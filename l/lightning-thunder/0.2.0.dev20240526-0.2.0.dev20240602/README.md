# Comparing `tmp/lightning_thunder-0.2.0.dev20240526.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240602.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning_thunder-0.2.0.dev20240526.tar", last modified: Sun May 26 00:21:05 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240602.tar", last modified: Sun Jun  2 00:21:37 2024, max compression
```

## Comparing `lightning_thunder-0.2.0.dev20240526.tar` & `lightning_thunder-0.2.0.dev20240602.tar`

### file list

```diff
@@ -1,103 +1,108 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.491341 lightning_thunder-0.2.0.dev20240526/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-26 00:21:05.491341 lightning_thunder-0.2.0.dev20240526/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2503 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      538 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.471341 lightning_thunder-0.2.0.dev20240526/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      130 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      836 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-26 00:21:05.491341 lightning_thunder-0.2.0.dev20240526/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.471341 lightning_thunder-0.2.0.dev20240526/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-05-26 00:21:05.000000 lightning_thunder-0.2.0.dev20240526/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    34699 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.475341 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   102923 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    23134 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3730 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    25820 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11229 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.475341 lightning_thunder-0.2.0.dev20240526/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    64679 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2555 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    32604 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.479341 lightning_thunder-0.2.0.dev20240526/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    15070 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    59756 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4484 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     5045 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/module.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   124800 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    50019 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28189 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    12551 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   142273 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37505 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.479341 lightning_thunder-0.2.0.dev20240526/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.479341 lightning_thunder-0.2.0.dev20240526/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    26793 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    11729 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.483341 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      310 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    10320 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    33464 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4629 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp_v2.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.483341 lightning_thunder-0.2.0.dev20240526/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    76235 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10901 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    14135 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    13131 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    85990 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24891 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-26 00:21:05.487341 lightning_thunder-0.2.0.dev20240526/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   166423 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2889 2024-05-26 00:21:01.000000 lightning_thunder-0.2.0.dev20240526/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.148808 lightning_thunder-0.2.0.dev20240602/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12859 2024-06-02 00:21:37.148808 lightning_thunder-0.2.0.dev20240602/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9879 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.148808 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12859 2024-06-02 00:21:37.000000 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2696 2024-06-02 00:21:37.000000 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-06-02 00:21:37.000000 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-06-02 00:21:37.000000 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      562 2024-06-02 00:21:37.000000 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-06-02 00:21:37.000000 lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.132808 lightning_thunder-0.2.0.dev20240602/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      861 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-06-02 00:21:37.152808 lightning_thunder-0.2.0.dev20240602/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.132808 lightning_thunder-0.2.0.dev20240602/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-06-02 00:21:36.000000 lightning_thunder-0.2.0.dev20240602/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35828 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.132808 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   102917 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23134 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3674 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27820 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11229 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.136808 lightning_thunder-0.2.0.dev20240602/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    64868 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2555 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    32744 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.140807 lightning_thunder-0.2.0.dev20240602/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15266 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13848 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19048 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   256245 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    60691 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4484 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6462 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/module.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   126083 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    50530 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28268 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26546 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21563 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12551 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   127848 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37505 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.140807 lightning_thunder-0.2.0.dev20240602/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.140807 lightning_thunder-0.2.0.dev20240602/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    29155 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20604 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.140807 lightning_thunder-0.2.0.dev20240602/thunder/distributed/tensor_parallel/
+-rw-r--r--   0 runner    (1001) docker     (127)      315 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/tensor_parallel/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10439 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/tensor_parallel/column_wise.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8725 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/tensor_parallel/common.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10882 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/tensor_parallel/row_wise.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.140807 lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      307 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12942 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33464 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4674 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/fsdp_v2.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10756 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.140807 lightning_thunder-0.2.0.dev20240602/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.144808 lightning_thunder-0.2.0.dev20240602/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25953 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    76315 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11165 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14949 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13557 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    88553 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24891 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.144808 lightning_thunder-0.2.0.dev20240602/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.144808 lightning_thunder-0.2.0.dev20240602/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-06-02 00:21:37.148808 lightning_thunder-0.2.0.dev20240602/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   167615 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2889 2024-06-02 00:21:30.000000 lightning_thunder-0.2.0.dev20240602/thunder/torch/langctx.py
```

### Comparing `lightning_thunder-0.2.0.dev20240526/LICENSE` & `lightning_thunder-0.2.0.dev20240602/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240602/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/PKG-INFO` & `lightning_thunder-0.2.0.dev20240602/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240526
+Version: 0.2.0.dev20240602
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -30,40 +30,41 @@
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
-Requires-Dist: ipython[all]==8.24.0; extra == "notebooks"
+Requires-Dist: ipython[all]==8.25.0; extra == "notebooks"
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
 Requires-Dist: coverage==7.5.1; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
 Requires-Dist: graphviz==0.20.3; extra == "test"
-Requires-Dist: hypothesis==6.100.0; extra == "test"
+Requires-Dist: hypothesis==6.103.0; extra == "test"
 Requires-Dist: jax; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jsonargparse; extra == "test"
-Requires-Dist: litgpt==0.3.0; extra == "test"
+Requires-Dist: litgpt==0.3.1; extra == "test"
 Requires-Dist: numpy; extra == "test"
 Requires-Dist: pandas; extra == "test"
+Requires-Dist: pytest-benchmark==4.0.0; extra == "test"
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
 Requires-Dist: pytest-timeout==2.3.1; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.6.1; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,47 +104,56 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
 
 &#160;
 
 ## Install Thunder
 
-To use Thunder on your local machine, first install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
+To use Thunder on your local machine:
+
+- install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
 
 ```bash
 # install nvFuser which installs the matching nightly PyTorch
 pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://pypi.nvidia.com
 ```
 
-Then, install Thunder as follows:
+- install [cudnn](https://gitlab-master.nvidia.com/cudnn/cudnn_frontend) as follows:
+
+```bash
+# install cudnn
+pip install nvidia-cudnn-frontend
+```
+
+- Finally, install Thunder as follows:
 
 ```
 # install thunder
 pip install lightning-thunder
 ```
 
 <details>
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240526
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240602
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -14,29 +14,30 @@
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
 mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: cuda-python; extra ==
-"notebooks" Requires-Dist: ipython[all]==8.24.0; extra == "notebooks" Provides-
+"notebooks" Requires-Dist: ipython[all]==8.25.0; extra == "notebooks" Provides-
 Extra: test Requires-Dist: absl-py; extra == "test" Requires-Dist:
 coverage==7.5.1; extra == "test" Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist: fdm==0.4.1;
 extra == "test" Requires-Dist: graphviz==0.20.3; extra == "test" Requires-Dist:
-hypothesis==6.100.0; extra == "test" Requires-Dist: jax; (sys_platform ==
+hypothesis==6.103.0; extra == "test" Requires-Dist: jax; (sys_platform ==
 "linux" or sys_platform == "darwin") and extra == "test" Requires-Dist: jaxlib;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
-Requires-Dist: jsonargparse; extra == "test" Requires-Dist: litgpt==0.3.0;
+Requires-Dist: jsonargparse; extra == "test" Requires-Dist: litgpt==0.3.1;
 extra == "test" Requires-Dist: numpy; extra == "test" Requires-Dist: pandas;
-extra == "test" Requires-Dist: pytest-cov==4.1.0; extra == "test" Requires-
-Dist: pytest-random-order==1.1.1; extra == "test" Requires-Dist: pytest-
-timeout==2.3.1; extra == "test" Requires-Dist: pytest-timestamper==0.0.10;
-extra == "test" Requires-Dist: pytest-xdist==3.6.1; extra == "test" Requires-
-Dist: pytest==8.1.1; extra == "test" Requires-Dist: xlsxwriter; extra == "test"
+extra == "test" Requires-Dist: pytest-benchmark==4.0.0; extra == "test"
+Requires-Dist: pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-
+order==1.1.1; extra == "test" Requires-Dist: pytest-timeout==2.3.1; extra ==
+"test" Requires-Dist: pytest-timestamper==0.0.10; extra == "test" Requires-
+Dist: pytest-xdist==3.6.1; extra == "test" Requires-Dist: pytest==8.1.1; extra
+== "test" Requires-Dist: xlsxwriter; extra == "test"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
@@ -74,19 +75,21 @@
 FSDP for training models on multiple GPUs. The following plot displays the
 normalized throughput measured for Llama 2 7B without FP8 mixed precision;
 support for FSDP is in progress.
                                    [Thunder]
   ## Get started The easiest way to get started with Thunder, requiring no
 extra installations or setups, is by using our [Zero to Thunder Tutorial
 Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).  
-## Install Thunder To use Thunder on your local machine, first install
-[nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together
-as follows: ```bash # install nvFuser which installs the matching nightly
-PyTorch pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://
-pypi.nvidia.com ``` Then, install Thunder as follows: ``` # install thunder pip
+## Install Thunder To use Thunder on your local machine: - install [nvFuser]
+(https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as
+follows: ```bash # install nvFuser which installs the matching nightly PyTorch
+pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://
+pypi.nvidia.com ``` - install [cudnn](https://gitlab-master.nvidia.com/cudnn/
+cudnn_frontend) as follows: ```bash # install cudnn pip install nvidia-cudnn-
+frontend ``` - Finally, install Thunder as follows: ``` # install thunder pip
 install lightning-thunder ``` Advanced install options   ### Install from main
 Alternatively, you can install the latest version of Thunder directly from this
 GitHub repository as follows: ``` # 1) Install nvFuser and PyTorch nightly
 dependencies: pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https:
 //pypi.nvidia.com ``` ```bash # 2) Install Thunder itself pip install
 git+https://github.com/Lightning-AI/lightning-thunder.git ```   ### Install to
 tinker and contribute If you are interested in tinkering with and contributing
```

### Comparing `lightning_thunder-0.2.0.dev20240526/README.md` & `lightning_thunder-0.2.0.dev20240602/README.md`

 * *Files 2% similar despite different names*

```diff
@@ -69,22 +69,31 @@
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
 
 &#160;
 
 ## Install Thunder
 
-To use Thunder on your local machine, first install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
+To use Thunder on your local machine:
+
+- install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
 
 ```bash
 # install nvFuser which installs the matching nightly PyTorch
 pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://pypi.nvidia.com
 ```
 
-Then, install Thunder as follows:
+- install [cudnn](https://gitlab-master.nvidia.com/cudnn/cudnn_frontend) as follows:
+
+```bash
+# install cudnn
+pip install nvidia-cudnn-frontend
+```
+
+- Finally, install Thunder as follows:
 
 ```
 # install thunder
 pip install lightning-thunder
 ```
 
 <details>
```

### Comparing `lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240526
+Version: 0.2.0.dev20240602
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -30,40 +30,41 @@
 Requires-Dist: numpy<2,>=1.23.0
 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2
 Requires-Dist: opt_einsum>=3.3.0
 Requires-Dist: mpmath<1.4.0
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
-Requires-Dist: ipython[all]==8.24.0; extra == "notebooks"
+Requires-Dist: ipython[all]==8.25.0; extra == "notebooks"
 Provides-Extra: test
 Requires-Dist: absl-py; extra == "test"
 Requires-Dist: coverage==7.5.1; extra == "test"
 Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test"
 Requires-Dist: fdm==0.4.1; extra == "test"
 Requires-Dist: graphviz==0.20.3; extra == "test"
-Requires-Dist: hypothesis==6.100.0; extra == "test"
+Requires-Dist: hypothesis==6.103.0; extra == "test"
 Requires-Dist: jax; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jaxlib; (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
 Requires-Dist: jsonargparse; extra == "test"
-Requires-Dist: litgpt==0.3.0; extra == "test"
+Requires-Dist: litgpt==0.3.1; extra == "test"
 Requires-Dist: numpy; extra == "test"
 Requires-Dist: pandas; extra == "test"
+Requires-Dist: pytest-benchmark==4.0.0; extra == "test"
 Requires-Dist: pytest-cov==4.1.0; extra == "test"
 Requires-Dist: pytest-random-order==1.1.1; extra == "test"
 Requires-Dist: pytest-timeout==2.3.1; extra == "test"
 Requires-Dist: pytest-timestamper==0.0.10; extra == "test"
 Requires-Dist: pytest-xdist==3.6.1; extra == "test"
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,47 +104,56 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240526/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240602/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
 
 &#160;
 
 ## Install Thunder
 
-To use Thunder on your local machine, first install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
+To use Thunder on your local machine:
+
+- install [nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as follows:
 
 ```bash
 # install nvFuser which installs the matching nightly PyTorch
 pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://pypi.nvidia.com
 ```
 
-Then, install Thunder as follows:
+- install [cudnn](https://gitlab-master.nvidia.com/cudnn/cudnn_frontend) as follows:
+
+```bash
+# install cudnn
+pip install nvidia-cudnn-frontend
+```
+
+- Finally, install Thunder as follows:
 
 ```
 # install thunder
 pip install lightning-thunder
 ```
 
 <details>
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240526
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240602
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
@@ -14,29 +14,30 @@
 :: OS Independent Classifier: Programming Language :: Python :: 3 Classifier:
 Programming Language :: Python :: 3.10 Requires-Python: >=3.10, <3.12
 Description-Content-Type: text/markdown License-File: LICENSE Requires-Dist:
 torch>=2.2.0 Requires-Dist: looseversion==1.3.0 Requires-Dist: lightning-
 utilities>=0.7.0 Requires-Dist: numpy<2,>=1.23.0 Requires-Dist: igraph>=0.10.4
 Requires-Dist: optree>=0.9.2 Requires-Dist: opt_einsum>=3.3.0 Requires-Dist:
 mpmath<1.4.0 Provides-Extra: notebooks Requires-Dist: cuda-python; extra ==
-"notebooks" Requires-Dist: ipython[all]==8.24.0; extra == "notebooks" Provides-
+"notebooks" Requires-Dist: ipython[all]==8.25.0; extra == "notebooks" Provides-
 Extra: test Requires-Dist: absl-py; extra == "test" Requires-Dist:
 coverage==7.5.1; extra == "test" Requires-Dist: einops; extra == "test"
 Requires-Dist: expecttest==0.2.1; extra == "test" Requires-Dist: fdm==0.4.1;
 extra == "test" Requires-Dist: graphviz==0.20.3; extra == "test" Requires-Dist:
-hypothesis==6.100.0; extra == "test" Requires-Dist: jax; (sys_platform ==
+hypothesis==6.103.0; extra == "test" Requires-Dist: jax; (sys_platform ==
 "linux" or sys_platform == "darwin") and extra == "test" Requires-Dist: jaxlib;
 (sys_platform == "linux" or sys_platform == "darwin") and extra == "test"
-Requires-Dist: jsonargparse; extra == "test" Requires-Dist: litgpt==0.3.0;
+Requires-Dist: jsonargparse; extra == "test" Requires-Dist: litgpt==0.3.1;
 extra == "test" Requires-Dist: numpy; extra == "test" Requires-Dist: pandas;
-extra == "test" Requires-Dist: pytest-cov==4.1.0; extra == "test" Requires-
-Dist: pytest-random-order==1.1.1; extra == "test" Requires-Dist: pytest-
-timeout==2.3.1; extra == "test" Requires-Dist: pytest-timestamper==0.0.10;
-extra == "test" Requires-Dist: pytest-xdist==3.6.1; extra == "test" Requires-
-Dist: pytest==8.1.1; extra == "test" Requires-Dist: xlsxwriter; extra == "test"
+extra == "test" Requires-Dist: pytest-benchmark==4.0.0; extra == "test"
+Requires-Dist: pytest-cov==4.1.0; extra == "test" Requires-Dist: pytest-random-
+order==1.1.1; extra == "test" Requires-Dist: pytest-timeout==2.3.1; extra ==
+"test" Requires-Dist: pytest-timestamper==0.0.10; extra == "test" Requires-
+Dist: pytest-xdist==3.6.1; extra == "test" Requires-Dist: pytest==8.1.1; extra
+== "test" Requires-Dist: xlsxwriter; extra == "test"
                               [Thunder][Thunder]
 
                     **Make PyTorch models Lightning fast.**
     ______________________________________________________________________
    _L_i_g_h_t_n_i_n_g_._a_i â¢ _P_e_r_f_o_r_m_a_n_c_e â¢ _G_e_t_ _s_t_a_r_t_e_d â¢ _I_n_s_t_a_l_l â¢ _E_x_a_m_p_l_e_s â¢
               _I_n_s_i_d_e_ _T_h_u_n_d_e_r â¢ _G_e_t_ _i_n_v_o_l_v_e_d_! â¢ _D_o_c_u_m_e_n_t_a_t_i_o_n
 [![license](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https:
@@ -74,19 +75,21 @@
 FSDP for training models on multiple GPUs. The following plot displays the
 normalized throughput measured for Llama 2 7B without FP8 mixed precision;
 support for FSDP is in progress.
                                    [Thunder]
   ## Get started The easiest way to get started with Thunder, requiring no
 extra installations or setups, is by using our [Zero to Thunder Tutorial
 Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).  
-## Install Thunder To use Thunder on your local machine, first install
-[nvFuser](https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together
-as follows: ```bash # install nvFuser which installs the matching nightly
-PyTorch pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://
-pypi.nvidia.com ``` Then, install Thunder as follows: ``` # install thunder pip
+## Install Thunder To use Thunder on your local machine: - install [nvFuser]
+(https://github.com/NVIDIA/Fuser) nightly and PyTorch nightly together as
+follows: ```bash # install nvFuser which installs the matching nightly PyTorch
+pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https://
+pypi.nvidia.com ``` - install [cudnn](https://gitlab-master.nvidia.com/cudnn/
+cudnn_frontend) as follows: ```bash # install cudnn pip install nvidia-cudnn-
+frontend ``` - Finally, install Thunder as follows: ``` # install thunder pip
 install lightning-thunder ``` Advanced install options   ### Install from main
 Alternatively, you can install the latest version of Thunder directly from this
 GitHub repository as follows: ``` # 1) Install nvFuser and PyTorch nightly
 dependencies: pip install --pre 'nvfuser-cu121[torch]' --extra-index-url https:
 //pypi.nvidia.com ``` ```bash # 2) Install Thunder itself pip install
 git+https://github.com/Lightning-AI/lightning-thunder.git ```   ### Install to
 tinker and contribute If you are interested in tinkering with and contributing
```

### Comparing `lightning_thunder-0.2.0.dev20240526/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240602/lightning_thunder.egg-info/SOURCES.txt`

 * *Files 8% similar despite different names*

```diff
@@ -51,14 +51,18 @@
 thunder/core/vjp_utils.py
 thunder/cudagraphs/__init__.py
 thunder/distributed/__init__.py
 thunder/distributed/bucketing.py
 thunder/distributed/checkpoint.py
 thunder/distributed/prims.py
 thunder/distributed/utils.py
+thunder/distributed/tensor_parallel/__init__.py
+thunder/distributed/tensor_parallel/column_wise.py
+thunder/distributed/tensor_parallel/common.py
+thunder/distributed/tensor_parallel/row_wise.py
 thunder/distributed/transforms/__init__.py
 thunder/distributed/transforms/ddp.py
 thunder/distributed/transforms/fsdp.py
 thunder/distributed/transforms/fsdp_v2.py
 thunder/examine/__init__.py
 thunder/examine/memory_caculation.py
 thunder/executors/__init__.py
```

### Comparing `lightning_thunder-0.2.0.dev20240526/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240602/requirements/test.txt`

 * *Files 12% similar despite different names*

```diff
@@ -1,21 +1,22 @@
 coverage ==7.5.1
 pytest ==8.1.1
+pytest-benchmark ==4.0.0
 pytest-timeout ==2.3.1
 pytest-cov ==4.1.0
 pytest-xdist ==3.6.1
 pytest-random-order ==1.1.1
 pytest-timestamper ==0.0.10
 graphviz ==0.20.3
 fdm ==0.4.1
 expecttest ==0.2.1  # for test_ddp.py
-hypothesis ==6.100.0  # for test_ddp.py
+hypothesis ==6.103.0  # for test_ddp.py
 numpy  # for test_ops.py
 einops  # for test_einops.py
-litgpt==0.3.0  # for the model definition in tests and benchmarks
+litgpt==0.3.1  # for the model definition in tests and benchmarks
 absl-py # thunder/benchmarks/test_benchmark_litgpt.py
 pandas # thunder/benchmarks/test_benchmark_litgpt.py
 xlsxwriter # thunder/benchmarks/test_benchmark_litgpt.py
 jsonargparse # thunder/benchmarks/benchmark_litgpt.py
 
 # Installs JAX on Linux and MacOS
 jaxlib; sys_platform == 'linux' or sys_platform == 'darwin'  # required for jax, see https://github.com/google/jax#installation
```

### Comparing `lightning_thunder-0.2.0.dev20240526/setup.py` & `lightning_thunder-0.2.0.dev20240602/setup.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -43,14 +43,15 @@
 )
 import thunder.extend as extend
 from thunder.extend import Executor, add_default_executor
 from thunder.core.compile_data import compile_data_and_stats, get_compile_data
 from thunder.core.langctxs import LanguageContext
 import thunder.core.langctxs as langctxs
 from thunder.core.baseutils import run_once, check
+from thunder.core.codeutils import Positions
 from thunder.core.proxies import (
     Proxy,
     TensorProxy,
     NumberProxy,
     StringProxy,
     IntegerProxy,
     FloatProxy,
@@ -88,28 +89,33 @@
     "bool8",
     "uint8",
     "int8",
     "int16",
     "int32",
     "int64",
     "bfloat16",
+    "float8_e5m2",
+    "float8_e5m2fnuz",
+    "float8_e4m3fn",
+    "float8_e4m3fnuz",
     "float16",
     "float32",
     "float64",
     "complex32",
     "complex64",
     "complex128",
     # language aliases
     "torch",
     "numpy",
     "prims",
     # interface functions
     # TODO Extend this
     # TODO Add device aliases
     # TODO Add executor aliases
+    "cudnn_executor",
     "sdpa_executor",
     "nvfuser_executor",
     "pytorch_executor",
     # debugging functions
     "set_execution_callback_file",
 ]
 
@@ -125,14 +131,18 @@
 bool8 = dtypes.bool8
 uint8 = dtypes.uint8
 int8 = dtypes.int8
 int16 = dtypes.int16
 int32 = dtypes.int32
 int64 = dtypes.int64
 bfloat16 = dtypes.bfloat16
+float8_e5m2 = dtypes.float8_e5m2
+float8_e5m2fnuz = dtypes.float8_e5m2fnuz
+float8_e4m3fn = dtypes.float8_e4m3fn
+float8_e4m3fnuz = dtypes.float8_e4m3fnuz
 float16 = dtypes.float16
 float32 = dtypes.float32
 float64 = dtypes.float64
 complex32 = dtypes.complex32
 complex64 = dtypes.complex64
 complex128 = dtypes.complex128
 
@@ -151,25 +161,30 @@
 resolve_executors = extend.resolve_executors
 add_executor_lists = extend.add_executor_lists
 get_executor = extend.get_executor
 get_all_executors = extend.get_all_executors
 get_default_executors = extend.get_default_executors
 get_always_executors = extend.get_always_executors
 
+cudnn_executor: None | extend.Executor = extend.get_executor("cudnn")
 sdpa_executor: None | extend.Executor = extend.get_executor("sdpa")
 nvfuser_executor: None | extend.Executor = extend.get_executor("nvfuser")
 pytorch_executor: None | extend.Executor = extend.get_executor("torch")
 
-# Default executor list is [sdpa -> nvfuser -> torch -> python]
+# Default executor list is [cudnn -> sdpa -> nvfuser -> torch -> python]
+# Note that add_default_executor inserts executor at start of list, hence the reverse order below.
 if nvfuser_executor:
     add_default_executor(nvfuser_executor)
 
 if sdpa_executor:
     add_default_executor(sdpa_executor)
 
+if cudnn_executor:
+    add_default_executor(cudnn_executor)
+
 #
 # Promoted debugging functions
 #
 
 # If set, Python programs will be written to this file before being executed, and if the
 #   the file is modified then the modified version of the program will be compiled and executed, instead.
 from thunder.core.trace import _set_execution_file
@@ -318,22 +333,25 @@
     for ex in executors:
         # TODO: sharp edge if lookasides are shadowed?
         executor_lookasides.update(ex._lookasides)
 
     assert type(record_history) is bool
 
     # TODO RC1 Refine the compile data option to remove unused options
+    # TODO: refine options
+    # NOTE(fixme): use_cudagraphs is being absorbed into compile_options
+    use_cudagraphs = compile_options.get("use_cudagraphs", False)
     cd = CompileData(
         fn=fn,
         langctx=langctx,
         executors_list=executors,
         cache_option=cache,
         sharp_edges=sharp_edges,
         using_jit=True,
-        use_cudagraphs=False,
+        use_cudagraphs=use_cudagraphs,
         disable_torch_autograd_support=disable_torch_autograd,
         use_rematerialization=False,
         only_execute_prims=False,
         disable_preprocessing=True,
         compile_options=compile_options,
         executor_lookasides=executor_lookasides,
     )
@@ -577,14 +595,20 @@
             comp = computation_trc.python_callable()
 
             if backward_trc is not None:
                 backward_fn = backward_trc.python_callable()
             else:
                 backward_fn = None
 
+            # TODO: using vanilla CUDAGraphExecutor is not safe unless the graph is always static!
+            # (fixme): inspect torch.cuda.make_graph_callables and/or use it instead!
+            # See https://github.com/Lightning-AI/lightning-thunder/issues/433
+            if cd.use_cudagraphs:
+                comp = CUDAGraphExecutor(comp)
+
             # TODO RC1 Update the cache
             cache_entry = CacheEntry(
                 pro,
                 prologue_traces,
                 comp,
                 extraces,
                 epilogue,
@@ -648,14 +672,15 @@
         return result
 
     if isinstance(fn, pytorch.nn.Module):
         fn_ = ThunderModule(fn, fn_)
         cd._thunder_module_map[id(fn)] = fn_
 
     # Sets compile options and statistics attributes
+    cd._get_computation_and_inputs = get_computation_and_inputs
     fn_._lc_cd = cd
     fn_._lc_cs = cs
     fn_._lc_early_transforms = early_transforms[:]  ## transforms
     fn_._lc_transforms = additional_transforms[:]  ## transforms
     fn_._lc_post_optimization_transforms = []  ## post_optimization_transforms
 
     return fn_
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -1244,15 +1244,15 @@
         self.devices: list[str] = [device]
 
     def make_batch(self) -> tuple[list, dict]:
         return (make_tensor(self.shape, device=self.device, dtype=self.tdtype, requires_grad=self.requires_grad),), {}
 
     def fn(self) -> Callable:
         def foo(a):
-            return torch.nn.functional.gelu(a, approximate="tanh").sum()
+            return torch.nn.functional.gelu(a, approximate="tanh")
 
         return foo
 
 
 class NanoGPTBenchmark(Benchmark, metaclass=UserFacingBenchmarkMeta):
     _args = (
         BenchmarkArg(
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/einsum.py`

 * *Files 1% similar despite different names*

```diff
@@ -11,15 +11,14 @@
     make_setup,
     fwd_executors,
     fwd_executor_ids,
     grad_executors,
     grad_executors_ids,
     thunder_gradv1,
     thunder_torchcompile_gradv1,
-    wrap_for_benchmark,
 )
 
 
 def _instantiate_benchmark_env(
     shapes: Sequence[Sequence[int]],
     equation: str,
     executor: Callable,
@@ -29,15 +28,14 @@
 ) -> Callable:
     bench: Benchmark = EinsumBenchmark(
         shapes=shapes, equation=equation, device=device, dtype=dtype, requires_grad=requires_grad
     )
 
     setup = make_setup(bench)
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
     return setup, fn
 
 
 _test_size_map = {
     "small": 16,
     "medium": 128,
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/targets.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,17 +1,18 @@
 from collections.abc import Callable
 from functools import partial, wraps
 from collections.abc import Sequence
 
 from lightning_utilities.core.imports import package_available
 
 import pytest
+import os
 import torch
 import thunder
-from thunder.core.transforms import grad, clear_grads, populate_grads, get_grad, put_grad, put_grads
+from thunder.core.transforms import grad, clear_grads, populate_grads
 from thunder.core.interpreter import interpret
 
 from thunder.benchmarks import (
     Benchmark,
     NanoGPTGeLUBenchmark,
     NanoGPTCrossEntropyBenchmark,
     NanoGPTLayerNormBenchmark,
@@ -23,52 +24,53 @@
     NanoGPTBenchmark,
     LitGPTBenchmark,
     LitGPTCausalSelfAttentionBenchmark,
     LlamaMLPBenchmark,
     torch_executor,
     torch_compile_executor,
     thunder_executor,
-    thunder_torch_executor,
     thunder_torch_compile_executor,
     thunder_apex_executor,
     thunder_apex_nvfuser_executor,
     thunder_cudnn_executor,
     thunder_cudnn_nvfuser_executor,
     thunder_cudnn_layer_norm_executor,
     thunder_cudnn_layer_norm_nvfuser_executor,
-    thunder_sdpa_executor,
     thunder_sdpa_torch_compile_nvfuser_executor,
     BatchNormBenchmark,
 )
 
 from thunder.tests.litgpt_model import Config as LitGPTConfig
+from thunder.tests.make_tensor import make_tensor
+
+from litgpt.config import configs
 
 
 APEX_FUSED_ROPE_AVAILABLE: bool = package_available("fused_rotary_positional_embedding")
+IMPORTANT_CONFIGS = [
+    "Llama-2-13b-hf",
+    "Llama-2-70b-hf",
+    "Llama-2-7b-hf",
+    "Llama-3-70B",
+    "Llama-3-8B",
+    "Mistral-7B-v0.1",
+    "phi-2",
+]
+RUN_ALL_CONFIGS = os.environ.get("THUNDER_BENCH_RUN_ALL_CONFIGS", "0") == "1"
 
 
 def make_setup(b: Benchmark):
     def setup():
         args_and_kwargs = b.make_batch()
         torch.cuda.synchronize()
         return args_and_kwargs
 
     return setup
 
 
-def wrap_for_benchmark(fn):
-    @wraps(fn)
-    def fn_(*args, **kwargs):
-        result = fn(*args, **kwargs)
-        torch.cuda.synchronize()
-        return result
-
-    return fn_
-
-
 def torch_fwd(b: Benchmark):
     module = b.fn()
     fn_ = torch_executor(module)
 
     if isinstance(module, torch.nn.Sequential):
 
         @wraps(fn_)
@@ -329,53 +331,50 @@
     ids=fwd_executor_ids,
 )
 def test_nanogpt_gelu_fwd(benchmark, executor: Callable):
     gelu_bench: Benchmark = NanoGPTGeLUBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(gelu_bench)
+    args, kwargs = gelu_bench.make_batch()
     fn = executor(gelu_bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_nanogpt_gelu_grad(benchmark, executor: Callable):
     gelu_bench: Benchmark = NanoGPTGeLUBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(gelu_bench)
+    args, kwargs = gelu_bench.make_batch()
     fn = executor(gelu_bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
 )
 def test_batch_norm_fwd(benchmark, executor: Callable):
     bn_bench: Benchmark = BatchNormBenchmark(
         (16, 128, 768), device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(bn_bench)
+    args, kwargs = bn_bench.make_batch()
     fn = executor(bn_bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     (
         torch_fwd_bwd,
         torchcompile_fwd_bwd,
@@ -384,18 +383,17 @@
     ids=fwd_executor_ids,
 )
 def test_batch_norm_grad(benchmark, executor: Callable):
     bn_bench: Benchmark = BatchNormBenchmark(
         (16, 128, 768), device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bn_bench)
+    args, kwargs = bn_bench.make_batch()
     fn = executor(bn_bench)
-    fn = wrap_for_benchmark(fn)
-    benchmark.pedantic(fn, setup=setup, rounds=200, warmup_rounds=20)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Improve cross entropy's fwd+bwd perf when using the PyTorch executor
 #   See "torch.cross_entropy implementation has incorrect dtype metadata + bwd
 #        is very slow"
 @pytest.mark.parametrize(
     "executor,",
@@ -406,19 +404,18 @@
     if executor is None:
         pytest.skip("Executor is unavailable")
 
     bench: Benchmark = NanoGPTCrossEntropyBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Improve cross entropy's fwd+bwd perf when using the PyTorch executor
 #   See "torch.cross_entropy implementation has incorrect dtype metadata + bwd
 #        is very slow"
 @pytest.mark.parametrize(
     "executor,",
@@ -429,19 +426,18 @@
     if executor is None:
         pytest.skip("Executor is unavailable")
 
     bench: Benchmark = NanoGPTCrossEntropyBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Improve cross entropy's fwd+bwd perf when using the PyTorch executor
 #   See "torch.cross_entropy implementation has incorrect dtype metadata + bwd
 #        is very slow"
 @pytest.mark.parametrize(
     "executor,",
@@ -452,72 +448,68 @@
     if executor is None:
         pytest.skip("Executor is unavailable")
 
     bench: Benchmark = NanoGPTLayerNormBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,", (fwd_executors + cudnn_fwd_executors), ids=(fwd_executor_ids + cudnn_fwd_executors_ids)
 )
 def test_nanogpt_sdpa_fwd(benchmark, executor: None | Callable):
     if executor is None:
         pytest.skip("Executor is unavailable")
 
     bench: Benchmark = NanoGPTSDPABenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Fix thunder-fwd-bwd+nvfuser
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_nanogpt_sdpa_grad(benchmark, executor: Callable):
     bench: Benchmark = NanoGPTSDPABenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_llama2_7b_sdpa_grad(benchmark, executor: Callable):
     bench: Benchmark = LitGPTSDPABenchmark(
         config="Llama-2-7b-hf", device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 sdpa_executors = (
     torch_executor,
     torch_compile_executor,
     thunder_executor,
     *((thunder_cudnn_nvfuser_executor,) if thunder_cudnn_nvfuser_executor is not None else ()),
@@ -543,70 +535,61 @@
         1,
         2,
     ),
     ids=("bs1", "bs2"),
 )
 @pytest.mark.parametrize(
     "config,",
-    (
-        "Llama-2-7b-hf",
-        "Llama-2-13b-hf",
-        "Llama-2-70b-hf",
-        "Llama-3-8B",
-        "Llama-3-70B",
-    ),
+    IMPORTANT_CONFIGS,
 )
 def test_litgpt_sdpa_grad(benchmark, executor: Callable, bs, config):
     bench: Benchmark = LitGPTSDPABenchmark(
         config=config,
         batchdims=(bs,),
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=True,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = thunder_fwd_bwd(bench, compile_fn=executor)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
 )
 def test_nanogpt_mlp_fwd(benchmark, executor: Callable):
     bench: Benchmark = NanoGPTMLPBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_nanogpt_mlp_grad(benchmark, executor: Callable):
     bench: Benchmark = NanoGPTMLPBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # NOTE The CSA module is linear -> sdpa -> dropout
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
@@ -615,19 +598,18 @@
     bench: Benchmark = NanoGPTCSABenchmark(
         config="gpt2-xl",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=False,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # NOTE The CSA module is linear -> sdpa -> dropout
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
@@ -636,55 +618,52 @@
     bench: Benchmark = NanoGPTCSABenchmark(
         config="gpt2-xl",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=True,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # NOTE NanoGPT's block module is layernorm -> csa -> layernorm -> mlp
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
 )
 def test_nanogpt_block_fwd(benchmark, executor: Callable):
     bench: Benchmark = NanoGPTBlockBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=False
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # NOTE NanoGPT's block module is layernorm -> csa -> layernorm -> mlp
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_nanogpt_block_grad(benchmark, executor: Callable):
     bench: Benchmark = NanoGPTBlockBenchmark(
         config="gpt2-xl", device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Fix torch.compiles bfloat16 atomic add issue with this benchmark -- why does thunder trigger it but regular torch.compile does not
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
@@ -694,19 +673,18 @@
         config="gpt2",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=False,
         only_return_loss=False,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Fix torch.compiles bfloat16 atomic add issue with this benchmark and add thunder-grad+torch.compile executor back
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
@@ -716,19 +694,18 @@
         config="gpt2",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=True,
         only_return_loss=True,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     fwd_executors,
     ids=fwd_executor_ids,
 )
@@ -737,19 +714,18 @@
         config="gpt2-xl",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=False,
         only_return_loss=False,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 # TODO Fix torch.compiles bfloat16 atomic add issue with this benchmark and add thunder-grad+torch.compile executor back
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
@@ -759,52 +735,49 @@
         config="gpt2-xl",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=True,
         only_return_loss=True,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 #
 # llama benchmarks
 #
 
 
 @pytest.mark.parametrize(
     "executor,", (fwd_executors + cudnn_fwd_executors), ids=(fwd_executor_ids + cudnn_fwd_executors_ids)
 )
 def test_open_llama_7b_fwd(benchmark, executor: Callable):
     cfg: LitGPTConfig = LitGPTConfig.from_name("open_llama_7b")
     b = LitGPTBenchmark(cfg, device="cuda:0", dtype=torch.bfloat16, requires_grad=False)
 
-    setup = make_setup(b)
+    args, kwargs = b.make_batch()
     fn = executor(b)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,", (fwd_executors + cudnn_fwd_executors), ids=(fwd_executor_ids + cudnn_fwd_executors_ids)
 )
 def test_llama_2_7b_hf_fwd(benchmark, executor: Callable):
     cfg: LitGPTConfig = LitGPTConfig.from_name("Llama-2-7b-hf")
     b = LitGPTBenchmark(cfg, device="cuda:0", dtype=torch.bfloat16, requires_grad=False)
 
-    setup = make_setup(b)
+    args, kwargs = b.make_batch()
     fn = executor(b)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
@@ -814,111 +787,218 @@
         cfg,
         batchdims=(2,),
         device="cuda",
         dtype=torch.bfloat16,
         requires_grad=True,
     )
 
-    setup = make_setup(b)
+    args, kwargs = b.make_batch()
     fn = executor(b)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_llama2_mlp_7b_grad(benchmark, executor: Callable):
     bench: Benchmark = LlamaMLPBenchmark(
         config="Llama-2-7b-hf", batchdims=(16,), device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_llama2_causal_self_attention_7b_grad(benchmark, executor: Callable):
     bench: Benchmark = LitGPTCausalSelfAttentionBenchmark(
         config="Llama-2-7b-hf", batchdims=(16,), device="cuda:0", dtype=thunder.bfloat16, requires_grad=True
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 @pytest.mark.parametrize(
     "executor,",
     grad_executors,
     ids=grad_executors_ids,
 )
 def test_llama2_7b_rmsnorm_grad(benchmark, executor: Callable):
     from thunder.benchmarks import LlamaRMSNormBenchmark
 
     bench: Benchmark = LlamaRMSNormBenchmark(n_embd=4096, device="cuda:0", dtype=thunder.bfloat16, requires_grad=True)
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
+
+
+# There are many configurations but only the following parameters affect the QKV split+RoPE benchmark:
+# - head_size
+# - n_head
+# - n_query_groups
+# - rope_n_elem
+# - block_size
+# Let's select only the configurations that differ in these parameters
+def get_configs_for_qkv_split_rope():
+    config_names = list(sorted(c["name"] for c in configs)) if RUN_ALL_CONFIGS else IMPORTANT_CONFIGS
+    unique_config_names = {}
+    for config_name in config_names:
+        config = LitGPTConfig.from_name(config_name)
+        key = tuple(
+            getattr(config, k)
+            for k in (
+                "head_size",
+                "n_head",
+                "n_query_groups",
+                "rope_n_elem",
+                "block_size",
+            )
+        )
+        if config_name in IMPORTANT_CONFIGS:
+            unique_config_names[key] = config_name
+        unique_config_names.setdefault(key, config_name)
+
+    config_names = list(sorted(unique_config_names.values()))
+    return config_names
+
+
+qkv_split_rope_executors = (
+    (torch_executor, False),
+    (torch_compile_executor, False),
+    (thunder_executor, False),
+    (thunder_sdpa_torch_compile_nvfuser_executor, False),
+    (torch_executor, True),
+    (torch_compile_executor, True),
+)
+qkv_split_rope_executors_ids = (
+    "torch",
+    "torch.compile",
+    "thunder",
+    "thunder+nvfuser+torch.compile",
+    "torch+apex",
+    "torch.compile+apex",
+)
 
 
+# Sample command to run this benchmark:
+# pytest thunder/benchmarks/targets.py -k "test_litgpt_qkv_split_rope_train_forward" --benchmark-group-by='param:config,param:bs' --benchmark-columns='min,max,mean,stddev,median'
 @pytest.mark.parametrize(
     "executor,use_apex,",
-    (
-        (torch_fwd_bwd, False),
-        (torchcompile_fwd_bwd, False),
-        (thunder_fwd_bwd, False),
-        (thunder_fwd_bwd_sdpa_torch_compile_nvfuser, False),
-        (torch_fwd_bwd, True),
-        (torchcompile_fwd_bwd, True),
-    ),
-    ids=(
-        "torch",
-        "torch.compile",
-        "thunder",
-        "thunder+nvfuser+torch.compile",
-        "torch+apex",
-        "torch.compile+apex",
-    ),
+    qkv_split_rope_executors,
+    ids=qkv_split_rope_executors_ids,
+)
+# bs = batch size
+# It's typically small for LLMs
+@pytest.mark.parametrize(
+    "bs,",
+    (2**i for i in range(0, 2)),
+    ids=(f"bs{2**i}" for i in range(0, 2)),
+)
+@pytest.mark.parametrize(
+    "config,",
+    get_configs_for_qkv_split_rope(),
 )
-def test_llama2_qkv_split_rope_7b_train(benchmark, executor: Callable, use_apex: bool):
+@pytest.mark.benchmark(group="forward")
+def test_litgpt_qkv_split_rope_train_forward(benchmark, executor: Callable, use_apex: bool, bs: int, config: str):
     from thunder.benchmarks import LlamaQKVSplitRopeBenchmark
 
     if use_apex and not APEX_FUSED_ROPE_AVAILABLE:
         pytest.skip("Apex fused rotary positional embedding is unavailable")
 
     bench: Benchmark = LlamaQKVSplitRopeBenchmark(
-        config="Llama-2-7b-hf",
-        batchdims=(32,),
+        config=config,
+        batchdims=(bs,),
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=True,
         use_apex=use_apex,
     )
 
-    setup = make_setup(bench)
-    fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
+    args, kwargs = bench.make_batch()
+    fn = executor(bench.fn())
+
+    benchmark(fn, *args, **kwargs)
+
+
+def backward_only(fn: Callable, jit_fn: Callable, fw_setup_fn: Callable):
+    jfn = jit_fn(fn)
+    args, kwargs = fw_setup_fn()
+    result = jfn(*args, **kwargs)
+    result = thunder.core.utils.sequencify(result)
+
+    result_metadata = [(r.dtype, r.device, r.shape) for r in result]
+
+    def bw_setup():
+        args = []
+        for dtype, device, shape in result_metadata:
+            torch_dtype = thunder.torch.to_torch_dtype(dtype)
+            torch_device = thunder.core.devices.to_torch_device(device)
+            args.append(make_tensor(shape, dtype=torch_dtype, device=torch_device, requires_grad=False))
+        return args, {}
+
+    def backward_fn(*args, **kwargs):
+        for a in args:
+            a.grad = None
+
+        torch.autograd.backward(result, args, retain_graph=True)
+
+    return backward_fn, bw_setup
+
+
+# Sample command to run this benchmark:
+# pytest thunder/benchmarks/targets.py -k "test_litgpt_qkv_split_rope_train_backward" --benchmark-group-by='param:config,param:bs' --benchmark-columns='min,max,mean,stddev,median'
+@pytest.mark.parametrize(
+    "executor,use_apex,",
+    qkv_split_rope_executors,
+    ids=qkv_split_rope_executors_ids,
+)
+@pytest.mark.parametrize(
+    "bs,",
+    (2**i for i in range(0, 2)),
+    ids=(f"bs{2**i}" for i in range(0, 2)),
+)
+@pytest.mark.parametrize(
+    "config,",
+    get_configs_for_qkv_split_rope(),
+)
+@pytest.mark.benchmark(group="backward")
+def test_litgpt_qkv_split_rope_train_backward(benchmark, executor: Callable, use_apex: bool, bs: int, config: str):
+    from thunder.benchmarks import LlamaQKVSplitRopeBenchmark
+
+    if use_apex and not APEX_FUSED_ROPE_AVAILABLE:
+        pytest.skip("Apex fused rotary positional embedding is unavailable")
+
+    bench: Benchmark = LlamaQKVSplitRopeBenchmark(
+        config=config,
+        batchdims=(bs,),
+        device="cuda:0",
+        dtype=thunder.bfloat16,
+        requires_grad=True,
+        use_apex=use_apex,
+    )
+
+    fw_setup = make_setup(bench)
+    fn, bw_setup = backward_only(bench.fn(), executor, fw_setup)
+    args, kwargs = bw_setup()
 
-    benchmark.pedantic(fn, setup=setup, rounds=40, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
 
 
 #
 # interpreter benchmarks
 #
 
 
@@ -928,12 +1008,11 @@
         config="gpt2",
         device="cuda:0",
         dtype=thunder.bfloat16,
         requires_grad=False,
         only_return_loss=False,
     )
 
-    setup = make_setup(bench)
+    args, kwargs = bench.make_batch()
     fn = executor(bench)
-    fn = wrap_for_benchmark(fn)
 
-    benchmark.pedantic(fn, setup=setup, rounds=5, warmup_rounds=1)
+    benchmark(fn, *args, **kwargs)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240602/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/clang/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -15,25 +15,34 @@
 from thunder.core.compile_data import using_symbolic_values
 from thunder.clang.langctx import register_method
 from thunder.core.langctxs import langctx, Languages
 
 import thunder.core.dtypes as dtypes
 from thunder.core import utils
 import thunder.core.prims as prims
-from thunder.core.proxies import IntegerProxy, NumberProxy, TensorProxy, pyval, pytype, proxy, AnyProxy, Proxy
+from thunder.core.proxies import (
+    IntegerProxy,
+    NumberProxy,
+    NumberLike,
+    TensorProxy,
+    pyval,
+    pytype,
+    proxy,
+    AnyProxy,
+    Proxy,
+)
 import thunder.core.devices as devices
 
 # This file defines the operations in thunder.jit's "core" language.
 #
 # These operators are intended to be used when defining user-facing languages, like the torch or NumPy
 # languages.
 
 __all__ = []
 
-NumberLike = Number | NumberProxy
 TensorLike = TensorProxy
 DeviceLike = Union[str, devices.Device]
 
 _clang_fn_set: set = set()
 
 
 # Decorator that sets the core language context and registers the function
@@ -1772,14 +1781,19 @@
     if dtypes.is_float_dtype(computation_dtype):
         return _floor_divide_float(a, b)
 
     # NOTE At this point the datatypes are neither complex nor floating point, so they are exact types
     return _floor_divide_integer(a, b, computation_dtype=computation_dtype)
 
 
+@clangop(method_name="trunc_divide")
+def trunc_divide(a: TensorProxy | Number, b: TensorProxy | Number, /) -> TensorProxy | Number:
+    return trunc(_c_div(a, b))
+
+
 @clangop()
 def fmod(a, b):
     return _elementwise_binary_wrapper(a, b, prim=prims.fmod)
 
 
 @clangop(method_name="mod")
 def mod(a, b):
@@ -1944,13 +1958,13 @@
 def argmin(a: TensorProxy, /, dim: int | None = None, keepdim: bool | None = False):
     return _argmaxmin_helper(prims.argmin, a, dim, keepdim)
 
 
 @clangop()
 def topk(
     a: TensorLike, /, k: int, dim: int | None = None, largest: bool = True, sorted: bool = True, *, out=None
-) -> (TensorProxy, TensorProxy):
+) -> tuple[TensorProxy, TensorProxy]:
     if dim is None:
         dim = a.ndim - 1 if a.ndim > 0 else 0
     dim = utils.canonicalize_dim(a.ndim, dim)
 
     return prims.topk(a, k, dim, bool(largest), bool(sorted), out=out)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240602/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/common.py` & `lightning_thunder-0.2.0.dev20240602/thunder/common.py`

 * *Files 2% similar despite different names*

```diff
@@ -29,15 +29,23 @@
 from thunder.core.trace import (
     TraceCtx,
     get_tracectx,
     set_tracectx,
     reset_tracectx,
 )
 from thunder.core.transform_common import dce, cse
-from thunder.core.proxies import is_proxyable, proxy, Proxy, CollectionProxy, TensorProxy, DDPType, FutureTensorProxy
+from thunder.core.proxies import (
+    is_proxyable,
+    proxy,
+    Proxy,
+    CollectionProxy,
+    TensorProxy,
+    DistParallelType,
+    FutureTensorProxy,
+)
 import thunder.core.prims as prims
 import thunder.distributed as dist
 import thunder.torch as ltorch
 from thunder.extend import Executor, get_default_executors, get_always_executors, OperatorExecutor, add_executor_lists
 import thunder.executors as executors
 from thunder.core.transforms import autocast
 from thunder.core.dtypes import to_dtype
@@ -555,15 +563,18 @@
                 no_sync = get_skip_data_parallel_grad_sync()
                 utils.check(
                     not (no_sync and getattr(compile_data, "use_fsdp", False)),
                     lambda: "`thunder.distributed.fsdp` does not support `no_sync`",
                 )
 
                 def ddp_sync(arg: Any | TensorProxy) -> Any | TensorProxy:
-                    if isinstance(arg, TensorProxy) and arg.ddp_type in (DDPType.REPLICATED, DDPType.FULLY_SHARDED):
+                    if isinstance(arg, TensorProxy) and arg.distparallel_type in (
+                        DistParallelType.REPLICATED,
+                        DistParallelType.FULLY_SHARDED,
+                    ):
                         return dist.prims.synchronize(arg, compile_data.process_group_for_ddp)
                     else:
                         return arg
 
                 if not no_sync:
                     proxyargs, proxykwargs = tree_map(ddp_sync, (proxyargs, proxykwargs))
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/baseutils.py`

 * *Files 4% similar despite different names*

```diff
@@ -300,14 +300,18 @@
     torch.bool: "torch.bool",
     torch.uint8: "torch.uint8",
     torch.int8: "torch.int8",
     torch.int16: "torch.int16",
     torch.int32: "torch.int32",
     torch.int64: "torch.int64",
     torch.bfloat16: "torch.bfloat16",
+    torch.float8_e4m3fn: "torch.float8_e4m3fn",
+    torch.float8_e4m3fnuz: "torch.float8_e4m3fnuz",
+    torch.float8_e5m2: "torch.float8_e5m2",
+    torch.float8_e5m2fnuz: "torch.float8_e5m2fnuz",
     torch.float16: "torch.float16",
     torch.float32: "torch.float32",
     torch.float64: "torch.float64",
     torch.complex32: "torch.complex32",
     torch.complex64: "torch.complex64",
     torch.complex128: "torch.complex128",
 }
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/codeutils.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,18 +1,19 @@
 from types import CodeType, FunctionType, MethodType, EllipsisType
-from typing import List, Dict, Tuple, Set, Deque, Any
+from typing import List, Dict, Tuple, Set, Deque, Any, NamedTuple
 from numbers import Number
 from collections import deque
 from collections.abc import Mapping, Sequence, Iterable
 import inspect
 from inspect import Parameter
 import string
 import functools
 from functools import partial
 import dis
+import linecache
 
 import torch
 
 import thunder.core.baseutils as baseutils
 from thunder.core.baseutils import ProxyInterface, check
 import thunder.core.dtypes as dtypes
 import thunder.core.devices as devices
@@ -215,14 +216,35 @@
     if type(x) is type:
         return m(f"{baseutils.print_type(x, with_quotes=False)}")
 
     # Handles objects that this doesn't know how to serialize as a string
     return m(f"(object of type {print_type(type(x), with_quotes=False)})")
 
 
+# Use dis.Positions in 3.11+ and make it up in <3.11
+if sys.version_info < (3, 11):
+
+    class Positions(NamedTuple):
+        lineno: int = None
+        end_lineno: int = None
+        col_offset: int = None
+        end_col_offset: int = None
+
+else:
+    Positions = dis.Positions
+
+
+def get_source_line(filename: str, lineno: int) -> str:
+    ls = linecache.getlines(filename)
+    if lineno <= 0 or lineno > len(ls):
+        return ""
+    else:
+        return ls[lineno - 1].rstrip()
+
+
 # TODO Make this a frozen dataclass?
 class SigInfo:
     def __init__(self, name, /):
         self.name = name
         self.args = []
         self.varargs = None
         self.kwargs = {}
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/dtypes.py`

 * *Files 5% similar despite different names*

```diff
@@ -55,17 +55,18 @@
     #   abstract classes from being instantiated
     def __new__(cls, *args, **kwargs):
         if cls in _abstract_classes:
             raise TypeError(f"{cls} is abstract and cannot be instantiated!")
 
         return object.__new__(cls)
 
-    def __init__(self, *, python_type, name, shortname, bytes, is_weak):
+    def __init__(self, *, python_type, name, shortname, bytes, is_weak, variant=None):
         self._python_type = python_type
         self._name = name
+        self._variant = variant
         self._shortname = shortname
         self._bytes = bytes
         self._is_weak = is_weak
 
     # NOTE: these are properties so they appear as read-only
     @property
     def python_type(self):
@@ -76,31 +77,38 @@
         return self._bytes
 
     @property
     def is_weak(self):
         return self._is_weak
 
     def shortname(self):
-        return f"{self._shortname}{8 * self._bytes}"
+        return f"{self._shortname}{8 * self._bytes}{f'_{self._variant}' if self._variant else ''}"
 
     # TODO Fix name printing
     def __repr__(self):
-        return f"{self._name}{8 * self._bytes}{'_' if self._is_weak else ''}"
+        return (
+            f"{self._name}{8 * self._bytes}{f'_{self._variant}' if self._variant else ''}{'_' if self._is_weak else ''}"
+        )
 
     def __str__(self):
         return self.__repr__()
 
     def __hash__(self) -> int:
-        return hash((self._name, self._bytes, self._is_weak))
+        return hash((self._name, self._bytes, self._is_weak, f"{self._variant if self._variant else ''}"))
 
     def __eq__(self, other) -> bool:
         if not isinstance(other, dtype):
             return False
 
-        return self._name == other._name and self._bytes == other._bytes and self._is_weak == other._is_weak
+        return (
+            self._name == other._name
+            and self._bytes == other._bytes
+            and self._is_weak == other._is_weak
+            and self._variant == other._variant
+        )
 
 
 class exact(dtype):
     """Abstract base class for the signedinteger, unsignedinteger and bool_ dtypes."""
 
 
 class signedinteger(exact):
@@ -148,22 +156,32 @@
 class inexact(dtype):
     """Abstract base class for the floating and complexfloating dtypes."""
 
     pass
 
 
 class floating(inexact):
-    """Base class for the floating dtypes: bfloat16, float16, float32, float64."""
+    """Base class for the floating dtypes: float8, bfloat16, float16, float32, float64."""
 
-    def __init__(self, name, shortname, *, bytes, is_weak):
-        super().__init__(python_type=float, name=name, shortname=shortname, bytes=bytes, is_weak=is_weak)
+    def __init__(self, name, shortname, *, bytes, is_weak, variant=None):
+        super().__init__(
+            python_type=float, name=name, shortname=shortname, bytes=bytes, is_weak=is_weak, variant=variant
+        )
 
 
 bfloat16 = floating("bfloat", "bf", bytes=2, is_weak=False)
 bfloat16_ = floating("bfloat", "bf", bytes=2, is_weak=True)
+float8_e5m2 = floating("float", "f", bytes=1, is_weak=False, variant="e5m2")
+float8_e5m2_ = floating("float", "f", bytes=1, is_weak=True, variant="e5m2")
+float8_e5m2fnuz = floating("float", "f", bytes=1, is_weak=False, variant="e5m2fnuz")
+float8_e5m2fnuz_ = floating("float", "f", bytes=1, is_weak=True, variant="e5m2fnuz")
+float8_e4m3fn = floating("float", "f", bytes=1, is_weak=False, variant="e4m3fn")
+float8_e4m3fn_ = floating("float", "f", bytes=1, is_weak=True, variant="e4m3fn")
+float8_e4m3fnuz = floating("float", "f", bytes=1, is_weak=False, variant="e4m3fnuz")
+float8_e4m3fnuz_ = floating("float", "f", bytes=1, is_weak=True, variant="e4m3fnuz")
 float16 = floating("float", "f", bytes=2, is_weak=False)
 float16_ = floating("float", "f", bytes=2, is_weak=True)
 float32 = floating("float", "f", bytes=4, is_weak=False)
 float32_ = floating("float", "f", bytes=4, is_weak=True)
 float64 = floating("float", "f", bytes=8, is_weak=False)
 float64_ = floating("float", "f", bytes=8, is_weak=True)
 
@@ -196,14 +214,22 @@
     int16_,
     int32,
     int32_,
     int64,
     int64_,
     bfloat16,
     bfloat16_,
+    float8_e5m2,
+    float8_e5m2_,
+    float8_e5m2fnuz,
+    float8_e5m2fnuz_,
+    float8_e4m3fn,
+    float8_e4m3fn_,
+    float8_e4m3fnuz,
+    float8_e4m3fnuz_,
     float16,
     float16_,
     float32,
     float32_,
     float64,
     float64_,
     complex32,
@@ -238,14 +264,18 @@
     d
     for d in all_dtypes
     if (isinstance(d, inexact) and d.bytes <= 2) or (isinstance(d, complexfloating) and d.bytes <= 4)
 }
 
 float_dtypes = {d for d in all_dtypes if isinstance(d, floating)} | {float}
 
+float_math_dtypes = {d for d in all_dtypes if isinstance(d, floating) and d.bytes >= 2}
+
+float_8bit_dtypes = {d for d in all_dtypes if (isinstance(d, floating) and d.bytes == 1)}
+
 complex_dtypes = {d for d in all_dtypes if isinstance(d, complexfloating)} | {complex}
 
 inexact_dtypes = float_dtypes | complex_dtypes
 
 weak_dtypes = {d for d in all_dtypes if d.is_weak} | all_numbertypes
 
 strong_dtypes = {d for d in all_dtypes if not d.is_weak}
@@ -302,29 +332,31 @@
 
 def has_subdtype(x, cls):
     dtype = to_dtype(x)
     return isinstance(dtype, cls)
 
 
 # Translates a sequence of dtypes and dtype classes into a concrete set of corresponding (strong) dtypes
-def resolve_dtypes(args):
+def resolve_dtypes(args: Iterable) -> set[dtype]:
     dtypes = set()
     for arg in args:
         if isinstance(arg, dtype):
-            dtypes.add(arg)
+            if not arg.is_weak:
+                dtypes.add(arg)
             continue
 
         if isinstance(arg, Iterable):
             for a in arg:
                 baseutils.check(
                     isinstance(a, dtype),
                     lambda: f"Iterables passed to resolve_dtypes must only contain dtypes, but found an Iterable with {a}",
                     exception_type=NotImplementedError,
                 )
-                dtypes.add(a)
+                if not a.is_weak:
+                    dtypes.add(a)
 
         baseutils.check(
             arg in (dtype, exact, signedinteger, unsignedinteger, bool_, inexact, floating, complexfloating),
             lambda: f"Excepted arguments to resolve_dtypes to be dtypes, sets of dtypes, or a dtype (sub)class, but got {arg}",
             exception_type=AssertionError,
         )
 
@@ -369,14 +401,18 @@
     bool8: bool8_,
     uint8: uint8_,
     int8: int8_,
     int16: int16_,
     int32: int32_,
     int64: int64_,
     bfloat16: bfloat16_,
+    float8_e5m2: float8_e5m2_,
+    float8_e5m2fnuz: float8_e5m2fnuz_,
+    float8_e4m3fn: float8_e4m3fn_,
+    float8_e4m3fnuz: float8_e4m3fnuz_,
     float16: float16_,
     float32: float32_,
     float64: float64_,
     complex32: complex32_,
     complex64: complex64_,
     complex128: complex128_,
 }
@@ -516,14 +552,22 @@
     int16: torch.int16,
     int32_: torch.int32,
     int32: torch.int32,
     int64_: torch.int64,
     int64: torch.int64,
     bfloat16_: torch.bfloat16,
     bfloat16: torch.bfloat16,
+    float8_e5m2: torch.float8_e5m2,
+    float8_e5m2_: torch.float8_e5m2,
+    float8_e5m2fnuz: torch.float8_e5m2fnuz,
+    float8_e5m2fnuz_: torch.float8_e5m2fnuz,
+    float8_e4m3fn: torch.float8_e4m3fn,
+    float8_e4m3fn_: torch.float8_e4m3fn,
+    float8_e4m3fnuz: torch.float8_e4m3fnuz,
+    float8_e4m3fnuz_: torch.float8_e4m3fnuz,
     float16_: torch.float16,
     float16: torch.float16,
     float32_: torch.float32,
     float32: torch.float32,
     float64_: torch.float64,
     float64: torch.float64,
     complex32_: torch.complex32,
@@ -547,15 +591,15 @@
 
     baseutils.check_type(x, dtype)
     return _thunder_to_torch_dtype_map[x]
 
 
 # Converts NumPy dtypes to and from thunder dtypes
 
-# NOTE NumPy does not support the bfloat16 or complexhalf (complex32) datatypes
+# NOTE NumPy does not support the bfloat16, complexhalf (complex32) or float8 datatypes
 _thunder_to_numpy_dtype_map = {
     bool: np.bool_,
     int: np.int_,
     float: np.float_,
     complex: np.cfloat,
     bool8_: np.bool_,
     bool8: np.bool_,
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/interpreter.py`

 * *Files 0% similar despite different names*

```diff
@@ -40,14 +40,15 @@
     MethodDescriptorType,
     MethodWrapperType,
     WrapperDescriptorType,
     TracebackType,
 )
 
 from thunder.core.baseutils import Singleton, init_colors, extract_callable_name
+from thunder.core.codeutils import Positions
 
 
 #
 # interpreter.py implements a Python interpreter in Python.
 #
 #   The interpreter is still being developed.
 #   See thunder/tests/test_interpreter.py for its current capabilities.
@@ -601,14 +602,21 @@
         self._push_frame_stack(frame)
         try:
             yield
         finally:
             pf = self._pop_frame_stack()
             assert pf is frame, "Frame stack inconsistency"
 
+    def get_current_user_source_location(self) -> tuple[str, Positions]:
+        for frame in reversed(self.frame_stack):
+            modname = unwrap(frame.globals).get("__name__", "")
+            if modname not in ("thunder.core.interpreter", "thunder.core.jit_ext"):
+                return frame.code.co_filename, frame.positions
+        return None, None
+
     # TODO Instead of appending to both the log and and interpreted_instructions we could
     #   consider just appending to the log and then filtering to only instructions when
     #   interpreted_instructions is accessed
     def record_interpreted_instruction(self, inst: dis.Instruction, /) -> InterpreterRuntimeCtx:
         if not self._record_history:
             return self
 
@@ -836,27 +844,14 @@
     def __str__(self):
         return f"<{type(self).__name__} typ={self.typ} handler={self.handler} level={self.level}>"
 
     def __repr__(self):
         return self.__str__()
 
 
-# Use dis.Positions in 3.11+ and make it up in <3.11
-if sys.version_info < (3, 11):
-
-    class Positions(NamedTuple):
-        lineno: int = None
-        end_lineno: int = None
-        col_offset: int = None
-        end_col_offset: int = None
-
-else:
-    Positions = dis.Positions
-
-
 def _positions_equal(p1: Positions | None, p2: Positions | None):
     if p1 is None or p2 is None:
         return p1 is p2  # both are None
     return (
         p1.lineno == p2.lineno
         and p1.col_offset == p2.col_offset
         and p1.end_lineno == p2.end_lineno
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/jit_ext.py`

 * *Files 2% similar despite different names*

```diff
@@ -4,26 +4,28 @@
 import builtins
 import collections
 from collections.abc import ValuesView, Iterable, Iterator
 from collections.abc import Callable, Sequence
 import weakref
 import random
 from functools import partial, wraps, reduce
+import linecache
 import operator
 import copy
 import contextvars
 from contextlib import contextmanager
 import dis
 import warnings
 from enum import Enum, auto
 from io import StringIO
 import inspect
 import time
 
 from thunder.core.compile_data import compile_data_and_stats, get_cache_option, using_symbolic_values, get_compile_data
+from thunder.core.symbol import bsym_header
 import thunder.clang as clang
 import thunder.core.transforms
 
 from types import (
     CellType,
     ClassMethodDescriptorType,
     CodeType,
@@ -48,15 +50,15 @@
     MethodType,
     GetSetDescriptorType,
     UnionType,
 )
 
 import torch
 from thunder.core.proxies import (
-    DDPType,
+    DistParallelType,
     proxy,
     Proxy,
     NumberProxy,
     StringProxy,
     TensorProxy,
     FutureTensorProxy,
     make_proxy_name,
@@ -74,14 +76,16 @@
     default_callbacks,
     INTERPRETER_CALLBACKS,
     INTERPRETER_SIGNALS,
     default_opcode_interpreter,
     _default_lookaside_map,
     default_lookaside,
     do_raise,
+    get_interpreterruntimectx,
+    InterpreterRuntimeCtx,
     is_opaque,
     Py_NULL,
     member_descriptor,
     WrappedValue,
     unwrap,
     wrap,
     wrap_const,
@@ -567,15 +571,18 @@
                 name = None
 
             p = proxy(uvalue, name=name, history=value.provenance)
 
             # TensorProxy attributes should be considered derived quantities, so we flag TensorProxies here
             value.provenance.ext_flag |= EXT_FLAG_IS_TENSOR_PROXY
 
-            if isinstance(p, TensorProxy) and p.ddp_type in (DDPType.REPLICATED, DDPType.FULLY_SHARDED):
+            if isinstance(p, TensorProxy) and p.distparallel_type in (
+                DistParallelType.REPLICATED,
+                DistParallelType.FULLY_SHARDED,
+            ):
                 p_new = thunder.distributed.prims.synchronize(
                     p,
                     self._process_group_for_ddp,
                 )
                 if isinstance(p.thunder_fsdp_padding_size, int):
                     p_new = p_new[: (p_new.shape[0] - p.thunder_fsdp_padding_size)]
                 p_orig = p
@@ -660,16 +667,31 @@
     def wrapper(*args, **kwargs):
         recursively_proxy(*args, **kwargs)
         return fn(*args, **kwargs)
 
     return wrapper
 
 
+def record_source_loc_in_symbol_header(fn):
+    @wraps(fn)
+    def wrapper(*args, **kwargs):
+        runtimectx: Interpreterruntimectx = get_interpreterruntimectx()
+        filename, positions = runtimectx.get_current_user_source_location()
+        ctx: GeneralJitCtx = get_general_jit_ctx()
+        ctx._computation_trace.set_current_source_location(filename, positions)
+        return fn(*args, **kwargs)
+
+    return wrapper
+
+
 _general_jit_lookaside_map.update(
-    {k: ensure_recursive_proxies(interpreter_needs_wrap(v)) for k, v in _torch_to_thunder_function_map.items()}
+    {
+        k: ensure_recursive_proxies(interpreter_needs_wrap(record_source_loc_in_symbol_header(v)))
+        for k, v in _torch_to_thunder_function_map.items()
+    }
 )
 
 
 def general_jit_lookaside(diverted_fn):
     def lookaside_wrapper(lookaside):
         _general_jit_lookaside_map[diverted_fn] = lookaside
         return lookaside
@@ -811,16 +833,22 @@
         elif isinstance(meth, property):
             if meth.fget is not None:
                 yield meth.fget, prop_lookaside_wrap(meth.fget)
 
 
 _general_jit_lookaside_map.update(
     {
-        **{fn: interpreter_needs_wrap(la) for fn, la in get_methods_properties(NumberProxy)},
-        **{fn: ensure_recursive_proxies(interpreter_needs_wrap(la)) for fn, la in get_methods_properties(TensorProxy)},
+        **{
+            fn: interpreter_needs_wrap(record_source_loc_in_symbol_header(la))
+            for fn, la in get_methods_properties(NumberProxy)
+        },
+        **{
+            fn: ensure_recursive_proxies(interpreter_needs_wrap(record_source_loc_in_symbol_header(la)))
+            for fn, la in get_methods_properties(TensorProxy)
+        },
         prop_lookaside_helper: prop_lookaside_helper,
     }
 )
 
 # TODO Implement safety --- UNSAFE, PERMISSIVE, SAFE
 _safe_functions: set = {
     dict.get,  # TODO Review safety of this
@@ -885,15 +913,15 @@
     if (executor_lookaside := ctx._executor_lookasides.get(fn, None)) is not None:
         lookaside = executor_lookaside
     elif isinstance(fn, Symbol) or fn in _clang_fn_set:
         # Performs symbol lookasides
         # NOTE Symbols "lookaside" to themselves; this just prevents their internals from being jitted
         # NOTE clang operations are not symbols, but we still prevent their internals from being jitted
         recursively_proxy(*args, **kwargs)
-        lookaside = interpreter_needs_wrap(fn)
+        lookaside = interpreter_needs_wrap(record_source_loc_in_symbol_header(fn))
     elif (general_jit_lookaside := _general_jit_lookaside_map.get(fn, None)) is not None:
         lookaside = general_jit_lookaside
     else:
         # Falls through to the interpreter's default lookaside
         lookaside = default_lookaside(fn, *args, **kwargs)
 
     if lookaside is None:
@@ -1550,14 +1578,15 @@
         record_history=record_history,
     )
 
     with general_jit_ctx(ctx):
         with tracectx(computation_trace):
             result = jfn(*args, **kwargs)
             prims.python_return(result)
+            computation_trace.set_current_source_location(None, None)
             process_recorded_modifications(ctx, epilogue_trace)
             last_interpreter_log = jfn._last_interpreter_log
 
     pro_to_comp, computation_intermediates = get_computation_inputs_and_intermediates(computation_trace)
 
     epilogue_inputs, _ = get_computation_inputs_and_intermediates(epilogue_trace)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/module.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/module.py`

 * *Files 19% similar despite different names*

```diff
@@ -26,46 +26,81 @@
 
         self._forward_fn = compiled_model_call
 
         # overrides for parameters and buffers (see get_buffer/get_parameter)
         # we populate these here for performance reasons (sam as module cache),
         # a single dict lookup is cheaper than traversin the module
         # hierarchy, see https://github.com/Lightning-AI/lightning-thunder/issues/396#issuecomment-2113231498
-        self._overrides = {
-            k: v for k, v in itertools.chain(self._model.named_parameters(), self._model.named_buffers())
-        }
+        self._overrides_parameters = dict(self._model.named_parameters())
+        self._overrides_buffers = dict(self._model.named_buffers())
         self._module_cache = {k: v for k, v in self._model.named_modules()}
-
         self._null = object()
 
     def get_buffer(self, name):
-        p = self._overrides.get(name, self._null)
+        p = self._overrides_buffers.get(name, self._null)
         if p is not self._null:
             return p
         return self._model.get_buffer(name)
 
     def set_buffer(self, name, value):
-        p = self._overrides[name] = value
+        p = self._overrides_buffers[name] = value
 
     def get_parameter(self, name):
-        p = self._overrides.get(name, self._null)
+        p = self._overrides_parameters.get(name, self._null)
         if p is not self._null:
             return p
         return self._model.get_parameter(name)
 
     def get_submodule(self, name):
         p = self._module_cache.get(name, self._null)
         if p is not self._null:
             return p
         return self._model.get_submodule(name)
 
     def forward(self, *args, **kwargs):
         res = self._forward_fn(*args, **kwargs)
         return res
 
+    def _named_parameters_or_buffers(self, overrides, orig_iter, prefix="", recurse=True, remove_duplicate=True):
+        seen_ids = set()
+        seen_names = set()
+        for k, v in itertools.chain(overrides.items(), orig_iter(remove_duplicate=remove_duplicate)):
+            if remove_duplicate:
+                id_v = id(v)
+                if id_v in seen_ids:
+                    continue
+                seen_ids.add(id_v)
+
+            mod, _, base_param = k.rpartition(".")
+            if recurse or not mod:
+                if k not in seen_names:
+                    seen_names.add(k)
+                    if prefix:
+                        yield (f"{prefix}.{k}", v)
+                    else:
+                        yield (k, v)
+
+    def named_parameters(self, prefix="", recurse=True, remove_duplicate=True):
+        yield from self._named_parameters_or_buffers(
+            self._overrides_parameters,
+            self._model.named_parameters,
+            prefix=prefix,
+            recurse=recurse,
+            remove_duplicate=remove_duplicate,
+        )
+
+    def named_buffers(self, prefix="", recurse=True, remove_duplicate=True):
+        yield from self._named_parameters_or_buffers(
+            self._overrides_buffers,
+            self._model.named_buffers,
+            prefix=prefix,
+            recurse=recurse,
+            remove_duplicate=remove_duplicate,
+        )
+
     @contextmanager
     def no_sync(self):
         r"""Context manager to disable gradient synchronization in data parallel mode.
 
         This context manager is intended to be used in conjunction with
         :class:`torch.nn.parallel.DistributedDataParallel` to disable gradient
         synchronization in the backward pass. It will not have any effect when
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/prims.py`

 * *Files 1% similar despite different names*

```diff
@@ -72,14 +72,15 @@
     numberproxy,
     pytype,
     pyval,
     Proxy,
     StringProxy,
     TupleProxy,
     AnyProxy,
+    IntegerProxy,
 )
 import thunder.core.codeutils as codeutils
 from thunder.core.codeutils import Printable
 import thunder.core.utils as utils
 import thunder.core.baseutils as baseutils
 import thunder.core.devices as devices
 import thunder.core.dtypes as dtypes
@@ -147,14 +148,15 @@
     UNIFORM = auto()
     UNIFORM_PHILOX = auto()
     RANDN = auto()
     EMPTY = auto()
     TENSOR_FROM_SEQUENCE = auto()
     # Probability distribution-related ops
     MULTINOMIAL = auto()
+    GET_AND_UPDATE_RNG_STATE = auto()
     # Reshaping and permuting prims
     BROADCAST_IN_DIM = auto()
     CAT = auto()
     FLIP = auto()
     RESHAPE = auto()
     SLICE = auto()
     SQUEEZE = auto()
@@ -2672,31 +2674,61 @@
     PrimIDs.UNIFORM,
     "uniform",
     meta=_uniform_meta,
     tags=(OpTags.RANDOM_OP,),
 )
 
 
+# Follow the nvFuser way to get the seed/offset used in nvFuser's philox RNG from the Torch's RNG state and
+# update the Torch's RNG state
+def _get_and_update_rng_state_meta(
+    seed: IntegerProxy | int | None, offset: IntegerProxy | int | None, device: devices.Device
+) -> tuple[IntegerProxy, IntegerProxy]:
+    seed_is_none = seed is None
+    offset_is_none = offset is None
+    utils.check(
+        not (seed_is_none ^ offset_is_none),
+        lambda: f"seed and offset must be given in pair (they are both None only used on first use of get_and_update_rng_statebut), but got {seed}, {offset}",
+    )
+    if not seed_is_none:
+        utils.check_type(seed, (IntegerProxy, int))
+    if not offset_is_none:
+        utils.check_type(offset, (IntegerProxy, int))
+    utils.check(
+        device.devicetype is devices.DeviceType.CUDA,
+        lambda: f"get_and_update_rng_state is supported for CUDA only",
+        exception_type=NotImplementedError,
+    )
+    return numberproxy(int, None), numberproxy(int, None)
+
+
+get_and_update_rng_state = make_prim(
+    PrimIDs.GET_AND_UPDATE_RNG_STATE,
+    "get_and_update_rng_state",
+    meta=_get_and_update_rng_state_meta,
+)
+
+
 def _uniform_philox_meta(
     shape: Sequence[int],
     minval: float,
     maxval: float,
     *,
     device: devices.Device,
     dtype: dtypes.dtype,
-    seed: int | TensorProxy,
-    offset: int | TensorProxy,
+    seed: int | IntegerProxy | TensorProxy,
+    offset: int | IntegerProxy | TensorProxy,
 ) -> TensorProxy:
     # Checks inputs
     utils.check_type(minval, float)
     utils.check_type(maxval, float)
     utils.check_type(device, devices.Device)
     utils.check_type(dtype, dtypes.dtype)
-    utils.check_type(seed, (int, TensorProxy))
-    utils.check_type(offset, (int, TensorProxy))
+    utils.check_type(seed, (int, TensorProxy, IntegerProxy))
+    utils.check_type(offset, (int, TensorProxy, IntegerProxy))
     utils.check(
         isinstance(seed, (int, IntegerProxy)) or seed.dtype is dtypes.int64,
         lambda: f"Expected {seed=} to be an integer or an int64 tensor",
     )
     utils.check(
         isinstance(offset, (int, IntegerProxy)) or seed.dtype is dtypes.int64,
         lambda: f"Expected {offset=} to be an integer or an int64 tensor",
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/proxies.py`

 * *Files 5% similar despite different names*

```diff
@@ -894,14 +894,17 @@
     def __itruediv__(self, other):
         return NotImplemented
 
     def __ixor__(self, other):
         return NotImplemented
 
 
+NumberLike = Number | NumberProxy
+
+
 def pyval(x: Number | str | AnyProxy) -> Number | str | any:
     baseutils.check_type(x, (NumberProxy, Number, str, AnyProxy))
 
     if isinstance(x, AnyProxy):
         return x._o
 
     if isinstance(x, (NumberProxy, StringProxy)):
@@ -987,54 +990,57 @@
         value_str = f"{self.value}" if self.value is not None else "?"
         return f"float {value_str}"
 
     def __repr__(self):
         return f"[FloatProxy name={self.name}, value={self.value}]"
 
 
-class DDPType(Enum):
+class DistParallelType(Enum):
     NONE = auto()
     REPLICATED = auto()
     FULLY_SHARDED = auto()
+    # Following two are for tensor parallelism
+    COLUMN_WISE = auto()
+    ROW_WISE = auto()
 
 
 def _infer_tensor_properties(
     like: TensorProxy | FutureTensorProxy | None = None,
     shape: ShapeLike | None = None,
     device: devices.Device | None = None,
     dtype: dtypes.dtype | None = None,
     requires_grad: bool | None = None,
-    ddp_type: DDPType | None = None,
+    distparallel_type: DistParallelType | None = None,
     thunder_fsdp_padding_size: int | None = None,
 ):
     _shape = None
     _device = None
     _dtype = None
     _requires_grad: None | bool = None
-    _ddp_type = DDPType.NONE
+    _dist_parallel_type = DistParallelType.NONE
     _thunder_fsdp_padding_size = None
 
     if like is not None:
         baseutils.check_type(like, (TensorProxy, FutureTensorProxy))
         _shape = tuple(like.shape)
         _device = like.device
         _dtype = like.true_dtype
         _requires_grad = like.requires_grad
-        _ddp_type = getattr(like, "ddp_type", DDPType.NONE)
+        _dist_parallel_type = getattr(like, "distparallel_type", DistParallelType.NONE)
 
     if shape is not None:
         baseutils.check_valid_shape(shape)
 
     _shape = tuple(shape) if shape is not None else _shape
     _device = device if device is not None else _device
     _dtype = dtype if dtype is not None else _dtype
     _dtype = dtypes.numbertype_to_dtype(_dtype) if dtypes.is_numbertype(_dtype) else _dtype
     _requires_grad = requires_grad if requires_grad is not None else _requires_grad
     _requires_grad = False if not dtypes.is_inexact_dtype(_dtype) else _requires_grad
-    _ddp_type = ddp_type if ddp_type is not None else _ddp_type
+    _dist_parallel_type = distparallel_type if distparallel_type is not None else _dist_parallel_type
     _thunder_fsdp_padding_size = (
         thunder_fsdp_padding_size if thunder_fsdp_padding_size is not None else _thunder_fsdp_padding_size
     )
 
     # Extracts actual values for shape
     # TODO RC1 Enable this
     if using_symbolic_values():
@@ -1050,31 +1056,41 @@
     # TODO Alias rank to ndim?
     _ndim = len(_shape)
 
     # Validates inputs
     baseutils.check_type(_device, devices.Device)
     baseutils.check_type(_dtype, dtypes.dtype)
     baseutils.check_type(_requires_grad, bool)
-    baseutils.check_type(_ddp_type, DDPType)
+    baseutils.check_type(_dist_parallel_type, DistParallelType)
     if isinstance(_thunder_fsdp_padding_size, int):
         baseutils.check(
-            _ddp_type == DDPType.FULLY_SHARDED,
-            lambda: f"{_ddp_type = } and {_thunder_fsdp_padding_size = } do not work",
+            _dist_parallel_type == DistParallelType.FULLY_SHARDED,
+            lambda: f"{_dist_parallel_type = } and {_thunder_fsdp_padding_size = } do not work",
         )
         baseutils.check(
             _thunder_fsdp_padding_size > 0,
             lambda: f"{_thunder_fsdp_padding_size=} expected to be > 0 or `None`",
         )
 
     # NOTE for simplicity functions that want to reason about weak dtypes should explicitly request
     #   the true_dtype property
     _true_dtype = _dtype
     _dtype = dtypes.to_strong_dtype(_dtype)
 
-    return _shape, _device, _dtype, _true_dtype, _numel, _ndim, _requires_grad, _ddp_type, _thunder_fsdp_padding_size
+    return (
+        _shape,
+        _device,
+        _dtype,
+        _true_dtype,
+        _numel,
+        _ndim,
+        _requires_grad,
+        _dist_parallel_type,
+        _thunder_fsdp_padding_size,
+    )
 
 
 # NOTE A FutureTensorProxy is intentionally NOT a subclass of TensorProxy
 class FutureTensorProxy(Proxy, TensorProxyInterface):
     def __init__(
         self,
         name: str | None = None,
@@ -1093,15 +1109,15 @@
             self._shape,
             self._device,
             self._dtype,
             self._true_dtype,
             self._numel,
             self._ndim,
             self._requires_grad,
-            _,  # ddp_type
+            _,  # distparallel_type
             _,  # thunder_fsdp_padding_size
         ) = _infer_tensor_properties(
             like,
             shape,
             device,
             dtype,
             False,
@@ -1160,31 +1176,33 @@
         *,
         like: TensorProxy | FutureTensorProxy | None = None,
         shape: ShapeLike | None = None,
         device: devices.Device | None = None,
         dtype: dtypes.dtype | None = None,
         requires_grad: bool | None = None,
         prefix: None | str = None,
-        ddp_type: DDPType | None = None,
+        distparallel_type: DistParallelType | None = None,
         history: None | tuple = None,
         thunder_fsdp_padding_size: int | None = None,
     ):
         super().__init__(name, prefix=prefix, history=history)
 
         (
             self._shape,
             self._device,
             self._dtype,
             self._true_dtype,
             self._numel,
             self._ndim,
             self._requires_grad,
-            self._ddp_type,
+            self._distparallel_type,
             self._thunder_fsdp_padding_size,
-        ) = _infer_tensor_properties(like, shape, device, dtype, requires_grad, ddp_type, thunder_fsdp_padding_size)
+        ) = _infer_tensor_properties(
+            like, shape, device, dtype, requires_grad, distparallel_type, thunder_fsdp_padding_size
+        )
 
     # NOTE The following properties DO NOT depend on the language context or record
     #   themselves into the trace, so they can be used when working with tensor proxies
     #   outside of a trace or language context
     @property
     def shape(self):
         return self._shape
@@ -1206,16 +1224,16 @@
         return self._true_dtype
 
     @property
     def requires_grad(self):
         return self._requires_grad
 
     @property
-    def ddp_type(self):
-        return self._ddp_type
+    def distparallel_type(self):
+        return self._distparallel_type
 
     @property
     def thunder_fsdp_padding_size(self):
         return self._thunder_fsdp_padding_size
 
     # We need to implement `__len__` as
     # > In addition to bypassing any instance attributes in the
@@ -1512,25 +1530,25 @@
     complex: ComplexProxy,
 }
 
 
 def tensorproxy(t: torch.Tensor, /, *, name: None | str, history: None | tuple = None) -> TensorProxy:
     device = devices.device_from_string(str(t.device))
     dtype = dtypes.to_dtype(t.dtype)
-    # See Note [DistributedDataParallel and ddp_type]
-    ddp_type = getattr(t, "ddp_type", None)
+    # See Note [DistributedDataParallel and distparallel_type]
+    distparallel_type = getattr(t, "distparallel_type", None)
     _thunder_fsdp_padding_size = getattr(t, "_thunder_fsdp_padding_size", None)
     # NOTE Without tuple(t.shape) then the shape would be a torch.Size object
     return TensorProxy(
         name,
         shape=tuple(t.shape),
         device=device,
         dtype=dtype,
         requires_grad=t.requires_grad,
-        ddp_type=ddp_type,
+        distparallel_type=distparallel_type,
         history=history,
         thunder_fsdp_padding_size=_thunder_fsdp_padding_size,
     )
 
 
 def futuretensorproxy(
     t: torch.Tensor | TensorProxy | FutureTensorProxy, /, *, name: None | str, history: None | tuple = None
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/rematerialization.py`

 * *Files 1% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 import time
 
 from igraph import Graph
 
 from thunder.core import prims, utils
 from thunder.core.baseutils import BoundSymbolInterface, ProxyInterface
 from thunder.core.prims import PrimIDs
-from thunder.core.proxies import TensorProxy, variableify
+from thunder.core.proxies import TensorProxy, variableify, NumberProxy
 from thunder.core.pytree import tree_flatten, tree_unflatten
 from thunder.core.symbol import has_tags
 from thunder.core.trace import from_trace, TraceCtx, TraceProvenance
 from thunder.core.transform_common import dce
 from thunder.executors.passes import update_fusion_call_ctx
 
 
@@ -328,14 +328,16 @@
     combined_trace = TraceCtx(None)
     combined_trace.bound_symbols = (*producer.subsymbols, *consumer.subsymbols)
     combined_consumers = utils.consumers(combined_trace)
 
     def get_weight(var):
         if isinstance(var, TensorProxy):
             return WEIGHT * var.dtype.bytes
+        elif isinstance(var, NumberProxy):
+            return 0.0
         return WEIGHT
 
     def add_edges(var):
         var_name = var.name
         weight = get_weight(var)
         weight = weight / 2.0 if var_name in (x.name for x in producer.args) else weight
         add_edge(var_name + "_in", var_name + "_out", capacity=weight)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/symbol.py`

 * *Files 6% similar despite different names*

```diff
@@ -11,15 +11,15 @@
 from dataclasses import dataclass, field
 from typing import Any, Dict, Optional, List, Type, Tuple, TYPE_CHECKING
 from collections.abc import Callable, Iterable
 from collections.abc import Sequence
 
 import thunder.core.baseutils as baseutils
 import thunder.core.codeutils as codeutils
-from thunder.core.codeutils import Printable
+from thunder.core.codeutils import Printable, Positions
 from thunder.core.baseutils import BoundSymbolInterface, ProxyInterface
 from thunder.core.pytree import tree_flatten, tree_unflatten, tree_map
 import thunder.core.dtypes as dtypes
 import thunder.core.devices as devices
 from thunder.core.proxies import Proxy, NumberProxy, variableify, CollectionProxy
 
 from thunder.core.trace import (
@@ -209,21 +209,31 @@
         return ba.args, ba.kwargs
 
     # TODO Remove _call_ctx
     def bind(self, *args, output, subsymbols=(), _call_ctx: None | dict = None, **kwargs) -> BoundSymbol:
         if self.meta is not None:
             args, kwargs = self.normalize(*args, **kwargs)
 
+        trace = get_tracectx()
+        if trace is not None:
+            source_filename = trace._current_source_filename
+            source_positions = trace._current_source_positions
+        else:
+            source_filename = None
+            source_positions = None
+
         b = BoundSymbol(
             self,
             args=args,
             kwargs=kwargs,
             output=output,
             subsymbols=subsymbols,
             header=_bsym_header.get(),
+            source_filename=source_filename,
+            source_positions=source_positions,
             _call_ctx=_call_ctx,
         )
         if self._bind_postprocess:
             self._bind_postprocess(b)
         return b
 
     def __call__(self, *args, **kwargs):
@@ -290,14 +300,16 @@
     args: tuple
     kwargs: dict
     output: Any
     subsymbols: Sequence[BoundSymbol] = ()
 
     # Header is a string that may be printed before the symbol
     header: str | list[str] = ""
+    source_filename: str | None = None
+    source_positions: Positions | None = None
 
     _call_ctx: None | dict[str, Any] = None
 
     _import_ctx: dict = field(default_factory=dict)
     _object_ctx: dict = field(default_factory=dict)
     _executor: None | Any = None
 
@@ -320,14 +332,16 @@
         self_kwargs = {
             "sym": self.sym,
             "args": self.args,
             "kwargs": self.kwargs,
             "output": self.output,
             "subsymbols": self.subsymbols,
             "header": self.header,
+            "source_filename": self.source_filename,
+            "source_positions": self.source_positions,
             "_call_ctx": self._call_ctx,
             "_import_ctx": self._import_ctx,
             "_object_ctx": self._object_ctx,
             "_executor": self._executor,
         }
 
         self_kwargs.update(kwargs)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/trace.py`

 * *Files 4% similar despite different names*

```diff
@@ -12,15 +12,15 @@
 
 import thunder
 import thunder.core.codeutils as codeutils
 import thunder.core.baseutils as baseutils
 from thunder.core.baseutils import ProxyInterface, BoundSymbolInterface
 import thunder.core.devices as devices
 from thunder.core.pytree import tree_flatten, tree_unflatten
-from thunder.core.codeutils import ContextObject
+from thunder.core.codeutils import ContextObject, get_source_line, Positions
 
 
 # TODO see issue "Improve TraceProvenance"
 #   Make this more interesting / printer better -- maybe let
 #   practitioners acquire the pass callable so they can replicate the pass?
 # This class is intended to describe how the trace was constructed
 #   In particular, it's intended to describe the pass that created the trace,
@@ -58,14 +58,17 @@
 
         self.name_ctr = 0
         self.obj_name_ctr = 0
         self.names = set()
 
         self._object_ctx: dict[int, ContextObject] = {}
 
+        self._current_source_filename: str | None = None
+        self._current_source_positions: Positions | None = None
+
         self._provenance: TraceProvenance | None = None
 
         # Objects related to unpacking
         # NOTE While unpacking inputs we also sometimes want to convert those inputs
         #   For example, when converting NumPy arrays we want to convert them to torch tensors
         #   Having this happen while unpacking is tricky to read, so we want the conversion
         #   to happen when the unpacking is finished.
@@ -302,14 +305,18 @@
 
         # Creates common ctx
         import_ctx.update(call_ctx)
         import_ctx.update(object_ctx)
 
         return import_ctx
 
+    def set_current_source_location(self, filename: str | None, positions: Positions | None):
+        self._current_source_filename = filename
+        self._current_source_positions = positions
+
     # TODO Account for multi-line signatures
     # TODO issue "Add type annotations to Python function produced by traces"
     #   Consider extending the signature with type information, in particular the
     #   the type information of the return value might be interesting
     def python(self, *, print_depth: int = 1, include_decorators: bool = True) -> str:
         token = set_tracectx(self)
 
@@ -402,15 +409,30 @@
             #     program.extend(constant_python)
 
             # Separates constants from operations
             # if len(constants) > 0:
             #     program.append("")
 
             # Prints operations
-            for bsym in self.bound_symbols:
+
+            filename = None
+            lineno = None
+            for i, bsym in enumerate(self.bound_symbols):
+                if (
+                    bsym.source_filename is not None
+                    and bsym.source_positions is not None
+                    and bsym.source_positions.lineno is not None
+                ) and (filename != bsym.source_filename or lineno != bsym.source_positions.lineno):
+                    if i > 0:
+                        program.append("")
+                    src_line = get_source_line(bsym.source_filename, bsym.source_positions.lineno)
+                    program.append(f"""  # {bsym.source_filename}:{bsym.source_positions.lineno}: \t{src_line}""")
+                filename = bsym.source_filename
+                lineno = bsym.source_positions and bsym.source_positions.lineno
+
                 lines = bsym.python(indent=1, print_depth=print_depth)
                 program.extend(lines)
 
             python = "\n".join(program)
 
             return python
         finally:
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/transforms.py`

 * *Files 4% similar despite different names*

```diff
@@ -1014,7880 +1014,6978 @@
 00003f50: 0a20 2020 2020 2020 2066 726f 6d20 7468  .        from th
 00003f60: 756e 6465 7220 696d 706f 7274 2054 6875  under import Thu
 00003f70: 6e64 6572 4d6f 6475 6c65 0a0a 2020 2020  nderModule..    
 00003f80: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
 00003f90: 6528 6a66 6e2c 2054 6875 6e64 6572 4d6f  e(jfn, ThunderMo
 00003fa0: 6475 6c65 293a 0a20 2020 2020 2020 2020  dule):.         
 00003fb0: 2020 206a 666e 2e5f 6f76 6572 7269 6465     jfn._override
-00003fc0: 7320 3d20 6366 6e2e 5f6f 7665 7272 6964  s = cfn._overrid
-00003fd0: 6573 0a20 2020 2020 2020 2072 6574 7572  es.        retur
-00003fe0: 6e20 6a66 6e0a 0a20 2020 2063 7320 3d20  n jfn..    cs = 
-00003ff0: 6765 7461 7474 7228 6366 6e2c 2022 5f6c  getattr(cfn, "_l
-00004000: 635f 6373 222c 204e 6f6e 6529 0a20 2020  c_cs", None).   
-00004010: 2069 6620 6373 2069 7320 4e6f 6e65 3a0a   if cs is None:.
-00004020: 2020 2020 2020 2020 6373 203d 2043 6f6d          cs = Com
-00004030: 7069 6c65 5374 6174 7328 290a 0a20 2020  pileStats()..   
-00004040: 2074 7261 6e73 666f 726d 7320 3d20 6366   transforms = cf
-00004050: 6e2e 5f6c 635f 7472 616e 7366 6f72 6d73  n._lc_transforms
-00004060: 202b 205b 7472 616e 7366 6f72 6d5d 0a20   + [transform]. 
-00004070: 2020 2070 6f74 7261 6e73 666f 726d 7320     potransforms 
-00004080: 3d20 6366 6e2e 5f6c 635f 706f 7374 5f6f  = cfn._lc_post_o
-00004090: 7074 696d 697a 6174 696f 6e5f 7472 616e  ptimization_tran
-000040a0: 7366 6f72 6d73 0a20 2020 2075 7369 6e67  sforms.    using
-000040b0: 5f67 7261 645f 7472 616e 7366 6f72 6d20  _grad_transform 
-000040c0: 3d20 6366 6e2e 5f75 7369 6e67 5f67 7261  = cfn._using_gra
-000040d0: 645f 7472 616e 7366 6f72 6d0a 0a20 2020  d_transform..   
-000040e0: 206e 6366 6e20 3d20 5f63 7265 6174 655f   ncfn = _create_
-000040f0: 6361 6c6c 6162 6c65 280a 2020 2020 2020  callable(.      
-00004100: 2020 6364 2c0a 2020 2020 2020 2020 6373    cd,.        cs
-00004110: 2c0a 2020 2020 2020 2020 7472 616e 7366  ,.        transf
-00004120: 6f72 6d73 3d74 7261 6e73 666f 726d 732c  orms=transforms,
-00004130: 0a20 2020 2020 2020 2070 6f73 745f 6f70  .        post_op
-00004140: 7469 6d69 7a61 7469 6f6e 5f74 7261 6e73  timization_trans
-00004150: 666f 726d 733d 706f 7472 616e 7366 6f72  forms=potransfor
-00004160: 6d73 2c0a 2020 2020 2020 2020 5f75 7369  ms,.        _usi
-00004170: 6e67 5f67 7261 645f 7472 616e 7366 6f72  ng_grad_transfor
-00004180: 6d3d 7573 696e 675f 6772 6164 5f74 7261  m=using_grad_tra
-00004190: 6e73 666f 726d 2c0a 2020 2020 290a 2020  nsform,.    ).  
-000041a0: 2020 7265 7475 726e 206e 6366 6e0a 0a0a    return ncfn...
-000041b0: 2320 544f 444f 2043 6f6e 7369 6465 7220  # TODO Consider 
-000041c0: 7265 6661 6374 6f72 696e 6720 7468 6973  refactoring this
-000041d0: 2077 6974 6820 7468 6520 6162 6f76 650a   with the above.
-000041e0: 2320 4865 6c70 6572 2066 756e 6374 696f  # Helper functio
-000041f0: 6e20 746f 2061 6464 2061 2070 6f73 742d  n to add a post-
-00004200: 6f70 7469 6d69 7a61 7469 6f6e 2074 7261  optimization tra
-00004210: 6e73 666f 726d 0a64 6566 2061 6464 5f70  nsform.def add_p
-00004220: 6f73 745f 6f70 7469 6d69 7a61 7469 6f6e  ost_optimization
-00004230: 5f74 7261 6e73 666f 726d 2863 666e 3a20  _transform(cfn: 
-00004240: 4361 6c6c 6162 6c65 2c20 7472 616e 7366  Callable, transf
-00004250: 6f72 6d3a 2043 616c 6c61 626c 6529 202d  orm: Callable) -
-00004260: 3e20 4361 6c6c 6162 6c65 3a0a 2020 2020  > Callable:.    
-00004270: 6672 6f6d 2074 6875 6e64 6572 2e63 6f6d  from thunder.com
-00004280: 6d6f 6e20 696d 706f 7274 205f 6372 6561  mon import _crea
-00004290: 7465 5f63 616c 6c61 626c 652c 2043 6f6d  te_callable, Com
-000042a0: 7069 6c65 4461 7461 2c20 436f 6d70 696c  pileData, Compil
-000042b0: 6553 7461 7473 0a0a 2020 2020 6364 3a20  eStats..    cd: 
-000042c0: 4e6f 6e65 207c 2041 6e79 203d 2067 6574  None | Any = get
-000042d0: 6174 7472 2863 666e 2c20 225f 6c63 5f63  attr(cfn, "_lc_c
-000042e0: 6422 2c20 4e6f 6e65 290a 0a20 2020 2075  d", None)..    u
-000042f0: 7469 6c73 2e63 6865 636b 2863 6420 6973  tils.check(cd is
-00004300: 206e 6f74 204e 6f6e 652c 206c 616d 6264   not None, lambd
-00004310: 613a 2066 2243 616e 206f 6e6c 7920 7472  a: f"Can only tr
-00004320: 616e 7366 6f72 6d20 636f 6d70 696c 6564  ansform compiled
-00004330: 2074 6875 6e64 6572 2066 756e 6374 696f   thunder functio
-00004340: 6e73 2229 0a20 2020 2075 7469 6c73 2e63  ns").    utils.c
-00004350: 6865 636b 2869 7369 6e73 7461 6e63 6528  heck(isinstance(
-00004360: 6364 2c20 436f 6d70 696c 6544 6174 6129  cd, CompileData)
-00004370: 2c20 6c61 6d62 6461 3a20 6622 466f 756e  , lambda: f"Foun
-00004380: 6420 616e 2075 6e6b 6e6f 776e 2063 6f6d  d an unknown com
-00004390: 7069 6c65 2064 6174 6120 6174 7472 6962  pile data attrib
-000043a0: 7574 6520 7b63 647d 2229 0a0a 2020 2020  ute {cd}")..    
-000043b0: 6373 203d 2043 6f6d 7069 6c65 5374 6174  cs = CompileStat
-000043c0: 7328 290a 2020 2020 7472 616e 7366 6f72  s().    transfor
-000043d0: 6d73 203d 2063 666e 2e5f 6c63 5f74 7261  ms = cfn._lc_tra
-000043e0: 6e73 666f 726d 730a 2020 2020 706f 7472  nsforms.    potr
-000043f0: 616e 7366 6f72 6d73 203d 2063 666e 2e5f  ansforms = cfn._
-00004400: 6c63 5f70 6f73 745f 6f70 7469 6d69 7a61  lc_post_optimiza
-00004410: 7469 6f6e 5f74 7261 6e73 666f 726d 7320  tion_transforms 
-00004420: 2b20 5b74 7261 6e73 666f 726d 5d0a 0a20  + [transform].. 
-00004430: 2020 206e 6366 6e20 3d20 5f63 7265 6174     ncfn = _creat
-00004440: 655f 6361 6c6c 6162 6c65 2863 642c 2063  e_callable(cd, c
-00004450: 732c 2074 7261 6e73 666f 726d 733d 7472  s, transforms=tr
-00004460: 616e 7366 6f72 6d73 2c20 706f 7374 5f6f  ansforms, post_o
-00004470: 7074 696d 697a 6174 696f 6e5f 7472 616e  ptimization_tran
-00004480: 7366 6f72 6d73 3d70 6f74 7261 6e73 666f  sforms=potransfo
-00004490: 726d 7329 0a20 2020 2072 6574 7572 6e20  rms).    return 
-000044a0: 6e63 666e 0a0a 0a23 2054 6865 206e 6f2d  ncfn...# The no-
-000044b0: 6f70 2074 7261 6e73 666f 726d 2e20 4120  op transform. A 
-000044c0: 7472 6976 6961 6c20 636f 6d70 6f73 6162  trivial composab
-000044d0: 6c65 2074 7261 6e73 666f 726d 2c20 6f6e  le transform, on
-000044e0: 6c79 2075 7365 6675 6c20 6173 2061 6e20  ly useful as an 
-000044f0: 6578 616d 706c 652e 0a64 6566 205f 6e6f  example..def _no
-00004500: 6f70 5f74 7261 6e73 666f 726d 2874 7261  op_transform(tra
-00004510: 6365 3a20 5472 6163 652c 202a 2a6b 7761  ce: Trace, **kwa
-00004520: 7267 7329 202d 3e20 5472 6163 653a 0a20  rgs) -> Trace:. 
-00004530: 2020 2073 7461 7274 5f74 696d 655f 6e73     start_time_ns
-00004540: 203d 2074 696d 652e 7469 6d65 5f6e 7328   = time.time_ns(
-00004550: 290a 2020 2020 6e6f 6f70 5f74 7261 6365  ).    noop_trace
-00004560: 203d 2066 726f 6d5f 7472 6163 6528 7472   = from_trace(tr
-00004570: 6163 6529 0a0a 2020 2020 7472 6163 6563  ace)..    tracec
-00004580: 7478 5f74 6f6b 3a20 416e 790a 2020 2020  tx_tok: Any.    
-00004590: 7472 793a 0a20 2020 2020 2020 2074 7261  try:.        tra
-000045a0: 6365 6374 785f 746f 6b20 3d20 7365 745f  cectx_tok = set_
-000045b0: 7472 6163 6563 7478 286e 6f6f 705f 7472  tracectx(noop_tr
-000045c0: 6163 6529 0a20 2020 2020 2020 2070 7269  ace).        pri
-000045d0: 6d73 2e63 6f6d 6d65 6e74 2822 5468 6973  ms.comment("This
-000045e0: 2063 6f6d 6d65 6e74 2061 6464 6564 2062   comment added b
-000045f0: 7920 7468 6520 6e6f 2d6f 7020 7472 616e  y the no-op tran
-00004600: 7366 6f72 6d22 290a 2020 2020 6669 6e61  sform").    fina
-00004610: 6c6c 793a 0a20 2020 2020 2020 2072 6573  lly:.        res
-00004620: 6574 5f74 7261 6365 6374 7828 7472 6163  et_tracectx(trac
-00004630: 6563 7478 5f74 6f6b 290a 0a20 2020 206e  ectx_tok)..    n
-00004640: 6f6f 705f 7472 6163 652e 626f 756e 645f  oop_trace.bound_
-00004650: 7379 6d62 6f6c 732e 6578 7465 6e64 2874  symbols.extend(t
-00004660: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-00004670: 6c73 290a 0a20 2020 2065 6e64 5f74 696d  ls)..    end_tim
-00004680: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
-00004690: 5f6e 7328 290a 2020 2020 656c 6170 7365  _ns().    elapse
-000046a0: 645f 7469 6d65 5f6e 7320 3d20 656e 645f  d_time_ns = end_
-000046b0: 7469 6d65 5f6e 7320 2d20 7374 6172 745f  time_ns - start_
-000046c0: 7469 6d65 5f6e 730a 2020 2020 656c 6170  time_ns.    elap
-000046d0: 7365 645f 7469 6d65 5f6d 696c 6c69 7320  sed_time_millis 
-000046e0: 3d20 656c 6170 7365 645f 7469 6d65 5f6e  = elapsed_time_n
-000046f0: 7320 2f2f 2031 3030 3030 3030 0a20 2020  s // 1000000.   
-00004700: 206e 6f6f 705f 7472 6163 652e 7365 745f   noop_trace.set_
-00004710: 7072 6f76 656e 616e 6365 2854 7261 6365  provenance(Trace
-00004720: 5072 6f76 656e 616e 6365 2866 224e 6f2d  Provenance(f"No-
-00004730: 6f70 2054 7261 6e73 666f 726d 2028 746f  op Transform (to
-00004740: 6f6b 207b 656c 6170 7365 645f 7469 6d65  ok {elapsed_time
-00004750: 5f6d 696c 6c69 737d 206d 696c 6c69 7365  _millis} millise
-00004760: 636f 6e64 7329 2229 290a 0a20 2020 2072  conds)"))..    r
-00004770: 6574 7572 6e20 6e6f 6f70 5f74 7261 6365  eturn noop_trace
-00004780: 0a0a 0a64 6566 206e 6f6f 7028 6366 6e3a  ...def noop(cfn:
-00004790: 2043 616c 6c61 626c 6529 202d 3e20 4361   Callable) -> Ca
-000047a0: 6c6c 6162 6c65 3a0a 2020 2020 7265 7475  llable:.    retu
-000047b0: 726e 2061 6464 5f74 7261 6e73 666f 726d  rn add_transform
-000047c0: 2863 666e 2c20 7472 616e 7366 6f72 6d3d  (cfn, transform=
-000047d0: 5f6e 6f6f 705f 7472 616e 7366 6f72 6d29  _noop_transform)
-000047e0: 0a0a 0a23 2054 6865 2063 6f6d 6d65 6e74  ...# The comment
-000047f0: 2066 7573 696f 6e73 2074 7261 6e73 666f   fusions transfo
-00004800: 726d 2e20 4a75 7374 2061 6464 7320 6120  rm. Just adds a 
-00004810: 636f 6d6d 656e 7420 6265 666f 7265 2061  comment before a
-00004820: 6e64 2061 6674 6572 2065 6163 6820 6675  nd after each fu
-00004830: 7369 6f6e 2e0a 2320 2020 5468 6973 2069  sion..#   This i
-00004840: 7320 616e 2065 7861 6d70 6c65 206f 6620  s an example of 
-00004850: 6120 706f 7374 2d6f 7074 696d 697a 6174  a post-optimizat
-00004860: 696f 6e20 7472 616e 7366 6f72 6d2e 0a64  ion transform..d
-00004870: 6566 205f 636f 6d6d 656e 745f 6675 7369  ef _comment_fusi
-00004880: 6f6e 735f 7472 616e 7366 6f72 6d28 7472  ons_transform(tr
-00004890: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-000048a0: 6172 6773 2920 2d3e 2054 7261 6365 3a0a  args) -> Trace:.
-000048b0: 2020 2020 7374 6172 745f 7469 6d65 5f6e      start_time_n
-000048c0: 7320 3d20 7469 6d65 2e74 696d 655f 6e73  s = time.time_ns
-000048d0: 2829 0a20 2020 2063 6f6d 6d65 6e74 6564  ().    commented
-000048e0: 5f74 7261 6365 203d 2066 726f 6d5f 7472  _trace = from_tr
-000048f0: 6163 6528 7472 6163 6529 0a0a 2020 2020  ace(trace)..    
-00004900: 6e62 7379 6d73 3a20 6c69 7374 5b42 6f75  nbsyms: list[Bou
-00004910: 6e64 5379 6d62 6f6c 5d20 3d20 5b5d 0a20  ndSymbol] = []. 
-00004920: 2020 2066 6f72 2062 7379 6d20 696e 2074     for bsym in t
-00004930: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-00004940: 6c73 3a0a 2020 2020 2020 2020 6966 2062  ls:.        if b
-00004950: 7379 6d2e 7379 6d2e 6973 5f66 7573 696f  sym.sym.is_fusio
-00004960: 6e3a 0a20 2020 2020 2020 2020 2020 2066  n:.            f
-00004970: 7573 696f 6e5f 6e61 6d65 203d 2062 7379  usion_name = bsy
-00004980: 6d2e 7379 6d2e 6e61 6d65 0a20 2020 2020  m.sym.name.     
-00004990: 2020 2020 2020 2070 7265 5f63 6f6d 6d65         pre_comme
-000049a0: 6e74 5f62 7379 6d20 3d20 7072 696d 732e  nt_bsym = prims.
-000049b0: 636f 6d6d 656e 742e 6269 6e64 2866 2242  comment.bind(f"B
-000049c0: 6566 6f72 6520 7b66 7573 696f 6e5f 6e61  efore {fusion_na
-000049d0: 6d65 7d22 2c20 6f75 7470 7574 3d4e 6f6e  me}", output=Non
-000049e0: 6529 0a20 2020 2020 2020 2020 2020 2070  e).            p
-000049f0: 6f73 745f 636f 6d6d 656e 745f 6273 796d  ost_comment_bsym
-00004a00: 203d 2070 7269 6d73 2e63 6f6d 6d65 6e74   = prims.comment
-00004a10: 2e62 696e 6428 6622 4166 7465 7220 7b66  .bind(f"After {f
-00004a20: 7573 696f 6e5f 6e61 6d65 7d22 2c20 6f75  usion_name}", ou
-00004a30: 7470 7574 3d4e 6f6e 6529 0a0a 2020 2020  tput=None)..    
-00004a40: 2020 2020 2020 2020 6e62 7379 6d73 2e65          nbsyms.e
-00004a50: 7874 656e 6428 5b70 7265 5f63 6f6d 6d65  xtend([pre_comme
-00004a60: 6e74 5f62 7379 6d2c 2062 7379 6d2c 2070  nt_bsym, bsym, p
-00004a70: 6f73 745f 636f 6d6d 656e 745f 6273 796d  ost_comment_bsym
-00004a80: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
-00004a90: 0a20 2020 2020 2020 2020 2020 206e 6273  .            nbs
-00004aa0: 796d 732e 6170 7065 6e64 2862 7379 6d29  yms.append(bsym)
-00004ab0: 0a0a 2020 2020 636f 6d6d 656e 7465 645f  ..    commented_
-00004ac0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-00004ad0: 6f6c 7320 3d20 6e62 7379 6d73 0a20 2020  ols = nbsyms.   
-00004ae0: 2065 6e64 5f74 696d 655f 6e73 203d 2074   end_time_ns = t
-00004af0: 696d 652e 7469 6d65 5f6e 7328 290a 2020  ime.time_ns().  
-00004b00: 2020 656c 6170 7365 645f 7469 6d65 5f6e    elapsed_time_n
-00004b10: 7320 3d20 656e 645f 7469 6d65 5f6e 7320  s = end_time_ns 
-00004b20: 2d20 7374 6172 745f 7469 6d65 5f6e 730a  - start_time_ns.
-00004b30: 2020 2020 656c 6170 7365 645f 7469 6d65      elapsed_time
-00004b40: 5f6d 696c 6c69 7320 3d20 656c 6170 7365  _millis = elapse
-00004b50: 645f 7469 6d65 5f6e 7320 2f2f 2031 3030  d_time_ns // 100
-00004b60: 3030 3030 0a0a 2020 2020 636f 6d6d 656e  0000..    commen
-00004b70: 7465 645f 7472 6163 652e 7365 745f 7072  ted_trace.set_pr
-00004b80: 6f76 656e 616e 6365 2854 7261 6365 5072  ovenance(TracePr
-00004b90: 6f76 656e 616e 6365 2866 2243 6f6d 6d65  ovenance(f"Comme
-00004ba0: 6e74 2046 7573 696f 6e73 2028 746f 6f6b  nt Fusions (took
-00004bb0: 207b 656c 6170 7365 645f 7469 6d65 5f6d   {elapsed_time_m
-00004bc0: 696c 6c69 737d 206d 696c 6c69 7365 636f  illis} milliseco
-00004bd0: 6e64 7329 2229 290a 0a20 2020 2072 6574  nds)"))..    ret
-00004be0: 7572 6e20 636f 6d6d 656e 7465 645f 7472  urn commented_tr
-00004bf0: 6163 650a 0a0a 6465 6620 636f 6d6d 656e  ace...def commen
-00004c00: 745f 6675 7369 6f6e 7328 6366 6e3a 2043  t_fusions(cfn: C
-00004c10: 616c 6c61 626c 6529 202d 3e20 4361 6c6c  allable) -> Call
-00004c20: 6162 6c65 3a0a 2020 2020 7265 7475 726e  able:.    return
-00004c30: 2061 6464 5f70 6f73 745f 6f70 7469 6d69   add_post_optimi
-00004c40: 7a61 7469 6f6e 5f74 7261 6e73 666f 726d  zation_transform
-00004c50: 2863 666e 2c20 5f63 6f6d 6d65 6e74 5f66  (cfn, _comment_f
-00004c60: 7573 696f 6e73 5f74 7261 6e73 666f 726d  usions_transform
-00004c70: 290a 0a0a 230a 2320 4865 6c70 6572 2066  )...#.# Helper f
-00004c80: 756e 6374 696f 6e73 2066 6f72 2063 6f6d  unctions for com
-00004c90: 706f 7361 626c 6520 7472 616e 7366 6f72  posable transfor
-00004ca0: 6d73 0a23 0a0a 0a23 2046 6c61 7474 656e  ms.#...# Flatten
-00004cb0: 7320 6120 6c69 7374 206f 6620 626f 756e  s a list of boun
-00004cc0: 6420 7379 6d62 6f6c 732c 2072 6574 7572  d symbols, retur
-00004cd0: 6e69 6e67 2074 6865 2066 6c61 7474 656e  ning the flatten
-00004ce0: 6564 206c 6973 740a 6465 6620 666c 6174  ed list.def flat
-00004cf0: 7465 6e5f 666f 725f 7472 616e 7366 6f72  ten_for_transfor
-00004d00: 6d28 7368 6f75 6c64 5f66 6c61 7474 656e  m(should_flatten
-00004d10: 3a20 4361 6c6c 6162 6c65 2c20 6273 796d  : Callable, bsym
-00004d20: 733a 206c 6973 745b 426f 756e 6453 796d  s: list[BoundSym
-00004d30: 626f 6c5d 2920 2d3e 206c 6973 745b 426f  bol]) -> list[Bo
-00004d40: 756e 6453 796d 626f 6c5d 3a0a 2020 2020  undSymbol]:.    
-00004d50: 666c 6174 7465 6e65 643a 206c 6973 745b  flattened: list[
-00004d60: 426f 756e 6453 796d 626f 6c5d 203d 205b  BoundSymbol] = [
-00004d70: 5d0a 0a20 2020 2064 6566 205f 666c 6174  ]..    def _flat
-00004d80: 7465 6e28 6273 796d 3a20 426f 756e 6453  ten(bsym: BoundS
-00004d90: 796d 626f 6c29 3a0a 2020 2020 2020 2020  ymbol):.        
-00004da0: 6966 2073 686f 756c 645f 666c 6174 7465  if should_flatte
-00004db0: 6e28 6273 796d 293a 0a20 2020 2020 2020  n(bsym):.       
-00004dc0: 2020 2020 2063 6865 636b 280a 2020 2020       check(.    
-00004dd0: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
-00004de0: 6273 796d 2e73 7562 7379 6d62 6f6c 7329  bsym.subsymbols)
-00004df0: 203e 2030 2c0a 2020 2020 2020 2020 2020   > 0,.          
-00004e00: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
-00004e10: 4e6f 2067 7261 6420 7275 6c65 2066 6f75  No grad rule fou
-00004e20: 6e64 2066 6f72 207b 6273 796d 7d20 616e  nd for {bsym} an
-00004e30: 6420 6e6f 2073 7562 7379 6d62 6f6c 7320  d no subsymbols 
-00004e40: 696e 7369 6465 2069 7420 746f 2063 7265  inside it to cre
-00004e50: 6174 6520 6120 6772 6164 2066 6f72 6d75  ate a grad formu
-00004e60: 6c61 222c 0a20 2020 2020 2020 2020 2020  la",.           
-00004e70: 2029 0a20 2020 2020 2020 2020 2020 2066   ).            f
-00004e80: 6f72 2073 6273 796d 2069 6e20 6273 796d  or sbsym in bsym
-00004e90: 2e73 7562 7379 6d62 6f6c 733a 0a20 2020  .subsymbols:.   
-00004ea0: 2020 2020 2020 2020 2020 2020 205f 666c               _fl
-00004eb0: 6174 7465 6e28 7362 7379 6d29 0a20 2020  atten(sbsym).   
-00004ec0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00004ed0: 2020 2020 2020 2066 6c61 7474 656e 6564         flattened
-00004ee0: 2e61 7070 656e 6428 6273 796d 290a 0a20  .append(bsym).. 
-00004ef0: 2020 2066 6f72 2062 7379 6d20 696e 2062     for bsym in b
-00004f00: 7379 6d73 3a0a 2020 2020 2020 2020 5f66  syms:.        _f
-00004f10: 6c61 7474 656e 2862 7379 6d29 0a0a 2020  latten(bsym)..  
-00004f20: 2020 7265 7475 726e 2066 6c61 7474 656e    return flatten
-00004f30: 6564 0a0a 0a23 0a23 2050 6861 6e74 6f6d  ed...#.# Phantom
-00004f40: 2067 7261 6420 7472 616e 7366 6f72 6d0a   grad transform.
-00004f50: 230a 0a23 0a23 2046 756e 6374 696f 6e73  #..#.# Functions
-00004f60: 2072 656c 6174 6564 2074 6f20 6675 6e63   related to func
-00004f70: 7469 6f6e 616c 697a 696e 6720 5468 756e  tionalizing Thun
-00004f80: 6465 724f 7074 696d 697a 6564 4d6f 6475  derOptimizedModu
-00004f90: 6c65 730a 230a 0a0a 2320 544f 444f 2054  les.#...# TODO T
-00004fa0: 6573 7420 7769 7468 2062 7566 6665 7273  est with buffers
-00004fb0: 0a64 6566 2070 6f70 756c 6174 655f 6772  .def populate_gr
-00004fc0: 6164 7328 6772 6164 733a 206c 6973 745b  ads(grads: list[
-00004fd0: 5465 6e73 6f72 5072 6f78 795d 2c20 746f  TensorProxy], to
-00004fe0: 6d3a 204e 6f6e 6520 7c20 746f 7263 682e  m: None | torch.
-00004ff0: 6e6e 2e4d 6f64 756c 6520 3d20 4e6f 6e65  nn.Module = None
-00005000: 2c20 6172 6773 3d4e 6f6e 652c 206b 7761  , args=None, kwa
-00005010: 7267 733d 4e6f 6e65 2920 2d3e 204e 6f6e  rgs=None) -> Non
-00005020: 653a 0a20 2020 2069 6478 3a20 696e 7420  e:.    idx: int 
-00005030: 3d20 300a 2020 2020 6672 6f6d 2074 6875  = 0.    from thu
-00005040: 6e64 6572 2069 6d70 6f72 7420 5468 756e  nder import Thun
-00005050: 6465 724d 6f64 756c 652c 2063 6f6d 7069  derModule, compi
-00005060: 6c65 5f64 6174 610a 0a20 2020 2069 6620  le_data..    if 
-00005070: 6973 696e 7374 616e 6365 2874 6f6d 2c20  isinstance(tom, 
-00005080: 5468 756e 6465 724d 6f64 756c 6529 206f  ThunderModule) o
-00005090: 7220 636f 6d70 696c 655f 6461 7461 2874  r compile_data(t
-000050a0: 6f6d 292e 7573 696e 675f 6a69 743a 0a20  om).using_jit:. 
-000050b0: 2020 2020 2020 2061 7373 6572 7420 6172         assert ar
-000050c0: 6773 2069 7320 6e6f 7420 4e6f 6e65 2c20  gs is not None, 
-000050d0: 2270 6f70 756c 6174 6520 6772 6164 206e  "populate grad n
-000050e0: 6565 6473 2061 7267 7320 2861 6e64 2070  eeds args (and p
-000050f0: 6f73 7369 626c 7920 6b77 6172 6773 2920  ossibly kwargs) 
-00005100: 746f 2077 6f72 6b20 7769 7468 2054 6875  to work with Thu
-00005110: 6e64 6572 4d6f 6475 6c65 7322 0a20 2020  nderModules".   
-00005120: 2020 2020 2069 6620 6b77 6172 6773 2069       if kwargs i
-00005130: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00005140: 2020 2020 6b77 6172 6773 203d 207b 7d0a      kwargs = {}.
-00005150: 2020 2020 2020 2020 5f2c 2063 6f6d 7075          _, compu
-00005160: 7461 7469 6f6e 5f69 6e70 7574 732c 205f  tation_inputs, _
-00005170: 203d 2063 6f6d 7069 6c65 5f64 6174 6128   = compile_data(
-00005180: 746f 6d29 2e67 6574 5f63 6f6d 7075 7461  tom).get_computa
-00005190: 7469 6f6e 5f61 6e64 5f69 6e70 7574 7328  tion_and_inputs(
-000051a0: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-000051b0: 0a20 2020 2020 2020 2066 6f72 2070 2069  .        for p i
-000051c0: 6e20 636f 6d70 7574 6174 696f 6e5f 696e  n computation_in
-000051d0: 7075 7473 3a0a 2020 2020 2020 2020 2020  puts:.          
-000051e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000051f0: 702c 2074 6f72 6368 2e54 656e 736f 7229  p, torch.Tensor)
-00005200: 2061 6e64 2070 2e72 6571 7569 7265 735f   and p.requires_
-00005210: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
-00005220: 2020 2020 2020 2320 5375 7070 6f72 7473        # Supports
-00005230: 2067 7261 6420 6163 6375 6d75 6c61 7469   grad accumulati
-00005240: 6f6e 2028 6c69 6b65 2077 6865 6e20 7765  on (like when we
-00005250: 6967 6874 2074 7969 6e67 290a 2020 2020  ight tying).    
-00005260: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00005270: 2e67 7261 6420 6973 206e 6f74 204e 6f6e  .grad is not Non
-00005280: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00005290: 2020 2020 2020 2070 2e67 7261 6420 2b3d         p.grad +=
-000052a0: 2067 7261 6473 5b69 6478 5d0a 2020 2020   grads[idx].    
-000052b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000052c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000052d0: 2020 2020 2020 702e 6772 6164 203d 2067        p.grad = g
-000052e0: 7261 6473 5b69 6478 5d0a 2020 2020 2020  rads[idx].      
-000052f0: 2020 2020 2020 2020 2020 6964 7820 2b3d            idx +=
-00005300: 2031 0a20 2020 2020 2020 2072 6574 7572   1.        retur
-00005310: 6e0a 0a20 2020 2023 2053 686f 7274 2d63  n..    # Short-c
-00005320: 6972 6375 6974 7320 6966 2074 6865 7265  ircuits if there
-00005330: 2061 7265 206e 6f20 6172 6773 206f 7220   are no args or 
-00005340: 6b77 6172 6773 0a20 2020 2069 6620 6172  kwargs.    if ar
-00005350: 6773 2069 7320 4e6f 6e65 2061 6e64 206b  gs is None and k
-00005360: 7761 7267 7320 6973 204e 6f6e 653a 0a20  wargs is None:. 
-00005370: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00005380: 2020 2066 6c61 7473 2c20 5f20 3d20 7472     flats, _ = tr
-00005390: 6565 5f66 6c61 7474 656e 2828 6172 6773  ee_flatten((args
-000053a0: 2c20 6b77 6172 6773 2929 0a20 2020 2066  , kwargs)).    f
-000053b0: 6f72 2066 2069 6e20 666c 6174 733a 0a20  or f in flats:. 
-000053c0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000053d0: 616e 6365 2866 2c20 746f 7263 682e 5465  ance(f, torch.Te
-000053e0: 6e73 6f72 2920 616e 6420 662e 7265 7175  nsor) and f.requ
-000053f0: 6972 6573 5f67 7261 643a 0a20 2020 2020  ires_grad:.     
-00005400: 2020 2020 2020 2066 2e67 7261 6420 3d20         f.grad = 
-00005410: 6772 6164 735b 6964 785d 0a20 2020 2020  grads[idx].     
-00005420: 2020 2020 2020 2069 6478 202b 3d20 310a         idx += 1.
-00005430: 0a0a 6465 6620 6578 7472 6163 745f 6772  ..def extract_gr
-00005440: 6164 7328 6d6f 6475 6c65 3a20 746f 7263  ads(module: torc
-00005450: 682e 6e6e 2e4d 6f64 756c 6529 202d 3e20  h.nn.Module) -> 
-00005460: 7475 706c 655b 746f 7263 682e 5465 6e73  tuple[torch.Tens
-00005470: 6f72 2c20 2e2e 2e5d 3a0a 2020 2020 6772  or, ...]:.    gr
-00005480: 6164 7320 3d20 7475 706c 6528 0a20 2020  ads = tuple(.   
-00005490: 2020 2020 2066 2e67 7261 640a 2020 2020       f.grad.    
-000054a0: 2020 2020 666f 7220 6620 696e 2063 6861      for f in cha
-000054b0: 696e 286d 6f64 756c 652e 7061 7261 6d65  in(module.parame
-000054c0: 7465 7273 2829 2c20 6d6f 6475 6c65 2e62  ters(), module.b
-000054d0: 7566 6665 7273 2829 290a 2020 2020 2020  uffers()).      
-000054e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-000054f0: 662c 2074 6f72 6368 2e54 656e 736f 7229  f, torch.Tensor)
-00005500: 2061 6e64 2066 2e72 6571 7569 7265 735f   and f.requires_
-00005510: 6772 6164 2061 6e64 2066 2e67 7261 6420  grad and f.grad 
-00005520: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00005530: 290a 2020 2020 7265 7475 726e 2067 7261  ).    return gra
-00005540: 6473 0a0a 0a64 6566 2063 6c65 6172 5f67  ds...def clear_g
-00005550: 7261 6473 286d 6f64 756c 653a 2074 6f72  rads(module: tor
-00005560: 6368 2e6e 6e2e 4d6f 6475 6c65 2920 2d3e  ch.nn.Module) ->
-00005570: 204e 6f6e 653a 0a20 2020 2069 6620 6e6f   None:.    if no
-00005580: 7420 6973 696e 7374 616e 6365 286d 6f64  t isinstance(mod
-00005590: 756c 652c 2074 6f72 6368 2e6e 6e2e 4d6f  ule, torch.nn.Mo
-000055a0: 6475 6c65 293a 0a20 2020 2020 2020 2072  dule):.        r
-000055b0: 6574 7572 6e0a 0a20 2020 2066 6f72 2070  eturn..    for p
-000055c0: 2069 6e20 6d6f 6475 6c65 2e70 6172 616d   in module.param
-000055d0: 6574 6572 7328 293a 0a20 2020 2020 2020  eters():.       
-000055e0: 2070 2e67 7261 6420 3d20 4e6f 6e65 0a20   p.grad = None. 
-000055f0: 2020 2066 6f72 2062 2069 6e20 6d6f 6475     for b in modu
-00005600: 6c65 2e62 7566 6665 7273 2829 3a0a 2020  le.buffers():.  
-00005610: 2020 2020 2020 622e 6772 6164 203d 204e        b.grad = N
-00005620: 6f6e 650a 0a0a 6672 6f6d 2074 6875 6e64  one...from thund
-00005630: 6572 2e63 6f72 652e 696e 7465 7270 7265  er.core.interpre
-00005640: 7465 7220 696d 706f 7274 206d 616b 655f  ter import make_
-00005650: 6f70 6171 7565 0a66 726f 6d20 7468 756e  opaque.from thun
-00005660: 6465 722e 636f 7265 2e6c 616e 6763 7478  der.core.langctx
-00005670: 7320 696d 706f 7274 206c 616e 6763 7478  s import langctx
-00005680: 2c20 4c61 6e67 7561 6765 730a 0a0a 2320  , Languages...# 
-00005690: 544f 444f 2052 4331 2052 6570 6c61 6365  TODO RC1 Replace
-000056a0: 2077 6974 6820 6c61 6e67 6374 780a 6465   with langctx.de
-000056b0: 6620 746f 7263 6863 7478 2866 6e29 3a0a  f torchctx(fn):.
-000056c0: 2020 2020 5f66 6e20 3d20 6c61 6e67 6374      _fn = langct
-000056d0: 7828 4c61 6e67 7561 6765 732e 544f 5243  x(Languages.TORC
-000056e0: 4829 2866 6e29 0a20 2020 2072 6574 7572  H)(fn).    retur
-000056f0: 6e20 6d61 6b65 5f6f 7061 7175 6528 5f66  n make_opaque(_f
-00005700: 6e29 0a0a 0a5f 6772 6164 5f66 6e5f 6d61  n)..._grad_fn_ma
-00005710: 703a 2064 6963 745b 416e 792c 2043 616c  p: dict[Any, Cal
-00005720: 6c61 626c 655d 203d 207b 7d0a 0a0a 6465  lable] = {}...de
-00005730: 6620 7265 6769 7374 6572 5f67 7261 6428  f register_grad(
-00005740: 7379 6d5f 6f72 5f69 643a 2053 796d 626f  sym_or_id: Symbo
-00005750: 6c20 7c20 416e 792c 2067 7261 6466 6e3a  l | Any, gradfn:
-00005760: 2043 616c 6c61 626c 6529 202d 3e20 4e6f   Callable) -> No
-00005770: 6e65 3a0a 2020 2020 6964 3a20 416e 7920  ne:.    id: Any 
-00005780: 3d20 7379 6d5f 6f72 5f69 640a 2020 2020  = sym_or_id.    
-00005790: 6966 2069 7369 6e73 7461 6e63 6528 7379  if isinstance(sy
-000057a0: 6d5f 6f72 5f69 642c 2053 796d 626f 6c29  m_or_id, Symbol)
-000057b0: 3a0a 2020 2020 2020 2020 6964 203d 2073  :.        id = s
-000057c0: 796d 5f6f 725f 6964 2e69 640a 2020 2020  ym_or_id.id.    
-000057d0: 5f67 7261 645f 666e 5f6d 6170 5b69 645d  _grad_fn_map[id]
-000057e0: 203d 2067 7261 6466 6e0a 0a0a 2320 4772   = gradfn...# Gr
-000057f0: 6164 2066 756e 6374 696f 6e73 2066 6f72  ad functions for
-00005800: 2070 7269 6d73 0a66 726f 6d20 7468 756e   prims.from thun
-00005810: 6465 722e 636f 7265 2e70 7269 6d73 2069  der.core.prims i
-00005820: 6d70 6f72 7420 5072 696d 4944 7320 6173  mport PrimIDs as
-00005830: 2070 6964 732c 2067 6574 5f67 7261 642c   pids, get_grad,
-00005840: 2070 7574 5f67 7261 640a 0a0a 2320 4120   put_grad...# A 
-00005850: 6765 6e65 7261 6c69 7a61 7469 6f6e 206f  generalization o
-00005860: 6620 7072 696d 732e 7075 745f 6772 6164  f prims.put_grad
-00005870: 2074 6f20 7079 7472 6565 730a 2320 544f   to pytrees.# TO
-00005880: 444f 2043 6f6e 7369 6465 7220 7661 6c69  DO Consider vali
-00005890: 6461 7469 6e67 2074 6861 7420 7468 6520  dating that the 
-000058a0: 7370 6563 7320 6172 6520 7468 6520 7361  specs are the sa
-000058b0: 6d65 0a23 2054 4f44 4f20 436f 6e73 6964  me.# TODO Consid
-000058c0: 6572 2076 616c 6964 6174 696e 6720 7468  er validating th
-000058d0: 6174 2074 6861 7420 6f62 6a65 6374 2072  at that object r
-000058e0: 6571 7569 7265 7320 6772 6164 2028 616e  equires grad (an
-000058f0: 6420 6669 6c74 6572 696e 6720 6f2e 772e  d filtering o.w.
-00005900: 290a 6465 6620 7075 745f 6772 6164 7328  ).def put_grads(
-00005910: 612c 2067 293a 0a20 2020 2066 6c61 7473  a, g):.    flats
-00005920: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
-00005930: 656e 2861 290a 2020 2020 666c 6174 6772  en(a).    flatgr
-00005940: 6164 732c 205f 203d 2074 7265 655f 666c  ads, _ = tree_fl
-00005950: 6174 7465 6e28 6729 0a0a 2020 2020 666f  atten(g)..    fo
-00005960: 7220 662c 2066 6720 696e 207a 6970 2866  r f, fg in zip(f
-00005970: 6c61 7473 2c20 666c 6174 6772 6164 7329  lats, flatgrads)
-00005980: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-00005990: 6e73 7461 6e63 6528 662c 2054 656e 736f  nstance(f, Tenso
-000059a0: 7250 726f 7879 2920 616e 6420 6973 696e  rProxy) and isin
-000059b0: 7374 616e 6365 2866 672c 2054 656e 736f  stance(fg, Tenso
-000059c0: 7250 726f 7879 293a 0a20 2020 2020 2020  rProxy):.       
-000059d0: 2020 2020 2070 7574 5f67 7261 6428 662c       put_grad(f,
-000059e0: 2066 6729 0a0a 0a23 0a23 2055 6e70 6163   fg)...#.# Unpac
-000059f0: 6b69 6e67 206f 7065 7261 746f 7220 6772  king operator gr
-00005a00: 6164 730a 230a 0a23 204e 4f54 4520 7072  ads.#..# NOTE pr
-00005a10: 696d 732e 756e 7061 636b 5f65 6d70 7479  ims.unpack_empty
-00005a20: 5f64 6963 7420 6372 6561 7465 7320 6e6f  _dict creates no
-00005a30: 2067 7261 6420 6173 736f 6369 6174 696f   grad associatio
-00005a40: 6e73 0a72 6567 6973 7465 725f 6772 6164  ns.register_grad
-00005a50: 2870 6964 732e 554e 5041 434b 5f45 4d50  (pids.UNPACK_EMP
-00005a60: 5459 5f44 4943 542c 2070 7269 6d73 2e75  TY_DICT, prims.u
-00005a70: 6e70 6163 6b5f 656d 7074 795f 6469 6374  npack_empty_dict
-00005a80: 290a 0a23 204e 4f54 4520 7072 696d 732e  )..# NOTE prims.
-00005a90: 756e 7061 636b 5f6b 6579 2063 7265 6174  unpack_key creat
-00005aa0: 6573 206e 6f20 6772 6164 2061 7373 6f63  es no grad assoc
-00005ab0: 6961 7469 6f6e 730a 7265 6769 7374 6572  iations.register
-00005ac0: 5f67 7261 6428 7069 6473 2e55 4e50 4143  _grad(pids.UNPAC
-00005ad0: 4b5f 4b45 592c 2070 7269 6d73 2e75 6e70  K_KEY, prims.unp
-00005ae0: 6163 6b5f 6b65 7929 0a0a 2320 4e4f 5445  ack_key)..# NOTE
-00005af0: 2070 7269 6d73 2e75 6e70 6163 6b5f 7365   prims.unpack_se
-00005b00: 7175 656e 6365 2063 7265 6174 6573 206e  quence creates n
-00005b10: 6f20 6772 6164 2061 7373 6f63 6961 7469  o grad associati
-00005b20: 6f6e 730a 7265 6769 7374 6572 5f67 7261  ons.register_gra
-00005b30: 6428 7069 6473 2e55 4e50 4143 4b5f 5345  d(pids.UNPACK_SE
-00005b40: 5155 454e 4345 2c20 7072 696d 732e 756e  QUENCE, prims.un
-00005b50: 7061 636b 5f73 6571 7565 6e63 6529 0a0a  pack_sequence)..
-00005b60: 0a23 0a23 2044 6174 6120 6d6f 7665 6d65  .#.# Data moveme
-00005b70: 6e74 2061 6e64 2074 7261 6e73 666f 726d  nt and transform
-00005b80: 6174 696f 6e20 6f70 6572 6174 6f72 2067  ation operator g
-00005b90: 7261 6473 0a23 0a40 746f 7263 6863 7478  rads.#.@torchctx
-00005ba0: 0a64 6566 205f 636f 6e76 6572 745f 656c  .def _convert_el
-00005bb0: 656d 656e 745f 7479 7065 5f70 7269 6d5f  ement_type_prim_
-00005bc0: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
-00005bd0: 2054 656e 736f 7250 726f 7879 2c20 6474   TensorProxy, dt
-00005be0: 7970 653a 2074 7970 6520 7c20 6474 7970  ype: type | dtyp
-00005bf0: 6573 2e64 7479 7065 2920 2d3e 204e 756d  es.dtype) -> Num
-00005c00: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00005c10: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00005c20: 6d73 2e63 6f6e 7665 7274 5f65 6c65 6d65  ms.convert_eleme
-00005c30: 6e74 5f74 7970 6528 612c 2064 7479 7065  nt_type(a, dtype
-00005c40: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00005c50: 7261 6428 6677 6429 0a20 2020 2067 5f63  rad(fwd).    g_c
-00005c60: 6f6e 7665 7274 6564 203d 2070 7269 6d73  onverted = prims
-00005c70: 2e63 6f6e 7665 7274 5f65 6c65 6d65 6e74  .convert_element
-00005c80: 5f74 7970 6528 672c 2064 7479 7065 732e  _type(g, dtypes.
-00005c90: 746f 5f64 7479 7065 2861 2929 0a20 2020  to_dtype(a)).   
-00005ca0: 2070 7574 5f67 7261 6428 612c 2067 5f63   put_grad(a, g_c
-00005cb0: 6f6e 7665 7274 6564 290a 0a20 2020 2072  onverted)..    r
-00005cc0: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00005cd0: 7374 6572 5f67 7261 6428 7069 6473 2e43  ster_grad(pids.C
-00005ce0: 4f4e 5645 5254 5f45 4c45 4d45 4e54 5f54  ONVERT_ELEMENT_T
-00005cf0: 5950 452c 205f 636f 6e76 6572 745f 656c  YPE, _convert_el
-00005d00: 656d 656e 745f 7479 7065 5f70 7269 6d5f  ement_type_prim_
-00005d10: 6772 6164 290a 0a23 0a23 2054 656e 736f  grad)..#.# Tenso
-00005d20: 7220 6372 6561 7469 6f6e 206f 7065 7261  r creation opera
-00005d30: 746f 7220 6772 6164 730a 230a 0a23 204e  tor grads.#..# N
-00005d40: 4f54 4520 7072 696d 732e 6675 6c6c 2063  OTE prims.full c
-00005d50: 7265 6174 6573 206e 6f20 6772 6164 2061  reates no grad a
-00005d60: 7373 6f63 6961 7469 6f6e 730a 7265 6769  ssociations.regi
-00005d70: 7374 6572 5f67 7261 6428 7069 6473 2e46  ster_grad(pids.F
-00005d80: 554c 4c2c 2070 7269 6d73 2e66 756c 6c29  ULL, prims.full)
-00005d90: 0a0a 2320 4e4f 5445 2070 7269 6d73 2e69  ..# NOTE prims.i
-00005da0: 6f74 6120 6372 6561 7465 7320 6e6f 2067  ota creates no g
-00005db0: 7261 6420 6173 736f 6369 6174 696f 6e73  rad associations
-00005dc0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00005dd0: 6964 732e 494f 5441 2c20 7072 696d 732e  ids.IOTA, prims.
-00005de0: 696f 7461 290a 0a0a 6465 6620 5f75 6e69  iota)...def _uni
-00005df0: 666f 726d 5f67 7261 6428 7368 6170 652c  form_grad(shape,
-00005e00: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
-00005e10: 202a 2c20 6465 7669 6365 2c20 6474 7970   *, device, dtyp
-00005e20: 6529 3a0a 2020 2020 6677 642c 2073 6176  e):.    fwd, sav
-00005e30: 6564 203d 2075 6e69 666f 726d 5f61 7567  ed = uniform_aug
-00005e40: 5f66 7764 2873 6861 7065 2c20 6d69 6e76  _fwd(shape, minv
-00005e50: 616c 2c20 6d61 7876 616c 2c20 6465 7669  al, maxval, devi
-00005e60: 6365 3d64 6576 6963 652c 2064 7479 7065  ce=device, dtype
-00005e70: 3d64 7479 7065 290a 2020 2020 6720 3d20  =dtype).    g = 
-00005e80: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
-00005e90: 2020 5f2c 2067 6d69 6e76 616c 2c20 676d    _, gminval, gm
-00005ea0: 6178 7661 6c20 3d20 756e 6966 6f72 6d5f  axval = uniform_
-00005eb0: 6261 636b 7761 7264 282a 7361 7665 642c  backward(*saved,
-00005ec0: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
-00005ed0: 7328 286d 696e 7661 6c2c 206d 6178 7661  s((minval, maxva
-00005ee0: 6c29 2c20 2867 6d69 6e76 616c 2c20 676d  l), (gminval, gm
-00005ef0: 6178 7661 6c29 290a 2020 2020 7265 7475  axval)).    retu
-00005f00: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00005f10: 725f 6772 6164 2870 6964 732e 554e 4946  r_grad(pids.UNIF
-00005f20: 4f52 4d2c 205f 756e 6966 6f72 6d5f 6772  ORM, _uniform_gr
-00005f30: 6164 290a 0a23 0a23 2052 6573 6861 7069  ad)..#.# Reshapi
-00005f40: 6e67 2061 6e64 2070 6572 6d75 7469 6e67  ng and permuting
-00005f50: 206f 7065 7261 746f 7220 6772 6164 730a   operator grads.
-00005f60: 230a 0a0a 4074 6f72 6368 6374 780a 6465  #...@torchctx.de
-00005f70: 6620 5f62 726f 6164 6361 7374 5f69 6e5f  f _broadcast_in_
-00005f80: 6469 6d5f 7072 696d 5f67 7261 6428 0a20  dim_prim_grad(. 
-00005f90: 2020 2061 3a20 5465 6e73 6f72 5072 6f78     a: TensorProx
-00005fa0: 792c 2073 6861 7065 3a20 5365 7175 656e  y, shape: Sequen
-00005fb0: 6365 5b69 6e74 5d2c 2062 726f 6164 6361  ce[int], broadca
-00005fc0: 7374 5f64 696d 656e 7369 6f6e 733a 2053  st_dimensions: S
-00005fd0: 6571 7565 6e63 655b 696e 745d 0a29 202d  equence[int].) -
-00005fe0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00005ff0: 2020 2066 7764 203d 2070 7269 6d73 2e62     fwd = prims.b
-00006000: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
-00006010: 612c 2073 6861 7065 2c20 6272 6f61 6463  a, shape, broadc
-00006020: 6173 745f 6469 6d65 6e73 696f 6e73 290a  ast_dimensions).
-00006030: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00006040: 6428 6677 6429 0a0a 2020 2020 756e 6974  d(fwd)..    unit
-00006050: 5f64 696d 7320 3d20 7475 706c 6528 6920  _dims = tuple(i 
-00006060: 666f 7220 692c 2073 2069 6e20 656e 756d  for i, s in enum
-00006070: 6572 6174 6528 612e 7368 6170 6529 2069  erate(a.shape) i
-00006080: 6620 7320 3d3d 2031 290a 2020 2020 6263  f s == 1).    bc
-00006090: 6173 745f 6469 6d73 203d 2074 7570 6c65  ast_dims = tuple
-000060a0: 2862 2066 6f72 2069 2c20 6220 696e 2065  (b for i, b in e
-000060b0: 6e75 6d65 7261 7465 2862 726f 6164 6361  numerate(broadca
-000060c0: 7374 5f64 696d 656e 7369 6f6e 7329 2069  st_dimensions) i
-000060d0: 6620 6920 6e6f 7420 696e 2075 6e69 745f  f i not in unit_
-000060e0: 6469 6d73 290a 2020 2020 7265 6475 6365  dims).    reduce
-000060f0: 5f64 696d 7320 3d20 7475 706c 6528 7320  _dims = tuple(s 
-00006100: 666f 7220 692c 2073 2069 6e20 656e 756d  for i, s in enum
-00006110: 6572 6174 6528 7261 6e67 6528 6c65 6e28  erate(range(len(
-00006120: 7368 6170 6529 2929 2069 6620 6920 6e6f  shape))) if i no
-00006130: 7420 696e 2062 6361 7374 5f64 696d 7329  t in bcast_dims)
-00006140: 0a0a 2020 2020 6720 3d20 6c74 6f72 6368  ..    g = ltorch
-00006150: 2e73 756d 2867 2c20 7265 6475 6365 5f64  .sum(g, reduce_d
-00006160: 696d 7329 0a0a 2020 2020 2320 4e4f 5445  ims)..    # NOTE
-00006170: 2054 6869 7320 6d75 7374 2062 6520 636c   This must be cl
-00006180: 616e 672e 756e 7371 7565 657a 6520 6265  ang.unsqueeze be
-00006190: 6361 7573 6520 746f 7263 682e 756e 7371  cause torch.unsq
-000061a0: 7565 657a 652c 2075 6e6c 696b 6520 636c  ueeze, unlike cl
-000061b0: 616e 672e 756e 7371 7565 657a 652c 206f  ang.unsqueeze, o
-000061c0: 6e6c 7920 6163 6365 7074 7320 616e 2069  nly accepts an i
-000061d0: 6e74 6567 6572 0a20 2020 2023 2020 2028  nteger.    #   (
-000061e0: 7075 7420 616e 6f74 6865 7220 7761 792c  put another way,
-000061f0: 2074 6f72 6368 206f 6e6c 7920 616c 6c6f   torch only allo
-00006200: 7773 206f 6e65 2075 6e73 7175 6565 7a65  ws one unsqueeze
-00006210: 2061 7420 6120 7469 6d65 290a 2020 2020   at a time).    
-00006220: 6720 3d20 636c 616e 672e 756e 7371 7565  g = clang.unsque
-00006230: 657a 6528 672c 2075 6e69 745f 6469 6d73  eze(g, unit_dims
-00006240: 290a 0a20 2020 2070 7574 5f67 7261 6428  )..    put_grad(
-00006250: 612c 2067 290a 0a20 2020 2072 6574 7572  a, g)..    retur
-00006260: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-00006270: 5f67 7261 6428 7069 6473 2e42 524f 4144  _grad(pids.BROAD
-00006280: 4341 5354 5f49 4e5f 4449 4d2c 205f 6272  CAST_IN_DIM, _br
-00006290: 6f61 6463 6173 745f 696e 5f64 696d 5f70  oadcast_in_dim_p
-000062a0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-000062b0: 6368 6374 780a 6465 6620 5f63 6174 5f70  chctx.def _cat_p
-000062c0: 7269 6d5f 6772 6164 2874 656e 736f 7273  rim_grad(tensors
-000062d0: 3a20 6c69 7374 5b54 656e 736f 7250 726f  : list[TensorPro
-000062e0: 7879 5d2c 202f 2c20 6469 6d3a 2069 6e74  xy], /, dim: int
-000062f0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00006300: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00006310: 732e 6361 7428 7465 6e73 6f72 732c 2064  s.cat(tensors, d
-00006320: 696d 290a 0a20 2020 2067 203d 2067 6574  im)..    g = get
-00006330: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
-00006340: 736c 6963 655f 7374 6172 743a 2069 6e74  slice_start: int
-00006350: 203d 2030 0a20 2020 2074 3a20 5465 6e73   = 0.    t: Tens
-00006360: 6f72 5072 6f78 790a 2020 2020 666f 7220  orProxy.    for 
-00006370: 7420 696e 2074 656e 736f 7273 3a0a 2020  t in tensors:.  
-00006380: 2020 2020 2020 6469 6d5f 6c65 6e3a 2069        dim_len: i
-00006390: 6e74 203d 2074 2e73 6861 7065 5b64 696d  nt = t.shape[dim
-000063a0: 5d0a 2020 2020 2020 2020 736c 6963 655f  ].        slice_
-000063b0: 656e 643a 2069 6e74 203d 2073 6c69 6365  end: int = slice
-000063c0: 5f73 7461 7274 202b 2064 696d 5f6c 656e  _start + dim_len
-000063d0: 0a20 2020 2020 2020 2067 5f73 6c69 6365  .        g_slice
-000063e0: 3a20 5465 6e73 6f72 5072 6f78 7920 3d20  : TensorProxy = 
-000063f0: 636c 616e 672e 736c 6963 655f 696e 5f64  clang.slice_in_d
-00006400: 696d 2867 2c20 736c 6963 655f 7374 6172  im(g, slice_star
-00006410: 742c 2073 6c69 6365 5f65 6e64 2c20 6469  t, slice_end, di
-00006420: 6d3d 6469 6d29 0a20 2020 2020 2020 2073  m=dim).        s
-00006430: 6c69 6365 5f73 7461 7274 203d 2073 6c69  lice_start = sli
-00006440: 6365 5f65 6e64 0a20 2020 2020 2020 2070  ce_end.        p
-00006450: 7574 5f67 7261 6428 742c 2067 5f73 6c69  ut_grad(t, g_sli
-00006460: 6365 290a 0a20 2020 2072 6574 7572 6e20  ce)..    return 
-00006470: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00006480: 7261 6428 7069 6473 2e43 4154 2c20 5f63  rad(pids.CAT, _c
-00006490: 6174 5f70 7269 6d5f 6772 6164 290a 0a0a  at_prim_grad)...
-000064a0: 6465 6620 5f72 6573 6861 7065 5f70 7269  def _reshape_pri
-000064b0: 6d5f 6772 6164 2861 3a20 5465 6e73 6f72  m_grad(a: Tensor
-000064c0: 5072 6f78 792c 2073 6861 7065 3a20 7475  Proxy, shape: tu
-000064d0: 706c 655b 696e 742c 202e 2e2e 5d29 202d  ple[int, ...]) -
-000064e0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-000064f0: 2020 2066 7764 203d 2070 7269 6d73 2e72     fwd = prims.r
-00006500: 6573 6861 7065 2861 2c20 7368 6170 6529  eshape(a, shape)
-00006510: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-00006520: 6164 2866 7764 290a 0a20 2020 2061 5f67  ad(fwd)..    a_g
-00006530: 7261 6420 3d20 7072 696d 732e 7265 7368  rad = prims.resh
-00006540: 6170 6528 672c 2061 2e73 6861 7065 290a  ape(g, a.shape).
-00006550: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00006560: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00006570: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00006580: 6572 5f67 7261 6428 7069 6473 2e52 4553  er_grad(pids.RES
-00006590: 4841 5045 2c20 5f72 6573 6861 7065 5f70  HAPE, _reshape_p
-000065a0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-000065b0: 6368 6374 780a 6465 6620 5f73 6c69 6365  chctx.def _slice
-000065c0: 5f70 7269 6d5f 6772 6164 280a 2020 2020  _prim_grad(.    
-000065d0: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-000065e0: 7374 6172 745f 696e 6469 6365 733a 2053  start_indices: S
-000065f0: 6571 7565 6e63 655b 696e 745d 2c20 656e  equence[int], en
-00006600: 645f 696e 6469 6365 733a 2053 6571 7565  d_indices: Seque
-00006610: 6e63 655b 696e 745d 2c20 7374 7269 6465  nce[int], stride
-00006620: 733a 204e 6f6e 6520 7c20 5365 7175 656e  s: None | Sequen
-00006630: 6365 5b69 6e74 5d20 3d20 4e6f 6e65 0a29  ce[int] = None.)
-00006640: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
-00006650: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-00006660: 2e73 6c69 6365 5f70 7269 6d28 612c 2073  .slice_prim(a, s
-00006670: 7461 7274 5f69 6e64 6963 6573 2c20 656e  tart_indices, en
-00006680: 645f 696e 6469 6365 732c 2073 7472 6964  d_indices, strid
-00006690: 6573 290a 0a20 2020 2067 203d 2067 6574  es)..    g = get
-000066a0: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
-000066b0: 7061 6464 696e 6720 3d20 4e6f 6e65 0a20  padding = None. 
-000066c0: 2020 2069 6620 7374 7269 6465 7320 6973     if strides is
-000066d0: 204e 6f6e 6520 6f72 206e 702e 616c 6c28   None or np.all(
-000066e0: 6e70 2e65 7175 616c 2873 7472 6964 6573  np.equal(strides
-000066f0: 2c20 3129 293a 0a20 2020 2020 2020 2070  , 1)):.        p
-00006700: 6164 6469 6e67 203d 2074 7570 6c65 287a  adding = tuple(z
-00006710: 6970 2873 7461 7274 5f69 6e64 6963 6573  ip(start_indices
-00006720: 2c20 6e70 2e73 7562 7472 6163 7428 612e  , np.subtract(a.
-00006730: 7368 6170 652c 2065 6e64 5f69 6e64 6963  shape, end_indic
-00006740: 6573 292c 2028 302c 2920 2a20 6c65 6e28  es), (0,) * len(
-00006750: 7374 6172 745f 696e 6469 6365 7329 2929  start_indices)))
-00006760: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00006770: 2020 2072 6561 6c5f 6c69 6d69 7473 203d     real_limits =
-00006780: 206e 702e 6164 6428 0a20 2020 2020 2020   np.add(.       
-00006790: 2020 2020 2073 7461 7274 5f69 6e64 6963       start_indic
-000067a0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-000067b0: 6e70 2e77 6865 7265 286e 702e 6571 7561  np.where(np.equa
-000067c0: 6c28 672e 7368 6170 652c 2030 292c 2030  l(g.shape, 0), 0
-000067d0: 2c20 6e70 2e61 6464 2831 2c20 6e70 2e6d  , np.add(1, np.m
-000067e0: 756c 7469 706c 7928 6e70 2e73 7562 7472  ultiply(np.subtr
-000067f0: 6163 7428 672e 7368 6170 652c 2031 292c  act(g.shape, 1),
-00006800: 2073 7472 6964 6573 2929 292c 0a20 2020   strides))),.   
-00006810: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
-00006820: 6164 6469 6e67 203d 2074 7570 6c65 287a  adding = tuple(z
-00006830: 6970 2873 7461 7274 5f69 6e64 6963 6573  ip(start_indices
-00006840: 2c20 6e70 2e73 7562 7472 6163 7428 612e  , np.subtract(a.
-00006850: 7368 6170 652c 2072 6561 6c5f 6c69 6d69  shape, real_limi
-00006860: 7473 292c 206e 702e 7375 6274 7261 6374  ts), np.subtract
-00006870: 2873 7472 6964 6573 2c20 3129 2929 0a0a  (strides, 1)))..
-00006880: 2020 2020 2320 436f 6e76 6572 7473 204e      # Converts N
-00006890: 756d 5079 206e 756d 6265 7273 2074 6f20  umPy numbers to 
-000068a0: 5079 7468 6f6e 2069 6e74 730a 2020 2020  Python ints.    
-000068b0: 2320 544f 444f 2053 686f 756c 6420 7765  # TODO Should we
-000068c0: 2073 7570 706f 7274 204e 756d 5079 206e   support NumPy n
-000068d0: 756d 6265 7273 2062 6574 7465 723f 0a20  umbers better?. 
-000068e0: 2020 2070 6164 6469 6e67 203d 2074 7265     padding = tre
-000068f0: 655f 6d61 7028 696e 742c 2070 6164 6469  e_map(int, paddi
-00006900: 6e67 290a 2020 2020 615f 6772 6164 203d  ng).    a_grad =
-00006910: 2070 7269 6d73 2e70 6164 2867 2c20 636f   prims.pad(g, co
-00006920: 6e73 745f 6173 2830 2c20 672e 6474 7970  nst_as(0, g.dtyp
-00006930: 6529 2c20 7061 6464 696e 6729 0a20 2020  e), padding).   
-00006940: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-00006950: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-00006960: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-00006970: 6772 6164 2870 6964 732e 534c 4943 452c  grad(pids.SLICE,
-00006980: 205f 736c 6963 655f 7072 696d 5f67 7261   _slice_prim_gra
-00006990: 6429 0a0a 0a40 746f 7263 6863 7478 0a64  d)...@torchctx.d
-000069a0: 6566 205f 7371 7565 657a 655f 7072 696d  ef _squeeze_prim
-000069b0: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
-000069c0: 726f 7879 2c20 2f2c 2064 696d 733a 2074  roxy, /, dims: t
-000069d0: 7570 6c65 5b69 6e74 2c20 2e2e 2e5d 2920  uple[int, ...]) 
-000069e0: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
-000069f0: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
-00006a00: 7371 7565 657a 6528 612c 2074 7570 6c65  squeeze(a, tuple
-00006a10: 2864 696d 7329 290a 0a20 2020 2067 203d  (dims))..    g =
-00006a20: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
-00006a30: 2020 2023 204e 4f54 4520 5468 6973 2063     # NOTE This c
-00006a40: 616c 6c73 2063 6c61 6e67 2e75 6e73 7175  alls clang.unsqu
-00006a50: 6565 7a65 2c20 616e 6420 6e6f 7420 746f  eeze, and not to
-00006a60: 7263 682e 756e 7371 7565 657a 652c 2062  rch.unsqueeze, b
-00006a70: 6563 6175 7365 2074 6f72 6368 2e75 6e73  ecause torch.uns
-00006a80: 7175 6565 7a65 206f 6e6c 7920 7375 7070  queeze only supp
-00006a90: 6f72 7473 0a20 2020 2023 2020 2075 6e73  orts.    #   uns
-00006aa0: 7175 6565 7a69 6e67 2061 2073 696e 676c  queezing a singl
-00006ab0: 6520 6469 6d65 6e73 696f 6e0a 2020 2020  e dimension.    
-00006ac0: 615f 6772 6164 203d 2063 6c61 6e67 2e75  a_grad = clang.u
-00006ad0: 6e73 7175 6565 7a65 2867 2c20 6469 6d73  nsqueeze(g, dims
-00006ae0: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
-00006af0: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
-00006b00: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00006b10: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
-00006b20: 5155 4545 5a45 2c20 5f73 7175 6565 7a65  QUEEZE, _squeeze
-00006b30: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
-00006b40: 6f72 6368 6374 780a 6465 6620 5f74 616b  orchctx.def _tak
-00006b50: 655f 7072 696d 5f67 7261 6428 613a 2054  e_prim_grad(a: T
-00006b60: 656e 736f 7250 726f 7879 2c20 696e 6465  ensorProxy, inde
-00006b70: 783a 2054 656e 736f 7250 726f 7879 2c20  x: TensorProxy, 
-00006b80: 6469 6d3a 2069 6e74 2920 2d3e 2054 656e  dim: int) -> Ten
-00006b90: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
-00006ba0: 6420 3d20 7072 696d 732e 7461 6b65 2861  d = prims.take(a
-00006bb0: 2c20 696e 6465 782c 2064 696d 290a 0a20  , index, dim).. 
-00006bc0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00006bd0: 6677 6429 0a0a 2020 2020 2320 544f 444f  fwd)..    # TODO
-00006be0: 2053 7769 7463 6820 746f 206c 746f 7263   Switch to ltorc
-00006bf0: 682e 696e 6465 785f 6164 643f 0a20 2020  h.index_add?.   
-00006c00: 2023 204e 4f54 4520 496e 7465 6e74 696f   # NOTE Intentio
-00006c10: 6e61 6c6c 7920 6e6f 7420 6361 6c6c 696e  nally not callin
-00006c20: 6720 7a65 726f 735f 6c69 6b65 2074 6f20  g zeros_like to 
-00006c30: 6176 6f69 6420 7072 6573 6572 7669 6e67  avoid preserving
-00006c40: 2061 0a20 2020 2023 2054 4f44 4f20 5570   a.    # TODO Up
-00006c50: 6461 7465 2074 6f20 6361 6c6c 206c 746f  date to call lto
-00006c60: 7263 682e 7a65 726f 730a 2020 2020 7a65  rch.zeros.    ze
-00006c70: 726f 7320 3d20 7072 696d 732e 6675 6c6c  ros = prims.full
-00006c80: 2861 2e73 6861 7065 2c20 6669 6c6c 5f76  (a.shape, fill_v
-00006c90: 616c 7565 3d30 2c20 6465 7669 6365 3d61  alue=0, device=a
-00006ca0: 2e64 6576 6963 652c 2064 7479 7065 3d61  .device, dtype=a
-00006cb0: 2e64 7479 7065 290a 2020 2020 615f 6772  .dtype).    a_gr
-00006cc0: 6164 203d 2070 7269 6d73 2e69 6e64 6578  ad = prims.index
-00006cd0: 5f61 6464 287a 6572 6f73 2c20 696e 6465  _add(zeros, inde
-00006ce0: 782c 2067 2c20 6469 6d29 0a20 2020 2070  x, g, dim).    p
-00006cf0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
-00006d00: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
-00006d10: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00006d20: 6164 2870 6964 732e 5441 4b45 2c20 5f74  ad(pids.TAKE, _t
-00006d30: 616b 655f 7072 696d 5f67 7261 6429 0a0a  ake_prim_grad)..
-00006d40: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00006d50: 6761 7468 6572 5f70 7269 6d5f 6772 6164  gather_prim_grad
-00006d60: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
-00006d70: 2069 6e64 6578 3a20 5465 6e73 6f72 5072   index: TensorPr
-00006d80: 6f78 792c 2064 696d 3a20 696e 7429 202d  oxy, dim: int) -
-00006d90: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00006da0: 2020 2066 7764 203d 2070 7269 6d73 2e67     fwd = prims.g
-00006db0: 6174 6865 7228 612c 2069 6e64 6578 2c20  ather(a, index, 
-00006dc0: 6469 6d29 0a0a 2020 2020 6720 3d20 6765  dim)..    g = ge
-00006dd0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00006de0: 2320 4e4f 5445 2049 6e74 656e 7469 6f6e  # NOTE Intention
-00006df0: 616c 6c79 206e 6f74 2063 616c 6c69 6e67  ally not calling
-00006e00: 207a 6572 6f73 5f6c 696b 6520 746f 2061   zeros_like to a
-00006e10: 766f 6964 2070 7265 7365 7276 696e 6720  void preserving 
-00006e20: 5465 6e73 6f72 5072 6f78 7920 612e 0a20  TensorProxy a.. 
-00006e30: 2020 2023 2054 4f44 4f20 5570 6461 7465     # TODO Update
-00006e40: 2074 6f20 6361 6c6c 206c 746f 7263 682e   to call ltorch.
-00006e50: 7a65 726f 730a 2020 2020 7a65 726f 7320  zeros.    zeros 
-00006e60: 3d20 7072 696d 732e 6675 6c6c 2861 2e73  = prims.full(a.s
-00006e70: 6861 7065 2c20 6669 6c6c 5f76 616c 7565  hape, fill_value
-00006e80: 3d30 2c20 6465 7669 6365 3d61 2e64 6576  =0, device=a.dev
-00006e90: 6963 652c 2064 7479 7065 3d61 2e64 7479  ice, dtype=a.dty
-00006ea0: 7065 290a 2020 2020 615f 6772 6164 203d  pe).    a_grad =
-00006eb0: 2070 7269 6d73 2e73 6361 7474 6572 5f61   prims.scatter_a
-00006ec0: 6464 287a 6572 6f73 2c20 696e 6465 782c  dd(zeros, index,
-00006ed0: 2067 2c20 6469 6d29 0a20 2020 2070 7574   g, dim).    put
-00006ee0: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
-00006ef0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00006f00: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00006f10: 2870 6964 732e 4741 5448 4552 2c20 5f67  (pids.GATHER, _g
-00006f20: 6174 6865 725f 7072 696d 5f67 7261 6429  ather_prim_grad)
-00006f30: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00006f40: 205f 7363 6174 7465 725f 6164 645f 7072   _scatter_add_pr
-00006f50: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
-00006f60: 7250 726f 7879 2c20 2f2c 2069 6e64 6578  rProxy, /, index
-00006f70: 3a20 5465 6e73 6f72 5072 6f78 792c 2076  : TensorProxy, v
-00006f80: 616c 7565 3a20 5465 6e73 6f72 5072 6f78  alue: TensorProx
-00006f90: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
-00006fa0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00006fb0: 2075 7469 6c73 2e63 6865 636b 280a 2020   utils.check(.  
-00006fc0: 2020 2020 2020 6e6f 7420 7661 6c75 652e        not value.
-00006fd0: 5f72 6571 7569 7265 735f 6772 6164 206f  _requires_grad o
-00006fe0: 7220 7661 6c75 652e 7368 6170 6520 3d3d  r value.shape ==
-00006ff0: 2069 6e64 6578 2e73 6861 7065 2c0a 2020   index.shape,.  
-00007000: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
-00007010: 5468 6520 6772 6164 6965 6e74 2066 6f72  The gradient for
-00007020: 2074 6865 2076 616c 7565 2054 656e 736f   the value Tenso
-00007030: 7220 6973 2069 6d70 6c65 6d65 6e74 6564  r is implemented
-00007040: 206f 6e6c 7920 7768 656e 2076 616c 7565   only when value
-00007050: 2e73 6861 7065 203d 3d20 696e 6465 782e  .shape == index.
-00007060: 7368 6170 652e 2022 0a20 2020 2020 2020  shape. ".       
-00007070: 2022 7661 6c75 6520 7368 6170 6520 6973   "value shape is
-00007080: 207b 7661 6c75 652e 7368 6170 657d 2077   {value.shape} w
-00007090: 6869 6c65 2069 6e64 6578 2073 6861 7065  hile index shape
-000070a0: 2069 7320 7b69 6e64 6578 2e73 6861 7065   is {index.shape
-000070b0: 7d22 2c0a 2020 2020 290a 0a20 2020 2066  }",.    )..    f
-000070c0: 7764 203d 2070 7269 6d73 2e73 6361 7474  wd = prims.scatt
-000070d0: 6572 5f61 6464 2861 2c20 696e 6465 782c  er_add(a, index,
-000070e0: 2076 616c 7565 2c20 6469 6d29 0a0a 2020   value, dim)..  
-000070f0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007100: 7764 290a 2020 2020 2320 4e4f 5445 2054  wd).    # NOTE T
-00007110: 6865 2076 616c 7565 2067 7261 6469 656e  he value gradien
-00007120: 7420 6973 206f 6e6c 7920 636f 7272 6563  t is only correc
-00007130: 7420 7768 656e 2073 7263 2e73 6861 7065  t when src.shape
-00007140: 203d 3d20 696e 6465 782e 7368 6170 652e   == index.shape.
-00007150: 0a20 2020 2023 2053 6565 2068 7474 7073  .    # See https
-00007160: 3a2f 2f67 6974 6875 622e 636f 6d2f 7079  ://github.com/py
-00007170: 746f 7263 682f 7079 746f 7263 682f 6973  torch/pytorch/is
-00007180: 7375 6573 2f32 3736 3134 2369 7373 7565  sues/27614#issue
-00007190: 636f 6d6d 656e 742d 3536 3436 3438 3831  comment-56464881
-000071a0: 390a 2020 2020 7661 6c75 655f 6772 6164  9.    value_grad
-000071b0: 203d 2070 7269 6d73 2e67 6174 6865 7228   = prims.gather(
-000071c0: 672c 2069 6e64 6578 2c20 6469 6d29 0a20  g, index, dim). 
-000071d0: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
-000071e0: 2076 616c 7565 292c 2028 672c 2076 616c   value), (g, val
-000071f0: 7565 5f67 7261 6429 290a 0a20 2020 2072  ue_grad))..    r
-00007200: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00007210: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
-00007220: 4341 5454 4552 5f41 4444 2c20 5f73 6361  CATTER_ADD, _sca
-00007230: 7474 6572 5f61 6464 5f70 7269 6d5f 6772  tter_add_prim_gr
-00007240: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
-00007250: 6465 6620 5f74 616b 655f 616c 6f6e 675f  def _take_along_
-00007260: 6178 6973 5f70 7269 6d5f 6772 6164 2861  axis_prim_grad(a
-00007270: 3a20 5465 6e73 6f72 5072 6f78 792c 2069  : TensorProxy, i
-00007280: 6e64 6578 3a20 5465 6e73 6f72 5072 6f78  ndex: TensorProx
-00007290: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
-000072a0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-000072b0: 2066 7764 203d 2070 7269 6d73 2e74 616b   fwd = prims.tak
-000072c0: 655f 616c 6f6e 675f 6178 6973 2861 2c20  e_along_axis(a, 
-000072d0: 696e 6465 782c 2064 696d 290a 0a20 2020  index, dim)..   
-000072e0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-000072f0: 6429 0a20 2020 2023 204e 4f54 4520 496e  d).    # NOTE In
-00007300: 7465 6e74 696f 6e61 6c6c 7920 6e6f 7420  tentionally not 
-00007310: 6361 6c6c 696e 6720 7a65 726f 735f 6c69  calling zeros_li
-00007320: 6b65 2074 6f20 6176 6f69 6420 7072 6573  ke to avoid pres
-00007330: 6572 7669 6e67 2054 656e 736f 7250 726f  erving TensorPro
-00007340: 7879 2061 2e0a 2020 2020 2320 544f 444f  xy a..    # TODO
-00007350: 2055 7064 6174 6520 746f 2063 616c 6c20   Update to call 
-00007360: 6c74 6f72 6368 2e7a 6572 6f73 0a20 2020  ltorch.zeros.   
-00007370: 207a 6572 6f73 203d 2070 7269 6d73 2e66   zeros = prims.f
-00007380: 756c 6c28 612e 7368 6170 652c 2066 696c  ull(a.shape, fil
-00007390: 6c5f 7661 6c75 653d 302c 2064 6576 6963  l_value=0, devic
-000073a0: 653d 612e 6465 7669 6365 2c20 6474 7970  e=a.device, dtyp
-000073b0: 653d 612e 6474 7970 6529 0a20 2020 2061  e=a.dtype).    a
-000073c0: 5f67 7261 6420 3d20 7072 696d 732e 7363  _grad = prims.sc
-000073d0: 6174 7465 725f 6164 6428 7a65 726f 732c  atter_add(zeros,
-000073e0: 2069 6e64 6578 2c20 672c 2064 696d 290a   index, g, dim).
-000073f0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00007400: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00007410: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00007420: 6572 5f67 7261 6428 7069 6473 2e54 414b  er_grad(pids.TAK
-00007430: 455f 414c 4f4e 475f 4158 4953 2c20 5f74  E_ALONG_AXIS, _t
-00007440: 616b 655f 616c 6f6e 675f 6178 6973 5f70  ake_along_axis_p
-00007450: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-00007460: 6368 6374 780a 6465 6620 5f74 7261 6e73  chctx.def _trans
-00007470: 706f 7365 5f70 7269 6d5f 6772 6164 2861  pose_prim_grad(a
-00007480: 3a20 5465 6e73 6f72 5072 6f78 792c 2070  : TensorProxy, p
-00007490: 6572 6d75 7461 7469 6f6e 3a20 7475 706c  ermutation: tupl
-000074a0: 655b 696e 742c 202e 2e2e 5d29 202d 3e20  e[int, ...]) -> 
-000074b0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-000074c0: 2066 7764 203d 2070 7269 6d73 2e74 7261   fwd = prims.tra
-000074d0: 6e73 706f 7365 2861 2c20 7475 706c 6528  nspose(a, tuple(
-000074e0: 7065 726d 7574 6174 696f 6e29 290a 0a20  permutation)).. 
-000074f0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00007500: 6677 6429 0a20 2020 2075 6e64 6f20 3d20  fwd).    undo = 
-00007510: 5f61 7267 736f 7274 2870 6572 6d75 7461  _argsort(permuta
-00007520: 7469 6f6e 290a 2020 2020 615f 6772 6164  tion).    a_grad
-00007530: 203d 2070 7269 6d73 2e74 7261 6e73 706f   = prims.transpo
-00007540: 7365 2867 2c20 7475 706c 6528 756e 646f  se(g, tuple(undo
-00007550: 2929 0a20 2020 2070 7574 5f67 7261 6428  )).    put_grad(
-00007560: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00007570: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00007580: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00007590: 5452 414e 5350 4f53 452c 205f 7472 616e  TRANSPOSE, _tran
-000075a0: 7370 6f73 655f 7072 696d 5f67 7261 6429  spose_prim_grad)
-000075b0: 0a0a 230a 2320 4d65 6d6f 7279 206c 6179  ..#.# Memory lay
-000075c0: 6f75 7420 6f70 6572 6174 6f72 2067 7261  out operator gra
-000075d0: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
-000075e0: 0a64 6566 205f 7374 7269 6465 5f6f 7264  .def _stride_ord
-000075f0: 6572 5f70 7269 6d5f 6772 6164 2861 3a20  er_prim_grad(a: 
-00007600: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
-00007610: 6f72 6465 723a 2053 6571 7565 6e63 655b  order: Sequence[
-00007620: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
-00007630: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00007640: 7072 696d 732e 7374 7269 6465 5f6f 7264  prims.stride_ord
-00007650: 6572 2861 2c20 6f72 6465 7229 0a0a 2020  er(a, order)..  
-00007660: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007670: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
-00007680: 2861 2c20 6729 0a0a 2020 2020 7265 7475  (a, g)..    retu
-00007690: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-000076a0: 725f 6772 6164 2870 6964 732e 5354 5249  r_grad(pids.STRI
-000076b0: 4445 5f4f 5244 4552 2c20 5f73 7472 6964  DE_ORDER, _strid
-000076c0: 655f 6f72 6465 725f 7072 696d 5f67 7261  e_order_prim_gra
-000076d0: 6429 0a0a 0a23 0a23 2045 6c65 6d65 6e74  d)...#.# Element
-000076e0: 7769 7365 2075 6e61 7279 206f 7065 7261  wise unary opera
-000076f0: 746f 7220 6772 6164 730a 230a 4074 6f72  tor grads.#.@tor
-00007700: 6368 6374 780a 6465 6620 5f61 6273 5f70  chctx.def _abs_p
-00007710: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-00007720: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007730: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007740: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007750: 7764 203d 2070 7269 6d73 2e61 6273 2861  wd = prims.abs(a
-00007760: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00007770: 7261 6428 6677 6429 0a20 2020 2070 7574  rad(fwd).    put
-00007780: 5f67 7261 6428 612c 2067 202a 206c 746f  _grad(a, g * lto
-00007790: 7263 682e 7369 676e 2861 2929 0a0a 2020  rch.sign(a))..  
-000077a0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-000077b0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-000077c0: 732e 4142 532c 205f 6162 735f 7072 696d  s.ABS, _abs_prim
-000077d0: 5f67 7261 6429 0a0a 0a64 6566 205f 636f  _grad)...def _co
-000077e0: 735f 7072 696d 5f67 7261 6428 613a 204e  s_prim_grad(a: N
-000077f0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007800: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
-00007810: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00007820: 2020 6677 6420 3d20 7072 696d 732e 636f    fwd = prims.co
-00007830: 7328 6129 0a0a 2020 2020 6720 3d20 6765  s(a)..    g = ge
-00007840: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00007850: 7075 745f 6772 6164 2861 2c20 6720 2a20  put_grad(a, g * 
-00007860: 282d 7072 696d 732e 7369 6e28 6129 2929  (-prims.sin(a)))
-00007870: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00007880: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00007890: 2870 6964 732e 434f 532c 205f 636f 735f  (pids.COS, _cos_
-000078a0: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-000078b0: 7263 6863 7478 0a64 6566 205f 6572 665f  rchctx.def _erf_
-000078c0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-000078d0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-000078e0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-000078f0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00007900: 6677 6420 3d20 7072 696d 732e 6572 6628  fwd = prims.erf(
-00007910: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
-00007920: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00007930: 6772 6164 203d 2032 202f 206d 6174 682e  grad = 2 / math.
-00007940: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
-00007950: 6c74 6f72 6368 2e65 7870 282d 2861 2a2a  ltorch.exp(-(a**
-00007960: 3229 2920 2a20 670a 2020 2020 7075 745f  2)) * g.    put_
-00007970: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
-00007980: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00007990: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-000079a0: 7069 6473 2e45 5246 2c20 5f65 7266 5f70  pids.ERF, _erf_p
-000079b0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-000079c0: 6368 6374 780a 6465 6620 5f65 7870 5f70  chctx.def _exp_p
-000079d0: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-000079e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-000079f0: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007a00: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007a10: 7764 203d 2070 7269 6d73 2e65 7870 2861  wd = prims.exp(a
-00007a20: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00007a30: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
-00007a40: 7261 6420 3d20 6720 2a20 6677 640a 2020  rad = g * fwd.  
-00007a50: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
-00007a60: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
-00007a70: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-00007a80: 5f67 7261 6428 7069 6473 2e45 5850 2c20  _grad(pids.EXP, 
-00007a90: 5f65 7870 5f70 7269 6d5f 6772 6164 290a  _exp_prim_grad).
-00007aa0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-00007ab0: 5f6c 6f67 5f70 7269 6d5f 6772 6164 2861  _log_prim_grad(a
-00007ac0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-00007ad0: 7250 726f 7879 2920 2d3e 204e 756d 6265  rProxy) -> Numbe
-00007ae0: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
-00007af0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-00007b00: 2e6c 6f67 2861 290a 0a20 2020 2067 203d  .log(a)..    g =
-00007b10: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
-00007b20: 2020 2061 5f67 7261 6420 3d20 6720 2f20     a_grad = g / 
-00007b30: 610a 2020 2020 7075 745f 6772 6164 2861  a.    put_grad(a
-00007b40: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
-00007b50: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00007b60: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
-00007b70: 4f47 2c20 5f6c 6f67 5f70 7269 6d5f 6772  OG, _log_prim_gr
-00007b80: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
-00007b90: 6465 6620 5f6e 6567 5f70 7269 6d5f 6772  def _neg_prim_gr
-00007ba0: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
-00007bb0: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
-00007bc0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007bd0: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00007be0: 7269 6d73 2e6e 6567 2861 290a 0a20 2020  rims.neg(a)..   
-00007bf0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00007c00: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
-00007c10: 612c 202d 6729 0a0a 2020 2020 7265 7475  a, -g)..    retu
-00007c20: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00007c30: 725f 6772 6164 2870 6964 732e 4e45 472c  r_grad(pids.NEG,
-00007c40: 205f 6e65 675f 7072 696d 5f67 7261 6429   _neg_prim_grad)
-00007c50: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00007c60: 205f 7273 7172 745f 7072 696d 5f67 7261   _rsqrt_prim_gra
-00007c70: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007c80: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00007c90: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007ca0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00007cb0: 2070 7269 6d73 2e72 7371 7274 2861 290a   prims.rsqrt(a).
-00007cc0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00007cd0: 6428 6677 6429 0a20 2020 2023 2041 6e20  d(fwd).    # An 
-00007ce0: 616c 7465 726e 6174 6976 6520 6465 7269  alternative deri
-00007cf0: 7661 7469 6f6e 2075 7365 6420 6279 204a  vation used by J
-00007d00: 4158 2069 7320 2d30 2e35 202a 2067 202a  AX is -0.5 * g *
-00007d10: 2072 7371 7274 2878 2920 2f20 780a 2020   rsqrt(x) / x.  
-00007d20: 2020 2320 7768 6572 6520 7273 7172 7428    # where rsqrt(
-00007d30: 7829 2061 6e64 2078 2061 7265 2073 6176  x) and x are sav
-00007d40: 6564 2066 6f72 2074 6865 2062 6163 6b77  ed for the backw
-00007d50: 6172 6473 2070 6173 732e 0a20 2020 2023  ards pass..    #
-00007d60: 2054 6869 7320 6465 7269 7661 7469 6f6e   This derivation
-00007d70: 2077 6173 2073 656c 6563 7465 6420 6265   was selected be
-00007d80: 6361 7573 6520 6974 2061 766f 6964 7320  cause it avoids 
-00007d90: 7361 7669 6e67 2074 6865 2069 6e70 7574  saving the input
-00007da0: 2074 656e 736f 722e 0a20 2020 2061 5f67   tensor..    a_g
-00007db0: 7261 6420 3d20 2d30 2e35 202a 2067 202a  rad = -0.5 * g *
-00007dc0: 2066 7764 2a2a 332e 300a 2020 2020 7075   fwd**3.0.    pu
-00007dd0: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
-00007de0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00007df0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00007e00: 6428 7069 6473 2e52 5351 5254 2c20 5f72  d(pids.RSQRT, _r
-00007e10: 7371 7274 5f70 7269 6d5f 6772 6164 290a  sqrt_prim_grad).
-00007e20: 0a0a 6465 6620 5f73 696e 5f70 7269 6d5f  ..def _sin_prim_
-00007e30: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
-00007e40: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
-00007e50: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007e60: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00007e70: 2070 7269 6d73 2e73 696e 2861 290a 0a20   prims.sin(a).. 
-00007e80: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00007e90: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
-00007ea0: 6428 612c 2067 202a 2070 7269 6d73 2e63  d(a, g * prims.c
-00007eb0: 6f73 2861 2929 0a0a 2020 2020 7265 7475  os(a))..    retu
-00007ec0: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00007ed0: 725f 6772 6164 2870 6964 732e 5349 4e2c  r_grad(pids.SIN,
-00007ee0: 205f 7369 6e5f 7072 696d 5f67 7261 6429   _sin_prim_grad)
-00007ef0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00007f00: 205f 7461 6e68 5f70 7269 6d5f 6772 6164   _tanh_prim_grad
-00007f10: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
-00007f20: 736f 7250 726f 7879 2c20 2f29 202d 3e20  sorProxy, /) -> 
-00007f30: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00007f40: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00007f50: 7072 696d 732e 7461 6e68 2861 290a 0a20  prims.tanh(a).. 
-00007f60: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00007f70: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
-00007f80: 3d20 6720 2a20 2831 202d 2066 7764 202a  = g * (1 - fwd *
-00007f90: 2066 7764 290a 2020 2020 7075 745f 6772   fwd).    put_gr
-00007fa0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
-00007fb0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00007fc0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00007fd0: 6473 2e54 414e 482c 205f 7461 6e68 5f70  ds.TANH, _tanh_p
-00007fe0: 7269 6d5f 6772 6164 290a 0a23 0a23 2045  rim_grad)..#.# E
-00007ff0: 6c65 6d65 6e74 7769 7365 2062 696e 6172  lementwise binar
-00008000: 7920 6f70 6572 6174 6f72 2067 7261 6473  y operator grads
-00008010: 0a23 0a0a 0a40 746f 7263 6863 7478 0a64  .#...@torchctx.d
-00008020: 6566 205f 6164 645f 7072 696d 5f67 7261  ef _add_prim_gra
-00008030: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00008040: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
-00008050: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00008060: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
-00008070: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
-00008080: 2020 2020 6677 6420 3d20 6120 2b20 620a      fwd = a + b.
-00008090: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-000080a0: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-000080b0: 6420 3d20 670a 2020 2020 625f 6772 6164  d = g.    b_grad
-000080c0: 203d 2067 0a20 2020 2070 7574 5f67 7261   = g.    put_gra
-000080d0: 6473 2828 612c 2062 292c 2028 615f 6772  ds((a, b), (a_gr
-000080e0: 6164 2c20 625f 6772 6164 2929 0a0a 2020  ad, b_grad))..  
-000080f0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00008100: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00008110: 732e 4144 442c 205f 6164 645f 7072 696d  s.ADD, _add_prim
-00008120: 5f67 7261 6429 0a0a 0a23 204e 4f54 4520  _grad)...# NOTE 
-00008130: 5468 6520 666f 6c6c 6f77 696e 6720 6772  The following gr
-00008140: 6164 2064 6566 696e 6974 696f 6e20 7265  ad definition re
-00008150: 6c69 6573 206f 6e20 7468 6520 6661 6374  lies on the fact
-00008160: 2074 6861 7420 6f6e 6c79 2069 6e65 7861   that only inexa
-00008170: 6374 2064 7479 7065 7320 6172 6520 6469  ct dtypes are di
-00008180: 6666 6572 656e 7469 6162 6c65 2c0a 2320  fferentiable,.# 
-00008190: 2020 616e 6420 746f 7263 6827 7320 7472    and torch's tr
-000081a0: 7565 2064 6976 6973 696f 6e20 6f70 6572  ue division oper
-000081b0: 6174 6f72 2061 6e64 2074 6865 2064 6976  ator and the div
-000081c0: 6973 696f 6e20 7072 696d 6974 6976 6520  ision primitive 
-000081d0: 6167 7265 6520 6f6e 2074 686f 7365 2074  agree on those t
-000081e0: 7970 6573 0a40 746f 7263 6863 7478 0a64  ypes.@torchctx.d
-000081f0: 6566 205f 6469 765f 7072 696d 5f67 7261  ef _div_prim_gra
-00008200: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00008210: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
-00008220: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00008230: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
-00008240: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
-00008250: 2020 2020 6677 6420 3d20 6120 2f20 620a      fwd = a / b.
-00008260: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00008270: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-00008280: 6420 3d20 6720 2f20 620a 2020 2020 625f  d = g / b.    b_
-00008290: 6772 6164 203d 202d 6720 2a20 2828 6120  grad = -g * ((a 
-000082a0: 2f20 6229 202f 2062 290a 2020 2020 7075  / b) / b).    pu
-000082b0: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
-000082c0: 2861 5f67 7261 642c 2062 5f67 7261 6429  (a_grad, b_grad)
-000082d0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-000082e0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-000082f0: 6428 7069 6473 2e44 4956 2c20 5f64 6976  d(pids.DIV, _div
-00008300: 5f70 7269 6d5f 6772 6164 290a 0a23 2043  _prim_grad)..# C
-00008310: 6f6d 7061 7269 736f 6e20 6f70 6572 6174  omparison operat
-00008320: 6f72 7320 2d2d 2074 6865 7365 2063 7265  ors -- these cre
-00008330: 6174 6520 6e6f 2067 7261 6420 6173 736f  ate no grad asso
-00008340: 6369 6174 696f 6e73 0a72 6567 6973 7465  ciations.registe
-00008350: 725f 6772 6164 2870 6964 732e 4551 2c20  r_grad(pids.EQ, 
-00008360: 7072 696d 732e 6571 290a 7265 6769 7374  prims.eq).regist
-00008370: 6572 5f67 7261 6428 7069 6473 2e47 452c  er_grad(pids.GE,
-00008380: 2070 7269 6d73 2e67 6529 0a72 6567 6973   prims.ge).regis
-00008390: 7465 725f 6772 6164 2870 6964 732e 4c54  ter_grad(pids.LT
-000083a0: 2c20 7072 696d 732e 6c74 290a 7265 6769  , prims.lt).regi
-000083b0: 7374 6572 5f67 7261 6428 7069 6473 2e4e  ster_grad(pids.N
-000083c0: 452c 2070 7269 6d73 2e6e 6529 0a72 6567  E, prims.ne).reg
-000083d0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-000083e0: 4754 2c20 7072 696d 732e 6774 290a 7265  GT, prims.gt).re
-000083f0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-00008400: 2e4c 452c 2070 7269 6d73 2e6c 6529 0a0a  .LE, prims.le)..
-00008410: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00008420: 6d75 6c5f 7072 696d 5f67 7261 6428 613a  mul_prim_grad(a:
-00008430: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00008440: 5072 6f78 792c 2062 3a20 4e75 6d62 6572  Proxy, b: Number
-00008450: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
-00008460: 2f29 202d 3e20 4e75 6d62 6572 207c 2054  /) -> Number | T
-00008470: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00008480: 6677 6420 3d20 6120 2a20 620a 0a20 2020  fwd = a * b..   
-00008490: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-000084a0: 6429 0a20 2020 2061 5f67 7261 6420 3d20  d).    a_grad = 
-000084b0: 6220 2a20 670a 2020 2020 625f 6772 6164  b * g.    b_grad
-000084c0: 203d 2061 202a 2067 0a20 2020 2070 7574   = a * g.    put
-000084d0: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
-000084e0: 615f 6772 6164 2c20 625f 6772 6164 2929  a_grad, b_grad))
-000084f0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00008500: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00008510: 2870 6964 732e 4d55 4c2c 205f 6d75 6c5f  (pids.MUL, _mul_
-00008520: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-00008530: 7263 6863 7478 0a64 6566 205f 7375 625f  rchctx.def _sub_
-00008540: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-00008550: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00008560: 792c 2062 3a20 4e75 6d62 6572 207c 2054  y, b: Number | T
-00008570: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
-00008580: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00008590: 6f78 793a 0a20 2020 2066 7764 203d 2061  oxy:.    fwd = a
-000085a0: 202d 2062 0a0a 2020 2020 6720 3d20 6765   - b..    g = ge
-000085b0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-000085c0: 615f 6772 6164 203d 2067 0a20 2020 2062  a_grad = g.    b
-000085d0: 5f67 7261 6420 3d20 2d67 0a20 2020 2070  _grad = -g.    p
+00003fc0: 735f 7061 7261 6d65 7465 7273 203d 2063  s_parameters = c
+00003fd0: 666e 2e5f 6f76 6572 7269 6465 735f 7061  fn._overrides_pa
+00003fe0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+00003ff0: 2020 2020 206a 666e 2e5f 6f76 6572 7269       jfn._overri
+00004000: 6465 735f 6275 6666 6572 7320 3d20 6366  des_buffers = cf
+00004010: 6e2e 5f6f 7665 7272 6964 6573 5f62 7566  n._overrides_buf
+00004020: 6665 7273 0a20 2020 2020 2020 2072 6574  fers.        ret
+00004030: 7572 6e20 6a66 6e0a 0a20 2020 2063 7320  urn jfn..    cs 
+00004040: 3d20 6765 7461 7474 7228 6366 6e2c 2022  = getattr(cfn, "
+00004050: 5f6c 635f 6373 222c 204e 6f6e 6529 0a20  _lc_cs", None). 
+00004060: 2020 2069 6620 6373 2069 7320 4e6f 6e65     if cs is None
+00004070: 3a0a 2020 2020 2020 2020 6373 203d 2043  :.        cs = C
+00004080: 6f6d 7069 6c65 5374 6174 7328 290a 0a20  ompileStats().. 
+00004090: 2020 2074 7261 6e73 666f 726d 7320 3d20     transforms = 
+000040a0: 6366 6e2e 5f6c 635f 7472 616e 7366 6f72  cfn._lc_transfor
+000040b0: 6d73 202b 205b 7472 616e 7366 6f72 6d5d  ms + [transform]
+000040c0: 0a20 2020 2070 6f74 7261 6e73 666f 726d  .    potransform
+000040d0: 7320 3d20 6366 6e2e 5f6c 635f 706f 7374  s = cfn._lc_post
+000040e0: 5f6f 7074 696d 697a 6174 696f 6e5f 7472  _optimization_tr
+000040f0: 616e 7366 6f72 6d73 0a20 2020 2075 7369  ansforms.    usi
+00004100: 6e67 5f67 7261 645f 7472 616e 7366 6f72  ng_grad_transfor
+00004110: 6d20 3d20 6366 6e2e 5f75 7369 6e67 5f67  m = cfn._using_g
+00004120: 7261 645f 7472 616e 7366 6f72 6d0a 0a20  rad_transform.. 
+00004130: 2020 206e 6366 6e20 3d20 5f63 7265 6174     ncfn = _creat
+00004140: 655f 6361 6c6c 6162 6c65 280a 2020 2020  e_callable(.    
+00004150: 2020 2020 6364 2c0a 2020 2020 2020 2020      cd,.        
+00004160: 6373 2c0a 2020 2020 2020 2020 7472 616e  cs,.        tran
+00004170: 7366 6f72 6d73 3d74 7261 6e73 666f 726d  sforms=transform
+00004180: 732c 0a20 2020 2020 2020 2070 6f73 745f  s,.        post_
+00004190: 6f70 7469 6d69 7a61 7469 6f6e 5f74 7261  optimization_tra
+000041a0: 6e73 666f 726d 733d 706f 7472 616e 7366  nsforms=potransf
+000041b0: 6f72 6d73 2c0a 2020 2020 2020 2020 5f75  orms,.        _u
+000041c0: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
+000041d0: 6f72 6d3d 7573 696e 675f 6772 6164 5f74  orm=using_grad_t
+000041e0: 7261 6e73 666f 726d 2c0a 2020 2020 290a  ransform,.    ).
+000041f0: 2020 2020 7265 7475 726e 206e 6366 6e0a      return ncfn.
+00004200: 0a0a 2320 544f 444f 2043 6f6e 7369 6465  ..# TODO Conside
+00004210: 7220 7265 6661 6374 6f72 696e 6720 7468  r refactoring th
+00004220: 6973 2077 6974 6820 7468 6520 6162 6f76  is with the abov
+00004230: 650a 2320 4865 6c70 6572 2066 756e 6374  e.# Helper funct
+00004240: 696f 6e20 746f 2061 6464 2061 2070 6f73  ion to add a pos
+00004250: 742d 6f70 7469 6d69 7a61 7469 6f6e 2074  t-optimization t
+00004260: 7261 6e73 666f 726d 0a64 6566 2061 6464  ransform.def add
+00004270: 5f70 6f73 745f 6f70 7469 6d69 7a61 7469  _post_optimizati
+00004280: 6f6e 5f74 7261 6e73 666f 726d 2863 666e  on_transform(cfn
+00004290: 3a20 4361 6c6c 6162 6c65 2c20 7472 616e  : Callable, tran
+000042a0: 7366 6f72 6d3a 2043 616c 6c61 626c 6529  sform: Callable)
+000042b0: 202d 3e20 4361 6c6c 6162 6c65 3a0a 2020   -> Callable:.  
+000042c0: 2020 6672 6f6d 2074 6875 6e64 6572 2e63    from thunder.c
+000042d0: 6f6d 6d6f 6e20 696d 706f 7274 205f 6372  ommon import _cr
+000042e0: 6561 7465 5f63 616c 6c61 626c 652c 2043  eate_callable, C
+000042f0: 6f6d 7069 6c65 4461 7461 2c20 436f 6d70  ompileData, Comp
+00004300: 696c 6553 7461 7473 0a0a 2020 2020 6364  ileStats..    cd
+00004310: 3a20 4e6f 6e65 207c 2041 6e79 203d 2067  : None | Any = g
+00004320: 6574 6174 7472 2863 666e 2c20 225f 6c63  etattr(cfn, "_lc
+00004330: 5f63 6422 2c20 4e6f 6e65 290a 0a20 2020  _cd", None)..   
+00004340: 2075 7469 6c73 2e63 6865 636b 2863 6420   utils.check(cd 
+00004350: 6973 206e 6f74 204e 6f6e 652c 206c 616d  is not None, lam
+00004360: 6264 613a 2066 2243 616e 206f 6e6c 7920  bda: f"Can only 
+00004370: 7472 616e 7366 6f72 6d20 636f 6d70 696c  transform compil
+00004380: 6564 2074 6875 6e64 6572 2066 756e 6374  ed thunder funct
+00004390: 696f 6e73 2229 0a20 2020 2075 7469 6c73  ions").    utils
+000043a0: 2e63 6865 636b 2869 7369 6e73 7461 6e63  .check(isinstanc
+000043b0: 6528 6364 2c20 436f 6d70 696c 6544 6174  e(cd, CompileDat
+000043c0: 6129 2c20 6c61 6d62 6461 3a20 6622 466f  a), lambda: f"Fo
+000043d0: 756e 6420 616e 2075 6e6b 6e6f 776e 2063  und an unknown c
+000043e0: 6f6d 7069 6c65 2064 6174 6120 6174 7472  ompile data attr
+000043f0: 6962 7574 6520 7b63 647d 2229 0a0a 2020  ibute {cd}")..  
+00004400: 2020 6373 203d 2043 6f6d 7069 6c65 5374    cs = CompileSt
+00004410: 6174 7328 290a 2020 2020 7472 616e 7366  ats().    transf
+00004420: 6f72 6d73 203d 2063 666e 2e5f 6c63 5f74  orms = cfn._lc_t
+00004430: 7261 6e73 666f 726d 730a 2020 2020 706f  ransforms.    po
+00004440: 7472 616e 7366 6f72 6d73 203d 2063 666e  transforms = cfn
+00004450: 2e5f 6c63 5f70 6f73 745f 6f70 7469 6d69  ._lc_post_optimi
+00004460: 7a61 7469 6f6e 5f74 7261 6e73 666f 726d  zation_transform
+00004470: 7320 2b20 5b74 7261 6e73 666f 726d 5d0a  s + [transform].
+00004480: 0a20 2020 206e 6366 6e20 3d20 5f63 7265  .    ncfn = _cre
+00004490: 6174 655f 6361 6c6c 6162 6c65 2863 642c  ate_callable(cd,
+000044a0: 2063 732c 2074 7261 6e73 666f 726d 733d   cs, transforms=
+000044b0: 7472 616e 7366 6f72 6d73 2c20 706f 7374  transforms, post
+000044c0: 5f6f 7074 696d 697a 6174 696f 6e5f 7472  _optimization_tr
+000044d0: 616e 7366 6f72 6d73 3d70 6f74 7261 6e73  ansforms=potrans
+000044e0: 666f 726d 7329 0a20 2020 2072 6574 7572  forms).    retur
+000044f0: 6e20 6e63 666e 0a0a 0a23 2054 6865 206e  n ncfn...# The n
+00004500: 6f2d 6f70 2074 7261 6e73 666f 726d 2e20  o-op transform. 
+00004510: 4120 7472 6976 6961 6c20 636f 6d70 6f73  A trivial compos
+00004520: 6162 6c65 2074 7261 6e73 666f 726d 2c20  able transform, 
+00004530: 6f6e 6c79 2075 7365 6675 6c20 6173 2061  only useful as a
+00004540: 6e20 6578 616d 706c 652e 0a64 6566 205f  n example..def _
+00004550: 6e6f 6f70 5f74 7261 6e73 666f 726d 2874  noop_transform(t
+00004560: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
+00004570: 7761 7267 7329 202d 3e20 5472 6163 653a  wargs) -> Trace:
+00004580: 0a20 2020 2073 7461 7274 5f74 696d 655f  .    start_time_
+00004590: 6e73 203d 2074 696d 652e 7469 6d65 5f6e  ns = time.time_n
+000045a0: 7328 290a 2020 2020 6e6f 6f70 5f74 7261  s().    noop_tra
+000045b0: 6365 203d 2066 726f 6d5f 7472 6163 6528  ce = from_trace(
+000045c0: 7472 6163 6529 0a0a 2020 2020 7472 6163  trace)..    trac
+000045d0: 6563 7478 5f74 6f6b 3a20 416e 790a 2020  ectx_tok: Any.  
+000045e0: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
+000045f0: 7261 6365 6374 785f 746f 6b20 3d20 7365  racectx_tok = se
+00004600: 745f 7472 6163 6563 7478 286e 6f6f 705f  t_tracectx(noop_
+00004610: 7472 6163 6529 0a20 2020 2020 2020 2070  trace).        p
+00004620: 7269 6d73 2e63 6f6d 6d65 6e74 2822 5468  rims.comment("Th
+00004630: 6973 2063 6f6d 6d65 6e74 2061 6464 6564  is comment added
+00004640: 2062 7920 7468 6520 6e6f 2d6f 7020 7472   by the no-op tr
+00004650: 616e 7366 6f72 6d22 290a 2020 2020 6669  ansform").    fi
+00004660: 6e61 6c6c 793a 0a20 2020 2020 2020 2072  nally:.        r
+00004670: 6573 6574 5f74 7261 6365 6374 7828 7472  eset_tracectx(tr
+00004680: 6163 6563 7478 5f74 6f6b 290a 0a20 2020  acectx_tok)..   
+00004690: 206e 6f6f 705f 7472 6163 652e 626f 756e   noop_trace.boun
+000046a0: 645f 7379 6d62 6f6c 732e 6578 7465 6e64  d_symbols.extend
+000046b0: 2874 7261 6365 2e62 6f75 6e64 5f73 796d  (trace.bound_sym
+000046c0: 626f 6c73 290a 0a20 2020 2065 6e64 5f74  bols)..    end_t
+000046d0: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
+000046e0: 6d65 5f6e 7328 290a 2020 2020 656c 6170  me_ns().    elap
+000046f0: 7365 645f 7469 6d65 5f6e 7320 3d20 656e  sed_time_ns = en
+00004700: 645f 7469 6d65 5f6e 7320 2d20 7374 6172  d_time_ns - star
+00004710: 745f 7469 6d65 5f6e 730a 2020 2020 656c  t_time_ns.    el
+00004720: 6170 7365 645f 7469 6d65 5f6d 696c 6c69  apsed_time_milli
+00004730: 7320 3d20 656c 6170 7365 645f 7469 6d65  s = elapsed_time
+00004740: 5f6e 7320 2f2f 2031 3030 3030 3030 0a20  _ns // 1000000. 
+00004750: 2020 206e 6f6f 705f 7472 6163 652e 7365     noop_trace.se
+00004760: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
+00004770: 6365 5072 6f76 656e 616e 6365 2866 224e  ceProvenance(f"N
+00004780: 6f2d 6f70 2054 7261 6e73 666f 726d 2028  o-op Transform (
+00004790: 746f 6f6b 207b 656c 6170 7365 645f 7469  took {elapsed_ti
+000047a0: 6d65 5f6d 696c 6c69 737d 206d 696c 6c69  me_millis} milli
+000047b0: 7365 636f 6e64 7329 2229 290a 0a20 2020  seconds)"))..   
+000047c0: 2072 6574 7572 6e20 6e6f 6f70 5f74 7261   return noop_tra
+000047d0: 6365 0a0a 0a64 6566 206e 6f6f 7028 6366  ce...def noop(cf
+000047e0: 6e3a 2043 616c 6c61 626c 6529 202d 3e20  n: Callable) -> 
+000047f0: 4361 6c6c 6162 6c65 3a0a 2020 2020 7265  Callable:.    re
+00004800: 7475 726e 2061 6464 5f74 7261 6e73 666f  turn add_transfo
+00004810: 726d 2863 666e 2c20 7472 616e 7366 6f72  rm(cfn, transfor
+00004820: 6d3d 5f6e 6f6f 705f 7472 616e 7366 6f72  m=_noop_transfor
+00004830: 6d29 0a0a 0a23 2054 6865 2063 6f6d 6d65  m)...# The comme
+00004840: 6e74 2066 7573 696f 6e73 2074 7261 6e73  nt fusions trans
+00004850: 666f 726d 2e20 4a75 7374 2061 6464 7320  form. Just adds 
+00004860: 6120 636f 6d6d 656e 7420 6265 666f 7265  a comment before
+00004870: 2061 6e64 2061 6674 6572 2065 6163 6820   and after each 
+00004880: 6675 7369 6f6e 2e0a 2320 2020 5468 6973  fusion..#   This
+00004890: 2069 7320 616e 2065 7861 6d70 6c65 206f   is an example o
+000048a0: 6620 6120 706f 7374 2d6f 7074 696d 697a  f a post-optimiz
+000048b0: 6174 696f 6e20 7472 616e 7366 6f72 6d2e  ation transform.
+000048c0: 0a64 6566 205f 636f 6d6d 656e 745f 6675  .def _comment_fu
+000048d0: 7369 6f6e 735f 7472 616e 7366 6f72 6d28  sions_transform(
+000048e0: 7472 6163 653a 2054 7261 6365 2c20 2a2a  trace: Trace, **
+000048f0: 6b77 6172 6773 2920 2d3e 2054 7261 6365  kwargs) -> Trace
+00004900: 3a0a 2020 2020 7374 6172 745f 7469 6d65  :.    start_time
+00004910: 5f6e 7320 3d20 7469 6d65 2e74 696d 655f  _ns = time.time_
+00004920: 6e73 2829 0a20 2020 2063 6f6d 6d65 6e74  ns().    comment
+00004930: 6564 5f74 7261 6365 203d 2066 726f 6d5f  ed_trace = from_
+00004940: 7472 6163 6528 7472 6163 6529 0a0a 2020  trace(trace)..  
+00004950: 2020 6e62 7379 6d73 3a20 6c69 7374 5b42    nbsyms: list[B
+00004960: 6f75 6e64 5379 6d62 6f6c 5d20 3d20 5b5d  oundSymbol] = []
+00004970: 0a20 2020 2066 6f72 2062 7379 6d20 696e  .    for bsym in
+00004980: 2074 7261 6365 2e62 6f75 6e64 5f73 796d   trace.bound_sym
+00004990: 626f 6c73 3a0a 2020 2020 2020 2020 6966  bols:.        if
+000049a0: 2062 7379 6d2e 7379 6d2e 6973 5f66 7573   bsym.sym.is_fus
+000049b0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+000049c0: 2066 7573 696f 6e5f 6e61 6d65 203d 2062   fusion_name = b
+000049d0: 7379 6d2e 7379 6d2e 6e61 6d65 0a20 2020  sym.sym.name.   
+000049e0: 2020 2020 2020 2020 2070 7265 5f63 6f6d           pre_com
+000049f0: 6d65 6e74 5f62 7379 6d20 3d20 7072 696d  ment_bsym = prim
+00004a00: 732e 636f 6d6d 656e 742e 6269 6e64 2866  s.comment.bind(f
+00004a10: 2242 6566 6f72 6520 7b66 7573 696f 6e5f  "Before {fusion_
+00004a20: 6e61 6d65 7d22 2c20 6f75 7470 7574 3d4e  name}", output=N
+00004a30: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+00004a40: 2070 6f73 745f 636f 6d6d 656e 745f 6273   post_comment_bs
+00004a50: 796d 203d 2070 7269 6d73 2e63 6f6d 6d65  ym = prims.comme
+00004a60: 6e74 2e62 696e 6428 6622 4166 7465 7220  nt.bind(f"After 
+00004a70: 7b66 7573 696f 6e5f 6e61 6d65 7d22 2c20  {fusion_name}", 
+00004a80: 6f75 7470 7574 3d4e 6f6e 6529 0a0a 2020  output=None)..  
+00004a90: 2020 2020 2020 2020 2020 6e62 7379 6d73            nbsyms
+00004aa0: 2e65 7874 656e 6428 5b70 7265 5f63 6f6d  .extend([pre_com
+00004ab0: 6d65 6e74 5f62 7379 6d2c 2062 7379 6d2c  ment_bsym, bsym,
+00004ac0: 2070 6f73 745f 636f 6d6d 656e 745f 6273   post_comment_bs
+00004ad0: 796d 5d29 0a20 2020 2020 2020 2065 6c73  ym]).        els
+00004ae0: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00004af0: 6273 796d 732e 6170 7065 6e64 2862 7379  bsyms.append(bsy
+00004b00: 6d29 0a0a 2020 2020 636f 6d6d 656e 7465  m)..    commente
+00004b10: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
+00004b20: 6d62 6f6c 7320 3d20 6e62 7379 6d73 0a20  mbols = nbsyms. 
+00004b30: 2020 2065 6e64 5f74 696d 655f 6e73 203d     end_time_ns =
+00004b40: 2074 696d 652e 7469 6d65 5f6e 7328 290a   time.time_ns().
+00004b50: 2020 2020 656c 6170 7365 645f 7469 6d65      elapsed_time
+00004b60: 5f6e 7320 3d20 656e 645f 7469 6d65 5f6e  _ns = end_time_n
+00004b70: 7320 2d20 7374 6172 745f 7469 6d65 5f6e  s - start_time_n
+00004b80: 730a 2020 2020 656c 6170 7365 645f 7469  s.    elapsed_ti
+00004b90: 6d65 5f6d 696c 6c69 7320 3d20 656c 6170  me_millis = elap
+00004ba0: 7365 645f 7469 6d65 5f6e 7320 2f2f 2031  sed_time_ns // 1
+00004bb0: 3030 3030 3030 0a0a 2020 2020 636f 6d6d  000000..    comm
+00004bc0: 656e 7465 645f 7472 6163 652e 7365 745f  ented_trace.set_
+00004bd0: 7072 6f76 656e 616e 6365 2854 7261 6365  provenance(Trace
+00004be0: 5072 6f76 656e 616e 6365 2866 2243 6f6d  Provenance(f"Com
+00004bf0: 6d65 6e74 2046 7573 696f 6e73 2028 746f  ment Fusions (to
+00004c00: 6f6b 207b 656c 6170 7365 645f 7469 6d65  ok {elapsed_time
+00004c10: 5f6d 696c 6c69 737d 206d 696c 6c69 7365  _millis} millise
+00004c20: 636f 6e64 7329 2229 290a 0a20 2020 2072  conds)"))..    r
+00004c30: 6574 7572 6e20 636f 6d6d 656e 7465 645f  eturn commented_
+00004c40: 7472 6163 650a 0a0a 6465 6620 636f 6d6d  trace...def comm
+00004c50: 656e 745f 6675 7369 6f6e 7328 6366 6e3a  ent_fusions(cfn:
+00004c60: 2043 616c 6c61 626c 6529 202d 3e20 4361   Callable) -> Ca
+00004c70: 6c6c 6162 6c65 3a0a 2020 2020 7265 7475  llable:.    retu
+00004c80: 726e 2061 6464 5f70 6f73 745f 6f70 7469  rn add_post_opti
+00004c90: 6d69 7a61 7469 6f6e 5f74 7261 6e73 666f  mization_transfo
+00004ca0: 726d 2863 666e 2c20 5f63 6f6d 6d65 6e74  rm(cfn, _comment
+00004cb0: 5f66 7573 696f 6e73 5f74 7261 6e73 666f  _fusions_transfo
+00004cc0: 726d 290a 0a0a 230a 2320 4865 6c70 6572  rm)...#.# Helper
+00004cd0: 2066 756e 6374 696f 6e73 2066 6f72 2063   functions for c
+00004ce0: 6f6d 706f 7361 626c 6520 7472 616e 7366  omposable transf
+00004cf0: 6f72 6d73 0a23 0a0a 0a23 2046 6c61 7474  orms.#...# Flatt
+00004d00: 656e 7320 6120 6c69 7374 206f 6620 626f  ens a list of bo
+00004d10: 756e 6420 7379 6d62 6f6c 732c 2072 6574  und symbols, ret
+00004d20: 7572 6e69 6e67 2074 6865 2066 6c61 7474  urning the flatt
+00004d30: 656e 6564 206c 6973 740a 6465 6620 666c  ened list.def fl
+00004d40: 6174 7465 6e5f 666f 725f 7472 616e 7366  atten_for_transf
+00004d50: 6f72 6d28 7368 6f75 6c64 5f66 6c61 7474  orm(should_flatt
+00004d60: 656e 3a20 4361 6c6c 6162 6c65 2c20 6273  en: Callable, bs
+00004d70: 796d 733a 206c 6973 745b 426f 756e 6453  yms: list[BoundS
+00004d80: 796d 626f 6c5d 2920 2d3e 206c 6973 745b  ymbol]) -> list[
+00004d90: 426f 756e 6453 796d 626f 6c5d 3a0a 2020  BoundSymbol]:.  
+00004da0: 2020 666c 6174 7465 6e65 643a 206c 6973    flattened: lis
+00004db0: 745b 426f 756e 6453 796d 626f 6c5d 203d  t[BoundSymbol] =
+00004dc0: 205b 5d0a 0a20 2020 2064 6566 205f 666c   []..    def _fl
+00004dd0: 6174 7465 6e28 6273 796d 3a20 426f 756e  atten(bsym: Boun
+00004de0: 6453 796d 626f 6c29 3a0a 2020 2020 2020  dSymbol):.      
+00004df0: 2020 6966 2073 686f 756c 645f 666c 6174    if should_flat
+00004e00: 7465 6e28 6273 796d 293a 0a20 2020 2020  ten(bsym):.     
+00004e10: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
+00004e20: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+00004e30: 6e28 6273 796d 2e73 7562 7379 6d62 6f6c  n(bsym.subsymbol
+00004e40: 7329 203e 2030 2c0a 2020 2020 2020 2020  s) > 0,.        
+00004e50: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+00004e60: 6622 4e6f 2067 7261 6420 7275 6c65 2066  f"No grad rule f
+00004e70: 6f75 6e64 2066 6f72 207b 6273 796d 7d20  ound for {bsym} 
+00004e80: 616e 6420 6e6f 2073 7562 7379 6d62 6f6c  and no subsymbol
+00004e90: 7320 696e 7369 6465 2069 7420 746f 2063  s inside it to c
+00004ea0: 7265 6174 6520 6120 6772 6164 2066 6f72  reate a grad for
+00004eb0: 6d75 6c61 222c 0a20 2020 2020 2020 2020  mula",.         
+00004ec0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00004ed0: 2066 6f72 2073 6273 796d 2069 6e20 6273   for sbsym in bs
+00004ee0: 796d 2e73 7562 7379 6d62 6f6c 733a 0a20  ym.subsymbols:. 
+00004ef0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00004f00: 666c 6174 7465 6e28 7362 7379 6d29 0a20  flatten(sbsym). 
+00004f10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00004f20: 2020 2020 2020 2020 2066 6c61 7474 656e           flatten
+00004f30: 6564 2e61 7070 656e 6428 6273 796d 290a  ed.append(bsym).
+00004f40: 0a20 2020 2066 6f72 2062 7379 6d20 696e  .    for bsym in
+00004f50: 2062 7379 6d73 3a0a 2020 2020 2020 2020   bsyms:.        
+00004f60: 5f66 6c61 7474 656e 2862 7379 6d29 0a0a  _flatten(bsym)..
+00004f70: 2020 2020 7265 7475 726e 2066 6c61 7474      return flatt
+00004f80: 656e 6564 0a0a 0a23 0a23 2050 6861 6e74  ened...#.# Phant
+00004f90: 6f6d 2067 7261 6420 7472 616e 7366 6f72  om grad transfor
+00004fa0: 6d0a 230a 0a23 0a23 2046 756e 6374 696f  m.#..#.# Functio
+00004fb0: 6e73 2072 656c 6174 6564 2074 6f20 6675  ns related to fu
+00004fc0: 6e63 7469 6f6e 616c 697a 696e 6720 5468  nctionalizing Th
+00004fd0: 756e 6465 724f 7074 696d 697a 6564 4d6f  underOptimizedMo
+00004fe0: 6475 6c65 730a 230a 0a0a 2320 544f 444f  dules.#...# TODO
+00004ff0: 2054 6573 7420 7769 7468 2062 7566 6665   Test with buffe
+00005000: 7273 0a64 6566 2070 6f70 756c 6174 655f  rs.def populate_
+00005010: 6772 6164 7328 6772 6164 733a 206c 6973  grads(grads: lis
+00005020: 745b 5465 6e73 6f72 5072 6f78 795d 2c20  t[TensorProxy], 
+00005030: 746f 6d3a 204e 6f6e 6520 7c20 746f 7263  tom: None | torc
+00005040: 682e 6e6e 2e4d 6f64 756c 6520 3d20 4e6f  h.nn.Module = No
+00005050: 6e65 2c20 6172 6773 3d4e 6f6e 652c 206b  ne, args=None, k
+00005060: 7761 7267 733d 4e6f 6e65 2920 2d3e 204e  wargs=None) -> N
+00005070: 6f6e 653a 0a20 2020 2069 6478 3a20 696e  one:.    idx: in
+00005080: 7420 3d20 300a 2020 2020 6672 6f6d 2074  t = 0.    from t
+00005090: 6875 6e64 6572 2069 6d70 6f72 7420 5468  hunder import Th
+000050a0: 756e 6465 724d 6f64 756c 652c 2063 6f6d  underModule, com
+000050b0: 7069 6c65 5f64 6174 610a 0a20 2020 2069  pile_data..    i
+000050c0: 6620 6973 696e 7374 616e 6365 2874 6f6d  f isinstance(tom
+000050d0: 2c20 5468 756e 6465 724d 6f64 756c 6529  , ThunderModule)
+000050e0: 206f 7220 636f 6d70 696c 655f 6461 7461   or compile_data
+000050f0: 2874 6f6d 292e 7573 696e 675f 6a69 743a  (tom).using_jit:
+00005100: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00005110: 6172 6773 2069 7320 6e6f 7420 4e6f 6e65  args is not None
+00005120: 2c20 2270 6f70 756c 6174 6520 6772 6164  , "populate grad
+00005130: 206e 6565 6473 2061 7267 7320 2861 6e64   needs args (and
+00005140: 2070 6f73 7369 626c 7920 6b77 6172 6773   possibly kwargs
+00005150: 2920 746f 2077 6f72 6b20 7769 7468 2054  ) to work with T
+00005160: 6875 6e64 6572 4d6f 6475 6c65 7322 0a20  hunderModules". 
+00005170: 2020 2020 2020 2069 6620 6b77 6172 6773         if kwargs
+00005180: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00005190: 2020 2020 2020 6b77 6172 6773 203d 207b        kwargs = {
+000051a0: 7d0a 2020 2020 2020 2020 5f2c 2063 6f6d  }.        _, com
+000051b0: 7075 7461 7469 6f6e 5f69 6e70 7574 732c  putation_inputs,
+000051c0: 205f 203d 2063 6f6d 7069 6c65 5f64 6174   _ = compile_dat
+000051d0: 6128 746f 6d29 2e67 6574 5f63 6f6d 7075  a(tom).get_compu
+000051e0: 7461 7469 6f6e 5f61 6e64 5f69 6e70 7574  tation_and_input
+000051f0: 7328 2a61 7267 732c 202a 2a6b 7761 7267  s(*args, **kwarg
+00005200: 7329 0a20 2020 2020 2020 2066 6f72 2070  s).        for p
+00005210: 2069 6e20 636f 6d70 7574 6174 696f 6e5f   in computation_
+00005220: 696e 7075 7473 3a0a 2020 2020 2020 2020  inputs:.        
+00005230: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00005240: 6528 702c 2074 6f72 6368 2e54 656e 736f  e(p, torch.Tenso
+00005250: 7229 2061 6e64 2070 2e72 6571 7569 7265  r) and p.require
+00005260: 735f 6772 6164 3a0a 2020 2020 2020 2020  s_grad:.        
+00005270: 2020 2020 2020 2020 2320 5375 7070 6f72          # Suppor
+00005280: 7473 2067 7261 6420 6163 6375 6d75 6c61  ts grad accumula
+00005290: 7469 6f6e 2028 6c69 6b65 2077 6865 6e20  tion (like when 
+000052a0: 7765 6967 6874 2074 7969 6e67 290a 2020  weight tying).  
+000052b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000052c0: 2070 2e67 7261 6420 6973 206e 6f74 204e   p.grad is not N
+000052d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000052e0: 2020 2020 2020 2020 2070 2e67 7261 6420           p.grad 
+000052f0: 2b3d 2067 7261 6473 5b69 6478 5d0a 2020  += grads[idx].  
+00005300: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00005310: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00005320: 2020 2020 2020 2020 702e 6772 6164 203d          p.grad =
+00005330: 2067 7261 6473 5b69 6478 5d0a 2020 2020   grads[idx].    
+00005340: 2020 2020 2020 2020 2020 2020 6964 7820              idx 
+00005350: 2b3d 2031 0a20 2020 2020 2020 2072 6574  += 1.        ret
+00005360: 7572 6e0a 0a20 2020 2023 2053 686f 7274  urn..    # Short
+00005370: 2d63 6972 6375 6974 7320 6966 2074 6865  -circuits if the
+00005380: 7265 2061 7265 206e 6f20 6172 6773 206f  re are no args o
+00005390: 7220 6b77 6172 6773 0a20 2020 2069 6620  r kwargs.    if 
+000053a0: 6172 6773 2069 7320 4e6f 6e65 2061 6e64  args is None and
+000053b0: 206b 7761 7267 7320 6973 204e 6f6e 653a   kwargs is None:
+000053c0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+000053d0: 0a20 2020 2066 6c61 7473 2c20 5f20 3d20  .    flats, _ = 
+000053e0: 7472 6565 5f66 6c61 7474 656e 2828 6172  tree_flatten((ar
+000053f0: 6773 2c20 6b77 6172 6773 2929 0a20 2020  gs, kwargs)).   
+00005400: 2066 6f72 2066 2069 6e20 666c 6174 733a   for f in flats:
+00005410: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00005420: 7374 616e 6365 2866 2c20 746f 7263 682e  stance(f, torch.
+00005430: 5465 6e73 6f72 2920 616e 6420 662e 7265  Tensor) and f.re
+00005440: 7175 6972 6573 5f67 7261 643a 0a20 2020  quires_grad:.   
+00005450: 2020 2020 2020 2020 2066 2e67 7261 6420           f.grad 
+00005460: 3d20 6772 6164 735b 6964 785d 0a20 2020  = grads[idx].   
+00005470: 2020 2020 2020 2020 2069 6478 202b 3d20           idx += 
+00005480: 310a 0a0a 6465 6620 6578 7472 6163 745f  1...def extract_
+00005490: 6772 6164 7328 6d6f 6475 6c65 3a20 746f  grads(module: to
+000054a0: 7263 682e 6e6e 2e4d 6f64 756c 6529 202d  rch.nn.Module) -
+000054b0: 3e20 7475 706c 655b 746f 7263 682e 5465  > tuple[torch.Te
+000054c0: 6e73 6f72 2c20 2e2e 2e5d 3a0a 2020 2020  nsor, ...]:.    
+000054d0: 6772 6164 7320 3d20 7475 706c 6528 0a20  grads = tuple(. 
+000054e0: 2020 2020 2020 2066 2e67 7261 640a 2020         f.grad.  
+000054f0: 2020 2020 2020 666f 7220 6620 696e 2063        for f in c
+00005500: 6861 696e 286d 6f64 756c 652e 7061 7261  hain(module.para
+00005510: 6d65 7465 7273 2829 2c20 6d6f 6475 6c65  meters(), module
+00005520: 2e62 7566 6665 7273 2829 290a 2020 2020  .buffers()).    
+00005530: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00005540: 6528 662c 2074 6f72 6368 2e54 656e 736f  e(f, torch.Tenso
+00005550: 7229 2061 6e64 2066 2e72 6571 7569 7265  r) and f.require
+00005560: 735f 6772 6164 2061 6e64 2066 2e67 7261  s_grad and f.gra
+00005570: 6420 6973 206e 6f74 204e 6f6e 650a 2020  d is not None.  
+00005580: 2020 290a 2020 2020 7265 7475 726e 2067    ).    return g
+00005590: 7261 6473 0a0a 0a64 6566 2063 6c65 6172  rads...def clear
+000055a0: 5f67 7261 6473 286d 6f64 756c 653a 2074  _grads(module: t
+000055b0: 6f72 6368 2e6e 6e2e 4d6f 6475 6c65 2920  orch.nn.Module) 
+000055c0: 2d3e 204e 6f6e 653a 0a20 2020 2069 6620  -> None:.    if 
+000055d0: 6e6f 7420 6973 696e 7374 616e 6365 286d  not isinstance(m
+000055e0: 6f64 756c 652c 2074 6f72 6368 2e6e 6e2e  odule, torch.nn.
+000055f0: 4d6f 6475 6c65 293a 0a20 2020 2020 2020  Module):.       
+00005600: 2072 6574 7572 6e0a 0a20 2020 2066 6f72   return..    for
+00005610: 2070 2069 6e20 6d6f 6475 6c65 2e70 6172   p in module.par
+00005620: 616d 6574 6572 7328 293a 0a20 2020 2020  ameters():.     
+00005630: 2020 2070 2e67 7261 6420 3d20 4e6f 6e65     p.grad = None
+00005640: 0a20 2020 2066 6f72 2062 2069 6e20 6d6f  .    for b in mo
+00005650: 6475 6c65 2e62 7566 6665 7273 2829 3a0a  dule.buffers():.
+00005660: 2020 2020 2020 2020 622e 6772 6164 203d          b.grad =
+00005670: 204e 6f6e 650a 0a0a 6672 6f6d 2074 6875   None...from thu
+00005680: 6e64 6572 2e63 6f72 652e 696e 7465 7270  nder.core.interp
+00005690: 7265 7465 7220 696d 706f 7274 206d 616b  reter import mak
+000056a0: 655f 6f70 6171 7565 0a66 726f 6d20 7468  e_opaque.from th
+000056b0: 756e 6465 722e 636f 7265 2e6c 616e 6763  under.core.langc
+000056c0: 7478 7320 696d 706f 7274 206c 616e 6763  txs import langc
+000056d0: 7478 2c20 4c61 6e67 7561 6765 730a 0a0a  tx, Languages...
+000056e0: 2320 544f 444f 2052 4331 2052 6570 6c61  # TODO RC1 Repla
+000056f0: 6365 2077 6974 6820 6c61 6e67 6374 780a  ce with langctx.
+00005700: 6465 6620 746f 7263 6863 7478 2866 6e29  def torchctx(fn)
+00005710: 3a0a 2020 2020 5f66 6e20 3d20 6c61 6e67  :.    _fn = lang
+00005720: 6374 7828 4c61 6e67 7561 6765 732e 544f  ctx(Languages.TO
+00005730: 5243 4829 2866 6e29 0a20 2020 2072 6574  RCH)(fn).    ret
+00005740: 7572 6e20 6d61 6b65 5f6f 7061 7175 6528  urn make_opaque(
+00005750: 5f66 6e29 0a0a 0a5f 6772 6164 5f66 6e5f  _fn)..._grad_fn_
+00005760: 6d61 703a 2064 6963 745b 416e 792c 2043  map: dict[Any, C
+00005770: 616c 6c61 626c 655d 203d 207b 7d0a 0a0a  allable] = {}...
+00005780: 6465 6620 7265 6769 7374 6572 5f67 7261  def register_gra
+00005790: 6428 7379 6d5f 6f72 5f69 643a 2053 796d  d(sym_or_id: Sym
+000057a0: 626f 6c20 7c20 416e 792c 2067 7261 6466  bol | Any, gradf
+000057b0: 6e3a 2043 616c 6c61 626c 6529 202d 3e20  n: Callable) -> 
+000057c0: 4e6f 6e65 3a0a 2020 2020 6964 3a20 416e  None:.    id: An
+000057d0: 7920 3d20 7379 6d5f 6f72 5f69 640a 2020  y = sym_or_id.  
+000057e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000057f0: 7379 6d5f 6f72 5f69 642c 2053 796d 626f  sym_or_id, Symbo
+00005800: 6c29 3a0a 2020 2020 2020 2020 6964 203d  l):.        id =
+00005810: 2073 796d 5f6f 725f 6964 2e69 640a 2020   sym_or_id.id.  
+00005820: 2020 5f67 7261 645f 666e 5f6d 6170 5b69    _grad_fn_map[i
+00005830: 645d 203d 2067 7261 6466 6e0a 0a0a 2320  d] = gradfn...# 
+00005840: 4772 6164 2066 756e 6374 696f 6e73 2066  Grad functions f
+00005850: 6f72 2070 7269 6d73 0a66 726f 6d20 7468  or prims.from th
+00005860: 756e 6465 722e 636f 7265 2e70 7269 6d73  under.core.prims
+00005870: 2069 6d70 6f72 7420 5072 696d 4944 7320   import PrimIDs 
+00005880: 6173 2070 6964 732c 2067 6574 5f67 7261  as pids, get_gra
+00005890: 642c 2070 7574 5f67 7261 640a 0a0a 2320  d, put_grad...# 
+000058a0: 4120 6765 6e65 7261 6c69 7a61 7469 6f6e  A generalization
+000058b0: 206f 6620 7072 696d 732e 7075 745f 6772   of prims.put_gr
+000058c0: 6164 2074 6f20 7079 7472 6565 730a 2320  ad to pytrees.# 
+000058d0: 544f 444f 2043 6f6e 7369 6465 7220 7661  TODO Consider va
+000058e0: 6c69 6461 7469 6e67 2074 6861 7420 7468  lidating that th
+000058f0: 6520 7370 6563 7320 6172 6520 7468 6520  e specs are the 
+00005900: 7361 6d65 0a23 2054 4f44 4f20 436f 6e73  same.# TODO Cons
+00005910: 6964 6572 2076 616c 6964 6174 696e 6720  ider validating 
+00005920: 7468 6174 2074 6861 7420 6f62 6a65 6374  that that object
+00005930: 2072 6571 7569 7265 7320 6772 6164 2028   requires grad (
+00005940: 616e 6420 6669 6c74 6572 696e 6720 6f2e  and filtering o.
+00005950: 772e 290a 6465 6620 7075 745f 6772 6164  w.).def put_grad
+00005960: 7328 612c 2067 293a 0a20 2020 2066 6c61  s(a, g):.    fla
+00005970: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
+00005980: 7474 656e 2861 290a 2020 2020 666c 6174  tten(a).    flat
+00005990: 6772 6164 732c 205f 203d 2074 7265 655f  grads, _ = tree_
+000059a0: 666c 6174 7465 6e28 6729 0a0a 2020 2020  flatten(g)..    
+000059b0: 666f 7220 662c 2066 6720 696e 207a 6970  for f, fg in zip
+000059c0: 2866 6c61 7473 2c20 666c 6174 6772 6164  (flats, flatgrad
+000059d0: 7329 3a0a 2020 2020 2020 2020 6966 2069  s):.        if i
+000059e0: 7369 6e73 7461 6e63 6528 662c 2054 656e  sinstance(f, Ten
+000059f0: 736f 7250 726f 7879 2920 616e 6420 6973  sorProxy) and is
+00005a00: 696e 7374 616e 6365 2866 672c 2054 656e  instance(fg, Ten
+00005a10: 736f 7250 726f 7879 293a 0a20 2020 2020  sorProxy):.     
+00005a20: 2020 2020 2020 2070 7574 5f67 7261 6428         put_grad(
+00005a30: 662c 2066 6729 0a0a 0a23 0a23 2055 6e70  f, fg)...#.# Unp
+00005a40: 6163 6b69 6e67 206f 7065 7261 746f 7220  acking operator 
+00005a50: 6772 6164 730a 230a 0a23 204e 4f54 4520  grads.#..# NOTE 
+00005a60: 7072 696d 732e 756e 7061 636b 5f65 6d70  prims.unpack_emp
+00005a70: 7479 5f64 6963 7420 6372 6561 7465 7320  ty_dict creates 
+00005a80: 6e6f 2067 7261 6420 6173 736f 6369 6174  no grad associat
+00005a90: 696f 6e73 0a72 6567 6973 7465 725f 6772  ions.register_gr
+00005aa0: 6164 2870 6964 732e 554e 5041 434b 5f45  ad(pids.UNPACK_E
+00005ab0: 4d50 5459 5f44 4943 542c 2070 7269 6d73  MPTY_DICT, prims
+00005ac0: 2e75 6e70 6163 6b5f 656d 7074 795f 6469  .unpack_empty_di
+00005ad0: 6374 290a 0a23 204e 4f54 4520 7072 696d  ct)..# NOTE prim
+00005ae0: 732e 756e 7061 636b 5f6b 6579 2063 7265  s.unpack_key cre
+00005af0: 6174 6573 206e 6f20 6772 6164 2061 7373  ates no grad ass
+00005b00: 6f63 6961 7469 6f6e 730a 7265 6769 7374  ociations.regist
+00005b10: 6572 5f67 7261 6428 7069 6473 2e55 4e50  er_grad(pids.UNP
+00005b20: 4143 4b5f 4b45 592c 2070 7269 6d73 2e75  ACK_KEY, prims.u
+00005b30: 6e70 6163 6b5f 6b65 7929 0a0a 2320 4e4f  npack_key)..# NO
+00005b40: 5445 2070 7269 6d73 2e75 6e70 6163 6b5f  TE prims.unpack_
+00005b50: 7365 7175 656e 6365 2063 7265 6174 6573  sequence creates
+00005b60: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
+00005b70: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
+00005b80: 7261 6428 7069 6473 2e55 4e50 4143 4b5f  rad(pids.UNPACK_
+00005b90: 5345 5155 454e 4345 2c20 7072 696d 732e  SEQUENCE, prims.
+00005ba0: 756e 7061 636b 5f73 6571 7565 6e63 6529  unpack_sequence)
+00005bb0: 0a0a 0a23 0a23 2044 6174 6120 6d6f 7665  ...#.# Data move
+00005bc0: 6d65 6e74 2061 6e64 2074 7261 6e73 666f  ment and transfo
+00005bd0: 726d 6174 696f 6e20 6f70 6572 6174 6f72  rmation operator
+00005be0: 2067 7261 6473 0a23 0a40 746f 7263 6863   grads.#.@torchc
+00005bf0: 7478 0a64 6566 205f 636f 6e76 6572 745f  tx.def _convert_
+00005c00: 656c 656d 656e 745f 7479 7065 5f70 7269  element_type_pri
+00005c10: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
+00005c20: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
+00005c30: 6474 7970 653a 2074 7970 6520 7c20 6474  dtype: type | dt
+00005c40: 7970 6573 2e64 7479 7065 2920 2d3e 204e  ypes.dtype) -> N
+00005c50: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00005c60: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00005c70: 7269 6d73 2e63 6f6e 7665 7274 5f65 6c65  rims.convert_ele
+00005c80: 6d65 6e74 5f74 7970 6528 612c 2064 7479  ment_type(a, dty
+00005c90: 7065 290a 0a20 2020 2067 203d 2067 6574  pe)..    g = get
+00005ca0: 5f67 7261 6428 6677 6429 0a20 2020 2067  _grad(fwd).    g
+00005cb0: 5f63 6f6e 7665 7274 6564 203d 2070 7269  _converted = pri
+00005cc0: 6d73 2e63 6f6e 7665 7274 5f65 6c65 6d65  ms.convert_eleme
+00005cd0: 6e74 5f74 7970 6528 672c 2064 7479 7065  nt_type(g, dtype
+00005ce0: 732e 746f 5f64 7479 7065 2861 2929 0a20  s.to_dtype(a)). 
+00005cf0: 2020 2070 7574 5f67 7261 6428 612c 2067     put_grad(a, g
+00005d00: 5f63 6f6e 7665 7274 6564 290a 0a20 2020  _converted)..   
+00005d10: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+00005d20: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00005d30: 2e43 4f4e 5645 5254 5f45 4c45 4d45 4e54  .CONVERT_ELEMENT
+00005d40: 5f54 5950 452c 205f 636f 6e76 6572 745f  _TYPE, _convert_
+00005d50: 656c 656d 656e 745f 7479 7065 5f70 7269  element_type_pri
+00005d60: 6d5f 6772 6164 290a 0a23 0a23 2054 656e  m_grad)..#.# Ten
+00005d70: 736f 7220 6372 6561 7469 6f6e 206f 7065  sor creation ope
+00005d80: 7261 746f 7220 6772 6164 730a 230a 0a23  rator grads.#..#
+00005d90: 204e 4f54 4520 7072 696d 732e 6675 6c6c   NOTE prims.full
+00005da0: 2063 7265 6174 6573 206e 6f20 6772 6164   creates no grad
+00005db0: 2061 7373 6f63 6961 7469 6f6e 730a 7265   associations.re
+00005dc0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00005dd0: 2e46 554c 4c2c 2070 7269 6d73 2e66 756c  .FULL, prims.ful
+00005de0: 6c29 0a0a 2320 4e4f 5445 2070 7269 6d73  l)..# NOTE prims
+00005df0: 2e69 6f74 6120 6372 6561 7465 7320 6e6f  .iota creates no
+00005e00: 2067 7261 6420 6173 736f 6369 6174 696f   grad associatio
+00005e10: 6e73 0a72 6567 6973 7465 725f 6772 6164  ns.register_grad
+00005e20: 2870 6964 732e 494f 5441 2c20 7072 696d  (pids.IOTA, prim
+00005e30: 732e 696f 7461 290a 0a0a 6465 6620 5f75  s.iota)...def _u
+00005e40: 6e69 666f 726d 5f67 7261 6428 7368 6170  niform_grad(shap
+00005e50: 652c 206d 696e 7661 6c2c 206d 6178 7661  e, minval, maxva
+00005e60: 6c2c 202a 2c20 6465 7669 6365 2c20 6474  l, *, device, dt
+00005e70: 7970 6529 3a0a 2020 2020 6677 642c 2073  ype):.    fwd, s
+00005e80: 6176 6564 203d 2075 6e69 666f 726d 5f61  aved = uniform_a
+00005e90: 7567 5f66 7764 2873 6861 7065 2c20 6d69  ug_fwd(shape, mi
+00005ea0: 6e76 616c 2c20 6d61 7876 616c 2c20 6465  nval, maxval, de
+00005eb0: 7669 6365 3d64 6576 6963 652c 2064 7479  vice=device, dty
+00005ec0: 7065 3d64 7479 7065 290a 2020 2020 6720  pe=dtype).    g 
+00005ed0: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00005ee0: 2020 2020 5f2c 2067 6d69 6e76 616c 2c20      _, gminval, 
+00005ef0: 676d 6178 7661 6c20 3d20 756e 6966 6f72  gmaxval = unifor
+00005f00: 6d5f 6261 636b 7761 7264 282a 7361 7665  m_backward(*save
+00005f10: 642c 2067 290a 2020 2020 7075 745f 6772  d, g).    put_gr
+00005f20: 6164 7328 286d 696e 7661 6c2c 206d 6178  ads((minval, max
+00005f30: 7661 6c29 2c20 2867 6d69 6e76 616c 2c20  val), (gminval, 
+00005f40: 676d 6178 7661 6c29 290a 2020 2020 7265  gmaxval)).    re
+00005f50: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00005f60: 7465 725f 6772 6164 2870 6964 732e 554e  ter_grad(pids.UN
+00005f70: 4946 4f52 4d2c 205f 756e 6966 6f72 6d5f  IFORM, _uniform_
+00005f80: 6772 6164 290a 0a23 0a23 2052 6573 6861  grad)..#.# Resha
+00005f90: 7069 6e67 2061 6e64 2070 6572 6d75 7469  ping and permuti
+00005fa0: 6e67 206f 7065 7261 746f 7220 6772 6164  ng operator grad
+00005fb0: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
+00005fc0: 6465 6620 5f62 726f 6164 6361 7374 5f69  def _broadcast_i
+00005fd0: 6e5f 6469 6d5f 7072 696d 5f67 7261 6428  n_dim_prim_grad(
+00005fe0: 0a20 2020 2061 3a20 5465 6e73 6f72 5072  .    a: TensorPr
+00005ff0: 6f78 792c 2073 6861 7065 3a20 5365 7175  oxy, shape: Sequ
+00006000: 656e 6365 5b69 6e74 5d2c 2062 726f 6164  ence[int], broad
+00006010: 6361 7374 5f64 696d 656e 7369 6f6e 733a  cast_dimensions:
+00006020: 2053 6571 7565 6e63 655b 696e 745d 0a29   Sequence[int].)
+00006030: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
+00006040: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00006050: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
+00006060: 6d28 612c 2073 6861 7065 2c20 6272 6f61  m(a, shape, broa
+00006070: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+00006080: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00006090: 7261 6428 6677 6429 0a0a 2020 2020 756e  rad(fwd)..    un
+000060a0: 6974 5f64 696d 7320 3d20 7475 706c 6528  it_dims = tuple(
+000060b0: 6920 666f 7220 692c 2073 2069 6e20 656e  i for i, s in en
+000060c0: 756d 6572 6174 6528 612e 7368 6170 6529  umerate(a.shape)
+000060d0: 2069 6620 7320 3d3d 2031 290a 2020 2020   if s == 1).    
+000060e0: 6263 6173 745f 6469 6d73 203d 2074 7570  bcast_dims = tup
+000060f0: 6c65 2862 2066 6f72 2069 2c20 6220 696e  le(b for i, b in
+00006100: 2065 6e75 6d65 7261 7465 2862 726f 6164   enumerate(broad
+00006110: 6361 7374 5f64 696d 656e 7369 6f6e 7329  cast_dimensions)
+00006120: 2069 6620 6920 6e6f 7420 696e 2075 6e69   if i not in uni
+00006130: 745f 6469 6d73 290a 2020 2020 7265 6475  t_dims).    redu
+00006140: 6365 5f64 696d 7320 3d20 7475 706c 6528  ce_dims = tuple(
+00006150: 7320 666f 7220 692c 2073 2069 6e20 656e  s for i, s in en
+00006160: 756d 6572 6174 6528 7261 6e67 6528 6c65  umerate(range(le
+00006170: 6e28 7368 6170 6529 2929 2069 6620 6920  n(shape))) if i 
+00006180: 6e6f 7420 696e 2062 6361 7374 5f64 696d  not in bcast_dim
+00006190: 7329 0a0a 2020 2020 2320 4e4f 5445 2057  s)..    # NOTE W
+000061a0: 6865 6e20 7468 6520 7265 6475 6365 5f64  hen the reduce_d
+000061b0: 696d 7320 7475 706c 6520 6973 2065 6d70  ims tuple is emp
+000061c0: 7479 2c20 7079 746f 7263 6820 7265 6475  ty, pytorch redu
+000061d0: 6365 7320 616c 6c20 6469 6d65 6e73 696f  ces all dimensio
+000061e0: 6e73 2e0a 2020 2020 2320 496e 2074 6869  ns..    # In thi
+000061f0: 7320 6361 7365 2c20 7765 2064 6f20 6e6f  s case, we do no
+00006200: 7420 7761 6e74 2074 6f20 7265 6475 6365  t want to reduce
+00006210: 2061 6e79 2064 696d 656e 7369 6f6e 732c   any dimensions,
+00006220: 2073 6f20 736b 6970 2074 6869 7320 7375   so skip this su
+00006230: 6d2e 0a20 2020 2069 6620 6c65 6e28 7265  m..    if len(re
+00006240: 6475 6365 5f64 696d 7329 203e 2030 3a0a  duce_dims) > 0:.
+00006250: 2020 2020 2020 2020 6720 3d20 6c74 6f72          g = ltor
+00006260: 6368 2e73 756d 2867 2c20 7265 6475 6365  ch.sum(g, reduce
+00006270: 5f64 696d 7329 0a0a 2020 2020 2320 4e4f  _dims)..    # NO
+00006280: 5445 2054 6869 7320 6d75 7374 2062 6520  TE This must be 
+00006290: 636c 616e 672e 756e 7371 7565 657a 6520  clang.unsqueeze 
+000062a0: 6265 6361 7573 6520 746f 7263 682e 756e  because torch.un
+000062b0: 7371 7565 657a 652c 2075 6e6c 696b 6520  squeeze, unlike 
+000062c0: 636c 616e 672e 756e 7371 7565 657a 652c  clang.unsqueeze,
+000062d0: 206f 6e6c 7920 6163 6365 7074 7320 616e   only accepts an
+000062e0: 2069 6e74 6567 6572 0a20 2020 2023 2020   integer.    #  
+000062f0: 2028 7075 7420 616e 6f74 6865 7220 7761   (put another wa
+00006300: 792c 2074 6f72 6368 206f 6e6c 7920 616c  y, torch only al
+00006310: 6c6f 7773 206f 6e65 2075 6e73 7175 6565  lows one unsquee
+00006320: 7a65 2061 7420 6120 7469 6d65 290a 2020  ze at a time).  
+00006330: 2020 6720 3d20 636c 616e 672e 756e 7371    g = clang.unsq
+00006340: 7565 657a 6528 672c 2075 6e69 745f 6469  ueeze(g, unit_di
+00006350: 6d73 290a 0a20 2020 2070 7574 5f67 7261  ms)..    put_gra
+00006360: 6428 612c 2067 290a 0a20 2020 2072 6574  d(a, g)..    ret
+00006370: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00006380: 6572 5f67 7261 6428 7069 6473 2e42 524f  er_grad(pids.BRO
+00006390: 4144 4341 5354 5f49 4e5f 4449 4d2c 205f  ADCAST_IN_DIM, _
+000063a0: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
+000063b0: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
+000063c0: 6f72 6368 6374 780a 6465 6620 5f63 6174  orchctx.def _cat
+000063d0: 5f70 7269 6d5f 6772 6164 2874 656e 736f  _prim_grad(tenso
+000063e0: 7273 3a20 6c69 7374 5b54 656e 736f 7250  rs: list[TensorP
+000063f0: 726f 7879 5d2c 202f 2c20 6469 6d3a 2069  roxy], /, dim: i
+00006400: 6e74 2920 2d3e 2054 656e 736f 7250 726f  nt) -> TensorPro
+00006410: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00006420: 696d 732e 6361 7428 7465 6e73 6f72 732c  ims.cat(tensors,
+00006430: 2064 696d 290a 0a20 2020 2067 203d 2067   dim)..    g = g
+00006440: 6574 5f67 7261 6428 6677 6429 0a0a 2020  et_grad(fwd)..  
+00006450: 2020 736c 6963 655f 7374 6172 743a 2069    slice_start: i
+00006460: 6e74 203d 2030 0a20 2020 2074 3a20 5465  nt = 0.    t: Te
+00006470: 6e73 6f72 5072 6f78 790a 2020 2020 666f  nsorProxy.    fo
+00006480: 7220 7420 696e 2074 656e 736f 7273 3a0a  r t in tensors:.
+00006490: 2020 2020 2020 2020 6469 6d5f 6c65 6e3a          dim_len:
+000064a0: 2069 6e74 203d 2074 2e73 6861 7065 5b64   int = t.shape[d
+000064b0: 696d 5d0a 2020 2020 2020 2020 736c 6963  im].        slic
+000064c0: 655f 656e 643a 2069 6e74 203d 2073 6c69  e_end: int = sli
+000064d0: 6365 5f73 7461 7274 202b 2064 696d 5f6c  ce_start + dim_l
+000064e0: 656e 0a20 2020 2020 2020 2067 5f73 6c69  en.        g_sli
+000064f0: 6365 3a20 5465 6e73 6f72 5072 6f78 7920  ce: TensorProxy 
+00006500: 3d20 636c 616e 672e 736c 6963 655f 696e  = clang.slice_in
+00006510: 5f64 696d 2867 2c20 736c 6963 655f 7374  _dim(g, slice_st
+00006520: 6172 742c 2073 6c69 6365 5f65 6e64 2c20  art, slice_end, 
+00006530: 6469 6d3d 6469 6d29 0a20 2020 2020 2020  dim=dim).       
+00006540: 2073 6c69 6365 5f73 7461 7274 203d 2073   slice_start = s
+00006550: 6c69 6365 5f65 6e64 0a20 2020 2020 2020  lice_end.       
+00006560: 2070 7574 5f67 7261 6428 742c 2067 5f73   put_grad(t, g_s
+00006570: 6c69 6365 290a 0a20 2020 2072 6574 7572  lice)..    retur
+00006580: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+00006590: 5f67 7261 6428 7069 6473 2e43 4154 2c20  _grad(pids.CAT, 
+000065a0: 5f63 6174 5f70 7269 6d5f 6772 6164 290a  _cat_prim_grad).
+000065b0: 0a0a 6465 6620 5f72 6573 6861 7065 5f70  ..def _reshape_p
+000065c0: 7269 6d5f 6772 6164 2861 3a20 5465 6e73  rim_grad(a: Tens
+000065d0: 6f72 5072 6f78 792c 2073 6861 7065 3a20  orProxy, shape: 
+000065e0: 7475 706c 655b 696e 742c 202e 2e2e 5d29  tuple[int, ...])
+000065f0: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
+00006600: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00006610: 2e72 6573 6861 7065 2861 2c20 7368 6170  .reshape(a, shap
+00006620: 6529 0a0a 2020 2020 6720 3d20 6765 745f  e)..    g = get_
+00006630: 6772 6164 2866 7764 290a 0a20 2020 2061  grad(fwd)..    a
+00006640: 5f67 7261 6420 3d20 7072 696d 732e 7265  _grad = prims.re
+00006650: 7368 6170 6528 672c 2061 2e73 6861 7065  shape(g, a.shape
+00006660: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+00006670: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00006680: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00006690: 7374 6572 5f67 7261 6428 7069 6473 2e52  ster_grad(pids.R
+000066a0: 4553 4841 5045 2c20 5f72 6573 6861 7065  ESHAPE, _reshape
+000066b0: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
+000066c0: 6f72 6368 6374 780a 6465 6620 5f73 6c69  orchctx.def _sli
+000066d0: 6365 5f70 7269 6d5f 6772 6164 280a 2020  ce_prim_grad(.  
+000066e0: 2020 613a 2054 656e 736f 7250 726f 7879    a: TensorProxy
+000066f0: 2c20 7374 6172 745f 696e 6469 6365 733a  , start_indices:
+00006700: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
+00006710: 656e 645f 696e 6469 6365 733a 2053 6571  end_indices: Seq
+00006720: 7565 6e63 655b 696e 745d 2c20 7374 7269  uence[int], stri
+00006730: 6465 733a 204e 6f6e 6520 7c20 5365 7175  des: None | Sequ
+00006740: 656e 6365 5b69 6e74 5d20 3d20 4e6f 6e65  ence[int] = None
+00006750: 0a29 202d 3e20 5465 6e73 6f72 5072 6f78  .) -> TensorProx
+00006760: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00006770: 6d73 2e73 6c69 6365 5f70 7269 6d28 612c  ms.slice_prim(a,
+00006780: 2073 7461 7274 5f69 6e64 6963 6573 2c20   start_indices, 
+00006790: 656e 645f 696e 6469 6365 732c 2073 7472  end_indices, str
+000067a0: 6964 6573 290a 0a20 2020 2067 203d 2067  ides)..    g = g
+000067b0: 6574 5f67 7261 6428 6677 6429 0a0a 2020  et_grad(fwd)..  
+000067c0: 2020 7061 6464 696e 6720 3d20 4e6f 6e65    padding = None
+000067d0: 0a20 2020 2069 6620 7374 7269 6465 7320  .    if strides 
+000067e0: 6973 204e 6f6e 6520 6f72 206e 702e 616c  is None or np.al
+000067f0: 6c28 6e70 2e65 7175 616c 2873 7472 6964  l(np.equal(strid
+00006800: 6573 2c20 3129 293a 0a20 2020 2020 2020  es, 1)):.       
+00006810: 2070 6164 6469 6e67 203d 2074 7570 6c65   padding = tuple
+00006820: 287a 6970 2873 7461 7274 5f69 6e64 6963  (zip(start_indic
+00006830: 6573 2c20 6e70 2e73 7562 7472 6163 7428  es, np.subtract(
+00006840: 612e 7368 6170 652c 2065 6e64 5f69 6e64  a.shape, end_ind
+00006850: 6963 6573 292c 2028 302c 2920 2a20 6c65  ices), (0,) * le
+00006860: 6e28 7374 6172 745f 696e 6469 6365 7329  n(start_indices)
+00006870: 2929 0a20 2020 2065 6c73 653a 0a20 2020  )).    else:.   
+00006880: 2020 2020 2072 6561 6c5f 6c69 6d69 7473       real_limits
+00006890: 203d 206e 702e 6164 6428 0a20 2020 2020   = np.add(.     
+000068a0: 2020 2020 2020 2073 7461 7274 5f69 6e64         start_ind
+000068b0: 6963 6573 2c0a 2020 2020 2020 2020 2020  ices,.          
+000068c0: 2020 6e70 2e77 6865 7265 286e 702e 6571    np.where(np.eq
+000068d0: 7561 6c28 672e 7368 6170 652c 2030 292c  ual(g.shape, 0),
+000068e0: 2030 2c20 6e70 2e61 6464 2831 2c20 6e70   0, np.add(1, np
+000068f0: 2e6d 756c 7469 706c 7928 6e70 2e73 7562  .multiply(np.sub
+00006900: 7472 6163 7428 672e 7368 6170 652c 2031  tract(g.shape, 1
+00006910: 292c 2073 7472 6964 6573 2929 292c 0a20  ), strides))),. 
+00006920: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00006930: 2070 6164 6469 6e67 203d 2074 7570 6c65   padding = tuple
+00006940: 287a 6970 2873 7461 7274 5f69 6e64 6963  (zip(start_indic
+00006950: 6573 2c20 6e70 2e73 7562 7472 6163 7428  es, np.subtract(
+00006960: 612e 7368 6170 652c 2072 6561 6c5f 6c69  a.shape, real_li
+00006970: 6d69 7473 292c 206e 702e 7375 6274 7261  mits), np.subtra
+00006980: 6374 2873 7472 6964 6573 2c20 3129 2929  ct(strides, 1)))
+00006990: 0a0a 2020 2020 2320 436f 6e76 6572 7473  ..    # Converts
+000069a0: 204e 756d 5079 206e 756d 6265 7273 2074   NumPy numbers t
+000069b0: 6f20 5079 7468 6f6e 2069 6e74 730a 2020  o Python ints.  
+000069c0: 2020 2320 544f 444f 2053 686f 756c 6420    # TODO Should 
+000069d0: 7765 2073 7570 706f 7274 204e 756d 5079  we support NumPy
+000069e0: 206e 756d 6265 7273 2062 6574 7465 723f   numbers better?
+000069f0: 0a20 2020 2070 6164 6469 6e67 203d 2074  .    padding = t
+00006a00: 7265 655f 6d61 7028 696e 742c 2070 6164  ree_map(int, pad
+00006a10: 6469 6e67 290a 2020 2020 615f 6772 6164  ding).    a_grad
+00006a20: 203d 2070 7269 6d73 2e70 6164 2867 2c20   = prims.pad(g, 
+00006a30: 636f 6e73 745f 6173 2830 2c20 672e 6474  const_as(0, g.dt
+00006a40: 7970 6529 2c20 7061 6464 696e 6729 0a20  ype), padding). 
+00006a50: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
+00006a60: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
+00006a70: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+00006a80: 725f 6772 6164 2870 6964 732e 534c 4943  r_grad(pids.SLIC
+00006a90: 452c 205f 736c 6963 655f 7072 696d 5f67  E, _slice_prim_g
+00006aa0: 7261 6429 0a0a 0a40 746f 7263 6863 7478  rad)...@torchctx
+00006ab0: 0a64 6566 205f 7371 7565 657a 655f 7072  .def _squeeze_pr
+00006ac0: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
+00006ad0: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
+00006ae0: 2074 7570 6c65 5b69 6e74 2c20 2e2e 2e5d   tuple[int, ...]
+00006af0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
+00006b00: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00006b10: 732e 7371 7565 657a 6528 612c 2074 7570  s.squeeze(a, tup
+00006b20: 6c65 2864 696d 7329 290a 0a20 2020 2067  le(dims))..    g
+00006b30: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00006b40: 0a20 2020 2023 204e 4f54 4520 5468 6973  .    # NOTE This
+00006b50: 2063 616c 6c73 2063 6c61 6e67 2e75 6e73   calls clang.uns
+00006b60: 7175 6565 7a65 2c20 616e 6420 6e6f 7420  queeze, and not 
+00006b70: 746f 7263 682e 756e 7371 7565 657a 652c  torch.unsqueeze,
+00006b80: 2062 6563 6175 7365 2074 6f72 6368 2e75   because torch.u
+00006b90: 6e73 7175 6565 7a65 206f 6e6c 7920 7375  nsqueeze only su
+00006ba0: 7070 6f72 7473 0a20 2020 2023 2020 2075  pports.    #   u
+00006bb0: 6e73 7175 6565 7a69 6e67 2061 2073 696e  nsqueezing a sin
+00006bc0: 676c 6520 6469 6d65 6e73 696f 6e0a 2020  gle dimension.  
+00006bd0: 2020 615f 6772 6164 203d 2063 6c61 6e67    a_grad = clang
+00006be0: 2e75 6e73 7175 6565 7a65 2867 2c20 6469  .unsqueeze(g, di
+00006bf0: 6d73 290a 2020 2020 7075 745f 6772 6164  ms).    put_grad
+00006c00: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
+00006c10: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+00006c20: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00006c30: 2e53 5155 4545 5a45 2c20 5f73 7175 6565  .SQUEEZE, _squee
+00006c40: 7a65 5f70 7269 6d5f 6772 6164 290a 0a0a  ze_prim_grad)...
+00006c50: 4074 6f72 6368 6374 780a 6465 6620 5f74  @torchctx.def _t
+00006c60: 616b 655f 7072 696d 5f67 7261 6428 613a  ake_prim_grad(a:
+00006c70: 2054 656e 736f 7250 726f 7879 2c20 696e   TensorProxy, in
+00006c80: 6465 783a 2054 656e 736f 7250 726f 7879  dex: TensorProxy
+00006c90: 2c20 6469 6d3a 2069 6e74 2920 2d3e 2054  , dim: int) -> T
+00006ca0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00006cb0: 6677 6420 3d20 7072 696d 732e 7461 6b65  fwd = prims.take
+00006cc0: 2861 2c20 696e 6465 782c 2064 696d 290a  (a, index, dim).
+00006cd0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00006ce0: 6428 6677 6429 0a0a 2020 2020 2320 544f  d(fwd)..    # TO
+00006cf0: 444f 2053 7769 7463 6820 746f 206c 746f  DO Switch to lto
+00006d00: 7263 682e 696e 6465 785f 6164 643f 0a20  rch.index_add?. 
+00006d10: 2020 2023 204e 4f54 4520 496e 7465 6e74     # NOTE Intent
+00006d20: 696f 6e61 6c6c 7920 6e6f 7420 6361 6c6c  ionally not call
+00006d30: 696e 6720 7a65 726f 735f 6c69 6b65 2074  ing zeros_like t
+00006d40: 6f20 6176 6f69 6420 7072 6573 6572 7669  o avoid preservi
+00006d50: 6e67 2061 0a20 2020 2023 2054 4f44 4f20  ng a.    # TODO 
+00006d60: 5570 6461 7465 2074 6f20 6361 6c6c 206c  Update to call l
+00006d70: 746f 7263 682e 7a65 726f 730a 2020 2020  torch.zeros.    
+00006d80: 7a65 726f 7320 3d20 7072 696d 732e 6675  zeros = prims.fu
+00006d90: 6c6c 2861 2e73 6861 7065 2c20 6669 6c6c  ll(a.shape, fill
+00006da0: 5f76 616c 7565 3d30 2c20 6465 7669 6365  _value=0, device
+00006db0: 3d61 2e64 6576 6963 652c 2064 7479 7065  =a.device, dtype
+00006dc0: 3d61 2e64 7479 7065 290a 2020 2020 615f  =a.dtype).    a_
+00006dd0: 6772 6164 203d 2070 7269 6d73 2e69 6e64  grad = prims.ind
+00006de0: 6578 5f61 6464 287a 6572 6f73 2c20 696e  ex_add(zeros, in
+00006df0: 6465 782c 2067 2c20 6469 6d29 0a20 2020  dex, g, dim).   
+00006e00: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
+00006e10: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+00006e20: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+00006e30: 6772 6164 2870 6964 732e 5441 4b45 2c20  grad(pids.TAKE, 
+00006e40: 5f74 616b 655f 7072 696d 5f67 7261 6429  _take_prim_grad)
+00006e50: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00006e60: 205f 6761 7468 6572 5f70 7269 6d5f 6772   _gather_prim_gr
+00006e70: 6164 2861 3a20 5465 6e73 6f72 5072 6f78  ad(a: TensorProx
+00006e80: 792c 2069 6e64 6578 3a20 5465 6e73 6f72  y, index: Tensor
+00006e90: 5072 6f78 792c 2064 696d 3a20 696e 7429  Proxy, dim: int)
+00006ea0: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
+00006eb0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
+00006ec0: 2e67 6174 6865 7228 612c 2069 6e64 6578  .gather(a, index
+00006ed0: 2c20 6469 6d29 0a0a 2020 2020 6720 3d20  , dim)..    g = 
+00006ee0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00006ef0: 2020 2320 4e4f 5445 2049 6e74 656e 7469    # NOTE Intenti
+00006f00: 6f6e 616c 6c79 206e 6f74 2063 616c 6c69  onally not calli
+00006f10: 6e67 207a 6572 6f73 5f6c 696b 6520 746f  ng zeros_like to
+00006f20: 2061 766f 6964 2070 7265 7365 7276 696e   avoid preservin
+00006f30: 6720 5465 6e73 6f72 5072 6f78 7920 612e  g TensorProxy a.
+00006f40: 0a20 2020 2023 2054 4f44 4f20 5570 6461  .    # TODO Upda
+00006f50: 7465 2074 6f20 6361 6c6c 206c 746f 7263  te to call ltorc
+00006f60: 682e 7a65 726f 730a 2020 2020 7a65 726f  h.zeros.    zero
+00006f70: 7320 3d20 7072 696d 732e 6675 6c6c 2861  s = prims.full(a
+00006f80: 2e73 6861 7065 2c20 6669 6c6c 5f76 616c  .shape, fill_val
+00006f90: 7565 3d30 2c20 6465 7669 6365 3d61 2e64  ue=0, device=a.d
+00006fa0: 6576 6963 652c 2064 7479 7065 3d61 2e64  evice, dtype=a.d
+00006fb0: 7479 7065 290a 2020 2020 615f 6772 6164  type).    a_grad
+00006fc0: 203d 2070 7269 6d73 2e73 6361 7474 6572   = prims.scatter
+00006fd0: 5f61 6464 287a 6572 6f73 2c20 696e 6465  _add(zeros, inde
+00006fe0: 782c 2067 2c20 6469 6d29 0a20 2020 2070  x, g, dim).    p
+00006ff0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+00007000: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+00007010: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00007020: 6164 2870 6964 732e 4741 5448 4552 2c20  ad(pids.GATHER, 
+00007030: 5f67 6174 6865 725f 7072 696d 5f67 7261  _gather_prim_gra
+00007040: 6429 0a0a 0a40 746f 7263 6863 7478 0a64  d)...@torchctx.d
+00007050: 6566 205f 7363 6174 7465 725f 6164 645f  ef _scatter_add_
+00007060: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
+00007070: 736f 7250 726f 7879 2c20 2f2c 2069 6e64  sorProxy, /, ind
+00007080: 6578 3a20 5465 6e73 6f72 5072 6f78 792c  ex: TensorProxy,
+00007090: 2076 616c 7565 3a20 5465 6e73 6f72 5072   value: TensorPr
+000070a0: 6f78 792c 2064 696d 3a20 696e 7429 202d  oxy, dim: int) -
+000070b0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+000070c0: 2020 2075 7469 6c73 2e63 6865 636b 280a     utils.check(.
+000070d0: 2020 2020 2020 2020 6e6f 7420 7661 6c75          not valu
+000070e0: 652e 5f72 6571 7569 7265 735f 6772 6164  e._requires_grad
+000070f0: 206f 7220 7661 6c75 652e 7368 6170 6520   or value.shape 
+00007100: 3d3d 2069 6e64 6578 2e73 6861 7065 2c0a  == index.shape,.
+00007110: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+00007120: 6622 5468 6520 6772 6164 6965 6e74 2066  f"The gradient f
+00007130: 6f72 2074 6865 2076 616c 7565 2054 656e  or the value Ten
+00007140: 736f 7220 6973 2069 6d70 6c65 6d65 6e74  sor is implement
+00007150: 6564 206f 6e6c 7920 7768 656e 2076 616c  ed only when val
+00007160: 7565 2e73 6861 7065 203d 3d20 696e 6465  ue.shape == inde
+00007170: 782e 7368 6170 652e 2022 0a20 2020 2020  x.shape. ".     
+00007180: 2020 2022 7661 6c75 6520 7368 6170 6520     "value shape 
+00007190: 6973 207b 7661 6c75 652e 7368 6170 657d  is {value.shape}
+000071a0: 2077 6869 6c65 2069 6e64 6578 2073 6861   while index sha
+000071b0: 7065 2069 7320 7b69 6e64 6578 2e73 6861  pe is {index.sha
+000071c0: 7065 7d22 2c0a 2020 2020 290a 0a20 2020  pe}",.    )..   
+000071d0: 2066 7764 203d 2070 7269 6d73 2e73 6361   fwd = prims.sca
+000071e0: 7474 6572 5f61 6464 2861 2c20 696e 6465  tter_add(a, inde
+000071f0: 782c 2076 616c 7565 2c20 6469 6d29 0a0a  x, value, dim)..
+00007200: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007210: 2866 7764 290a 2020 2020 2320 4e4f 5445  (fwd).    # NOTE
+00007220: 2054 6865 2076 616c 7565 2067 7261 6469   The value gradi
+00007230: 656e 7420 6973 206f 6e6c 7920 636f 7272  ent is only corr
+00007240: 6563 7420 7768 656e 2073 7263 2e73 6861  ect when src.sha
+00007250: 7065 203d 3d20 696e 6465 782e 7368 6170  pe == index.shap
+00007260: 652e 0a20 2020 2023 2053 6565 2068 7474  e..    # See htt
+00007270: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00007280: 7079 746f 7263 682f 7079 746f 7263 682f  pytorch/pytorch/
+00007290: 6973 7375 6573 2f32 3736 3134 2369 7373  issues/27614#iss
+000072a0: 7565 636f 6d6d 656e 742d 3536 3436 3438  uecomment-564648
+000072b0: 3831 390a 2020 2020 7661 6c75 655f 6772  819.    value_gr
+000072c0: 6164 203d 2070 7269 6d73 2e67 6174 6865  ad = prims.gathe
+000072d0: 7228 672c 2069 6e64 6578 2c20 6469 6d29  r(g, index, dim)
+000072e0: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
+000072f0: 612c 2076 616c 7565 292c 2028 672c 2076  a, value), (g, v
+00007300: 616c 7565 5f67 7261 6429 290a 0a20 2020  alue_grad))..   
+00007310: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+00007320: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00007330: 2e53 4341 5454 4552 5f41 4444 2c20 5f73  .SCATTER_ADD, _s
+00007340: 6361 7474 6572 5f61 6464 5f70 7269 6d5f  catter_add_prim_
+00007350: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
+00007360: 780a 6465 6620 5f74 616b 655f 616c 6f6e  x.def _take_alon
+00007370: 675f 6178 6973 5f70 7269 6d5f 6772 6164  g_axis_prim_grad
+00007380: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
+00007390: 2069 6e64 6578 3a20 5465 6e73 6f72 5072   index: TensorPr
+000073a0: 6f78 792c 2064 696d 3a20 696e 7429 202d  oxy, dim: int) -
+000073b0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+000073c0: 2020 2066 7764 203d 2070 7269 6d73 2e74     fwd = prims.t
+000073d0: 616b 655f 616c 6f6e 675f 6178 6973 2861  ake_along_axis(a
+000073e0: 2c20 696e 6465 782c 2064 696d 290a 0a20  , index, dim).. 
+000073f0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007400: 6677 6429 0a20 2020 2023 204e 4f54 4520  fwd).    # NOTE 
+00007410: 496e 7465 6e74 696f 6e61 6c6c 7920 6e6f  Intentionally no
+00007420: 7420 6361 6c6c 696e 6720 7a65 726f 735f  t calling zeros_
+00007430: 6c69 6b65 2074 6f20 6176 6f69 6420 7072  like to avoid pr
+00007440: 6573 6572 7669 6e67 2054 656e 736f 7250  eserving TensorP
+00007450: 726f 7879 2061 2e0a 2020 2020 2320 544f  roxy a..    # TO
+00007460: 444f 2055 7064 6174 6520 746f 2063 616c  DO Update to cal
+00007470: 6c20 6c74 6f72 6368 2e7a 6572 6f73 0a20  l ltorch.zeros. 
+00007480: 2020 207a 6572 6f73 203d 2070 7269 6d73     zeros = prims
+00007490: 2e66 756c 6c28 612e 7368 6170 652c 2066  .full(a.shape, f
+000074a0: 696c 6c5f 7661 6c75 653d 302c 2064 6576  ill_value=0, dev
+000074b0: 6963 653d 612e 6465 7669 6365 2c20 6474  ice=a.device, dt
+000074c0: 7970 653d 612e 6474 7970 6529 0a20 2020  ype=a.dtype).   
+000074d0: 2061 5f67 7261 6420 3d20 7072 696d 732e   a_grad = prims.
+000074e0: 7363 6174 7465 725f 6164 6428 7a65 726f  scatter_add(zero
+000074f0: 732c 2069 6e64 6578 2c20 672c 2064 696d  s, index, g, dim
+00007500: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+00007510: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00007520: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00007530: 7374 6572 5f67 7261 6428 7069 6473 2e54  ster_grad(pids.T
+00007540: 414b 455f 414c 4f4e 475f 4158 4953 2c20  AKE_ALONG_AXIS, 
+00007550: 5f74 616b 655f 616c 6f6e 675f 6178 6973  _take_along_axis
+00007560: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
+00007570: 6f72 6368 6374 780a 6465 6620 5f74 7261  orchctx.def _tra
+00007580: 6e73 706f 7365 5f70 7269 6d5f 6772 6164  nspose_prim_grad
+00007590: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
+000075a0: 2070 6572 6d75 7461 7469 6f6e 3a20 7475   permutation: tu
+000075b0: 706c 655b 696e 742c 202e 2e2e 5d29 202d  ple[int, ...]) -
+000075c0: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+000075d0: 2020 2066 7764 203d 2070 7269 6d73 2e74     fwd = prims.t
+000075e0: 7261 6e73 706f 7365 2861 2c20 7475 706c  ranspose(a, tupl
+000075f0: 6528 7065 726d 7574 6174 696f 6e29 290a  e(permutation)).
+00007600: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00007610: 6428 6677 6429 0a20 2020 2075 6e64 6f20  d(fwd).    undo 
+00007620: 3d20 5f61 7267 736f 7274 2870 6572 6d75  = _argsort(permu
+00007630: 7461 7469 6f6e 290a 2020 2020 615f 6772  tation).    a_gr
+00007640: 6164 203d 2070 7269 6d73 2e74 7261 6e73  ad = prims.trans
+00007650: 706f 7365 2867 2c20 7475 706c 6528 756e  pose(g, tuple(un
+00007660: 646f 2929 0a20 2020 2070 7574 5f67 7261  do)).    put_gra
+00007670: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
+00007680: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00007690: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+000076a0: 732e 5452 414e 5350 4f53 452c 205f 7472  s.TRANSPOSE, _tr
+000076b0: 616e 7370 6f73 655f 7072 696d 5f67 7261  anspose_prim_gra
+000076c0: 6429 0a0a 230a 2320 4d65 6d6f 7279 206c  d)..#.# Memory l
+000076d0: 6179 6f75 7420 6f70 6572 6174 6f72 2067  ayout operator g
+000076e0: 7261 6473 0a23 0a0a 0a40 746f 7263 6863  rads.#...@torchc
+000076f0: 7478 0a64 6566 205f 7374 7269 6465 5f6f  tx.def _stride_o
+00007700: 7264 6572 5f70 7269 6d5f 6772 6164 2861  rder_prim_grad(a
+00007710: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
+00007720: 2c20 6f72 6465 723a 2053 6571 7565 6e63  , order: Sequenc
+00007730: 655b 696e 745d 2920 2d3e 2054 656e 736f  e[int]) -> Tenso
+00007740: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00007750: 3d20 7072 696d 732e 7374 7269 6465 5f6f  = prims.stride_o
+00007760: 7264 6572 2861 2c20 6f72 6465 7229 0a0a  rder(a, order)..
+00007770: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007780: 2866 7764 290a 2020 2020 7075 745f 6772  (fwd).    put_gr
+00007790: 6164 2861 2c20 6729 0a0a 2020 2020 7265  ad(a, g)..    re
+000077a0: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+000077b0: 7465 725f 6772 6164 2870 6964 732e 5354  ter_grad(pids.ST
+000077c0: 5249 4445 5f4f 5244 4552 2c20 5f73 7472  RIDE_ORDER, _str
+000077d0: 6964 655f 6f72 6465 725f 7072 696d 5f67  ide_order_prim_g
+000077e0: 7261 6429 0a0a 0a23 0a23 2045 6c65 6d65  rad)...#.# Eleme
+000077f0: 6e74 7769 7365 2075 6e61 7279 206f 7065  ntwise unary ope
+00007800: 7261 746f 7220 6772 6164 730a 230a 4074  rator grads.#.@t
+00007810: 6f72 6368 6374 780a 6465 6620 5f61 6273  orchctx.def _abs
+00007820: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
+00007830: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007840: 7879 2920 2d3e 204e 756d 6265 7220 7c20  xy) -> Number | 
+00007850: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007860: 2066 7764 203d 2070 7269 6d73 2e61 6273   fwd = prims.abs
+00007870: 2861 290a 0a20 2020 2067 203d 2067 6574  (a)..    g = get
+00007880: 5f67 7261 6428 6677 6429 0a20 2020 2070  _grad(fwd).    p
+00007890: 7574 5f67 7261 6428 612c 2067 202a 206c  ut_grad(a, g * l
+000078a0: 746f 7263 682e 7369 676e 2861 2929 0a0a  torch.sign(a))..
+000078b0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+000078c0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+000078d0: 6964 732e 4142 532c 205f 6162 735f 7072  ids.ABS, _abs_pr
+000078e0: 696d 5f67 7261 6429 0a0a 0a64 6566 205f  im_grad)...def _
+000078f0: 636f 735f 7072 696d 5f67 7261 6428 613a  cos_prim_grad(a:
+00007900: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007910: 5072 6f78 7929 202d 3e20 4e75 6d62 6572  Proxy) -> Number
+00007920: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
+00007930: 2020 2020 6677 6420 3d20 7072 696d 732e      fwd = prims.
+00007940: 636f 7328 6129 0a0a 2020 2020 6720 3d20  cos(a)..    g = 
+00007950: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00007960: 2020 7075 745f 6772 6164 2861 2c20 6720    put_grad(a, g 
+00007970: 2a20 282d 7072 696d 732e 7369 6e28 6129  * (-prims.sin(a)
+00007980: 2929 0a0a 2020 2020 7265 7475 726e 2066  ))..    return f
+00007990: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+000079a0: 6164 2870 6964 732e 434f 532c 205f 636f  ad(pids.COS, _co
+000079b0: 735f 7072 696d 5f67 7261 6429 0a0a 0a40  s_prim_grad)...@
+000079c0: 746f 7263 6863 7478 0a64 6566 205f 6572  torchctx.def _er
+000079d0: 665f 7072 696d 5f67 7261 6428 613a 204e  f_prim_grad(a: N
+000079e0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+000079f0: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
+00007a00: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00007a10: 2020 6677 6420 3d20 7072 696d 732e 6572    fwd = prims.er
+00007a20: 6628 6129 0a0a 2020 2020 6720 3d20 6765  f(a)..    g = ge
+00007a30: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00007a40: 615f 6772 6164 203d 2032 202f 206d 6174  a_grad = 2 / mat
+00007a50: 682e 7371 7274 286d 6174 682e 7069 2920  h.sqrt(math.pi) 
+00007a60: 2a20 6c74 6f72 6368 2e65 7870 282d 2861  * ltorch.exp(-(a
+00007a70: 2a2a 3229 2920 2a20 670a 2020 2020 7075  **2)) * g.    pu
+00007a80: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
+00007a90: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00007aa0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00007ab0: 6428 7069 6473 2e45 5246 2c20 5f65 7266  d(pids.ERF, _erf
+00007ac0: 5f70 7269 6d5f 6772 6164 290a 0a0a 4074  _prim_grad)...@t
+00007ad0: 6f72 6368 6374 780a 6465 6620 5f65 7870  orchctx.def _exp
+00007ae0: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
+00007af0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
+00007b00: 7879 2920 2d3e 204e 756d 6265 7220 7c20  xy) -> Number | 
+00007b10: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007b20: 2066 7764 203d 2070 7269 6d73 2e65 7870   fwd = prims.exp
+00007b30: 2861 290a 0a20 2020 2067 203d 2067 6574  (a)..    g = get
+00007b40: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
+00007b50: 5f67 7261 6420 3d20 6720 2a20 6677 640a  _grad = g * fwd.
+00007b60: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00007b70: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00007b80: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00007b90: 6572 5f67 7261 6428 7069 6473 2e45 5850  er_grad(pids.EXP
+00007ba0: 2c20 5f65 7870 5f70 7269 6d5f 6772 6164  , _exp_prim_grad
+00007bb0: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+00007bc0: 6620 5f6c 6f67 5f70 7269 6d5f 6772 6164  f _log_prim_grad
+00007bd0: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
+00007be0: 736f 7250 726f 7879 2920 2d3e 204e 756d  sorProxy) -> Num
+00007bf0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007c00: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00007c10: 6d73 2e6c 6f67 2861 290a 0a20 2020 2067  ms.log(a)..    g
+00007c20: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00007c30: 0a20 2020 2061 5f67 7261 6420 3d20 6720  .    a_grad = g 
+00007c40: 2f20 610a 2020 2020 7075 745f 6772 6164  / a.    put_grad
+00007c50: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
+00007c60: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+00007c70: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00007c80: 2e4c 4f47 2c20 5f6c 6f67 5f70 7269 6d5f  .LOG, _log_prim_
+00007c90: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
+00007ca0: 780a 6465 6620 5f6e 6567 5f70 7269 6d5f  x.def _neg_prim_
+00007cb0: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
+00007cc0: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
+00007cd0: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007ce0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007cf0: 2070 7269 6d73 2e6e 6567 2861 290a 0a20   prims.neg(a).. 
+00007d00: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00007d10: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
+00007d20: 6428 612c 202d 6729 0a0a 2020 2020 7265  d(a, -g)..    re
+00007d30: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00007d40: 7465 725f 6772 6164 2870 6964 732e 4e45  ter_grad(pids.NE
+00007d50: 472c 205f 6e65 675f 7072 696d 5f67 7261  G, _neg_prim_gra
+00007d60: 6429 0a0a 0a40 746f 7263 6863 7478 0a64  d)...@torchctx.d
+00007d70: 6566 205f 7273 7172 745f 7072 696d 5f67  ef _rsqrt_prim_g
+00007d80: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
+00007d90: 5465 6e73 6f72 5072 6f78 792c 202f 2920  TensorProxy, /) 
+00007da0: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
+00007db0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00007dc0: 203d 2070 7269 6d73 2e72 7371 7274 2861   = prims.rsqrt(a
+00007dd0: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00007de0: 7261 6428 6677 6429 0a20 2020 2023 2041  rad(fwd).    # A
+00007df0: 6e20 616c 7465 726e 6174 6976 6520 6465  n alternative de
+00007e00: 7269 7661 7469 6f6e 2075 7365 6420 6279  rivation used by
+00007e10: 204a 4158 2069 7320 2d30 2e35 202a 2067   JAX is -0.5 * g
+00007e20: 202a 2072 7371 7274 2878 2920 2f20 780a   * rsqrt(x) / x.
+00007e30: 2020 2020 2320 7768 6572 6520 7273 7172      # where rsqr
+00007e40: 7428 7829 2061 6e64 2078 2061 7265 2073  t(x) and x are s
+00007e50: 6176 6564 2066 6f72 2074 6865 2062 6163  aved for the bac
+00007e60: 6b77 6172 6473 2070 6173 732e 0a20 2020  kwards pass..   
+00007e70: 2023 2054 6869 7320 6465 7269 7661 7469   # This derivati
+00007e80: 6f6e 2077 6173 2073 656c 6563 7465 6420  on was selected 
+00007e90: 6265 6361 7573 6520 6974 2061 766f 6964  because it avoid
+00007ea0: 7320 7361 7669 6e67 2074 6865 2069 6e70  s saving the inp
+00007eb0: 7574 2074 656e 736f 722e 0a20 2020 2061  ut tensor..    a
+00007ec0: 5f67 7261 6420 3d20 2d30 2e35 202a 2067  _grad = -0.5 * g
+00007ed0: 202a 2066 7764 2a2a 332e 300a 2020 2020   * fwd**3.0.    
+00007ee0: 7075 745f 6772 6164 2861 2c20 615f 6772  put_grad(a, a_gr
+00007ef0: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
+00007f00: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00007f10: 7261 6428 7069 6473 2e52 5351 5254 2c20  rad(pids.RSQRT, 
+00007f20: 5f72 7371 7274 5f70 7269 6d5f 6772 6164  _rsqrt_prim_grad
+00007f30: 290a 0a0a 6465 6620 5f73 696e 5f70 7269  )...def _sin_pri
+00007f40: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
+00007f50: 207c 2054 656e 736f 7250 726f 7879 2920   | TensorProxy) 
+00007f60: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
+00007f70: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00007f80: 203d 2070 7269 6d73 2e73 696e 2861 290a   = prims.sin(a).
+00007f90: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00007fa0: 6428 6677 6429 0a20 2020 2070 7574 5f67  d(fwd).    put_g
+00007fb0: 7261 6428 612c 2067 202a 2070 7269 6d73  rad(a, g * prims
+00007fc0: 2e63 6f73 2861 2929 0a0a 2020 2020 7265  .cos(a))..    re
+00007fd0: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00007fe0: 7465 725f 6772 6164 2870 6964 732e 5349  ter_grad(pids.SI
+00007ff0: 4e2c 205f 7369 6e5f 7072 696d 5f67 7261  N, _sin_prim_gra
+00008000: 6429 0a0a 0a40 746f 7263 6863 7478 0a64  d)...@torchctx.d
+00008010: 6566 205f 7461 6e68 5f70 7269 6d5f 6772  ef _tanh_prim_gr
+00008020: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+00008030: 656e 736f 7250 726f 7879 2c20 2f29 202d  ensorProxy, /) -
+00008040: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
+00008050: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00008060: 3d20 7072 696d 732e 7461 6e68 2861 290a  = prims.tanh(a).
+00008070: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
+00008080: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
+00008090: 6420 3d20 6720 2a20 2831 202d 2066 7764  d = g * (1 - fwd
+000080a0: 202a 2066 7764 290a 2020 2020 7075 745f   * fwd).    put_
+000080b0: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
+000080c0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+000080d0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+000080e0: 7069 6473 2e54 414e 482c 205f 7461 6e68  pids.TANH, _tanh
+000080f0: 5f70 7269 6d5f 6772 6164 290a 0a23 0a23  _prim_grad)..#.#
+00008100: 2045 6c65 6d65 6e74 7769 7365 2062 696e   Elementwise bin
+00008110: 6172 7920 6f70 6572 6174 6f72 2067 7261  ary operator gra
+00008120: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
+00008130: 0a64 6566 205f 6164 645f 7072 696d 5f67  .def _add_prim_g
+00008140: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
+00008150: 5465 6e73 6f72 5072 6f78 792c 2062 3a20  TensorProxy, b: 
+00008160: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+00008170: 726f 7879 2c20 2f29 202d 3e20 4e75 6d62  roxy, /) -> Numb
+00008180: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00008190: 3a0a 2020 2020 6677 6420 3d20 6120 2b20  :.    fwd = a + 
+000081a0: 620a 0a20 2020 2067 203d 2067 6574 5f67  b..    g = get_g
+000081b0: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+000081c0: 7261 6420 3d20 670a 2020 2020 625f 6772  rad = g.    b_gr
+000081d0: 6164 203d 2067 0a20 2020 2070 7574 5f67  ad = g.    put_g
+000081e0: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
+000081f0: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
+00008200: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008210: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008220: 6964 732e 4144 442c 205f 6164 645f 7072  ids.ADD, _add_pr
+00008230: 696d 5f67 7261 6429 0a0a 0a23 204e 4f54  im_grad)...# NOT
+00008240: 4520 5468 6520 666f 6c6c 6f77 696e 6720  E The following 
+00008250: 6772 6164 2064 6566 696e 6974 696f 6e20  grad definition 
+00008260: 7265 6c69 6573 206f 6e20 7468 6520 6661  relies on the fa
+00008270: 6374 2074 6861 7420 6f6e 6c79 2069 6e65  ct that only ine
+00008280: 7861 6374 2064 7479 7065 7320 6172 6520  xact dtypes are 
+00008290: 6469 6666 6572 656e 7469 6162 6c65 2c0a  differentiable,.
+000082a0: 2320 2020 616e 6420 746f 7263 6827 7320  #   and torch's 
+000082b0: 7472 7565 2064 6976 6973 696f 6e20 6f70  true division op
+000082c0: 6572 6174 6f72 2061 6e64 2074 6865 2064  erator and the d
+000082d0: 6976 6973 696f 6e20 7072 696d 6974 6976  ivision primitiv
+000082e0: 6520 6167 7265 6520 6f6e 2074 686f 7365  e agree on those
+000082f0: 2074 7970 6573 0a40 746f 7263 6863 7478   types.@torchctx
+00008300: 0a64 6566 205f 6469 765f 7072 696d 5f67  .def _div_prim_g
+00008310: 7261 6428 613a 204e 756d 6265 7220 7c20  rad(a: Number | 
+00008320: 5465 6e73 6f72 5072 6f78 792c 2062 3a20  TensorProxy, b: 
+00008330: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
+00008340: 726f 7879 2c20 2f29 202d 3e20 4e75 6d62  roxy, /) -> Numb
+00008350: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00008360: 3a0a 2020 2020 6677 6420 3d20 6120 2f20  :.    fwd = a / 
+00008370: 620a 0a20 2020 2067 203d 2067 6574 5f67  b..    g = get_g
+00008380: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
+00008390: 7261 6420 3d20 6720 2f20 620a 2020 2020  rad = g / b.    
+000083a0: 625f 6772 6164 203d 202d 6720 2a20 2828  b_grad = -g * ((
+000083b0: 6120 2f20 6229 202f 2062 290a 2020 2020  a / b) / b).    
+000083c0: 7075 745f 6772 6164 7328 2861 2c20 6229  put_grads((a, b)
+000083d0: 2c20 2861 5f67 7261 642c 2062 5f67 7261  , (a_grad, b_gra
+000083e0: 6429 290a 0a20 2020 2072 6574 7572 6e20  d))..    return 
+000083f0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00008400: 7261 6428 7069 6473 2e44 4956 2c20 5f64  rad(pids.DIV, _d
+00008410: 6976 5f70 7269 6d5f 6772 6164 290a 0a23  iv_prim_grad)..#
+00008420: 2043 6f6d 7061 7269 736f 6e20 6f70 6572   Comparison oper
+00008430: 6174 6f72 7320 2d2d 2074 6865 7365 2063  ators -- these c
+00008440: 7265 6174 6520 6e6f 2067 7261 6420 6173  reate no grad as
+00008450: 736f 6369 6174 696f 6e73 0a72 6567 6973  sociations.regis
+00008460: 7465 725f 6772 6164 2870 6964 732e 4551  ter_grad(pids.EQ
+00008470: 2c20 7072 696d 732e 6571 290a 7265 6769  , prims.eq).regi
+00008480: 7374 6572 5f67 7261 6428 7069 6473 2e47  ster_grad(pids.G
+00008490: 452c 2070 7269 6d73 2e67 6529 0a72 6567  E, prims.ge).reg
+000084a0: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+000084b0: 4c54 2c20 7072 696d 732e 6c74 290a 7265  LT, prims.lt).re
+000084c0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+000084d0: 2e4e 452c 2070 7269 6d73 2e6e 6529 0a72  .NE, prims.ne).r
+000084e0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+000084f0: 732e 4754 2c20 7072 696d 732e 6774 290a  s.GT, prims.gt).
+00008500: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00008510: 6473 2e4c 452c 2070 7269 6d73 2e6c 6529  ds.LE, prims.le)
+00008520: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00008530: 205f 6d75 6c5f 7072 696d 5f67 7261 6428   _mul_prim_grad(
+00008540: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+00008550: 6f72 5072 6f78 792c 2062 3a20 4e75 6d62  orProxy, b: Numb
+00008560: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00008570: 2c20 2f29 202d 3e20 4e75 6d62 6572 207c  , /) -> Number |
+00008580: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00008590: 2020 6677 6420 3d20 6120 2a20 620a 0a20    fwd = a * b.. 
+000085a0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+000085b0: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
+000085c0: 3d20 6220 2a20 670a 2020 2020 625f 6772  = b * g.    b_gr
+000085d0: 6164 203d 2061 202a 2067 0a20 2020 2070  ad = a * g.    p
 000085e0: 7574 5f67 7261 6473 2828 612c 2062 292c  ut_grads((a, b),
 000085f0: 2028 615f 6772 6164 2c20 625f 6772 6164   (a_grad, b_grad
 00008600: 2929 0a0a 2020 2020 7265 7475 726e 2066  ))..    return f
 00008610: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
-00008620: 6164 2870 6964 732e 5355 422c 205f 7375  ad(pids.SUB, _su
-00008630: 625f 7072 696d 5f67 7261 6429 0a0a 0a23  b_prim_grad)...#
-00008640: 0a23 2043 6f6e 6469 7469 6f6e 616c 206f  .# Conditional o
-00008650: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
-00008660: 0a0a 6465 6620 5f77 6865 7265 5f70 7269  ..def _where_pri
-00008670: 6d5f 6772 6164 2870 7265 643a 204e 756d  m_grad(pred: Num
-00008680: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-00008690: 792c 2061 3a20 4e75 6d62 6572 207c 2054  y, a: Number | T
-000086a0: 656e 736f 7250 726f 7879 2c20 623a 204e  ensorProxy, b: N
-000086b0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-000086c0: 6f78 7929 202d 3e20 5465 6e73 6f72 5072  oxy) -> TensorPr
-000086d0: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-000086e0: 7269 6d73 2e77 6865 7265 2870 7265 642c  rims.where(pred,
-000086f0: 2061 2c20 6229 0a0a 2020 2020 6720 3d20   a, b)..    g = 
-00008700: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
-00008710: 2020 615f 6772 6164 203d 206c 746f 7263    a_grad = ltorc
-00008720: 682e 7768 6572 6528 7072 6564 2c20 672c  h.where(pred, g,
-00008730: 2030 290a 2020 2020 625f 6772 6164 203d   0).    b_grad =
-00008740: 206c 746f 7263 682e 7768 6572 6528 7072   ltorch.where(pr
-00008750: 6564 2c20 302c 2067 290a 2020 2020 7075  ed, 0, g).    pu
-00008760: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
-00008770: 2861 5f67 7261 642c 2062 5f67 7261 6429  (a_grad, b_grad)
-00008780: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00008790: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-000087a0: 6428 7069 6473 2e57 4845 5245 2c20 5f77  d(pids.WHERE, _w
-000087b0: 6865 7265 5f70 7269 6d5f 6772 6164 290a  here_prim_grad).
-000087c0: 0a23 0a23 2052 6564 7563 7469 6f6e 206f  .#.# Reduction o
-000087d0: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
-000087e0: 0a0a 2320 544f 444f 2052 6576 6965 7720  ..# TODO Review 
-000087f0: 7477 6561 6b69 6e67 2067 7261 645f 6368  tweaking grad_ch
-00008800: 6f6f 7365 725f 7075 6c6c 6261 636b 2069  ooser_pullback i
-00008810: 6e74 6572 6661 6365 0a64 6566 205f 616d  nterface.def _am
-00008820: 6178 5f70 7269 6d5f 6772 6164 2861 3a20  ax_prim_grad(a: 
-00008830: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
-00008840: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
-00008850: 6e74 5d29 202d 3e20 5465 6e73 6f72 5072  nt]) -> TensorPr
-00008860: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00008870: 7269 6d73 2e61 6d61 7828 612c 2064 696d  rims.amax(a, dim
-00008880: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
-00008890: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-000088a0: 6772 6164 203d 2067 7261 645f 6368 6f6f  grad = grad_choo
-000088b0: 7365 725f 6261 636b 7761 7264 2866 7764  ser_backward(fwd
-000088c0: 2c20 612c 2061 2e73 6861 7065 2c20 6469  , a, a.shape, di
-000088d0: 6d73 2c20 6729 0a20 2020 2070 7574 5f67  ms, g).    put_g
-000088e0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
-000088f0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00008900: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00008910: 6964 732e 414d 4158 2c20 5f61 6d61 785f  ids.AMAX, _amax_
-00008920: 7072 696d 5f67 7261 6429 0a0a 0a64 6566  prim_grad)...def
-00008930: 205f 7375 6d5f 7072 696d 5f67 7261 6428   _sum_prim_grad(
-00008940: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-00008950: 2f2c 2064 696d 733a 2053 6571 7565 6e63  /, dims: Sequenc
-00008960: 655b 696e 745d 2920 2d3e 2054 656e 736f  e[int]) -> Tenso
-00008970: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-00008980: 3d20 7072 696d 732e 7375 6d28 612c 2064  = prims.sum(a, d
+00008620: 6164 2870 6964 732e 4d55 4c2c 205f 6d75  ad(pids.MUL, _mu
+00008630: 6c5f 7072 696d 5f67 7261 6429 0a0a 0a40  l_prim_grad)...@
+00008640: 746f 7263 6863 7478 0a64 6566 205f 7375  torchctx.def _su
+00008650: 625f 7072 696d 5f67 7261 6428 613a 204e  b_prim_grad(a: N
+00008660: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00008670: 6f78 792c 2062 3a20 4e75 6d62 6572 207c  oxy, b: Number |
+00008680: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
+00008690: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+000086a0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+000086b0: 2061 202d 2062 0a0a 2020 2020 6720 3d20   a - b..    g = 
+000086c0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+000086d0: 2020 615f 6772 6164 203d 2067 0a20 2020    a_grad = g.   
+000086e0: 2062 5f67 7261 6420 3d20 2d67 0a20 2020   b_grad = -g.   
+000086f0: 2070 7574 5f67 7261 6473 2828 612c 2062   put_grads((a, b
+00008700: 292c 2028 615f 6772 6164 2c20 625f 6772  ), (a_grad, b_gr
+00008710: 6164 2929 0a0a 2020 2020 7265 7475 726e  ad))..    return
+00008720: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+00008730: 6772 6164 2870 6964 732e 5355 422c 205f  grad(pids.SUB, _
+00008740: 7375 625f 7072 696d 5f67 7261 6429 0a0a  sub_prim_grad)..
+00008750: 0a23 0a23 2043 6f6e 6469 7469 6f6e 616c  .#.# Conditional
+00008760: 206f 7065 7261 746f 7220 6772 6164 730a   operator grads.
+00008770: 230a 0a0a 6465 6620 5f77 6865 7265 5f70  #...def _where_p
+00008780: 7269 6d5f 6772 6164 2870 7265 643a 204e  rim_grad(pred: N
+00008790: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+000087a0: 6f78 792c 2061 3a20 4e75 6d62 6572 207c  oxy, a: Number |
+000087b0: 2054 656e 736f 7250 726f 7879 2c20 623a   TensorProxy, b:
+000087c0: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+000087d0: 5072 6f78 7929 202d 3e20 5465 6e73 6f72  Proxy) -> Tensor
+000087e0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+000087f0: 2070 7269 6d73 2e77 6865 7265 2870 7265   prims.where(pre
+00008800: 642c 2061 2c20 6229 0a0a 2020 2020 6720  d, a, b)..    g 
+00008810: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00008820: 2020 2020 615f 6772 6164 203d 206c 746f      a_grad = lto
+00008830: 7263 682e 7768 6572 6528 7072 6564 2c20  rch.where(pred, 
+00008840: 672c 2030 290a 2020 2020 625f 6772 6164  g, 0).    b_grad
+00008850: 203d 206c 746f 7263 682e 7768 6572 6528   = ltorch.where(
+00008860: 7072 6564 2c20 302c 2067 290a 2020 2020  pred, 0, g).    
+00008870: 7075 745f 6772 6164 7328 2861 2c20 6229  put_grads((a, b)
+00008880: 2c20 2861 5f67 7261 642c 2062 5f67 7261  , (a_grad, b_gra
+00008890: 6429 290a 0a20 2020 2072 6574 7572 6e20  d))..    return 
+000088a0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+000088b0: 7261 6428 7069 6473 2e57 4845 5245 2c20  rad(pids.WHERE, 
+000088c0: 5f77 6865 7265 5f70 7269 6d5f 6772 6164  _where_prim_grad
+000088d0: 290a 0a23 0a23 2052 6564 7563 7469 6f6e  )..#.# Reduction
+000088e0: 206f 7065 7261 746f 7220 6772 6164 730a   operator grads.
+000088f0: 230a 0a0a 2320 544f 444f 2052 6576 6965  #...# TODO Revie
+00008900: 7720 7477 6561 6b69 6e67 2067 7261 645f  w tweaking grad_
+00008910: 6368 6f6f 7365 725f 7075 6c6c 6261 636b  chooser_pullback
+00008920: 2069 6e74 6572 6661 6365 0a64 6566 205f   interface.def _
+00008930: 616d 6178 5f70 7269 6d5f 6772 6164 2861  amax_prim_grad(a
+00008940: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
+00008950: 2c20 6469 6d73 3a20 5365 7175 656e 6365  , dims: Sequence
+00008960: 5b69 6e74 5d29 202d 3e20 5465 6e73 6f72  [int]) -> Tensor
+00008970: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00008980: 2070 7269 6d73 2e61 6d61 7828 612c 2064   prims.amax(a, d
 00008990: 696d 7329 0a0a 2020 2020 6720 3d20 6765  ims)..    g = ge
 000089a0: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-000089b0: 615f 6772 6164 203d 2072 6573 746f 7265  a_grad = restore
-000089c0: 5f72 6564 7563 6564 5f64 696d 7328 672c  _reduced_dims(g,
-000089d0: 2064 696d 732c 2061 2e73 6861 7065 290a   dims, a.shape).
-000089e0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-000089f0: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00008a00: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00008a10: 6572 5f67 7261 6428 7069 6473 2e53 554d  er_grad(pids.SUM
-00008a20: 2c20 5f73 756d 5f70 7269 6d5f 6772 6164  , _sum_prim_grad
-00008a30: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-00008a40: 6620 5f74 6f70 6b5f 7072 696d 5f67 7261  f _topk_prim_gra
-00008a50: 6428 0a20 2020 2061 3a20 5465 6e73 6f72  d(.    a: Tensor
-00008a60: 5072 6f78 792c 202f 2c20 6b3a 2069 6e74  Proxy, /, k: int
-00008a70: 2c20 6469 6d3a 204e 6f6e 6520 7c20 696e  , dim: None | in
-00008a80: 7420 3d20 4e6f 6e65 2c20 6c61 7267 6573  t = None, larges
-00008a90: 743a 2062 6f6f 6c20 3d20 5472 7565 2c20  t: bool = True, 
-00008aa0: 736f 7274 6564 3a20 626f 6f6c 203d 2054  sorted: bool = T
-00008ab0: 7275 652c 202a 2c20 6f75 743d 4e6f 6e65  rue, *, out=None
-00008ac0: 0a29 3a0a 2020 2020 6677 6420 3d20 7072  .):.    fwd = pr
-00008ad0: 696d 732e 746f 706b 2861 2c20 6b2c 2064  ims.topk(a, k, d
-00008ae0: 696d 2c20 6c61 7267 6573 742c 2073 6f72  im, largest, sor
-00008af0: 7465 642c 206f 7574 3d6f 7574 290a 2020  ted, out=out).  
-00008b00: 2020 7661 6c2c 2069 6478 203d 2066 7764    val, idx = fwd
-00008b10: 0a0a 2020 2020 7661 6c5f 6772 6164 203d  ..    val_grad =
-00008b20: 2067 6574 5f67 7261 6428 7661 6c29 0a0a   get_grad(val)..
-00008b30: 2020 2020 615f 6772 6164 203d 206c 746f      a_grad = lto
-00008b40: 7263 682e 7a65 726f 735f 6c69 6b65 2861  rch.zeros_like(a
-00008b50: 290a 2020 2020 2320 544f 444f 3a20 7265  ).    # TODO: re
-00008b60: 706c 6163 6520 7769 7468 2073 6361 7474  place with scatt
-00008b70: 6572 206f 6e63 6520 7765 2068 6176 6520  er once we have 
-00008b80: 6974 2e0a 2020 2020 2320 7363 6174 7465  it..    # scatte
-00008b90: 725f 6164 6420 6973 2061 2070 7269 6d20  r_add is a prim 
-00008ba0: 616e 6420 6974 2072 656c 6965 7320 6f6e  and it relies on
-00008bb0: 2061 746f 6d69 6320 6f70 732e 0a20 2020   atomic ops..   
-00008bc0: 2061 5f67 7261 6420 3d20 6c74 6f72 6368   a_grad = ltorch
-00008bd0: 2e73 6361 7474 6572 5f61 6464 2861 5f67  .scatter_add(a_g
-00008be0: 7261 642c 2064 696d 2c20 6964 782c 2076  rad, dim, idx, v
-00008bf0: 616c 5f67 7261 6429 0a20 2020 2070 7574  al_grad).    put
-00008c00: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
-00008c10: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00008c20: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00008c30: 2870 6964 732e 544f 504b 2c20 5f74 6f70  (pids.TOPK, _top
-00008c40: 6b5f 7072 696d 5f67 7261 6429 0a0a 0a23  k_prim_grad)...#
-00008c50: 2054 4f44 4f20 4669 7820 6469 7669 7369   TODO Fix divisi
-00008c60: 6f6e 2062 7920 7a65 726f 2077 6865 6e20  on by zero when 
-00008c70: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
-00008c80: 3d20 3020 6f72 2077 6865 6e20 6d65 616e  = 0 or when mean
-00008c90: 2e6e 756d 656c 203d 3d20 300a 2320 2020  .numel == 0.#   
-00008ca0: 6279 2072 6574 7572 6e69 6e67 207a 6572  by returning zer
-00008cb0: 6f73 5f6c 696b 6528 6129 206f 7220 7369  os_like(a) or si
-00008cc0: 6d69 6c61 722e 0a23 2054 4f44 4f20 4669  milar..# TODO Fi
-00008cd0: 7820 6772 6164 2077 6865 6e20 636f 7272  x grad when corr
-00008ce0: 6563 7469 6f6e 203e 206e 5f65 6c65 6d5f  ection > n_elem_
-00008cf0: 7265 6475 6365 642e 0a40 746f 7263 6863  reduced..@torchc
-00008d00: 7478 0a64 6566 205f 7661 725f 6d65 616e  tx.def _var_mean
-00008d10: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
-00008d20: 6e73 6f72 5072 6f78 792c 202f 2c20 6469  nsorProxy, /, di
-00008d30: 6d73 3a20 5365 7175 656e 6365 5b69 6e74  ms: Sequence[int
-00008d40: 5d2c 202a 2c20 636f 7272 6563 7469 6f6e  ], *, correction
-00008d50: 3a20 4e75 6d62 6572 2920 2d3e 2054 656e  : Number) -> Ten
-00008d60: 736f 7250 726f 7879 3a0a 2020 2020 762c  sorProxy:.    v,
-00008d70: 206d 203d 2070 7269 6d73 2e76 6172 5f6d   m = prims.var_m
-00008d80: 6561 6e28 612c 2064 696d 732c 2063 6f72  ean(a, dims, cor
-00008d90: 7265 6374 696f 6e3d 636f 7272 6563 7469  rection=correcti
-00008da0: 6f6e 290a 0a20 2020 2067 7620 3d20 6765  on)..    gv = ge
-00008db0: 745f 6772 6164 2876 290a 2020 2020 676d  t_grad(v).    gm
-00008dc0: 203d 2067 6574 5f67 7261 6428 6d29 0a0a   = get_grad(m)..
-00008dd0: 2020 2020 6e5f 656c 656d 5f72 6564 7563      n_elem_reduc
-00008de0: 6564 203d 2061 2e6e 756d 656c 2829 202f  ed = a.numel() /
-00008df0: 2f20 6d2e 6e75 6d65 6c28 2920 6966 2061  / m.numel() if a
-00008e00: 2e6e 756d 656c 2829 2021 3d20 3020 656c  .numel() != 0 el
-00008e10: 7365 2031 0a0a 2020 2020 2320 436f 6d70  se 1..    # Comp
-00008e20: 7574 6573 206d 6561 6e20 6277 640a 2020  utes mean bwd.  
-00008e30: 2020 6d65 616e 5f73 6361 6c65 203d 2031    mean_scale = 1
-00008e40: 2e30 202f 206e 5f65 6c65 6d5f 7265 6475  .0 / n_elem_redu
-00008e50: 6365 640a 2020 2020 6d65 616e 5f67 7261  ced.    mean_gra
-00008e60: 6420 3d20 6d65 616e 5f73 6361 6c65 202a  d = mean_scale *
-00008e70: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-00008e80: 5f64 696d 7328 676d 2c20 6469 6d73 2c20  _dims(gm, dims, 
-00008e90: 612e 7368 6170 6529 0a0a 2020 2020 2320  a.shape)..    # 
-00008ea0: 436f 6d70 7574 6573 2076 6172 2062 7764  Computes var bwd
-00008eb0: 0a20 2020 206e 6f72 6d61 6c69 7a61 7469  .    normalizati
-00008ec0: 6f6e 5f73 6361 6c61 7220 3d20 6e5f 656c  on_scalar = n_el
-00008ed0: 656d 5f72 6564 7563 6564 202d 2063 6f72  em_reduced - cor
-00008ee0: 7265 6374 696f 6e0a 2020 2020 7265 7374  rection.    rest
-00008ef0: 6f72 6564 5f67 7620 3d20 7265 7374 6f72  ored_gv = restor
-00008f00: 655f 7265 6475 6365 645f 6469 6d73 2867  e_reduced_dims(g
-00008f10: 762c 2064 696d 732c 2061 2e73 6861 7065  v, dims, a.shape
-00008f20: 290a 2020 2020 2320 496e 7365 7274 696e  ).    # Insertin
-00008f30: 6720 6120 636f 6e76 6572 7369 6f6e 2074  g a conversion t
-00008f40: 6f20 7468 6520 7361 6d65 2064 7479 7065  o the same dtype
-00008f50: 2074 6f20 6469 7361 626c 6520 6e76 4675   to disable nvFu
-00008f60: 7365 7220 6578 6563 7574 6f72 7327 730a  ser executors's.
-00008f70: 2020 2020 2320 626f 6f6b 656e 6420 6f70      # bookend op
-00008f80: 7469 6d69 7a61 7469 6f6e 2028 6e76 5f65  timization (nv_e
-00008f90: 6e61 626c 655f 626f 6f6b 656e 6429 2c20  nable_bookend), 
-00008fa0: 7768 6963 6820 6361 6e20 6361 7573 6520  which can cause 
-00008fb0: 7468 6520 6261 636b 7761 7264 0a20 2020  the backward.   
-00008fc0: 2023 2070 6173 7320 746f 2067 656e 6572   # pass to gener
-00008fd0: 6174 6520 7477 6f20 6b65 726e 656c 730a  ate two kernels.
-00008fe0: 2020 2020 6d65 616e 5f6d 6474 7970 6520      mean_mdtype 
-00008ff0: 3d20 7072 696d 732e 636f 6e76 6572 745f  = prims.convert_
-00009000: 656c 656d 656e 745f 7479 7065 286d 2c20  element_type(m, 
-00009010: 6d2e 6474 7970 6529 0a20 2020 2072 6573  m.dtype).    res
-00009020: 746f 7265 645f 6d65 616e 203d 2072 6573  tored_mean = res
-00009030: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
-00009040: 7328 6d65 616e 5f6d 6474 7970 652c 2064  s(mean_mdtype, d
-00009050: 696d 732c 2061 2e73 6861 7065 290a 2020  ims, a.shape).  
-00009060: 2020 7661 725f 6772 6164 203d 2028 3220    var_grad = (2 
-00009070: 2a20 7265 7374 6f72 6564 5f67 7620 2a20  * restored_gv * 
-00009080: 2861 202d 2072 6573 746f 7265 645f 6d65  (a - restored_me
-00009090: 616e 2929 202f 206e 6f72 6d61 6c69 7a61  an)) / normaliza
-000090a0: 7469 6f6e 5f73 6361 6c61 720a 0a20 2020  tion_scalar..   
-000090b0: 2070 7574 5f67 7261 6428 612c 206d 6561   put_grad(a, mea
-000090c0: 6e5f 6772 6164 202b 2076 6172 5f67 7261  n_grad + var_gra
-000090d0: 6429 0a0a 2020 2020 7265 7475 726e 2076  d)..    return v
-000090e0: 2c20 6d0a 0a0a 7265 6769 7374 6572 5f67  , m...register_g
-000090f0: 7261 6428 7069 6473 2e56 4152 5f4d 4541  rad(pids.VAR_MEA
-00009100: 4e2c 205f 7661 725f 6d65 616e 5f70 7269  N, _var_mean_pri
-00009110: 6d5f 6772 6164 290a 0a0a 230a 2320 4c69  m_grad)...#.# Li
-00009120: 6e65 6172 2061 6c67 6562 7261 206f 7065  near algebra ope
-00009130: 7261 746f 7220 6772 6164 730a 230a 4074  rator grads.#.@t
-00009140: 6f72 6368 6374 780a 6465 6620 5f6c 696e  orchctx.def _lin
-00009150: 6561 725f 7072 696d 5f67 7261 6428 613a  ear_prim_grad(a:
-00009160: 2054 656e 736f 7250 726f 7879 2c20 773a   TensorProxy, w:
-00009170: 2054 656e 736f 7250 726f 7879 2c20 6269   TensorProxy, bi
-00009180: 6173 3a20 4e6f 6e65 207c 2054 656e 736f  as: None | Tenso
-00009190: 7250 726f 7879 2920 2d3e 2054 656e 736f  rProxy) -> Tenso
-000091a0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
-000091b0: 3d20 7072 696d 732e 6c69 6e65 6172 2861  = prims.linear(a
-000091c0: 2c20 772c 2062 6961 7329 0a0a 2020 2020  , w, bias)..    
-000091d0: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-000091e0: 290a 0a20 2020 2066 6972 7374 5f64 696d  )..    first_dim
-000091f0: 203d 202d 320a 2020 2020 6772 6164 5f61   = -2.    grad_a
-00009200: 203d 206c 746f 7263 682e 6d61 746d 756c   = ltorch.matmul
-00009210: 2867 2e72 6573 6861 7065 282d 312c 2067  (g.reshape(-1, g
-00009220: 2e73 6861 7065 5b2d 315d 292c 2077 292e  .shape[-1]), w).
-00009230: 7265 7368 6170 6528 612e 7368 6170 6529  reshape(a.shape)
-00009240: 0a0a 2020 2020 6772 6164 5f77 3a20 5465  ..    grad_w: Te
-00009250: 6e73 6f72 5072 6f78 790a 2020 2020 6966  nsorProxy.    if
-00009260: 2061 2e6e 6469 6d20 3d3d 2031 3a0a 2020   a.ndim == 1:.  
-00009270: 2020 2020 2020 6772 6164 5f77 203d 206c        grad_w = l
-00009280: 746f 7263 682e 6d61 746d 756c 2867 2e75  torch.matmul(g.u
-00009290: 6e73 7175 6565 7a65 2866 6972 7374 5f64  nsqueeze(first_d
-000092a0: 696d 292e 6d54 2c20 612e 756e 7371 7565  im).mT, a.unsque
-000092b0: 657a 6528 6669 7273 745f 6469 6d29 290a  eze(first_dim)).
-000092c0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000092d0: 2020 6772 6164 5f77 203d 206c 746f 7263    grad_w = ltorc
-000092e0: 682e 6d61 746d 756c 2867 2e72 6573 6861  h.matmul(g.resha
-000092f0: 7065 282d 312c 2067 2e73 6861 7065 5b2d  pe(-1, g.shape[-
-00009300: 315d 292e 6d54 2c20 612e 7265 7368 6170  1]).mT, a.reshap
-00009310: 6528 2d31 2c20 612e 7368 6170 655b 2d31  e(-1, a.shape[-1
-00009320: 5d29 290a 0a20 2020 2070 7574 5f67 7261  ]))..    put_gra
-00009330: 6473 2828 612c 2077 292c 2028 6772 6164  ds((a, w), (grad
-00009340: 5f61 2c20 6772 6164 5f77 2929 0a0a 2020  _a, grad_w))..  
-00009350: 2020 6966 2062 6961 7320 6973 206e 6f74    if bias is not
-00009360: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
-00009370: 6620 672e 6e64 696d 203e 2031 3a0a 2020  f g.ndim > 1:.  
-00009380: 2020 2020 2020 2020 2020 6772 6164 5f62            grad_b
-00009390: 6961 7320 3d20 6c74 6f72 6368 2e73 756d  ias = ltorch.sum
-000093a0: 2867 2c20 7475 706c 6528 7261 6e67 6528  (g, tuple(range(
-000093b0: 672e 6e64 696d 202d 2031 2929 290a 2020  g.ndim - 1))).  
-000093c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000093d0: 2020 2020 2020 2020 6772 6164 5f62 6961          grad_bia
-000093e0: 7320 3d20 670a 2020 2020 2020 2020 7075  s = g.        pu
-000093f0: 745f 6772 6164 2862 6961 732c 2067 7261  t_grad(bias, gra
-00009400: 645f 6269 6173 290a 0a20 2020 2072 6574  d_bias)..    ret
-00009410: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00009420: 6572 5f67 7261 6428 7069 6473 2e4c 494e  er_grad(pids.LIN
-00009430: 4541 522c 205f 6c69 6e65 6172 5f70 7269  EAR, _linear_pri
-00009440: 6d5f 6772 6164 290a 0a0a 2320 544f 444f  m_grad)...# TODO
-00009450: 2041 6464 2065 7870 6c69 6369 7420 6c74   Add explicit lt
-00009460: 6f72 6368 2076 7320 636c 616e 6720 6d6f  orch vs clang mo
-00009470: 6475 6c65 2074 6f20 7468 6520 7465 6e73  dule to the tens
-00009480: 6f72 206f 7065 7261 7469 6f6e 7320 6265  or operations be
-00009490: 6c6f 770a 2320 544f 444f 2063 6f75 6c64  low.# TODO could
-000094a0: 2077 6520 6765 7420 7269 6420 6f66 2074   we get rid of t
-000094b0: 6865 2066 696e 616c 2073 7175 6565 7a65  he final squeeze
-000094c0: 7320 696e 2074 6865 2062 2e6e 6469 6d20  s in the b.ndim 
-000094d0: 3d3d 2031 2063 6173 6520 616e 6420 7468  == 1 case and th
-000094e0: 6520 612e 6e64 696d 203d 3d20 3120 6361  e a.ndim == 1 ca
-000094f0: 7365 3f0a 4074 6f72 6368 6374 780a 6465  se?.@torchctx.de
-00009500: 6620 5f6d 6174 6d75 6c5f 7072 696d 5f67  f _matmul_prim_g
-00009510: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
-00009520: 7879 2c20 623a 2054 656e 736f 7250 726f  xy, b: TensorPro
-00009530: 7879 2c20 2f29 202d 3e20 5465 6e73 6f72  xy, /) -> Tensor
-00009540: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00009550: 2070 7269 6d73 2e6d 6174 6d75 6c28 612c   prims.matmul(a,
-00009560: 2062 290a 2020 2020 6720 3d20 6765 745f   b).    g = get_
-00009570: 6772 6164 2866 7764 290a 0a20 2020 206c  grad(fwd)..    l
-00009580: 6173 745f 6469 6d20 3d20 282d 312c 290a  ast_dim = (-1,).
-00009590: 2020 2020 6669 7273 745f 6469 6d20 3d20      first_dim = 
-000095a0: 282d 322c 290a 2020 2020 6966 2061 2e6e  (-2,).    if a.n
-000095b0: 6469 6d20 3d3d 2031 2061 6e64 2062 2e6e  dim == 1 and b.n
-000095c0: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
-000095d0: 2020 7075 745f 6772 6164 7328 2861 2c20    put_grads((a, 
-000095e0: 6229 2c20 2867 202a 2062 2c20 6720 2a20  b), (g * b, g * 
-000095f0: 6129 290a 2020 2020 656c 6966 2062 2e6e  a)).    elif b.n
-00009600: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
-00009610: 2020 6761 203d 2075 6e73 7175 6565 7a65    ga = unsqueeze
-00009620: 2867 2c20 6c61 7374 5f64 696d 2920 4020  (g, last_dim) @ 
-00009630: 756e 7371 7565 657a 6528 622c 206c 6173  unsqueeze(b, las
-00009640: 745f 6469 6d29 2e6d 540a 2020 2020 2020  t_dim).mT.      
-00009650: 2020 6762 203d 2061 2e6d 5420 4020 756e    gb = a.mT @ un
-00009660: 7371 7565 657a 6528 672c 206c 6173 745f  squeeze(g, last_
-00009670: 6469 6d29 0a20 2020 2020 2020 2069 6620  dim).        if 
-00009680: 672e 6e64 696d 203e 2031 3a0a 2020 2020  g.ndim > 1:.    
-00009690: 2020 2020 2020 2020 6762 203d 2073 7175          gb = squ
-000096a0: 6565 7a65 2867 622c 206c 6173 745f 6469  eeze(gb, last_di
-000096b0: 6d29 0a20 2020 2020 2020 2020 2020 2067  m).            g
-000096c0: 6220 3d20 6c74 6f72 6368 2e73 756d 2867  b = ltorch.sum(g
-000096d0: 622c 2074 7570 6c65 2872 616e 6765 2867  b, tuple(range(g
-000096e0: 622e 6e64 696d 202d 2031 2929 290a 2020  b.ndim - 1))).  
-000096f0: 2020 2020 2020 7075 745f 6772 6164 7328        put_grads(
-00009700: 2861 2c20 6229 2c20 2867 612c 2067 622e  (a, b), (ga, gb.
-00009710: 7371 7565 657a 6528 2929 290a 2020 2020  squeeze())).    
-00009720: 656c 6966 2061 2e6e 6469 6d20 3d3d 2031  elif a.ndim == 1
-00009730: 3a0a 2020 2020 2020 2020 6761 203d 2075  :.        ga = u
-00009740: 6e73 7175 6565 7a65 2867 2c20 6669 7273  nsqueeze(g, firs
-00009750: 745f 6469 6d29 2040 2062 2e6d 540a 2020  t_dim) @ b.mT.  
-00009760: 2020 2020 2020 6966 2067 2e6e 6469 6d20        if g.ndim 
-00009770: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00009780: 2067 6120 3d20 6c74 6f72 6368 2e73 756d   ga = ltorch.sum
-00009790: 2867 612c 2074 7570 6c65 2872 616e 6765  (ga, tuple(range
-000097a0: 2867 612e 6e64 696d 202d 2031 2929 290a  (ga.ndim - 1))).
-000097b0: 2020 2020 2020 2020 6762 203d 2075 6e73          gb = uns
-000097c0: 7175 6565 7a65 2861 2c20 6669 7273 745f  queeze(a, first_
-000097d0: 6469 6d29 2e6d 5420 4020 756e 7371 7565  dim).mT @ unsque
-000097e0: 657a 6528 672c 2066 6972 7374 5f64 696d  eze(g, first_dim
-000097f0: 290a 2020 2020 2020 2020 7075 745f 6772  ).        put_gr
-00009800: 6164 7328 2861 2c20 6229 2c20 2867 612e  ads((a, b), (ga.
-00009810: 7371 7565 657a 6528 292c 2067 6229 290a  squeeze(), gb)).
-00009820: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009830: 2020 7075 745f 6772 6164 7328 2861 2c20    put_grads((a, 
-00009840: 6229 2c20 2867 2040 2062 2e6d 542c 2061  b), (g @ b.mT, a
-00009850: 2e6d 5420 4020 6729 290a 0a20 2020 2072  .mT @ g))..    r
-00009860: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00009870: 7374 6572 5f67 7261 6428 7069 6473 2e4d  ster_grad(pids.M
-00009880: 4154 4d55 4c2c 205f 6d61 746d 756c 5f70  ATMUL, _matmul_p
-00009890: 7269 6d5f 6772 6164 290a 0a23 0a23 204e  rim_grad)..#.# N
-000098a0: 4e20 6f70 6572 6174 6f72 2067 7261 6473  N operator grads
-000098b0: 0a23 0a0a 0a40 746f 7263 6863 7478 0a64  .#...@torchctx.d
-000098c0: 6566 205f 656d 6265 6464 696e 675f 7072  ef _embedding_pr
-000098d0: 696d 5f67 7261 6428 0a20 2020 2061 3a20  im_grad(.    a: 
-000098e0: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
-000098f0: 7765 6967 6874 2c20 2a2c 2070 6164 6469  weight, *, paddi
-00009900: 6e67 5f69 6478 3d2d 312c 206d 6178 5f6e  ng_idx=-1, max_n
-00009910: 6f72 6d3d 4e6f 6e65 2c20 6e6f 726d 5f74  orm=None, norm_t
-00009920: 7970 653d 322e 302c 2073 6361 6c65 5f67  ype=2.0, scale_g
-00009930: 7261 645f 6279 5f66 7265 713d 4661 6c73  rad_by_freq=Fals
-00009940: 652c 2073 7061 7273 653d 4661 6c73 650a  e, sparse=False.
-00009950: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00009960: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00009970: 732e 656d 6265 6464 696e 6728 0a20 2020  s.embedding(.   
-00009980: 2020 2020 2061 2c0a 2020 2020 2020 2020       a,.        
-00009990: 7765 6967 6874 2c0a 2020 2020 2020 2020  weight,.        
-000099a0: 7061 6464 696e 675f 6964 783d 7061 6464  padding_idx=padd
-000099b0: 696e 675f 6964 782c 0a20 2020 2020 2020  ing_idx,.       
-000099c0: 206d 6178 5f6e 6f72 6d3d 6d61 785f 6e6f   max_norm=max_no
-000099d0: 726d 2c0a 2020 2020 2020 2020 6e6f 726d  rm,.        norm
-000099e0: 5f74 7970 653d 6e6f 726d 5f74 7970 652c  _type=norm_type,
-000099f0: 0a20 2020 2020 2020 2073 6361 6c65 5f67  .        scale_g
-00009a00: 7261 645f 6279 5f66 7265 713d 7363 616c  rad_by_freq=scal
-00009a10: 655f 6772 6164 5f62 795f 6672 6571 2c0a  e_grad_by_freq,.
-00009a20: 2020 2020 2020 2020 7370 6172 7365 3d73          sparse=s
-00009a30: 7061 7273 652c 0a20 2020 2029 0a0a 2020  parse,.    )..  
-00009a40: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00009a50: 7764 290a 2020 2020 615f 6772 6164 203d  wd).    a_grad =
-00009a60: 2070 7269 6d73 2e65 6d62 6564 6469 6e67   prims.embedding
-00009a70: 5f62 6163 6b77 6172 6428 672c 2061 2c20  _backward(g, a, 
-00009a80: 7765 6967 6874 2e73 6861 7065 5b30 5d2c  weight.shape[0],
-00009a90: 2070 6164 6469 6e67 5f69 6478 2c20 7363   padding_idx, sc
-00009aa0: 616c 655f 6772 6164 5f62 795f 6672 6571  ale_grad_by_freq
-00009ab0: 2c20 7370 6172 7365 290a 2020 2020 7075  , sparse).    pu
-00009ac0: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
-00009ad0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00009ae0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00009af0: 6428 7069 6473 2e45 4d42 4544 4449 4e47  d(pids.EMBEDDING
-00009b00: 2c20 5f65 6d62 6564 6469 6e67 5f70 7269  , _embedding_pri
-00009b10: 6d5f 6772 6164 290a 0a23 0a23 2050 6861  m_grad)..#.# Pha
-00009b20: 6e74 6f6d 2067 7261 6420 7472 616e 7366  ntom grad transf
-00009b30: 6f72 6d20 6865 6c70 6572 730a 230a 0a0a  orm helpers.#...
-00009b40: 6465 6620 5f67 6574 5f67 7261 6466 6e5f  def _get_gradfn_
-00009b50: 616e 645f 6578 6563 7574 6f72 280a 2020  and_executor(.  
-00009b60: 2020 6273 796d 3a20 426f 756e 6453 796d    bsym: BoundSym
-00009b70: 626f 6c2c 202a 2c20 6578 6563 7574 6f72  bol, *, executor
-00009b80: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
-00009b90: 5b41 6e79 5d20 3d20 7475 706c 6528 290a  [Any] = tuple().
-00009ba0: 2920 2d3e 2074 7570 6c65 5b43 616c 6c61  ) -> tuple[Calla
-00009bb0: 626c 6520 7c20 4e6f 6e65 2c20 4578 6563  ble | None, Exec
-00009bc0: 7574 6f72 207c 204e 6f6e 655d 3a0a 2020  utor | None]:.  
-00009bd0: 2020 6364 203d 2067 6574 5f63 6f6d 7069    cd = get_compi
-00009be0: 6c65 5f64 6174 6128 290a 2020 2020 6578  le_data().    ex
-00009bf0: 6563 7574 6f72 735f 6c69 7374 203d 2063  ecutors_list = c
-00009c00: 642e 6578 6563 7574 6f72 735f 6c69 7374  d.executors_list
-00009c10: 2069 6620 6364 2069 7320 6e6f 7420 4e6f   if cd is not No
-00009c20: 6e65 2065 6c73 6520 6578 6563 7574 6f72  ne else executor
-00009c30: 735f 6c69 7374 0a20 2020 2023 2043 6865  s_list.    # Che
-00009c40: 636b 7320 6966 2074 6865 2065 7865 6375  cks if the execu
-00009c50: 746f 7220 7768 6963 6820 6861 7320 7072  tor which has pr
-00009c60: 696f 7269 7479 2066 6f72 2074 6869 7320  iority for this 
-00009c70: 6f70 6572 6174 696f 6e20 6861 7320 6120  operation has a 
-00009c80: 7370 6563 6966 6963 2067 7261 6420 7472  specific grad tr
-00009c90: 616e 7366 6f72 6d20 666f 7220 6974 0a20  ansform for it. 
-00009ca0: 2020 2066 6f72 2065 7820 696e 2065 7865     for ex in exe
-00009cb0: 6375 746f 7273 5f6c 6973 743a 0a20 2020  cutors_list:.   
-00009cc0: 2020 2020 2069 6620 6578 2e63 616e 5f65       if ex.can_e
-00009cd0: 7865 6375 7465 5f6f 725f 6675 7365 2862  xecute_or_fuse(b
-00009ce0: 7379 6d29 3a0a 2020 2020 2020 2020 2020  sym):.          
-00009cf0: 2020 6578 5f67 7261 645f 7472 616e 7366    ex_grad_transf
-00009d00: 6f72 6d3a 204e 6f6e 6520 7c20 4361 6c6c  orm: None | Call
-00009d10: 6162 6c65 203d 2065 782e 6765 745f 6772  able = ex.get_gr
-00009d20: 6164 5f74 7261 6e73 666f 726d 2862 7379  ad_transform(bsy
-00009d30: 6d2e 7379 6d29 0a20 2020 2020 2020 2020  m.sym).         
-00009d40: 2020 2069 6620 6578 5f67 7261 645f 7472     if ex_grad_tr
-00009d50: 616e 7366 6f72 6d20 6973 206e 6f74 204e  ansform is not N
-00009d60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00009d70: 2020 2020 2072 6574 7572 6e20 6578 5f67       return ex_g
-00009d80: 7261 645f 7472 616e 7366 6f72 6d2c 2065  rad_transform, e
-00009d90: 780a 2020 2020 2020 2020 2020 2020 6272  x.            br
-00009da0: 6561 6b0a 0a20 2020 2023 2049 6620 7468  eak..    # If th
-00009db0: 6520 6578 6563 7574 6f72 2064 6f65 736e  e executor doesn
-00009dc0: 2774 2064 6566 696e 6520 6974 7320 6f77  't define its ow
-00009dd0: 6e20 6772 6164 2074 7261 6e73 666f 726d  n grad transform
-00009de0: 2c20 7468 6973 206a 7573 7420 7265 7475  , this just retu
-00009df0: 726e 7320 7468 6520 6465 6661 756c 7420  rns the default 
-00009e00: 6772 6164 2074 7261 6e73 666f 726d 2066  grad transform f
-00009e10: 6f72 2074 6865 2062 7379 6d0a 2020 2020  or the bsym.    
-00009e20: 6772 6164 666e 203d 205f 6772 6164 5f66  gradfn = _grad_f
-00009e30: 6e5f 6d61 702e 6765 7428 6273 796d 2e73  n_map.get(bsym.s
-00009e40: 796d 2e69 642c 204e 6f6e 6529 0a20 2020  ym.id, None).   
-00009e50: 2072 6574 7572 6e20 6772 6164 666e 2c20   return gradfn, 
-00009e60: 4e6f 6e65 0a0a 0a23 2054 6865 2064 6566  None...# The def
-00009e70: 6175 6c74 2067 7261 6420 7370 6563 6966  ault grad specif
-00009e80: 6965 7220 666f 7220 7468 6520 6772 6164  ier for the grad
-00009e90: 2074 7261 6e73 666f 726d 0a23 2020 2046   transform.#   F
-00009ea0: 6f72 2065 6163 6820 7465 6e73 6f72 206f  or each tensor o
-00009eb0: 7574 7075 7420 226f 2220 7265 7175 6972  utput "o" requir
-00009ec0: 696e 6720 6772 6164 2c20 7370 6563 6966  ing grad, specif
-00009ed0: 6965 7320 6120 6772 6164 206f 6620 6f6e  ies a grad of on
-00009ee0: 6573 5f6c 696b 6528 6f29 0a64 6566 205f  es_like(o).def _
-00009ef0: 6772 6164 5f73 7065 6369 6669 6572 5f64  grad_specifier_d
-00009f00: 6566 6175 6c74 2870 7974 7265 653a 2041  efault(pytree: A
-00009f10: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-00009f20: 2066 6c61 7473 2c20 5f20 3d20 7472 6565   flats, _ = tree
-00009f30: 5f66 6c61 7474 656e 2870 7974 7265 6529  _flatten(pytree)
-00009f40: 0a0a 2020 2020 666f 7220 6620 696e 2066  ..    for f in f
-00009f50: 6c61 7473 3a0a 2020 2020 2020 2020 6966  lats:.        if
-00009f60: 2069 7369 6e73 7461 6e63 6528 662c 2054   isinstance(f, T
-00009f70: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
-00009f80: 662e 7265 7175 6972 6573 5f67 7261 643a  f.requires_grad:
-00009f90: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00009fa0: 4f54 4520 5468 6973 2075 7365 7320 636c  OTE This uses cl
-00009fb0: 616e 672e 6f6e 6573 5f6c 696b 6520 666f  ang.ones_like fo
-00009fc0: 7220 6e6f 7720 6265 6361 7573 6520 6c74  r now because lt
-00009fd0: 6f72 6368 2e6f 6e65 735f 6c69 6b65 2077  orch.ones_like w
-00009fe0: 696c 6c20 6578 7465 6e64 2074 6865 0a20  ill extend the. 
-00009ff0: 2020 2020 2020 2020 2020 2023 2020 206c             #   l
-0000a000: 6966 6574 696d 6520 6f66 2066 2c20 7768  ifetime of f, wh
-0000a010: 696c 6520 636c 616e 672e 6f6e 6573 5f6c  ile clang.ones_l
-0000a020: 696b 6520 7769 6c6c 2065 7874 7261 6374  ike will extract
-0000a030: 2074 6865 206d 6574 6164 6174 6120 6f66   the metadata of
-0000a040: 2066 2061 7420 7472 6163 6520 7469 6d65   f at trace time
-0000a050: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0000a060: 6d73 2e70 7574 5f67 7261 6428 662c 2063  ms.put_grad(f, c
-0000a070: 6c61 6e67 2e66 756c 6c5f 6c69 6b65 2866  lang.full_like(f
-0000a080: 2c20 312e 3029 290a 0a0a 2320 544f 444f  , 1.0))...# TODO
-0000a090: 2054 6573 7420 7769 7468 2062 7566 6665   Test with buffe
-0000a0a0: 7273 0a64 6566 205f 6772 6164 5f6f 7574  rs.def _grad_out
-0000a0b0: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
-0000a0c0: 6c74 2870 7974 7265 653a 2041 6e79 2920  lt(pytree: Any) 
-0000a0d0: 2d3e 206c 6973 745b 5465 6e73 6f72 5072  -> list[TensorPr
-0000a0e0: 6f78 795d 3a0a 2020 2020 666c 6174 732c  oxy]:.    flats,
-0000a0f0: 205f 203d 2074 7265 655f 666c 6174 7465   _ = tree_flatte
-0000a100: 6e28 7079 7472 6565 290a 2020 2020 6772  n(pytree).    gr
-0000a110: 6164 7320 3d20 6c69 7374 285b 7072 696d  ads = list([prim
-0000a120: 732e 6765 745f 6772 6164 2866 2920 666f  s.get_grad(f) fo
-0000a130: 7220 6620 696e 2066 6c61 7473 2069 6620  r f in flats if 
-0000a140: 6973 696e 7374 616e 6365 2866 2c20 5465  isinstance(f, Te
-0000a150: 6e73 6f72 5072 6f78 7929 2061 6e64 2066  nsorProxy) and f
-0000a160: 2e72 6571 7569 7265 735f 6772 6164 5d29  .requires_grad])
-0000a170: 0a20 2020 2072 6574 7572 6e20 6772 6164  .    return grad
-0000a180: 730a 0a0a 2320 544f 444f 2046 6f72 6d61  s...# TODO Forma
-0000a190: 6c6c 7920 6465 6669 6e65 2074 6865 2022  lly define the "
-0000a1a0: 6772 6164 6965 6e74 2220 6f66 2061 2074  gradient" of a t
-0000a1b0: 656e 736f 720a 2320 544f 444f 2049 6620  ensor.# TODO If 
-0000a1c0: 6e6f 6e65 206f 6620 7468 6520 696e 7075  none of the inpu
-0000a1d0: 7473 2074 6f20 616e 206f 7065 7261 7469  ts to an operati
-0000a1e0: 6f6e 2072 6571 7569 7265 2067 7261 642c  on require grad,
-0000a1f0: 2074 6865 6e20 7765 2063 6f75 6c64 206c   then we could l
-0000a200: 6561 7665 2074 6861 7420 6f70 6572 6174  eave that operat
-0000a210: 696f 6e20 616c 6f6e 650a 2320 2020 5468  ion alone.#   Th
-0000a220: 6973 2063 6f75 6c64 2061 6374 7561 6c6c  is could actuall
-0000a230: 7920 696d 7072 6f76 6520 7065 7266 6f72  y improve perfor
-0000a240: 6d61 6e63 6520 6966 2074 6865 206f 7065  mance if the ope
-0000a250: 7261 7469 6f6e 2070 6572 666f 726d 7320  ration performs 
-0000a260: 6578 7472 6120 636f 6d70 7574 6174 696f  extra computatio
-0000a270: 6e73 2069 6e20 6974 7320 6772 6164 2074  ns in its grad t
-0000a280: 7261 6e73 666f 726d 0a23 2020 2041 2077  ransform.#   A w
-0000a290: 6f72 6b61 726f 756e 6420 666f 7220 7468  orkaround for th
-0000a2a0: 6973 2077 6f75 6c64 2062 6520 666f 7220  is would be for 
-0000a2b0: 7468 6520 6f70 6572 6174 696f 6e20 6974  the operation it
-0000a2c0: 7365 6c66 2074 6f20 6368 6563 6b20 6966  self to check if
-0000a2d0: 2069 7473 2069 6e70 7574 2072 6571 7569   its input requi
-0000a2e0: 7265 7320 6772 6164 206f 7220 6e6f 740a  res grad or not.
-0000a2f0: 2320 5472 616e 7366 6f72 6d73 2061 2066  # Transforms a f
-0000a300: 756e 6374 696f 6e20 746f 2063 6f6d 7075  unction to compu
-0000a310: 7465 2074 6865 2022 6772 6164 6965 6e74  te the "gradient
-0000a320: 2220 6f66 2069 7473 2069 6e70 7574 7320  " of its inputs 
-0000a330: 7265 7175 6972 696e 6720 6772 6164 2c20  requiring grad, 
-0000a340: 706f 7373 6962 6c79 0a23 2020 206d 6f64  possibly.#   mod
-0000a350: 6966 6965 6420 6279 2074 6865 2067 7261  ified by the gra
-0000a360: 6420 7370 6563 6966 6965 7273 2028 7365  d specifiers (se
-0000a370: 6520 6265 6c6f 7729 2e0a 2320 5468 6520  e below)..# The 
-0000a380: 6f70 7469 6f6e 616c 2067 7261 645f 7370  optional grad_sp
-0000a390: 6563 6966 6965 7220 6172 6775 6d65 6e74  ecifier argument
-0000a3a0: 2061 6363 6570 7473 2074 6865 2066 756e   accepts the fun
-0000a3b0: 6374 696f 6e27 7320 6f75 7470 7574 2c20  ction's output, 
-0000a3c0: 7275 6e73 2069 6e20 6120 6e6f 2d67 7261  runs in a no-gra
-0000a3d0: 6420 636f 6e74 6578 742c 0a23 2020 2061  d context,.#   a
-0000a3e0: 6e64 2063 616e 2070 7574 2067 7261 6473  nd can put grads
-0000a3f0: 2028 7573 696e 6720 7072 696d 732e 7075   (using prims.pu
-0000a400: 745f 6772 6164 2829 2920 666f 7220 7465  t_grad()) for te
-0000a410: 6e73 6f72 732e 2042 7920 6465 6661 756c  nsors. By defaul
-0000a420: 742c 2066 6f72 2065 7665 7279 2074 656e  t, for every ten
-0000a430: 736f 7220 6f75 7470 7574 2022 6f22 0a23  sor output "o".#
-0000a440: 2020 2074 6861 7420 7265 7175 6972 6573     that requires
-0000a450: 2067 7261 642c 2061 2067 7261 6420 6f66   grad, a grad of
-0000a460: 206f 6e65 735f 6c69 6b65 286f 2920 6973   ones_like(o) is
-0000a470: 2070 7574 2e0a 2320 5468 6520 6f70 7469   put..# The opti
-0000a480: 6f6e 616c 2067 7261 645f 6f75 745f 7370  onal grad_out_sp
-0000a490: 6563 6966 6965 7220 6163 6365 7074 7320  ecifier accepts 
-0000a4a0: 7468 6520 6675 6e63 7469 6f6e 2773 2069  the function's i
-0000a4b0: 6e70 7574 2061 6e64 2063 616e 2063 616c  nput and can cal
-0000a4c0: 6c20 7072 696d 732e 6765 745f 6772 6164  l prims.get_grad
-0000a4d0: 2829 2074 6f0a 2320 2020 6163 7175 6972  () to.#   acquir
-0000a4e0: 6520 616e 6420 7265 7475 726e 2067 7261  e and return gra
-0000a4f0: 6469 656e 7473 2061 7320 6465 7369 7265  dients as desire
-0000a500: 642e 2042 7920 6465 6661 756c 742c 2074  d. By default, t
-0000a510: 6865 2069 6e70 7574 2069 7320 666c 6174  he input is flat
-0000a520: 7465 6e65 640a 2320 2020 2874 7265 655f  tened.#   (tree_
-0000a530: 666c 6174 7465 6e28 6172 6773 2c20 6b77  flatten(args, kw
-0000a540: 6172 6773 2929 2061 6e64 2061 2066 6c61  args)) and a fla
-0000a550: 7420 6c69 7374 206f 6620 6772 6164 7320  t list of grads 
-0000a560: 666f 7220 616c 6c20 7465 6e73 6f72 7320  for all tensors 
-0000a570: 7265 7175 6972 696e 6720 6772 6164 0a23  requiring grad.#
-0000a580: 2020 2061 6e64 204e 6f6e 6520 666f 7220     and None for 
-0000a590: 6f74 6865 7220 696e 7075 7473 2069 7320  other inputs is 
-0000a5a0: 7265 7475 726e 6564 2e0a 2320 5468 6520  returned..# The 
-0000a5b0: 616c 676f 7269 7468 6d20 666f 7220 6d6f  algorithm for mo
-0000a5c0: 6469 6679 696e 6720 7468 6520 7072 6f67  difying the prog
-0000a5d0: 7261 6d20 6861 7320 7468 6520 666f 6c6c  ram has the foll
-0000a5e0: 6f77 696e 6720 7374 6570 733a 0a23 2020  owing steps:.#  
-0000a5f0: 2031 2920 466c 6174 7465 6e73 2074 6865   1) Flattens the
-0000a600: 206f 7269 6769 6e61 6c20 7472 6163 6520   original trace 
-0000a610: 666f 7220 7468 6520 6772 6164 2074 7261  for the grad tra
-0000a620: 6e73 666f 726d 202d 2d20 656e 7375 696e  nsform -- ensuin
-0000a630: 6720 7468 6174 2061 6c6c 2074 6f70 2d6c  g that all top-l
-0000a640: 6576 656c 2073 796d 626f 6c73 2068 6176  evel symbols hav
-0000a650: 650a 2320 2020 2020 2020 6120 6772 6164  e.#       a grad
-0000a660: 2066 756e 6374 696f 6e2e 0a64 6566 205f   function..def _
-0000a670: 5f67 7261 6428 0a20 2020 2063 666e 2c20  _grad(.    cfn, 
-0000a680: 6772 6164 5f73 7065 6369 6669 6572 3a20  grad_specifier: 
-0000a690: 4361 6c6c 6162 6c65 203d 205f 6772 6164  Callable = _grad
-0000a6a0: 5f73 7065 6369 6669 6572 5f64 6566 6175  _specifier_defau
-0000a6b0: 6c74 2c20 6772 6164 5f6f 7574 5f73 7065  lt, grad_out_spe
-0000a6c0: 6369 6669 6572 3a20 4361 6c6c 6162 6c65  cifier: Callable
-0000a6d0: 203d 205f 6772 6164 5f6f 7574 5f73 7065   = _grad_out_spe
-0000a6e0: 6369 6669 6572 5f64 6566 6175 6c74 0a29  cifier_default.)
-0000a6f0: 202d 3e20 4361 6c6c 6162 6c65 3a0a 2020   -> Callable:.  
-0000a700: 2020 2320 4372 6561 7465 7320 6120 6375    # Creates a cu
-0000a710: 7374 6f6d 2074 7261 6e73 666f 726d 2063  stom transform c
-0000a720: 616c 6c61 626c 6520 7468 6174 2062 696e  allable that bin
-0000a730: 6473 2074 6865 2061 6464 6974 696f 6e61  ds the additiona
-0000a740: 6c20 6172 6775 6d65 6e74 7320 746f 2074  l arguments to t
-0000a750: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
-0000a760: 6d0a 2020 2020 406c 616e 6763 7478 284c  m.    @langctx(L
-0000a770: 616e 6775 6167 6573 2e43 4c41 4e47 290a  anguages.CLANG).
-0000a780: 2020 2020 6465 6620 5f67 7261 645f 7472      def _grad_tr
-0000a790: 616e 7366 6f72 6d28 7472 633a 2054 7261  ansform(trc: Tra
-0000a7a0: 6365 2c20 2a2c 2065 7865 6375 746f 7273  ce, *, executors
-0000a7b0: 5f6c 6973 743a 2053 6571 7565 6e63 655b  _list: Sequence[
-0000a7c0: 416e 795d 2920 2d3e 2054 7261 6365 3a0a  Any]) -> Trace:.
-0000a7d0: 2020 2020 2020 2020 7374 6172 745f 7469          start_ti
-0000a7e0: 6d65 5f6e 7320 3d20 7469 6d65 2e74 696d  me_ns = time.tim
-0000a7f0: 655f 6e73 2829 0a0a 2020 2020 2020 2020  e_ns()..        
-0000a800: 2320 5354 4550 204f 4e45 202d 2d20 466c  # STEP ONE -- Fl
-0000a810: 6174 7465 6e73 2061 6e64 2064 6365 730a  attens and dces.
-0000a820: 0a20 2020 2020 2020 2023 2052 6574 7572  .        # Retur
-0000a830: 6e73 2054 7275 6520 6966 2074 6865 2062  ns True if the b
-0000a840: 7379 6d20 6861 7320 6e6f 2067 7261 6420  sym has no grad 
-0000a850: 6675 6e63 7469 6f6e 2c20 616e 6420 736f  function, and so
-0000a860: 206d 7573 7420 6265 2066 6c61 7474 656e   must be flatten
-0000a870: 6564 2066 6f72 2074 6865 2067 7261 6420  ed for the grad 
-0000a880: 7472 616e 7366 6f72 6d0a 2020 2020 2020  transform.      
-0000a890: 2020 6e65 7665 725f 666c 6174 7465 6e3a    never_flatten:
-0000a8a0: 2073 6574 5b48 6173 6861 626c 655d 203d   set[Hashable] =
-0000a8b0: 207b 7072 696d 732e 5072 696d 4944 732e   {prims.PrimIDs.
-0000a8c0: 5245 5455 524e 2c20 7072 696d 732e 5072  RETURN, prims.Pr
-0000a8d0: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
-0000a8e0: 5649 414c 7d0a 0a20 2020 2020 2020 2064  VIAL}..        d
-0000a8f0: 6566 2073 686f 756c 645f 666c 6174 7465  ef should_flatte
-0000a900: 6e5f 666f 725f 6772 6164 2862 7379 6d3a  n_for_grad(bsym:
-0000a910: 2042 6f75 6e64 5379 6d62 6f6c 2920 2d3e   BoundSymbol) ->
-0000a920: 2062 6f6f 6c3a 0a20 2020 2020 2020 2020   bool:.         
-0000a930: 2020 2069 6620 6273 796d 2e73 796d 2e69     if bsym.sym.i
-0000a940: 6420 696e 206e 6576 6572 5f66 6c61 7474  d in never_flatt
-0000a950: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-0000a960: 2020 2020 7265 7475 726e 2046 616c 7365      return False
-0000a970: 0a0a 2020 2020 2020 2020 2020 2020 6772  ..            gr
-0000a980: 6164 666e 3a20 4e6f 6e65 207c 2043 616c  adfn: None | Cal
-0000a990: 6c61 626c 650a 2020 2020 2020 2020 2020  lable.          
-0000a9a0: 2020 6772 6164 666e 2c20 5f20 3d20 5f67    gradfn, _ = _g
-0000a9b0: 6574 5f67 7261 6466 6e5f 616e 645f 6578  et_gradfn_and_ex
-0000a9c0: 6563 7574 6f72 2862 7379 6d2c 2065 7865  ecutor(bsym, exe
-0000a9d0: 6375 746f 7273 5f6c 6973 743d 6578 6563  cutors_list=exec
-0000a9e0: 7574 6f72 735f 6c69 7374 290a 2020 2020  utors_list).    
-0000a9f0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0000aa00: 7261 6466 6e20 6973 204e 6f6e 650a 0a20  radfn is None.. 
-0000aa10: 2020 2020 2020 2023 2054 4f44 4f20 5243         # TODO RC
-0000aa20: 313a 206d 6179 6265 206d 6f76 6520 746f  1: maybe move to
-0000aa30: 2070 726f 6475 6365 2074 6865 7365 2061   produce these a
-0000aa40: 6c77 6179 7320 6f6e 2063 7265 6174 696f  lways on creatio
-0000aa50: 6e0a 2020 2020 2020 2020 6966 2074 7263  n.        if trc
-0000aa60: 2e6b 7761 7267 7320 6973 204e 6f6e 653a  .kwargs is None:
-0000aa70: 0a20 2020 2020 2020 2020 2020 2074 7263  .            trc
-0000aa80: 2e6b 7761 7267 7320 3d20 7b7d 0a20 2020  .kwargs = {}.   
-0000aa90: 2020 2020 2069 6620 7472 632e 666e 2069       if trc.fn i
-0000aaa0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000aab0: 2020 2020 7472 632e 666e 203d 2074 7263      trc.fn = trc
-0000aac0: 2e70 7974 686f 6e5f 6361 6c6c 6162 6c65  .python_callable
-0000aad0: 2829 0a0a 2020 2020 2020 2020 6772 6164  ()..        grad
-0000aae0: 7472 6320 3d20 6672 6f6d 5f74 7261 6365  trc = from_trace
-0000aaf0: 2874 7263 290a 2020 2020 2020 2020 666c  (trc).        fl
-0000ab00: 6174 7465 6e65 645f 6273 796d 733a 206c  attened_bsyms: l
-0000ab10: 6973 745b 426f 756e 6453 796d 626f 6c5d  ist[BoundSymbol]
-0000ab20: 203d 2066 6c61 7474 656e 5f66 6f72 5f74   = flatten_for_t
-0000ab30: 7261 6e73 666f 726d 2873 686f 756c 645f  ransform(should_
-0000ab40: 666c 6174 7465 6e5f 666f 725f 6772 6164  flatten_for_grad
-0000ab50: 2c20 7472 632e 626f 756e 645f 7379 6d62  , trc.bound_symb
-0000ab60: 6f6c 7329 0a20 2020 2020 2020 2067 7261  ols).        gra
-0000ab70: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
-0000ab80: 6c73 203d 2066 6c61 7474 656e 6564 5f62  ls = flattened_b
-0000ab90: 7379 6d73 0a20 2020 2020 2020 2067 7261  syms.        gra
-0000aba0: 6474 7263 203d 2064 6365 2867 7261 6474  dtrc = dce(gradt
-0000abb0: 7263 290a 0a20 2020 2020 2020 2023 2053  rc)..        # S
-0000abc0: 5445 5020 5457 4f20 2d2d 2052 6570 6c61  TEP TWO -- Repla
-0000abd0: 6365 7320 6f72 6967 696e 616c 2063 616c  ces original cal
-0000abe0: 6c73 2077 6974 6820 6772 6164 2063 616c  ls with grad cal
-0000abf0: 6c73 0a0a 2020 2020 2020 2020 2320 4465  ls..        # De
-0000ac00: 6669 6e65 7320 7468 6520 7669 7369 746f  fines the visito
-0000ac10: 7220 7061 7474 6572 6e20 666f 7220 7468  r pattern for th
-0000ac20: 6520 6669 7273 7420 7061 7373 206f 6620  e first pass of 
-0000ac30: 7468 6520 6772 6164 2074 7261 6e73 666f  the grad transfo
-0000ac40: 726d 2c0a 2020 2020 2020 2020 2320 2020  rm,.        #   
-0000ac50: 7768 6963 6820 7377 6170 7320 426f 756e  which swaps Boun
-0000ac60: 6453 796d 626f 6c73 2077 6974 6820 7468  dSymbols with th
-0000ac70: 6569 7220 6772 6164 2066 756e 6374 696f  eir grad functio
-0000ac80: 6e73 0a20 2020 2020 2020 2064 6566 2076  ns.        def v
-0000ac90: 6973 6974 5f28 6273 796d 3a20 426f 756e  isit_(bsym: Boun
-0000aca0: 6453 796d 626f 6c29 202d 3e20 4361 6c6c  dSymbol) -> Call
-0000acb0: 6162 6c65 3a0a 2020 2020 2020 2020 2020  able:.          
-0000acc0: 2020 6772 6164 666e 3a20 4e6f 6e65 207c    gradfn: None |
-0000acd0: 2043 616c 6c61 626c 650a 2020 2020 2020   Callable.      
-0000ace0: 2020 2020 2020 6772 6164 666e 2c20 5f20        gradfn, _ 
-0000acf0: 3d20 5f67 6574 5f67 7261 6466 6e5f 616e  = _get_gradfn_an
-0000ad00: 645f 6578 6563 7574 6f72 2862 7379 6d2c  d_executor(bsym,
-0000ad10: 2065 7865 6375 746f 7273 5f6c 6973 743d   executors_list=
-0000ad20: 6578 6563 7574 6f72 735f 6c69 7374 290a  executors_list).
-0000ad30: 2020 2020 2020 2020 2020 2020 6368 6563              chec
-0000ad40: 6b28 0a20 2020 2020 2020 2020 2020 2020  k(.             
-0000ad50: 2020 2067 7261 6466 6e20 6973 206e 6f74     gradfn is not
-0000ad60: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-0000ad70: 2020 2020 2020 206c 616d 6264 613a 2066         lambda: f
-0000ad80: 2246 6169 6c65 6420 746f 2066 696e 6420  "Failed to find 
-0000ad90: 6120 6772 6164 666e 2066 6f72 207b 6273  a gradfn for {bs
-0000ada0: 796d 3d7d 2061 6674 6572 2066 6c61 7474  ym=} after flatt
-0000adb0: 656e 696e 6722 2c0a 2020 2020 2020 2020  ening",.        
-0000adc0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0000add0: 6e5f 7479 7065 3d41 7373 6572 7469 6f6e  n_type=Assertion
-0000ade0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-0000adf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0000ae00: 2072 6574 7572 6e20 6772 6164 666e 0a0a   return gradfn..
-0000ae10: 2020 2020 2020 2020 4077 7261 7073 2874          @wraps(t
-0000ae20: 7263 2e66 6e2e 6d65 7461 2069 6620 6973  rc.fn.meta if is
-0000ae30: 696e 7374 616e 6365 2874 7263 2e66 6e2c  instance(trc.fn,
-0000ae40: 2053 796d 626f 6c29 2065 6c73 6520 7472   Symbol) else tr
-0000ae50: 632e 666e 290a 2020 2020 2020 2020 6465  c.fn).        de
-0000ae60: 6620 696e 7465 7270 7265 7469 6e67 5f66  f interpreting_f
-0000ae70: 6e28 2a61 7267 732c 202a 2a6b 7761 7267  n(*args, **kwarg
-0000ae80: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000ae90: 7265 7375 6c74 203d 2065 7661 6c5f 7472  result = eval_tr
-0000aea0: 6163 6528 6772 6164 7472 632c 202a 6172  ace(gradtrc, *ar
-0000aeb0: 6773 2c20 7379 6d62 6f6c 5f6d 6170 7065  gs, symbol_mappe
-0000aec0: 723d 7669 7369 745f 2c20 2a2a 6b77 6172  r=visit_, **kwar
-0000aed0: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-0000aee0: 2320 5365 7473 2067 7261 6473 2066 6f72  # Sets grads for
-0000aef0: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0000af00: 2020 2020 2320 544f 444f 2054 6869 7320      # TODO This 
-0000af10: 6566 6665 6374 6976 656c 7920 7275 6e73  effectively runs
-0000af20: 2069 6e20 6120 6e6f 2067 7261 6420 636f   in a no grad co
-0000af30: 6e74 6578 7420 2d2d 2073 686f 756c 6420  ntext -- should 
-0000af40: 6974 2072 756e 2069 6e20 6120 6772 6164  it run in a grad
-0000af50: 2063 6f6e 7465 7874 2c0a 2020 2020 2020   context,.      
-0000af60: 2020 2020 2020 2320 2020 6f72 2073 686f        #   or sho
-0000af70: 756c 6420 7468 6572 6520 6265 2074 6865  uld there be the
-0000af80: 206f 7074 696f 6e20 746f 2072 756e 2069   option to run i
-0000af90: 7420 696e 2061 2067 7261 6420 636f 6e74  t in a grad cont
-0000afa0: 6578 743f 0a20 2020 2020 2020 2020 2020  ext?.           
-0000afb0: 2067 7261 645f 7370 6563 6966 6965 7228   grad_specifier(
-0000afc0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
-0000afd0: 2020 2020 2320 436f 6e73 7472 7563 7473      # Constructs
-0000afe0: 2072 6574 7572 6e20 7661 6c75 650a 2020   return value.  
-0000aff0: 2020 2020 2020 2020 2020 666c 6174 5f67            flat_g
-0000b000: 7261 6473 203d 2067 7261 645f 6f75 745f  rads = grad_out_
-0000b010: 7370 6563 6966 6965 7228 2861 7267 732c  specifier((args,
-0000b020: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
-0000b030: 2020 2020 2020 7265 7475 726e 2066 6c61        return fla
-0000b040: 745f 6772 6164 730a 0a20 2020 2020 2020  t_grads..       
-0000b050: 2023 204e 4f54 4520 4166 7465 7220 7468   # NOTE After th
-0000b060: 6973 2063 616c 6c20 7468 6520 6772 6164  is call the grad
-0000b070: 7472 6320 6973 2069 6e76 616c 6964 2c20  trc is invalid, 
-0000b080: 6265 6361 7573 653a 0a20 2020 2020 2020  because:.       
-0000b090: 2023 2020 2031 2920 5468 6520 6e6f 6e2d   #   1) The non-
-0000b0a0: 6578 6563 7574 6162 6c65 2070 7574 5f67  executable put_g
-0000b0b0: 7261 6420 6f70 6572 6174 696f 6e73 2061  rad operations a
-0000b0c0: 7265 2073 7469 6c6c 2069 6e20 7468 6520  re still in the 
-0000b0d0: 7472 6163 652c 2061 6e64 206d 756c 7469  trace, and multi
-0000b0e0: 706c 6520 6361 6c6c 7320 746f 2070 7574  ple calls to put
-0000b0f0: 2067 7261 6420 6172 6520 6e6f 7420 6163   grad are not ac
-0000b100: 6375 6d75 6c61 7465 640a 2020 2020 2020  cumulated.      
-0000b110: 2020 2320 2020 3229 2054 6865 206e 6f6e    #   2) The non
-0000b120: 2d65 7865 6375 7461 626c 6520 6765 745f  -executable get_
-0000b130: 6772 6164 206f 7065 7261 7469 6f6e 7320  grad operations 
-0000b140: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
-0000b150: 2074 7261 6365 2c20 616e 6420 7468 6579   trace, and they
-0000b160: 206d 6179 2070 726f 6475 6365 2064 6966   may produce dif
-0000b170: 6665 7265 6e74 2070 726f 7869 6573 2077  ferent proxies w
-0000b180: 6865 6e0a 2020 2020 2020 2020 2320 2020  hen.        #   
-0000b190: 2020 2020 6361 6c6c 6564 206f 6e20 7468      called on th
-0000b1a0: 6520 7361 6d65 2069 6e70 7574 730a 2020  e same inputs.  
-0000b1b0: 2020 2020 2020 2320 2020 3329 2054 6865        #   3) The
-0000b1c0: 206f 7065 7261 7469 6f6e 7320 6172 6520   operations are 
-0000b1d0: 6e6f 7420 696e 2061 2076 616c 6964 206f  not in a valid o
-0000b1e0: 7264 6572 0a20 2020 2020 2020 2067 7261  rder.        gra
-0000b1f0: 6474 7263 203d 2063 6f6e 7374 7275 6374  dtrc = construct
-0000b200: 5f74 7261 6365 280a 2020 2020 2020 2020  _trace(.        
-0000b210: 2020 2020 7265 6e61 6d65 5f70 726f 7869      rename_proxi
-0000b220: 6573 3d46 616c 7365 2c0a 2020 2020 2020  es=False,.      
-0000b230: 2020 2020 2020 7573 655f 6463 653d 4661        use_dce=Fa
-0000b240: 6c73 652c 0a20 2020 2020 2020 2029 2869  lse,.        )(i
-0000b250: 6e74 6572 7072 6574 696e 675f 666e 2c20  nterpreting_fn, 
-0000b260: 2a67 7261 6474 7263 2e61 7267 732c 202a  *gradtrc.args, *
-0000b270: 2a67 7261 6474 7263 2e6b 7761 7267 7329  *gradtrc.kwargs)
-0000b280: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
-0000b290: 2e73 636f 7065 7320 3d20 5b67 7261 6474  .scopes = [gradt
-0000b2a0: 7263 2e62 6f75 6e64 5f73 796d 626f 6c73  rc.bound_symbols
-0000b2b0: 5d0a 2020 2020 2020 2020 6772 6164 7472  ].        gradtr
-0000b2c0: 632e 5f63 6f6d 706c 6574 6520 3d20 4661  c._complete = Fa
-0000b2d0: 6c73 650a 0a20 2020 2020 2020 2023 2053  lse..        # S
-0000b2e0: 5445 5020 5448 5245 4520 2d2d 2048 616e  TEP THREE -- Han
-0000b2f0: 646c 6573 2070 7574 5f67 7261 6420 616e  dles put_grad an
-0000b300: 6420 6765 745f 6772 6164 206f 7065 7261  d get_grad opera
-0000b310: 7469 6f6e 7320 616e 6420 6163 6375 6d75  tions and accumu
-0000b320: 6c61 7465 7320 6772 6164 6965 6e74 730a  lates gradients.
-0000b330: 0a20 2020 2020 2020 2023 2041 6363 756d  .        # Accum
-0000b340: 756c 6174 6573 2067 7261 6469 656e 7473  ulates gradients
-0000b350: 2c20 6372 6561 7469 6e67 2074 6865 2070  , creating the p
-0000b360: 7269 6d61 6c20 2d3e 2061 6363 756d 756c  rimal -> accumul
-0000b370: 6174 6564 2067 7261 6420 6d61 7070 696e  ated grad mappin
-0000b380: 670a 2020 2020 2020 2020 2320 5365 7473  g.        # Sets
-0000b390: 2074 6865 2074 7261 6369 6e67 2063 6f6e   the tracing con
-0000b3a0: 7465 7874 2073 6f20 6163 6375 6d75 6c61  text so accumula
-0000b3b0: 7469 6f6e 206f 7065 7261 7469 6f6e 7320  tion operations 
-0000b3c0: 6172 6520 7265 636f 7264 6564 2069 6e74  are recorded int
-0000b3d0: 6f20 7468 6520 7472 6163 650a 2020 2020  o the trace.    
-0000b3e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000b3f0: 2020 2020 2074 7261 6365 6374 785f 746f       tracectx_to
-0000b400: 6b20 3d20 7365 745f 7472 6163 6563 7478  k = set_tracectx
-0000b410: 2867 7261 6474 7263 290a 0a20 2020 2020  (gradtrc)..     
-0000b420: 2020 2020 2020 2023 204d 6170 7320 7072         # Maps pr
-0000b430: 696d 616c 7320 746f 2074 6865 6972 2067  imals to their g
-0000b440: 7261 6469 656e 7473 2028 7768 6963 6820  radients (which 
-0000b450: 6172 6520 7265 7475 726e 6564 2066 726f  are returned fro
-0000b460: 6d20 6361 6c6c 696e 6720 6765 745f 6772  m calling get_gr
-0000b470: 6164 206f 6e20 7468 6520 7072 696d 616c  ad on the primal
-0000b480: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-0000b490: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
-0000b4a0: 6d61 703a 2064 6963 745b 5661 7269 6162  map: dict[Variab
-0000b4b0: 6c65 2c20 5465 6e73 6f72 5072 6f78 795d  le, TensorProxy]
-0000b4c0: 203d 207b 7d0a 0a20 2020 2020 2020 2020   = {}..         
-0000b4d0: 2020 2023 2048 616e 646c 6573 2070 7574     # Handles put
-0000b4e0: 5f67 7261 6420 6f70 6572 6174 696f 6e73  _grad operations
-0000b4f0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-0000b500: 4f54 4520 5468 6973 206d 6f64 6966 6965  OTE This modifie
-0000b510: 7320 6120 6c69 7374 2074 6861 7420 6973  s a list that is
-0000b520: 2062 6569 6e67 2065 6e75 6d65 7261 7465   being enumerate
-0000b530: 6420 6f76 6572 2c20 6275 7420 6974 2773  d over, but it's
-0000b540: 204f 4b20 6265 6361 7573 6520 7765 2772   OK because we'r
-0000b550: 6520 6f6e 6c79 0a20 2020 2020 2020 2020  e only.         
-0000b560: 2020 2023 2020 2061 7070 656e 6469 6e67     #   appending
-0000b570: 2074 6f20 7468 6520 656e 6420 6f66 2074   to the end of t
-0000b580: 6865 206c 6973 740a 2020 2020 2020 2020  he list.        
-0000b590: 2020 2020 6273 796d 3a20 426f 756e 6453      bsym: BoundS
-0000b5a0: 796d 626f 6c0a 2020 2020 2020 2020 2020  ymbol.          
-0000b5b0: 2020 666f 7220 6273 796d 2069 6e20 6772    for bsym in gr
-0000b5c0: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
-0000b5d0: 6f6c 733a 0a20 2020 2020 2020 2020 2020  ols:.           
-0000b5e0: 2020 2020 2069 643a 2048 6173 6861 626c       id: Hashabl
-0000b5f0: 6520 3d20 6273 796d 2e73 796d 2e69 640a  e = bsym.sym.id.
-0000b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b610: 6966 2069 6420 6973 2070 6964 732e 5055  if id is pids.PU
-0000b620: 545f 4752 4144 3a0a 2020 2020 2020 2020  T_GRAD:.        
-0000b630: 2020 2020 2020 2020 2020 2020 7072 696d              prim
-0000b640: 616c 3a20 4e75 6d62 6572 207c 2054 656e  al: Number | Ten
-0000b650: 736f 7250 726f 7879 0a20 2020 2020 2020  sorProxy.       
-0000b660: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-0000b670: 643a 204e 756d 6265 7220 7c20 5465 6e73  d: Number | Tens
-0000b680: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
-0000b690: 2020 2020 2020 2020 2020 2020 7072 696d              prim
-0000b6a0: 616c 2c20 6772 6164 203d 2062 7379 6d2e  al, grad = bsym.
-0000b6b0: 666c 6174 5f61 7267 730a 0a20 2020 2020  flat_args..     
-0000b6c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b6d0: 2054 4f44 4f20 5375 7070 6f72 7420 6175   TODO Support au
-0000b6e0: 746f 6772 6164 206f 6e20 6e75 6d62 6572  tograd on number
-0000b6f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000b700: 2020 2020 2020 2320 4669 6c74 6572 7320        # Filters 
-0000b710: 6361 6c6c 7320 746f 2070 7574 5f67 7261  calls to put_gra
-0000b720: 6420 7468 6174 2077 6f75 6c64 2070 7574  d that would put
-0000b730: 2061 2067 7261 6420 6f6e 2061 206e 6f6e   a grad on a non
-0000b740: 2d74 656e 736f 7220 6f72 2061 2074 656e  -tensor or a ten
-0000b750: 736f 7220 7468 6174 2064 6f65 736e 2774  sor that doesn't
-0000b760: 2072 6571 7569 7265 2067 7261 640a 2020   require grad.  
-0000b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b780: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0000b790: 6e63 6528 7072 696d 616c 2c20 5465 6e73  nce(primal, Tens
-0000b7a0: 6f72 5072 6f78 7929 206f 7220 6e6f 7420  orProxy) or not 
-0000b7b0: 7072 696d 616c 2e72 6571 7569 7265 735f  primal.requires_
-0000b7c0: 6772 6164 3a0a 2020 2020 2020 2020 2020  grad:.          
-0000b7d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000b7e0: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-0000b7f0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0000b800: 444f 2053 7570 706f 7274 2063 6f6d 706c  DO Support compl
-0000b810: 6578 2061 7574 6f67 7261 640a 2020 2020  ex autograd.    
-0000b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b830: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
-0000b840: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000b850: 6f74 2064 7479 7065 732e 6973 5f63 6f6d  ot dtypes.is_com
-0000b860: 706c 6578 5f64 7479 7065 2864 7479 7065  plex_dtype(dtype
-0000b870: 732e 746f 5f64 7479 7065 2870 7269 6d61  s.to_dtype(prima
-0000b880: 6c29 292c 0a20 2020 2020 2020 2020 2020  l)),.           
-0000b890: 2020 2020 2020 2020 2020 2020 206c 616d               lam
-0000b8a0: 6264 613a 2066 2243 6f6d 706c 6578 2067  bda: f"Complex g
-0000b8b0: 7261 6420 6973 206e 6f74 2073 7570 706f  rad is not suppo
-0000b8c0: 7274 6564 2079 6574 222c 0a20 2020 2020  rted yet",.     
-0000b8d0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0000b8e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000b8f0: 2020 2020 2020 7670 7269 6d61 6c3a 2056        vprimal: V
-0000b900: 6172 6961 626c 6520 3d20 7661 7269 6162  ariable = variab
-0000b910: 6c65 6966 7928 7072 696d 616c 290a 2020  leify(primal).  
-0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 2020 6163 6375 6d3a 204e 6f6e 6520 7c20    accum: None | 
-0000b940: 5465 6e73 6f72 5072 6f78 7920 3d20 7072  TensorProxy = pr
-0000b950: 696d 616c 735f 746f 5f67 696e 7075 745f  imals_to_ginput_
-0000b960: 6d61 702e 6765 7428 7670 7269 6d61 6c2c  map.get(vprimal,
-0000b970: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
-0000b980: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0000b990: 6363 756d 2069 7320 4e6f 6e65 3a0a 2020  ccum is None:.  
-0000b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9b0: 2020 2020 2020 7072 696d 616c 735f 746f        primals_to
-0000b9c0: 5f67 696e 7075 745f 6d61 705b 7670 7269  _ginput_map[vpri
-0000b9d0: 6d61 6c5d 203d 2067 7261 640a 2020 2020  mal] = grad.    
-0000b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b9f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000ba00: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-0000ba10: 6375 6d20 3d20 6163 6375 6d20 2b20 6772  cum = accum + gr
-0000ba20: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
-0000ba30: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-0000ba40: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
-0000ba50: 5b76 7072 696d 616c 5d20 3d20 6163 6375  [vprimal] = accu
-0000ba60: 6d0a 0a20 2020 2020 2020 2020 2020 2023  m..            #
-0000ba70: 2048 616e 646c 6573 2067 6574 5f67 7261   Handles get_gra
-0000ba80: 6420 6f70 6572 6174 696f 6e73 0a0a 2020  d operations..  
-0000ba90: 2020 2020 2020 2020 2020 2320 5265 7365            # Rese
-0000baa0: 7473 2074 6865 2073 7761 706d 6170 2066  ts the swapmap f
-0000bab0: 6f72 2067 7261 6473 0a20 2020 2020 2020  or grads.       
-0000bac0: 2020 2020 2073 7761 706d 6170 3a20 6469       swapmap: di
-0000bad0: 6374 5b56 6172 6961 626c 652c 2050 726f  ct[Variable, Pro
-0000bae0: 7879 5d20 3d20 7b7d 0a0a 2020 2020 2020  xy] = {}..      
-0000baf0: 2020 2020 2020 666f 7220 6273 796d 2069        for bsym i
-0000bb00: 6e20 6772 6164 7472 632e 626f 756e 645f  n gradtrc.bound_
-0000bb10: 7379 6d62 6f6c 733a 0a20 2020 2020 2020  symbols:.       
-0000bb20: 2020 2020 2020 2020 2069 643a 2048 6173           id: Has
-0000bb30: 6861 626c 6520 3d20 6273 796d 2e73 796d  hable = bsym.sym
-0000bb40: 2e69 640a 2020 2020 2020 2020 2020 2020  .id.            
-0000bb50: 2020 2020 6966 2069 6420 6973 2070 6964      if id is pid
-0000bb60: 732e 4745 545f 4752 4144 3a0a 2020 2020  s.GET_GRAD:.    
-0000bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb80: 7072 696d 616c 3a20 4e75 6d62 6572 207c  primal: Number |
-0000bb90: 2054 656e 736f 7250 726f 7879 0a20 2020   TensorProxy.   
-0000bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bbb0: 2028 7072 696d 616c 2c29 203d 2062 7379   (primal,) = bsy
-0000bbc0: 6d2e 666c 6174 5f61 7267 730a 2020 2020  m.flat_args.    
-0000bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bbe0: 6772 6164 3a20 4e75 6d62 6572 207c 2054  grad: Number | T
-0000bbf0: 656e 736f 7250 726f 7879 203d 2062 7379  ensorProxy = bsy
-0000bc00: 6d2e 6f75 7470 7574 0a0a 2020 2020 2020  m.output..      
-0000bc10: 2020 2020 2020 2020 2020 2020 2020 7670                vp
-0000bc20: 7269 6d61 6c3a 2056 6172 6961 626c 650a  rimal: Variable.
-0000bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc40: 2020 2020 7667 7261 643a 2056 6172 6961      vgrad: Varia
-0000bc50: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-0000bc60: 2020 2020 2020 2020 7670 7269 6d61 6c2c          vprimal,
-0000bc70: 2076 6772 6164 203d 2076 6172 6961 626c   vgrad = variabl
-0000bc80: 6569 6679 2870 7269 6d61 6c29 2c20 7661  eify(primal), va
-0000bc90: 7269 6162 6c65 6966 7928 6772 6164 290a  riableify(grad).
-0000bca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bcb0: 2020 2020 2061 6374 7561 6c5f 6772 6164       actual_grad
-0000bcc0: 3a20 4e6f 6e65 207c 2054 656e 736f 7250  : None | TensorP
-0000bcd0: 726f 7879 203d 2070 7269 6d61 6c73 5f74  roxy = primals_t
-0000bce0: 6f5f 6769 6e70 7574 5f6d 6170 2e67 6574  o_ginput_map.get
-0000bcf0: 2876 7072 696d 616c 2c20 4e6f 6e65 290a  (vprimal, None).
-0000bd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bd10: 2020 2020 2023 204e 4f54 4520 4966 2061       # NOTE If a
-0000bd20: 6374 7561 6c5f 6772 6164 2069 7320 4e6f  ctual_grad is No
-0000bd30: 6e65 2074 6865 6e20 7468 6572 6527 7320  ne then there's 
-0000bd40: 6120 6765 745f 6772 6164 2829 2072 6571  a get_grad() req
-0000bd50: 7565 7374 2066 6f72 2061 2074 656e 736f  uest for a tenso
-0000bd60: 7220 7768 6963 680a 2020 2020 2020 2020  r which.        
-0000bd70: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000bd80: 6861 7320 6e6f 2070 7574 5f67 7261 6428  has no put_grad(
-0000bd90: 292c 2073 6f20 7765 2072 6574 7572 6e20  ), so we return 
-0000bda0: 7a65 726f 7320 666f 7220 7468 6520 6772  zeros for the gr
-0000bdb0: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
-0000bdc0: 2020 2020 2020 2023 2054 4f44 4f20 5265         # TODO Re
-0000bdd0: 7669 7369 7420 7468 6973 202d 2d20 6361  visit this -- ca
-0000bde0: 6e20 7765 2072 656d 6f76 6520 7468 6573  n we remove thes
-0000bdf0: 6520 636f 6d70 7574 6174 696f 6e73 2c20  e computations, 
-0000be00: 6f72 2075 7365 2061 2073 7065 6369 616c  or use a special
-0000be10: 205a 6572 6f54 656e 736f 720a 2020 2020   ZeroTensor.    
-0000be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be30: 2320 2020 746f 2073 696d 706c 6966 7920  #   to simplify 
-0000be40: 7468 656d 3f0a 2020 2020 2020 2020 2020  them?.          
-0000be50: 2020 2020 2020 2020 2020 6966 2061 6374            if act
-0000be60: 7561 6c5f 6772 6164 2069 7320 4e6f 6e65  ual_grad is None
-0000be70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000be80: 2020 2020 2020 2020 2020 6163 7475 616c            actual
-0000be90: 5f67 7261 6420 3d20 6c74 6f72 6368 2e7a  _grad = ltorch.z
-0000bea0: 6572 6f73 5f6c 696b 6528 7072 696d 616c  eros_like(primal
-0000beb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000bec0: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-0000bed0: 735f 746f 5f67 696e 7075 745f 6d61 705b  s_to_ginput_map[
-0000bee0: 7670 7269 6d61 6c5d 203d 2061 6374 7561  vprimal] = actua
-0000bef0: 6c5f 6772 6164 0a0a 2020 2020 2020 2020  l_grad..        
-0000bf00: 2020 2020 2020 2020 2020 2020 2320 5570              # Up
-0000bf10: 6461 7465 7320 7468 6520 6772 6164 2061  dates the grad a
-0000bf20: 6c69 6173 206d 6170 0a20 2020 2020 2020  lias map.       
-0000bf30: 2020 2020 2020 2020 2020 2020 2076 6163               vac
-0000bf40: 7475 616c 5f67 7261 643a 2056 6172 6961  tual_grad: Varia
-0000bf50: 626c 6520 3d20 7661 7269 6162 6c65 6966  ble = variableif
-0000bf60: 7928 6163 7475 616c 5f67 7261 6429 0a20  y(actual_grad). 
-0000bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf80: 2020 2069 6620 7661 6374 7561 6c5f 6772     if vactual_gr
-0000bf90: 6164 2021 3d20 7667 7261 643a 0a20 2020  ad != vgrad:.   
-0000bfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfb0: 2020 2020 2073 7761 706d 6170 5b76 6772       swapmap[vgr
-0000bfc0: 6164 5d20 3d20 6163 7475 616c 5f67 7261  ad] = actual_gra
-0000bfd0: 640a 0a20 2020 2020 2020 2066 696e 616c  d..        final
-0000bfe0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-0000bff0: 2320 5265 7374 6f72 6573 2073 636f 7065  # Restores scope
-0000c000: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0000c010: 6574 5f74 7261 6365 6374 7828 7472 6163  et_tracectx(trac
-0000c020: 6563 7478 5f74 6f6b 290a 0a20 2020 2020  ectx_tok)..     
-0000c030: 2020 2023 2046 696c 7465 7273 2070 7574     # Filters put
-0000c040: 5f67 7261 6420 616e 6420 6765 745f 6772  _grad and get_gr
-0000c050: 6164 206f 7065 7261 7469 6f6e 7320 616e  ad operations an
-0000c060: 6420 6170 706c 6965 7320 7468 6520 7377  d applies the sw
-0000c070: 6170 6d61 700a 2020 2020 2020 2020 6465  apmap.        de
-0000c080: 6620 5f66 696c 7465 7228 6273 796d 3a20  f _filter(bsym: 
-0000c090: 426f 756e 6453 796d 626f 6c29 202d 3e20  BoundSymbol) -> 
-0000c0a0: 626f 6f6c 3a0a 2020 2020 2020 2020 2020  bool:.          
-0000c0b0: 2020 6964 3a20 4861 7368 6162 6c65 203d    id: Hashable =
-0000c0c0: 2062 7379 6d2e 7379 6d2e 6964 0a20 2020   bsym.sym.id.   
-0000c0d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000c0e0: 6964 2069 6e20 2870 6964 732e 5055 545f  id in (pids.PUT_
-0000c0f0: 4752 4144 2c20 7069 6473 2e47 4554 5f47  GRAD, pids.GET_G
-0000c100: 5241 4429 0a0a 2020 2020 2020 2020 6772  RAD)..        gr
-0000c110: 6164 7472 632e 626f 756e 645f 7379 6d62  adtrc.bound_symb
-0000c120: 6f6c 7320 3d20 5b0a 2020 2020 2020 2020  ols = [.        
-0000c130: 2020 2020 6273 796d 2e66 726f 6d5f 6273      bsym.from_bs
-0000c140: 796d 5f73 7761 705f 7072 6f78 6965 7328  ym_swap_proxies(
-0000c150: 7377 6170 6d61 7029 2066 6f72 2062 7379  swapmap) for bsy
-0000c160: 6d20 696e 2067 7261 6474 7263 2e62 6f75  m in gradtrc.bou
-0000c170: 6e64 5f73 796d 626f 6c73 2069 6620 6e6f  nd_symbols if no
-0000c180: 7420 5f66 696c 7465 7228 6273 796d 290a  t _filter(bsym).
-0000c190: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
-0000c1a0: 2020 2023 2053 5445 5020 464f 5552 202d     # STEP FOUR -
-0000c1b0: 2d2d 204f 7264 6572 7320 7468 6520 6f70  -- Orders the op
-0000c1c0: 6572 6174 696f 6e73 0a20 2020 2020 2020  erations.       
-0000c1d0: 2023 2054 4f44 4f20 436f 6e73 6964 6572   # TODO Consider
-0000c1e0: 2061 6c74 6572 6e61 7469 7665 2073 6368   alternative sch
-0000c1f0: 6564 756c 696e 6720 616c 676f 7269 7468  eduling algorith
-0000c200: 6d73 2c20 6d61 7962 6520 6279 2075 7369  ms, maybe by usi
-0000c210: 6e67 2067 7261 7068 2066 6561 7475 7265  ng graph feature
-0000c220: 730a 2020 2020 2020 2020 2320 2020 536f  s.        #   So
-0000c230: 6d65 2069 6465 6173 2061 7265 206c 6f6f  me ideas are loo
-0000c240: 6b69 6e67 2061 7420 6d65 6d6f 7279 2d73  king at memory-s
-0000c250: 6176 696e 6720 6e6f 6465 732c 2061 6e64  aving nodes, and
-0000c260: 206e 6f64 6573 2077 6974 6820 6120 6869   nodes with a hi
-0000c270: 6768 2069 6e2d 6465 6772 6565 206f 7220  gh in-degree or 
-0000c280: 6869 6768 206f 7574 2d64 6567 7265 650a  high out-degree.
-0000c290: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-0000c2a0: 6573 2061 6e20 696e 6974 6961 6c20 7661  es an initial va
-0000c2b0: 6c69 6420 6f72 6465 7269 6e67 2074 6f20  lid ordering to 
-0000c2c0: 4443 452c 2073 6f20 7468 6174 2061 6464  DCE, so that add
-0000c2d0: 6974 696f 6e61 6c20 6f72 6465 7269 6e67  itional ordering
-0000c2e0: 2061 6e61 6c79 7369 7320 646f 6573 6e27   analysis doesn'
-0000c2f0: 7420 6e65 6564 2074 6f20 636f 6e73 6964  t need to consid
-0000c300: 6572 2061 6c6c 2073 796d 626f 6c73 0a20  er all symbols. 
-0000c310: 2020 2020 2020 2072 6f6f 7473 2c20 6c65         roots, le
-0000c320: 6176 6573 203d 2062 7379 6d5f 6c69 7374  aves = bsym_list
-0000c330: 5f74 6f5f 6461 6728 6772 6164 7472 632e  _to_dag(gradtrc.
-0000c340: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
-0000c350: 2020 2020 2020 206f 7264 6572 6564 5f62         ordered_b
-0000c360: 7379 6d73 203d 2074 6f70 6f73 6f72 745f  syms = toposort_
-0000c370: 6273 796d 5f64 6167 2872 6f6f 7473 2c20  bsym_dag(roots, 
-0000c380: 544f 504f 534f 5254 5f4f 5244 4552 2e54  TOPOSORT_ORDER.T
-0000c390: 4f50 5f44 4f57 4e29 0a20 2020 2020 2020  OP_DOWN).       
-0000c3a0: 2067 7261 6474 7263 2e62 6f75 6e64 5f73   gradtrc.bound_s
-0000c3b0: 796d 626f 6c73 203d 206f 7264 6572 6564  ymbols = ordered
-0000c3c0: 5f62 7379 6d73 0a20 2020 2020 2020 2067  _bsyms.        g
-0000c3d0: 7261 6474 7263 203d 2064 6365 2867 7261  radtrc = dce(gra
-0000c3e0: 6474 7263 290a 0a20 2020 2020 2020 2023  dtrc)..        #
-0000c3f0: 2049 6465 6e74 6966 6965 7320 7468 6520   Identifies the 
-0000c400: 6f72 6465 7220 6f66 2042 6f75 6e64 5379  order of BoundSy
-0000c410: 6d62 6f6c 7320 7573 696e 6720 6120 2244  mbols using a "D
-0000c420: 4653 2061 6e64 2063 6861 696e 2220 616c  FS and chain" al
-0000c430: 676f 7269 7468 6d0a 2020 2020 2020 2020  gorithm.        
-0000c440: 2320 544f 444f 2045 6c61 626f 7261 7465  # TODO Elaborate
-0000c450: 206f 6e20 7468 6973 2061 6c67 6f72 6974   on this algorit
-0000c460: 686d 2061 6e64 2074 6865 2069 6d70 6c65  hm and the imple
-0000c470: 6d65 6e74 6174 696f 6e0a 2020 2020 2020  mentation.      
-0000c480: 2020 726f 6f74 732c 206c 6561 7665 7320    roots, leaves 
-0000c490: 3d20 6273 796d 5f6c 6973 745f 746f 5f64  = bsym_list_to_d
-0000c4a0: 6167 2867 7261 6474 7263 2e62 6f75 6e64  ag(gradtrc.bound
-0000c4b0: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
-0000c4c0: 2020 6368 6563 6b28 0a20 2020 2020 2020    check(.       
-0000c4d0: 2020 2020 206c 656e 286c 6561 7665 7329       len(leaves)
-0000c4e0: 203d 3d20 312c 0a20 2020 2020 2020 2020   == 1,.         
-0000c4f0: 2020 206c 616d 6264 613a 2066 2245 7870     lambda: f"Exp
-0000c500: 6563 7465 6420 6f6e 6c79 206f 6e65 206c  ected only one l
-0000c510: 6561 6620 6e6f 6465 2077 6865 6e20 736f  eaf node when so
-0000c520: 7274 696e 6720 666f 7220 6772 6164 2c20  rting for grad, 
-0000c530: 666f 756e 6420 7468 6572 6520 7765 7265  found there were
-0000c540: 207b 6c65 6e28 6c65 6176 6573 297d 206c   {len(leaves)} l
-0000c550: 6561 7665 7322 2c0a 2020 2020 2020 2020  eaves",.        
-0000c560: 290a 2020 2020 2020 2020 286c 6561 662c  ).        (leaf,
-0000c570: 2920 3d20 6c65 6176 6573 0a0a 2020 2020  ) = leaves..    
-0000c580: 2020 2020 2320 436f 6d70 7574 6573 2074      # Computes t
-0000c590: 6865 2074 656e 736f 7220 6d65 6d6f 7279  he tensor memory
-0000c5a0: 2075 7365 6420 6279 2074 6865 2067 6976   used by the giv
-0000c5b0: 656e 2070 7974 7265 650a 2020 2020 2020  en pytree.      
-0000c5c0: 2020 6465 6620 6d65 6d6f 7279 5f75 7365    def memory_use
-0000c5d0: 6428 7079 7472 6565 2920 2d3e 2069 6e74  d(pytree) -> int
-0000c5e0: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
-0000c5f0: 6d6f 7279 5f75 7365 3a20 696e 7420 3d20  mory_use: int = 
-0000c600: 300a 0a20 2020 2020 2020 2020 2020 2064  0..            d
-0000c610: 6566 2063 6f75 6e74 5f6d 656d 6f72 795f  ef count_memory_
-0000c620: 7573 6528 7829 3a0a 2020 2020 2020 2020  use(x):.        
-0000c630: 2020 2020 2020 2020 6e6f 6e6c 6f63 616c          nonlocal
-0000c640: 206d 656d 6f72 795f 7573 650a 2020 2020   memory_use.    
-0000c650: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000c660: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
-0000c670: 736f 7250 726f 7879 293a 0a20 2020 2020  sorProxy):.     
-0000c680: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000c690: 656d 6f72 795f 7573 6520 2b3d 2078 2e64  emory_use += x.d
-0000c6a0: 7479 7065 2e5f 6279 7465 7320 2a20 782e  type._bytes * x.
-0000c6b0: 6e75 6d65 6c0a 0a20 2020 2020 2020 2020  numel..         
-0000c6c0: 2020 2074 7265 655f 6d61 7028 636f 756e     tree_map(coun
-0000c6d0: 745f 6d65 6d6f 7279 5f75 7365 2c20 7079  t_memory_use, py
-0000c6e0: 7472 6565 290a 2020 2020 2020 2020 2020  tree).          
-0000c6f0: 2020 7265 7475 726e 206d 656d 6f72 795f    return memory_
-0000c700: 7573 650a 0a20 2020 2020 2020 2023 2054  use..        # T
-0000c710: 7275 6520 7768 656e 2061 206e 6f64 6520  rue when a node 
-0000c720: 6973 2061 2022 6c69 6e6b 2220 2d2d 2061  is a "link" -- a
-0000c730: 206e 6f64 6520 7769 7468 206f 6e6c 7920   node with only 
-0000c740: 6f6e 6520 6368 696c 6420 616e 6420 6174  one child and at
-0000c750: 206d 6f73 7420 6f6e 6520 7061 7265 6e74   most one parent
-0000c760: 0a20 2020 2020 2020 2023 2020 2043 6f6e  .        #   Con
-0000c770: 6365 7074 7561 6c6c 7920 7468 6520 6e6f  ceptually the no
-0000c780: 6465 2069 7320 6120 226c 696e 6b22 2069  de is a "link" i
-0000c790: 6e20 6120 6368 6169 6e20 6f66 206e 6f64  n a chain of nod
-0000c7a0: 6573 206c 696b 6520 4120 2d3e 2042 202d  es like A -> B -
-0000c7b0: 3e20 430a 2020 2020 2020 2020 6465 6620  > C.        def 
-0000c7c0: 6973 5f6c 696e 6b28 6e3a 204e 6f64 6529  is_link(n: Node)
-0000c7d0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-0000c7e0: 2020 2020 2020 5f69 735f 6c69 6e6b 203d        _is_link =
-0000c7f0: 206c 656e 286e 2e63 6869 6c64 7265 6e29   len(n.children)
-0000c800: 203d 3d20 3120 616e 6420 6c65 6e28 6e2e   == 1 and len(n.
-0000c810: 7061 7265 6e74 7329 203c 3d20 310a 2020  parents) <= 1.  
-0000c820: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000c830: 205f 6973 5f6c 696e 6b0a 0a20 2020 2020   _is_link..     
-0000c840: 2020 2063 6f75 6e74 6572 3a20 696e 7420     counter: int 
-0000c850: 3d20 300a 0a20 2020 2020 2020 2064 6566  = 0..        def
-0000c860: 205f 6368 6169 6e28 633a 206c 6973 745b   _chain(c: list[
-0000c870: 4e6f 6465 5d2c 2065 6e64 3a20 4e6f 6465  Node], end: Node
-0000c880: 2920 2d3e 206c 6973 745b 4e6f 6465 5d3a  ) -> list[Node]:
-0000c890: 0a20 2020 2020 2020 2020 2020 206e 6f6e  .            non
-0000c8a0: 6c6f 6361 6c20 636f 756e 7465 720a 0a20  local counter.. 
-0000c8b0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0000c8c0: 4f20 4578 7065 7269 6d65 6e74 2077 6974  O Experiment wit
-0000c8d0: 6820 6e6f 7420 616c 7761 7973 2066 7573  h not always fus
-0000c8e0: 696e 6720 7468 6973 2069 6e74 6f20 7468  ing this into th
-0000c8f0: 6520 636f 6e73 756d 6572 202d 2d20 7468  e consumer -- th
-0000c900: 6572 6520 636f 756c 6420 6265 2061 6e0a  ere could be an.
-0000c910: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000c920: 696e 7465 7265 7374 696e 6720 6d69 6e63  interesting minc
-0000c930: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
-0000c940: 204e 4f54 4520 496e 2074 6869 7320 6361   NOTE In this ca
-0000c950: 7365 2074 6865 2063 6861 696e 2063 616e  se the chain can
-0000c960: 6e6f 7420 6265 2065 7874 656e 6465 642c  not be extended,
-0000c970: 2061 6e64 2069 7473 206f 7269 6769 6e20   and its origin 
-0000c980: 6973 2069 6e70 7574 2074 6f20 7468 6520  is input to the 
-0000c990: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-0000c9a0: 2020 2020 2023 2020 2073 6f20 7468 6973       #   so this
-0000c9b0: 206a 7573 7420 6675 7365 7320 6974 2069   just fuses it i
-0000c9c0: 6e74 6f20 7468 6520 636f 6e73 756d 6572  nto the consumer
-0000c9d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000c9e0: 6c65 6e28 656e 642e 7061 7265 6e74 7329  len(end.parents)
-0000c9f0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-0000ca00: 2020 2020 2020 2066 6f72 206e 2069 6e20         for n in 
-0000ca10: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
-0000ca20: 2020 2020 2020 206e 2e6e 756d 6265 7220         n.number 
-0000ca30: 3d20 636f 756e 7465 720a 2020 2020 2020  = counter.      
-0000ca40: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0000ca50: 756e 7465 7220 2b3d 2031 0a20 2020 2020  unter += 1.     
-0000ca60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000ca70: 6e20 5b5d 0a0a 2020 2020 2020 2020 2020  n []..          
-0000ca80: 2020 2320 4e4f 5445 206c 656e 2865 6e64    # NOTE len(end
-0000ca90: 2e70 6172 656e 7473 2920 3d3d 2031 206f  .parents) == 1 o
-0000caa0: 6e20 7468 6973 2070 6174 680a 2020 2020  n this path.    
-0000cab0: 2020 2020 2020 2020 2870 6172 656e 742c          (parent,
-0000cac0: 2920 3d20 656e 642e 7061 7265 6e74 730a  ) = end.parents.
-0000cad0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-0000cae0: 7874 656e 6473 2074 6865 2063 6861 696e  xtends the chain
-0000caf0: 2069 6620 7468 6520 7061 7265 6e74 2069   if the parent i
-0000cb00: 7320 6120 6c69 6e6b 0a20 2020 2020 2020  s a link.       
-0000cb10: 2020 2020 2069 6620 6973 5f6c 696e 6b28       if is_link(
-0000cb20: 7061 7265 6e74 293a 0a20 2020 2020 2020  parent):.       
-0000cb30: 2020 2020 2020 2020 2063 2e61 7070 656e           c.appen
-0000cb40: 6428 7061 7265 6e74 290a 2020 2020 2020  d(parent).      
-0000cb50: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000cb60: 205f 6368 6169 6e28 632c 2070 6172 656e   _chain(c, paren
-0000cb70: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-0000cb80: 2320 4e4f 5445 2049 6e20 7468 6973 2063  # NOTE In this c
-0000cb90: 6173 6520 7468 6520 6368 6169 6e20 6861  ase the chain ha
-0000cba0: 7320 6120 7061 7265 6e74 2074 6861 7420  s a parent that 
-0000cbb0: 6973 206e 6f74 2061 206c 696e 6b0a 2020  is not a link.  
-0000cbc0: 2020 2020 2020 2020 2020 2320 4669 6e64            # Find
-0000cbd0: 7320 7468 6520 6d69 6e63 7574 0a20 2020  s the mincut.   
-0000cbe0: 2020 2020 2020 2020 206d 696e 6375 745f           mincut_
-0000cbf0: 6964 783a 2069 6e74 203d 206c 656e 2863  idx: int = len(c
-0000cc00: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
-0000cc10: 6e5f 6d65 6d6f 7279 5f75 7361 6765 3a20  n_memory_usage: 
-0000cc20: 696e 7420 3d20 6d65 6d6f 7279 5f75 7365  int = memory_use
-0000cc30: 6428 7061 7265 6e74 2e62 7379 6d2e 6f75  d(parent.bsym.ou
-0000cc40: 7470 7574 290a 0a20 2020 2020 2020 2020  tput)..         
-0000cc50: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
-0000cc60: 2065 6e75 6d65 7261 7465 2863 293a 0a20   enumerate(c):. 
-0000cc70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000cc80: 656d 203d 206d 656d 6f72 795f 7573 6564  em = memory_used
-0000cc90: 286e 2e62 7379 6d2e 6f75 7470 7574 290a  (n.bsym.output).
-0000cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccb0: 6966 206d 656d 203c 206d 696e 5f6d 656d  if mem < min_mem
-0000ccc0: 6f72 795f 7573 6167 653a 0a20 2020 2020  ory_usage:.     
-0000ccd0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000cce0: 696e 6375 745f 6964 7820 3d20 6964 780a  incut_idx = idx.
-0000ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd00: 2020 2020 6d69 6e5f 6d65 6d6f 7279 5f75      min_memory_u
-0000cd10: 7361 6765 203d 206d 656d 0a0a 2020 2020  sage = mem..    
-0000cd20: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
-0000cd30: 206e 2069 6e20 656e 756d 6572 6174 6528   n in enumerate(
-0000cd40: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
-0000cd50: 2020 2020 6966 2069 6478 203c 206d 696e      if idx < min
-0000cd60: 6375 745f 6964 783a 0a20 2020 2020 2020  cut_idx:.       
-0000cd70: 2020 2020 2020 2020 2020 2020 206e 2e6e               n.n
-0000cd80: 756d 6265 7220 3d20 636f 756e 7465 720a  umber = counter.
-0000cd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cda0: 2020 2020 636f 756e 7465 7220 2b3d 2031      counter += 1
-0000cdb0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000cdc0: 5265 7475 726e 7320 7468 6520 7072 6f64  Returns the prod
-0000cdd0: 7563 6572 2d73 6964 6520 6368 6169 6e20  ucer-side chain 
-0000cde0: 6375 7420 6966 2069 7420 6578 6973 7473  cut if it exists
-0000cdf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000ce00: 6d69 6e63 7574 5f69 6478 203c 206c 656e  mincut_idx < len
-0000ce10: 2863 293a 0a20 2020 2020 2020 2020 2020  (c):.           
-0000ce20: 2020 2020 2072 6574 7572 6e20 5b63 5b6d       return [c[m
-0000ce30: 696e 6375 745f 6964 785d 5d0a 2020 2020  incut_idx]].    
-0000ce40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000ce50: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0000ce60: 7365 7274 206d 696e 6375 745f 6964 7820  sert mincut_idx 
-0000ce70: 3d3d 206c 656e 2863 290a 2020 2020 2020  == len(c).      
-0000ce80: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000ce90: 2065 6e64 2e70 6172 656e 7473 0a0a 2020   end.parents..  
-0000cea0: 2020 2020 2020 6465 6620 6368 6169 6e5f        def chain_
-0000ceb0: 6f75 7428 6e3a 204e 6f64 652c 2073 7461  out(n: Node, sta
-0000cec0: 636b 3a20 6c69 7374 5b4e 6f64 655d 2920  ck: list[Node]) 
-0000ced0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0000cee0: 2020 2020 2023 2053 686f 7274 2d63 6972       # Short-cir
-0000cef0: 6375 6974 7320 6966 2074 6865 206f 7269  cuits if the ori
-0000cf00: 6769 6e61 6c20 6e6f 6465 206e 2063 616e  ginal node n can
-0000cf10: 6e6f 7420 6265 2070 6172 7420 6f66 2061  not be part of a
-0000cf20: 2063 6861 696e 0a20 2020 2020 2020 2020   chain.         
-0000cf30: 2020 2069 6620 6e6f 7420 6973 5f6c 696e     if not is_lin
-0000cf40: 6b28 6e29 3a0a 2020 2020 2020 2020 2020  k(n):.          
-0000cf50: 2020 2020 2020 7374 6163 6b2e 6170 7065        stack.appe
-0000cf60: 6e64 286e 290a 2020 2020 2020 2020 2020  nd(n).          
-0000cf70: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-0000cf80: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-0000cf90: 2069 735f 6c69 6e6b 286e 2920 3d3d 2054   is_link(n) == T
-0000cfa0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0000cfb0: 706f 7374 5f63 6861 696e 3a20 6c69 7374  post_chain: list
-0000cfc0: 5b4e 6f64 655d 203d 205f 6368 6169 6e28  [Node] = _chain(
-0000cfd0: 5b6e 5d2c 206e 290a 0a20 2020 2020 2020  [n], n)..       
-0000cfe0: 2020 2020 2066 6f72 2070 6320 696e 2070       for pc in p
-0000cff0: 6f73 745f 6368 6169 6e3a 0a20 2020 2020  ost_chain:.     
-0000d000: 2020 2020 2020 2020 2020 2073 7461 636b             stack
-0000d010: 2e61 7070 656e 6428 7063 290a 0a20 2020  .append(pc)..   
-0000d020: 2020 2020 2073 7461 636b 3a20 6c69 7374       stack: list
-0000d030: 5b4e 6f64 655d 203d 205b 6c65 6166 5d0a  [Node] = [leaf].
-0000d040: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
-0000d050: 6e28 7374 6163 6b29 203e 2030 3a0a 2020  n(stack) > 0:.  
-0000d060: 2020 2020 2020 2020 2020 6e3a 204e 6f64            n: Nod
-0000d070: 6520 3d20 7374 6163 6b2e 706f 7028 290a  e = stack.pop().
-0000d080: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000d090: 6e2e 6e75 6d62 6572 2069 7320 6e6f 7420  n.number is not 
-0000d0a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000d0b0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0000d0c0: 2020 2020 2020 2020 2020 2020 6e2e 6e75              n.nu
-0000d0d0: 6d62 6572 203d 2063 6f75 6e74 6572 0a20  mber = counter. 
-0000d0e0: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
-0000d0f0: 6572 202b 3d20 310a 0a20 2020 2020 2020  er += 1..       
-0000d100: 2020 2020 2066 6f72 2070 2069 6e20 6e2e       for p in n.
-0000d110: 7061 7265 6e74 733a 0a20 2020 2020 2020  parents:.       
-0000d120: 2020 2020 2020 2020 2063 6861 696e 5f6f           chain_o
-0000d130: 7574 2870 2c20 7374 6163 6b29 0a0a 2020  ut(p, stack)..  
-0000d140: 2020 2020 2020 6465 6620 5f73 656c 6563        def _selec
-0000d150: 746f 7228 656c 6967 6962 6c65 5f6e 6f64  tor(eligible_nod
-0000d160: 6573 3a20 6c69 7374 5b4e 6f64 655d 2920  es: list[Node]) 
-0000d170: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-0000d180: 2020 2020 6d69 6e5f 6964 783a 2069 6e74      min_idx: int
-0000d190: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-0000d1a0: 206d 696e 5f6e 756d 6265 723a 2069 6e74   min_number: int
-0000d1b0: 203d 2065 6c69 6769 626c 655f 6e6f 6465   = eligible_node
-0000d1c0: 735b 305d 2e6e 756d 6265 720a 0a20 2020  s[0].number..   
-0000d1d0: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
-0000d1e0: 416c 7468 6f75 6768 2077 6527 7665 2061  Although we've a
-0000d1f0: 6c72 6561 6479 2070 726f 6365 7373 6564  lready processed
-0000d200: 2074 6865 2066 6972 7374 2065 6c65 6d65   the first eleme
-0000d210: 6e74 2068 6572 652c 2074 6869 7320 7374  nt here, this st
-0000d220: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
-0000d230: 2320 2020 656e 756d 6572 6174 6573 2074  #   enumerates t
-0000d240: 6865 2065 6e74 6972 6520 6c69 7374 2063  he entire list c
-0000d250: 2074 6f20 616c 6967 6e20 7468 6520 656e   to align the en
-0000d260: 756d 6572 6174 696f 6e20 6964 7820 7072  umeration idx pr
-0000d270: 6f70 6572 6c79 0a20 2020 2020 2020 2020  operly.         
-0000d280: 2020 2066 6f72 2069 6478 2c20 6e20 696e     for idx, n in
-0000d290: 2065 6e75 6d65 7261 7465 2865 6c69 6769   enumerate(eligi
-0000d2a0: 626c 655f 6e6f 6465 7329 3a0a 2020 2020  ble_nodes):.    
-0000d2b0: 2020 2020 2020 2020 2020 2020 6368 6563              chec
-0000d2c0: 6b28 6e2e 6e75 6d62 6572 2069 7320 6e6f  k(n.number is no
-0000d2d0: 7420 4e6f 6e65 2c20 6c61 6d62 6461 3a20  t None, lambda: 
-0000d2e0: 6622 4578 7065 6374 6564 2065 6163 6820  f"Expected each 
-0000d2f0: 6e6f 6465 2074 6f20 6265 206e 756d 6265  node to be numbe
-0000d300: 7265 642c 2062 7574 207b 6e7d 2077 6173  red, but {n} was
-0000d310: 206e 6f74 2229 0a0a 2020 2020 2020 2020   not")..        
-0000d320: 2020 2020 2020 2020 6966 206e 2e6e 756d          if n.num
-0000d330: 6265 7220 3c20 6d69 6e5f 6e75 6d62 6572  ber < min_number
-0000d340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000d350: 2020 2020 2020 6d69 6e5f 6964 7820 3d20        min_idx = 
-0000d360: 6964 780a 2020 2020 2020 2020 2020 2020  idx.            
-0000d370: 2020 2020 2020 2020 6d69 6e5f 6e75 6d62          min_numb
-0000d380: 6572 203d 206e 2e6e 756d 6265 720a 0a20  er = n.number.. 
-0000d390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d3a0: 6e20 6d69 6e5f 6964 780a 0a20 2020 2020  n min_idx..     
-0000d3b0: 2020 2073 6f72 7465 645f 6273 796d 7320     sorted_bsyms 
-0000d3c0: 3d20 746f 706f 736f 7274 5f62 7379 6d5f  = toposort_bsym_
-0000d3d0: 6461 6728 6c65 6176 6573 2c20 746f 706f  dag(leaves, topo
-0000d3e0: 736f 7274 5f6f 7264 6572 3d54 4f50 4f53  sort_order=TOPOS
-0000d3f0: 4f52 545f 4f52 4445 522e 424f 5454 4f4d  ORT_ORDER.BOTTOM
-0000d400: 5f55 502c 2073 656c 6563 746f 723d 5f73  _UP, selector=_s
-0000d410: 656c 6563 746f 7229 0a20 2020 2020 2020  elector).       
-0000d420: 2067 7261 6474 7263 2e62 6f75 6e64 5f73   gradtrc.bound_s
-0000d430: 796d 626f 6c73 203d 2073 6f72 7465 645f  ymbols = sorted_
-0000d440: 6273 796d 730a 2020 2020 2020 2020 6772  bsyms.        gr
-0000d450: 6164 7472 6320 3d20 6463 6528 6772 6164  adtrc = dce(grad
-0000d460: 7472 6329 0a0a 2020 2020 2020 2020 2320  trc)..        # 
-0000d470: 544f 444f 2043 6f6e 7369 6465 7220 686f  TODO Consider ho
-0000d480: 7720 746f 2068 616e 646c 6520 6772 6164  w to handle grad
-0000d490: 2077 2e72 2e74 2e20 6f6e 6c79 2073 6f6d   w.r.t. only som
-0000d4a0: 6520 6f75 7470 7574 7320 2d2d 2073 686f  e outputs -- sho
-0000d4b0: 756c 6420 616c 6c20 6772 6164 0a20 2020  uld all grad.   
-0000d4c0: 2020 2020 2023 2020 206f 7065 7261 7469       #   operati
-0000d4d0: 6f6e 7320 7573 696e 6720 7468 6520 6f74  ons using the ot
-0000d4e0: 6865 7220 6f75 7470 7574 2062 6520 7265  her output be re
-0000d4f0: 6d6f 7665 643f 2057 6861 7420 6b69 6e64  moved? What kind
-0000d500: 206f 6620 6173 7375 6d70 7469 6f6e 2064   of assumption d
-0000d510: 6f65 7320 7468 6174 0a20 2020 2020 2020  oes that.       
-0000d520: 2023 2020 206d 616b 6520 6162 6f75 7420   #   make about 
-0000d530: 7468 6520 6772 6164 2073 7472 7563 7475  the grad structu
-0000d540: 7265 3f20 5072 6f62 6162 6c79 2073 6f6d  re? Probably som
-0000d550: 6520 6b69 6e64 206f 6620 696e 6465 7065  e kind of indepe
-0000d560: 6e64 656e 6365 2061 7373 756d 7074 696f  ndence assumptio
-0000d570: 6e3f 2041 7265 0a20 2020 2020 2020 2023  n? Are.        #
-0000d580: 2020 2074 6865 7265 2070 7261 6374 6963     there practic
-0000d590: 616c 2065 7861 6d70 6c65 7320 7768 6572  al examples wher
-0000d5a0: 6520 7468 6174 2773 2061 6e20 6973 7375  e that's an issu
-0000d5b0: 653f 0a0a 2020 2020 2020 2020 656e 645f  e?..        end_
-0000d5c0: 7469 6d65 5f6e 7320 3d20 7469 6d65 2e74  time_ns = time.t
-0000d5d0: 696d 655f 6e73 2829 0a20 2020 2020 2020  ime_ns().       
-0000d5e0: 2065 6c61 7073 6564 5f74 696d 655f 6e73   elapsed_time_ns
-0000d5f0: 203d 2065 6e64 5f74 696d 655f 6e73 202d   = end_time_ns -
-0000d600: 2073 7461 7274 5f74 696d 655f 6e73 0a20   start_time_ns. 
-0000d610: 2020 2020 2020 2065 6c61 7073 6564 5f74         elapsed_t
-0000d620: 696d 655f 6d69 6c6c 6973 203d 2065 6c61  ime_millis = ela
-0000d630: 7073 6564 5f74 696d 655f 6e73 202f 2f20  psed_time_ns // 
-0000d640: 3130 3030 3030 300a 2020 2020 2020 2020  1000000.        
-0000d650: 6772 6164 7472 632e 7365 745f 7072 6f76  gradtrc.set_prov
-0000d660: 656e 616e 6365 2854 7261 6365 5072 6f76  enance(TraceProv
-0000d670: 656e 616e 6365 2866 2247 7261 6420 2874  enance(f"Grad (t
-0000d680: 6f6f 6b20 7b65 6c61 7073 6564 5f74 696d  ook {elapsed_tim
-0000d690: 655f 6d69 6c6c 6973 7d20 6d69 6c6c 6973  e_millis} millis
-0000d6a0: 6563 6f6e 6473 2922 2929 0a0a 2020 2020  econds)"))..    
-0000d6b0: 2020 2020 7265 7475 726e 2067 7261 6474      return gradt
-0000d6c0: 7263 0a0a 2020 2020 2320 4e4f 5445 2054  rc..    # NOTE T
-0000d6d0: 6869 7320 6973 2061 206b 6c75 6467 6520  his is a kludge 
-0000d6e0: 746f 2069 6e64 6963 6174 6520 7468 6174  to indicate that
-0000d6f0: 2077 6520 7368 6f75 6c64 6e27 7420 7573   we shouldn't us
-0000d700: 6520 5079 546f 7263 6827 7320 6175 746f  e PyTorch's auto
-0000d710: 6772 6164 2062 6563 6175 7365 0a20 2020  grad because.   
-0000d720: 2023 2020 2077 6527 7265 2075 7369 6e67   #   we're using
-0000d730: 206f 7572 206f 776e 2061 7574 6f67 7261   our own autogra
-0000d740: 6420 7472 616e 7366 6f72 6d0a 2020 2020  d transform.    
-0000d750: 6366 6e2e 5f75 7369 6e67 5f67 7261 645f  cfn._using_grad_
-0000d760: 7472 616e 7366 6f72 6d20 3d20 5472 7565  transform = True
-0000d770: 0a0a 2020 2020 7265 7475 726e 2061 6464  ..    return add
-0000d780: 5f74 7261 6e73 666f 726d 2863 666e 2c20  _transform(cfn, 
-0000d790: 7472 616e 7366 6f72 6d3d 5f67 7261 645f  transform=_grad_
-0000d7a0: 7472 616e 7366 6f72 6d2c 2064 6973 6162  transform, disab
-0000d7b0: 6c65 5f74 6f72 6368 5f61 7574 6f67 7261  le_torch_autogra
-0000d7c0: 645f 7375 7070 6f72 743d 5472 7565 290a  d_support=True).
-0000d7d0: 0a0a 6465 6620 6772 6164 280a 2020 2020  ..def grad(.    
-0000d7e0: 6366 6e2c 0a29 202d 3e20 4361 6c6c 6162  cfn,.) -> Callab
-0000d7f0: 6c65 3a0a 2020 2020 6465 6620 6772 6164  le:.    def grad
-0000d800: 2866 756e 6329 3a0a 0a20 2020 2020 2020  (func):..       
-0000d810: 2040 7772 6170 7328 6675 6e63 290a 2020   @wraps(func).  
-0000d820: 2020 2020 2020 6465 6620 6772 6164 5f66        def grad_f
-0000d830: 756e 6328 2a61 7267 732c 202a 2a6b 7761  unc(*args, **kwa
-0000d840: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
-0000d850: 2020 5f2c 2067 7261 6473 203d 2076 616c    _, grads = val
-0000d860: 7565 5f61 6e64 5f67 7261 6428 6675 6e63  ue_and_grad(func
-0000d870: 2928 2a61 7267 732c 202a 2a6b 7761 7267  )(*args, **kwarg
-0000d880: 7329 0a20 2020 2020 2020 2020 2020 2067  s).            g
-0000d890: 7261 6473 203d 2074 7265 655f 666c 6174  rads = tree_flat
-0000d8a0: 7465 6e28 6772 6164 7329 5b30 5d0a 2020  ten(grads)[0].  
-0000d8b0: 2020 2020 2020 2020 2020 6772 6164 7320            grads 
-0000d8c0: 3d20 5b67 2066 6f72 2067 2069 6e20 6772  = [g for g in gr
-0000d8d0: 6164 7320 6966 2067 2069 7320 6e6f 7420  ads if g is not 
-0000d8e0: 4e6f 6e65 5d0a 2020 2020 2020 2020 2020  None].          
-0000d8f0: 2020 7265 7475 726e 2067 7261 6473 0a0a    return grads..
-0000d900: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0000d910: 7261 645f 6675 6e63 0a0a 2020 2020 6465  rad_func..    de
-0000d920: 6620 5f67 7261 645f 7472 616e 7366 6f72  f _grad_transfor
-0000d930: 6d28 7472 633a 2054 7261 6365 2c20 2a2c  m(trc: Trace, *,
-0000d940: 2065 7865 6375 746f 7273 5f6c 6973 743a   executors_list:
-0000d950: 2053 6571 7565 6e63 655b 416e 795d 2920   Sequence[Any]) 
-0000d960: 2d3e 2054 7261 6365 3a0a 2020 2020 2020  -> Trace:.      
-0000d970: 2020 2320 5573 696e 6720 7472 632e 7079    # Using trc.py
-0000d980: 7468 6f6e 5f63 616c 6c61 626c 6528 2920  thon_callable() 
-0000d990: 6d61 6b65 7320 6974 2069 6d70 6f73 7369  makes it impossi
-0000d9a0: 626c 6520 746f 2072 6574 7261 6365 2074  ble to retrace t
-0000d9b0: 6865 0a20 2020 2020 2020 2023 2066 756e  he.        # fun
-0000d9c0: 6374 696f 6e20 6265 6361 7573 6520 7468  ction because th
-0000d9d0: 6520 7079 7468 6f6e 5f63 616c 6c61 626c  e python_callabl
-0000d9e0: 6520 7573 6573 2070 7974 686f 6e5f 6374  e uses python_ct
-0000d9f0: 7820 7768 6963 6820 7265 706c 6163 6573  x which replaces
-0000da00: 0a20 2020 2020 2020 2023 2073 796d 626f  .        # symbo
-0000da10: 6c20 6f63 6375 7272 656e 6365 7320 7769  l occurrences wi
-0000da20: 7468 2069 7473 2073 796d 626f 6c2e 5f63  th its symbol._c
-0000da30: 616c 6c5f 6374 7820 6675 6e63 7469 6f6e  all_ctx function
-0000da40: 0a20 2020 2020 2020 2040 7772 6170 7328  .        @wraps(
-0000da50: 7472 632e 7079 7468 6f6e 5f63 616c 6c61  trc.python_calla
-0000da60: 626c 6528 2929 0a20 2020 2020 2020 2064  ble()).        d
-0000da70: 6566 2070 7974 686f 6e5f 6361 6c6c 6162  ef python_callab
-0000da80: 6c65 282a 6172 6773 2c20 2a2a 6b77 6172  le(*args, **kwar
-0000da90: 6773 293a 0a20 2020 2020 2020 2020 2020  gs):.           
-0000daa0: 2072 6574 7572 6e20 6576 616c 5f74 7261   return eval_tra
-0000dab0: 6365 2874 7263 2c20 2a61 7267 732c 202a  ce(trc, *args, *
-0000dac0: 2a6b 7761 7267 7329 0a0a 2020 2020 2020  *kwargs)..      
-0000dad0: 2020 6772 6164 7472 6320 3d20 636f 6e73    gradtrc = cons
-0000dae0: 7472 7563 745f 7472 6163 6528 2928 6772  truct_trace()(gr
-0000daf0: 6164 2870 7974 686f 6e5f 6361 6c6c 6162  ad(python_callab
-0000db00: 6c65 292c 202a 7472 632e 6172 6773 2c20  le), *trc.args, 
-0000db10: 2a2a 7472 632e 6b77 6172 6773 290a 2020  **trc.kwargs).  
-0000db20: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
-0000db30: 6474 7263 0a0a 2020 2020 6366 6e2e 5f75  dtrc..    cfn._u
-0000db40: 7369 6e67 5f67 7261 645f 7472 616e 7366  sing_grad_transf
-0000db50: 6f72 6d20 3d20 5472 7565 0a20 2020 2072  orm = True.    r
-0000db60: 6574 7572 6e20 6164 645f 7472 616e 7366  eturn add_transf
-0000db70: 6f72 6d28 6366 6e2c 2074 7261 6e73 666f  orm(cfn, transfo
-0000db80: 726d 3d5f 6772 6164 5f74 7261 6e73 666f  rm=_grad_transfo
-0000db90: 726d 2c20 6469 7361 626c 655f 746f 7263  rm, disable_torc
-0000dba0: 685f 6175 746f 6772 6164 5f73 7570 706f  h_autograd_suppo
-0000dbb0: 7274 3d54 7275 6529 0a0a 0a63 6c61 7373  rt=True)...class
-0000dbc0: 2054 7261 6e73 666f 726d 7328 456e 756d   Transforms(Enum
-0000dbd0: 293a 0a20 2020 2049 6465 6e74 6974 794f  ):.    IdentityO
-0000dbe0: 7020 3d20 6175 746f 2829 0a20 2020 2056  p = auto().    V
-0000dbf0: 6d61 704f 7020 3d20 6175 746f 2829 0a20  mapOp = auto(). 
-0000dc00: 2020 204a 7670 4f70 203d 2061 7574 6f28     JvpOp = auto(
-0000dc10: 290a 2020 2020 566a 704f 7020 3d20 6175  ).    VjpOp = au
-0000dc20: 746f 2829 0a0a 0a40 6c72 755f 6361 6368  to()...@lru_cach
-0000dc30: 6528 6d61 7873 697a 653d 4e6f 6e65 290a  e(maxsize=None).
-0000dc40: 6465 6620 7379 6d62 6f6c 5f74 6f5f 6576  def symbol_to_ev
-0000dc50: 616c 2862 6f75 6e64 5f73 796d 626f 6c29  al(bound_symbol)
-0000dc60: 3a0a 2020 2020 2222 224d 6170 2061 2042  :.    """Map a B
-0000dc70: 6f75 6e64 5379 6d62 6f6c 2074 6f20 6120  oundSymbol to a 
-0000dc80: 6675 6e63 7469 6f6e 2074 6861 7420 6576  function that ev
-0000dc90: 616c 7561 7465 7320 6974 2e0a 0a20 2020  aluates it...   
-0000dca0: 2041 7267 733a 0a20 2020 2020 2020 2062   Args:.        b
-0000dcb0: 6f75 6e64 5f73 796d 626f 6c3a 2042 6f75  ound_symbol: Bou
-0000dcc0: 6e64 5379 6d62 6f6c 2074 6f20 6d61 700a  ndSymbol to map.
-0000dcd0: 2020 2020 2222 220a 2020 2020 2320 5379      """.    # Sy
-0000dce0: 6d62 6f6c 2069 7320 6361 6c6c 6162 6c65  mbol is callable
-0000dcf0: 0a20 2020 2072 6574 7572 6e20 626f 756e  .    return boun
-0000dd00: 645f 7379 6d62 6f6c 2e73 796d 0a0a 0a23  d_symbol.sym...#
-0000dd10: 2054 4f44 4f3a 2043 7572 7265 6e74 6c79   TODO: Currently
-0000dd20: 2077 6520 7573 6520 7472 6163 652e 6172   we use trace.ar
-0000dd30: 6773 2061 6e64 2074 7261 6365 2e6b 7761  gs and trace.kwa
-0000dd40: 7267 7320 746f 2067 6574 2074 6865 2061  rgs to get the a
-0000dd50: 7267 756d 656e 7473 0a23 204d 6179 6265  rguments.# Maybe
-0000dd60: 2077 6520 7368 6f75 6c64 2075 7365 2074   we should use t
-0000dd70: 6865 7365 2069 6e73 7465 6164 0a74 7261  hese instead.tra
-0000dd80: 6e73 666f 726d 5f73 6b69 705f 6c69 7374  nsform_skip_list
-0000dd90: 203d 2028 0a20 2020 2070 7269 6d73 2e50   = (.    prims.P
-0000dda0: 7269 6d49 4473 2e55 4e50 4143 4b5f 454d  rimIDs.UNPACK_EM
-0000ddb0: 5054 595f 4449 4354 2c0a 2020 2020 7072  PTY_DICT,.    pr
-0000ddc0: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
-0000ddd0: 434b 5f4b 4559 2c0a 2020 2020 7072 696d  CK_KEY,.    prim
-0000dde0: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
-0000ddf0: 5f53 4551 5545 4e43 452c 0a20 2020 2070  _SEQUENCE,.    p
-0000de00: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
-0000de10: 4143 4b5f 5452 4956 4941 4c2c 0a20 2020  ACK_TRIVIAL,.   
-0000de20: 2070 7269 6d73 2e50 7269 6d49 4473 2e52   prims.PrimIDs.R
-0000de30: 4554 5552 4e2c 0a29 0a0a 0a64 6566 2065  ETURN,.)...def e
-0000de40: 7661 6c5f 7472 6163 6528 7472 6163 652c  val_trace(trace,
-0000de50: 202a 6172 6773 2c20 7379 6d62 6f6c 5f6d   *args, symbol_m
-0000de60: 6170 7065 723d 7379 6d62 6f6c 5f74 6f5f  apper=symbol_to_
-0000de70: 6576 616c 2c20 7769 7468 5f65 6e76 3d46  eval, with_env=F
-0000de80: 616c 7365 2c20 2a2a 6b77 6172 6773 293a  alse, **kwargs):
-0000de90: 0a20 2020 2022 2222 4576 616c 7561 7465  .    """Evaluate
-0000dea0: 2061 2074 7261 6365 2e0a 0a20 2020 2041   a trace...    A
-0000deb0: 7267 733a 0a20 2020 2020 2020 2074 7261  rgs:.        tra
-0000dec0: 6365 3a20 7472 6163 6520 746f 2065 7661  ce: trace to eva
-0000ded0: 6c75 6174 650a 2020 2020 2020 2020 2a61  luate.        *a
-0000dee0: 7267 733a 2061 7267 756d 656e 7473 2074  rgs: arguments t
-0000def0: 6f20 6576 616c 7561 7465 2074 6865 2074  o evaluate the t
-0000df00: 7261 6365 2077 6974 680a 2020 2020 2020  race with.      
-0000df10: 2020 7379 6d62 6f6c 5f6d 6170 7065 723a    symbol_mapper:
-0000df20: 2066 756e 6374 696f 6e20 7468 6174 206d   function that m
-0000df30: 6170 7320 6120 7379 6d62 6f6c 2074 6f20  aps a symbol to 
-0000df40: 6120 6675 6e63 7469 6f6e 2074 6861 7420  a function that 
-0000df50: 6576 616c 7561 7465 7320 6974 0a20 2020  evaluates it.   
-0000df60: 2020 2020 202a 2a6b 7761 7267 733a 206b       **kwargs: k
-0000df70: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
-0000df80: 2074 6f20 6576 616c 7561 7465 2074 6865   to evaluate the
-0000df90: 2074 7261 6365 2077 6974 680a 0a20 2020   trace with..   
-0000dfa0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0000dfb0: 2020 7265 7375 6c74 206f 6620 6576 616c    result of eval
-0000dfc0: 7561 7469 6e67 2074 6865 2074 7261 6365  uating the trace
-0000dfd0: 0a20 2020 2022 2222 0a20 2020 2065 6e76  .    """.    env
-0000dfe0: 203d 207b 7d0a 0a20 2020 2064 6566 2072   = {}..    def r
-0000dff0: 6561 6428 783a 2056 6172 6961 626c 6529  ead(x: Variable)
-0000e000: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-0000e010: 6e73 7461 6e63 6528 782c 2056 6172 6961  nstance(x, Varia
-0000e020: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
-0000e030: 2020 7265 7475 726e 2065 6e76 5b78 2e6e    return env[x.n
-0000e040: 616d 655d 0a20 2020 2020 2020 2065 6c73  ame].        els
-0000e050: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000e060: 6574 7572 6e20 780a 0a20 2020 2064 6566  eturn x..    def
-0000e070: 2077 7269 7465 2876 3a20 5661 7269 6162   write(v: Variab
-0000e080: 6c65 2c20 7661 6c3a 2041 6e79 2c20 616c  le, val: Any, al
-0000e090: 6c6f 775f 6475 706c 6963 6174 6573 3d46  low_duplicates=F
-0000e0a0: 616c 7365 2920 2d3e 204e 6f6e 653a 0a20  alse) -> None:. 
-0000e0b0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0000e0c0: 696e 7374 616e 6365 2876 2c20 5661 7269  instance(v, Vari
-0000e0d0: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
-0000e0e0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0000e0f0: 2020 2320 4475 706c 6963 6174 6573 2061    # Duplicates a
-0000e100: 7265 2061 6c6c 6f77 6564 2061 6e64 206f  re allowed and o
-0000e110: 7665 7277 7269 7474 656e 0a20 2020 2020  verwritten.     
-0000e120: 2020 2069 6620 762e 6e61 6d65 2069 6e20     if v.name in 
-0000e130: 656e 763a 0a20 2020 2020 2020 2020 2020  env:.           
-0000e140: 2069 6620 616c 6c6f 775f 6475 706c 6963   if allow_duplic
-0000e150: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
-0000e160: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0000e170: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0000e180: 616c 7565 4572 726f 7228 6622 5661 7269  alueError(f"Vari
-0000e190: 6162 6c65 207b 762e 6e61 6d65 7d20 6973  able {v.name} is
-0000e1a0: 2062 6569 6e67 206f 7665 7277 7269 7474   being overwritt
-0000e1b0: 656e 2074 6869 7320 6973 206e 6f74 2061  en this is not a
-0000e1c0: 6c6c 6f77 6564 2229 0a20 2020 2020 2020  llowed").       
-0000e1d0: 2065 6e76 5b76 2e6e 616d 655d 203d 2076   env[v.name] = v
-0000e1e0: 616c 0a0a 2020 2020 7361 6665 5f6d 6170  al..    safe_map
-0000e1f0: 5f66 6c61 7428 7772 6974 652c 206c 6973  _flat(write, lis
-0000e200: 7428 7472 6163 652e 6172 6773 292c 206c  t(trace.args), l
-0000e210: 6973 7428 6172 6773 2929 0a20 2020 2073  ist(args)).    s
-0000e220: 6166 655f 6d61 705f 666c 6174 2877 7269  afe_map_flat(wri
-0000e230: 7465 2c20 6c69 7374 2874 7261 6365 2e6b  te, list(trace.k
-0000e240: 7761 7267 732e 7661 6c75 6573 2829 292c  wargs.values()),
-0000e250: 206c 6973 7428 6b77 6172 6773 2e76 616c   list(kwargs.val
-0000e260: 7565 7328 2929 290a 0a20 2020 2066 6f72  ues()))..    for
-0000e270: 2073 796d 626f 6c20 696e 2074 7261 6365   symbol in trace
-0000e280: 2e62 6f75 6e64 5f73 796d 626f 6c73 3a0a  .bound_symbols:.
-0000e290: 2020 2020 2020 2020 6966 2073 796d 626f          if symbo
-0000e2a0: 6c2e 7379 6d2e 6964 2069 6e20 7472 616e  l.sym.id in tran
-0000e2b0: 7366 6f72 6d5f 736b 6970 5f6c 6973 743a  sform_skip_list:
-0000e2c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0000e2d0: 7469 6e75 650a 2020 2020 2020 2020 6172  tinue.        ar
-0000e2e0: 6773 203d 2074 7265 655f 6d61 7028 7265  gs = tree_map(re
-0000e2f0: 6164 2c20 7379 6d62 6f6c 2e61 7267 7329  ad, symbol.args)
-0000e300: 0a20 2020 2020 2020 206b 7761 7267 7320  .        kwargs 
-0000e310: 3d20 7472 6565 5f6d 6170 2872 6561 642c  = tree_map(read,
-0000e320: 2073 796d 626f 6c2e 6b77 6172 6773 290a   symbol.kwargs).
-0000e330: 2020 2020 2020 2020 7072 696d 5f66 756e          prim_fun
-0000e340: 6320 3d20 7379 6d62 6f6c 5f6d 6170 7065  c = symbol_mappe
-0000e350: 7228 7379 6d62 6f6c 290a 2020 2020 2020  r(symbol).      
-0000e360: 2020 6966 2070 7269 6d5f 6675 6e63 2069    if prim_func i
-0000e370: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000e380: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-0000e390: 2020 2020 2072 6573 756c 7420 3d20 7072       result = pr
-0000e3a0: 696d 5f66 756e 6328 2a61 7267 732c 202a  im_func(*args, *
-0000e3b0: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-0000e3c0: 2073 6166 655f 6d61 705f 666c 6174 2877   safe_map_flat(w
-0000e3d0: 7269 7465 2c20 6c69 7374 2873 6571 7565  rite, list(seque
-0000e3e0: 6e63 6966 7928 7379 6d62 6f6c 2e6f 7574  ncify(symbol.out
-0000e3f0: 7075 7429 292c 206c 6973 7428 7365 7175  put)), list(sequ
-0000e400: 656e 6369 6679 2872 6573 756c 7429 2929  encify(result)))
-0000e410: 0a0a 2020 2020 6966 2077 6974 685f 656e  ..    if with_en
-0000e420: 763a 0a20 2020 2020 2020 2072 6574 7572  v:.        retur
-0000e430: 6e20 7472 6565 5f6d 6170 2872 6561 642c  n tree_map(read,
-0000e440: 2074 7261 6365 2e6f 7574 7075 7429 2c20   trace.output), 
-0000e450: 656e 760a 0a20 2020 2072 6574 7572 6e20  env..    return 
-0000e460: 7472 6565 5f6d 6170 2872 6561 642c 2074  tree_map(read, t
-0000e470: 7261 6365 2e6f 7574 7075 7429 0a0a 0a64  race.output)...d
-0000e480: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
-0000e490: 6c5f 6d65 7461 6675 6e63 282a 6172 6773  l_metafunc(*args
-0000e4a0: 2c20 7472 6163 653a 2054 7261 6365 2c20  , trace: Trace, 
-0000e4b0: 2a2a 6b77 6172 6773 293a 0a20 2020 2077  **kwargs):.    w
-0000e4c0: 6974 6820 6465 7461 6368 6564 5f74 7261  ith detached_tra
-0000e4d0: 6365 2829 3a0a 2020 2020 2020 2020 7265  ce():.        re
-0000e4e0: 7475 726e 2065 7661 6c5f 7472 6163 6528  turn eval_trace(
-0000e4f0: 7472 6163 652c 202a 6172 6773 2c20 2a2a  trace, *args, **
-0000e500: 6b77 6172 6773 290a 0a0a 6964 656e 7469  kwargs)...identi
-0000e510: 7479 5f63 616c 6c20 3d20 5379 6d62 6f6c  ty_call = Symbol
-0000e520: 2869 643d 5472 616e 7366 6f72 6d73 2e49  (id=Transforms.I
-0000e530: 6465 6e74 6974 794f 702c 206e 616d 653d  dentityOp, name=
-0000e540: 2269 6465 6e74 6974 795f 6361 6c6c 222c  "identity_call",
-0000e550: 206d 6574 613d 5f69 6465 6e74 6974 795f   meta=_identity_
-0000e560: 6361 6c6c 5f6d 6574 6166 756e 6329 0a0a  call_metafunc)..
-0000e570: 0a64 6566 2069 6465 6e74 6974 7928 6675  .def identity(fu
-0000e580: 6e63 293a 0a20 2020 2022 2222 4964 656e  nc):.    """Iden
-0000e590: 7469 7479 2074 7261 6e73 666f 726d 2066  tity transform f
-0000e5a0: 6f72 2061 2054 6875 6e64 6572 2066 756e  or a Thunder fun
-0000e5b0: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
-0000e5c0: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
-0000e5d0: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
-0000e5e0: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
-0000e5f0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
-0000e600: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-0000e610: 6620 7772 6170 7065 7228 2a61 7267 732c  f wrapper(*args,
-0000e620: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0000e630: 2020 2020 7472 6163 6520 3d20 636f 6e73      trace = cons
-0000e640: 7472 7563 745f 7472 6163 6528 2928 6675  truct_trace()(fu
-0000e650: 6e63 2c20 2a61 7267 732c 202a 2a6b 7761  nc, *args, **kwa
-0000e660: 7267 7329 0a20 2020 2020 2020 2072 6574  rgs).        ret
-0000e670: 7572 6e20 6964 656e 7469 7479 5f63 616c  urn identity_cal
-0000e680: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
-0000e690: 732c 2074 7261 6365 3d74 7261 6365 290a  s, trace=trace).
-0000e6a0: 0a20 2020 2072 6574 7572 6e20 7772 6170  .    return wrap
-0000e6b0: 7065 720a 0a0a 6465 6620 5f69 6465 6e74  per...def _ident
-0000e6c0: 6974 795f 6361 6c6c 5f70 7974 6f72 6368  ity_call_pytorch
-0000e6d0: 282a 6172 6773 2c20 7472 6163 653a 2054  (*args, trace: T
-0000e6e0: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
-0000e6f0: 0a20 2020 2069 6d70 6f72 7420 746f 7263  .    import torc
-0000e700: 680a 0a20 2020 2064 6566 2073 796d 626f  h..    def symbo
-0000e710: 6c5f 6d61 7070 6572 286f 7029 3a0a 2020  l_mapper(op):.  
-0000e720: 2020 2020 2020 6966 206f 702e 6f70 203d        if op.op =
-0000e730: 3d20 5472 616e 7366 6f72 6d73 2e49 6465  = Transforms.Ide
-0000e740: 6e74 6974 794f 703a 0a20 2020 2020 2020  ntityOp:.       
-0000e750: 2020 2020 2072 6574 7572 6e20 5f69 6465       return _ide
-0000e760: 6e74 6974 795f 6361 6c6c 5f70 7974 6f72  ntity_call_pytor
-0000e770: 6368 0a0a 2020 2020 2020 2020 746f 7263  ch..        torc
-0000e780: 685f 6f70 203d 206f 7073 5f74 6f5f 746f  h_op = ops_to_to
-0000e790: 7263 685f 6f70 735f 6d61 705b 6f70 2e6f  rch_ops_map[op.o
-0000e7a0: 705d 0a20 2020 2020 2020 2069 6620 6973  p].        if is
-0000e7b0: 696e 7374 616e 6365 2874 6f72 6368 5f6f  instance(torch_o
-0000e7c0: 702c 2073 7472 293a 0a20 2020 2020 2020  p, str):.       
-0000e7d0: 2020 2020 2072 6574 7572 6e20 6765 7461       return geta
-0000e7e0: 7474 7228 746f 7263 682c 2074 6f72 6368  ttr(torch, torch
-0000e7f0: 5f6f 702e 7374 7269 7028 2270 7974 6f72  _op.strip("pytor
-0000e800: 6368 2e22 2929 0a20 2020 2020 2020 2072  ch.")).        r
-0000e810: 6574 7572 6e20 746f 7263 685f 6f70 0a0a  eturn torch_op..
-0000e820: 2020 2020 7769 7468 2064 6574 6163 6865      with detache
-0000e830: 645f 7472 6163 6528 293a 0a20 2020 2020  d_trace():.     
-0000e840: 2020 2072 6574 7572 6e20 6576 616c 5f74     return eval_t
-0000e850: 7261 6365 2874 7261 6365 2c20 2a61 7267  race(trace, *arg
-0000e860: 732c 202a 2a6b 7761 7267 732c 2073 796d  s, **kwargs, sym
-0000e870: 626f 6c5f 6d61 7070 6572 3d73 796d 626f  bol_mapper=symbo
-0000e880: 6c5f 6d61 7070 6572 290a 0a0a 2320 5265  l_mapper)...# Re
-0000e890: 6769 7374 6572 2074 6865 2069 6465 6e74  gister the ident
-0000e8a0: 6974 7920 6361 6c6c 2066 6f72 2050 7954  ity call for PyT
-0000e8b0: 6f72 6368 2065 7865 6375 746f 722e 0a23  orch executor..#
-0000e8c0: 206f 7073 5f74 6f5f 746f 7263 685f 6f70   ops_to_torch_op
-0000e8d0: 735f 6d61 705b 5472 616e 7366 6f72 6d73  s_map[Transforms
-0000e8e0: 2e49 6465 6e74 6974 794f 705d 203d 205f  .IdentityOp] = _
-0000e8f0: 6964 656e 7469 7479 5f63 616c 6c5f 7079  identity_call_py
-0000e900: 746f 7263 680a 0a0a 2320 564d 4150 2074  torch...# VMAP t
-0000e910: 7261 6e73 666f 726d 0a23 202d 2d2d 2d2d  ransform.# -----
-0000e920: 2d2d 2d2d 2d2d 2d2d 0a0a 0a63 6c61 7373  --------...class
-0000e930: 204e 6f74 4d61 7070 6564 3a0a 2020 2020   NotMapped:.    
-0000e940: 2222 2252 6570 7265 7365 6e74 7320 6120  """Represents a 
-0000e950: 6e6f 6e2d 6261 7463 6865 6420 6469 6d65  non-batched dime
-0000e960: 6e73 696f 6e2e 2222 220a 0a20 2020 2064  nsion."""..    d
-0000e970: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-0000e980: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-0000e990: 6e20 226e 6f74 5f6d 6170 7065 6422 0a0a  n "not_mapped"..
-0000e9a0: 0a40 6461 7461 636c 6173 7328 6672 6f7a  .@dataclass(froz
-0000e9b0: 656e 3d54 7275 6529 0a63 6c61 7373 2042  en=True).class B
-0000e9c0: 6174 6368 6564 5661 6c75 653a 0a20 2020  atchedValue:.   
-0000e9d0: 2022 2222 4261 7463 6865 6420 7661 6c75   """Batched valu
-0000e9e0: 6520 666f 7220 7468 6520 766d 6170 2074  e for the vmap t
-0000e9f0: 7261 6e73 666f 726d 2e0a 0a20 2020 2041  ransform...    A
-0000ea00: 7474 7269 6275 7465 733a 0a20 2020 2020  ttributes:.     
-0000ea10: 2020 2076 616c 7565 3a20 4261 7463 6865     value: Batche
-0000ea20: 6420 7661 6c75 652e 0a20 2020 2020 2020  d value..       
-0000ea30: 2062 6174 6368 5f64 696d 3a20 4261 7463   batch_dim: Batc
-0000ea40: 6869 6e67 2064 696d 656e 7369 6f6e 206f  hing dimension o
-0000ea50: 7220 6e6f 745f 6d61 7070 6564 0a20 2020  r not_mapped.   
-0000ea60: 2022 2222 0a0a 2020 2020 7661 6c75 653a   """..    value:
-0000ea70: 2041 6e79 0a20 2020 2062 6174 6368 5f64   Any.    batch_d
-0000ea80: 696d 3a20 696e 7420 7c20 4e6f 744d 6170  im: int | NotMap
-0000ea90: 7065 640a 0a20 2020 2064 6566 205f 5f69  ped..    def __i
-0000eaa0: 7465 725f 5f28 7365 6c66 293a 0a20 2020  ter__(self):.   
-0000eab0: 2020 2020 2079 6965 6c64 2073 656c 662e       yield self.
-0000eac0: 7661 6c75 650a 2020 2020 2020 2020 7969  value.        yi
-0000ead0: 656c 6420 7365 6c66 2e62 6174 6368 5f64  eld self.batch_d
-0000eae0: 696d 0a0a 0a64 6566 2070 6169 725f 746f  im...def pair_to
-0000eaf0: 5f62 6174 6368 6564 5f76 616c 7565 2870  _batched_value(p
-0000eb00: 6169 7229 3a0a 2020 2020 2222 2243 6f6e  air):.    """Con
-0000eb10: 7665 7274 7320 6120 7061 6972 2074 6f20  verts a pair to 
-0000eb20: 6120 4261 7463 6865 6456 616c 7565 2e0a  a BatchedValue..
-0000eb30: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0000eb40: 2020 2070 6169 7220 2853 6571 7565 6e63     pair (Sequenc
-0000eb50: 6529 3a20 5061 6972 2074 6f20 636f 6e76  e): Pair to conv
-0000eb60: 6572 742e 0a0a 2020 2020 5265 7475 726e  ert...    Return
-0000eb70: 733a 0a20 2020 2020 2020 2042 6174 6368  s:.        Batch
-0000eb80: 6564 5661 6c75 653a 2042 6174 6368 6564  edValue: Batched
-0000eb90: 5661 6c75 6520 7265 7072 6573 656e 7461  Value representa
-0000eba0: 7469 6f6e 206f 6620 7468 6520 7061 6972  tion of the pair
-0000ebb0: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-0000ebc0: 2069 7369 6e73 7461 6e63 6528 7061 6972   isinstance(pair
-0000ebd0: 2c20 4261 7463 6865 6456 616c 7565 293a  , BatchedValue):
-0000ebe0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000ebf0: 7061 6972 0a20 2020 2065 6c73 653a 0a20  pair.    else:. 
-0000ec00: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000ec10: 696e 7374 616e 6365 2870 6169 722c 2053  instance(pair, S
-0000ec20: 6571 7565 6e63 6529 2061 6e64 206c 656e  equence) and len
-0000ec30: 2870 6169 7229 203d 3d20 320a 2020 2020  (pair) == 2.    
-0000ec40: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
-0000ec50: 6564 5661 6c75 6528 2a70 6169 7229 0a0a  edValue(*pair)..
-0000ec60: 0a64 6566 2076 6563 746f 7269 7a65 645f  .def vectorized_
-0000ec70: 6261 7463 6865 7228 7072 696d 2c20 6178  batcher(prim, ax
-0000ec80: 6973 5f73 697a 652c 2062 6174 6368 6564  is_size, batched
-0000ec90: 5f76 616c 7565 732c 202a 2a6b 7761 7267  _values, **kwarg
-0000eca0: 7329 3a0a 2020 2020 6261 7463 685f 6469  s):.    batch_di
-0000ecb0: 6d20 3d20 6261 7463 6865 645f 7661 6c75  m = batched_valu
-0000ecc0: 6573 5b30 5d2e 6261 7463 685f 6469 6d0a  es[0].batch_dim.
-0000ecd0: 2020 2020 6173 7365 7274 2061 6c6c 280a      assert all(.
-0000ece0: 2020 2020 2020 2020 6261 7463 685f 6469          batch_di
-0000ecf0: 6d20 3d3d 2062 762e 6261 7463 685f 6469  m == bv.batch_di
-0000ed00: 6d20 666f 7220 6276 2069 6e20 6261 7463  m for bv in batc
-0000ed10: 6865 645f 7661 6c75 6573 5b31 3a5d 0a20  hed_values[1:]. 
-0000ed20: 2020 2029 2c20 6622 6076 6563 746f 7269     ), f"`vectori
-0000ed30: 7a65 645f 6261 7463 6865 7260 2067 6f74  zed_batcher` got
-0000ed40: 2064 6966 6665 7265 6e74 2062 6174 6368   different batch
-0000ed50: 6564 2064 696d 656e 7369 6f6e 7320 7b5b  ed dimensions {[
-0000ed60: 6276 2e62 6174 6368 5f64 696d 2066 6f72  bv.batch_dim for
-0000ed70: 2062 7620 696e 2062 6174 6368 6564 5f76   bv in batched_v
-0000ed80: 616c 7565 735d 7d22 0a20 2020 2072 6574  alues]}".    ret
-0000ed90: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
-0000eda0: 2870 7269 6d28 2a5b 6276 2e76 616c 7565  (prim(*[bv.value
-0000edb0: 2066 6f72 2062 7620 696e 2062 6174 6368   for bv in batch
-0000edc0: 6564 5f76 616c 7565 735d 2c20 2a2a 6b77  ed_values], **kw
-0000edd0: 6172 6773 292c 2062 6174 6368 5f64 696d  args), batch_dim
-0000ede0: 290a 0a0a 6e6f 745f 6d61 7070 6564 203d  )...not_mapped =
-0000edf0: 204e 6f74 4d61 7070 6564 2829 0a0a 0a64   NotMapped()...d
-0000ee00: 6566 206d 6f76 6564 696d 2878 2c20 7372  ef movedim(x, sr
-0000ee10: 633a 2069 6e74 2c20 6473 743a 2069 6e74  c: int, dst: int
-0000ee20: 293a 0a20 2020 2070 6572 6d20 3d20 5b69  ):.    perm = [i
-0000ee30: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0000ee40: 782e 6e64 696d 2920 6966 2069 2021 3d20  x.ndim) if i != 
-0000ee50: 7372 635d 0a20 2020 2070 6572 6d2e 696e  src].    perm.in
-0000ee60: 7365 7274 2864 7374 2c20 7372 6329 0a20  sert(dst, src). 
-0000ee70: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
-0000ee80: 7472 616e 7370 6f73 6528 782c 2074 7570  transpose(x, tup
-0000ee90: 6c65 2870 6572 6d29 290a 0a0a 6465 6620  le(perm))...def 
-0000eea0: 6d6f 7665 5f62 6174 6368 5f64 696d 2861  move_batch_dim(a
-0000eeb0: 7869 735f 7369 7a65 2c20 7372 632c 2064  xis_size, src, d
-0000eec0: 7374 2c20 7829 3a0a 2020 2020 6966 2073  st, x):.    if s
-0000eed0: 7263 2069 7320 6e6f 745f 6d61 7070 6564  rc is not_mapped
-0000eee0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-0000eef0: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-0000ef00: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000ef10: 7265 7475 726e 2078 0a20 2020 2020 2020  return x.       
-0000ef20: 2074 6172 6765 745f 7368 6170 6520 3d20   target_shape = 
-0000ef30: 6c69 7374 2878 2e73 6861 7065 290a 2020  list(x.shape).  
-0000ef40: 2020 2020 2020 7461 7267 6574 5f73 6861        target_sha
-0000ef50: 7065 2e69 6e73 6572 7428 6473 742c 2061  pe.insert(dst, a
-0000ef60: 7869 735f 7369 7a65 290a 2020 2020 2020  xis_size).      
-0000ef70: 2020 6263 6173 745f 6469 6d73 203d 206c    bcast_dims = l
-0000ef80: 6973 7428 7261 6e67 6528 6c65 6e28 7461  ist(range(len(ta
-0000ef90: 7267 6574 5f73 6861 7065 2929 290a 2020  rget_shape))).  
-0000efa0: 2020 2020 2020 6263 6173 745f 6469 6d73        bcast_dims
-0000efb0: 2e70 6f70 2864 7374 290a 2020 2020 2020  .pop(dst).      
-0000efc0: 2020 7265 7475 726e 2070 7269 6d73 2e62    return prims.b
-0000efd0: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
-0000efe0: 782c 2074 6172 6765 745f 7368 6170 652c  x, target_shape,
-0000eff0: 2062 6361 7374 5f64 696d 7329 0a20 2020   bcast_dims).   
-0000f000: 2065 6c69 6620 7372 6320 3d3d 2064 7374   elif src == dst
-0000f010: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000f020: 2078 0a20 2020 2065 6c73 653a 0a20 2020   x.    else:.   
-0000f030: 2020 2020 2072 6574 7572 6e20 6d6f 7665       return move
-0000f040: 6469 6d28 782c 2073 7263 2c20 6473 7429  dim(x, src, dst)
-0000f050: 0a0a 0a64 6566 2062 696e 6172 795f 6f70  ...def binary_op
-0000f060: 5f62 6174 6368 696e 675f 7275 6c65 286f  _batching_rule(o
-0000f070: 703a 2070 7269 6d73 2e50 7269 6d49 4473  p: prims.PrimIDs
-0000f080: 2c20 6178 6973 5f73 697a 653a 2069 6e74  , axis_size: int
-0000f090: 2c20 7661 6c73 5f69 6e3a 2042 6174 6368  , vals_in: Batch
-0000f0a0: 6564 5661 6c75 6529 3a0a 2020 2020 2828  edValue):.    ((
-0000f0b0: 782c 2078 5f62 6469 6d29 2c20 2879 2c20  x, x_bdim), (y, 
-0000f0c0: 795f 6264 696d 2929 203d 2076 616c 735f  y_bdim)) = vals_
-0000f0d0: 696e 0a20 2020 2069 6620 785f 6264 696d  in.    if x_bdim
-0000f0e0: 2021 3d20 795f 6264 696d 3a0a 2020 2020   != y_bdim:.    
-0000f0f0: 2020 2020 6966 2078 5f62 6469 6d20 6973      if x_bdim is
-0000f100: 206e 6f74 5f6d 6170 7065 643a 0a20 2020   not_mapped:.   
-0000f110: 2020 2020 2020 2020 2078 203d 206d 6f76           x = mov
-0000f120: 655f 6261 7463 685f 6469 6d28 6178 6973  e_batch_dim(axis
-0000f130: 5f73 697a 652c 2078 5f62 6469 6d2c 2079  _size, x_bdim, y
-0000f140: 5f62 6469 6d2c 2078 290a 2020 2020 2020  _bdim, x).      
-0000f150: 2020 2020 2020 785f 6264 696d 203d 2079        x_bdim = y
-0000f160: 5f62 6469 6d0a 2020 2020 2020 2020 656c  _bdim.        el
-0000f170: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000f180: 7920 3d20 6d6f 7665 5f62 6174 6368 5f64  y = move_batch_d
-0000f190: 696d 2861 7869 735f 7369 7a65 2c20 795f  im(axis_size, y_
-0000f1a0: 6264 696d 2c20 785f 6264 696d 2c20 7929  bdim, x_bdim, y)
-0000f1b0: 0a20 2020 2072 6574 7572 6e20 4261 7463  .    return Batc
-0000f1c0: 6865 6456 616c 7565 286f 7028 782c 2079  hedValue(op(x, y
-0000f1d0: 292c 2078 5f62 6469 6d29 0a0a 0a64 6566  ), x_bdim)...def
-0000f1e0: 2073 696e 5f76 6d61 7028 6178 6973 5f73   sin_vmap(axis_s
-0000f1f0: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
-0000f200: 6368 6564 5661 6c75 6529 202d 3e20 4261  chedValue) -> Ba
-0000f210: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
-0000f220: 7265 7475 726e 2076 6563 746f 7269 7a65  return vectorize
-0000f230: 645f 6261 7463 6865 7228 7072 696d 732e  d_batcher(prims.
-0000f240: 7369 6e2c 2061 7869 735f 7369 7a65 2c20  sin, axis_size, 
-0000f250: 2861 2c29 290a 0a0a 6465 6620 636f 735f  (a,))...def cos_
-0000f260: 766d 6170 2861 7869 735f 7369 7a65 3a20  vmap(axis_size: 
-0000f270: 696e 742c 2061 3a20 4261 7463 6865 6456  int, a: BatchedV
-0000f280: 616c 7565 2920 2d3e 2042 6174 6368 6564  alue) -> Batched
-0000f290: 5661 6c75 653a 0a20 2020 2072 6574 7572  Value:.    retur
-0000f2a0: 6e20 7665 6374 6f72 697a 6564 5f62 6174  n vectorized_bat
-0000f2b0: 6368 6572 2870 7269 6d73 2e63 6f73 2c20  cher(prims.cos, 
-0000f2c0: 6178 6973 5f73 697a 652c 2028 612c 2929  axis_size, (a,))
-0000f2d0: 0a0a 0a64 6566 206d 756c 5f76 6d61 7028  ...def mul_vmap(
-0000f2e0: 6178 6973 5f73 697a 653a 2069 6e74 2c20  axis_size: int, 
-0000f2f0: 613a 2042 6174 6368 6564 5661 6c75 652c  a: BatchedValue,
-0000f300: 2062 3a20 4261 7463 6865 6456 616c 7565   b: BatchedValue
-0000f310: 2920 2d3e 2042 6174 6368 6564 5661 6c75  ) -> BatchedValu
-0000f320: 653a 0a20 2020 2072 6574 7572 6e20 6269  e:.    return bi
-0000f330: 6e61 7279 5f6f 705f 6261 7463 6869 6e67  nary_op_batching
-0000f340: 5f72 756c 6528 7072 696d 732e 6d75 6c2c  _rule(prims.mul,
-0000f350: 2061 7869 735f 7369 7a65 2c20 2861 2c20   axis_size, (a, 
-0000f360: 6229 290a 0a0a 6465 6620 6164 645f 766d  b))...def add_vm
-0000f370: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
-0000f380: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
-0000f390: 7565 2c20 623a 2042 6174 6368 6564 5661  ue, b: BatchedVa
-0000f3a0: 6c75 6529 202d 3e20 4261 7463 6865 6456  lue) -> BatchedV
-0000f3b0: 616c 7565 3a0a 2020 2020 7265 7475 726e  alue:.    return
-0000f3c0: 2062 696e 6172 795f 6f70 5f62 6174 6368   binary_op_batch
-0000f3d0: 696e 675f 7275 6c65 2870 7269 6d73 2e61  ing_rule(prims.a
-0000f3e0: 6464 2c20 6178 6973 5f73 697a 652c 2028  dd, axis_size, (
-0000f3f0: 612c 2062 2929 0a0a 0a64 6566 2073 756d  a, b))...def sum
-0000f400: 5f76 6d61 7028 6178 6973 5f73 697a 653a  _vmap(axis_size:
-0000f410: 2069 6e74 2c20 613a 2042 6174 6368 6564   int, a: Batched
-0000f420: 5661 6c75 652c 2064 696d 733a 2053 6571  Value, dims: Seq
-0000f430: 7565 6e63 655b 696e 745d 2c20 2a2a 6b77  uence[int], **kw
-0000f440: 6172 6773 2920 2d3e 2042 6174 6368 6564  args) -> Batched
-0000f450: 5661 6c75 653a 0a20 2020 2062 6469 6d20  Value:.    bdim 
-0000f460: 3d20 612e 6261 7463 685f 6469 6d0a 2020  = a.batch_dim.  
-0000f470: 2020 2320 544f 444f 3a20 7265 6d6f 7665    # TODO: remove
-0000f480: 2074 6869 7320 7768 656e 2064 696d 7320   this when dims 
-0000f490: 6265 636f 6d65 7320 6120 6d61 6e64 6174  becomes a mandat
-0000f4a0: 6f72 7920 6b77 6172 670a 2020 2020 6966  ory kwarg.    if
-0000f4b0: 206c 656e 2864 696d 7329 203e 2030 3a0a   len(dims) > 0:.
-0000f4c0: 2020 2020 2020 2020 6469 6d73 2c20 5f20          dims, _ 
-0000f4d0: 3d20 7361 6665 5f7a 6970 282a 6469 6d73  = safe_zip(*dims
-0000f4e0: 290a 2020 2020 6469 6d73 5f62 6566 6f72  ).    dims_befor
-0000f4f0: 6520 3d20 7475 706c 6528 656c 2066 6f72  e = tuple(el for
-0000f500: 2065 6c20 696e 2064 696d 7320 6966 2065   el in dims if e
-0000f510: 6c20 3c20 6264 696d 290a 2020 2020 6469  l < bdim).    di
-0000f520: 6d73 5f61 6674 6572 203d 2074 7570 6c65  ms_after = tuple
-0000f530: 2865 6c20 2b20 3120 666f 7220 656c 2069  (el + 1 for el i
-0000f540: 6e20 6469 6d73 2069 6620 656c 203e 3d20  n dims if el >= 
-0000f550: 6264 696d 290a 2020 2020 6261 7463 6865  bdim).    batche
-0000f560: 645f 6469 6d73 203d 2064 696d 735f 6265  d_dims = dims_be
-0000f570: 666f 7265 202b 2064 696d 735f 6166 7465  fore + dims_afte
-0000f580: 720a 2020 2020 7265 7475 726e 2076 6563  r.    return vec
-0000f590: 746f 7269 7a65 645f 6261 7463 6865 7228  torized_batcher(
-0000f5a0: 7072 696d 732e 7375 6d2c 2061 7869 735f  prims.sum, axis_
-0000f5b0: 7369 7a65 2c20 2861 2c29 2c20 6469 6d73  size, (a,), dims
-0000f5c0: 3d62 6174 6368 6564 5f64 696d 732c 202a  =batched_dims, *
-0000f5d0: 2a6b 7761 7267 7329 0a0a 0a23 2054 4f44  *kwargs)...# TOD
-0000f5e0: 4f3a 2050 6c65 6173 6520 7465 7374 2074  O: Please test t
-0000f5f0: 6869 7320 6578 7465 6e73 6976 656c 790a  his extensively.
-0000f600: 6465 6620 6272 6f61 6463 6173 745f 696e  def broadcast_in
-0000f610: 5f64 696d 5f76 6d61 7028 0a20 2020 2061  _dim_vmap(.    a
-0000f620: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
-0000f630: 3a20 4261 7463 6865 6456 616c 7565 2c20  : BatchedValue, 
-0000f640: 7368 6170 653a 2053 6571 7565 6e63 655b  shape: Sequence[
-0000f650: 4261 7463 6865 6456 616c 7565 5d2c 2062  BatchedValue], b
-0000f660: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000f670: 6f6e 733a 2053 6571 7565 6e63 655b 4261  ons: Sequence[Ba
-0000f680: 7463 6865 6456 616c 7565 5d0a 2920 2d3e  tchedValue].) ->
-0000f690: 2042 6174 6368 6564 5661 6c75 653a 0a20   BatchedValue:. 
-0000f6a0: 2020 2062 6469 6d20 3d20 612e 6261 7463     bdim = a.batc
-0000f6b0: 685f 6469 6d0a 2020 2020 2320 544f 444f  h_dim.    # TODO
-0000f6c0: 3a20 7265 6d6f 7665 2074 6869 7320 7768  : remove this wh
-0000f6d0: 656e 2073 6861 7065 2061 6e64 2062 726f  en shape and bro
-0000f6e0: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-0000f6f0: 7320 6265 636f 6d65 206d 616e 6461 746f  s become mandato
-0000f700: 7279 206b 7761 7267 730a 2020 2020 7368  ry kwargs.    sh
-0000f710: 6170 652c 205f 203d 2073 6166 655f 7a69  ape, _ = safe_zi
-0000f720: 7028 2a73 6861 7065 290a 2020 2020 6966  p(*shape).    if
-0000f730: 206c 656e 2862 726f 6164 6361 7374 5f64   len(broadcast_d
-0000f740: 696d 656e 7369 6f6e 7329 203e 2030 3a0a  imensions) > 0:.
-0000f750: 2020 2020 2020 2020 6272 6f61 6463 6173          broadcas
-0000f760: 745f 6469 6d65 6e73 696f 6e73 2c20 5f20  t_dimensions, _ 
-0000f770: 3d20 7361 6665 5f7a 6970 282a 6272 6f61  = safe_zip(*broa
-0000f780: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-0000f790: 290a 2020 2020 6966 2062 6469 6d20 6973  ).    if bdim is
-0000f7a0: 206e 6f74 5f6d 6170 7065 643a 0a20 2020   not_mapped:.   
-0000f7b0: 2020 2020 2072 6574 7572 6e20 4261 7463       return Batc
-0000f7c0: 6865 6456 616c 7565 2870 7269 6d73 2e62  hedValue(prims.b
-0000f7d0: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
-0000f7e0: 612e 7661 6c75 652c 2073 6861 7065 2c20  a.value, shape, 
-0000f7f0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000f800: 696f 6e73 292c 2062 6469 6d29 0a20 2020  ions), bdim).   
-0000f810: 2065 6c73 653a 0a20 2020 2020 2020 206e   else:.        n
-0000f820: 6577 5f62 6469 6d20 3d20 6264 696d 202b  ew_bdim = bdim +
-0000f830: 2073 756d 2831 2066 6f72 2064 696d 2069   sum(1 for dim i
-0000f840: 6e20 6272 6f61 6463 6173 745f 6469 6d65  n broadcast_dime
-0000f850: 6e73 696f 6e73 2069 6620 6469 6d20 3c20  nsions if dim < 
-0000f860: 6264 696d 290a 2020 2020 2020 2020 6e65  bdim).        ne
-0000f870: 775f 7368 6170 6520 3d20 6c69 7374 2873  w_shape = list(s
-0000f880: 6861 7065 290a 2020 2020 2020 2020 6e65  hape).        ne
-0000f890: 775f 7368 6170 652e 696e 7365 7274 286e  w_shape.insert(n
-0000f8a0: 6577 5f62 6469 6d2c 2061 7869 735f 7369  ew_bdim, axis_si
-0000f8b0: 7a65 290a 2020 2020 2020 2020 6e65 775f  ze).        new_
-0000f8c0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000f8d0: 696f 6e73 203d 2028 302c 2920 2b20 7475  ions = (0,) + tu
-0000f8e0: 706c 6528 6469 6d20 2b20 3120 6966 2064  ple(dim + 1 if d
-0000f8f0: 696d 203e 3d20 6264 696d 2065 6c73 6520  im >= bdim else 
-0000f900: 6469 6d20 666f 7220 6469 6d20 696e 2062  dim for dim in b
-0000f910: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000f920: 6f6e 7329 0a20 2020 2020 2020 2069 6620  ons).        if 
-0000f930: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000f940: 696f 6e73 203d 3d20 2829 3a0a 2020 2020  ions == ():.    
-0000f950: 2020 2020 2020 2020 6e65 775f 6272 6f61          new_broa
-0000f960: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-0000f970: 203d 2028 290a 2020 2020 2020 2020 7265   = ().        re
-0000f980: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
-0000f990: 6528 7072 696d 732e 6272 6f61 6463 6173  e(prims.broadcas
-0000f9a0: 745f 696e 5f64 696d 2861 2e76 616c 7565  t_in_dim(a.value
-0000f9b0: 2c20 6e65 775f 7368 6170 652c 206e 6577  , new_shape, new
-0000f9c0: 5f62 726f 6164 6361 7374 5f64 696d 656e  _broadcast_dimen
-0000f9d0: 7369 6f6e 7329 2c20 6e65 775f 6264 696d  sions), new_bdim
-0000f9e0: 290a 0a0a 766d 6170 5f69 6d70 6c73 3a20  )...vmap_impls: 
-0000f9f0: 6469 6374 5b70 7269 6d73 2e53 796d 626f  dict[prims.Symbo
-0000fa00: 6c2c 2043 616c 6c61 626c 655d 203d 2064  l, Callable] = d
-0000fa10: 6963 7428 290a 0a0a 6465 6620 756e 7772  ict()...def unwr
-0000fa20: 6170 5f6f 6e65 5f6c 6576 656c 5f6f 665f  ap_one_level_of_
-0000fa30: 7375 6273 796d 626f 6c73 2874 7261 6365  subsymbols(trace
-0000fa40: 293a 0a20 2020 206e 6577 5f73 796d 626f  ):.    new_symbo
-0000fa50: 6c73 5f69 7465 7220 3d20 280a 2020 2020  ls_iter = (.    
-0000fa60: 2020 2020 626f 756e 645f 7379 6d62 6f6c      bound_symbol
-0000fa70: 2e73 7562 7379 6d62 6f6c 7320 6966 206c  .subsymbols if l
-0000fa80: 656e 2862 6f75 6e64 5f73 796d 626f 6c2e  en(bound_symbol.
-0000fa90: 7375 6273 796d 626f 6c73 2920 3e20 3020  subsymbols) > 0 
-0000faa0: 656c 7365 205b 626f 756e 645f 7379 6d62  else [bound_symb
-0000fab0: 6f6c 5d0a 2020 2020 2020 2020 666f 7220  ol].        for 
-0000fac0: 626f 756e 645f 7379 6d62 6f6c 2069 6e20  bound_symbol in 
-0000fad0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0000fae0: 6f6c 730a 2020 2020 290a 2020 2020 6e65  ols.    ).    ne
-0000faf0: 775f 7379 6d62 6f6c 7320 3d20 6c69 7374  w_symbols = list
-0000fb00: 2863 6861 696e 2e66 726f 6d5f 6974 6572  (chain.from_iter
-0000fb10: 6162 6c65 286e 6577 5f73 796d 626f 6c73  able(new_symbols
-0000fb20: 5f69 7465 7229 290a 2020 2020 7472 6163  _iter)).    trac
-0000fb30: 652e 626f 756e 645f 7379 6d62 6f6c 7320  e.bound_symbols 
-0000fb40: 3d20 6e65 775f 7379 6d62 6f6c 730a 2020  = new_symbols.  
-0000fb50: 2020 7265 7475 726e 2074 7261 6365 0a0a    return trace..
-0000fb60: 0a64 6566 2064 6563 6f6d 706f 7365 645f  .def decomposed_
-0000fb70: 666e 5f76 6d61 705f 7275 6c65 2861 7869  fn_vmap_rule(axi
-0000fb80: 735f 7369 7a65 2c20 2a61 7267 732c 2066  s_size, *args, f
-0000fb90: 6e2c 202a 2a6b 7761 7267 7329 3a0a 2020  n, **kwargs):.  
-0000fba0: 2020 6172 6773 2c20 696e 5f64 696d 7320    args, in_dims 
-0000fbb0: 3d20 756e 7a69 7032 2861 7267 7329 0a20  = unzip2(args). 
-0000fbc0: 2020 2075 6e62 6174 6368 6564 5f61 7267     unbatched_arg
-0000fbd0: 7320 3d20 7472 6565 5f6d 6170 286c 616d  s = tree_map(lam
-0000fbe0: 6264 6120 783a 2072 656d 6f76 655f 6261  bda x: remove_ba
-0000fbf0: 7463 685f 6469 6d28 7829 2069 6620 6973  tch_dim(x) if is
-0000fc00: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
-0000fc10: 6f72 5072 6f78 7929 2065 6c73 6520 782c  orProxy) else x,
-0000fc20: 2061 7267 7329 0a20 2020 2074 7261 6365   args).    trace
-0000fc30: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-0000fc40: 6365 2829 2866 6e2c 202a 756e 6261 7463  ce()(fn, *unbatc
-0000fc50: 6865 645f 6172 6773 2c20 2a2a 6b77 6172  hed_args, **kwar
-0000fc60: 6773 290a 2020 2020 7472 6163 6520 3d20  gs).    trace = 
-0000fc70: 756e 7772 6170 5f6f 6e65 5f6c 6576 656c  unwrap_one_level
-0000fc80: 5f6f 665f 7375 6273 796d 626f 6c73 2874  _of_subsymbols(t
-0000fc90: 7261 6365 290a 2020 2020 6f75 7473 203d  race).    outs =
-0000fca0: 205f 766d 6170 5f63 616c 6c5f 6d65 7461   _vmap_call_meta
-0000fcb0: 6675 6e63 2846 616c 7365 2c20 6172 6773  func(False, args
-0000fcc0: 2c20 696e 5f64 696d 732c 2030 2c20 6178  , in_dims, 0, ax
-0000fcd0: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
-0000fce0: 6e5f 7472 6163 653d 7472 6163 652c 202a  n_trace=trace, *
-0000fcf0: 2a6b 7761 7267 7329 0a20 2020 2069 6620  *kwargs).    if 
-0000fd00: 6973 696e 7374 616e 6365 286f 7574 732c  isinstance(outs,
-0000fd10: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-0000fd20: 2020 2020 6f75 745f 6469 6d73 203d 2028      out_dims = (
-0000fd30: 302c 2920 2a20 6c65 6e28 6f75 7473 290a  0,) * len(outs).
-0000fd40: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000fd50: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
-0000fd60: 6261 7463 6865 645f 7661 6c75 652c 2073  batched_value, s
-0000fd70: 6166 655f 7a69 7028 6f75 7473 2c20 6f75  afe_zip(outs, ou
-0000fd80: 745f 6469 6d73 2929 0a20 2020 2072 6574  t_dims)).    ret
-0000fd90: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
-0000fda0: 286f 7574 732c 2030 290a 0a0a 766d 6170  (outs, 0)...vmap
-0000fdb0: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-0000fdc0: 6d49 4473 2e53 494e 5d20 3d20 7369 6e5f  mIDs.SIN] = sin_
-0000fdd0: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
-0000fde0: 7072 696d 732e 5072 696d 4944 732e 434f  prims.PrimIDs.CO
-0000fdf0: 535d 203d 2063 6f73 5f76 6d61 700a 766d  S] = cos_vmap.vm
-0000fe00: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
-0000fe10: 7269 6d49 4473 2e4d 554c 5d20 3d20 6d75  rimIDs.MUL] = mu
-0000fe20: 6c5f 766d 6170 0a76 6d61 705f 696d 706c  l_vmap.vmap_impl
-0000fe30: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
-0000fe40: 4144 445d 203d 2061 6464 5f76 6d61 700a  ADD] = add_vmap.
-0000fe50: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
-0000fe60: 2e50 7269 6d49 4473 2e53 554d 5d20 3d20  .PrimIDs.SUM] = 
-0000fe70: 7375 6d5f 766d 6170 0a76 6d61 705f 696d  sum_vmap.vmap_im
-0000fe80: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-0000fe90: 732e 4252 4f41 4443 4153 545f 494e 5f44  s.BROADCAST_IN_D
-0000fea0: 494d 5d20 3d20 6272 6f61 6463 6173 745f  IM] = broadcast_
-0000feb0: 696e 5f64 696d 5f76 6d61 700a 0a0a 6465  in_dim_vmap...de
-0000fec0: 6620 766d 6170 5f73 796d 626f 6c5f 6d61  f vmap_symbol_ma
-0000fed0: 7070 6572 2873 796d 626f 6c3a 2070 7269  pper(symbol: pri
-0000fee0: 6d73 2e53 796d 626f 6c2c 202a 2c20 6178  ms.Symbol, *, ax
-0000fef0: 6973 5f73 697a 653a 2069 6e74 293a 0a20  is_size: int):. 
-0000ff00: 2020 2022 2222 4d61 7073 2061 2073 796d     """Maps a sym
-0000ff10: 626f 6c20 746f 2061 2076 6d61 7020 6675  bol to a vmap fu
-0000ff20: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
-0000ff30: 7561 7465 7320 6974 2e0a 0a20 2020 2041  uates it...    A
-0000ff40: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
-0000ff50: 626f 6c20 2870 7269 6d73 2e53 796d 626f  bol (prims.Symbo
-0000ff60: 6c29 3a20 5379 6d62 6f6c 2074 6f20 6576  l): Symbol to ev
-0000ff70: 616c 7561 7465 2e0a 0a20 2020 2052 6169  aluate...    Rai
-0000ff80: 7365 733a 0a20 2020 2020 2020 204e 6f74  ses:.        Not
-0000ff90: 496d 706c 656d 656e 7465 6445 7272 6f72  ImplementedError
-0000ffa0: 3a20 4966 2074 6865 2076 6d61 7020 666f  : If the vmap fo
-0000ffb0: 7220 7468 6520 7379 6d62 6f6c 2069 7320  r the symbol is 
-0000ffc0: 6e6f 7420 696d 706c 656d 656e 7465 642e  not implemented.
-0000ffd0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0000ffe0: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
-0000fff0: 2076 6d61 7020 6675 6e63 7469 6f6e 2074   vmap function t
-00010000: 6861 7420 6576 616c 7561 7465 7320 7468  hat evaluates th
-00010010: 6520 7379 6d62 6f6c 2e0a 2020 2020 2222  e symbol..    ""
-00010020: 220a 0a20 2020 2064 6566 2077 7261 705f  "..    def wrap_
-00010030: 6172 6728 7829 3a0a 2020 2020 2020 2020  arg(x):.        
-00010040: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-00010050: 2042 6174 6368 6564 5661 6c75 6529 3a0a   BatchedValue):.
-00010060: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010070: 726e 2078 0a20 2020 2020 2020 2065 6c69  rn x.        eli
-00010080: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-00010090: 284e 756d 6265 722c 204e 756d 6265 7250  (Number, NumberP
-000100a0: 726f 7879 2929 3a0a 2020 2020 2020 2020  roxy)):.        
-000100b0: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
-000100c0: 6564 5661 6c75 6528 782c 206e 6f74 5f6d  edValue(x, not_m
-000100d0: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
-000100e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000100f0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00010100: 7228 6622 766d 6170 2077 7261 705f 6172  r(f"vmap wrap_ar
-00010110: 6720 676f 7420 616e 2075 6e73 7570 706f  g got an unsuppo
-00010120: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
-00010130: 7829 7d22 290a 0a20 2020 2069 6620 7379  x)}")..    if sy
-00010140: 6d62 6f6c 2e61 7265 5f61 6c6c 5f61 7267  mbol.are_all_arg
-00010150: 735f 636f 6e73 7461 6e74 3a0a 0a20 2020  s_constant:..   
-00010160: 2020 2020 2064 6566 205f 766d 6170 5f69       def _vmap_i
-00010170: 6d70 6c5f 636f 6e73 7428 7379 6d62 6f6c  mpl_const(symbol
-00010180: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-00010190: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-000101a0: 6f75 7420 3d20 7379 6d62 6f6c 5f74 6f5f  out = symbol_to_
-000101b0: 6576 616c 2873 796d 626f 6c29 282a 6172  eval(symbol)(*ar
-000101c0: 6773 2c20 2a2a 6b77 6172 6773 290a 0a20  gs, **kwargs).. 
-000101d0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-000101e0: 696e 7374 616e 6365 286f 7574 2c20 5365  instance(out, Se
-000101f0: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-00010200: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00010210: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
-00010220: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
-00010230: 7361 6665 5f7a 6970 2861 7267 732c 205b  safe_zip(args, [
-00010240: 6e6f 745f 6d61 7070 6564 5d20 2a20 6c65  not_mapped] * le
-00010250: 6e28 6f75 7429 2929 0a0a 2020 2020 2020  n(out)))..      
-00010260: 2020 2020 2020 7265 7475 726e 2042 6174        return Bat
-00010270: 6368 6564 5661 6c75 6528 6f75 742c 206e  chedValue(out, n
-00010280: 6f74 5f6d 6170 7065 6429 0a0a 2020 2020  ot_mapped)..    
-00010290: 2020 2020 7265 7475 726e 2070 6172 7469      return parti
-000102a0: 616c 285f 766d 6170 5f69 6d70 6c5f 636f  al(_vmap_impl_co
-000102b0: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
-000102c0: 2020 766d 6170 5f69 6d70 6c20 3d20 766d    vmap_impl = vm
-000102d0: 6170 5f69 6d70 6c73 2e67 6574 2873 796d  ap_impls.get(sym
-000102e0: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
-000102f0: 6966 2076 6d61 705f 696d 706c 2069 7320  if vmap_impl is 
-00010300: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-00010310: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
-00010320: 796d 626f 6c73 2920 3e20 303a 0a20 2020  ymbols) > 0:.   
-00010330: 2020 2020 2020 2020 2076 6d61 705f 696d           vmap_im
-00010340: 706c 203d 2070 6172 7469 616c 2864 6563  pl = partial(dec
-00010350: 6f6d 706f 7365 645f 666e 5f76 6d61 705f  omposed_fn_vmap_
-00010360: 7275 6c65 2c20 666e 3d73 796d 626f 6c2e  rule, fn=symbol.
-00010370: 7379 6d29 0a20 2020 2020 2020 2065 6c73  sym).        els
-00010380: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00010390: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-000103a0: 7465 6445 7272 6f72 2866 2276 6d61 7020  tedError(f"vmap 
-000103b0: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
-000103c0: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
-000103d0: 6d65 6e74 6564 2229 0a0a 2020 2020 6465  mented")..    de
-000103e0: 6620 5f76 6d61 705f 696d 706c 282a 6172  f _vmap_impl(*ar
-000103f0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-00010400: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
-00010410: 6565 5f6d 6170 2877 7261 705f 6172 672c  ee_map(wrap_arg,
-00010420: 2061 7267 7329 0a20 2020 2020 2020 2061   args).        a
-00010430: 7373 6572 7420 616c 6c28 6973 696e 7374  ssert all(isinst
-00010440: 616e 6365 2861 7267 2c20 4261 7463 6865  ance(arg, Batche
-00010450: 6456 616c 7565 2920 666f 7220 6172 6720  dValue) for arg 
-00010460: 696e 2074 7265 655f 666c 6174 7465 6e28  in tree_flatten(
-00010470: 6172 6773 295b 305d 290a 2020 2020 2020  args)[0]).      
-00010480: 2020 7265 7475 726e 2076 6d61 705f 696d    return vmap_im
-00010490: 706c 2861 7869 735f 7369 7a65 2c20 2a61  pl(axis_size, *a
-000104a0: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
-000104b0: 2020 2020 7265 7475 726e 205f 766d 6170      return _vmap
-000104c0: 5f69 6d70 6c0a 0a0a 6465 6620 7265 6d6f  _impl...def remo
-000104d0: 7665 5f62 6174 6368 5f64 696d 2874 656e  ve_batch_dim(ten
-000104e0: 736f 723a 2054 656e 736f 7250 726f 7879  sor: TensorProxy
-000104f0: 2c20 6261 7463 685f 6469 6d3a 2069 6e74  , batch_dim: int
-00010500: 203d 2030 2920 2d3e 2054 656e 736f 7250   = 0) -> TensorP
-00010510: 726f 7879 3a0a 2020 2020 2222 2252 656d  roxy:.    """Rem
-00010520: 6f76 6573 2074 6865 2062 6174 6368 2064  oves the batch d
-00010530: 696d 656e 7369 6f6e 2066 726f 6d20 6120  imension from a 
-00010540: 7465 6e73 6f72 2e0a 0a20 2020 2041 7267  tensor...    Arg
-00010550: 733a 0a20 2020 2020 2020 2074 656e 736f  s:.        tenso
-00010560: 7220 2854 656e 736f 7250 726f 7879 293a  r (TensorProxy):
-00010570: 2054 656e 736f 7220 746f 2072 656d 6f76   Tensor to remov
-00010580: 6520 7468 6520 6261 7463 6820 6469 6d65  e the batch dime
-00010590: 6e73 696f 6e20 6672 6f6d 2e0a 0a20 2020  nsion from...   
-000105a0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-000105b0: 2020 5465 6e73 6f72 5072 6f78 793a 2054    TensorProxy: T
-000105c0: 656e 736f 7220 7769 7468 2074 6865 2062  ensor with the b
-000105d0: 6174 6368 2064 696d 656e 7369 6f6e 2072  atch dimension r
-000105e0: 656d 6f76 6564 2e0a 2020 2020 2222 220a  emoved..    """.
-000105f0: 2020 2020 6e65 775f 7368 6170 6520 3d20      new_shape = 
-00010600: 7465 6e73 6f72 2e73 6861 7065 5b3a 6261  tensor.shape[:ba
-00010610: 7463 685f 6469 6d5d 202b 2074 656e 736f  tch_dim] + tenso
-00010620: 722e 7368 6170 655b 6261 7463 685f 6469  r.shape[batch_di
-00010630: 6d20 2b20 3120 3a5d 0a20 2020 2072 6574  m + 1 :].    ret
-00010640: 7572 6e20 5465 6e73 6f72 5072 6f78 7928  urn TensorProxy(
-00010650: 6c69 6b65 3d74 656e 736f 722c 2073 6861  like=tensor, sha
-00010660: 7065 3d6e 6577 5f73 6861 7065 290a 0a0a  pe=new_shape)...
-00010670: 2320 544f 444f 3a20 696e 204a 4158 2061  # TODO: in JAX a
-00010680: 7267 732c 2069 6e5f 6469 6d73 2061 7265  rgs, in_dims are
-00010690: 2066 6c61 7474 656e 6564 2074 6865 2073   flattened the s
-000106a0: 616d 6520 7761 790a 2320 544f 444f 3a20  ame way.# TODO: 
-000106b0: 696e 204a 4158 206f 7574 5f64 696d 7320  in JAX out_dims 
-000106c0: 6172 6520 666c 6174 7465 6e65 6420 6173  are flattened as
-000106d0: 2077 656c 6c0a 6465 6620 5f76 6d61 705f   well.def _vmap_
-000106e0: 6361 6c6c 5f6d 6574 6166 756e 6328 6465  call_metafunc(de
-000106f0: 7461 6368 6564 3a20 626f 6f6c 2c20 6172  tached: bool, ar
-00010700: 6773 2c20 696e 5f64 696d 732c 206f 7574  gs, in_dims, out
-00010710: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
-00010720: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
-00010730: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
-00010740: 7329 3a0a 2020 2020 2222 224d 6574 6166  s):.    """Metaf
-00010750: 756e 6374 696f 6e20 666f 7220 766d 6170  unction for vmap
-00010760: 2063 616c 6c2e 0a0a 2020 2020 4172 6773   call...    Args
-00010770: 3a0a 2020 2020 2020 2020 6465 7461 6368  :.        detach
-00010780: 6564 2028 626f 6f6c 293a 2057 6865 7468  ed (bool): Wheth
-00010790: 6572 2074 6f20 6465 7461 6368 2074 6865  er to detach the
-000107a0: 2074 7261 6365 2e0a 2020 2020 2020 2020   trace..        
-000107b0: 6172 6773 2028 5475 706c 655b 5072 6f78  args (Tuple[Prox
-000107c0: 795d 293a 2041 7267 756d 656e 7473 2074  y]): Arguments t
-000107d0: 6f20 7468 6520 6675 6e63 7469 6f6e 2e0a  o the function..
-000107e0: 2020 2020 2020 2020 696e 5f64 696d 7320          in_dims 
-000107f0: 2854 7570 6c65 5b69 6e74 5d29 3a20 4261  (Tuple[int]): Ba
-00010800: 7463 6820 6469 6d65 6e73 696f 6e20 666f  tch dimension fo
-00010810: 7220 6561 6368 2061 7267 756d 656e 742e  r each argument.
-00010820: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
-00010830: 7320 2854 7570 6c65 5b69 6e74 5d29 3a20  s (Tuple[int]): 
-00010840: 4261 7463 6820 6469 6d65 6e73 696f 6e20  Batch dimension 
-00010850: 666f 7220 7265 7475 726e 2076 616c 7565  for return value
-00010860: 732e 0a20 2020 2020 2020 2066 756e 6374  s..        funct
-00010870: 696f 6e5f 7472 6163 6520 2854 7261 6365  ion_trace (Trace
-00010880: 293a 2054 7261 6365 2074 6f20 7573 6520  ): Trace to use 
-00010890: 666f 7220 7468 6520 6675 6e63 7469 6f6e  for the function
-000108a0: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
-000108b0: 3a20 4b65 7977 6f72 6420 6172 6775 6d65  : Keyword argume
-000108c0: 6e74 732e 0a0a 2020 2020 5261 6973 6573  nts...    Raises
-000108d0: 3a0a 2020 2020 2020 2020 4173 7365 7274  :.        Assert
-000108e0: 696f 6e45 7272 6f72 3a20 4966 2074 6865  ionError: If the
-000108f0: 2076 6d61 7020 666f 7220 6b65 7977 6f72   vmap for keywor
-00010900: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
-00010910: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
-00010920: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00010930: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
-00010940: 7468 6520 766d 6170 2074 7261 6e73 666f  the vmap transfo
-00010950: 726d 2e0a 2020 2020 2222 220a 2020 2020  rm..    """.    
-00010960: 636f 6d6d 6f6e 5f64 6576 6963 6520 3d20  common_device = 
-00010970: 7b78 2e64 6576 6963 6520 666f 7220 7820  {x.device for x 
-00010980: 696e 2061 7267 7320 6966 2069 7369 6e73  in args if isins
-00010990: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
-000109a0: 726f 7879 297d 0a20 2020 2061 7373 6572  roxy)}.    asser
-000109b0: 7420 6c65 6e28 636f 6d6d 6f6e 5f64 6576  t len(common_dev
-000109c0: 6963 6529 203c 3d20 312c 2022 766d 6170  ice) <= 1, "vmap
-000109d0: 2066 6f72 206d 756c 7469 706c 6520 6465   for multiple de
-000109e0: 7669 6365 7320 6973 206e 6f74 2069 6d70  vices is not imp
-000109f0: 6c65 6d65 6e74 6564 220a 2020 2020 2863  lemented".    (c
-00010a00: 6f6d 6d6f 6e5f 6465 7669 6365 2c29 203d  ommon_device,) =
-00010a10: 2063 6f6d 6d6f 6e5f 6465 7669 6365 2069   common_device i
-00010a20: 6620 6c65 6e28 636f 6d6d 6f6e 5f64 6576  f len(common_dev
-00010a30: 6963 6529 203d 3d20 3120 656c 7365 2028  ice) == 1 else (
-00010a40: 6370 752c 290a 0a20 2020 2069 6620 6178  cpu,)..    if ax
-00010a50: 6973 5f73 697a 6520 6973 204e 6f6e 653a  is_size is None:
-00010a60: 0a20 2020 2020 2020 2028 6178 6973 5f73  .        (axis_s
-00010a70: 697a 652c 2920 3d20 7b78 2e73 6861 7065  ize,) = {x.shape
-00010a80: 5b61 785d 2066 6f72 2078 2c20 6178 2069  [ax] for x, ax i
-00010a90: 6e20 7a69 7028 6172 6773 2c20 696e 5f64  n zip(args, in_d
-00010aa0: 696d 7329 2069 6620 6178 2069 7320 6e6f  ims) if ax is no
-00010ab0: 7420 6e6f 745f 6d61 7070 6564 7d0a 2020  t not_mapped}.  
-00010ac0: 2020 696e 5f64 696d 7320 3d20 696e 5f64    in_dims = in_d
-00010ad0: 696d 7320 6966 2069 7369 6e73 7461 6e63  ims if isinstanc
-00010ae0: 6528 696e 5f64 696d 732c 2053 6571 7565  e(in_dims, Seque
-00010af0: 6e63 6529 2065 6c73 6520 2869 6e5f 6469  nce) else (in_di
-00010b00: 6d73 2c29 0a20 2020 2069 6e5f 6469 6d73  ms,).    in_dims
-00010b10: 203d 2074 7570 6c65 286e 6f74 5f6d 6170   = tuple(not_map
-00010b20: 7065 6420 6966 2069 7369 6e73 7461 6e63  ped if isinstanc
-00010b30: 6528 612c 2028 4e75 6d62 6572 2c20 4e75  e(a, (Number, Nu
-00010b40: 6d62 6572 5072 6f78 7929 2920 656c 7365  mberProxy)) else
-00010b50: 2064 2066 6f72 2061 2c20 6420 696e 2073   d for a, d in s
-00010b60: 6166 655f 7a69 7028 6172 6773 2c20 696e  afe_zip(args, in
-00010b70: 5f64 696d 7329 290a 2020 2020 6f75 745f  _dims)).    out_
-00010b80: 6469 6d73 203d 206f 7574 5f64 696d 7320  dims = out_dims 
-00010b90: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-00010ba0: 745f 6469 6d73 2c20 5365 7175 656e 6365  t_dims, Sequence
-00010bb0: 2920 656c 7365 2028 6f75 745f 6469 6d73  ) else (out_dims
-00010bc0: 2c29 0a0a 2020 2020 6374 7820 3d20 6465  ,)..    ctx = de
-00010bd0: 7461 6368 6564 5f74 7261 6365 2829 2069  tached_trace() i
-00010be0: 6620 6465 7461 6368 6564 2065 6c73 6520  f detached else 
-00010bf0: 6e75 6c6c 636f 6e74 6578 7428 290a 2020  nullcontext().  
-00010c00: 2020 7769 7468 2063 7478 3a0a 2020 2020    with ctx:.    
-00010c10: 2020 2020 2320 5765 2070 726f 7061 6761      # We propaga
-00010c20: 7465 2074 6865 2042 6174 6368 5661 6c75  te the BatchValu
-00010c30: 6520 7468 726f 7567 6820 7468 6520 7472  e through the tr
-00010c40: 6163 652c 2061 6e64 2074 6865 6e20 756e  ace, and then un
-00010c50: 7772 6170 2069 7420 6174 2074 6865 2065  wrap it at the e
-00010c60: 6e64 0a20 2020 2020 2020 2062 6174 6368  nd.        batch
-00010c70: 6564 5f61 7267 7320 3d20 7361 6665 5f6d  ed_args = safe_m
-00010c80: 6170 2870 6169 725f 746f 5f62 6174 6368  ap(pair_to_batch
-00010c90: 6564 5f76 616c 7565 2c20 7361 6665 5f7a  ed_value, safe_z
-00010ca0: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
-00010cb0: 2929 0a20 2020 2020 2020 2072 6573 756c  )).        resul
-00010cc0: 7420 3d20 6576 616c 5f74 7261 6365 280a  t = eval_trace(.
-00010cd0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-00010ce0: 7469 6f6e 5f74 7261 6365 2c20 2a62 6174  tion_trace, *bat
-00010cf0: 6368 6564 5f61 7267 732c 2073 796d 626f  ched_args, symbo
-00010d00: 6c5f 6d61 7070 6572 3d70 6172 7469 616c  l_mapper=partial
-00010d10: 2876 6d61 705f 7379 6d62 6f6c 5f6d 6170  (vmap_symbol_map
-00010d20: 7065 722c 2061 7869 735f 7369 7a65 3d61  per, axis_size=a
-00010d30: 7869 735f 7369 7a65 292c 202a 2a6b 7761  xis_size), **kwa
-00010d40: 7267 730a 2020 2020 2020 2020 290a 2020  rgs.        ).  
-00010d50: 2020 2020 2020 2320 556e 7772 6170 7069        # Unwrappi
-00010d60: 6e67 2074 6865 2042 6174 6368 6564 5661  ng the BatchedVa
-00010d70: 6c75 6527 730a 2020 2020 2020 2020 6966  lue's.        if
-00010d80: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-00010d90: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
-00010da0: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
-00010db0: 7265 7375 6c74 2c20 7370 6563 203d 2074  result, spec = t
-00010dc0: 7265 655f 666c 6174 7465 6e28 7265 7375  ree_flatten(resu
-00010dd0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-00010de0: 6173 7365 7274 2061 6c6c 2869 7369 6e73  assert all(isins
-00010df0: 7461 6e63 6528 782c 2042 6174 6368 6564  tance(x, Batched
-00010e00: 5661 6c75 6529 2066 6f72 2078 2069 6e20  Value) for x in 
-00010e10: 666c 6174 5f72 6573 756c 7429 0a20 2020  flat_result).   
-00010e20: 2020 2020 2020 2020 206f 7574 732c 2062           outs, b
-00010e30: 6469 6d73 203d 2075 6e7a 6970 3228 666c  dims = unzip2(fl
-00010e40: 6174 5f72 6573 756c 7429 0a20 2020 2020  at_result).     
-00010e50: 2020 2020 2020 2023 2054 4f44 4f3a 2068         # TODO: h
-00010e60: 616e 646c 6520 7468 6520 6361 7365 2077  andle the case w
-00010e70: 6865 7265 206f 7574 5f64 696d 7320 6973  here out_dims is
-00010e80: 2061 2073 696e 676c 6520 7661 6c75 6520   a single value 
-00010e90: 6265 7474 6572 0a20 2020 2020 2020 2020  better.         
-00010ea0: 2020 2069 6620 6c65 6e28 6f75 745f 6469     if len(out_di
-00010eb0: 6d73 2920 3d3d 2031 3a0a 2020 2020 2020  ms) == 1:.      
-00010ec0: 2020 2020 2020 2020 2020 6f75 745f 6469            out_di
-00010ed0: 6d73 203d 206f 7574 5f64 696d 7320 2a20  ms = out_dims * 
-00010ee0: 6c65 6e28 6f75 7473 290a 2020 2020 2020  len(outs).      
-00010ef0: 2020 2020 2020 6f75 7473 203d 2073 6166        outs = saf
-00010f00: 655f 6d61 7028 7061 7274 6961 6c28 6d6f  e_map(partial(mo
-00010f10: 7665 5f62 6174 6368 5f64 696d 2c20 6178  ve_batch_dim, ax
-00010f20: 6973 5f73 697a 6529 2c20 6264 696d 732c  is_size), bdims,
-00010f30: 206f 7574 5f64 696d 732c 206f 7574 7329   out_dims, outs)
-00010f40: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00010f50: 7572 6e20 7472 6565 5f75 6e66 6c61 7474  urn tree_unflatt
-00010f60: 656e 286f 7574 732c 2073 7065 6329 0a20  en(outs, spec). 
-00010f70: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00010f80: 616e 6365 2872 6573 756c 742c 2028 4e75  ance(result, (Nu
-00010f90: 6d62 6572 2c20 4e75 6d62 6572 5072 6f78  mber, NumberProx
-00010fa0: 7929 2920 616e 6420 6178 6973 5f73 697a  y)) and axis_siz
-00010fb0: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
-00010fc0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-00010fd0: 4f3a 2066 6574 6368 2074 6865 2064 6566  O: fetch the def
-00010fe0: 6175 6c74 2064 6576 6963 6520 6672 6f6d  ault device from
-00010ff0: 2074 6865 2063 6f6e 7465 7874 0a20 2020   the context.   
-00011000: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00011010: 3d20 6675 6c6c 2873 6861 7065 3d28 292c  = full(shape=(),
-00011020: 2066 696c 6c5f 7661 6c75 653d 7265 7375   fill_value=resu
-00011030: 6c74 2c20 6465 7669 6365 3d63 6f6d 6d6f  lt, device=commo
-00011040: 6e5f 6465 7669 6365 290a 2020 2020 2020  n_device).      
-00011050: 2020 2020 2020 7265 7375 6c74 203d 2042        result = B
-00011060: 6174 6368 6564 5661 6c75 6528 7265 7375  atchedValue(resu
-00011070: 6c74 2c20 6e6f 745f 6d61 7070 6564 290a  lt, not_mapped).
-00011080: 2020 2020 2020 2020 656c 6966 2028 0a20          elif (. 
-00011090: 2020 2020 2020 2020 2020 2069 7369 6e73             isins
-000110a0: 7461 6e63 6528 7265 7375 6c74 2c20 4261  tance(result, Ba
-000110b0: 7463 6865 6456 616c 7565 290a 2020 2020  tchedValue).    
-000110c0: 2020 2020 2020 2020 616e 6420 6973 696e          and isin
-000110d0: 7374 616e 6365 2872 6573 756c 742e 7661  stance(result.va
-000110e0: 6c75 652c 2028 4e75 6d62 6572 2c20 4e75  lue, (Number, Nu
-000110f0: 6d62 6572 5072 6f78 7929 290a 2020 2020  mberProxy)).    
-00011100: 2020 2020 2020 2020 616e 6420 6178 6973          and axis
-00011110: 5f73 697a 6520 6973 206e 6f74 204e 6f6e  _size is not Non
-00011120: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
-00011130: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00011140: 3d20 4261 7463 6865 6456 616c 7565 2866  = BatchedValue(f
-00011150: 756c 6c28 7368 6170 653d 2829 2c20 6669  ull(shape=(), fi
-00011160: 6c6c 5f76 616c 7565 3d72 6573 756c 742e  ll_value=result.
-00011170: 7661 6c75 652c 2064 6576 6963 653d 636f  value, device=co
-00011180: 6d6d 6f6e 5f64 6576 6963 6529 2c20 7265  mmon_device), re
-00011190: 7375 6c74 2e62 6174 6368 5f64 696d 290a  sult.batch_dim).
-000111a0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-000111b0: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
-000111c0: 2c20 4261 7463 6865 6456 616c 7565 290a  , BatchedValue).
-000111d0: 2020 2020 2020 2020 6f75 7420 3d20 6d6f          out = mo
-000111e0: 7665 5f62 6174 6368 5f64 696d 2861 7869  ve_batch_dim(axi
-000111f0: 735f 7369 7a65 2c20 7265 7375 6c74 2e62  s_size, result.b
-00011200: 6174 6368 5f64 696d 2c20 6f75 745f 6469  atch_dim, out_di
-00011210: 6d73 5b30 5d2c 2072 6573 756c 742e 7661  ms[0], result.va
-00011220: 6c75 6529 0a20 2020 2020 2020 2072 6574  lue).        ret
-00011230: 7572 6e20 6f75 740a 0a0a 766d 6170 5f63  urn out...vmap_c
-00011240: 616c 6c20 3d20 5379 6d62 6f6c 2869 643d  all = Symbol(id=
-00011250: 5472 616e 7366 6f72 6d73 2e56 6d61 704f  Transforms.VmapO
-00011260: 702c 206e 616d 653d 2276 6d61 705f 6361  p, name="vmap_ca
-00011270: 6c6c 222c 206d 6574 613d 7061 7274 6961  ll", meta=partia
-00011280: 6c28 5f76 6d61 705f 6361 6c6c 5f6d 6574  l(_vmap_call_met
-00011290: 6166 756e 632c 2046 616c 7365 2929 0a0a  afunc, False))..
-000112a0: 0a23 2054 4f44 4f3a 2068 6f77 2073 686f  .# TODO: how sho
-000112b0: 756c 6420 7765 2068 616e 646c 6520 6f75  uld we handle ou
-000112c0: 745f 6469 6d73 2068 6572 653f 0a23 2061  t_dims here?.# a
-000112d0: 6c74 686f 7567 6820 6865 7265 2077 6520  lthough here we 
-000112e0: 6172 6520 6361 6c6c 696e 6720 766d 6170  are calling vmap
-000112f0: 206f 6620 6964 656e 7469 7479 2c20 736f   of identity, so
-00011300: 2077 6520 7368 6f75 6c64 206b 6e6f 7720   we should know 
-00011310: 6672 6f6d 2074 6865 2063 616c 6c20 746f  from the call to
-00011320: 2076 6d61 700a 2320 5468 6973 2073 686f   vmap.# This sho
-00011330: 756c 6420 6265 2066 696e 652e 2049 6620  uld be fine. If 
-00011340: 7765 2068 6176 6520 766d 6170 2869 6465  we have vmap(ide
-00011350: 6e74 6974 7928 6675 6e63 292c 206f 7574  ntity(func), out
-00011360: 5f64 696d 733d 4e29 2074 6865 6e20 7468  _dims=N) then th
-00011370: 6973 2072 756c 6520 6973 2066 6972 7374  is rule is first
-00011380: 2075 7365 640a 2320 746f 2067 6574 2074   used.# to get t
-00011390: 6865 2076 6d61 7070 6564 2072 6573 756c  he vmapped resul
-000113a0: 7420 6f66 2069 6465 6e74 6974 7928 6675  t of identity(fu
-000113b0: 6e63 2920 696e 2076 6d61 705f 7379 6d62  nc) in vmap_symb
-000113c0: 6f6c 5f6d 6170 7065 722c 2061 6e64 206f  ol_mapper, and o
-000113d0: 7574 5f64 696d 7320 6973 2068 616e 646c  ut_dims is handl
-000113e0: 6564 0a23 2061 6674 6572 2074 6861 7420  ed.# after that 
-000113f0: 696e 2074 6865 206f 7574 6572 205f 766d  in the outer _vm
-00011400: 6170 5f63 616c 6c5f 6d65 7461 6675 6e63  ap_call_metafunc
-00011410: 2e0a 6465 6620 5f69 6465 6e74 6974 795f  ..def _identity_
-00011420: 6361 6c6c 5f76 6d61 7028 6178 6973 5f73  call_vmap(axis_s
-00011430: 697a 652c 202a 6261 7463 6865 645f 6172  ize, *batched_ar
-00011440: 6773 2c20 7472 6163 653a 2054 7261 6365  gs, trace: Trace
-00011450: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00011460: 2061 7267 732c 2069 6e5f 6469 6d73 203d   args, in_dims =
-00011470: 2075 6e7a 6970 3228 6261 7463 6865 645f   unzip2(batched_
-00011480: 6172 6773 290a 2020 2020 6f75 745f 6469  args).    out_di
-00011490: 6d73 203d 2030 2020 2320 4669 786d 650a  ms = 0  # Fixme.
-000114a0: 2020 2020 6f75 7473 2c20 6f75 745f 6469      outs, out_di
-000114b0: 6d73 203d 205f 766d 6170 5f63 616c 6c5f  ms = _vmap_call_
-000114c0: 6d65 7461 6675 6e63 2846 616c 7365 2c20  metafunc(False, 
-000114d0: 6172 6773 2c20 696e 5f64 696d 732c 206f  args, in_dims, o
-000114e0: 7574 5f64 696d 732c 2061 7869 735f 7369  ut_dims, axis_si
-000114f0: 7a65 2c20 6675 6e63 7469 6f6e 5f74 7261  ze, function_tra
-00011500: 6365 3d74 7261 6365 2c20 2a2a 6b77 6172  ce=trace, **kwar
-00011510: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
-00011520: 7461 6e63 6528 6f75 7473 2c20 5365 7175  tance(outs, Sequ
-00011530: 656e 6365 293a 0a20 2020 2020 2020 2072  ence):.        r
-00011540: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
-00011550: 6169 725f 746f 5f62 6174 6368 6564 5f76  air_to_batched_v
-00011560: 616c 7565 2c20 7361 6665 5f7a 6970 286f  alue, safe_zip(o
-00011570: 7574 732c 206f 7574 5f64 696d 7329 290a  uts, out_dims)).
-00011580: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
-00011590: 6564 5661 6c75 6528 6f75 7473 2c20 6f75  edValue(outs, ou
-000115a0: 745f 6469 6d73 290a 0a0a 766d 6170 5f69  t_dims)...vmap_i
-000115b0: 6d70 6c73 5b54 7261 6e73 666f 726d 732e  mpls[Transforms.
-000115c0: 4964 656e 7469 7479 4f70 5d20 3d20 5f69  IdentityOp] = _i
-000115d0: 6465 6e74 6974 795f 6361 6c6c 5f76 6d61  dentity_call_vma
-000115e0: 700a 0a0a 6465 6620 5f6a 7670 5f63 616c  p...def _jvp_cal
-000115f0: 6c5f 766d 6170 2861 7869 735f 7369 7a65  l_vmap(axis_size
-00011600: 2c20 6261 7463 6865 645f 7072 696d 616c  , batched_primal
-00011610: 732c 2062 6174 6368 6564 5f74 616e 6765  s, batched_tange
-00011620: 6e74 732c 202a 2c20 6675 6e63 7469 6f6e  nts, *, function
-00011630: 5f74 7261 6365 3a20 5472 6163 652c 202a  _trace: Trace, *
-00011640: 2a6b 7761 7267 7329 3a0a 2020 2020 7072  *kwargs):.    pr
-00011650: 696d 616c 732c 2070 7269 6d61 6c73 5f62  imals, primals_b
-00011660: 6469 6d73 203d 2073 6166 655f 7a69 7028  dims = safe_zip(
-00011670: 2a62 6174 6368 6564 5f70 7269 6d61 6c73  *batched_primals
-00011680: 290a 2020 2020 7461 6e67 656e 7473 2c20  ).    tangents, 
-00011690: 7461 6e67 656e 7473 5f62 6469 6d73 203d  tangents_bdims =
-000116a0: 2073 6166 655f 7a69 7028 2a62 6174 6368   safe_zip(*batch
-000116b0: 6564 5f74 616e 6765 6e74 7329 0a20 2020  ed_tangents).   
-000116c0: 206a 7670 5f66 756e 6320 3d20 7061 7274   jvp_func = part
-000116d0: 6961 6c28 5f6a 7670 5f63 616c 6c5f 6d65  ial(_jvp_call_me
-000116e0: 7461 6675 6e63 2c20 4661 6c73 652c 2066  tafunc, False, f
-000116f0: 756e 6374 696f 6e5f 7472 6163 653d 6675  unction_trace=fu
-00011700: 6e63 7469 6f6e 5f74 7261 6365 290a 2020  nction_trace).  
-00011710: 2020 766d 6170 7065 645f 6a76 705f 6675    vmapped_jvp_fu
-00011720: 6e63 203d 2076 6d61 7028 6a76 705f 6675  nc = vmap(jvp_fu
-00011730: 6e63 2c20 696e 5f64 696d 733d 2870 7269  nc, in_dims=(pri
-00011740: 6d61 6c73 5f62 6469 6d73 2c20 7461 6e67  mals_bdims, tang
-00011750: 656e 7473 5f62 6469 6d73 292c 2061 7869  ents_bdims), axi
-00011760: 735f 7369 7a65 3d61 7869 735f 7369 7a65  s_size=axis_size
-00011770: 290a 2020 2020 7265 7375 6c74 203d 2076  ).    result = v
-00011780: 6d61 7070 6564 5f6a 7670 5f66 756e 6328  mapped_jvp_func(
-00011790: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
-000117a0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
-000117b0: 2072 6574 7572 6e20 7472 6565 5f6d 6170   return tree_map
-000117c0: 286c 616d 6264 6120 783a 2042 6174 6368  (lambda x: Batch
-000117d0: 6564 5661 6c75 6528 782c 2030 292c 2072  edValue(x, 0), r
-000117e0: 6573 756c 7429 0a0a 0a76 6d61 705f 696d  esult)...vmap_im
-000117f0: 706c 735b 5472 616e 7366 6f72 6d73 2e4a  pls[Transforms.J
-00011800: 7670 4f70 5d20 3d20 5f6a 7670 5f63 616c  vpOp] = _jvp_cal
-00011810: 6c5f 766d 6170 0a0a 0a64 6566 2076 6d61  l_vmap...def vma
-00011820: 7028 6675 6e63 2c20 696e 5f64 696d 733d  p(func, in_dims=
-00011830: 302c 206f 7574 5f64 696d 733d 302c 2061  0, out_dims=0, a
-00011840: 7869 735f 7369 7a65 3d4e 6f6e 6529 3a0a  xis_size=None):.
-00011850: 2020 2020 2222 2256 6563 746f 7269 7a69      """Vectorizi
-00011860: 6e67 2074 7261 6e73 666f 726d 2066 6f72  ng transform for
-00011870: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
-00011880: 696f 6e2e 0a0a 2020 2020 4172 6773 3a0a  ion...    Args:.
-00011890: 2020 2020 2020 2020 6675 6e63 2028 4361          func (Ca
-000118a0: 6c6c 6162 6c65 293a 2041 2054 6875 6e64  llable): A Thund
-000118b0: 6572 2066 756e 6374 696f 6e20 746f 2062  er function to b
-000118c0: 6520 7472 616e 7366 6f72 6d65 642e 0a0a  e transformed...
-000118d0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-000118e0: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
-000118f0: 2076 6d61 7070 6564 2076 6572 7369 6f6e   vmapped version
-00011900: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-00011910: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
-00011920: 2054 4f44 4f3a 2066 6c61 7474 656e 0a20   TODO: flatten. 
-00011930: 2020 2023 2049 6e20 4a41 5820 666c 6174     # In JAX flat
-00011940: 7465 6e69 6e67 206f 6620 696e 5f64 696d  tening of in_dim
-00011950: 7320 6973 2072 6174 6865 7220 636f 6d70  s is rather comp
-00011960: 6c69 6361 7465 6420 6265 6361 7573 6520  licated because 
-00011970: 6974 2063 616e 206f 7074 696f 6e61 6c6c  it can optionall
-00011980: 7920 6265 0a20 2020 2023 2073 7065 6369  y be.    # speci
-00011990: 6669 6564 2061 7320 6120 e280 9c70 7265  fied as a ...pre
-000119a0: 6669 78e2 809d 2070 7974 7265 652c 206d  fix... pytree, m
-000119b0: 6561 6e69 6e67 2074 6861 7420 6120 7369  eaning that a si
-000119c0: 6e67 6c65 206c 6561 6620 7661 6c75 6520  ngle leaf value 
-000119d0: 6361 6e20 6265 2061 7070 6c69 6564 0a20  can be applied. 
-000119e0: 2020 2023 2074 6f20 616e 2065 6e74 6972     # to an entir
-000119f0: 6520 7375 622d 7079 7472 6565 2e0a 0a20  e sub-pytree... 
-00011a00: 2020 2064 6566 2066 6c61 7474 656e 5f66     def flatten_f
-00011a10: 756e 635f 666f 725f 766d 6170 2866 756e  unc_for_vmap(fun
-00011a20: 632c 2061 7267 732c 206b 7761 7267 7329  c, args, kwargs)
-00011a30: 3a0a 2020 2020 2020 2020 666c 6174 5f61  :.        flat_a
-00011a40: 7267 732c 2073 7065 6320 3d20 7472 6565  rgs, spec = tree
-00011a50: 5f66 6c61 7474 656e 2828 6172 6773 2c20  _flatten((args, 
-00011a60: 6b77 6172 6773 2929 0a0a 2020 2020 2020  kwargs))..      
-00011a70: 2020 6465 6620 666c 6174 5f66 756e 6328    def flat_func(
-00011a80: 2a66 6c61 745f 6172 6773 293a 0a20 2020  *flat_args):.   
-00011a90: 2020 2020 2020 2020 2066 6e5f 6172 6773           fn_args
-00011aa0: 2c20 666e 5f6b 7761 7267 7320 3d20 7472  , fn_kwargs = tr
-00011ab0: 6565 5f75 6e66 6c61 7474 656e 2866 6c61  ee_unflatten(fla
-00011ac0: 745f 6172 6773 2c20 7370 6563 290a 2020  t_args, spec).  
-00011ad0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00011ae0: 2066 756e 6328 2a66 6e5f 6172 6773 2c20   func(*fn_args, 
-00011af0: 2a2a 666e 5f6b 7761 7267 7329 0a0a 2020  **fn_kwargs)..  
-00011b00: 2020 2020 2020 7265 7475 726e 2066 6c61        return fla
-00011b10: 745f 6675 6e63 2c20 666c 6174 5f61 7267  t_func, flat_arg
-00011b20: 732c 2073 7065 630a 0a20 2020 2064 6566  s, spec..    def
-00011b30: 2077 7261 7070 6572 282a 6172 6773 2c20   wrapper(*args, 
-00011b40: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00011b50: 2020 2066 756e 635f 666c 6174 2c20 6172     func_flat, ar
-00011b60: 6773 5f66 6c61 742c 2061 7267 735f 7370  gs_flat, args_sp
-00011b70: 6563 203d 2066 6c61 7474 656e 5f66 756e  ec = flatten_fun
-00011b80: 635f 666f 725f 766d 6170 2866 756e 632c  c_for_vmap(func,
-00011b90: 2061 7267 732c 206b 7761 7267 7329 0a20   args, kwargs). 
-00011ba0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-00011bb0: 616e 6365 2869 6e5f 6469 6d73 2c20 696e  ance(in_dims, in
-00011bc0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00011bd0: 696e 5f64 696d 735f 666c 6174 203d 2028  in_dims_flat = (
-00011be0: 696e 5f64 696d 732c 2920 2a20 6c65 6e28  in_dims,) * len(
-00011bf0: 6172 6773 5f66 6c61 7429 0a20 2020 2020  args_flat).     
-00011c00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00011c10: 2020 2020 2069 6e5f 6469 6d73 5f66 6c61       in_dims_fla
-00011c20: 742c 2069 6e5f 6469 6d73 5f73 7065 6320  t, in_dims_spec 
-00011c30: 3d20 7472 6565 5f66 6c61 7474 656e 2869  = tree_flatten(i
-00011c40: 6e5f 6469 6d73 290a 2020 2020 2020 2020  n_dims).        
-00011c50: 2020 2020 6173 7365 7274 206c 656e 2869      assert len(i
-00011c60: 6e5f 6469 6d73 5f66 6c61 7429 203d 3d20  n_dims_flat) == 
-00011c70: 6c65 6e28 6172 6773 5f66 6c61 7429 2c20  len(args_flat), 
-00011c80: 2269 6e5f 6469 6d73 206d 7573 7420 6861  "in_dims must ha
-00011c90: 7665 2074 6865 2073 616d 6520 6c65 6e67  ve the same leng
-00011ca0: 7468 2061 7320 6172 6773 2c20 6b77 6172  th as args, kwar
-00011cb0: 6773 220a 2020 2020 2020 2020 756e 6261  gs".        unba
-00011cc0: 7463 6865 645f 6172 6773 5f66 6c61 7420  tched_args_flat 
-00011cd0: 3d20 5b72 656d 6f76 655f 6261 7463 685f  = [remove_batch_
-00011ce0: 6469 6d28 6172 6729 2069 6620 6973 696e  dim(arg) if isin
-00011cf0: 7374 616e 6365 2861 7267 2c20 5465 6e73  stance(arg, Tens
-00011d00: 6f72 5072 6f78 7929 2065 6c73 6520 6172  orProxy) else ar
-00011d10: 6720 666f 7220 6172 6720 696e 2061 7267  g for arg in arg
-00011d20: 735f 666c 6174 5d0a 2020 2020 2020 2020  s_flat].        
-00011d30: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
-00011d40: 745f 7472 6163 6528 2928 6675 6e63 5f66  t_trace()(func_f
-00011d50: 6c61 742c 202a 756e 6261 7463 6865 645f  lat, *unbatched_
-00011d60: 6172 6773 5f66 6c61 7429 0a20 2020 2020  args_flat).     
-00011d70: 2020 206f 7574 7320 3d20 766d 6170 5f63     outs = vmap_c
-00011d80: 616c 6c28 6172 6773 5f66 6c61 742c 2069  all(args_flat, i
-00011d90: 6e5f 6469 6d73 5f66 6c61 742c 206f 7574  n_dims_flat, out
-00011da0: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
-00011db0: 3d61 7869 735f 7369 7a65 2c20 6675 6e63  =axis_size, func
-00011dc0: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
-00011dd0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00011de0: 206f 7574 730a 0a20 2020 2072 6574 7572   outs..    retur
-00011df0: 6e20 7772 6170 7065 720a 0a0a 2320 544f  n wrapper...# TO
-00011e00: 444f 2054 6869 7320 6675 6e63 7469 6f6e  DO This function
-00011e10: 2063 6f6d 6d65 6e74 6564 206f 7574 2062   commented out b
-00011e20: 6563 6175 7365 2069 7420 6361 6c6c 7320  ecause it calls 
-00011e30: 6d61 6b65 5f74 7261 6365 642c 2077 6869  make_traced, whi
-00011e40: 6368 2064 6f65 7320 6e6f 7420 6578 6973  ch does not exis
-00011e50: 740a 2320 6465 6620 766d 6170 5f65 6167  t.# def vmap_eag
-00011e60: 6572 2866 756e 632c 2061 7267 732c 2069  er(func, args, i
-00011e70: 6e5f 6469 6d73 3d30 2c20 6f75 745f 6469  n_dims=0, out_di
-00011e80: 6d73 3d30 2c20 6178 6973 5f73 697a 653d  ms=0, axis_size=
-00011e90: 4e6f 6e65 2c20 6578 6563 7574 6f72 3d22  None, executor="
-00011ea0: 746f 7263 6822 293a 0a23 2020 2020 2022  torch"):.#     "
-00011eb0: 2222 436f 6d70 7574 6573 2074 6865 2076  ""Computes the v
-00011ec0: 6d61 7020 6f66 2061 2054 6875 6e64 6572  map of a Thunder
-00011ed0: 2066 756e 6374 696f 6e2e 0a0a 2320 2020   function...#   
-00011ee0: 2020 4172 6773 3a0a 2320 2020 2020 2020    Args:.#       
-00011ef0: 2020 6675 6e63 2028 4361 6c6c 6162 6c65    func (Callable
-00011f00: 293a 2041 2054 6875 6e64 6572 2066 756e  ): A Thunder fun
-00011f10: 6374 696f 6e20 746f 2062 6520 7472 616e  ction to be tran
-00011f20: 7366 6f72 6d65 642e 0a23 2020 2020 2020  sformed..#      
-00011f30: 2020 2061 7267 7320 285f 7479 7065 5f29     args (_type_)
-00011f40: 3a20 4172 6773 206f 6620 7468 6520 6675  : Args of the fu
-00011f50: 6e63 7469 6f6e 2e0a 2320 2020 2020 2020  nction..#       
-00011f60: 2020 6578 6563 7574 6f72 2028 7374 722c    executor (str,
-00011f70: 206f 7074 696f 6e61 6c29 3a20 4578 6563   optional): Exec
-00011f80: 7574 6f72 2074 6f20 7573 652e 2044 6566  utor to use. Def
-00011f90: 6175 6c74 7320 746f 2022 746f 7263 6822  aults to "torch"
-00011fa0: 2e0a 0a23 2020 2020 2052 6574 7572 6e73  ...#     Returns
-00011fb0: 3a0a 2320 2020 2020 2020 2020 5468 6520  :.#         The 
-00011fc0: 7265 7375 6c74 206f 6620 7468 6520 766d  result of the vm
-00011fd0: 6170 7065 6420 6675 6e63 7469 6f6e 2e0a  apped function..
-00011fe0: 2320 2020 2020 2222 220a 2320 2020 2020  #     """.#     
-00011ff0: 2320 544f 444f 3a20 6669 7820 7468 6973  # TODO: fix this
-00012000: 202d 206e 6f74 2061 6c6c 2061 7267 7320   - not all args 
-00012010: 6d61 7920 6265 2062 6174 6368 6564 0a23  may be batched.#
-00012020: 2020 2020 2023 2054 4f44 4f3a 2068 6572       # TODO: her
-00012030: 6520 7765 2061 7373 756d 6520 6261 7463  e we assume batc
-00012040: 6820 6178 6973 2069 7320 300a 2320 2020  h axis is 0.#   
-00012050: 2020 766d 6170 5f74 7261 6365 203d 206d    vmap_trace = m
-00012060: 616b 655f 7472 6163 6528 0a23 2020 2020  ake_trace(.#    
-00012070: 2020 2020 2076 6d61 7028 6675 6e63 2c20       vmap(func, 
-00012080: 696e 5f64 696d 733d 696e 5f64 696d 732c  in_dims=in_dims,
-00012090: 206f 7574 5f64 696d 733d 6f75 745f 6469   out_dims=out_di
-000120a0: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
-000120b0: 6973 5f73 697a 6529 2c20 6578 6563 7574  is_size), execut
-000120c0: 6f72 3d65 7865 6375 746f 722c 0a23 2020  or=executor,.#  
-000120d0: 2020 2020 2020 202a 6172 6773 290a 2320         *args).# 
-000120e0: 2020 2020 766d 6170 5f74 7261 6365 6420      vmap_traced 
-000120f0: 3d20 6d61 6b65 5f74 7261 6365 6428 7061  = make_traced(pa
-00012100: 7274 6961 6c28 6576 616c 5f74 7261 6365  rtial(eval_trace
-00012110: 2c20 766d 6170 5f74 7261 6365 292c 2065  , vmap_trace), e
-00012120: 7865 6375 746f 723d 6578 6563 7574 6f72  xecutor=executor
-00012130: 290a 2320 2020 2020 7265 7475 726e 2076  ).#     return v
-00012140: 6d61 705f 7472 6163 6564 282a 6172 6773  map_traced(*args
-00012150: 290a 0a0a 2320 4a56 5020 7472 616e 7366  )...# JVP transf
-00012160: 6f72 6d0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  orm.# ----------
-00012170: 2d2d 2d0a 0a0a 4064 6174 6163 6c61 7373  ---...@dataclass
-00012180: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
-00012190: 6173 7320 4a56 5044 7561 6c3a 0a20 2020  ass JVPDual:.   
-000121a0: 2022 2222 4475 616c 206e 756d 6265 7220   """Dual number 
-000121b0: 666f 7220 7468 6520 4a56 5020 7472 616e  for the JVP tran
-000121c0: 7366 6f72 6d2e 0a0a 2020 2020 4174 7472  sform...    Attr
-000121d0: 6962 7574 6573 3a0a 2020 2020 2020 2020  ibutes:.        
-000121e0: 7072 696d 616c 3a20 5072 696d 616c 2076  primal: Primal v
-000121f0: 616c 7565 2e0a 2020 2020 2020 2020 7461  alue..        ta
-00012200: 6e67 656e 743a 2054 616e 6765 6e74 2076  ngent: Tangent v
-00012210: 616c 7565 2e0a 2020 2020 2222 220a 0a20  alue..    """.. 
-00012220: 2020 2070 7269 6d61 6c3a 2041 6e79 0a20     primal: Any. 
-00012230: 2020 2074 616e 6765 6e74 3a20 416e 790a     tangent: Any.
-00012240: 0a20 2020 2064 6566 205f 5f69 7465 725f  .    def __iter_
-00012250: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-00012260: 2079 6965 6c64 2073 656c 662e 7072 696d   yield self.prim
-00012270: 616c 0a20 2020 2020 2020 2079 6965 6c64  al.        yield
-00012280: 2073 656c 662e 7461 6e67 656e 740a 0a0a   self.tangent...
-00012290: 6465 6620 7061 6972 5f74 6f5f 6a76 705f  def pair_to_jvp_
-000122a0: 6475 616c 2870 6169 7229 3a0a 2020 2020  dual(pair):.    
-000122b0: 2222 2243 6f6e 7665 7274 7320 6120 7061  """Converts a pa
-000122c0: 6972 2074 6f20 6120 4a56 5044 7561 6c2e  ir to a JVPDual.
-000122d0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-000122e0: 2020 2020 7061 6972 2028 5365 7175 656e      pair (Sequen
-000122f0: 6365 293a 2050 6169 7220 746f 2063 6f6e  ce): Pair to con
-00012300: 7665 7274 2e0a 0a20 2020 2052 6574 7572  vert...    Retur
-00012310: 6e73 3a0a 2020 2020 2020 2020 4a56 5044  ns:.        JVPD
-00012320: 7561 6c3a 204a 5650 4475 616c 2072 6570  ual: JVPDual rep
-00012330: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
-00012340: 6865 2070 6169 722e 0a20 2020 2022 2222  he pair..    """
-00012350: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
-00012360: 6365 2870 6169 722c 204a 5650 4475 616c  ce(pair, JVPDual
-00012370: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
-00012380: 6e20 7061 6972 0a20 2020 2065 6c73 653a  n pair.    else:
-00012390: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000123a0: 6973 696e 7374 616e 6365 2870 6169 722c  isinstance(pair,
-000123b0: 2053 6571 7565 6e63 6529 2061 6e64 206c   Sequence) and l
-000123c0: 656e 2870 6169 7229 203d 3d20 320a 2020  en(pair) == 2.  
-000123d0: 2020 2020 2020 7265 7475 726e 204a 5650        return JVP
-000123e0: 4475 616c 282a 7061 6972 290a 0a0a 6465  Dual(*pair)...de
-000123f0: 6620 7369 6e5f 6a76 7028 613a 204a 5650  f sin_jvp(a: JVP
-00012400: 4475 616c 293a 0a20 2020 2078 2c20 7864  Dual):.    x, xd
-00012410: 203d 2061 0a20 2020 2072 6574 7572 6e20   = a.    return 
-00012420: 4a56 5044 7561 6c28 7072 696d 732e 7369  JVPDual(prims.si
-00012430: 6e28 7829 2c20 7072 696d 732e 636f 7328  n(x), prims.cos(
-00012440: 7829 202a 2078 6429 0a0a 0a64 6566 206d  x) * xd)...def m
-00012450: 756c 5f6a 7670 2861 3a20 4a56 5044 7561  ul_jvp(a: JVPDua
-00012460: 6c2c 2062 3a20 4a56 5044 7561 6c29 3a0a  l, b: JVPDual):.
-00012470: 2020 2020 782c 2078 6420 3d20 610a 2020      x, xd = a.  
-00012480: 2020 792c 2079 6420 3d20 620a 2020 2020    y, yd = b.    
-00012490: 7265 7475 726e 204a 5650 4475 616c 2878  return JVPDual(x
-000124a0: 202a 2079 2c20 7820 2a20 7964 202b 2079   * y, x * yd + y
-000124b0: 202a 2078 6429 0a0a 0a64 6566 2061 6464   * xd)...def add
-000124c0: 5f6a 7670 2861 3a20 4a56 5044 7561 6c2c  _jvp(a: JVPDual,
-000124d0: 2062 3a20 4a56 5044 7561 6c29 3a0a 2020   b: JVPDual):.  
-000124e0: 2020 782c 2078 6420 3d20 610a 2020 2020    x, xd = a.    
-000124f0: 792c 2079 6420 3d20 620a 2020 2020 7265  y, yd = b.    re
-00012500: 7475 726e 204a 5650 4475 616c 2878 202b  turn JVPDual(x +
-00012510: 2079 2c20 7864 202b 2079 6429 0a0a 0a64   y, xd + yd)...d
-00012520: 6566 2062 726f 6164 6361 7374 5f69 6e5f  ef broadcast_in_
-00012530: 6469 6d5f 6a76 7028 613a 204a 5650 4475  dim_jvp(a: JVPDu
-00012540: 616c 2c20 7368 6170 653a 2074 7570 6c65  al, shape: tuple
-00012550: 5b4a 5650 4475 616c 2c20 2e2e 2e5d 2c20  [JVPDual, ...], 
-00012560: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-00012570: 696f 6e73 3a20 7475 706c 655b 4a56 5044  ions: tuple[JVPD
-00012580: 7561 6c2c 202e 2e2e 5d29 202d 3e20 4a56  ual, ...]) -> JV
-00012590: 5044 7561 6c3a 0a20 2020 2078 2c20 7864  PDual:.    x, xd
-000125a0: 203d 2061 0a20 2020 2023 2054 4f44 4f3a   = a.    # TODO:
-000125b0: 2073 6861 7065 2061 6e64 2062 726f 6164   shape and broad
-000125c0: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
-000125d0: 7368 6f75 6c64 2062 6520 7475 706c 6573  should be tuples
-000125e0: 206f 6620 696e 7473 0a20 2020 2023 2062   of ints.    # b
-000125f0: 7574 2066 6f72 206e 6f77 2069 7427 7320  ut for now it's 
-00012600: 6120 7475 706c 6520 6f66 204a 5650 4475  a tuple of JVPDu
-00012610: 616c 730a 2020 2020 6966 206c 656e 2873  als.    if len(s
-00012620: 6861 7065 2920 3e20 3020 616e 6420 6973  hape) > 0 and is
-00012630: 696e 7374 616e 6365 2873 6861 7065 5b30  instance(shape[0
-00012640: 5d2c 204a 5650 4475 616c 293a 0a20 2020  ], JVPDual):.   
-00012650: 2020 2020 2073 6861 7065 2c20 5f20 3d20       shape, _ = 
-00012660: 7361 6665 5f7a 6970 282a 7368 6170 6529  safe_zip(*shape)
-00012670: 0a20 2020 2069 6620 6c65 6e28 6272 6f61  .    if len(broa
-00012680: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-00012690: 2920 3e20 3020 616e 6420 6973 696e 7374  ) > 0 and isinst
-000126a0: 616e 6365 2862 726f 6164 6361 7374 5f64  ance(broadcast_d
-000126b0: 696d 656e 7369 6f6e 735b 305d 2c20 4a56  imensions[0], JV
-000126c0: 5044 7561 6c29 3a0a 2020 2020 2020 2020  PDual):.        
-000126d0: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-000126e0: 696f 6e73 2c20 5f20 3d20 7361 6665 5f7a  ions, _ = safe_z
-000126f0: 6970 282a 6272 6f61 6463 6173 745f 6469  ip(*broadcast_di
-00012700: 6d65 6e73 696f 6e73 290a 2020 2020 7265  mensions).    re
-00012710: 7475 726e 204a 5650 4475 616c 280a 2020  turn JVPDual(.  
-00012720: 2020 2020 2020 7072 696d 732e 6272 6f61        prims.broa
-00012730: 6463 6173 745f 696e 5f64 696d 2878 2c20  dcast_in_dim(x, 
-00012740: 7368 6170 652c 2062 726f 6164 6361 7374  shape, broadcast
-00012750: 5f64 696d 656e 7369 6f6e 7329 2c20 7072  _dimensions), pr
-00012760: 696d 732e 6272 6f61 6463 6173 745f 696e  ims.broadcast_in
-00012770: 5f64 696d 2878 642c 2073 6861 7065 2c20  _dim(xd, shape, 
-00012780: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-00012790: 696f 6e73 290a 2020 2020 290a 0a0a 6465  ions).    )...de
-000127a0: 6620 756e 7061 636b 5f73 6571 7565 6e63  f unpack_sequenc
-000127b0: 655f 6a76 7028 7365 7175 656e 6365 3a20  e_jvp(sequence: 
-000127c0: 4a56 5044 7561 6c2c 206c 656e 6774 683a  JVPDual, length:
-000127d0: 204a 5650 4475 616c 2920 2d3e 204a 5650   JVPDual) -> JVP
-000127e0: 4475 616c 3a0a 2020 2020 7820 3d20 7472  Dual:.    x = tr
-000127f0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-00012800: 2078 2e70 7269 6d61 6c2c 2073 6571 7565   x.primal, seque
-00012810: 6e63 6529 0a20 2020 2078 6420 3d20 7472  nce).    xd = tr
-00012820: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-00012830: 2078 2e74 616e 6765 6e74 2c20 7365 7175   x.tangent, sequ
-00012840: 656e 6365 290a 2020 2020 6c65 6e67 7468  ence).    length
-00012850: 2c20 5f20 3d20 6c65 6e67 7468 0a20 2020  , _ = length.   
-00012860: 2070 7269 6d61 6c73 203d 2070 7269 6d73   primals = prims
-00012870: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
-00012880: 2878 2c20 6c65 6e67 7468 290a 2020 2020  (x, length).    
-00012890: 7461 6e67 656e 7473 203d 2070 7269 6d73  tangents = prims
-000128a0: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
-000128b0: 2878 642c 206c 656e 6774 6829 0a20 2020  (xd, length).   
-000128c0: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
-000128d0: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
-000128e0: 6c2c 2073 6166 655f 7a69 7028 7072 696d  l, safe_zip(prim
-000128f0: 616c 732c 2074 616e 6765 6e74 7329 290a  als, tangents)).
-00012900: 0a0a 6465 6620 756e 7061 636b 5f74 7269  ..def unpack_tri
-00012910: 7669 616c 5f6a 7670 2878 3a20 4a56 5044  vial_jvp(x: JVPD
-00012920: 7561 6c29 202d 3e20 4a56 5044 7561 6c3a  ual) -> JVPDual:
-00012930: 0a20 2020 2072 6574 7572 6e20 780a 0a0a  .    return x...
-00012940: 6a76 705f 696d 706c 733a 2064 6963 745b  jvp_impls: dict[
-00012950: 7072 696d 732e 5379 6d62 6f6c 2c20 4361  prims.Symbol, Ca
-00012960: 6c6c 6162 6c65 5d20 3d20 6469 6374 2829  llable] = dict()
-00012970: 0a0a 6a76 705f 696d 706c 735b 7072 696d  ..jvp_impls[prim
-00012980: 732e 5072 696d 4944 732e 5349 4e5d 203d  s.PrimIDs.SIN] =
-00012990: 2073 696e 5f6a 7670 0a6a 7670 5f69 6d70   sin_jvp.jvp_imp
-000129a0: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
-000129b0: 2e4d 554c 5d20 3d20 6d75 6c5f 6a76 700a  .MUL] = mul_jvp.
-000129c0: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
-000129d0: 5072 696d 4944 732e 4144 445d 203d 2061  PrimIDs.ADD] = a
-000129e0: 6464 5f6a 7670 0a6a 7670 5f69 6d70 6c73  dd_jvp.jvp_impls
-000129f0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e42  [prims.PrimIDs.B
-00012a00: 524f 4144 4341 5354 5f49 4e5f 4449 4d5d  ROADCAST_IN_DIM]
-00012a10: 203d 2062 726f 6164 6361 7374 5f69 6e5f   = broadcast_in_
-00012a20: 6469 6d5f 6a76 700a 2320 6a76 705f 696d  dim_jvp.# jvp_im
-00012a30: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-00012a40: 732e 554e 5041 434b 5f53 4551 5545 4e43  s.UNPACK_SEQUENC
-00012a50: 455d 203d 2075 6e70 6163 6b5f 7365 7175  E] = unpack_sequ
-00012a60: 656e 6365 5f6a 7670 0a23 206a 7670 5f69  ence_jvp.# jvp_i
-00012a70: 6d70 6c73 5b70 7269 6d73 2e50 7269 6d49  mpls[prims.PrimI
-00012a80: 4473 2e55 4e50 4143 4b5f 5452 4956 4941  Ds.UNPACK_TRIVIA
-00012a90: 4c5d 203d 2075 6e70 6163 6b5f 7472 6976  L] = unpack_triv
-00012aa0: 6961 6c5f 6a76 700a 0a0a 6465 6620 6a76  ial_jvp...def jv
-00012ab0: 705f 7379 6d62 6f6c 5f6d 6170 7065 7228  p_symbol_mapper(
-00012ac0: 7379 6d62 6f6c 3a20 7072 696d 732e 5379  symbol: prims.Sy
-00012ad0: 6d62 6f6c 293a 0a20 2020 2022 2222 4d61  mbol):.    """Ma
-00012ae0: 7073 2061 2073 796d 626f 6c20 746f 2061  ps a symbol to a
-00012af0: 204a 5650 2066 756e 6374 696f 6e20 7468   JVP function th
-00012b00: 6174 2065 7661 6c75 6174 6573 2069 742e  at evaluates it.
-00012b10: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-00012b20: 2020 2020 7379 6d62 6f6c 2028 7072 696d      symbol (prim
-00012b30: 732e 5379 6d62 6f6c 293a 2053 796d 626f  s.Symbol): Symbo
-00012b40: 6c20 746f 2065 7661 6c75 6174 652e 0a0a  l to evaluate...
-00012b50: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-00012b60: 2020 2020 4e6f 7449 6d70 6c65 6d65 6e74      NotImplement
-00012b70: 6564 4572 726f 723a 2049 6620 7468 6520  edError: If the 
-00012b80: 4a56 5020 666f 7220 7468 6520 7379 6d62  JVP for the symb
-00012b90: 6f6c 2069 7320 6e6f 7420 696d 706c 656d  ol is not implem
-00012ba0: 656e 7465 642e 0a0a 2020 2020 5265 7475  ented...    Retu
-00012bb0: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-00012bc0: 6c61 626c 653a 204a 5650 2066 756e 6374  lable: JVP funct
-00012bd0: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
-00012be0: 6573 2074 6865 2073 796d 626f 6c2e 0a20  es the symbol.. 
-00012bf0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-00012c00: 7772 6170 5f61 7267 2878 293a 0a20 2020  wrap_arg(x):.   
-00012c10: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00012c20: 6365 2878 2c20 4a56 5044 7561 6c29 3a0a  ce(x, JVPDual):.
-00012c30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012c40: 726e 2078 0a20 2020 2020 2020 2065 6c69  rn x.        eli
-00012c50: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-00012c60: 4e75 6d62 6572 293a 0a20 2020 2020 2020  Number):.       
-00012c70: 2020 2020 2072 6574 7572 6e20 4a56 5044       return JVPD
-00012c80: 7561 6c28 782c 2074 7970 6528 7829 2830  ual(x, type(x)(0
-00012c90: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
-00012ca0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00012cb0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00012cc0: 4a56 5020 7772 6170 5f61 7267 2067 6f74  JVP wrap_arg got
-00012cd0: 2061 6e20 756e 7375 7070 6f72 7465 6420   an unsupported 
-00012ce0: 7479 7065 207b 7479 7065 2878 297d 2229  type {type(x)}")
-00012cf0: 0a0a 2020 2020 2320 4966 2073 796d 626f  ..    # If symbo
-00012d00: 6c2e 6172 6773 2064 6f65 736e 2774 2068  l.args doesn't h
-00012d10: 6176 6520 7375 6263 6c61 7373 6573 206f  ave subclasses o
-00012d20: 6620 5661 7269 6162 6c65 2c20 7468 656e  f Variable, then
-00012d30: 2077 6520 6e65 6564 2074 6f20 7265 7475   we need to retu
-00012d40: 726e 2061 207a 6572 6f20 7461 6e67 656e  rn a zero tangen
-00012d50: 740a 2020 2020 2320 544f 444f 3a20 7468  t.    # TODO: th
-00012d60: 6572 6520 6d61 7920 6265 2061 2062 6574  ere may be a bet
-00012d70: 7465 7220 7761 7920 746f 2064 6574 6563  ter way to detec
-00012d80: 7420 636f 6e73 7461 6e74 7320 696e 2074  t constants in t
-00012d90: 6865 2074 7261 6365 0a20 2020 2069 6620  he trace.    if 
-00012da0: 7379 6d62 6f6c 2e61 7265 5f61 6c6c 5f61  symbol.are_all_a
-00012db0: 7267 735f 636f 6e73 7461 6e74 3a0a 0a20  rgs_constant:.. 
-00012dc0: 2020 2020 2020 2064 6566 207a 6572 6f73         def zeros
-00012dd0: 5f6c 696b 6528 7829 3a0a 2020 2020 2020  _like(x):.      
-00012de0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00012df0: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
-00012e00: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-00012e10: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
-00012e20: 5f6c 696b 6528 782c 2066 696c 6c5f 7661  _like(x, fill_va
-00012e30: 6c75 653d 3029 0a20 2020 2020 2020 2020  lue=0).         
-00012e40: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00012e50: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
-00012e60: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
-00012e70: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
-00012e80: 782e 7661 6c75 6529 2830 290a 2020 2020  x.value)(0).    
-00012e90: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-00012ea0: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
-00012eb0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00012ec0: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
-00012ed0: 7829 2830 290a 2020 2020 2020 2020 2020  x)(0).          
-00012ee0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00012ef0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00012f00: 6c75 6545 7272 6f72 2866 227a 6572 6f73  lueError(f"zeros
-00012f10: 5f6c 696b 6520 696e 7369 6465 204a 5650  _like inside JVP
-00012f20: 2067 6f74 2061 6e20 756e 7375 7070 6f72   got an unsuppor
-00012f30: 7465 6420 7479 7065 207b 7479 7065 2878  ted type {type(x
-00012f40: 297d 2229 0a0a 2020 2020 2020 2020 6465  )}")..        de
-00012f50: 6620 6a76 705f 696d 706c 5f63 6f6e 7374  f jvp_impl_const
-00012f60: 2873 796d 626f 6c2c 202a 6172 6773 2c20  (symbol, *args, 
-00012f70: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00012f80: 2020 2020 2020 2070 7269 6d61 6c73 203d         primals =
-00012f90: 2073 796d 626f 6c5f 746f 5f65 7661 6c28   symbol_to_eval(
-00012fa0: 7379 6d62 6f6c 2928 2a61 7267 732c 202a  symbol)(*args, *
-00012fb0: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-00012fc0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00012fd0: 6365 2870 7269 6d61 6c73 2c20 5365 7175  ce(primals, Sequ
-00012fe0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-00012ff0: 2020 2020 2020 2074 616e 6765 6e74 7320         tangents 
-00013000: 3d20 7475 706c 6528 7a65 726f 735f 6c69  = tuple(zeros_li
-00013010: 6b65 2870 2920 666f 7220 7020 696e 2070  ke(p) for p in p
-00013020: 7269 6d61 6c73 290a 2020 2020 2020 2020  rimals).        
-00013030: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00013040: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
-00013050: 6a76 705f 6475 616c 2c20 7361 6665 5f7a  jvp_dual, safe_z
-00013060: 6970 2870 7269 6d61 6c73 2c20 7461 6e67  ip(primals, tang
-00013070: 656e 7473 2929 0a20 2020 2020 2020 2020  ents)).         
-00013080: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-00013090: 6c28 7072 696d 616c 732c 207a 6572 6f73  l(primals, zeros
-000130a0: 5f6c 696b 6528 7072 696d 616c 7329 290a  _like(primals)).
-000130b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000130c0: 7061 7274 6961 6c28 6a76 705f 696d 706c  partial(jvp_impl
-000130d0: 5f63 6f6e 7374 2c20 7379 6d62 6f6c 290a  _const, symbol).
-000130e0: 0a20 2020 2023 204e 6f72 6d61 6c20 6361  .    # Normal ca
-000130f0: 7365 2c20 7765 2068 6176 6520 6120 7072  se, we have a pr
-00013100: 6f78 7920 7461 6e67 656e 740a 2020 2020  oxy tangent.    
-00013110: 6a76 705f 696d 706c 203d 206a 7670 5f69  jvp_impl = jvp_i
-00013120: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
-00013130: 7379 6d2e 6964 290a 2020 2020 6966 206a  sym.id).    if j
-00013140: 7670 5f69 6d70 6c20 6973 204e 6f6e 653a  vp_impl is None:
-00013150: 0a20 2020 2020 2020 2072 6169 7365 204e  .        raise N
-00013160: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-00013170: 6f72 2866 224a 5650 2066 6f72 207b 7379  or(f"JVP for {sy
-00013180: 6d62 6f6c 2e73 796d 2e69 647d 2069 7320  mbol.sym.id} is 
-00013190: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-000131a0: 290a 0a20 2020 2064 6566 205f 6a76 705f  )..    def _jvp_
-000131b0: 696d 706c 282a 6172 6773 2c20 2a2a 6b77  impl(*args, **kw
-000131c0: 6172 6773 293a 0a20 2020 2020 2020 2061  args):.        a
-000131d0: 7267 7320 3d20 7472 6565 5f6d 6170 2877  rgs = tree_map(w
-000131e0: 7261 705f 6172 672c 2061 7267 7329 0a20  rap_arg, args). 
-000131f0: 2020 2020 2020 2023 2045 7870 6563 7469         # Expecti
-00013200: 6e67 204a 5650 4475 616c 7320 7772 6170  ng JVPDuals wrap
-00013210: 7069 6e67 2070 6169 7273 206f 6620 7072  ping pairs of pr
-00013220: 696d 616c 7320 616e 6420 7461 6e67 656e  imals and tangen
-00013230: 7473 0a20 2020 2020 2020 2061 7373 6572  ts.        asser
-00013240: 7420 616c 6c28 6973 696e 7374 616e 6365  t all(isinstance
-00013250: 2861 7267 2c20 4a56 5044 7561 6c29 2066  (arg, JVPDual) f
-00013260: 6f72 2061 7267 2069 6e20 7472 6565 5f66  or arg in tree_f
-00013270: 6c61 7474 656e 2861 7267 7329 5b30 5d29  latten(args)[0])
-00013280: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013290: 6a76 705f 696d 706c 282a 6172 6773 2c20  jvp_impl(*args, 
-000132a0: 2a2a 6b77 6172 6773 290a 0a20 2020 2072  **kwargs)..    r
-000132b0: 6574 7572 6e20 5f6a 7670 5f69 6d70 6c0a  eturn _jvp_impl.
-000132c0: 0a0a 6465 6620 5f6a 7670 5f63 616c 6c5f  ..def _jvp_call_
-000132d0: 6d65 7461 6675 6e63 2864 6574 6163 6865  metafunc(detache
-000132e0: 643a 2062 6f6f 6c2c 2070 7269 6d61 6c73  d: bool, primals
-000132f0: 2c20 7461 6e67 656e 7473 2c20 2a2c 2066  , tangents, *, f
-00013300: 756e 6374 696f 6e5f 7472 6163 653a 2054  unction_trace: T
-00013310: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
-00013320: 0a20 2020 2022 2222 4d65 7461 6675 6e63  .    """Metafunc
-00013330: 7469 6f6e 2066 6f72 2074 6865 204a 5650  tion for the JVP
-00013340: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
-00013350: 2041 7267 733a 0a20 2020 2020 2020 2064   Args:.        d
-00013360: 6574 6163 6865 6420 2862 6f6f 6c29 3a20  etached (bool): 
-00013370: 5768 6574 6865 7220 746f 2064 6574 6163  Whether to detac
-00013380: 6820 7468 6520 7472 6163 652e 0a20 2020  h the trace..   
-00013390: 2020 2020 2070 7269 6d61 6c73 2028 5475       primals (Tu
-000133a0: 706c 655b 5072 6f78 795d 293a 2050 7269  ple[Proxy]): Pri
-000133b0: 6d61 6c20 7661 6c75 6573 2e0a 2020 2020  mal values..    
-000133c0: 2020 2020 7461 6e67 656e 7473 2028 5475      tangents (Tu
-000133d0: 706c 655b 5072 6f78 795d 293a 2054 616e  ple[Proxy]): Tan
-000133e0: 6765 6e74 2076 616c 7565 732e 0a20 2020  gent values..   
-000133f0: 2020 2020 2066 756e 6374 696f 6e5f 7472       function_tr
-00013400: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
-00013410: 6365 206f 6620 7468 6520 6675 6e63 7469  ce of the functi
-00013420: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
-00013430: 726d 6564 2e0a 2020 2020 2020 2020 6b77  rmed..        kw
-00013440: 6172 6773 3a20 4b65 7977 6f72 6420 6172  args: Keyword ar
-00013450: 6775 6d65 6e74 732e 0a0a 2020 2020 5261  guments...    Ra
-00013460: 6973 6573 3a0a 2020 2020 2020 2020 4173  ises:.        As
-00013470: 7365 7274 696f 6e45 7272 6f72 3a20 4966  sertionError: If
-00013480: 2074 6865 204a 5650 2066 6f72 206b 6579   the JVP for key
-00013490: 776f 7264 2061 7267 756d 656e 7473 2069  word arguments i
-000134a0: 7320 6e6f 7420 696d 706c 656d 656e 7465  s not implemente
-000134b0: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
-000134c0: 0a20 2020 2020 2020 2052 6573 756c 7420  .        Result 
-000134d0: 6f66 2074 6865 204a 5650 2074 7261 6e73  of the JVP trans
-000134e0: 666f 726d 2e0a 2020 2020 2222 220a 2020  form..    """.  
-000134f0: 2020 6173 7365 7274 206c 656e 286b 7761    assert len(kwa
-00013500: 7267 7329 203d 3d20 302c 2022 4a56 5020  rgs) == 0, "JVP 
-00013510: 666f 7220 6b77 6172 6773 2069 7320 6e6f  for kwargs is no
-00013520: 7420 696d 706c 656d 656e 7465 6422 0a0a  t implemented"..
-00013530: 2020 2020 6374 7820 3d20 6465 7461 6368      ctx = detach
-00013540: 6564 5f74 7261 6365 2829 2069 6620 6465  ed_trace() if de
-00013550: 7461 6368 6564 2065 6c73 6520 6e75 6c6c  tached else null
-00013560: 636f 6e74 6578 7428 290a 2020 2020 7769  context().    wi
-00013570: 7468 2063 7478 3a0a 2020 2020 2020 2020  th ctx:.        
-00013580: 2320 5772 6170 7069 6e67 2074 6865 2070  # Wrapping the p
-00013590: 7269 6d61 6c73 2061 6e64 2074 616e 6765  rimals and tange
-000135a0: 6e74 7320 696e 204a 5650 4475 616c 7320  nts in JVPDuals 
-000135b0: 6973 206e 6f74 2073 7472 6963 746c 7920  is not strictly 
-000135c0: 6e65 6365 7373 6172 792c 2062 7574 2069  necessary, but i
-000135d0: 7420 6d61 6b65 730a 2020 2020 2020 2020  t makes.        
-000135e0: 2320 7468 6520 636f 6465 206d 6f72 6520  # the code more 
-000135f0: 7265 6164 6162 6c65 0a20 2020 2020 2020  readable.       
-00013600: 2023 2057 6520 7072 6f70 6167 6174 6520   # We propagate 
-00013610: 7468 6520 4a56 5044 7561 6c73 2074 6872  the JVPDuals thr
-00013620: 6f75 6768 2074 6865 2074 7261 6365 2c20  ough the trace, 
-00013630: 616e 6420 7468 656e 2075 6e77 7261 7020  and then unwrap 
-00013640: 7468 656d 2061 7420 7468 6520 656e 640a  them at the end.
-00013650: 2020 2020 2020 2020 7072 696d 616c 735f          primals_
-00013660: 7461 6e67 656e 7473 5f64 7561 6c73 203d  tangents_duals =
-00013670: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
-00013680: 6f5f 6a76 705f 6475 616c 2c20 7361 6665  o_jvp_dual, safe
-00013690: 5f7a 6970 2870 7269 6d61 6c73 2c20 7461  _zip(primals, ta
-000136a0: 6e67 656e 7473 2929 0a20 2020 2020 2020  ngents)).       
-000136b0: 2072 6573 756c 7420 3d20 6576 616c 5f74   result = eval_t
-000136c0: 7261 6365 2866 756e 6374 696f 6e5f 7472  race(function_tr
-000136d0: 6163 652c 202a 7072 696d 616c 735f 7461  ace, *primals_ta
-000136e0: 6e67 656e 7473 5f64 7561 6c73 2c20 7379  ngents_duals, sy
-000136f0: 6d62 6f6c 5f6d 6170 7065 723d 6a76 705f  mbol_mapper=jvp_
-00013700: 7379 6d62 6f6c 5f6d 6170 7065 7229 0a20  symbol_mapper). 
-00013710: 2020 2020 2020 2023 2055 6e77 7261 7070         # Unwrapp
-00013720: 696e 6720 7468 6520 4a56 5044 7561 6c73  ing the JVPDuals
-00013730: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-00013740: 7374 616e 6365 2872 6573 756c 742c 2053  stance(result, S
-00013750: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-00013760: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-00013770: 2869 7369 6e73 7461 6e63 6528 782c 204a  (isinstance(x, J
-00013780: 5650 4475 616c 2920 666f 7220 7820 696e  VPDual) for x in
-00013790: 2072 6573 756c 7429 0a20 2020 2020 2020   result).       
-000137a0: 2020 2020 2070 7269 6d61 6c73 2c20 7461       primals, ta
-000137b0: 6e67 656e 7473 203d 2075 6e7a 6970 3228  ngents = unzip2(
-000137c0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
-000137d0: 2020 2020 7265 7475 726e 2070 7269 6d61      return prima
-000137e0: 6c73 2c20 7461 6e67 656e 7473 0a20 2020  ls, tangents.   
-000137f0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00013800: 7374 616e 6365 2872 6573 756c 742c 204a  stance(result, J
-00013810: 5650 4475 616c 290a 2020 2020 2020 2020  VPDual).        
-00013820: 7265 7475 726e 2072 6573 756c 742e 7072  return result.pr
-00013830: 696d 616c 2c20 7265 7375 6c74 2e74 616e  imal, result.tan
-00013840: 6765 6e74 0a0a 0a6a 7670 5f63 616c 6c20  gent...jvp_call 
-00013850: 3d20 5379 6d62 6f6c 2869 643d 5472 616e  = Symbol(id=Tran
-00013860: 7366 6f72 6d73 2e4a 7670 4f70 2c20 6e61  sforms.JvpOp, na
-00013870: 6d65 3d22 6a76 705f 6361 6c6c 222c 206d  me="jvp_call", m
-00013880: 6574 613d 7061 7274 6961 6c28 5f6a 7670  eta=partial(_jvp
-00013890: 5f63 616c 6c5f 6d65 7461 6675 6e63 2c20  _call_metafunc, 
-000138a0: 4661 6c73 6529 290a 0a0a 6465 6620 5f69  False))...def _i
-000138b0: 6465 6e74 6974 795f 6361 6c6c 5f6a 7670  dentity_call_jvp
-000138c0: 282a 6172 6773 3a20 4a56 5044 7561 6c2c  (*args: JVPDual,
-000138d0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-000138e0: 2a6b 7761 7267 7329 3a0a 2020 2020 7072  *kwargs):.    pr
-000138f0: 696d 616c 732c 2074 616e 6765 6e74 7320  imals, tangents 
-00013900: 3d20 756e 7a69 7032 2861 7267 7329 0a20  = unzip2(args). 
-00013910: 2020 206f 7574 5f70 7269 6d61 6c73 2c20     out_primals, 
-00013920: 6f75 745f 7461 6e67 656e 7473 203d 205f  out_tangents = _
-00013930: 6a76 705f 6361 6c6c 5f6d 6574 6166 756e  jvp_call_metafun
-00013940: 6328 4661 6c73 652c 2070 7269 6d61 6c73  c(False, primals
-00013950: 2c20 7461 6e67 656e 7473 2c20 7472 6163  , tangents, trac
-00013960: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-00013970: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-00013980: 7574 5f70 7269 6d61 6c73 2c20 5365 7175  ut_primals, Sequ
-00013990: 656e 6365 293a 0a20 2020 2020 2020 2072  ence):.        r
-000139a0: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
-000139b0: 6169 725f 746f 5f6a 7670 5f64 7561 6c2c  air_to_jvp_dual,
-000139c0: 2073 6166 655f 7a69 7028 6f75 745f 7072   safe_zip(out_pr
-000139d0: 696d 616c 732c 206f 7574 5f74 616e 6765  imals, out_tange
-000139e0: 6e74 7329 290a 2020 2020 7265 7475 726e  nts)).    return
-000139f0: 204a 5650 4475 616c 286f 7574 5f70 7269   JVPDual(out_pri
-00013a00: 6d61 6c73 2c20 6f75 745f 7461 6e67 656e  mals, out_tangen
-00013a10: 7473 290a 0a0a 6a76 705f 696d 706c 735b  ts)...jvp_impls[
-00013a20: 5472 616e 7366 6f72 6d73 2e49 6465 6e74  Transforms.Ident
-00013a30: 6974 794f 705d 203d 205f 6964 656e 7469  ityOp] = _identi
-00013a40: 7479 5f63 616c 6c5f 6a76 700a 0a0a 6465  ty_call_jvp...de
-00013a50: 6620 5f76 6d61 705f 6361 6c6c 5f6a 7670  f _vmap_call_jvp
-00013a60: 2861 7267 733a 204a 5650 4475 616c 2c20  (args: JVPDual, 
-00013a70: 696e 5f64 696d 732c 206f 7574 5f64 696d  in_dims, out_dim
-00013a80: 732c 2061 7869 735f 7369 7a65 2c20 7472  s, axis_size, tr
-00013a90: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-00013aa0: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
-00013ab0: 6c73 2c20 7461 6e67 656e 7473 203d 2073  ls, tangents = s
-00013ac0: 6166 655f 7a69 7028 2a61 7267 7329 0a20  afe_zip(*args). 
-00013ad0: 2020 2069 6e5f 6469 6d73 2c20 5f20 3d20     in_dims, _ = 
-00013ae0: 7361 6665 5f7a 6970 282a 696e 5f64 696d  safe_zip(*in_dim
-00013af0: 7329 0a20 2020 206f 7574 5f64 696d 732c  s).    out_dims,
-00013b00: 205f 203d 2073 6166 655f 7a69 7028 2a6f   _ = safe_zip(*o
-00013b10: 7574 5f64 696d 7329 0a20 2020 2076 6d61  ut_dims).    vma
-00013b20: 7070 6564 5f74 7261 6365 203d 2063 6f6e  pped_trace = con
-00013b30: 7374 7275 6374 5f74 7261 6365 2829 280a  struct_trace()(.
-00013b40: 2020 2020 2020 2020 766d 6170 2870 6172          vmap(par
-00013b50: 7469 616c 2865 7661 6c5f 7472 6163 652c  tial(eval_trace,
-00013b60: 2074 7261 6365 292c 2069 6e5f 6469 6d73   trace), in_dims
-00013b70: 3d69 6e5f 6469 6d73 2c20 6f75 745f 6469  =in_dims, out_di
-00013b80: 6d73 3d6f 7574 5f64 696d 732c 2061 7869  ms=out_dims, axi
-00013b90: 735f 7369 7a65 3d61 7869 735f 7369 7a65  s_size=axis_size
-00013ba0: 292c 202a 7072 696d 616c 730a 2020 2020  ), *primals.    
-00013bb0: 290a 2020 2020 766d 6170 7065 645f 6675  ).    vmapped_fu
-00013bc0: 6e63 203d 2070 6172 7469 616c 2865 7661  nc = partial(eva
-00013bd0: 6c5f 7472 6163 652c 2076 6d61 7070 6564  l_trace, vmapped
-00013be0: 5f74 7261 6365 290a 2020 2020 6f75 745f  _trace).    out_
-00013bf0: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
-00013c00: 6765 6e74 7320 3d20 6a76 7028 766d 6170  gents = jvp(vmap
-00013c10: 7065 645f 6675 6e63 2928 7072 696d 616c  ped_func)(primal
-00013c20: 732c 2074 616e 6765 6e74 732c 202a 2a6b  s, tangents, **k
-00013c30: 7761 7267 7329 0a20 2020 2069 6620 6973  wargs).    if is
-00013c40: 696e 7374 616e 6365 286f 7574 5f70 7269  instance(out_pri
-00013c50: 6d61 6c73 2c20 5365 7175 656e 6365 293a  mals, Sequence):
-00013c60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00013c70: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
-00013c80: 5f6a 7670 5f64 7561 6c2c 2073 6166 655f  _jvp_dual, safe_
-00013c90: 7a69 7028 6f75 745f 7072 696d 616c 732c  zip(out_primals,
-00013ca0: 206f 7574 5f74 616e 6765 6e74 7329 290a   out_tangents)).
-00013cb0: 2020 2020 7265 7475 726e 204a 5650 4475      return JVPDu
-00013cc0: 616c 286f 7574 5f70 7269 6d61 6c73 2c20  al(out_primals, 
-00013cd0: 6f75 745f 7461 6e67 656e 7473 290a 0a0a  out_tangents)...
-00013ce0: 6a76 705f 696d 706c 735b 5472 616e 7366  jvp_impls[Transf
-00013cf0: 6f72 6d73 2e56 6d61 704f 705d 203d 205f  orms.VmapOp] = _
-00013d00: 766d 6170 5f63 616c 6c5f 6a76 700a 0a0a  vmap_call_jvp...
-00013d10: 6465 6620 6a76 7028 6675 6e63 293a 0a20  def jvp(func):. 
-00013d20: 2020 2022 2222 4a61 636f 6269 616e 2d76     """Jacobian-v
-00013d30: 6563 746f 7220 7072 6f64 7563 7420 7472  ector product tr
-00013d40: 616e 7366 6f72 6d20 666f 7220 6120 5468  ansform for a Th
-00013d50: 756e 6465 7220 6675 6e63 7469 6f6e 2e0a  under function..
-00013d60: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00013d70: 2020 2066 756e 6320 2843 616c 6c61 626c     func (Callabl
-00013d80: 6529 3a20 4120 5468 756e 6465 7220 6675  e): A Thunder fu
-00013d90: 6e63 7469 6f6e 2074 6f20 6265 2074 7261  nction to be tra
-00013da0: 6e73 666f 726d 6564 2e0a 0a20 2020 2052  nsformed...    R
-00013db0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00013dc0: 4361 6c6c 6162 6c65 3a20 4120 6675 6e63  Callable: A func
-00013dd0: 7469 6f6e 2074 6861 7420 636f 6d70 7574  tion that comput
-00013de0: 6573 2074 6865 204a 6163 6f62 6961 6e2d  es the Jacobian-
-00013df0: 7665 6374 6f72 2070 726f 6475 6374 0a20  vector product. 
-00013e00: 2020 2020 2020 2020 2020 2074 616b 696e             takin
-00013e10: 6720 7072 696d 616c 7320 616e 6420 7461  g primals and ta
-00013e20: 6e67 656e 7473 2061 7320 6172 6775 6d65  ngents as argume
-00013e30: 6e74 732e 0a20 2020 2022 2222 0a0a 2020  nts..    """..  
-00013e40: 2020 6465 6620 7772 6170 7065 7228 7072    def wrapper(pr
-00013e50: 696d 616c 732c 2074 616e 6765 6e74 7329  imals, tangents)
-00013e60: 3a0a 2020 2020 2020 2020 7472 6163 6520  :.        trace 
-00013e70: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-00013e80: 6528 2928 6675 6e63 2c20 2a70 7269 6d61  e()(func, *prima
-00013e90: 6c73 290a 2020 2020 2020 2020 7265 7475  ls).        retu
-00013ea0: 726e 206a 7670 5f63 616c 6c28 7072 696d  rn jvp_call(prim
-00013eb0: 616c 732c 2074 616e 6765 6e74 732c 2066  als, tangents, f
-00013ec0: 756e 6374 696f 6e5f 7472 6163 653d 7472  unction_trace=tr
-00013ed0: 6163 6529 0a0a 2020 2020 7265 7475 726e  ace)..    return
-00013ee0: 2077 7261 7070 6572 0a0a 0a23 2054 4f44   wrapper...# TOD
-00013ef0: 4f20 5468 6973 2066 756e 6374 696f 6e20  O This function 
-00013f00: 636f 6d6d 656e 7465 6420 6f75 7420 6265  commented out be
-00013f10: 6361 7573 6520 6974 2063 616c 6c73 206d  cause it calls m
-00013f20: 616b 655f 7472 6163 6564 2c20 7768 6963  ake_traced, whic
-00013f30: 6820 646f 6573 206e 6f74 2065 7869 7374  h does not exist
-00013f40: 0a23 2064 6566 206a 7670 5f65 6167 6572  .# def jvp_eager
-00013f50: 2866 756e 632c 2070 7269 6d61 6c73 2c20  (func, primals, 
-00013f60: 7461 6e67 656e 7473 2c20 6578 6563 7574  tangents, execut
-00013f70: 6f72 3d22 746f 7263 6822 293a 0a23 2020  or="torch"):.#  
-00013f80: 2020 2022 2222 436f 6d70 7574 6573 2074     """Computes t
-00013f90: 6865 204a 6163 6f62 6961 6e2d 7665 6374  he Jacobian-vect
-00013fa0: 6f72 2070 726f 6475 6374 206f 6620 6120  or product of a 
-00013fb0: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
-00013fc0: 2e0a 0a23 2020 2020 2041 7267 733a 0a23  ...#     Args:.#
-00013fd0: 2020 2020 2020 2020 2066 756e 6320 2843           func (C
-00013fe0: 616c 6c61 626c 6529 3a20 4120 5468 756e  allable): A Thun
-00013ff0: 6465 7220 6675 6e63 7469 6f6e 2074 6f20  der function to 
-00014000: 6265 2074 7261 6e73 666f 726d 6564 2e0a  be transformed..
-00014010: 2320 2020 2020 2020 2020 7072 696d 616c  #         primal
-00014020: 7320 285f 7479 7065 5f29 3a20 5072 696d  s (_type_): Prim
-00014030: 616c 7320 6f66 2074 6865 2066 756e 6374  als of the funct
-00014040: 696f 6e2e 0a23 2020 2020 2020 2020 2074  ion..#         t
-00014050: 616e 6765 6e74 7320 285f 7479 7065 5f29  angents (_type_)
-00014060: 3a20 5461 6e67 656e 7473 206f 6620 7468  : Tangents of th
-00014070: 6520 6675 6e63 7469 6f6e 2e0a 2320 2020  e function..#   
-00014080: 2020 2020 2020 6578 6563 7574 6f72 2028        executor (
-00014090: 7374 722c 206f 7074 696f 6e61 6c29 3a20  str, optional): 
-000140a0: 4578 6563 7574 6f72 2074 6f20 7573 652e  Executor to use.
-000140b0: 2044 6566 6175 6c74 7320 746f 2022 746f   Defaults to "to
-000140c0: 7263 6822 2e0a 0a23 2020 2020 2052 6574  rch"...#     Ret
-000140d0: 7572 6e73 3a0a 2320 2020 2020 2020 2020  urns:.#         
-000140e0: 5468 6520 7265 7375 6c74 206f 6620 7468  The result of th
-000140f0: 6520 4a61 636f 6269 616e 2d76 6563 746f  e Jacobian-vecto
-00014100: 7220 7072 6f64 7563 742e 0a23 2020 2020  r product..#    
-00014110: 2022 2222 0a23 2020 2020 2074 7261 6365   """.#     trace
-00014120: 203d 206d 616b 655f 7472 6163 6528 6675   = make_trace(fu
-00014130: 6e63 2c20 6578 6563 7574 6f72 3d65 7865  nc, executor=exe
-00014140: 6375 746f 722c 202a 7072 696d 616c 7329  cutor, *primals)
-00014150: 0a0a 2320 2020 2020 6465 6620 6a76 705f  ..#     def jvp_
-00014160: 6675 6e63 282a 7072 696d 616c 735f 616e  func(*primals_an
-00014170: 645f 7461 6e67 656e 7473 293a 0a23 2020  d_tangents):.#  
-00014180: 2020 2020 2020 205f 7072 696d 616c 732c         _primals,
-00014190: 205f 7461 6e67 656e 7473 203d 2070 7269   _tangents = pri
-000141a0: 6d61 6c73 5f61 6e64 5f74 616e 6765 6e74  mals_and_tangent
-000141b0: 735b 3a20 6c65 6e28 7072 696d 616c 7329  s[: len(primals)
-000141c0: 5d2c 2070 7269 6d61 6c73 5f61 6e64 5f74  ], primals_and_t
-000141d0: 616e 6765 6e74 735b 6c65 6e28 7072 696d  angents[len(prim
-000141e0: 616c 7329 203a 5d0a 2320 2020 2020 2020  als) :].#       
-000141f0: 2020 7265 7475 726e 205f 6a76 705f 6361    return _jvp_ca
-00014200: 6c6c 5f6d 6574 6166 756e 6328 5f70 7269  ll_metafunc(_pri
-00014210: 6d61 6c73 2c20 5f74 616e 6765 6e74 732c  mals, _tangents,
-00014220: 2074 7261 6365 2c20 6465 7461 6368 6564   trace, detached
-00014230: 3d46 616c 7365 290a 0a23 2020 2020 206a  =False)..#     j
-00014240: 7670 5f74 7261 6365 203d 206d 616b 655f  vp_trace = make_
-00014250: 7472 6163 6528 6a76 705f 6675 6e63 2c20  trace(jvp_func, 
-00014260: 6578 6563 7574 6f72 3d65 7865 6375 746f  executor=executo
-00014270: 7229 282a 7072 696d 616c 732c 202a 7461  r)(*primals, *ta
-00014280: 6e67 656e 7473 290a 2320 2020 2020 6a76  ngents).#     jv
-00014290: 705f 7472 6163 6564 203d 206d 616b 655f  p_traced = make_
-000142a0: 7472 6163 6564 2870 6172 7469 616c 2865  traced(partial(e
-000142b0: 7661 6c5f 7472 6163 652c 206a 7670 5f74  val_trace, jvp_t
-000142c0: 7261 6365 292c 2065 7865 6375 746f 723d  race), executor=
-000142d0: 6578 6563 7574 6f72 290a 2320 2020 2020  executor).#     
-000142e0: 7265 7475 726e 206a 7670 5f74 7261 6365  return jvp_trace
-000142f0: 6428 2a70 7269 6d61 6c73 2c20 2a74 616e  d(*primals, *tan
-00014300: 6765 6e74 7329 0a0a 0a23 2056 4a50 2074  gents)...# VJP t
-00014310: 7261 6e73 666f 726d 0a23 203d 3d3d 3d3d  ransform.# =====
-00014320: 3d3d 3d3d 3d3d 3d3d 0a40 6461 7461 636c  ========.@datacl
-00014330: 6173 7328 6672 6f7a 656e 3d54 7275 6529  ass(frozen=True)
-00014340: 0a63 6c61 7373 2056 4a50 4475 616c 3a0a  .class VJPDual:.
-00014350: 2020 2020 2222 2241 2070 6169 7220 6f66      """A pair of
-00014360: 2070 7269 6d61 6c20 616e 6420 7361 7665   primal and save
-00014370: 6420 696e 666f 726d 6174 696f 6e20 666f  d information fo
-00014380: 7220 6261 636b 7761 7264 2028 7265 7369  r backward (resi
-00014390: 6475 616c 7329 2e0a 0a20 2020 2041 7267  duals)...    Arg
-000143a0: 733a 0a20 2020 2020 2020 2070 7269 6d61  s:.        prima
-000143b0: 6c20 2855 6e69 6f6e 5b50 726f 7879 2c20  l (Union[Proxy, 
-000143c0: 4e75 6d62 6572 5d29 3a20 5072 696d 616c  Number]): Primal
-000143d0: 2076 616c 7565 2c20 692e 652e 2c20 7468   value, i.e., th
-000143e0: 6520 7661 6c75 6520 6265 696e 6720 6469  e value being di
-000143f0: 6666 6572 656e 7469 6174 6564 2e0a 2020  fferentiated..  
-00014400: 2020 2020 2020 7265 7369 6475 616c 7320        residuals 
-00014410: 2854 7570 6c65 5b50 726f 7879 2c20 2e2e  (Tuple[Proxy, ..
-00014420: 2e5d 293a 2052 6573 6964 7561 6c73 2c20  .]): Residuals, 
-00014430: 692e 652e 2c20 7468 6520 7661 6c75 6573  i.e., the values
-00014440: 2074 6861 7420 6172 650a 2020 2020 2020   that are.      
-00014450: 2020 2020 2020 7361 7665 6420 666f 7220        saved for 
-00014460: 7468 6520 6261 636b 7761 7264 2e0a 0a20  the backward... 
-00014470: 2020 2059 6965 6c64 733a 0a20 2020 2020     Yields:.     
-00014480: 2020 2054 7570 6c65 5b56 6172 6961 626c     Tuple[Variabl
-00014490: 652c 2054 7570 6c65 5b56 6172 6961 626c  e, Tuple[Variabl
-000144a0: 652c 202e 2e2e 5d2c 2043 616c 6c61 626c  e, ...], Callabl
-000144b0: 655d 3a20 5072 696d 616c 2061 6e64 2072  e]: Primal and r
-000144c0: 6573 6964 7561 6c73 0a20 2020 2022 2222  esiduals.    """
-000144d0: 0a0a 2020 2020 7072 696d 616c 3a20 5072  ..    primal: Pr
-000144e0: 6f78 7920 7c20 4e75 6d62 6572 0a20 2020  oxy | Number.   
-000144f0: 2072 6573 6964 7561 6c73 3a20 7475 706c   residuals: tupl
-00014500: 655b 5072 6f78 792c 202e 2e2e 5d0a 0a20  e[Proxy, ...].. 
-00014510: 2020 2064 6566 205f 5f69 7465 725f 5f28     def __iter__(
-00014520: 7365 6c66 293a 0a20 2020 2020 2020 2079  self):.        y
-00014530: 6965 6c64 2073 656c 662e 7072 696d 616c  ield self.primal
-00014540: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
-00014550: 656c 662e 7265 7369 6475 616c 730a 0a0a  elf.residuals...
-00014560: 636c 6173 7320 4e6f 5075 6c6c 6261 636b  class NoPullback
-00014570: 3a0a 2020 2020 2222 2241 2064 756d 6d79  :.    """A dummy
-00014580: 2070 756c 6c62 6163 6b20 6675 6e63 7469   pullback functi
-00014590: 6f6e 2074 6861 7420 7265 7475 726e 7320  on that returns 
-000145a0: 4e6f 6e65 206f 7220 7261 6973 6573 2061  None or raises a
-000145b0: 6e20 6572 726f 722e 2222 220a 0a20 2020  n error."""..   
-000145c0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-000145d0: 6c66 2c20 6e75 6d5f 6172 6773 3d30 293a  lf, num_args=0):
-000145e0: 0a20 2020 2020 2020 2073 656c 662e 6e75  .        self.nu
-000145f0: 6d5f 6172 6773 203d 206e 756d 5f61 7267  m_args = num_arg
-00014600: 730a 0a20 2020 2064 6566 205f 5f63 616c  s..    def __cal
-00014610: 6c5f 5f28 7365 6c66 2c20 2a61 7267 732c  l__(self, *args,
-00014620: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00014630: 2020 2020 6966 2073 656c 662e 6e75 6d5f      if self.num_
-00014640: 6172 6773 203e 2030 3a0a 2020 2020 2020  args > 0:.      
-00014650: 2020 2020 2020 7265 7475 726e 2028 4e6f        return (No
-00014660: 6e65 2c29 202a 2073 656c 662e 6e75 6d5f  ne,) * self.num_
-00014670: 6172 6773 0a20 2020 2020 2020 2072 6169  args.        rai
-00014680: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-00014690: 2250 756c 6c62 6163 6b20 6361 6c6c 6564  "Pullback called
-000146a0: 206f 6e20 6120 6e6f 6e2d 6469 6666 6572   on a non-differ
-000146b0: 656e 7469 6162 6c65 2073 796d 626f 6c20  entiable symbol 
-000146c0: 6f72 2061 2063 6f6e 7374 616e 742e 2229  or a constant.")
-000146d0: 0a0a 0a63 6c61 7373 205a 6572 6f42 6163  ...class ZeroBac
-000146e0: 6b77 6172 643a 0a20 2020 2022 2222 4120  kward:.    """A 
-000146f0: 6865 6c70 6572 2062 6163 6b77 6172 6420  helper backward 
-00014700: 6675 6e63 7469 6f6e 2074 6861 7420 7265  function that re
-00014710: 7475 726e 7320 7a65 726f 732e 2222 220a  turns zeros.""".
-00014720: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00014730: 5f28 7365 6c66 2c20 6e75 6d5f 6172 6773  _(self, num_args
-00014740: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00014750: 6e75 6d5f 6172 6773 203d 206e 756d 5f61  num_args = num_a
-00014760: 7267 730a 0a20 2020 2064 6566 205f 5f63  rgs..    def __c
-00014770: 616c 6c5f 5f28 7365 6c66 2c20 2a61 7267  all__(self, *arg
-00014780: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-00014790: 2020 2020 2020 2320 4173 7375 6d69 6e67        # Assuming
-000147a0: 2074 6861 7420 7468 6520 6669 7273 7420   that the first 
-000147b0: 6172 6775 6d65 6e74 7320 6172 6520 7468  arguments are th
-000147c0: 6520 666f 7277 6172 6420 6172 6775 6d65  e forward argume
-000147d0: 6e74 730a 2020 2020 2020 2020 666f 7277  nts.        forw
-000147e0: 6172 645f 6172 6773 203d 2061 7267 735b  ard_args = args[
-000147f0: 3a20 7365 6c66 2e6e 756d 5f61 7267 735d  : self.num_args]
-00014800: 0a0a 2020 2020 2020 2020 6465 6620 7a65  ..        def ze
-00014810: 726f 735f 6c69 6b65 2878 293a 0a20 2020  ros_like(x):.   
-00014820: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00014830: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-00014840: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
-00014850: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00014860: 756c 6c5f 6c69 6b65 2878 2c20 6669 6c6c  ull_like(x, fill
-00014870: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
-00014880: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00014890: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
-000148a0: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-000148b0: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
-000148c0: 7065 2878 2e76 616c 7565 2928 3029 0a20  pe(x.value)(0). 
-000148d0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000148e0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-000148f0: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
-00014900: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
-00014910: 7065 2878 2928 3029 0a20 2020 2020 2020  pe(x)(0).       
-00014920: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014930: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00014940: 2056 616c 7565 4572 726f 7228 6622 7a65   ValueError(f"ze
-00014950: 726f 735f 6c69 6b65 2069 6e73 6964 6520  ros_like inside 
-00014960: 5a65 726f 4261 636b 7761 7264 2067 6f74  ZeroBackward got
-00014970: 2061 6e20 756e 7375 7070 6f72 7465 6420   an unsupported 
-00014980: 7479 7065 207b 7479 7065 2878 297d 2229  type {type(x)}")
-00014990: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000149a0: 2074 7570 6c65 287a 6572 6f73 5f6c 696b   tuple(zeros_lik
-000149b0: 6528 6172 6729 2066 6f72 2061 7267 2069  e(arg) for arg i
-000149c0: 6e20 666f 7277 6172 645f 6172 6773 290a  n forward_args).
-000149d0: 0a0a 2320 4d61 7070 696e 6720 6672 6f6d  ..# Mapping from
-000149e0: 2073 796d 626f 6c73 2074 6f20 6175 676d   symbols to augm
-000149f0: 656e 7465 6420 7072 696d 616c 2028 666f  ented primal (fo
-00014a00: 7277 6172 6429 2066 756e 6374 696f 6e73  rward) functions
-00014a10: 2075 7365 6420 696e 2056 4a50 0a23 2054   used in VJP.# T
-00014a20: 6865 2061 7567 6d65 6e74 6564 5f70 7269  he augmented_pri
-00014a30: 6d61 6c20 6675 6e63 7469 6f6e 2074 616b  mal function tak
-00014a40: 6573 2074 6865 2070 7269 6d61 6c20 7661  es the primal va
-00014a50: 6c75 6573 2061 6e64 2072 6574 7572 6e73  lues and returns
-00014a60: 2074 6865 2070 7269 6d61 6c0a 2320 7265   the primal.# re
-00014a70: 7375 6c74 2061 6e64 2074 6865 2072 6573  sult and the res
-00014a80: 6964 7561 6c73 2028 7361 7665 6420 7661  iduals (saved va
-00014a90: 6c75 6573 2066 6f72 2074 6865 2062 6163  lues for the bac
-00014aa0: 6b77 6172 6429 2e0a 6175 676d 656e 7465  kward)..augmente
-00014ab0: 645f 666f 7277 6172 645f 696d 706c 7320  d_forward_impls 
-00014ac0: 3d20 7b0a 2020 2020 7072 696d 732e 5072  = {.    prims.Pr
-00014ad0: 696d 4944 732e 4143 4f53 3a20 6c61 6d62  imIDs.ACOS: lamb
-00014ae0: 6461 2078 3a20 2870 7269 6d73 2e61 636f  da x: (prims.aco
-00014af0: 7328 7829 2c20 2878 2c29 292c 0a20 2020  s(x), (x,)),.   
-00014b00: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
-00014b10: 434f 5348 3a20 6c61 6d62 6461 2078 3a20  COSH: lambda x: 
-00014b20: 2870 7269 6d73 2e61 636f 7368 2878 292c  (prims.acosh(x),
-00014b30: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-00014b40: 732e 5072 696d 4944 732e 4153 494e 3a20  s.PrimIDs.ASIN: 
-00014b50: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014b60: 2e61 7369 6e28 7829 2c20 2878 2c29 292c  .asin(x), (x,)),
-00014b70: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014b80: 4473 2e41 5349 4e48 3a20 6c61 6d62 6461  Ds.ASINH: lambda
-00014b90: 2078 3a20 2870 7269 6d73 2e61 7369 6e68   x: (prims.asinh
-00014ba0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-00014bb0: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
-00014bc0: 414e 3a20 6c61 6d62 6461 2078 3a20 2870  AN: lambda x: (p
-00014bd0: 7269 6d73 2e61 7461 6e28 7829 2c20 2878  rims.atan(x), (x
-00014be0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014bf0: 7269 6d49 4473 2e41 5441 4e48 3a20 6c61  rimIDs.ATANH: la
-00014c00: 6d62 6461 2078 3a20 2870 7269 6d73 2e61  mbda x: (prims.a
-00014c10: 7461 6e68 2878 292c 2028 782c 2929 2c0a  tanh(x), (x,)),.
-00014c20: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014c30: 732e 4154 414e 323a 206c 616d 6264 6120  s.ATAN2: lambda 
-00014c40: 782c 2079 3a20 2870 7269 6d73 2e61 7461  x, y: (prims.ata
-00014c50: 6e32 2878 2c20 7929 2c20 2878 2c20 7929  n2(x, y), (x, y)
-00014c60: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014c70: 6d49 4473 2e43 4f53 483a 206c 616d 6264  mIDs.COSH: lambd
-00014c80: 6120 783a 2028 7072 696d 732e 636f 7368  a x: (prims.cosh
-00014c90: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-00014ca0: 7072 696d 732e 5072 696d 4944 732e 4449  prims.PrimIDs.DI
-00014cb0: 4741 4d4d 413a 206c 616d 6264 6120 783a  GAMMA: lambda x:
-00014cc0: 2028 7072 696d 732e 6469 6761 6d6d 6128   (prims.digamma(
-00014cd0: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
-00014ce0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
-00014cf0: 433a 206c 616d 6264 6120 783a 2028 7072  C: lambda x: (pr
-00014d00: 696d 732e 6572 6663 2878 292c 2028 782c  ims.erfc(x), (x,
-00014d10: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-00014d20: 696d 4944 732e 4552 4649 4e56 3a20 6c61  imIDs.ERFINV: la
-00014d30: 6d62 6461 2078 3a20 2870 7269 6d73 2e65  mbda x: (prims.e
-00014d40: 7266 696e 7628 7829 2c20 2870 7269 6d73  rfinv(x), (prims
-00014d50: 2e65 7266 696e 7628 7829 2c29 292c 0a20  .erfinv(x),)),. 
-00014d60: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014d70: 2e45 5246 4349 4e56 3a20 6c61 6d62 6461  .ERFCINV: lambda
-00014d80: 2078 3a20 2870 7269 6d73 2e65 7266 6369   x: (prims.erfci
-00014d90: 6e76 2878 292c 2028 7072 696d 732e 6572  nv(x), (prims.er
-00014da0: 6663 696e 7628 7829 2c29 292c 0a20 2020  fcinv(x),)),.   
-00014db0: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
-00014dc0: 5850 323a 206c 616d 6264 6120 783a 2028  XP2: lambda x: (
-00014dd0: 7072 696d 732e 6578 7032 2878 292c 2028  prims.exp2(x), (
-00014de0: 7072 696d 732e 6578 7032 2878 292c 2929  prims.exp2(x),))
-00014df0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014e00: 4944 732e 4558 504d 313a 206c 616d 6264  IDs.EXPM1: lambd
-00014e10: 6120 783a 2028 7072 696d 732e 6578 706d  a x: (prims.expm
-00014e20: 3128 7829 2c20 2870 7269 6d73 2e65 7870  1(x), (prims.exp
-00014e30: 6d31 2878 292c 2929 2c0a 2020 2020 7072  m1(x),)),.    pr
-00014e40: 696d 732e 5072 696d 4944 732e 4c47 414d  ims.PrimIDs.LGAM
-00014e50: 4d41 3a20 6c61 6d62 6461 2078 3a20 2870  MA: lambda x: (p
-00014e60: 7269 6d73 2e6c 6761 6d6d 6128 7829 2c20  rims.lgamma(x), 
-00014e70: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
-00014e80: 2e50 7269 6d49 4473 2e4e 4454 5249 3a20  .PrimIDs.NDTRI: 
-00014e90: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014ea0: 2e6e 6474 7269 2878 292c 2028 7072 696d  .ndtri(x), (prim
-00014eb0: 732e 6e64 7472 6928 7829 2c29 292c 0a20  s.ndtri(x),)),. 
-00014ec0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014ed0: 2e53 494e 483a 206c 616d 6264 6120 783a  .SINH: lambda x:
-00014ee0: 2028 7072 696d 732e 7369 6e68 2878 292c   (prims.sinh(x),
-00014ef0: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-00014f00: 732e 5072 696d 4944 732e 5351 5254 3a20  s.PrimIDs.SQRT: 
-00014f10: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014f20: 2e73 7172 7428 7829 2c20 2870 7269 6d73  .sqrt(x), (prims
-00014f30: 2e73 7172 7428 7829 2c29 292c 0a20 2020  .sqrt(x),)),.   
-00014f40: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
-00014f50: 4f47 3130 3a20 6c61 6d62 6461 2078 3a20  OG10: lambda x: 
-00014f60: 2870 7269 6d73 2e6c 6f67 3130 2878 292c  (prims.log10(x),
-00014f70: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-00014f80: 732e 5072 696d 4944 732e 4c4f 4731 503a  s.PrimIDs.LOG1P:
-00014f90: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014fa0: 732e 6c6f 6731 7028 7829 2c20 2878 2c29  s.log1p(x), (x,)
-00014fb0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014fc0: 6d49 4473 2e4c 4f47 323a 206c 616d 6264  mIDs.LOG2: lambd
-00014fd0: 6120 783a 2028 7072 696d 732e 6c6f 6732  a x: (prims.log2
-00014fe0: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
-00014ff0: 7072 696d 732e 5072 696d 4944 732e 5a45  prims.PrimIDs.ZE
-00015000: 5441 3a20 6c61 6d62 6461 2078 2c20 793a  TA: lambda x, y:
-00015010: 2028 7072 696d 732e 7a65 7461 2878 2c20   (prims.zeta(x, 
-00015020: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
-00015030: 2070 7269 6d73 2e50 7269 6d49 4473 2e46   prims.PrimIDs.F
-00015040: 4d4f 443a 206c 616d 6264 6120 782c 2079  MOD: lambda x, y
-00015050: 3a20 2870 7269 6d73 2e66 6d6f 6428 782c  : (prims.fmod(x,
-00015060: 2079 292c 2028 782c 2079 2929 2c0a 2020   y), (x, y)),.  
-00015070: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00015080: 434f 5059 5f3a 206c 616d 6264 6120 782c  COPY_: lambda x,
-00015090: 2079 3a20 2870 7269 6d73 2e63 6f70 795f   y: (prims.copy_
-000150a0: 2878 2c20 7929 2c20 7475 706c 6528 2929  (x, y), tuple())
-000150b0: 2c0a 7d0a 0a0a 2320 4d61 7070 696e 6720  ,.}...# Mapping 
-000150c0: 6672 6f6d 2073 796d 626f 6c73 2074 6f20  from symbols to 
-000150d0: 6261 636b 7761 7264 2066 756e 6374 696f  backward functio
-000150e0: 6e73 2075 7365 6420 696e 2056 4a50 0a23  ns used in VJP.#
-000150f0: 2054 6865 2062 6163 6b77 6172 6420 6675   The backward fu
-00015100: 6e63 7469 6f6e 2074 616b 6573 2074 6865  nction takes the
-00015110: 2072 6573 6964 7561 6c73 2061 6e64 2063   residuals and c
-00015120: 6f74 616e 6765 6e74 7320 616e 6420 7265  otangents and re
-00015130: 7475 726e 7320 7468 650a 2320 7665 6374  turns the.# vect
-00015140: 6f72 2d4a 6163 6f62 6961 6e20 7072 6f64  or-Jacobian prod
-00015150: 7563 7473 2066 6f72 2065 6163 6820 6172  ucts for each ar
-00015160: 6775 6d65 6e74 2e0a 6261 636b 7761 7264  gument..backward
-00015170: 5f69 6d70 6c73 203d 207b 0a20 2020 2070  _impls = {.    p
-00015180: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
-00015190: 533a 206c 616d 6264 6120 782c 2067 3a20  S: lambda x, g: 
-000151a0: 2d67 202f 2070 7269 6d73 2e73 7172 7428  -g / prims.sqrt(
-000151b0: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
-000151c0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-000151d0: 4143 4f53 483a 206c 616d 6264 6120 782c  ACOSH: lambda x,
-000151e0: 2067 3a20 6720 2a20 7072 696d 732e 7273   g: g * prims.rs
-000151f0: 7172 7428 7820 2a20 7820 2d20 312e 3029  qrt(x * x - 1.0)
-00015200: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00015210: 4944 732e 4153 494e 3a20 6c61 6d62 6461  IDs.ASIN: lambda
-00015220: 2078 2c20 673a 2067 202f 2070 7269 6d73   x, g: g / prims
-00015230: 2e73 7172 7428 312e 3020 2d20 7820 2a20  .sqrt(1.0 - x * 
-00015240: 7829 2c0a 2020 2020 7072 696d 732e 5072  x),.    prims.Pr
-00015250: 696d 4944 732e 4153 494e 483a 206c 616d  imIDs.ASINH: lam
-00015260: 6264 6120 782c 2067 3a20 6720 2a20 7072  bda x, g: g * pr
-00015270: 696d 732e 7273 7172 7428 312e 3020 2b20  ims.rsqrt(1.0 + 
-00015280: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
-00015290: 732e 5072 696d 4944 732e 4154 414e 3a20  s.PrimIDs.ATAN: 
-000152a0: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
-000152b0: 2028 312e 3020 2b20 7820 2a20 7829 2c0a   (1.0 + x * x),.
-000152c0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-000152d0: 732e 4154 414e 483a 206c 616d 6264 6120  s.ATANH: lambda 
-000152e0: 782c 2067 3a20 6720 2f20 2831 2e30 202d  x, g: g / (1.0 -
-000152f0: 2078 202a 2078 292c 0a20 2020 2070 7269   x * x),.    pri
-00015300: 6d73 2e50 7269 6d49 4473 2e43 4f53 483a  ms.PrimIDs.COSH:
-00015310: 206c 616d 6264 6120 782c 2067 3a20 7072   lambda x, g: pr
-00015320: 696d 732e 6d75 6c28 672c 2070 7269 6d73  ims.mul(g, prims
-00015330: 2e73 696e 6828 7829 292c 0a20 2020 2070  .sinh(x)),.    p
-00015340: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
-00015350: 433a 206c 616d 6264 6120 782c 2067 3a20  C: lambda x, g: 
-00015360: 2d67 202a 2032 2e30 202f 206d 6174 682e  -g * 2.0 / math.
-00015370: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
-00015380: 7072 696d 732e 6578 7028 2d78 202a 2078  prims.exp(-x * x
-00015390: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-000153a0: 6d49 4473 2e45 5246 494e 563a 206c 616d  mIDs.ERFINV: lam
-000153b0: 6264 6120 7265 7375 6c74 2c20 673a 2067  bda result, g: g
-000153c0: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
-000153d0: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
-000153e0: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
-000153f0: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
-00015400: 696d 4944 732e 4552 4643 494e 563a 206c  imIDs.ERFCINV: l
-00015410: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
-00015420: 202d 6720 2a20 302e 3520 2a20 6d61 7468   -g * 0.5 * math
-00015430: 2e73 7172 7428 6d61 7468 2e70 6929 202a  .sqrt(math.pi) *
-00015440: 2070 7269 6d73 2e65 7870 2872 6573 756c   prims.exp(resul
-00015450: 742a 2a32 292c 0a20 2020 2070 7269 6d73  t**2),.    prims
-00015460: 2e50 7269 6d49 4473 2e45 5850 323a 206c  .PrimIDs.EXP2: l
-00015470: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
-00015480: 2067 202a 2072 6573 756c 7420 2a20 6d61   g * result * ma
-00015490: 7468 2e6c 6f67 2832 2e30 292c 0a20 2020  th.log(2.0),.   
-000154a0: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
-000154b0: 5850 4d31 3a20 6c61 6d62 6461 2072 6573  XPM1: lambda res
-000154c0: 756c 742c 2067 3a20 6720 2a20 2872 6573  ult, g: g * (res
-000154d0: 756c 7420 2b20 312e 3029 2c0a 2020 2020  ult + 1.0),.    
-000154e0: 7072 696d 732e 5072 696d 4944 732e 4c47  prims.PrimIDs.LG
-000154f0: 414d 4d41 3a20 6c61 6d62 6461 2078 2c20  AMMA: lambda x, 
-00015500: 673a 2067 202a 2070 7269 6d73 2e64 6967  g: g * prims.dig
-00015510: 616d 6d61 2878 292c 0a20 2020 2070 7269  amma(x),.    pri
-00015520: 6d73 2e50 7269 6d49 4473 2e4e 4454 5249  ms.PrimIDs.NDTRI
-00015530: 3a20 6c61 6d62 6461 2072 6573 756c 742c  : lambda result,
-00015540: 2067 3a20 6720 2a20 7072 696d 732e 6578   g: g * prims.ex
-00015550: 7028 302e 3520 2a20 7265 7375 6c74 2a2a  p(0.5 * result**
-00015560: 3229 202a 206d 6174 682e 7371 7274 2832  2) * math.sqrt(2
-00015570: 2e30 202a 206d 6174 682e 7069 292c 0a20  .0 * math.pi),. 
-00015580: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00015590: 2e53 494e 483a 206c 616d 6264 6120 782c  .SINH: lambda x,
-000155a0: 2067 3a20 7072 696d 732e 6d75 6c28 672c   g: prims.mul(g,
-000155b0: 2070 7269 6d73 2e63 6f73 6828 7829 292c   prims.cosh(x)),
-000155c0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-000155d0: 4473 2e53 5152 543a 206c 616d 6264 6120  Ds.SQRT: lambda 
-000155e0: 7265 7375 6c74 2c20 673a 2067 202f 2028  result, g: g / (
-000155f0: 322e 3020 2a20 7265 7375 6c74 292c 0a20  2.0 * result),. 
-00015600: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00015610: 2e4c 4f47 3130 3a20 6c61 6d62 6461 2078  .LOG10: lambda x
-00015620: 2c20 673a 2067 202f 2028 7820 2a20 322e  , g: g / (x * 2.
-00015630: 3330 3235 3835 3039 3239 3934 3034 3629  302585092994046)
-00015640: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00015650: 4944 732e 4c4f 4731 503a 206c 616d 6264  IDs.LOG1P: lambd
-00015660: 6120 782c 2067 3a20 6720 2f20 2878 202b  a x, g: g / (x +
-00015670: 2031 292c 0a20 2020 2070 7269 6d73 2e50   1),.    prims.P
-00015680: 7269 6d49 4473 2e4c 4f47 323a 206c 616d  rimIDs.LOG2: lam
-00015690: 6264 6120 782c 2067 3a20 6720 2f20 2878  bda x, g: g / (x
-000156a0: 202a 2030 2e36 3933 3134 3731 3830 3535   * 0.69314718055
-000156b0: 3939 3435 3329 2c0a 2020 2020 7072 696d  99453),.    prim
-000156c0: 732e 5072 696d 4944 732e 464d 4f44 3a20  s.PrimIDs.FMOD: 
-000156d0: 6c61 6d62 6461 2078 2c20 792c 2067 3a20  lambda x, y, g: 
-000156e0: 2867 2c20 2d67 202a 2070 7269 6d73 2e74  (g, -g * prims.t
-000156f0: 7275 6e63 2878 202f 2079 2929 2c0a 2020  runc(x / y)),.  
-00015700: 2020 2320 5468 6520 636f 7079 2073 686f    # The copy sho
-00015710: 756c 6420 6e6f 7420 6265 2064 6966 6665  uld not be diffe
-00015720: 7265 6e74 6961 626c 652e 2057 6520 7265  rentiable. We re
-00015730: 7475 726e 204e 6f6e 6520 746f 2065 6e61  turn None to ena
-00015740: 626c 6520 7468 6520 6765 6e65 7261 7469  ble the generati
-00015750: 6f6e 206f 6620 7468 6520 6261 636b 7761  on of the backwa
-00015760: 7264 2067 7261 7068 2074 6872 6f75 6768  rd graph through
-00015770: 2074 6865 6d2e 0a20 2020 2070 7269 6d73   them..    prims
-00015780: 2e50 7269 6d49 4473 2e43 4f50 595f 3a20  .PrimIDs.COPY_: 
-00015790: 6c61 6d62 6461 2067 3a20 284e 6f6e 652c  lambda g: (None,
-000157a0: 204e 6f6e 6529 2c0a 7d0a 0a0a 6465 6620   None),.}...def 
-000157b0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-000157c0: 6564 5f66 6f72 7761 7264 286f 7029 3a0a  ed_forward(op):.
-000157d0: 2020 2020 2222 2244 6563 6f72 6174 6f72      """Decorator
-000157e0: 2074 6f20 7265 6769 7374 6572 2061 6e20   to register an 
-000157f0: 6175 676d 656e 7465 6420 666f 7277 6172  augmented forwar
-00015800: 6420 696d 706c 656d 656e 7461 7469 6f6e  d implementation
-00015810: 2066 6f72 2061 2073 796d 626f 6c2e 0a0a   for a symbol...
-00015820: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00015830: 2020 6f70 2028 4f70 7329 3a20 5379 6d62    op (Ops): Symb
-00015840: 6f6c 2066 6f72 2077 6869 6368 2074 6f20  ol for which to 
-00015850: 7265 6769 7374 6572 2074 6865 2061 7567  register the aug
-00015860: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
-00015870: 6d70 6c65 6d65 6e74 6174 696f 6e2e 0a0a  mplementation...
-00015880: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00015890: 2020 2020 2043 616c 6c61 626c 653a 2044       Callable: D
-000158a0: 6563 6f72 6174 6f72 2066 756e 6374 696f  ecorator functio
-000158b0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
-000158c0: 6465 6620 6465 636f 7261 746f 7228 6675  def decorator(fu
-000158d0: 6e63 293a 0a20 2020 2020 2020 2061 7567  nc):.        aug
-000158e0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-000158f0: 6d70 6c73 5b6f 705d 203d 2066 756e 630a  mpls[op] = func.
-00015900: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00015910: 756e 630a 0a20 2020 2072 6574 7572 6e20  unc..    return 
-00015920: 6465 636f 7261 746f 720a 0a0a 6465 6620  decorator...def 
-00015930: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
-00015940: 6428 6f70 293a 0a20 2020 2022 2222 4465  d(op):.    """De
-00015950: 636f 7261 746f 7220 746f 2072 6567 6973  corator to regis
-00015960: 7465 7220 6120 6261 636b 7761 7264 2069  ter a backward i
-00015970: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
-00015980: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
-00015990: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
-000159a0: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
-000159b0: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
-000159c0: 6973 7465 7220 7468 6520 6261 636b 7761  ister the backwa
-000159d0: 7264 2069 6d70 6c65 6d65 6e74 6174 696f  rd implementatio
-000159e0: 6e2e 0a0a 2020 2020 5265 7475 726e 733a  n...    Returns:
-000159f0: 0a20 2020 2020 2020 2043 616c 6c61 626c  .        Callabl
-00015a00: 653a 2044 6563 6f72 6174 6f72 2066 756e  e: Decorator fun
-00015a10: 6374 696f 6e2e 0a20 2020 2022 2222 0a0a  ction..    """..
-00015a20: 2020 2020 6465 6620 6465 636f 7261 746f      def decorato
-00015a30: 7228 6675 6e63 293a 0a20 2020 2020 2020  r(func):.       
-00015a40: 2062 6163 6b77 6172 645f 696d 706c 735b   backward_impls[
-00015a50: 6f70 5d20 3d20 6675 6e63 0a20 2020 2020  op] = func.     
-00015a60: 2020 2072 6574 7572 6e20 6675 6e63 0a0a     return func..
-00015a70: 2020 2020 7265 7475 726e 2064 6563 6f72      return decor
-00015a80: 6174 6f72 0a0a 0a64 6566 2072 6573 746f  ator...def resto
-00015a90: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
-00015aa0: 782c 2072 6564 7563 6564 5f64 696d 732c  x, reduced_dims,
-00015ab0: 206f 7269 6769 6e61 6c5f 7368 6170 6529   original_shape)
-00015ac0: 3a0a 2020 2020 2222 2252 6573 746f 7265  :.    """Restore
-00015ad0: 7320 7468 6520 7265 6475 6365 6420 6469  s the reduced di
-00015ae0: 6d65 6e73 696f 6e73 206f 6620 6120 7465  mensions of a te
-00015af0: 6e73 6f72 2e0a 0a20 2020 2041 7267 733a  nsor...    Args:
-00015b00: 0a20 2020 2020 2020 2078 2028 5661 7269  .        x (Vari
-00015b10: 6162 6c65 293a 2054 656e 736f 7220 746f  able): Tensor to
-00015b20: 2062 6520 7265 7368 6170 6564 2e0a 2020   be reshaped..  
-00015b30: 2020 2020 2020 7265 6475 6365 645f 6469        reduced_di
-00015b40: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
-00015b50: 2e2e 5d29 3a20 5475 706c 6520 6f66 2072  ..]): Tuple of r
-00015b60: 6564 7563 6564 2064 696d 656e 7369 6f6e  educed dimension
-00015b70: 732e 0a20 2020 2020 2020 206f 7269 6769  s..        origi
-00015b80: 6e61 6c5f 7368 6170 6520 2854 7570 6c65  nal_shape (Tuple
-00015b90: 5b69 6e74 2c20 2e2e 2e5d 293a 204f 7269  [int, ...]): Ori
-00015ba0: 6769 6e61 6c20 7368 6170 6520 6f66 2074  ginal shape of t
-00015bb0: 6865 2074 656e 736f 722e 0a0a 2020 2020  he tensor...    
-00015bc0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00015bd0: 2056 6172 6961 626c 653a 2054 656e 736f   Variable: Tenso
-00015be0: 7220 7769 7468 2074 6865 2072 6564 7563  r with the reduc
-00015bf0: 6564 2064 696d 656e 7369 6f6e 7320 7265  ed dimensions re
-00015c00: 7374 6f72 6564 2e0a 2020 2020 2222 220a  stored..    """.
-00015c10: 2020 2020 6966 206f 7269 6769 6e61 6c5f      if original_
-00015c20: 7368 6170 6520 3d3d 2028 293a 2020 2320  shape == ():  # 
-00015c30: 7363 616c 6172 0a20 2020 2020 2020 2072  scalar.        r
-00015c40: 6574 7572 6e20 780a 0a20 2020 2075 6e73  eturn x..    uns
-00015c50: 7175 6565 7a65 6420 3d20 636c 616e 672e  queezed = clang.
-00015c60: 756e 7371 7565 657a 6528 782c 2072 6564  unsqueeze(x, red
-00015c70: 7563 6564 5f64 696d 7329 0a20 2020 2072  uced_dims).    r
-00015c80: 6574 7572 6e20 636c 616e 672e 6578 7061  eturn clang.expa
-00015c90: 6e64 2875 6e73 7175 6565 7a65 642c 206f  nd(unsqueezed, o
-00015ca0: 7269 6769 6e61 6c5f 7368 6170 6529 0a0a  riginal_shape)..
-00015cb0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-00015cc0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-00015cd0: 732e 5a45 5441 290a 6465 6620 7a65 7461  s.ZETA).def zeta
-00015ce0: 5f62 6163 6b77 6172 6428 782c 2079 2c20  _backward(x, y, 
-00015cf0: 6729 3a0a 2020 2020 2320 5468 6520 6465  g):.    # The de
-00015d00: 7269 7661 7469 7665 2077 7274 2074 6865  rivative wrt the
-00015d10: 2066 6972 7374 2061 7267 756d 656e 7420   first argument 
-00015d20: 6973 206e 6f74 2065 7870 7265 7373 6962  is not expressib
-00015d30: 6c65 2069 6e20 7465 726d 7320 6f66 207a  le in terms of z
-00015d40: 6574 6120 6f72 0a20 2020 2023 206f 7468  eta or.    # oth
-00015d50: 6572 2073 7065 6369 616c 2066 756e 6374  er special funct
-00015d60: 696f 6e73 0a20 2020 2023 2054 6865 7265  ions.    # There
-00015d70: 666f 7265 2c20 7765 2063 6f6d 7075 7465  fore, we compute
-00015d80: 206f 6e6c 7920 7468 6520 6465 7269 7661   only the deriva
-00015d90: 7469 7665 2077 7274 2074 6865 2073 6563  tive wrt the sec
-00015da0: 6f6e 6420 6172 6775 6d65 6e74 0a20 2020  ond argument.   
-00015db0: 2067 7920 3d20 6720 2a20 2d78 202a 2070   gy = g * -x * p
-00015dc0: 7269 6d73 2e7a 6574 6128 7820 2b20 312e  rims.zeta(x + 1.
-00015dd0: 302c 2079 290a 0a20 2020 2023 2052 6574  0, y)..    # Ret
-00015de0: 7572 6e20 6120 6d61 7070 7069 6e67 2066  urn a mappping f
-00015df0: 726f 6d20 7468 6520 666f 7277 6172 6420  rom the forward 
-00015e00: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
-00015e10: 2067 7261 6469 656e 7473 0a20 2020 2072   gradients.    r
-00015e20: 6574 7572 6e20 7b22 7922 3a20 6779 7d0a  eturn {"y": gy}.
-00015e30: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00015e40: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00015e50: 4473 2e44 4947 414d 4d41 290a 6465 6620  Ds.DIGAMMA).def 
-00015e60: 6469 6761 6d6d 615f 6261 636b 7761 7264  digamma_backward
-00015e70: 2861 3a20 5072 6f78 792c 2067 293a 0a20  (a: Proxy, g):. 
-00015e80: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
-00015e90: 746f 7263 6820 696d 706f 7274 2070 6f6c  torch import pol
-00015ea0: 7967 616d 6d61 0a0a 2020 2020 7265 7475  ygamma..    retu
-00015eb0: 726e 2067 202a 2070 6f6c 7967 616d 6d61  rn g * polygamma
-00015ec0: 2831 2c20 6129 0a0a 0a40 7265 6769 7374  (1, a)...@regist
-00015ed0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-00015ee0: 7761 7264 2822 746f 7263 682e 706f 6c79  ward("torch.poly
-00015ef0: 6761 6d6d 6122 290a 6465 6620 706f 6c79  gamma").def poly
-00015f00: 6761 6d6d 615f 6175 675f 6677 6428 6e3a  gamma_aug_fwd(n:
-00015f10: 2069 6e74 2c20 613a 2050 726f 7879 293a   int, a: Proxy):
-00015f20: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00015f30: 722e 746f 7263 6820 696d 706f 7274 2070  r.torch import p
-00015f40: 6f6c 7967 616d 6d61 0a0a 2020 2020 7072  olygamma..    pr
-00015f50: 696d 616c 203d 2070 6f6c 7967 616d 6d61  imal = polygamma
-00015f60: 286e 2c20 6129 0a20 2020 2072 6573 6964  (n, a).    resid
-00015f70: 7561 6c73 203d 2028 6e2c 2061 290a 2020  uals = (n, a).  
-00015f80: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00015f90: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-00015fa0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-00015fb0: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
-00015fc0: 706f 6c79 6761 6d6d 6122 290a 6465 6620  polygamma").def 
-00015fd0: 706f 6c79 6761 6d6d 615f 6261 636b 7761  polygamma_backwa
-00015fe0: 7264 286e 3a20 696e 742c 2061 3a20 5072  rd(n: int, a: Pr
-00015ff0: 6f78 792c 2067 293a 0a20 2020 2066 726f  oxy, g):.    fro
-00016000: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
-00016010: 696d 706f 7274 2070 6f6c 7967 616d 6d61  import polygamma
-00016020: 0a0a 2020 2020 7265 7475 726e 204e 6f6e  ..    return Non
-00016030: 652c 2067 202a 2070 6f6c 7967 616d 6d61  e, g * polygamma
-00016040: 286e 202b 2031 2c20 6129 0a0a 0a40 7265  (n + 1, a)...@re
-00016050: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00016060: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
-00016070: 414e 3229 0a64 6566 2061 7461 6e32 5f62  AN2).def atan2_b
-00016080: 6163 6b77 6172 6428 782c 2079 2c20 6729  ackward(x, y, g)
-00016090: 3a0a 2020 2020 616c 7068 6120 3d20 312e  :.    alpha = 1.
-000160a0: 3020 2f20 2878 202a 2078 202b 2079 202a  0 / (x * x + y *
-000160b0: 2079 290a 2020 2020 6772 6164 5f78 203d   y).    grad_x =
-000160c0: 2067 202a 2079 202a 2061 6c70 6861 0a20   g * y * alpha. 
-000160d0: 2020 2067 7261 645f 7920 3d20 6720 2a20     grad_y = g * 
-000160e0: 2d78 202a 2061 6c70 6861 0a20 2020 2072  -x * alpha.    r
-000160f0: 6574 7572 6e20 6772 6164 5f78 2c20 6772  eturn grad_x, gr
-00016100: 6164 5f79 0a0a 0a40 7265 6769 7374 6572  ad_y...@register
-00016110: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-00016120: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
-00016130: 2e56 4152 290a 6465 6620 7661 725f 6175  .VAR).def var_au
-00016140: 675f 6677 6428 612c 2064 696d 2c20 2a2c  g_fwd(a, dim, *,
-00016150: 2063 6f72 7265 6374 696f 6e29 3a0a 2020   correction):.  
-00016160: 2020 7620 3d20 7072 696d 732e 7661 7228    v = prims.var(
-00016170: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
-00016180: 6f6e 3d63 6f72 7265 6374 696f 6e29 0a20  on=correction). 
-00016190: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-000161a0: 6c28 2876 2c29 2c20 2861 2c20 6469 6d2c  l((v,), (a, dim,
-000161b0: 2063 6f72 7265 6374 696f 6e2c 2076 2929   correction, v))
-000161c0: 0a0a 0a23 2054 4f44 4f3a 2066 6978 2064  ...# TODO: fix d
-000161d0: 6976 6973 696f 6e20 6279 207a 6572 6f20  ivision by zero 
-000161e0: 7768 656e 206e 5f65 6c65 6d5f 7265 6475  when n_elem_redu
-000161f0: 6365 6420 3d3d 2030 206f 7220 7768 656e  ced == 0 or when
-00016200: 2076 2e6e 756d 656c 203d 3d20 300a 2320   v.numel == 0.# 
-00016210: 6279 2072 6574 7572 6e69 6e67 207a 6572  by returning zer
-00016220: 6f73 5f6c 696b 6528 6129 206f 7220 7369  os_like(a) or si
-00016230: 6d69 6c61 722e 0a23 2054 4f44 4f3a 2066  milar..# TODO: f
-00016240: 6978 2067 7261 6420 7768 656e 2063 6f72  ix grad when cor
-00016250: 7265 6374 696f 6e20 3e20 6e5f 656c 656d  rection > n_elem
-00016260: 5f72 6564 7563 6564 2e0a 4072 6567 6973  _reduced..@regis
-00016270: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
-00016280: 6d73 2e50 7269 6d49 4473 2e56 4152 290a  ms.PrimIDs.VAR).
-00016290: 6465 6620 7661 725f 6261 636b 7761 7264  def var_backward
-000162a0: 2861 2c20 6469 6d2c 2063 6f72 7265 6374  (a, dim, correct
-000162b0: 696f 6e2c 2076 2c20 6729 3a0a 2020 2020  ion, v, g):.    
-000162c0: 6e5f 656c 656d 5f72 6564 7563 6564 203d  n_elem_reduced =
-000162d0: 2061 2e6e 756d 656c 2829 202f 2f20 762e   a.numel() // v.
-000162e0: 6e75 6d65 6c28 2920 6966 2061 2e6e 756d  numel() if a.num
-000162f0: 656c 2829 2021 3d20 3020 656c 7365 2031  el() != 0 else 1
-00016300: 0a20 2020 206e 6f72 6d61 6c69 7a61 7469  .    normalizati
-00016310: 6f6e 5f73 6361 6c61 7220 3d20 6e5f 656c  on_scalar = n_el
-00016320: 656d 5f72 6564 7563 6564 202d 2063 6f72  em_reduced - cor
-00016330: 7265 6374 696f 6e0a 2020 2020 6720 3d20  rection.    g = 
-00016340: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
-00016350: 6469 6d73 2867 2c20 6469 6d2c 2061 2e73  dims(g, dim, a.s
-00016360: 6861 7065 290a 2020 2020 6966 2061 2e64  hape).    if a.d
-00016370: 7479 7065 2021 3d20 762e 6474 7970 653a  type != v.dtype:
-00016380: 0a20 2020 2020 2020 2061 203d 2070 7269  .        a = pri
-00016390: 6d73 2e63 6f6e 7665 7274 5f65 6c65 6d65  ms.convert_eleme
-000163a0: 6e74 5f74 7970 6528 612c 2076 2e64 7479  nt_type(a, v.dty
-000163b0: 7065 290a 2020 2020 6d65 616e 203d 2070  pe).    mean = p
-000163c0: 7269 6d73 2e73 756d 2861 2c20 6469 6d29  rims.sum(a, dim)
-000163d0: 202f 206e 5f65 6c65 6d5f 7265 6475 6365   / n_elem_reduce
-000163e0: 640a 2020 2020 6d65 616e 203d 2072 6573  d.    mean = res
-000163f0: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
-00016400: 7328 6d65 616e 2c20 6469 6d2c 2061 2e73  s(mean, dim, a.s
-00016410: 6861 7065 290a 2020 2020 7265 7475 726e  hape).    return
-00016420: 2028 3220 2a20 6720 2a20 2861 202d 206d   (2 * g * (a - m
-00016430: 6561 6e29 2920 2f20 6e6f 726d 616c 697a  ean)) / normaliz
-00016440: 6174 696f 6e5f 7363 616c 6172 0a0a 0a64  ation_scalar...d
-00016450: 6566 206e 5f65 6c65 6d5f 7265 6475 6365  ef n_elem_reduce
-00016460: 6428 615f 6e64 696d 2c20 615f 7368 6170  d(a_ndim, a_shap
-00016470: 652c 2064 696d 7329 3a0a 2020 2020 6469  e, dims):.    di
-00016480: 6d73 203d 2075 7469 6c73 2e63 616e 6f6e  ms = utils.canon
-00016490: 6963 616c 697a 655f 6469 6d73 2861 5f6e  icalize_dims(a_n
-000164a0: 6469 6d2c 2064 696d 7329 0a20 2020 2072  dim, dims).    r
-000164b0: 6564 7563 7469 6f6e 5f73 697a 6520 3d20  eduction_size = 
-000164c0: 310a 2020 2020 666f 7220 6964 782c 2073  1.    for idx, s
-000164d0: 697a 6520 696e 2065 6e75 6d65 7261 7465  ize in enumerate
-000164e0: 2861 5f73 6861 7065 293a 0a20 2020 2020  (a_shape):.     
-000164f0: 2020 2069 6620 6964 7820 696e 2064 696d     if idx in dim
-00016500: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00016510: 6564 7563 7469 6f6e 5f73 697a 6520 2a3d  eduction_size *=
-00016520: 2073 697a 650a 2020 2020 7265 7475 726e   size.    return
-00016530: 2072 6564 7563 7469 6f6e 5f73 697a 650a   reduction_size.
-00016540: 0a0a 6465 6620 6d65 616e 5f62 6163 6b77  ..def mean_backw
-00016550: 6172 6428 615f 6e64 696d 2c20 615f 7368  ard(a_ndim, a_sh
-00016560: 6170 652c 2064 696d 732c 2067 7261 6429  ape, dims, grad)
-00016570: 3a0a 2020 2020 6d65 616e 5f6c 6f63 616c  :.    mean_local
-00016580: 5f67 7261 6420 3d20 312e 3020 2f20 6e5f  _grad = 1.0 / n_
-00016590: 656c 656d 5f72 6564 7563 6564 2861 5f6e  elem_reduced(a_n
-000165a0: 6469 6d2c 2061 5f73 6861 7065 2c20 6469  dim, a_shape, di
-000165b0: 6d73 290a 2020 2020 7265 7475 726e 2072  ms).    return r
-000165c0: 6573 746f 7265 5f72 6564 7563 6564 5f64  estore_reduced_d
-000165d0: 696d 7328 6772 6164 2c20 6469 6d73 2c20  ims(grad, dims, 
-000165e0: 615f 7368 6170 6529 202a 206d 6561 6e5f  a_shape) * mean_
-000165f0: 6c6f 6361 6c5f 6772 6164 0a0a 0a40 7265  local_grad...@re
-00016600: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-00016610: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
-00016620: 7269 6d49 4473 2e50 4144 290a 6465 6620  rimIDs.PAD).def 
-00016630: 7061 645f 6175 675f 6677 6428 612c 2070  pad_aug_fwd(a, p
-00016640: 6164 6469 6e67 5f76 616c 7565 2c20 7061  adding_value, pa
-00016650: 6464 696e 675f 636f 6e66 6967 293a 0a20  dding_config):. 
-00016660: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-00016670: 6c28 2870 7269 6d73 2e70 6164 2861 2c20  l((prims.pad(a, 
-00016680: 7061 6464 696e 675f 7661 6c75 652c 2070  padding_value, p
-00016690: 6164 6469 6e67 5f63 6f6e 6669 6729 2c29  adding_config),)
-000166a0: 2c20 2861 2c20 7061 6464 696e 675f 636f  , (a, padding_co
-000166b0: 6e66 6967 2929 0a0a 0a40 7265 6769 7374  nfig))...@regist
-000166c0: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
-000166d0: 732e 5072 696d 4944 732e 5041 4429 0a64  s.PrimIDs.PAD).d
-000166e0: 6566 2070 6164 5f62 6163 6b77 6172 6428  ef pad_backward(
-000166f0: 612c 2070 6164 6469 6e67 5f63 6f6e 6669  a, padding_confi
-00016700: 672c 2067 293a 0a20 2020 2023 2053 686f  g, g):.    # Sho
-00016710: 7274 2063 6972 6375 6974 206f 6e20 656d  rt circuit on em
-00016720: 7074 7920 696e 7075 742e 0a20 2020 2069  pty input..    i
-00016730: 6620 616e 7928 6469 6d20 3d3d 2030 2066  f any(dim == 0 f
-00016740: 6f72 2064 696d 2069 6e20 612e 7368 6170  or dim in a.shap
-00016750: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00016760: 726e 2066 756c 6c5f 6c69 6b65 2861 2c20  rn full_like(a, 
-00016770: 6669 6c6c 5f76 616c 7565 3d30 290a 0a20  fill_value=0).. 
-00016780: 2020 2023 2055 6e2d 7061 6420 6279 2070     # Un-pad by p
-00016790: 6164 6469 6e67 2077 6974 6820 7a65 726f  adding with zero
-000167a0: 2076 616c 7565 730a 2020 2020 7a65 726f   values.    zero
-000167b0: 5f70 6164 6469 6e67 5f63 6f6e 6669 6720  _padding_config 
-000167c0: 3d20 5b28 2d6c 6f2c 202d 6869 2c20 3029  = [(-lo, -hi, 0)
-000167d0: 2066 6f72 206c 6f2c 2068 692c 205f 2069   for lo, hi, _ i
-000167e0: 6e20 7061 6464 696e 675f 636f 6e66 6967  n padding_config
-000167f0: 5d0a 0a20 2020 2067 203d 2070 7269 6d73  ]..    g = prims
-00016800: 2e70 6164 2867 2c20 302e 302c 207a 6572  .pad(g, 0.0, zer
-00016810: 6f5f 7061 6464 696e 675f 636f 6e66 6967  o_padding_config
-00016820: 290a 0a20 2020 2023 2055 6e2d 736c 6963  )..    # Un-slic
-00016830: 6520 6279 2073 6c69 6369 6e67 2077 6974  e by slicing wit
-00016840: 6820 6120 7374 7269 6465 206f 6620 7661  h a stride of va
-00016850: 6c75 6520 2864 696c 6174 696f 6e20 2b20  lue (dilation + 
-00016860: 3129 0a20 2020 2066 6f72 2064 696d 2c20  1).    for dim, 
-00016870: 285f 2c20 5f2c 2064 2920 696e 2065 6e75  (_, _, d) in enu
-00016880: 6d65 7261 7465 2870 6164 6469 6e67 5f63  merate(padding_c
-00016890: 6f6e 6669 6729 3a0a 2020 2020 2020 2020  onfig):.        
-000168a0: 6720 3d20 736c 6963 655f 696e 5f64 696d  g = slice_in_dim
-000168b0: 2867 2c20 302c 2067 2e73 6861 7065 5b64  (g, 0, g.shape[d
-000168c0: 696d 5d2c 2073 7472 6964 653d 6420 2b20  im], stride=d + 
-000168d0: 312c 2064 696d 3d64 696d 290a 0a20 2020  1, dim=dim)..   
-000168e0: 2072 6574 7572 6e20 670a 0a0a 4072 6567   return g...@reg
-000168f0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00016900: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00016910: 696d 4944 732e 5052 4f44 290a 6465 6620  imIDs.PROD).def 
-00016920: 7072 6f64 5f61 7567 5f66 7764 2878 2c20  prod_aug_fwd(x, 
-00016930: 6469 6d73 293a 0a20 2020 2022 2222 4175  dims):.    """Au
-00016940: 676d 656e 7465 6420 7072 6f64 206f 7065  gmented prod ope
-00016950: 7261 7469 6f6e 2e0a 0a20 2020 2041 7267  ration...    Arg
-00016960: 733a 0a20 2020 2020 2020 2078 2028 5661  s:.        x (Va
-00016970: 7269 6162 6c65 293a 2054 656e 736f 7220  riable): Tensor 
-00016980: 746f 2062 6520 6d75 6c74 6970 6c69 6564  to be multiplied
-00016990: 2e0a 2020 2020 2020 2020 6469 6d73 2028  ..        dims (
-000169a0: 5475 706c 655b 696e 742c 202e 2e2e 5d29  Tuple[int, ...])
-000169b0: 3a20 4469 6d65 6e73 696f 6e73 2074 6f20  : Dimensions to 
-000169c0: 6265 206d 756c 7469 706c 6965 642e 0a0a  be multiplied...
-000169d0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-000169e0: 2020 2020 2056 4a50 4475 616c 3a20 5072       VJPDual: Pr
-000169f0: 696d 616c 2061 6e64 2072 6573 6964 7561  imal and residua
-00016a00: 6c73 2e0a 2020 2020 2222 220a 2020 2020  ls..    """.    
-00016a10: 7072 696d 616c 203d 2070 7269 6d73 2e70  primal = prims.p
-00016a20: 726f 6428 782c 2064 696d 7329 0a0a 2020  rod(x, dims)..  
-00016a30: 2020 7265 7369 6475 616c 7320 3d20 280a    residuals = (.
-00016a40: 2020 2020 2020 2020 7072 696d 616c 2c0a          primal,.
-00016a50: 2020 2020 2020 2020 782c 0a20 2020 2020          x,.     
-00016a60: 2020 2078 2e73 6861 7065 2c0a 2020 2020     x.shape,.    
-00016a70: 2020 2020 6469 6d73 2c0a 2020 2020 290a      dims,.    ).
-00016a80: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00016a90: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00016aa0: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00016ab0: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
-00016ac0: 2e50 7269 6d49 4473 2e50 524f 4429 0a64  .PrimIDs.PROD).d
-00016ad0: 6566 2070 726f 645f 7075 6c6c 6261 636b  ef prod_pullback
-00016ae0: 2870 7269 6d61 6c2c 2078 2c20 785f 7368  (primal, x, x_sh
-00016af0: 6170 652c 2072 6564 7563 6564 5f64 696d  ape, reduced_dim
-00016b00: 732c 2067 293a 0a20 2020 2072 6574 7572  s, g):.    retur
-00016b10: 6e20 7072 696d 732e 6469 7628 7265 7374  n prims.div(rest
-00016b20: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
-00016b30: 2870 7269 6d61 6c20 2a20 672c 2072 6564  (primal * g, red
-00016b40: 7563 6564 5f64 696d 732c 2078 5f73 6861  uced_dims, x_sha
-00016b50: 7065 292c 2078 290a 0a0a 6465 6620 6b65  pe), x)...def ke
-00016b60: 6570 6469 6d5f 7265 6475 6374 696f 6e28  epdim_reduction(
-00016b70: 7265 6475 6374 696f 6e5f 666e 2c20 782c  reduction_fn, x,
-00016b80: 2064 696d 7329 3a0a 2020 2020 2222 2241   dims):.    """A
-00016b90: 7070 6c69 6573 2072 6564 7563 7469 6f6e  pplies reduction
-00016ba0: 2061 6e64 2066 6978 6573 206f 7574 7075   and fixes outpu
-00016bb0: 7420 746f 2063 6f6e 666f 726d 2074 6f20  t to conform to 
-00016bc0: 6b65 6570 6469 6d3d 5472 7565 2222 220a  keepdim=True""".
-00016bd0: 2020 2020 6f75 7420 3d20 7265 6475 6374      out = reduct
-00016be0: 696f 6e5f 666e 2878 2c20 6469 6d73 290a  ion_fn(x, dims).
-00016bf0: 2020 2020 6172 676d 6178 5f73 756d 5f6f      argmax_sum_o
-00016c00: 7574 5f73 6861 7065 203d 205b 782e 7368  ut_shape = [x.sh
-00016c10: 6170 655b 695d 2069 6620 6920 6e6f 7420  ape[i] if i not 
-00016c20: 696e 2064 696d 7320 656c 7365 2031 2066  in dims else 1 f
-00016c30: 6f72 2069 2069 6e20 7261 6e67 6528 782e  or i in range(x.
-00016c40: 6e64 696d 295d 0a20 2020 2062 726f 6164  ndim)].    broad
-00016c50: 6361 7374 5f64 696d 7320 3d20 5b69 2066  cast_dims = [i f
-00016c60: 6f72 2069 2069 6e20 7261 6e67 6528 782e  or i in range(x.
-00016c70: 6e64 696d 2920 6966 2069 206e 6f74 2069  ndim) if i not i
-00016c80: 6e20 6469 6d73 5d0a 2020 2020 7265 7475  n dims].    retu
-00016c90: 726e 2070 7269 6d73 2e62 726f 6164 6361  rn prims.broadca
-00016ca0: 7374 5f69 6e5f 6469 6d28 6f75 742c 2061  st_in_dim(out, a
-00016cb0: 7267 6d61 785f 7375 6d5f 6f75 745f 7368  rgmax_sum_out_sh
-00016cc0: 6170 652c 2062 726f 6164 6361 7374 5f64  ape, broadcast_d
-00016cd0: 696d 7329 0a0a 0a23 2049 6e73 7069 7265  ims)...# Inspire
-00016ce0: 6420 6672 6f6d 2068 7474 7073 3a2f 2f67  d from https://g
-00016cf0: 6974 6875 622e 636f 6d2f 4849 5053 2f61  ithub.com/HIPS/a
-00016d00: 7574 6f67 7261 642f 626c 6f62 2f6d 6173  utograd/blob/mas
-00016d10: 7465 722f 6175 746f 6772 6164 2f6e 756d  ter/autograd/num
-00016d20: 7079 2f6e 756d 7079 5f76 6a70 732e 7079  py/numpy_vjps.py
-00016d30: 234c 3335 330a 6465 6620 6772 6164 5f63  #L353.def grad_c
-00016d40: 686f 6f73 6572 5f62 6163 6b77 6172 6428  hooser_backward(
-00016d50: 7072 696d 616c 2c20 782c 2078 5f73 6861  primal, x, x_sha
-00016d60: 7065 2c20 7265 6475 6365 645f 6469 6d73  pe, reduced_dims
-00016d70: 2c20 6729 3a0a 2020 2020 2222 2242 7569  , g):.    """Bui
-00016d80: 6c64 7320 6772 6164 6965 6e74 206f 6620  lds gradient of 
-00016d90: 6675 6e63 7469 6f6e 7320 7468 6174 2063  functions that c
-00016da0: 686f 6f73 6520 6120 7369 6e67 6c65 2069  hoose a single i
-00016db0: 7465 6d2c 2073 7563 6820 6173 206d 696e  tem, such as min
-00016dc0: 206f 7220 6d61 782e 2222 220a 2020 2020   or max.""".    
-00016dd0: 675f 7265 7065 6174 6564 203d 2072 6573  g_repeated = res
-00016de0: 746f 7265 5f72 6564 7563 6564 5f64 696d  tore_reduced_dim
-00016df0: 7328 672c 2072 6564 7563 6564 5f64 696d  s(g, reduced_dim
-00016e00: 732c 2078 5f73 6861 7065 290a 2020 2020  s, x_shape).    
-00016e10: 7072 696d 616c 5f72 6570 6561 7465 6420  primal_repeated 
-00016e20: 3d20 7265 7374 6f72 655f 7265 6475 6365  = restore_reduce
-00016e30: 645f 6469 6d73 2870 7269 6d61 6c2c 2072  d_dims(primal, r
-00016e40: 6564 7563 6564 5f64 696d 732c 2078 5f73  educed_dims, x_s
-00016e50: 6861 7065 290a 2020 2020 6172 676d 6178  hape).    argmax
-00016e60: 5f6c 6f63 6174 696f 6e73 203d 2078 203d  _locations = x =
-00016e70: 3d20 7072 696d 616c 5f72 6570 6561 7465  = primal_repeate
-00016e80: 640a 2020 2020 6172 676d 6178 5f73 756d  d.    argmax_sum
-00016e90: 203d 206b 6565 7064 696d 5f72 6564 7563   = keepdim_reduc
-00016ea0: 7469 6f6e 2870 7269 6d73 2e73 756d 2c20  tion(prims.sum, 
-00016eb0: 6172 676d 6178 5f6c 6f63 6174 696f 6e73  argmax_locations
-00016ec0: 2c20 7265 6475 6365 645f 6469 6d73 290a  , reduced_dims).
-00016ed0: 2020 2020 6f75 7420 3d20 675f 7265 7065      out = g_repe
-00016ee0: 6174 6564 202a 2061 7267 6d61 785f 6c6f  ated * argmax_lo
-00016ef0: 6361 7469 6f6e 7320 2f20 6172 676d 6178  cations / argmax
-00016f00: 5f73 756d 0a20 2020 2072 6574 7572 6e20  _sum.    return 
-00016f10: 6f75 740a 0a0a 7265 6769 7374 6572 5f62  out...register_b
-00016f20: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
-00016f30: 696d 4944 732e 414d 494e 2928 6772 6164  imIDs.AMIN)(grad
-00016f40: 5f63 686f 6f73 6572 5f62 6163 6b77 6172  _chooser_backwar
-00016f50: 6429 0a0a 0a40 7265 6769 7374 6572 5f61  d)...@register_a
-00016f60: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00016f70: 2870 7269 6d73 2e50 7269 6d49 4473 2e41  (prims.PrimIDs.A
-00016f80: 4d49 4e29 0a64 6566 2061 6d69 6e5f 6175  MIN).def amin_au
-00016f90: 675f 6677 6428 782c 2064 696d 7329 3a0a  g_fwd(x, dims):.
-00016fa0: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
-00016fb0: 2061 6d69 6e20 6f70 6572 6174 696f 6e2e   amin operation.
-00016fc0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00016fd0: 2020 2078 2028 5661 7269 6162 6c65 293a     x (Variable):
-00016fe0: 2054 656e 736f 7220 746f 2063 6f6d 7075   Tensor to compu
-00016ff0: 7465 2061 6d69 6e20 6f6e 2e0a 2020 2020  te amin on..    
-00017000: 2020 2020 6469 6d73 2028 5475 706c 655b      dims (Tuple[
-00017010: 696e 742c 202e 2e2e 5d29 3a20 4469 6d65  int, ...]): Dime
-00017020: 6e73 696f 6e73 2074 6f20 636f 6d70 7574  nsions to comput
-00017030: 6520 616d 696e 206f 7665 722e 0a20 2020  e amin over..   
-00017040: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00017050: 2020 564a 5044 7561 6c3a 2050 7269 6d61    VJPDual: Prima
-00017060: 6c20 616e 6420 7265 7369 6475 616c 732e  l and residuals.
-00017070: 0a20 2020 2022 2222 0a20 2020 2070 7269  .    """.    pri
-00017080: 6d61 6c20 3d20 7072 696d 732e 616d 696e  mal = prims.amin
-00017090: 2878 2c20 6469 6d73 290a 0a20 2020 2072  (x, dims)..    r
-000170a0: 6573 6964 7561 6c73 203d 2028 0a20 2020  esiduals = (.   
-000170b0: 2020 2020 2070 7269 6d61 6c2c 0a20 2020       primal,.   
-000170c0: 2020 2020 2078 2c0a 2020 2020 2020 2020       x,.        
-000170d0: 782e 7368 6170 652c 0a20 2020 2020 2020  x.shape,.       
-000170e0: 2064 696d 732c 0a20 2020 2029 0a0a 2020   dims,.    )..  
-000170f0: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00017100: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-00017110: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-00017120: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00017130: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
-00017140: 504f 5729 0a64 6566 2070 6f77 5f61 7567  POW).def pow_aug
-00017150: 5f66 6564 2878 2c20 7929 3a0a 2020 2020  _fed(x, y):.    
-00017160: 2222 2241 7567 6d65 6e74 6564 2074 6865  """Augmented the
-00017170: 2070 6f77 206f 7065 7261 7469 6f6e 2e0a   pow operation..
-00017180: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00017190: 2020 2078 2028 5661 7269 6162 6c65 293a     x (Variable):
-000171a0: 2054 656e 736f 7220 7769 7468 2074 6865   Tensor with the
-000171b0: 2062 6173 6520 746f 2062 6520 6578 706f   base to be expo
-000171c0: 6e65 6e74 6961 7465 642e 0a20 2020 2020  nentiated..     
-000171d0: 2020 2079 2028 5661 7269 6162 6c65 293a     y (Variable):
-000171e0: 2054 656e 736f 7220 7769 7468 2070 6f77   Tensor with pow
-000171f0: 6572 2074 6f20 7261 6973 6520 746f 2e0a  er to raise to..
-00017200: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-00017210: 2020 2020 2020 564a 5044 7561 6c3a 2050        VJPDual: P
-00017220: 7269 6d61 6c20 616e 6420 7265 7369 6475  rimal and residu
-00017230: 616c 732e 0a20 2020 2022 2222 0a20 2020  als..    """.   
-00017240: 2070 7269 6d61 6c20 3d20 7072 696d 732e   primal = prims.
-00017250: 706f 7728 782c 2079 290a 2020 2020 7265  pow(x, y).    re
-00017260: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
-00017270: 6c2c 2078 2c20 7929 0a20 2020 2072 6574  l, x, y).    ret
-00017280: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-00017290: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-000172a0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-000172b0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-000172c0: 732e 504f 5729 0a64 6566 2070 6f77 5f62  s.POW).def pow_b
-000172d0: 6163 6b77 6172 6428 7265 7375 6c74 2c20  ackward(result, 
-000172e0: 782c 2079 2c20 6729 3a0a 2020 2020 696d  x, y, g):.    im
-000172f0: 706f 7274 2074 6875 6e64 6572 2e63 6c61  port thunder.cla
-00017300: 6e67 2061 7320 746c 616e 670a 0a20 2020  ng as tlang..   
-00017310: 2067 7265 7375 6c74 203d 2067 202a 2072   gresult = g * r
-00017320: 6573 756c 7420 2023 2072 6575 7365 2063  esult  # reuse c
-00017330: 6f6d 6d6f 6e20 6661 6374 6f72 0a20 2020  ommon factor.   
-00017340: 2064 7820 3d20 6720 2a20 7920 2a20 7820   dx = g * y * x 
-00017350: 2a2a 2028 7920 2d20 3129 0a20 2020 2064  ** (y - 1).    d
-00017360: 7920 3d20 6772 6573 756c 7420 2a20 746c  y = gresult * tl
-00017370: 616e 672e 6c6f 6728 7829 0a20 2020 2072  ang.log(x).    r
-00017380: 6574 7572 6e20 6478 2c20 6479 0a0a 0a40  eturn dx, dy...@
-00017390: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-000173a0: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
-000173b0: 2e50 7269 6d49 4473 2e54 414e 290a 6465  .PrimIDs.TAN).de
-000173c0: 6620 7461 6e5f 6175 675f 6677 6428 7829  f tan_aug_fwd(x)
-000173d0: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
-000173e0: 6564 2074 616e 206f 7065 7261 7469 6f6e  ed tan operation
-000173f0: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-00017400: 2020 2020 2078 2028 5661 7269 6162 6c65       x (Variable
-00017410: 293a 2054 656e 736f 7220 746f 2062 6520  ): Tensor to be 
-00017420: 7061 7373 6564 2074 6f20 7461 6e2e 0a20  passed to tan.. 
-00017430: 2020 2022 2222 0a0a 2020 2020 7072 696d     """..    prim
-00017440: 616c 203d 2070 7269 6d73 2e74 616e 2878  al = prims.tan(x
-00017450: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00017460: 3d20 2870 7269 6d61 6c2c 290a 2020 2020  = (primal,).    
-00017470: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
-00017480: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
-00017490: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
-000174a0: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
-000174b0: 6d49 4473 2e54 414e 290a 6465 6620 7461  mIDs.TAN).def ta
-000174c0: 6e5f 6261 636b 7761 7264 2872 6573 756c  n_backward(resul
-000174d0: 742c 2067 293a 0a20 2020 2072 6574 7572  t, g):.    retur
-000174e0: 6e20 6720 2a20 2831 202b 2072 6573 756c  n g * (1 + resul
-000174f0: 7420 2a20 7265 7375 6c74 290a 0a0a 2320  t * result)...# 
-00017500: 4e4f 5445 3a20 4a61 7820 7573 6573 206e  NOTE: Jax uses n
-00017510: 702e 6172 6773 6f72 7420 696e 2069 7473  p.argsort in its
-00017520: 2074 7261 6e73 706f 7365 2076 6a70 2063   transpose vjp c
-00017530: 6f6d 7075 7461 7469 6f6e 0a64 6566 205f  omputation.def _
-00017540: 6172 6773 6f72 7428 7365 7129 3a0a 2020  argsort(seq):.  
-00017550: 2020 7265 7475 726e 2073 6f72 7465 6428    return sorted(
-00017560: 7261 6e67 6528 6c65 6e28 7365 7129 292c  range(len(seq)),
-00017570: 206b 6579 3d73 6571 2e5f 5f67 6574 6974   key=seq.__getit
-00017580: 656d 5f5f 290a 0a0a 4072 6567 6973 7465  em__)...@registe
-00017590: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
-000175a0: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
-000175b0: 732e 4445 5649 4345 5f50 5554 290a 6465  s.DEVICE_PUT).de
-000175c0: 6620 6465 7669 6365 5f70 7574 5f61 7567  f device_put_aug
-000175d0: 5f66 7764 2861 3a20 5465 6e73 6f72 5072  _fwd(a: TensorPr
-000175e0: 6f78 792c 2064 6576 6963 653a 2044 6576  oxy, device: Dev
-000175f0: 6963 6529 202d 3e20 5465 6e73 6f72 5072  ice) -> TensorPr
-00017600: 6f78 793a 0a20 2020 2070 7269 6d61 6c20  oxy:.    primal 
-00017610: 3d20 7072 696d 732e 6465 7669 6365 5f70  = prims.device_p
-00017620: 7574 2861 2c20 6465 7669 6365 290a 2020  ut(a, device).  
-00017630: 2020 7265 7369 6475 616c 7320 3d20 2861    residuals = (a
-00017640: 2e64 6576 6963 652c 290a 2020 2020 7265  .device,).    re
-00017650: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-00017660: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-00017670: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00017680: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-00017690: 4473 2e44 4556 4943 455f 5055 5429 0a64  Ds.DEVICE_PUT).d
-000176a0: 6566 2064 6576 6963 655f 7075 745f 6261  ef device_put_ba
-000176b0: 636b 7761 7264 286f 7269 675f 6465 7669  ckward(orig_devi
-000176c0: 6365 2c20 6729 3a0a 2020 2020 7265 7475  ce, g):.    retu
-000176d0: 726e 2070 7269 6d73 2e64 6576 6963 655f  rn prims.device_
-000176e0: 7075 7428 672c 206f 7269 675f 6465 7669  put(g, orig_devi
-000176f0: 6365 292c 204e 6f6e 650a 0a0a 4072 6567  ce), None...@reg
-00017700: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00017710: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00017720: 696d 4944 732e 434f 4e56 4f4c 5554 494f  imIDs.CONVOLUTIO
-00017730: 4e29 0a64 6566 2063 6f6e 766f 6c75 7469  N).def convoluti
-00017740: 6f6e 5f61 7567 5f66 7764 280a 2020 2020  on_aug_fwd(.    
-00017750: 613a 2050 726f 7879 2c0a 2020 2020 7765  a: Proxy,.    we
-00017760: 6967 6874 2c0a 2020 2020 6269 6173 2c0a  ight,.    bias,.
-00017770: 2020 2020 7374 7269 6465 2c0a 2020 2020      stride,.    
-00017780: 7061 6464 696e 672c 0a20 2020 2064 696c  padding,.    dil
-00017790: 6174 696f 6e2c 0a20 2020 2074 7261 6e73  ation,.    trans
-000177a0: 706f 7365 642c 0a20 2020 206f 7574 7075  posed,.    outpu
-000177b0: 745f 7061 6464 696e 672c 0a20 2020 2067  t_padding,.    g
-000177c0: 726f 7570 732c 0a29 3a0a 2020 2020 7072  roups,.):.    pr
-000177d0: 696d 616c 203d 2063 6f6e 766f 6c75 7469  imal = convoluti
-000177e0: 6f6e 2861 2c20 7765 6967 6874 2c20 6269  on(a, weight, bi
-000177f0: 6173 2c20 7374 7269 6465 2c20 7061 6464  as, stride, padd
-00017800: 696e 672c 2064 696c 6174 696f 6e2c 2074  ing, dilation, t
-00017810: 7261 6e73 706f 7365 642c 206f 7574 7075  ransposed, outpu
-00017820: 745f 7061 6464 696e 672c 2067 726f 7570  t_padding, group
-00017830: 7329 0a20 2020 2072 6573 6964 7561 6c73  s).    residuals
-00017840: 203d 2028 7072 696d 616c 2c20 612c 2077   = (primal, a, w
-00017850: 6569 6768 742c 2062 6961 732c 2073 7472  eight, bias, str
-00017860: 6964 652c 2070 6164 6469 6e67 2c20 6469  ide, padding, di
-00017870: 6c61 7469 6f6e 2c20 7472 616e 7370 6f73  lation, transpos
-00017880: 6564 2c20 6f75 7470 7574 5f70 6164 6469  ed, output_paddi
-00017890: 6e67 2c20 6772 6f75 7073 290a 2020 2020  ng, groups).    
-000178a0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
-000178b0: 7269 6d61 6c2c 2072 6573 6964 7561 6c73  rimal, residuals
-000178c0: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
-000178d0: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
-000178e0: 6d49 4473 2e43 4f4e 564f 4c55 5449 4f4e  mIDs.CONVOLUTION
-000178f0: 290a 6465 6620 636f 6e76 6f6c 7574 696f  ).def convolutio
-00017900: 6e5f 6261 636b 7761 7264 280a 2020 2020  n_backward(.    
-00017910: 6f75 7470 7574 3a20 5072 6f78 792c 0a20  output: Proxy,. 
-00017920: 2020 2069 6e70 7574 3a20 5072 6f78 792c     input: Proxy,
-00017930: 0a20 2020 2077 6569 6768 742c 0a20 2020  .    weight,.   
-00017940: 2062 6961 732c 0a20 2020 2073 7472 6964   bias,.    strid
-00017950: 652c 0a20 2020 2070 6164 6469 6e67 2c0a  e,.    padding,.
-00017960: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
-00017970: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
-00017980: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
-00017990: 2c0a 2020 2020 6772 6f75 7073 2c0a 2020  ,.    groups,.  
-000179a0: 2020 6772 6164 2c0a 293a 0a20 2020 2023    grad,.):.    #
-000179b0: 2054 7261 6e73 706f 7365 6420 636f 6e76   Transposed conv
-000179c0: 6f6c 7574 696f 6e20 6973 206e 6f74 2073  olution is not s
-000179d0: 7570 706f 7274 6564 210a 2020 2020 6173  upported!.    as
-000179e0: 7365 7274 2074 7261 6e73 706f 7365 6420  sert transposed 
-000179f0: 3d3d 2030 0a0a 2020 2020 696e 7075 745f  == 0..    input_
-00017a00: 6772 6164 203d 204e 6f6e 650a 2020 2020  grad = None.    
-00017a10: 7765 6967 6874 5f67 7261 6420 3d20 4e6f  weight_grad = No
-00017a20: 6e65 0a20 2020 2062 6961 735f 6772 6164  ne.    bias_grad
-00017a30: 203d 204e 6f6e 650a 0a20 2020 2023 2053   = None..    # S
-00017a40: 686f 7274 2063 6972 6375 6974 206f 6e20  hort circuit on 
-00017a50: 7a65 726f 2d64 696d 2067 7261 640a 2020  zero-dim grad.  
-00017a60: 2020 6966 2061 6e79 2873 203d 3d20 3020    if any(s == 0 
-00017a70: 666f 7220 7320 696e 2067 7261 642e 7368  for s in grad.sh
-00017a80: 6170 6529 3a0a 2020 2020 2020 2020 696e  ape):.        in
-00017a90: 7075 745f 6772 6164 203d 2066 756c 6c5f  put_grad = full_
-00017aa0: 6c69 6b65 2869 6e70 7574 2c20 6669 6c6c  like(input, fill
-00017ab0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
-00017ac0: 2020 7765 6967 6874 5f67 7261 6420 3d20    weight_grad = 
-00017ad0: 6675 6c6c 5f6c 696b 6528 7765 6967 6874  full_like(weight
-00017ae0: 2c20 6669 6c6c 5f76 616c 7565 3d30 290a  , fill_value=0).
-00017af0: 2020 2020 2020 2020 6966 2062 6961 7320          if bias 
-00017b00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00017b10: 2020 2020 2020 2020 2062 6961 735f 6772           bias_gr
-00017b20: 6164 203d 2066 756c 6c5f 6c69 6b65 2862  ad = full_like(b
-00017b30: 6961 732c 2066 696c 6c5f 7661 6c75 653d  ias, fill_value=
-00017b40: 3029 0a20 2020 2020 2020 2072 6574 7572  0).        retur
-00017b50: 6e20 2869 6e70 7574 5f67 7261 642c 2077  n (input_grad, w
-00017b60: 6569 6768 745f 6772 6164 2c20 6269 6173  eight_grad, bias
-00017b70: 5f67 7261 6429 202b 2028 284e 6f6e 652c  _grad) + ((None,
-00017b80: 2920 2a20 3629 0a0a 2020 2020 6261 7463  ) * 6)..    batc
-00017b90: 682c 2069 6e5f 6368 616e 6e65 6c73 2c20  h, in_channels, 
-00017ba0: 2a73 7061 7469 616c 5f64 696d 7320 3d20  *spatial_dims = 
-00017bb0: 696e 7075 742e 7368 6170 650a 2020 2020  input.shape.    
-00017bc0: 6f75 745f 6368 616e 6e65 6c73 2c20 6769  out_channels, gi
-00017bd0: 6e5f 6368 616e 6e65 6c73 2c20 2a6b 6572  n_channels, *ker
-00017be0: 6e65 6c5f 6469 6d73 203d 2077 6569 6768  nel_dims = weigh
-00017bf0: 742e 7368 6170 650a 2020 2020 6469 6d20  t.shape.    dim 
-00017c00: 3d20 6c65 6e28 7370 6174 6961 6c5f 6469  = len(spatial_di
-00017c10: 6d73 290a 0a20 2020 2064 6566 206d 6179  ms)..    def may
-00017c20: 6265 5f65 7870 616e 645f 7365 7128 732c  be_expand_seq(s,
-00017c30: 2064 696d 293a 0a20 2020 2020 2020 2069   dim):.        i
-00017c40: 6620 6c65 6e28 7329 203d 3d20 313a 0a20  f len(s) == 1:. 
-00017c50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00017c60: 6e20 2873 5b30 5d2c 2920 2a20 6469 6d0a  n (s[0],) * dim.
-00017c70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00017c80: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017c90: 2073 0a0a 2020 2020 7374 7269 6465 203d   s..    stride =
-00017ca0: 206d 6179 6265 5f65 7870 616e 645f 7365   maybe_expand_se
-00017cb0: 7128 7374 7269 6465 2c20 6469 6d29 0a20  q(stride, dim). 
-00017cc0: 2020 2070 6164 6469 6e67 203d 206d 6179     padding = may
-00017cd0: 6265 5f65 7870 616e 645f 7365 7128 7061  be_expand_seq(pa
-00017ce0: 6464 696e 672c 2064 696d 290a 2020 2020  dding, dim).    
-00017cf0: 6469 6c61 7469 6f6e 203d 206d 6179 6265  dilation = maybe
-00017d00: 5f65 7870 616e 645f 7365 7128 6469 6c61  _expand_seq(dila
-00017d10: 7469 6f6e 2c20 6469 6d29 0a0a 2020 2020  tion, dim)..    
-00017d20: 6465 6620 636f 6e76 5f74 7261 6e73 706f  def conv_transpo
-00017d30: 7365 2874 293a 0a20 2020 2020 2020 2072  se(t):.        r
-00017d40: 6574 7572 6e20 7072 696d 732e 7472 616e  eturn prims.tran
-00017d50: 7370 6f73 6528 742c 2028 312c 2030 2920  spose(t, (1, 0) 
-00017d60: 2b20 7475 706c 6528 7261 6e67 6528 322c  + tuple(range(2,
-00017d70: 2074 2e6e 6469 6d29 2929 0a0a 2020 2020   t.ndim)))..    
-00017d80: 2320 696e 7075 745f 6772 6164 203d 207b  # input_grad = {
-00017d90: 0a20 2020 2064 6566 2074 7261 6e73 706f  .    def transpo
-00017da0: 7365 5f61 6e64 5f66 6c69 705f 7765 6967  se_and_flip_weig
-00017db0: 6874 2877 6569 6768 7429 3a0a 2020 2020  ht(weight):.    
-00017dc0: 2020 2020 2320 5468 6520 6c69 6e65 7320      # The lines 
-00017dd0: 6265 6c6f 7720 6172 6520 7472 616e 7370  below are transp
-00017de0: 6f73 696e 6720 7468 6520 6368 616e 6e65  osing the channe
-00017df0: 6c73 2064 696d 732e 0a20 2020 2020 2020  ls dims..       
-00017e00: 2023 2057 6520 616c 736f 206e 6565 6420   # We also need 
-00017e10: 746f 2065 7874 7261 6374 2074 6865 2067  to extract the g
-00017e20: 726f 7570 2069 6e66 6f72 6d61 7469 6f6e  roup information
-00017e30: 2061 6e64 206d 6572 6765 2069 740a 2020   and merge it.  
-00017e40: 2020 2020 2020 2320 7769 7468 2074 6865        # with the
-00017e50: 2064 696d 656e 7369 6f6e 2063 6f72 7265   dimension corre
-00017e60: 7370 6f6e 6469 6e67 2074 6f20 7468 6520  sponding to the 
-00017e70: 226f 7574 5f63 6861 6e6e 656c 7322 2064  "out_channels" d
-00017e80: 696d 2e0a 2020 2020 2020 2020 2320 286f  im..        # (o
-00017e90: 7574 5f63 6861 6e6e 656c 732c 2067 696e  ut_channels, gin
-00017ea0: 5f63 6861 6e6e 656c 7329 202d 3e20 2867  _channels) -> (g
-00017eb0: 696e 5f63 6861 6e6e 656c 732c 206f 7574  in_channels, out
-00017ec0: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
-00017ed0: 2020 2077 6569 6768 7420 3d20 636f 6e76     weight = conv
-00017ee0: 5f74 7261 6e73 706f 7365 2877 6569 6768  _transpose(weigh
-00017ef0: 7429 0a20 2020 2020 2020 2023 2053 706c  t).        # Spl
-00017f00: 6974 2028 6f75 745f 6368 616e 6e65 6c73  it (out_channels
-00017f10: 2c29 202d 3e20 2867 726f 7570 732c 206f  ,) -> (groups, o
-00017f20: 7574 5f63 6861 6e6e 656c 7320 2f2f 2067  ut_channels // g
-00017f30: 726f 7570 7329 0a20 2020 2020 2020 2077  roups).        w
-00017f40: 6569 6768 7420 3d20 7765 6967 6874 2e72  eight = weight.r
-00017f50: 6573 6861 7065 285b 6769 6e5f 6368 616e  eshape([gin_chan
-00017f60: 6e65 6c73 2c20 6772 6f75 7073 2c20 6f75  nels, groups, ou
-00017f70: 745f 6368 616e 6e65 6c73 202f 2f20 6772  t_channels // gr
-00017f80: 6f75 7073 5d20 2b20 6b65 726e 656c 5f64  oups] + kernel_d
-00017f90: 696d 7329 0a20 2020 2020 2020 2023 204d  ims).        # M
-00017fa0: 6f76 696e 6720 6772 6f75 7073 2074 6f20  oving groups to 
-00017fb0: 7468 6520 6c65 6674 2d6d 6f73 7420 706f  the left-most po
-00017fc0: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
-00017fd0: 2320 2867 696e 5f63 6861 6e6e 656c 732c  # (gin_channels,
-00017fe0: 2067 726f 7570 732c 206f 7574 5f63 6861   groups, out_cha
-00017ff0: 6e6e 656c 7320 2f2f 2067 726f 7570 7329  nnels // groups)
-00018000: 202d 3e20 2867 726f 7570 732c 2067 696e   -> (groups, gin
-00018010: 5f63 6861 6e6e 656c 732c 206f 7574 5f63  _channels, out_c
-00018020: 6861 6e6e 656c 7320 2f2f 2067 726f 7570  hannels // group
-00018030: 7329 0a20 2020 2020 2020 2077 6569 6768  s).        weigh
-00018040: 7420 3d20 636f 6e76 5f74 7261 6e73 706f  t = conv_transpo
-00018050: 7365 2877 6569 6768 7429 0a20 2020 2020  se(weight).     
-00018060: 2020 2023 2053 7175 6173 6820 2867 726f     # Squash (gro
-00018070: 7570 732c 2067 696e 5f63 6861 6e6e 656c  ups, gin_channel
-00018080: 7329 202d 3e20 2869 6e5f 6368 616e 6e65  s) -> (in_channe
-00018090: 6c73 290a 2020 2020 2020 2020 7765 6967  ls).        weig
-000180a0: 6874 203d 2077 6569 6768 742e 7265 7368  ht = weight.resh
-000180b0: 6170 6528 5b69 6e5f 6368 616e 6e65 6c73  ape([in_channels
-000180c0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
-000180d0: 2f20 6772 6f75 7073 5d20 2b20 6b65 726e  / groups] + kern
-000180e0: 656c 5f64 696d 7329 0a0a 2020 2020 2020  el_dims)..      
-000180f0: 2020 2320 466c 6970 2073 7061 7469 616c    # Flip spatial
-00018100: 2064 696d 656e 7369 6f6e 730a 2020 2020   dimensions.    
-00018110: 2020 2020 7765 6967 6874 203d 2070 7269      weight = pri
-00018120: 6d73 2e66 6c69 7028 7765 6967 6874 2c20  ms.flip(weight, 
-00018130: 7475 706c 6528 7261 6e67 6528 322c 2077  tuple(range(2, w
-00018140: 6569 6768 742e 6e64 696d 2929 290a 2020  eight.ndim))).  
-00018150: 2020 2020 2020 7265 7475 726e 2077 6569        return wei
-00018160: 6768 740a 0a20 2020 2023 2057 6520 6e65  ght..    # We ne
-00018170: 6564 2074 6f20 7061 6420 7468 6520 6772  ed to pad the gr
-00018180: 6164 6965 6e74 2074 6f20 6265 2061 626c  adient to be abl
-00018190: 6520 746f 2066 6974 206b 6572 6e65 6c20  e to fit kernel 
-000181a0: 7769 6e64 6f77 732e 0a20 2020 2069 6e69  windows..    ini
-000181b0: 7469 616c 5f67 7261 645f 7061 6464 696e  tial_grad_paddin
-000181c0: 6720 3d20 5b64 202a 2028 6b20 2d20 3129  g = [d * (k - 1)
-000181d0: 2066 6f72 2064 2c20 6b20 696e 207a 6970   for d, k in zip
-000181e0: 2864 696c 6174 696f 6e2c 206b 6572 6e65  (dilation, kerne
-000181f0: 6c5f 6469 6d73 295d 0a0a 2020 2020 696e  l_dims)]..    in
-00018200: 7075 745f 6772 6164 203d 2063 6f6e 766f  put_grad = convo
-00018210: 6c75 7469 6f6e 280a 2020 2020 2020 2020  lution(.        
-00018220: 7072 696d 732e 7061 6428 0a20 2020 2020  prims.pad(.     
-00018230: 2020 2020 2020 2067 7261 642c 0a20 2020         grad,.   
-00018240: 2020 2020 2020 2020 2030 2e30 2c0a 2020           0.0,.  
-00018250: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00018260: 7069 7865 7320 6172 6520 7374 7269 6465  pixes are stride
-00018270: 2061 7761 7920 6672 6f6d 2065 6163 6820   away from each 
-00018280: 6f74 6865 7220 696e 2074 6865 206f 7269  other in the ori
-00018290: 6769 6e61 6c20 696e 7075 742e 0a20 2020  ginal input..   
-000182a0: 2020 2020 2020 2020 2023 2048 656e 6365           # Hence
-000182b0: 2077 6520 6e65 6564 2074 6f20 6469 6c61   we need to dila
-000182c0: 7465 2074 6865 2067 7261 6469 656e 7420  te the gradient 
-000182d0: 6279 2064 696c 6174 696f 6e3d 7374 7269  by dilation=stri
-000182e0: 6465 202d 2031 0a20 2020 2020 2020 2020  de - 1.         
-000182f0: 2020 2023 2073 6f20 7468 6174 2074 6865     # so that the
-00018300: 7265 2061 7265 2073 7472 6964 6520 2d20  re are stride - 
-00018310: 3120 7a65 726f 7320 6265 7477 6565 6e20  1 zeros between 
-00018320: 7468 6520 7069 7865 6c73 2e0a 2020 2020  the pixels..    
-00018330: 2020 2020 2020 2020 5b28 302c 2030 2c20          [(0, 0, 
-00018340: 3029 2c20 2830 2c20 302c 2030 295d 202b  0), (0, 0, 0)] +
-00018350: 205b 2830 2c20 302c 2073 202d 2031 2920   [(0, 0, s - 1) 
-00018360: 666f 7220 7320 696e 2073 7472 6964 655d  for s in stride]
-00018370: 2c0a 2020 2020 2020 2020 292c 0a20 2020  ,.        ),.   
-00018380: 2020 2020 2074 7261 6e73 706f 7365 5f61       transpose_a
-00018390: 6e64 5f66 6c69 705f 7765 6967 6874 2877  nd_flip_weight(w
-000183a0: 6569 6768 7429 2c0a 2020 2020 2020 2020  eight),.        
-000183b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2320  None,.        # 
-000183c0: 5365 7474 696e 6720 7374 7269 6465 2074  Setting stride t
-000183d0: 6f20 3120 6173 2074 6865 2064 6973 7461  o 1 as the dista
-000183e0: 6e63 6520 6265 7477 6565 6e20 7069 7865  nce between pixe
-000183f0: 6c73 2069 7320 7461 6b65 6e0a 2020 2020  ls is taken.    
-00018400: 2020 2020 2320 6361 7265 2062 7920 7468      # care by th
-00018410: 6520 7061 6420 7269 6768 7420 6162 6f76  e pad right abov
-00018420: 652e 0a20 2020 2020 2020 2028 312c 292c  e..        (1,),
-00018430: 0a20 2020 2020 2020 2069 6e69 7469 616c  .        initial
-00018440: 5f67 7261 645f 7061 6464 696e 672c 0a20  _grad_padding,. 
-00018450: 2020 2020 2020 2064 696c 6174 696f 6e2c         dilation,
-00018460: 0a20 2020 2020 2020 2074 7261 6e73 706f  .        transpo
-00018470: 7365 642c 0a20 2020 2020 2020 206f 7574  sed,.        out
-00018480: 7075 745f 7061 6464 696e 672c 0a20 2020  put_padding,.   
-00018490: 2020 2020 2067 726f 7570 732c 0a20 2020       groups,.   
-000184a0: 2029 0a0a 2020 2020 6465 6620 7061 645f   )..    def pad_
-000184b0: 746f 5f69 6e70 7574 2867 7261 6429 3a0a  to_input(grad):.
-000184c0: 2020 2020 2020 2020 2320 5765 206e 6565          # We nee
-000184d0: 6420 746f 2075 6e70 6164 2074 6865 2070  d to unpad the p
-000184e0: 6164 6469 6e67 2064 6f6e 6520 746f 2074  adding done to t
-000184f0: 6865 2069 6e70 7574 2070 7269 6f72 2074  he input prior t
-00018500: 6f20 7468 6520 636f 6e76 6f6c 7574 696f  o the convolutio
-00018510: 6e2e 0a20 2020 2020 2020 2023 204e 6f74  n..        # Not
-00018520: 6520 7468 6174 206c 6f77 2061 6e64 2068  e that low and h
-00018530: 6967 6820 7061 6464 696e 6720 6172 6520  igh padding are 
-00018540: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
-00018550: 6571 7561 6c2c 2073 6f20 7765 2063 616e  equal, so we can
-00018560: 6e6f 740a 2020 2020 2020 2020 2320 6162  not.        # ab
-00018570: 736f 7262 2069 7420 696e 746f 2074 6865  sorb it into the
-00018580: 2063 6f6e 766f 6c75 7469 6f6e 206a 7573   convolution jus
-00018590: 7420 7965 742c 2075 6e6c 6573 7320 7468  t yet, unless th
-000185a0: 6520 4150 4920 6973 206d 6f64 6966 6965  e API is modifie
-000185b0: 642e 0a20 2020 2020 2020 2070 6164 5f63  d..        pad_c
-000185c0: 6f6e 6669 6720 3d20 5b28 302c 2030 2c20  onfig = [(0, 0, 
-000185d0: 3029 2c20 2830 2c20 302c 2030 295d 0a20  0), (0, 0, 0)]. 
-000185e0: 2020 2020 2020 2066 6f72 206f 2c20 692c         for o, i,
-000185f0: 2067 2c20 7020 696e 207a 6970 2867 7261   g, p in zip(gra
-00018600: 642e 7368 6170 655b 323a 5d2c 2073 7061  d.shape[2:], spa
-00018610: 7469 616c 5f64 696d 732c 2069 6e70 7574  tial_dims, input
-00018620: 5f67 7261 642e 7368 6170 655b 323a 5d2c  _grad.shape[2:],
-00018630: 2070 6164 6469 6e67 293a 0a20 2020 2020   padding):.     
-00018640: 2020 2020 2020 206c 6f20 3d20 2d70 0a20         lo = -p. 
-00018650: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-00018660: 6520 7468 6174 2028 6920 2b20 3220 2a20  e that (i + 2 * 
-00018670: 7029 2069 7320 7468 6520 7369 7a65 206f  p) is the size o
-00018680: 6620 7468 6520 7061 6464 6564 2069 6e70  f the padded inp
-00018690: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-000186a0: 2320 736f 2074 6865 2071 7561 6e74 6974  # so the quantit
-000186b0: 7920 2869 202b 2032 202a 2070 2920 2d20  y (i + 2 * p) - 
-000186c0: 6720 7465 6c6c 7320 7573 2062 7920 686f  g tells us by ho
-000186d0: 7720 6d75 6368 0a20 2020 2020 2020 2020  w much.         
-000186e0: 2020 2023 2077 6520 6e65 6564 2074 6f20     # we need to 
-000186f0: 7061 6420 7468 6520 6772 6164 6965 6e74  pad the gradient
-00018700: 2073 6f20 7468 6174 2074 6865 2065 6c65   so that the ele
-00018710: 6d65 6e74 7320 6f75 7473 6964 650a 2020  ments outside.  
-00018720: 2020 2020 2020 2020 2020 2320 6f66 2074            # of t
-00018730: 6865 2063 6f6e 766f 6c75 7469 6f6e 2072  he convolution r
-00018740: 6563 6569 7665 207a 6572 6f20 6772 6164  eceive zero grad
-00018750: 6965 6e74 2e0a 2020 2020 2020 2020 2020  ient..          
-00018760: 2020 2320 7020 6973 2061 6464 6974 696f    # p is additio
-00018770: 6e61 6c6c 7920 7375 6274 7261 6374 6564  nally subtracted
-00018780: 2074 6f20 6e65 6761 7465 2074 6865 2069   to negate the i
-00018790: 6e70 7574 2773 2070 6164 0a20 2020 2020  nput's pad.     
-000187a0: 2020 2020 2020 2023 2069 6e20 666f 7277         # in forw
-000187b0: 6172 642e 0a20 2020 2020 2020 2020 2020  ard..           
-000187c0: 2068 6920 3d20 2869 202b 2032 202a 2070   hi = (i + 2 * p
-000187d0: 2920 2d20 6720 2d20 700a 2020 2020 2020  ) - g - p.      
-000187e0: 2020 2020 2020 7061 645f 636f 6e66 6967        pad_config
-000187f0: 2e61 7070 656e 6428 286c 6f2c 2068 692c  .append((lo, hi,
-00018800: 2030 2929 0a20 2020 2020 2020 2072 6574   0)).        ret
-00018810: 7572 6e20 7072 696d 732e 7061 6428 6772  urn prims.pad(gr
-00018820: 6164 2c20 302e 302c 2070 6164 5f63 6f6e  ad, 0.0, pad_con
-00018830: 6669 6729 0a0a 2020 2020 696e 7075 745f  fig)..    input_
-00018840: 6772 6164 203d 2070 6164 5f74 6f5f 696e  grad = pad_to_in
-00018850: 7075 7428 696e 7075 745f 6772 6164 290a  put(input_grad).
-00018860: 2020 2020 2320 7d0a 0a20 2020 2023 2062      # }..    # b
-00018870: 6961 735f 6772 6164 203d 207b 0a20 2020  ias_grad = {.   
-00018880: 2069 6620 6269 6173 2069 7320 6e6f 7420   if bias is not 
-00018890: 4e6f 6e65 3a0a 2020 2020 2020 2020 696d  None:.        im
-000188a0: 706f 7274 2074 6875 6e64 6572 2e74 6f72  port thunder.tor
-000188b0: 6368 2061 7320 6c74 6f72 6368 0a0a 2020  ch as ltorch..  
-000188c0: 2020 2020 2020 6269 6173 5f67 7261 6420        bias_grad 
-000188d0: 3d20 6c74 6f72 6368 2e73 756d 2867 7261  = ltorch.sum(gra
-000188e0: 642c 205b 6420 666f 7220 6420 696e 2072  d, [d for d in r
-000188f0: 616e 6765 2867 7261 642e 6e64 696d 2920  ange(grad.ndim) 
-00018900: 6966 2064 2021 3d20 315d 290a 2020 2020  if d != 1]).    
-00018910: 2320 7d0a 0a20 2020 2023 2077 6569 6768  # }..    # weigh
-00018920: 7420 6772 6164 203d 207b 0a20 2020 2064  t grad = {.    d
-00018930: 6566 2070 6164 5f74 7261 6e73 706f 7365  ef pad_transpose
-00018940: 5f61 6e64 5f70 7573 685f 6772 6f75 7073  _and_push_groups
-00018950: 5f69 6e74 6f5f 6261 7463 6865 7328 7429  _into_batches(t)
-00018960: 3a0a 2020 2020 2020 2020 2320 4669 7273  :.        # Firs
-00018970: 7420 7061 642c 2e2e 2e0a 2020 2020 2020  t pad,....      
-00018980: 2020 2320 5061 6420 6173 206e 6563 6573    # Pad as neces
-00018990: 7361 7279 2073 6f20 7468 6174 2069 6e20  sary so that in 
-000189a0: 636f 6e76 6f6c 7574 696f 6e73 2077 6520  convolutions we 
-000189b0: 6e65 7665 7220 6164 7661 6e63 650a 2020  never advance.  
-000189c0: 2020 2020 2020 2320 7061 7374 2072 656c        # past rel
-000189d0: 6576 616e 7420 696e 7075 7473 2e0a 2020  evant inputs..  
-000189e0: 2020 2020 2020 7061 645f 636f 6e66 6967        pad_config
-000189f0: 203d 205b 2830 2c20 302c 2030 292c 2028   = [(0, 0, 0), (
-00018a00: 302c 2030 2c20 3029 5d0a 2020 2020 2020  0, 0, 0)].      
-00018a10: 2020 666f 7220 6f2c 2069 2c20 6b2c 2070    for o, i, k, p
-00018a20: 2c20 732c 2064 2069 6e20 7a69 7028 6772  , s, d in zip(gr
-00018a30: 6164 2e73 6861 7065 5b32 3a5d 2c20 7370  ad.shape[2:], sp
-00018a40: 6174 6961 6c5f 6469 6d73 2c20 6b65 726e  atial_dims, kern
-00018a50: 656c 5f64 696d 732c 2070 6164 6469 6e67  el_dims, padding
-00018a60: 2c20 7374 7269 6465 2c20 6469 6c61 7469  , stride, dilati
-00018a70: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
-00018a80: 2023 2050 6164 6469 6e67 2066 726f 6d20   # Padding from 
-00018a90: 6265 6c6f 7720 6973 2074 6865 2073 616d  below is the sam
-00018aa0: 652e 0a20 2020 2020 2020 2020 2020 206c  e..            l
-00018ab0: 6f20 3d20 700a 2020 2020 2020 2020 2020  o = p.          
-00018ac0: 2020 2320 5468 6572 6520 6973 2061 6c77    # There is alw
-00018ad0: 6179 7320 7468 6520 6d61 7820 696e 6465  ays the max inde
-00018ae0: 7820 6964 7820 696e 2074 6865 2069 6e70  x idx in the inp
-00018af0: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
-00018b00: 2074 6865 2076 616c 7565 206f 6620 7768   the value of wh
-00018b10: 6963 682c 2069 6e70 7574 5b69 6478 5d2c  ich, input[idx],
-00018b20: 2074 6865 206b 6572 6e65 6c20 746f 7563   the kernel touc
-00018b30: 6865 732e 0a20 2020 2020 2020 2020 2020  hes..           
-00018b40: 2023 2054 6865 206b 6572 6e65 6c20 7265   # The kernel re
-00018b50: 6163 682c 206f 7220 6b5f 7265 6163 682c  ach, or k_reach,
-00018b60: 2069 7320 6578 6163 746c 7920 6964 7820   is exactly idx 
-00018b70: 2b20 312e 0a20 2020 2020 2020 2020 2020  + 1..           
-00018b80: 2023 2057 6520 7573 6520 6974 2074 6f20   # We use it to 
-00018b90: 6465 6369 6465 2062 7920 686f 7720 6d75  decide by how mu
-00018ba0: 6368 2077 6520 6e65 6564 2074 6f20 7061  ch we need to pa
-00018bb0: 6420 6672 6f6d 2061 626f 7665 0a20 2020  d from above.   
-00018bc0: 2020 2020 2020 2020 2023 2061 7320 746f           # as to
-00018bd0: 206e 6f74 206d 6f76 6520 7061 7374 2072   not move past r
-00018be0: 656c 6576 616e 7420 7661 6c75 6573 2e0a  elevant values..
-00018bf0: 2020 2020 2020 2020 2020 2020 6b5f 7265              k_re
-00018c00: 6163 6820 3d20 286f 202d 2031 2920 2a20  ach = (o - 1) * 
-00018c10: 7320 2b20 6420 2a20 286b 202d 2031 2920  s + d * (k - 1) 
-00018c20: 2b20 310a 2020 2020 2020 2020 2020 2020  + 1.            
-00018c30: 2320 5468 6520 7061 6420 6672 6f6d 2061  # The pad from a
-00018c40: 626f 7665 2065 7175 616c 7320 6b5f 7265  bove equals k_re
-00018c50: 6163 6820 6d69 6e75 7320 7468 6520 6c65  ach minus the le
-00018c60: 6e67 7468 0a20 2020 2020 2020 2020 2020  ngth.           
-00018c70: 2023 206f 6620 7468 6520 696e 7075 7420   # of the input 
-00018c80: 7061 6464 6564 2066 726f 6d20 6265 6c6f  padded from belo
-00018c90: 772e 0a20 2020 2020 2020 2020 2020 2068  w..            h
-00018ca0: 6920 3d20 6b5f 7265 6163 6820 2d20 2869  i = k_reach - (i
-00018cb0: 202b 2070 290a 2020 2020 2020 2020 2020   + p).          
-00018cc0: 2020 7061 645f 636f 6e66 6967 2e61 7070    pad_config.app
-00018cd0: 656e 6428 286c 6f2c 2068 692c 2030 2929  end((lo, hi, 0))
-00018ce0: 0a20 2020 2020 2020 2074 203d 2070 7269  .        t = pri
-00018cf0: 6d73 2e70 6164 2874 2c20 302e 302c 2070  ms.pad(t, 0.0, p
-00018d00: 6164 5f63 6f6e 6669 6729 0a0a 2020 2020  ad_config)..    
-00018d10: 2020 2020 5f2c 205f 2c20 2a74 5f73 7061      _, _, *t_spa
-00018d20: 7469 616c 5f64 696d 7320 3d20 742e 7368  tial_dims = t.sh
-00018d30: 6170 650a 0a20 2020 2020 2020 2023 202e  ape..        # .
-00018d40: 2e2e 2074 6865 6e20 646f 2074 6865 2072  .. then do the r
-00018d50: 6573 742e 0a20 2020 2020 2020 2023 2074  est..        # t
-00018d60: 2e73 6861 7065 203d 3d20 2862 6174 6368  .shape == (batch
-00018d70: 2c20 696e 5f63 6861 6e6e 656c 732c 202e  , in_channels, .
-00018d80: 2e2e 290a 2020 2020 2020 2020 2320 5468  ..).        # Th
-00018d90: 6520 7265 7375 6c74 206f 6620 7468 6973  e result of this
-00018da0: 2066 756e 6374 696f 6e20 6861 7320 7368   function has sh
-00018db0: 6170 650a 2020 2020 2020 2020 2320 2869  ape.        # (i
-00018dc0: 6e5f 6368 616e 6e65 6c73 2c20 6261 7463  n_channels, batc
-00018dd0: 6820 2a20 6772 6f75 7073 290a 2020 2020  h * groups).    
-00018de0: 2020 2020 2320 2862 6174 6368 2c20 696e      # (batch, in
-00018df0: 5f63 6861 6e6e 656c 7329 202d 3e20 2869  _channels) -> (i
-00018e00: 6e5f 6368 616e 6e65 6c73 2c20 6261 7463  n_channels, batc
-00018e10: 6829 0a20 2020 2020 2020 2074 203d 2063  h).        t = c
-00018e20: 6f6e 765f 7472 616e 7370 6f73 6528 7429  onv_transpose(t)
-00018e30: 0a20 2020 2020 2020 2023 2053 706c 6974  .        # Split
-00018e40: 2028 696e 5f63 6861 6e6e 656c 732c 2920   (in_channels,) 
-00018e50: 2d3e 2028 6772 6f75 7073 2c20 6769 6e5f  -> (groups, gin_
-00018e60: 6368 616e 6e65 6c73 290a 2020 2020 2020  channels).      
-00018e70: 2020 7420 3d20 742e 7265 7368 6170 6528    t = t.reshape(
-00018e80: 5b67 726f 7570 732c 2067 696e 5f63 6861  [groups, gin_cha
-00018e90: 6e6e 656c 732c 2062 6174 6368 5d20 2b20  nnels, batch] + 
-00018ea0: 745f 7370 6174 6961 6c5f 6469 6d73 290a  t_spatial_dims).
-00018eb0: 2020 2020 2020 2020 2320 5472 616e 7370          # Transp
-00018ec0: 6f73 6520 2867 726f 7570 732c 2067 696e  ose (groups, gin
-00018ed0: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
-00018ee0: 2920 2d3e 2028 6769 6e5f 6368 616e 6e65  ) -> (gin_channe
-00018ef0: 6c73 2c20 6772 6f75 7073 2c20 6261 7463  ls, groups, batc
-00018f00: 6829 0a20 2020 2020 2020 2074 203d 2063  h).        t = c
-00018f10: 6f6e 765f 7472 616e 7370 6f73 6528 7429  onv_transpose(t)
-00018f20: 0a20 2020 2020 2020 2023 2046 6c61 7474  .        # Flatt
-00018f30: 656e 2028 6772 6f75 7073 2c20 6261 7463  en (groups, batc
-00018f40: 6829 202d 3e20 2867 726f 7570 7320 2a20  h) -> (groups * 
-00018f50: 6261 7463 682c 290a 2020 2020 2020 2020  batch,).        
-00018f60: 7420 3d20 742e 7265 7368 6170 6528 5b67  t = t.reshape([g
-00018f70: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
-00018f80: 7570 7320 2a20 6261 7463 685d 202b 2074  ups * batch] + t
-00018f90: 5f73 7061 7469 616c 5f64 696d 7329 0a20  _spatial_dims). 
-00018fa0: 2020 2020 2020 2072 6574 7572 6e20 740a         return t.
-00018fb0: 0a20 2020 2023 2069 6e70 7574 2077 696c  .    # input wil
-00018fc0: 6c20 6861 7665 2073 6861 7065 2028 6769  l have shape (gi
-00018fd0: 6e5f 6368 616e 6e65 6c73 2c20 6772 6f75  n_channels, grou
-00018fe0: 7073 202a 2062 6174 6368 290a 2020 2020  ps * batch).    
-00018ff0: 696e 7075 7420 3d20 7061 645f 7472 616e  input = pad_tran
-00019000: 7370 6f73 655f 616e 645f 7075 7368 5f67  spose_and_push_g
-00019010: 726f 7570 735f 696e 746f 5f62 6174 6368  roups_into_batch
-00019020: 6573 2869 6e70 7574 290a 2020 2020 2320  es(input).    # 
-00019030: 6772 6164 2077 696c 6c20 6861 7665 2073  grad will have s
-00019040: 6861 7065 2028 6f75 745f 6368 616e 6e65  hape (out_channe
-00019050: 6c73 2c20 6261 7463 6829 0a20 2020 2023  ls, batch).    #
-00019060: 204e 6f74 6520 7468 6174 2074 6865 7365   Note that these
-00019070: 2073 6861 7065 7320 6172 6520 636f 6d70   shapes are comp
-00019080: 6174 6962 6c65 2066 6f72 2061 2067 726f  atible for a gro
-00019090: 7570 2063 6f6e 766f 6c75 7469 6f6e 2e0a  up convolution..
-000190a0: 2020 2020 6772 6164 203d 2063 6f6e 765f      grad = conv_
-000190b0: 7472 616e 7370 6f73 6528 6772 6164 290a  transpose(grad).
-000190c0: 0a20 2020 2023 2057 6879 2064 6f20 7765  .    # Why do we
-000190d0: 2066 6c69 7020 7374 7269 6465 2061 6e64   flip stride and
-000190e0: 2064 696c 6174 696f 6e3f 0a20 2020 2023   dilation?.    #
-000190f0: 206b 6572 6e65 6c5b 695d 2061 6e64 206b   kernel[i] and k
-00019100: 6572 6e65 6c5b 6920 2b20 315d 2061 7265  ernel[i + 1] are
-00019110: 2064 696c 6174 696f 6e20 6170 6172 7420   dilation apart 
-00019120: 6672 6f6d 2065 6163 6820 6f74 6865 722c  from each other,
-00019130: 0a20 2020 2023 2073 6f20 6469 6c61 7469  .    # so dilati
-00019140: 6f6e 2062 6563 6f6d 6573 2074 6865 206e  on becomes the n
-00019150: 6577 2073 7472 6964 652e 0a20 2020 2023  ew stride..    #
-00019160: 2041 6c6c 2074 6865 2065 6c65 6d65 6e74   All the element
-00019170: 7320 7468 6174 206b 6572 6e65 6c5b 695d  s that kernel[i]
-00019180: 2074 6f75 6368 6573 2061 7265 2073 7472   touches are str
-00019190: 6964 6520 6177 6179 2066 726f 6d20 6561  ide away from ea
-000191a0: 6368 206f 7468 6572 2c0a 2020 2020 2320  ch other,.    # 
-000191b0: 6865 6e63 6520 7374 7269 6465 2062 6563  hence stride bec
-000191c0: 6f6d 6573 2074 6865 206e 6577 2064 696c  omes the new dil
-000191d0: 6174 696f 6e2e 0a20 2020 2077 6569 6768  ation..    weigh
-000191e0: 745f 6772 6164 203d 2063 6f6e 766f 6c75  t_grad = convolu
-000191f0: 7469 6f6e 280a 2020 2020 2020 2020 696e  tion(.        in
-00019200: 7075 742c 0a20 2020 2020 2020 2067 7261  put,.        gra
-00019210: 642c 0a20 2020 2020 2020 204e 6f6e 652c  d,.        None,
-00019220: 0a20 2020 2020 2020 2064 696c 6174 696f  .        dilatio
-00019230: 6e2c 2020 2320 7365 7420 7374 7269 6465  n,  # set stride
-00019240: 3d64 696c 6174 696f 6e0a 2020 2020 2020  =dilation.      
-00019250: 2020 2830 2c29 2c0a 2020 2020 2020 2020    (0,),.        
-00019260: 7374 7269 6465 2c20 2023 2073 6574 2064  stride,  # set d
-00019270: 696c 6174 696f 6e3d 7374 7269 6465 0a20  ilation=stride. 
-00019280: 2020 2020 2020 2074 7261 6e73 706f 7365         transpose
-00019290: 642c 0a20 2020 2020 2020 206f 7574 7075  d,.        outpu
-000192a0: 745f 7061 6464 696e 672c 0a20 2020 2020  t_padding,.     
-000192b0: 2020 2067 726f 7570 732c 0a20 2020 2029     groups,.    )
-000192c0: 0a0a 2020 2020 2320 5468 6520 7265 7375  ..    # The resu
-000192d0: 6c74 206f 6620 7468 6520 636f 6e76 6f6c  lt of the convol
-000192e0: 7574 696f 6e20 6861 7320 7368 6170 6520  ution has shape 
-000192f0: 2867 696e 5f63 6861 6e6e 656c 732c 206f  (gin_channels, o
-00019300: 7574 5f63 6861 6e6e 656c 7329 2c0a 2020  ut_channels),.  
-00019310: 2020 2320 736f 2074 7261 6e73 706f 7369    # so transposi
-00019320: 7469 6f6e 2069 7320 7265 7175 6972 6564  tion is required
-00019330: 2e0a 2020 2020 7765 6967 6874 5f67 7261  ..    weight_gra
-00019340: 6420 3d20 636f 6e76 5f74 7261 6e73 706f  d = conv_transpo
-00019350: 7365 2877 6569 6768 745f 6772 6164 290a  se(weight_grad).
-00019360: 2020 2020 2320 7d0a 0a20 2020 2072 6574      # }..    ret
-00019370: 7572 6e20 2869 6e70 7574 5f67 7261 642c  urn (input_grad,
-00019380: 2077 6569 6768 745f 6772 6164 2c20 6269   weight_grad, bi
-00019390: 6173 5f67 7261 6429 0a0a 0a40 7265 6769  as_grad)...@regi
-000193a0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-000193b0: 6f72 7761 7264 2822 746f 7263 682e 6c6f  orward("torch.lo
-000193c0: 675f 736f 6674 6d61 7822 290a 6465 6620  g_softmax").def 
-000193d0: 6c6f 675f 736f 6674 6d61 785f 6175 675f  log_softmax_aug_
-000193e0: 6677 6428 696e 7075 743a 2054 656e 736f  fwd(input: Tenso
-000193f0: 7250 726f 7879 2c20 6469 6d3a 2069 6e74  rProxy, dim: int
-00019400: 2c20 2a2c 2064 7479 7065 3d4e 6f6e 6529  , *, dtype=None)
-00019410: 202d 3e20 564a 5044 7561 6c3a 0a20 2020   -> VJPDual:.   
-00019420: 2066 726f 6d20 7468 756e 6465 722e 746f   from thunder.to
-00019430: 7263 6820 696d 706f 7274 206c 6f67 5f73  rch import log_s
-00019440: 6f66 746d 6178 0a0a 2020 2020 7072 696d  oftmax..    prim
-00019450: 616c 203d 206c 6f67 5f73 6f66 746d 6178  al = log_softmax
-00019460: 2869 6e70 7574 2c20 6469 6d3d 6469 6d2c  (input, dim=dim,
-00019470: 2064 7479 7065 3d64 7479 7065 290a 2020   dtype=dtype).  
-00019480: 2020 7265 7369 6475 616c 7320 3d20 2870    residuals = (p
-00019490: 7269 6d61 6c2c 2064 696d 2c20 696e 7075  rimal, dim, inpu
-000194a0: 742e 6474 7970 6529 0a20 2020 2072 6574  t.dtype).    ret
-000194b0: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
-000194c0: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
-000194d0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
-000194e0: 6172 6428 2274 6f72 6368 2e6c 6f67 5f73  ard("torch.log_s
-000194f0: 6f66 746d 6178 2229 0a64 6566 206c 6f67  oftmax").def log
-00019500: 5f73 6f66 746d 6178 5f62 6163 6b77 6172  _softmax_backwar
-00019510: 6428 7072 696d 616c 2c20 6469 6d2c 2064  d(primal, dim, d
-00019520: 7479 7065 2c20 6729 3a0a 2020 2020 6672  type, g):.    fr
-00019530: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
-00019540: 2069 6d70 6f72 7420 6c6f 675f 736f 6674   import log_soft
-00019550: 6d61 785f 6261 636b 7761 7264 0a0a 2020  max_backward..  
-00019560: 2020 7265 7475 726e 206c 6f67 5f73 6f66    return log_sof
-00019570: 746d 6178 5f62 6163 6b77 6172 6428 672c  tmax_backward(g,
-00019580: 2070 7269 6d61 6c2c 2064 696d 2c20 6474   primal, dim, dt
-00019590: 7970 6529 0a0a 0a40 7265 6769 7374 6572  ype)...@register
-000195a0: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-000195b0: 7264 2822 746f 7263 682e 6e6e 2e66 756e  rd("torch.nn.fun
-000195c0: 6374 696f 6e61 6c2e 6e6c 6c5f 6c6f 7373  ctional.nll_loss
-000195d0: 2229 0a64 6566 206e 6c6c 5f6c 6f73 735f  ").def nll_loss_
-000195e0: 6175 675f 6677 6428 0a20 2020 2069 6e70  aug_fwd(.    inp
-000195f0: 7574 3a20 5072 6f78 792c 0a20 2020 2074  ut: Proxy,.    t
-00019600: 6172 6765 743a 2050 726f 7879 2c0a 2020  arget: Proxy,.  
-00019610: 2020 7765 6967 6874 3a20 4e6f 6e65 207c    weight: None |
-00019620: 2050 726f 7879 2c0a 2020 2020 6967 6e6f   Proxy,.    igno
-00019630: 7265 5f69 6e64 6578 3a20 696e 742c 0a20  re_index: int,. 
-00019640: 2020 2072 6564 7563 7469 6f6e 3a20 7374     reduction: st
-00019650: 722c 0a29 202d 3e20 564a 5044 7561 6c3a  r,.) -> VJPDual:
-00019660: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00019670: 722e 746f 7263 6820 696d 706f 7274 205f  r.torch import _
-00019680: 6e6c 6c5f 6c6f 7373 5f68 656c 7065 720a  nll_loss_helper.
-00019690: 0a20 2020 2070 7269 6d61 6c2c 2074 6f74  .    primal, tot
-000196a0: 616c 5f77 6569 6768 7420 3d20 5f6e 6c6c  al_weight = _nll
-000196b0: 5f6c 6f73 735f 6865 6c70 6572 280a 2020  _loss_helper(.  
-000196c0: 2020 2020 2020 696e 7075 742c 0a20 2020        input,.   
-000196d0: 2020 2020 2074 6172 6765 742c 0a20 2020       target,.   
-000196e0: 2020 2020 2077 6569 6768 742c 0a20 2020       weight,.   
-000196f0: 2020 2020 2069 676e 6f72 655f 696e 6465       ignore_inde
-00019700: 782c 0a20 2020 2020 2020 2072 6564 7563  x,.        reduc
-00019710: 7469 6f6e 2c0a 2020 2020 290a 2020 2020  tion,.    ).    
-00019720: 7265 7369 6475 616c 7320 3d20 2869 6e70  residuals = (inp
-00019730: 7574 2c20 7461 7267 6574 2c20 7765 6967  ut, target, weig
-00019740: 6874 2c20 7265 6475 6374 696f 6e2c 2069  ht, reduction, i
-00019750: 676e 6f72 655f 696e 6465 782c 2074 6f74  gnore_index, tot
-00019760: 616c 5f77 6569 6768 7429 0a20 2020 2072  al_weight).    r
-00019770: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
-00019780: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
-00019790: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
-000197a0: 6b77 6172 6428 2274 6f72 6368 2e6e 6e2e  kward("torch.nn.
-000197b0: 6675 6e63 7469 6f6e 616c 2e6e 6c6c 5f6c  functional.nll_l
-000197c0: 6f73 7322 290a 6465 6620 6e6c 6c5f 6c6f  oss").def nll_lo
-000197d0: 7373 5f62 6163 6b77 6172 6428 696e 7075  ss_backward(inpu
-000197e0: 742c 2074 6172 6765 742c 2077 6569 6768  t, target, weigh
-000197f0: 742c 2072 6564 7563 7469 6f6e 2c20 6967  t, reduction, ig
-00019800: 6e6f 7265 5f69 6e64 6578 2c20 746f 7461  nore_index, tota
-00019810: 6c5f 7765 6967 6874 2c20 6729 3a0a 2020  l_weight, g):.  
-00019820: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00019830: 6f72 6368 2069 6d70 6f72 7420 6e6c 6c5f  orch import nll_
-00019840: 6c6f 7373 5f62 6163 6b77 6172 640a 0a20  loss_backward.. 
-00019850: 2020 2067 696e 7075 7420 3d20 6e6c 6c5f     ginput = nll_
-00019860: 6c6f 7373 5f62 6163 6b77 6172 6428 672c  loss_backward(g,
-00019870: 2069 6e70 7574 2c20 7461 7267 6574 2c20   input, target, 
-00019880: 7765 6967 6874 2c20 7265 6475 6374 696f  weight, reductio
-00019890: 6e2c 2069 676e 6f72 655f 696e 6465 782c  n, ignore_index,
-000198a0: 2074 6f74 616c 5f77 6569 6768 7429 0a20   total_weight). 
-000198b0: 2020 2072 6574 7572 6e20 6769 6e70 7574     return ginput
-000198c0: 2c20 2a28 284e 6f6e 652c 2920 2a20 3429  , *((None,) * 4)
-000198d0: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-000198e0: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
-000198f0: 746f 7263 682e 7370 6c69 7422 290a 6465  torch.split").de
-00019900: 6620 7370 6c69 745f 6175 675f 6677 6428  f split_aug_fwd(
-00019910: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-00019920: 7370 6c69 745f 7369 7a65 5f6f 725f 7365  split_size_or_se
-00019930: 6374 696f 6e73 3a20 696e 7420 7c20 5365  ctions: int | Se
-00019940: 7175 656e 6365 5b69 6e74 5d2c 2064 696d  quence[int], dim
-00019950: 3a20 696e 7420 3d20 3029 202d 3e20 564a  : int = 0) -> VJ
-00019960: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
-00019970: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00019980: 706f 7274 2073 706c 6974 0a0a 2020 2020  port split..    
-00019990: 7072 696d 616c 203d 2073 706c 6974 2861  primal = split(a
-000199a0: 2c20 7370 6c69 745f 7369 7a65 5f6f 725f  , split_size_or_
-000199b0: 7365 6374 696f 6e73 2c20 6469 6d29 0a20  sections, dim). 
-000199c0: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-000199d0: 6469 6d2c 290a 2020 2020 7265 7475 726e  dim,).    return
-000199e0: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-000199f0: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
-00019a00: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00019a10: 2822 746f 7263 682e 7370 6c69 7422 290a  ("torch.split").
-00019a20: 6465 6620 7370 6c69 745f 6261 636b 7761  def split_backwa
-00019a30: 7264 2864 696d 2c20 2a67 7261 6473 293a  rd(dim, *grads):
-00019a40: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00019a50: 722e 746f 7263 6820 696d 706f 7274 2063  r.torch import c
-00019a60: 6174 0a0a 2020 2020 7265 7475 726e 2063  at..    return c
-00019a70: 6174 2867 7261 6473 2c20 6469 6d29 0a0a  at(grads, dim)..
-00019a80: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00019a90: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
-00019aa0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-00019ab0: 6c2e 656d 6265 6464 696e 6722 290a 6465  l.embedding").de
-00019ac0: 6620 656d 6265 6464 696e 675f 6175 675f  f embedding_aug_
-00019ad0: 6677 6428 0a20 2020 2061 3a20 5072 6f78  fwd(.    a: Prox
-00019ae0: 792c 0a20 2020 2077 6569 6768 743a 2050  y,.    weight: P
-00019af0: 726f 7879 2c0a 2020 2020 7061 6464 696e  roxy,.    paddin
-00019b00: 675f 6964 783a 2069 6e74 207c 204e 6f6e  g_idx: int | Non
-00019b10: 652c 0a20 2020 206d 6178 5f6e 6f72 6d3a  e,.    max_norm:
-00019b20: 2066 6c6f 6174 207c 204e 6f6e 652c 0a20   float | None,. 
-00019b30: 2020 206e 6f72 6d5f 7479 7065 3a20 666c     norm_type: fl
-00019b40: 6f61 742c 0a20 2020 2073 6361 6c65 5f67  oat,.    scale_g
-00019b50: 7261 645f 6279 5f66 7265 713a 2062 6f6f  rad_by_freq: boo
-00019b60: 6c2c 0a20 2020 2073 7061 7273 653a 2062  l,.    sparse: b
-00019b70: 6f6f 6c2c 0a29 202d 3e20 564a 5044 7561  ool,.) -> VJPDua
-00019b80: 6c3a 0a20 2020 2066 726f 6d20 7468 756e  l:.    from thun
-00019b90: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
-00019ba0: 2065 6d62 6564 6469 6e67 0a0a 2020 2020   embedding..    
-00019bb0: 7072 696d 616c 203d 2065 6d62 6564 6469  primal = embeddi
-00019bc0: 6e67 280a 2020 2020 2020 2020 612c 0a20  ng(.        a,. 
-00019bd0: 2020 2020 2020 2077 6569 6768 742c 0a20         weight,. 
-00019be0: 2020 2020 2020 2070 6164 6469 6e67 5f69         padding_i
-00019bf0: 6478 3d70 6164 6469 6e67 5f69 6478 2c0a  dx=padding_idx,.
-00019c00: 2020 2020 2020 2020 6d61 785f 6e6f 726d          max_norm
-00019c10: 3d6d 6178 5f6e 6f72 6d2c 0a20 2020 2020  =max_norm,.     
-00019c20: 2020 206e 6f72 6d5f 7479 7065 3d6e 6f72     norm_type=nor
-00019c30: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
-00019c40: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-00019c50: 6571 3d73 6361 6c65 5f67 7261 645f 6279  eq=scale_grad_by
-00019c60: 5f66 7265 712c 0a20 2020 2020 2020 2073  _freq,.        s
-00019c70: 7061 7273 653d 7370 6172 7365 2c0a 2020  parse=sparse,.  
-00019c80: 2020 290a 2020 2020 7265 7369 6475 616c    ).    residual
-00019c90: 7320 3d20 2861 2c20 7765 6967 6874 2e73  s = (a, weight.s
-00019ca0: 6861 7065 5b30 5d2c 2070 6164 6469 6e67  hape[0], padding
-00019cb0: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
-00019cc0: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
-00019cd0: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
-00019ce0: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
-00019cf0: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
-00019d00: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
-00019d10: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-00019d20: 6c2e 656d 6265 6464 696e 6722 290a 6465  l.embedding").de
-00019d30: 6620 656d 6265 6464 696e 675f 6261 636b  f embedding_back
-00019d40: 7761 7264 2861 2c20 6e75 6d5f 7765 6967  ward(a, num_weig
-00019d50: 6874 732c 2070 6164 6469 6e67 5f69 6478  hts, padding_idx
-00019d60: 2c20 7363 616c 655f 6772 6164 5f62 795f  , scale_grad_by_
-00019d70: 6672 6571 2c20 7370 6172 7365 2c20 6729  freq, sparse, g)
-00019d80: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-00019d90: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
-00019da0: 656d 6265 6464 696e 675f 6261 636b 7761  embedding_backwa
-00019db0: 7264 0a0a 2020 2020 7061 6464 696e 675f  rd..    padding_
-00019dc0: 6964 7820 3d20 2d31 2069 6620 7061 6464  idx = -1 if padd
-00019dd0: 696e 675f 6964 7820 6973 204e 6f6e 6520  ing_idx is None 
-00019de0: 656c 7365 2070 6164 6469 6e67 5f69 6478  else padding_idx
-00019df0: 0a20 2020 2067 7765 6967 6874 203d 2065  .    gweight = e
-00019e00: 6d62 6564 6469 6e67 5f62 6163 6b77 6172  mbedding_backwar
-00019e10: 6428 672c 2061 2c20 6e75 6d5f 7765 6967  d(g, a, num_weig
-00019e20: 6874 732c 2070 6164 6469 6e67 5f69 6478  hts, padding_idx
-00019e30: 2c20 7363 616c 655f 6772 6164 5f62 795f  , scale_grad_by_
-00019e40: 6672 6571 2c20 7370 6172 7365 290a 2020  freq, sparse).  
-00019e50: 2020 7265 7475 726e 2067 7765 6967 6874    return gweight
-00019e60: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-00019e70: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
-00019e80: 746f 7263 682e 6375 6d73 756d 2229 0a64  torch.cumsum").d
-00019e90: 6566 2063 756d 7375 6d5f 6175 675f 6677  ef cumsum_aug_fw
-00019ea0: 6428 613a 2050 726f 7879 2c20 6469 6d3a  d(a: Proxy, dim:
-00019eb0: 2069 6e74 2c20 2a2c 2064 7479 7065 3a20   int, *, dtype: 
-00019ec0: 4e6f 6e65 207c 2064 7479 7065 732e 6474  None | dtypes.dt
-00019ed0: 7970 6520 3d20 4e6f 6e65 2920 2d3e 2056  ype = None) -> V
-00019ee0: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
-00019ef0: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
-00019f00: 6d70 6f72 7420 6375 6d73 756d 0a0a 2020  mport cumsum..  
-00019f10: 2020 7072 696d 616c 203d 2063 756d 7375    primal = cumsu
-00019f20: 6d28 612c 2064 696d 2c20 6474 7970 653d  m(a, dim, dtype=
-00019f30: 6474 7970 6529 0a20 2020 2072 6573 6964  dtype).    resid
-00019f40: 7561 6c73 203d 2028 0a20 2020 2020 2020  uals = (.       
-00019f50: 2061 2e64 7479 7065 2c0a 2020 2020 2020   a.dtype,.      
-00019f60: 2020 6469 6d2c 0a20 2020 2029 0a20 2020    dim,.    ).   
-00019f70: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00019f80: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00019f90: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-00019fa0: 6163 6b77 6172 6428 2274 6f72 6368 2e63  ackward("torch.c
-00019fb0: 756d 7375 6d22 290a 6465 6620 6375 6d73  umsum").def cums
-00019fc0: 756d 5f62 6163 6b77 6172 6428 615f 6474  um_backward(a_dt
-00019fd0: 7970 652c 2064 696d 2c20 6729 3a0a 2020  ype, dim, g):.  
-00019fe0: 2020 6720 3d20 672e 746f 2861 5f64 7479    g = g.to(a_dty
-00019ff0: 7065 290a 2020 2020 6966 2067 2e6e 756d  pe).    if g.num
-0001a000: 656c 2829 203c 3d20 3120 6f72 2067 2e73  el() <= 1 or g.s
-0001a010: 6861 7065 5b64 696d 5d20 3d3d 2031 3a0a  hape[dim] == 1:.
-0001a020: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-0001a030: 0a20 2020 2072 6574 7572 6e20 672e 666c  .    return g.fl
-0001a040: 6970 2864 696d 292e 6375 6d73 756d 2864  ip(dim).cumsum(d
-0001a050: 696d 292e 666c 6970 2864 696d 290a 0a0a  im).flip(dim)...
-0001a060: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-0001a070: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
-0001a080: 6368 2e73 6f66 746d 6178 2229 0a64 6566  ch.softmax").def
-0001a090: 2073 6f66 746d 6178 5f61 7567 5f66 7764   softmax_aug_fwd
-0001a0a0: 2861 3a20 5072 6f78 792c 2064 696d 3a20  (a: Proxy, dim: 
-0001a0b0: 696e 742c 2064 7479 7065 3a20 6474 7970  int, dtype: dtyp
-0001a0c0: 6573 2e64 7479 7065 207c 204e 6f6e 6520  es.dtype | None 
-0001a0d0: 3d20 4e6f 6e65 2920 2d3e 2056 4a50 4475  = None) -> VJPDu
-0001a0e0: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
-0001a0f0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-0001a100: 7420 736f 6674 6d61 780a 0a20 2020 2070  t softmax..    p
-0001a110: 7269 6d61 6c20 3d20 736f 6674 6d61 7828  rimal = softmax(
-0001a120: 612c 2064 696d 2c20 6474 7970 653d 6474  a, dim, dtype=dt
-0001a130: 7970 6529 0a20 2020 2072 6573 6964 7561  ype).    residua
-0001a140: 6c73 203d 2028 7072 696d 616c 2c20 6469  ls = (primal, di
-0001a150: 6d29 0a20 2020 2072 6574 7572 6e20 564a  m).    return VJ
-0001a160: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
-0001a170: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
-0001a180: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
-0001a190: 6f72 6368 2e73 6f66 746d 6178 2229 0a64  orch.softmax").d
-0001a1a0: 6566 2073 6f66 746d 6178 5f62 6163 6b77  ef softmax_backw
-0001a1b0: 6172 6428 7072 696d 616c 2c20 6469 6d2c  ard(primal, dim,
-0001a1c0: 2067 293a 0a20 2020 2072 6574 7572 6e20   g):.    return 
-0001a1d0: 7072 696d 616c 202a 2028 6720 2d20 2870  primal * (g - (p
-0001a1e0: 7269 6d61 6c20 2a20 6729 2e73 756d 2864  rimal * g).sum(d
-0001a1f0: 696d 2c20 6b65 6570 6469 6d3d 5472 7565  im, keepdim=True
-0001a200: 2929 0a0a 0a64 6566 2069 7465 725f 626f  ))...def iter_bo
-0001a210: 756e 645f 7379 6d62 6f6c 7328 626f 756e  und_symbols(boun
-0001a220: 645f 7379 6d62 6f6c 7329 3a0a 2020 2020  d_symbols):.    
-0001a230: 2222 2249 7465 7261 7465 206f 7665 7220  """Iterate over 
-0001a240: 626f 756e 6420 7379 6d62 6f6c 732c 2073  bound symbols, s
-0001a250: 6b69 7070 696e 6720 7379 6d62 6f6c 7320  kipping symbols 
-0001a260: 7468 6174 2061 7265 206e 6f74 2073 7570  that are not sup
-0001a270: 706f 7274 6564 2062 790a 2020 2020 7468  ported by.    th
-0001a280: 6520 7472 616e 7366 6f72 6d73 2069 6e66  e transforms inf
-0001a290: 7261 7374 7275 6374 7572 652e 0a0a 2020  rastructure...  
-0001a2a0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001a2b0: 626f 756e 645f 7379 6d62 6f6c 7320 284c  bound_symbols (L
-0001a2c0: 6973 745b 426f 756e 6453 796d 626f 6c5d  ist[BoundSymbol]
-0001a2d0: 293a 204c 6973 7420 6f66 2062 6f75 6e64  ): List of bound
-0001a2e0: 2073 796d 626f 6c73 0a0a 2020 2020 5969   symbols..    Yi
-0001a2f0: 656c 6473 3a0a 2020 2020 2020 2020 426f  elds:.        Bo
-0001a300: 756e 6453 796d 626f 6c3a 2042 6f75 6e64  undSymbol: Bound
-0001a310: 2073 796d 626f 6c73 2074 6861 7420 6172   symbols that ar
-0001a320: 6520 7375 7070 6f72 7465 6420 6279 2074  e supported by t
-0001a330: 6865 2074 7261 6e73 666f 726d 730a 2020  he transforms.  
-0001a340: 2020 2020 2020 696e 6672 6173 7472 7563        infrastruc
-0001a350: 7475 7265 0a20 2020 2022 2222 0a20 2020  ture.    """.   
-0001a360: 2066 6f72 2073 796d 626f 6c20 696e 2062   for symbol in b
-0001a370: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
-0001a380: 2020 2020 2020 6966 2073 796d 626f 6c2e        if symbol.
-0001a390: 7379 6d2e 6964 2069 6e20 7472 616e 7366  sym.id in transf
-0001a3a0: 6f72 6d5f 736b 6970 5f6c 6973 743a 0a20  orm_skip_list:. 
-0001a3b0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0001a3c0: 6e75 650a 2020 2020 2020 2020 656c 6966  nue.        elif
-0001a3d0: 2073 796d 626f 6c2e 6f75 7470 7574 2069   symbol.output i
-0001a3e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001a3f0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-0001a400: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001a410: 2020 2020 2020 2079 6965 6c64 2073 796d         yield sym
-0001a420: 626f 6c0a 0a0a 6465 6620 6465 636f 6e73  bol...def decons
-0001a430: 7472 7563 745f 666f 7277 6172 645f 656e  truct_forward_en
-0001a440: 765f 666f 725f 6261 636b 7761 7264 2874  v_for_backward(t
-0001a450: 7261 6365 2c20 656e 7629 3a0a 2020 2020  race, env):.    
-0001a460: 2320 4e6f 7465 205b 5361 7669 6e67 2074  # Note [Saving t
-0001a470: 6865 2066 6f72 7761 7264 2065 6e76 6972  he forward envir
-0001a480: 6f6e 6d65 6e74 2069 6e20 7468 6520 6261  onment in the ba
-0001a490: 636b 7761 7264 2072 756c 655d 0a20 2020  ckward rule].   
-0001a4a0: 2023 2057 6520 6361 6e6e 6f74 2073 6176   # We cannot sav
-0001a4b0: 6520 7468 6520 7472 6163 6520 6f62 6a65  e the trace obje
-0001a4c0: 6374 2069 6e20 7468 6520 7265 7369 6475  ct in the residu
-0001a4d0: 616c 7320 6265 6361 7573 6520 6578 6563  als because exec
-0001a4e0: 7574 6f72 7320 6d61 7920 6e6f 740a 2020  utors may not.  
-0001a4f0: 2020 2320 6265 2061 626c 6520 746f 2072    # be able to r
-0001a500: 6574 7572 6e20 6974 2066 6f72 2074 6865  eturn it for the
-0001a510: 2073 706c 6974 7465 6420 666f 7277 6172   splitted forwar
-0001a520: 642f 6261 636b 7761 7264 2070 6173 7365  d/backward passe
-0001a530: 732e 2049 6e73 7465 6164 2c20 7765 0a20  s. Instead, we. 
-0001a540: 2020 2023 2073 6176 6520 6172 6773 2061     # save args a
-0001a550: 6e64 206b 7761 7267 7320 6f66 2074 6865  nd kwargs of the
-0001a560: 206f 7269 6769 6e61 6c20 6675 6e63 7469   original functi
-0001a570: 6f6e 2063 616c 6c20 616e 6420 7265 636f  on call and reco
-0001a580: 6e73 7472 7563 7420 7468 650a 2020 2020  nstruct the.    
-0001a590: 2320 7472 6163 6520 6f62 6a65 6374 2061  # trace object a
-0001a5a0: 6e64 2069 7473 2065 6e76 6972 6f6e 6d65  nd its environme
-0001a5b0: 6e74 2064 6963 7420 696e 2074 6865 2062  nt dict in the b
-0001a5c0: 6163 6b77 6172 6420 7275 6c65 2e20 4865  ackward rule. He
-0001a5d0: 7265 2077 6520 7265 6c79 0a20 2020 2023  re we rely.    #
-0001a5e0: 206f 6e20 7468 6520 6661 6374 2074 6861   on the fact tha
-0001a5f0: 7420 7468 6520 6f72 6465 7220 6f66 2074  t the order of t
-0001a600: 6865 2073 796d 626f 6c73 2069 6e20 7468  he symbols in th
-0001a610: 6520 7472 6163 6520 6973 2064 6574 6572  e trace is deter
-0001a620: 6d69 6e69 7374 6963 0a20 2020 2023 2061  ministic.    # a
-0001a630: 6e64 2061 6c77 6179 7320 7468 6520 7361  nd always the sa
-0001a640: 6d65 2066 6f72 2074 6865 2073 616d 6520  me for the same 
-0001a650: 6675 6e63 7469 6f6e 2063 616c 6c20 616e  function call an
-0001a660: 6420 7468 6520 7361 6d65 2073 6574 206f  d the same set o
-0001a670: 660a 2020 2020 2320 6172 6775 6d65 6e74  f.    # argument
-0001a680: 732e 2053 6565 2074 6573 745f 6772 6164  s. See test_grad
-0001a690: 2e70 793a 7465 7374 5f74 6f72 6368 5f61  .py:test_torch_a
-0001a6a0: 7574 6f67 7261 645f 6675 6e63 7469 6f6e  utograd_function
-0001a6b0: 2066 6f72 2061 6e20 6578 616d 706c 650a   for an example.
-0001a6c0: 2020 2020 2320 7768 6572 6520 7468 6973      # where this
-0001a6d0: 2069 7320 7465 7374 6564 2e0a 2020 2020   is tested..    
-0001a6e0: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0001a6f0: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
-0001a700: 6c73 2874 7261 6365 2e62 6f75 6e64 5f73  ls(trace.bound_s
-0001a710: 796d 626f 6c73 290a 2020 2020 7361 7665  ymbols).    save
-0001a720: 645f 666f 725f 6261 636b 7761 7264 203d  d_for_backward =
-0001a730: 2074 7570 6c65 2865 6e76 5b73 6571 7565   tuple(env[seque
-0001a740: 6e63 6966 7928 7379 6d62 6f6c 2e6f 7574  ncify(symbol.out
-0001a750: 7075 7429 5b30 5d2e 6e61 6d65 5d2e 7265  put)[0].name].re
-0001a760: 7369 6475 616c 7320 666f 7220 7379 6d62  siduals for symb
-0001a770: 6f6c 2069 6e20 626f 756e 645f 7379 6d62  ol in bound_symb
-0001a780: 6f6c 7329 0a20 2020 2072 6574 7572 6e20  ols).    return 
-0001a790: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-0001a7a0: 7264 0a0a 0a64 6566 2072 6563 6f6e 7374  rd...def reconst
-0001a7b0: 7275 6374 5f66 6f72 7761 7264 5f65 6e76  ruct_forward_env
-0001a7c0: 5f66 6f72 5f62 6163 6b77 6172 6428 7472  _for_backward(tr
-0001a7d0: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
-0001a7e0: 6163 6b77 6172 6429 3a0a 2020 2020 626f  ackward):.    bo
-0001a7f0: 756e 645f 7379 6d62 6f6c 7320 3d20 6974  und_symbols = it
-0001a800: 6572 5f62 6f75 6e64 5f73 796d 626f 6c73  er_bound_symbols
-0001a810: 2874 7261 6365 2e62 6f75 6e64 5f73 796d  (trace.bound_sym
-0001a820: 626f 6c73 290a 0a20 2020 2072 6563 6f6e  bols)..    recon
-0001a830: 7374 7275 6374 6564 5f65 6e76 203d 207b  structed_env = {
-0001a840: 7d0a 0a20 2020 2066 6f72 2069 6478 2c20  }..    for idx, 
-0001a850: 7379 6d20 696e 2065 6e75 6d65 7261 7465  sym in enumerate
-0001a860: 2862 6f75 6e64 5f73 796d 626f 6c73 293a  (bound_symbols):
-0001a870: 0a20 2020 2020 2020 206b 203d 2073 6571  .        k = seq
-0001a880: 7565 6e63 6966 7928 7379 6d2e 6f75 7470  uencify(sym.outp
-0001a890: 7574 295b 305d 2e6e 616d 650a 2020 2020  ut)[0].name.    
-0001a8a0: 2020 2020 7620 3d20 564a 5044 7561 6c28      v = VJPDual(
-0001a8b0: 4e6f 6e65 2c20 7361 7665 645f 666f 725f  None, saved_for_
-0001a8c0: 6261 636b 7761 7264 5b69 6478 5d29 0a20  backward[idx]). 
-0001a8d0: 2020 2020 2020 2072 6563 6f6e 7374 7275         reconstru
-0001a8e0: 6374 6564 5f65 6e76 5b6b 5d20 3d20 760a  cted_env[k] = v.
-0001a8f0: 0a20 2020 2072 6574 7572 6e20 7265 636f  .    return reco
-0001a900: 6e73 7472 7563 7465 645f 656e 760a 0a0a  nstructed_env...
-0001a910: 6465 6620 6465 636f 6d70 6f73 6564 5f66  def decomposed_f
-0001a920: 6e5f 6175 675f 6677 645f 7275 6c65 282a  n_aug_fwd_rule(*
-0001a930: 6172 6773 2c20 6465 636f 6d70 6f73 6564  args, decomposed
-0001a940: 5f66 6e2c 202a 2a6b 7761 7267 7329 3a0a  _fn, **kwargs):.
-0001a950: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
-0001a960: 2066 6f72 7761 7264 2072 756c 6520 666f   forward rule fo
-0001a970: 7220 636f 6d70 6f73 6974 6520 6675 6e63  r composite func
-0001a980: 7469 6f6e 7320 696d 706c 656d 656e 7465  tions implemente
-0001a990: 6420 696e 2074 6572 6d73 206f 6620 6f74  d in terms of ot
-0001a9a0: 6865 7220 6675 6e63 7469 6f6e 7320 7468  her functions th
-0001a9b0: 6174 2061 7265 0a20 2020 2073 7570 706f  at are.    suppo
-0001a9c0: 7365 6420 746f 2062 6520 7375 7070 6f72  sed to be suppor
-0001a9d0: 7465 6420 6279 2074 6865 2056 4a50 2069  ted by the VJP i
-0001a9e0: 6e66 7261 7374 7275 6374 7572 652e 0a0a  nfrastructure...
-0001a9f0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0001aa00: 2020 6465 636f 6d70 6f73 6564 5f66 6e20    decomposed_fn 
-0001aa10: 2843 616c 6c61 626c 6529 3a20 6465 636f  (Callable): deco
-0001aa20: 6d70 6f73 6564 2076 6572 7369 6f6e 206f  mposed version o
-0001aa30: 6620 7468 6520 6675 6e63 7469 6f6e 0a0a  f the function..
-0001aa40: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001aa50: 2020 2020 2043 616c 6c61 626c 653a 2041       Callable: A
-0001aa60: 7567 6d65 6e74 6564 2066 6f72 7761 7264  ugmented forward
-0001aa70: 2072 756c 6520 666f 7220 7468 6520 636f   rule for the co
-0001aa80: 6d70 6f73 6974 6520 6675 6e63 7469 6f6e  mposite function
-0001aa90: 0a20 2020 2022 2222 0a20 2020 2074 7261  .    """.    tra
-0001aaa0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-0001aab0: 7261 6365 2829 2864 6563 6f6d 706f 7365  race()(decompose
-0001aac0: 645f 666e 2c20 2a61 7267 732c 202a 2a6b  d_fn, *args, **k
-0001aad0: 7761 7267 7329 0a20 2020 2074 7261 6365  wargs).    trace
-0001aae0: 203d 2075 6e77 7261 705f 6f6e 655f 6c65   = unwrap_one_le
-0001aaf0: 7665 6c5f 6f66 5f73 7562 7379 6d62 6f6c  vel_of_subsymbol
-0001ab00: 7328 7472 6163 6529 0a20 2020 2023 2054  s(trace).    # T
-0001ab10: 6865 7265 206d 6179 2062 6520 6120 6465  here may be a de
-0001ab20: 6164 206e 6f64 6520 6c69 6b65 2022 5f20  ad node like "_ 
-0001ab30: 3d20 7072 696d 732e 636f 6e76 6572 745f  = prims.convert_
-0001ab40: 656c 656d 656e 745f 7479 7065 2830 2c20  element_type(0, 
-0001ab50: 666c 6f61 7429 220a 2020 2020 2320 696e  float)".    # in
-0001ab60: 2074 6865 2074 7261 6365 2e20 5765 206e   the trace. We n
-0001ab70: 6565 6420 746f 2072 656d 6f76 6520 6974  eed to remove it
-0001ab80: 2062 6566 6f72 6520 7765 2063 616e 2075   before we can u
-0001ab90: 7365 2074 6865 2074 7261 6365 2066 6f72  se the trace for
-0001aba0: 0a20 2020 2023 2061 7567 6d65 6e74 6564  .    # augmented
-0001abb0: 5f66 6f72 7761 7264 5f70 6173 732e 0a20  _forward_pass.. 
-0001abc0: 2020 2074 7261 6365 203d 2064 6365 2874     trace = dce(t
-0001abd0: 7261 6365 290a 2020 2020 7265 7375 6c74  race).    result
-0001abe0: 2c20 656e 7620 3d20 6175 676d 656e 7465  , env = augmente
-0001abf0: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
-0001ac00: 6172 6773 2c20 7472 6163 653d 7472 6163  args, trace=trac
-0001ac10: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-0001ac20: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001ac30: 6172 6420 3d20 6465 636f 6e73 7472 7563  ard = deconstruc
-0001ac40: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
-0001ac50: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
-0001ac60: 2c20 656e 7629 0a20 2020 2023 2053 7461  , env).    # Sta
-0001ac70: 7469 6320 6361 6368 696e 6720 646f 6573  tic caching does
-0001ac80: 206e 6f74 2077 6974 6820 7769 7468 206b   not with with k
-0001ac90: 7761 7267 7320 6469 6374 732c 2073 6f20  wargs dicts, so 
-0001aca0: 7765 2772 6520 636f 6e76 6572 7469 6e67  we're converting
-0001acb0: 2074 6865 6d0a 2020 2020 2320 746f 204e   them.    # to N
-0001acc0: 6f6e 6520 666f 7220 6e6f 7720 7768 656e  one for now when
-0001acd0: 2070 6f73 7369 626c 652e 0a20 2020 206b   possible..    k
-0001ace0: 7761 7267 7320 3d20 4e6f 6e65 2069 6620  wargs = None if 
-0001acf0: 6e6f 7420 6b77 6172 6773 2065 6c73 6520  not kwargs else 
-0001ad00: 6b77 6172 6773 0a20 2020 2072 6573 6964  kwargs.    resid
-0001ad10: 7561 6c73 203d 2028 6172 6773 2c20 6b77  uals = (args, kw
-0001ad20: 6172 6773 2c20 7361 7665 645f 666f 725f  args, saved_for_
-0001ad30: 6261 636b 7761 7264 290a 2020 2020 7265  backward).    re
-0001ad40: 7475 726e 2056 4a50 4475 616c 2872 6573  turn VJPDual(res
-0001ad50: 756c 742c 2072 6573 6964 7561 6c73 290a  ult, residuals).
-0001ad60: 0a0a 6465 6620 6465 636f 6d70 6f73 6564  ..def decomposed
-0001ad70: 5f66 6e5f 6261 636b 7761 7264 5f72 756c  _fn_backward_rul
-0001ad80: 6528 6465 636f 6d70 6f73 6564 5f66 6e2c  e(decomposed_fn,
-0001ad90: 2061 7267 732c 206b 7761 7267 732c 2073   args, kwargs, s
-0001ada0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001adb0: 642c 202a 6772 6164 7329 3a0a 2020 2020  d, *grads):.    
-0001adc0: 6b77 6172 6773 203d 207b 7d20 6966 206b  kwargs = {} if k
-0001add0: 7761 7267 7320 6973 204e 6f6e 6520 656c  wargs is None el
-0001ade0: 7365 206b 7761 7267 730a 2020 2020 7472  se kwargs.    tr
-0001adf0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-0001ae00: 7472 6163 6528 2928 6465 636f 6d70 6f73  trace()(decompos
-0001ae10: 6564 5f66 6e2c 202a 6172 6773 2c20 2a2a  ed_fn, *args, **
-0001ae20: 6b77 6172 6773 290a 2020 2020 7472 6163  kwargs).    trac
-0001ae30: 6520 3d20 756e 7772 6170 5f6f 6e65 5f6c  e = unwrap_one_l
-0001ae40: 6576 656c 5f6f 665f 7375 6273 796d 626f  evel_of_subsymbo
-0001ae50: 6c73 2874 7261 6365 290a 2020 2020 7472  ls(trace).    tr
-0001ae60: 6163 6520 3d20 6463 6528 7472 6163 6529  ace = dce(trace)
-0001ae70: 0a20 2020 2023 2062 6f75 6e64 5f73 796d  .    # bound_sym
-0001ae80: 626f 6c73 203d 2069 7465 725f 626f 756e  bols = iter_boun
-0001ae90: 645f 7379 6d62 6f6c 7328 7472 6163 652e  d_symbols(trace.
-0001aea0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
-0001aeb0: 2020 2023 2072 6563 6f6e 7374 7275 6374     # reconstruct
-0001aec0: 6564 5f65 6e76 203d 207b 0a20 2020 2023  ed_env = {.    #
-0001aed0: 2020 2020 2073 6571 7565 6e63 6966 7928       sequencify(
-0001aee0: 7379 6d62 6f6c 2e6f 7574 7075 7429 5b30  symbol.output)[0
-0001aef0: 5d2e 6e61 6d65 3a20 564a 5044 7561 6c28  ].name: VJPDual(
-0001af00: 4e6f 6e65 2c20 7361 7665 645f 666f 725f  None, saved_for_
-0001af10: 6261 636b 7761 7264 5b69 5d29 0a20 2020  backward[i]).   
-0001af20: 2023 2020 2020 2066 6f72 2069 2c20 7379   #     for i, sy
-0001af30: 6d62 6f6c 2069 6e20 656e 756d 6572 6174  mbol in enumerat
-0001af40: 6528 626f 756e 645f 7379 6d62 6f6c 7329  e(bound_symbols)
-0001af50: 0a20 2020 2023 207d 0a20 2020 2072 6563  .    # }.    rec
-0001af60: 6f6e 7374 7275 6374 6564 5f65 6e76 203d  onstructed_env =
-0001af70: 2072 6563 6f6e 7374 7275 6374 5f66 6f72   reconstruct_for
-0001af80: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
-0001af90: 6b77 6172 6428 7472 6163 652c 2073 6176  kward(trace, sav
-0001afa0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-0001afb0: 0a20 2020 2072 6573 756c 7420 3d20 6261  .    result = ba
-0001afc0: 636b 7761 7264 5f70 6173 7328 7265 636f  ckward_pass(reco
-0001afd0: 6e73 7472 7563 7465 645f 656e 762c 2074  nstructed_env, t
-0001afe0: 7261 6365 2c20 6772 6164 7329 0a20 2020  race, grads).   
-0001aff0: 2069 6620 6c65 6e28 6172 6773 2920 3d3d   if len(args) ==
-0001b000: 2031 3a0a 2020 2020 2020 2020 7265 7475   1:.        retu
-0001b010: 726e 2072 6573 756c 745b 305d 0a20 2020  rn result[0].   
-0001b020: 2023 2042 6163 6b77 6172 6420 7061 7373   # Backward pass
-0001b030: 206d 6967 6874 2072 6574 7572 6e20 6120   might return a 
-0001b040: 6469 6374 2077 6974 6820 6772 6164 7320  dict with grads 
-0001b050: 6275 7420 6375 7272 656e 7420 696e 7465  but current inte
-0001b060: 7266 6163 6520 6f66 0a20 2020 2023 2062  rface of.    # b
-0001b070: 6163 6b77 6172 6420 7275 6c65 2064 6f65  ackward rule doe
-0001b080: 7320 6e6f 7420 7375 7070 6f72 7420 6974  s not support it
-0001b090: 2e20 536f 2077 6520 6a75 7374 2064 726f  . So we just dro
-0001b0a0: 7020 6974 2066 6f72 206e 6f77 2e0a 2020  p it for now..  
-0001b0b0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0001b0c0: 6528 7265 7375 6c74 5b2d 315d 2c20 6469  e(result[-1], di
-0001b0d0: 6374 293a 0a20 2020 2020 2020 2072 6574  ct):.        ret
-0001b0e0: 7572 6e20 7265 7375 6c74 5b3a 2d31 5d0a  urn result[:-1].
-0001b0f0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-0001b100: 740a 0a0a 4072 6567 6973 7465 725f 6175  t...@register_au
-0001b110: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
-0001b120: 2274 6f72 6368 2e54 656e 736f 722e 636f  "torch.Tensor.co
-0001b130: 6e74 6967 756f 7573 2229 0a40 7265 6769  ntiguous").@regi
-0001b140: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-0001b150: 6f72 7761 7264 2822 746f 7263 682e 636f  orward("torch.co
-0001b160: 6e74 6967 756f 7573 2229 0a64 6566 2063  ntiguous").def c
-0001b170: 6f6e 7469 6775 6f75 735f 6175 675f 6677  ontiguous_aug_fw
-0001b180: 6428 783a 2054 656e 736f 7250 726f 7879  d(x: TensorProxy
-0001b190: 2c20 2f2c 202a 2c20 6d65 6d6f 7279 5f66  , /, *, memory_f
-0001b1a0: 6f72 6d61 743a 2074 6f72 6368 2e6d 656d  ormat: torch.mem
-0001b1b0: 6f72 795f 666f 726d 6174 203d 2074 6f72  ory_format = tor
-0001b1c0: 6368 2e63 6f6e 7469 6775 6f75 735f 666f  ch.contiguous_fo
-0001b1d0: 726d 6174 2920 2d3e 2056 4a50 4475 616c  rmat) -> VJPDual
-0001b1e0: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-0001b1f0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
-0001b200: 636f 6e74 6967 756f 7573 0a0a 2020 2020  contiguous..    
-0001b210: 7265 7475 726e 2056 4a50 4475 616c 2863  return VJPDual(c
-0001b220: 6f6e 7469 6775 6f75 7328 782c 206d 656d  ontiguous(x, mem
-0001b230: 6f72 795f 666f 726d 6174 3d6d 656d 6f72  ory_format=memor
-0001b240: 795f 666f 726d 6174 292c 2074 7570 6c65  y_format), tuple
-0001b250: 2829 290a 0a0a 4072 6567 6973 7465 725f  ())...@register_
-0001b260: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
-0001b270: 5465 6e73 6f72 2e63 6f6e 7469 6775 6f75  Tensor.contiguou
-0001b280: 7322 290a 4072 6567 6973 7465 725f 6261  s").@register_ba
-0001b290: 636b 7761 7264 2822 746f 7263 682e 636f  ckward("torch.co
-0001b2a0: 6e74 6967 756f 7573 2229 0a64 6566 2063  ntiguous").def c
-0001b2b0: 6f6e 7469 6775 6f75 735f 6261 636b 7761  ontiguous_backwa
-0001b2c0: 7264 282a 7265 7369 6475 616c 735f 616e  rd(*residuals_an
-0001b2d0: 645f 6772 6164 2920 2d3e 2054 656e 736f  d_grad) -> Tenso
-0001b2e0: 7250 726f 7879 3a0a 2020 2020 2320 5265  rProxy:.    # Re
-0001b2f0: 7369 6475 616c 7320 6973 206e 6f74 2065  siduals is not e
-0001b300: 6d70 7479 2062 6563 6175 7365 2063 6f6e  mpty because con
-0001b310: 7469 6775 6f75 7320 7379 6d62 6f6c 2068  tiguous symbol h
-0001b320: 6173 2074 6865 2073 616d 6520 6f75 7470  as the same outp
-0001b330: 7574 2061 7320 6974 7320 696e 7075 740a  ut as its input.
-0001b340: 2020 2020 6720 3d20 7265 7369 6475 616c      g = residual
-0001b350: 735f 616e 645f 6772 6164 5b2d 315d 0a20  s_and_grad[-1]. 
-0001b360: 2020 2072 6574 7572 6e20 670a 0a0a 6465     return g...de
-0001b370: 6620 7265 6369 7072 6f63 616c 5f61 7567  f reciprocal_aug
-0001b380: 5f66 7764 2861 3a20 5465 6e73 6f72 5072  _fwd(a: TensorPr
-0001b390: 6f78 7929 202d 3e20 564a 5044 7561 6c3a  oxy) -> VJPDual:
-0001b3a0: 0a20 2020 2070 7269 6d61 6c20 3d20 7265  .    primal = re
-0001b3b0: 6369 7072 6f63 616c 2861 290a 2020 2020  ciprocal(a).    
-0001b3c0: 7265 7475 726e 2056 4a50 4475 616c 2870  return VJPDual(p
-0001b3d0: 7269 6d61 6c2c 2028 7072 696d 616c 2c29  rimal, (primal,)
-0001b3e0: 290a 0a0a 6465 6620 7265 6369 7072 6f63  )...def reciproc
-0001b3f0: 616c 5f62 6163 6b77 6172 6428 7072 696d  al_backward(prim
-0001b400: 616c 2c20 6729 3a0a 2020 2020 7265 7475  al, g):.    retu
-0001b410: 726e 202d 6720 2a20 7072 696d 616c 202a  rn -g * primal *
-0001b420: 2070 7269 6d61 6c0a 0a0a 4070 6172 7469   primal...@parti
-0001b430: 616c 2872 6567 6973 7465 725f 6772 6164  al(register_grad
-0001b440: 2c20 7072 696d 732e 5072 696d 4944 732e  , prims.PrimIDs.
-0001b450: 5245 4349 5052 4f43 414c 290a 6465 6620  RECIPROCAL).def 
-0001b460: 7265 6369 7072 6f63 616c 5f6a 6f69 6e74  reciprocal_joint
-0001b470: 5f66 6f72 7761 7264 5f62 6163 6b77 6172  _forward_backwar
-0001b480: 645f 7275 6c65 2861 3a20 5465 6e73 6f72  d_rule(a: Tensor
-0001b490: 5072 6f78 7929 202d 3e20 5465 6e73 6f72  Proxy) -> Tensor
-0001b4a0: 5072 6f78 793a 0a20 2020 2072 6573 756c  Proxy:.    resul
-0001b4b0: 742c 2073 6176 6564 203d 2072 6563 6970  t, saved = recip
-0001b4c0: 726f 6361 6c5f 6175 675f 6677 6428 6129  rocal_aug_fwd(a)
-0001b4d0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-0001b4e0: 6428 7265 7375 6c74 290a 2020 2020 6761  d(result).    ga
-0001b4f0: 203d 2072 6563 6970 726f 6361 6c5f 6261   = reciprocal_ba
-0001b500: 636b 7761 7264 282a 7361 7665 642c 2067  ckward(*saved, g
-0001b510: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
-0001b520: 2c20 6761 290a 2020 2020 7265 7475 726e  , ga).    return
-0001b530: 2072 6573 756c 740a 0a0a 4072 6567 6973   result...@regis
-0001b540: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-0001b550: 7277 6172 6428 2274 6f72 6368 2e69 6e64  rward("torch.ind
-0001b560: 6578 5f70 7574 2229 0a64 6566 2069 6e64  ex_put").def ind
-0001b570: 6578 5f70 7574 5f61 7567 5f66 7764 280a  ex_put_aug_fwd(.
-0001b580: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
-0001b590: 7879 2c20 2f2c 2069 6e64 6963 6573 3a20  xy, /, indices: 
-0001b5a0: 5365 7175 656e 6365 5b54 656e 736f 7250  Sequence[TensorP
-0001b5b0: 726f 7879 5d2c 2076 616c 7565 733a 2054  roxy], values: T
-0001b5c0: 656e 736f 7250 726f 7879 2c20 6163 6375  ensorProxy, accu
-0001b5d0: 6d75 6c61 7465 3a20 626f 6f6c 203d 2046  mulate: bool = F
-0001b5e0: 616c 7365 0a29 202d 3e20 564a 5044 7561  alse.) -> VJPDua
-0001b5f0: 6c3a 0a20 2020 2070 7269 6d61 6c20 3d20  l:.    primal = 
-0001b600: 636c 616e 672e 696e 6465 785f 7075 7428  clang.index_put(
-0001b610: 612c 2069 6e64 6963 6573 2c20 7661 6c75  a, indices, valu
-0001b620: 6573 2c20 6163 6375 6d75 6c61 7465 290a  es, accumulate).
-0001b630: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
-0001b640: 280a 2020 2020 2020 2020 696e 6469 6365  (.        indice
-0001b650: 732c 0a20 2020 2020 2020 2076 616c 7565  s,.        value
-0001b660: 732c 0a20 2020 2020 2020 2061 6363 756d  s,.        accum
-0001b670: 756c 6174 652c 0a20 2020 2029 0a20 2020  ulate,.    ).   
-0001b680: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-0001b690: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-0001b6a0: 7329 0a0a 0a64 6566 2073 756d 5f74 6f28  s)...def sum_to(
-0001b6b0: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
-0001b6c0: 7368 6170 653a 2053 6571 7565 6e63 655b  shape: Sequence[
-0001b6d0: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
-0001b6e0: 726f 7879 3a0a 2020 2020 6966 206e 6f74  roxy:.    if not
-0001b6f0: 2073 6861 7065 3a0a 2020 2020 2020 2020   shape:.        
-0001b700: 7265 7475 726e 2061 2e73 756d 2829 0a20  return a.sum(). 
-0001b710: 2020 206c 6561 6469 6e67 5f64 696d 7320     leading_dims 
-0001b720: 3d20 612e 6e64 696d 202d 206c 656e 2873  = a.ndim - len(s
-0001b730: 6861 7065 290a 2020 2020 7265 6475 6365  hape).    reduce
-0001b740: 5f64 696d 7320 3d20 7475 706c 6528 7261  _dims = tuple(ra
-0001b750: 6e67 6528 6c65 6164 696e 675f 6469 6d73  nge(leading_dims
-0001b760: 2929 202b 2074 7570 6c65 280a 2020 2020  )) + tuple(.    
-0001b770: 2020 2020 6920 666f 7220 6920 696e 2072      i for i in r
-0001b780: 616e 6765 286c 6561 6469 6e67 5f64 696d  ange(leading_dim
-0001b790: 732c 2061 2e6e 6469 6d29 2069 6620 7368  s, a.ndim) if sh
-0001b7a0: 6170 655b 6920 2d20 6c65 6164 696e 675f  ape[i - leading_
-0001b7b0: 6469 6d73 5d20 3d3d 2031 2061 6e64 2061  dims] == 1 and a
-0001b7c0: 2e73 6861 7065 5b69 5d20 213d 2031 0a20  .shape[i] != 1. 
-0001b7d0: 2020 2029 0a20 2020 2061 203d 206c 746f     ).    a = lto
-0001b7e0: 7263 682e 7375 6d28 612c 2064 696d 3d72  rch.sum(a, dim=r
-0001b7f0: 6564 7563 655f 6469 6d73 2c20 6b65 6570  educe_dims, keep
-0001b800: 6469 6d3d 5472 7565 290a 2020 2020 6966  dim=True).    if
-0001b810: 206c 6561 6469 6e67 5f64 696d 7320 3e20   leading_dims > 
-0001b820: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
-0001b830: 6e20 6c74 6f72 6368 2e76 6965 7728 612c  n ltorch.view(a,
-0001b840: 2073 6861 7065 290a 2020 2020 7265 7475   shape).    retu
-0001b850: 726e 2061 0a0a 0a40 7265 6769 7374 6572  rn a...@register
-0001b860: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
-0001b870: 2e69 6e64 6578 5f70 7574 2229 0a64 6566  .index_put").def
-0001b880: 2069 6e64 6578 5f70 7574 5f62 6163 6b77   index_put_backw
-0001b890: 6172 6428 696e 6469 6365 733a 2053 6571  ard(indices: Seq
-0001b8a0: 7565 6e63 655b 5465 6e73 6f72 5072 6f78  uence[TensorProx
-0001b8b0: 795d 2c20 7661 6c75 6573 3a20 5465 6e73  y], values: Tens
-0001b8c0: 6f72 5072 6f78 792c 2061 6363 756d 756c  orProxy, accumul
-0001b8d0: 6174 653a 2062 6f6f 6c2c 2067 3a20 5465  ate: bool, g: Te
-0001b8e0: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
-0001b8f0: 675f 7661 6c75 6573 203d 2067 5b69 6e64  g_values = g[ind
-0001b900: 6963 6573 5d0a 2020 2020 2320 746f 7263  ices].    # torc
-0001b910: 6820 6861 7320 6578 7472 6120 6c6f 6769  h has extra logi
-0001b920: 6320 746f 2068 616e 646c 6520 7468 6520  c to handle the 
-0001b930: 6578 7061 6e64 6564 2076 616c 7565 730a  expanded values.
-0001b940: 2020 2020 6966 206e 6f74 2075 7469 6c73      if not utils
-0001b950: 2e73 616d 655f 7368 6170 6528 675f 7661  .same_shape(g_va
-0001b960: 6c75 6573 2e73 6861 7065 2c20 7661 6c75  lues.shape, valu
-0001b970: 6573 2e73 6861 7065 293a 0a20 2020 2020  es.shape):.     
-0001b980: 2020 2069 6620 636c 616e 672e 636f 6d70     if clang.comp
-0001b990: 7574 655f 6272 6f61 6463 6173 745f 7368  ute_broadcast_sh
-0001b9a0: 6170 6528 675f 7661 6c75 6573 2e73 6861  ape(g_values.sha
-0001b9b0: 7065 2c20 7661 6c75 6573 2e73 6861 7065  pe, values.shape
-0001b9c0: 293a 0a20 2020 2020 2020 2020 2020 2067  ):.            g
-0001b9d0: 5f76 616c 7565 7320 3d20 7375 6d5f 746f  _values = sum_to
-0001b9e0: 2867 5f76 616c 7565 732c 2076 616c 7565  (g_values, value
-0001b9f0: 732e 7368 6170 6529 0a20 2020 2069 6620  s.shape).    if 
-0001ba00: 6163 6375 6d75 6c61 7465 3a0a 2020 2020  accumulate:.    
-0001ba10: 2020 2020 7265 7475 726e 2067 2c20 675f      return g, g_
-0001ba20: 7661 6c75 6573 0a20 2020 2072 6574 7572  values.    retur
-0001ba30: 6e20 636c 616e 672e 696e 6465 785f 7075  n clang.index_pu
-0001ba40: 7428 672c 2069 6e64 6963 6573 2c20 6c74  t(g, indices, lt
-0001ba50: 6f72 6368 2e7a 6572 6f73 5f6c 696b 6528  orch.zeros_like(
-0001ba60: 7661 6c75 6573 292c 2046 616c 7365 292c  values), False),
-0001ba70: 2067 5f76 616c 7565 730a 0a0a 6465 6620   g_values...def 
-0001ba80: 756e 6966 6f72 6d5f 6175 675f 6677 6428  uniform_aug_fwd(
-0001ba90: 7368 6170 652c 206d 696e 7661 6c2c 206d  shape, minval, m
-0001baa0: 6178 7661 6c2c 202a 2c20 6465 7669 6365  axval, *, device
-0001bab0: 2c20 6474 7970 6529 3a0a 2020 2020 7072  , dtype):.    pr
-0001bac0: 696d 616c 203d 2070 7269 6d73 2e75 6e69  imal = prims.uni
-0001bad0: 666f 726d 2873 6861 7065 2c20 6d69 6e76  form(shape, minv
-0001bae0: 616c 2c20 6d61 7876 616c 2c20 6465 7669  al, maxval, devi
-0001baf0: 6365 3d64 6576 6963 652c 2064 7479 7065  ce=device, dtype
-0001bb00: 3d64 7479 7065 290a 2020 2020 7265 7475  =dtype).    retu
-0001bb10: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-0001bb20: 6c2c 2028 7072 696d 616c 2c20 6d69 6e76  l, (primal, minv
-0001bb30: 616c 2c20 6d61 7876 616c 2929 0a0a 0a64  al, maxval))...d
-0001bb40: 6566 2075 6e69 666f 726d 5f62 6163 6b77  ef uniform_backw
-0001bb50: 6172 6428 7072 696d 616c 2c20 6d69 6e76  ard(primal, minv
-0001bb60: 616c 2c20 6d61 7876 616c 2c20 6729 3a0a  al, maxval, g):.
-0001bb70: 2020 2020 2320 756e 6966 6f72 6d20 6973      # uniform is
-0001bb80: 2069 6d70 6c65 6d65 6e74 6564 2061 7320   implemented as 
-0001bb90: 286d 6178 7661 6c20 2d20 6d69 6e76 616c  (maxval - minval
-0001bba0: 2920 2a20 756e 6966 6f72 6d28 7368 6170  ) * uniform(shap
-0001bbb0: 652c 2030 2c20 3129 202b 206d 696e 7661  e, 0, 1) + minva
-0001bbc0: 6c0a 2020 2020 756e 7363 616c 6564 5f70  l.    unscaled_p
-0001bbd0: 7269 6d61 6c20 3d20 2870 7269 6d61 6c20  rimal = (primal 
-0001bbe0: 2d20 6d69 6e76 616c 2920 2f20 286d 6178  - minval) / (max
-0001bbf0: 7661 6c20 2d20 6d69 6e76 616c 290a 2020  val - minval).  
-0001bc00: 2020 7265 6475 6365 5f61 6c6c 5f64 696d    reduce_all_dim
-0001bc10: 7320 3d20 7475 706c 6528 7261 6e67 6528  s = tuple(range(
-0001bc20: 672e 6e64 696d 2929 0a20 2020 2073 756d  g.ndim)).    sum
-0001bc30: 203d 2070 6172 7469 616c 2870 7269 6d73   = partial(prims
-0001bc40: 2e73 756d 2c20 6469 6d73 3d72 6564 7563  .sum, dims=reduc
-0001bc50: 655f 616c 6c5f 6469 6d73 290a 2020 2020  e_all_dims).    
-0001bc60: 7265 7475 726e 204e 6f6e 652c 2073 756d  return None, sum
-0001bc70: 2867 202a 2028 3120 2d20 756e 7363 616c  (g * (1 - unscal
-0001bc80: 6564 5f70 7269 6d61 6c29 292c 2073 756d  ed_primal)), sum
-0001bc90: 2867 202a 2075 6e73 6361 6c65 645f 7072  (g * unscaled_pr
-0001bca0: 696d 616c 290a 0a0a 6e6f 6e64 6966 6665  imal)...nondiffe
-0001bcb0: 7265 6e74 6961 626c 655f 766a 705f 7379  rentiable_vjp_sy
-0001bcc0: 6d62 6f6c 7320 3d20 2870 7269 6d73 2e50  mbols = (prims.P
-0001bcd0: 7269 6d49 4473 2e42 4954 5749 5345 5f41  rimIDs.BITWISE_A
-0001bce0: 4e44 2c20 7072 696d 732e 5072 696d 4944  ND, prims.PrimID
-0001bcf0: 732e 5349 474e 4249 542c 2070 7269 6d73  s.SIGNBIT, prims
-0001bd00: 2e50 7269 6d49 4473 2e46 554c 4c29 0a0a  .PrimIDs.FULL)..
-0001bd10: 0a64 6566 2069 735f 636f 6e73 7461 6e74  .def is_constant
-0001bd20: 5f66 6f72 5f76 6a70 2873 796d 626f 6c3a  _for_vjp(symbol:
-0001bd30: 2070 7269 6d73 2e53 796d 626f 6c29 202d   prims.Symbol) -
-0001bd40: 3e20 626f 6f6c 3a0a 2020 2020 2222 2243  > bool:.    """C
-0001bd50: 6865 636b 2069 6620 6120 7379 6d62 6f6c  heck if a symbol
-0001bd60: 2069 7320 636f 6e73 7461 6e74 2066 6f72   is constant for
-0001bd70: 2074 6865 2056 4a50 2074 7261 6e73 666f   the VJP transfo
-0001bd80: 726d 2e0a 0a20 2020 2041 7267 733a 0a20  rm...    Args:. 
-0001bd90: 2020 2020 2020 2073 796d 626f 6c20 2870         symbol (p
-0001bda0: 7269 6d73 2e53 796d 626f 6c29 3a20 5379  rims.Symbol): Sy
-0001bdb0: 6d62 6f6c 2074 6f20 6368 6563 6b2e 0a0a  mbol to check...
-0001bdc0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001bdd0: 2020 2020 2062 6f6f 6c3a 2054 7275 6520       bool: True 
-0001bde0: 6966 2074 6865 2073 796d 626f 6c20 6973  if the symbol is
-0001bdf0: 2063 6f6e 7374 616e 742c 2046 616c 7365   constant, False
-0001be00: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
-0001be10: 2222 220a 2020 2020 6172 655f 616c 6c5f  """.    are_all_
-0001be20: 6172 6773 5f6e 6f6e 5f64 6966 6665 7265  args_non_differe
-0001be30: 6e74 6961 626c 6520 3d20 6e6f 7420 616e  ntiable = not an
-0001be40: 7928 6973 696e 7374 616e 6365 2861 7267  y(isinstance(arg
-0001be50: 2c20 2846 6c6f 6174 5072 6f78 792c 2054  , (FloatProxy, T
-0001be60: 656e 736f 7250 726f 7879 2929 2066 6f72  ensorProxy)) for
-0001be70: 2061 7267 2069 6e20 7379 6d62 6f6c 2e66   arg in symbol.f
-0001be80: 6c61 745f 6172 6773 290a 2020 2020 7265  lat_args).    re
-0001be90: 7475 726e 2028 0a20 2020 2020 2020 2061  turn (.        a
-0001bea0: 7265 5f61 6c6c 5f61 7267 735f 6e6f 6e5f  re_all_args_non_
-0001beb0: 6469 6666 6572 656e 7469 6162 6c65 0a20  differentiable. 
-0001bec0: 2020 2020 2020 206f 7220 7379 6d62 6f6c         or symbol
-0001bed0: 2e61 7265 5f61 6c6c 5f61 7267 735f 636f  .are_all_args_co
-0001bee0: 6e73 7461 6e74 0a20 2020 2020 2020 206f  nstant.        o
-0001bef0: 7220 7379 6d62 6f6c 2e73 796d 2e69 6420  r symbol.sym.id 
-0001bf00: 696e 206e 6f6e 6469 6666 6572 656e 7469  in nondifferenti
-0001bf10: 6162 6c65 5f76 6a70 5f73 796d 626f 6c73  able_vjp_symbols
-0001bf20: 0a20 2020 2029 0a0a 0a64 6566 2076 6a70  .    )...def vjp
-0001bf30: 5f73 796d 626f 6c5f 6d61 7070 6572 2873  _symbol_mapper(s
-0001bf40: 796d 626f 6c3a 2070 7269 6d73 2e53 796d  ymbol: prims.Sym
-0001bf50: 626f 6c2c 202a 6172 6773 2c20 2a2a 6b77  bol, *args, **kw
-0001bf60: 6172 6773 293a 0a20 2020 2022 2222 5379  args):.    """Sy
-0001bf70: 6d62 6f6c 206d 6170 7065 7220 666f 7220  mbol mapper for 
-0001bf80: 7468 6520 564a 5020 7472 616e 7366 6f72  the VJP transfor
-0001bf90: 6d2e 0a0a 2020 2020 4172 6773 3a0a 2020  m...    Args:.  
-0001bfa0: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
-0001bfb0: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
-0001bfc0: 626f 6c20 746f 2062 6520 6d61 7070 6564  bol to be mapped
-0001bfd0: 2e0a 2020 2020 2020 2020 6172 6773 2028  ..        args (
-0001bfe0: 5475 706c 655b 5661 7269 6162 6c65 5d29  Tuple[Variable])
-0001bff0: 3a20 4172 6775 6d65 6e74 7320 746f 2074  : Arguments to t
-0001c000: 6865 2073 796d 626f 6c2e 0a20 2020 2020  he symbol..     
-0001c010: 2020 206b 7761 7267 7320 2844 6963 745b     kwargs (Dict[
-0001c020: 7374 722c 2056 6172 6961 626c 655d 293a  str, Variable]):
-0001c030: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
-0001c040: 7473 2074 6f20 7468 6520 7379 6d62 6f6c  ts to the symbol
-0001c050: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-0001c060: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-0001c070: 3a20 4120 6675 6e63 7469 6f6e 2074 6861  : A function tha
-0001c080: 7420 636f 6d70 7574 6573 2074 6865 2056  t computes the V
-0001c090: 4a50 206f 6620 7468 6520 7379 6d62 6f6c  JP of the symbol
-0001c0a0: 2e0a 2020 2020 2222 220a 2020 2020 2320  ..    """.    # 
-0001c0b0: 436f 6e73 7461 6e74 2063 6173 650a 2020  Constant case.  
-0001c0c0: 2020 6966 2069 735f 636f 6e73 7461 6e74    if is_constant
-0001c0d0: 5f66 6f72 5f76 6a70 2873 796d 626f 6c29  _for_vjp(symbol)
-0001c0e0: 3a0a 0a20 2020 2020 2020 2064 6566 2076  :..        def v
-0001c0f0: 6a70 5f69 6d70 6c5f 636f 6e73 7428 7379  jp_impl_const(sy
-0001c100: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
-0001c110: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-0001c120: 2020 2020 6172 6773 2c20 6b77 6172 6773      args, kwargs
-0001c130: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-0001c140: 6461 2078 3a20 782e 7072 696d 616c 2069  da x: x.primal i
-0001c150: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0001c160: 564a 5044 7561 6c29 2065 6c73 6520 782c  VJPDual) else x,
-0001c170: 2028 6172 6773 2c20 6b77 6172 6773 2929   (args, kwargs))
-0001c180: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0001c190: 6d61 6c73 203d 2073 796d 626f 6c5f 746f  mals = symbol_to
-0001c1a0: 5f65 7661 6c28 7379 6d62 6f6c 2928 2a61  _eval(symbol)(*a
-0001c1b0: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-0001c1c0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0001c1d0: 696e 7374 616e 6365 2870 7269 6d61 6c73  instance(primals
-0001c1e0: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
-0001c1f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001c200: 7572 6e20 7472 6565 5f6d 6170 286c 616d  urn tree_map(lam
-0001c210: 6264 6120 783a 2056 4a50 4475 616c 2878  bda x: VJPDual(x
-0001c220: 2c20 7475 706c 6528 2929 2c20 7072 696d  , tuple()), prim
-0001c230: 616c 7329 0a20 2020 2020 2020 2020 2020  als).           
-0001c240: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-0001c250: 7072 696d 616c 732c 2074 7570 6c65 2829  primals, tuple()
-0001c260: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0001c270: 6e20 7061 7274 6961 6c28 766a 705f 696d  n partial(vjp_im
-0001c280: 706c 5f63 6f6e 7374 2c20 7379 6d62 6f6c  pl_const, symbol
-0001c290: 290a 0a20 2020 2023 204e 6f72 6d61 6c20  )..    # Normal 
-0001c2a0: 6361 7365 2c20 7765 2068 6176 6520 6120  case, we have a 
-0001c2b0: 7072 6f78 7920 7461 6e67 656e 740a 2020  proxy tangent.  
-0001c2c0: 2020 766a 705f 696d 706c 203d 2061 7567    vjp_impl = aug
-0001c2d0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
-0001c2e0: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
-0001c2f0: 7379 6d2e 6964 290a 0a20 2020 2069 6620  sym.id)..    if 
-0001c300: 5f67 6574 5f67 7261 6466 6e5f 616e 645f  _get_gradfn_and_
-0001c310: 6578 6563 7574 6f72 2873 796d 626f 6c29  executor(symbol)
-0001c320: 5b30 5d20 6973 206e 6f74 204e 6f6e 653a  [0] is not None:
-0001c330: 0a20 2020 2020 2020 2076 6a70 5f69 6d70  .        vjp_imp
-0001c340: 6c2c 2062 6163 6b77 6172 645f 666e 203d  l, backward_fn =
-0001c350: 206d 616b 655f 6175 675f 666f 7277 6172   make_aug_forwar
-0001c360: 645f 616e 645f 6261 636b 7761 7264 2873  d_and_backward(s
-0001c370: 796d 626f 6c29 0a0a 2020 2020 6966 2076  ymbol)..    if v
-0001c380: 6a70 5f69 6d70 6c20 6973 204e 6f6e 653a  jp_impl is None:
-0001c390: 0a20 2020 2020 2020 2023 2057 6520 636f  .        # We co
-0001c3a0: 756c 6420 6e6f 7420 6669 6e64 2061 2056  uld not find a V
-0001c3b0: 4a50 2066 6f72 2074 6869 7320 7379 6d62  JP for this symb
-0001c3c0: 6f6c 2c20 736f 2077 6520 7472 7920 746f  ol, so we try to
-0001c3d0: 2064 6563 6f6d 706f 7365 2069 740a 2020   decompose it.  
-0001c3e0: 2020 2020 2020 6966 206c 656e 2873 796d        if len(sym
-0001c3f0: 626f 6c2e 7375 6273 796d 626f 6c73 2920  bol.subsymbols) 
-0001c400: 3e20 3020 616e 6420 6e6f 7420 6973 696e  > 0 and not isin
-0001c410: 7374 616e 6365 2873 796d 626f 6c2e 7379  stance(symbol.sy
-0001c420: 6d2e 6964 2c20 7072 696d 732e 5072 696d  m.id, prims.Prim
-0001c430: 4944 7329 3a0a 2020 2020 2020 2020 2020  IDs):.          
-0001c440: 2020 766a 705f 696d 706c 203d 2070 6172    vjp_impl = par
-0001c450: 7469 616c 2864 6563 6f6d 706f 7365 645f  tial(decomposed_
-0001c460: 666e 5f61 7567 5f66 7764 5f72 756c 652c  fn_aug_fwd_rule,
-0001c470: 2064 6563 6f6d 706f 7365 645f 666e 3d73   decomposed_fn=s
-0001c480: 796d 626f 6c2e 7379 6d29 0a20 2020 2020  ymbol.sym).     
-0001c490: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001c4a0: 2020 2020 2023 2057 6520 636f 756c 6420       # We could 
-0001c4b0: 6e6f 7420 6669 6e64 2061 2056 4a50 2066  not find a VJP f
-0001c4c0: 6f72 2074 6869 7320 7379 6d62 6f6c 2061  or this symbol a
-0001c4d0: 6e64 2077 6520 636f 756c 6420 6e6f 7420  nd we could not 
-0001c4e0: 6465 636f 6d70 6f73 6520 6974 0a20 2020  decompose it.   
-0001c4f0: 2020 2020 2020 2020 2023 2049 7420 636f           # It co
-0001c500: 756c 6420 6265 2061 2074 6f72 6368 2e64  uld be a torch.d
-0001c510: 726f 706f 7574 2077 6974 6820 302e 3020  ropout with 0.0 
-0001c520: 7072 6f62 6162 696c 6974 792c 2073 6f20  probability, so 
-0001c530: 7765 2073 6b69 7020 6974 0a20 2020 2020  we skip it.     
-0001c540: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
-0001c550: 2e73 796d 2e69 6420 3d3d 2022 746f 7263  .sym.id == "torc
-0001c560: 682e 6e6e 2e66 756e 6374 696f 6e61 6c2e  h.nn.functional.
-0001c570: 6472 6f70 6f75 7422 3a0a 2020 2020 2020  dropout":.      
-0001c580: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001c590: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0001c5a0: 2020 7072 696e 7428 6622 564a 5020 666f    print(f"VJP fo
-0001c5b0: 7220 7b73 796d 626f 6c7d 2069 7320 6e6f  r {symbol} is no
-0001c5c0: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
-0001c5d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001c5e0: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
-0001c5f0: 4572 726f 7228 6622 564a 5020 666f 7220  Error(f"VJP for 
-0001c600: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
-0001c610: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-0001c620: 6564 2229 0a0a 2020 2020 6465 6620 5f76  ed")..    def _v
-0001c630: 6a70 5f69 6d70 6c28 2a61 7267 732c 202a  jp_impl(*args, *
-0001c640: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0001c650: 2020 7072 696d 616c 732c 206b 7761 7267    primals, kwarg
-0001c660: 7320 3d20 7472 6565 5f6d 6170 286c 616d  s = tree_map(lam
-0001c670: 6264 6120 783a 2078 2e70 7269 6d61 6c20  bda x: x.primal 
-0001c680: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0001c690: 2056 4a50 4475 616c 2920 656c 7365 2078   VJPDual) else x
-0001c6a0: 2c20 2861 7267 732c 206b 7761 7267 7329  , (args, kwargs)
-0001c6b0: 290a 2020 2020 2020 2020 6f75 745f 7072  ).        out_pr
-0001c6c0: 696d 616c 2c20 6f75 745f 7265 7369 6475  imal, out_residu
-0001c6d0: 616c 7320 3d20 766a 705f 696d 706c 282a  als = vjp_impl(*
-0001c6e0: 7072 696d 616c 732c 202a 2a6b 7761 7267  primals, **kwarg
-0001c6f0: 7329 0a0a 2020 2020 2020 2020 2320 5765  s)..        # We
-0001c700: 2061 7265 2073 6176 696e 6720 7468 6520   are saving the 
-0001c710: 7265 7369 6475 616c 7320 616e 6420 7075  residuals and pu
-0001c720: 6c6c 6261 636b 206f 6e6c 7920 696e 2074  llback only in t
-0001c730: 6865 2066 6972 7374 206f 7574 7075 740a  he first output.
-0001c740: 2020 2020 2020 2020 2320 6261 636b 7761          # backwa
-0001c750: 7264 5f70 6173 7320 7468 656e 2072 6574  rd_pass then ret
-0001c760: 7269 6576 6573 2074 6865 2072 6573 6964  rieves the resid
-0001c770: 7561 6c73 2061 6e64 2070 756c 6c62 6163  uals and pullbac
-0001c780: 6b20 6672 6f6d 2074 6865 2066 6972 7374  k from the first
-0001c790: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-0001c7a0: 6966 2069 7369 6e73 7461 6e63 6528 6f75  if isinstance(ou
-0001c7b0: 745f 7072 696d 616c 2c20 5365 7175 656e  t_primal, Sequen
-0001c7c0: 6365 293a 0a20 2020 2020 2020 2020 2020  ce):.           
-0001c7d0: 2072 6574 7572 6e20 2856 4a50 4475 616c   return (VJPDual
-0001c7e0: 286f 7574 5f70 7269 6d61 6c5b 305d 2c20  (out_primal[0], 
-0001c7f0: 6f75 745f 7265 7369 6475 616c 7329 2c20  out_residuals), 
-0001c800: 2a28 564a 5044 7561 6c28 6f2c 2074 7570  *(VJPDual(o, tup
-0001c810: 6c65 2829 2920 666f 7220 6f20 696e 206f  le()) for o in o
-0001c820: 7574 5f70 7269 6d61 6c5b 313a 5d29 290a  ut_primal[1:])).
-0001c830: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0001c840: 2856 4a50 4475 616c 286f 7574 5f70 7269  (VJPDual(out_pri
-0001c850: 6d61 6c2c 206f 7574 5f72 6573 6964 7561  mal, out_residua
-0001c860: 6c73 292c 290a 0a20 2020 2072 6574 7572  ls),)..    retur
-0001c870: 6e20 5f76 6a70 5f69 6d70 6c0a 0a0a 6465  n _vjp_impl...de
-0001c880: 6620 6368 6563 6b5f 6273 796d 5f66 6f72  f check_bsym_for
-0001c890: 5f76 6a70 2862 7379 6d29 3a0a 2020 2020  _vjp(bsym):.    
-0001c8a0: 2222 220a 2020 2020 4368 6563 6b20 6966  """.    Check if
-0001c8b0: 2061 2062 6f75 6e64 2073 796d 626f 6c20   a bound symbol 
-0001c8c0: 6973 2073 7570 706f 7274 6564 2062 7920  is supported by 
-0001c8d0: 766a 702e 0a0a 2020 2020 4172 6773 3a0a  vjp...    Args:.
-0001c8e0: 2020 2020 2020 2020 6273 796d 2028 426f          bsym (Bo
-0001c8f0: 756e 6453 796d 626f 6c29 3a20 5468 6520  undSymbol): The 
-0001c900: 626f 756e 6420 7379 6d62 6f6c 2074 6f20  bound symbol to 
-0001c910: 6368 6563 6b2e 0a0a 2020 2020 5265 7475  check...    Retu
-0001c920: 726e 733a 0a20 2020 2020 2020 2062 6f6f  rns:.        boo
-0001c930: 6c3a 2054 7275 6520 6966 2074 6865 2062  l: True if the b
-0001c940: 6f75 6e64 2073 796d 626f 6c20 6973 2073  ound symbol is s
-0001c950: 7570 706f 7274 6564 2062 7920 766a 702c  upported by vjp,
-0001c960: 2046 616c 7365 206f 7468 6572 7769 7365   False otherwise
-0001c970: 2e0a 2020 2020 2222 220a 0a20 2020 2069  ..    """..    i
-0001c980: 6620 6273 796d 2e73 796d 2e69 6420 696e  f bsym.sym.id in
-0001c990: 2074 7261 6e73 666f 726d 5f73 6b69 705f   transform_skip_
-0001c9a0: 6c69 7374 3a0a 2020 2020 2020 2020 7265  list:.        re
-0001c9b0: 7475 726e 2054 7275 650a 0a20 2020 2069  turn True..    i
-0001c9c0: 6620 6273 796d 2e73 796d 2e69 6420 696e  f bsym.sym.id in
-0001c9d0: 2062 6163 6b77 6172 645f 696d 706c 7320   backward_impls 
-0001c9e0: 616e 6420 6273 796d 2e73 796d 2e69 6420  and bsym.sym.id 
-0001c9f0: 696e 2061 7567 6d65 6e74 6564 5f66 6f72  in augmented_for
-0001ca00: 7761 7264 5f69 6d70 6c73 3a0a 2020 2020  ward_impls:.    
-0001ca10: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-0001ca20: 0a20 2020 2069 6620 6273 796d 2e73 796d  .    if bsym.sym
-0001ca30: 2e69 6420 696e 205f 6772 6164 5f66 6e5f  .id in _grad_fn_
-0001ca40: 6d61 703a 0a20 2020 2020 2020 2072 6574  map:.        ret
-0001ca50: 7572 6e20 5472 7565 0a0a 2020 2020 2320  urn True..    # 
-0001ca60: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
-0001ca70: 6420 6120 564a 5020 666f 7220 7468 6973  d a VJP for this
-0001ca80: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
-0001ca90: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
-0001caa0: 6974 0a20 2020 2023 2069 6e74 6f20 7375  it.    # into su
-0001cab0: 622d 7379 6d62 6f6c 7320 616e 6420 6368  b-symbols and ch
-0001cac0: 6563 6b20 6966 2074 6865 7920 6172 6520  eck if they are 
-0001cad0: 7375 7070 6f72 7465 640a 2020 2020 6966  supported.    if
-0001cae0: 206c 656e 2862 7379 6d2e 7375 6273 796d   len(bsym.subsym
-0001caf0: 626f 6c73 2920 3e20 3020 616e 6420 6e6f  bols) > 0 and no
-0001cb00: 7420 6273 796d 2e73 796d 2e69 735f 7072  t bsym.sym.is_pr
-0001cb10: 696d 3a0a 2020 2020 2020 2020 7375 6274  im:.        subt
-0001cb20: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
-0001cb30: 5f74 7261 6365 2829 2862 7379 6d2e 7379  _trace()(bsym.sy
-0001cb40: 6d2c 202a 6273 796d 2e61 7267 732c 202a  m, *bsym.args, *
-0001cb50: 2a62 7379 6d2e 6b77 6172 6773 290a 2020  *bsym.kwargs).  
-0001cb60: 2020 2020 2020 7375 6274 7261 6365 203d        subtrace =
-0001cb70: 2075 6e77 7261 705f 6f6e 655f 6c65 7665   unwrap_one_leve
-0001cb80: 6c5f 6f66 5f73 7562 7379 6d62 6f6c 7328  l_of_subsymbols(
-0001cb90: 7375 6274 7261 6365 290a 2020 2020 2020  subtrace).      
-0001cba0: 2020 616c 6c5f 7375 7070 6f72 7465 6420    all_supported 
-0001cbb0: 3d20 616c 6c28 6368 6563 6b5f 6273 796d  = all(check_bsym
-0001cbc0: 5f66 6f72 5f76 6a70 2873 7562 6273 796d  _for_vjp(subbsym
-0001cbd0: 2920 666f 7220 7375 6262 7379 6d20 696e  ) for subbsym in
-0001cbe0: 2073 7562 7472 6163 652e 626f 756e 645f   subtrace.bound_
-0001cbf0: 7379 6d62 6f6c 7329 0a20 2020 2020 2020  symbols).       
-0001cc00: 2072 6574 7572 6e20 616c 6c5f 7375 7070   return all_supp
-0001cc10: 6f72 7465 640a 0a20 2020 2072 6574 7572  orted..    retur
-0001cc20: 6e20 4661 6c73 650a 0a0a 6465 6620 6175  n False...def au
-0001cc30: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
-0001cc40: 7061 7373 282a 6172 6773 2c20 7472 6163  pass(*args, trac
-0001cc50: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
-0001cc60: 6773 293a 0a20 2020 2022 2222 4175 676d  gs):.    """Augm
-0001cc70: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
-0001cc80: 7373 2066 6f72 2074 6865 2056 4a50 2074  ss for the VJP t
-0001cc90: 7261 6e73 666f 726d 2e0a 0a20 2020 2054  ransform...    T
-0001cca0: 6865 2061 7567 6d65 6e74 6564 2066 6f72  he augmented for
-0001ccb0: 7761 7264 2070 6173 7320 6973 2061 2066  ward pass is a f
-0001ccc0: 6f72 7761 7264 2070 6173 7320 7468 6174  orward pass that
-0001ccd0: 2072 6574 7572 6e73 2074 6865 2072 6573   returns the res
-0001cce0: 6964 7561 6c73 0a20 2020 206f 6620 7468  iduals.    of th
-0001ccf0: 6520 666f 7277 6172 6420 7061 7373 2e0a  e forward pass..
-0001cd00: 2020 2020 5468 6573 6520 7265 7369 6475      These residu
-0001cd10: 616c 7320 6172 6520 7573 6564 2069 6e20  als are used in 
-0001cd20: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
-0001cd30: 7320 746f 2063 6f6d 7075 7465 2074 6865  s to compute the
-0001cd40: 2056 4a50 2061 6e64 2074 6865 790a 2020   VJP and they.  
-0001cd50: 2020 6172 6520 7265 636f 7264 6564 2069    are recorded i
-0001cd60: 6e20 7468 6520 656e 7669 726f 6e6d 656e  n the environmen
-0001cd70: 7420 6469 6374 696f 6e61 7279 2066 6f72  t dictionary for
-0001cd80: 2065 6163 6820 7661 7269 6162 6c65 2e0a   each variable..
-0001cd90: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0001cda0: 2020 2061 7267 7320 2854 7570 6c65 5b56     args (Tuple[V
-0001cdb0: 6172 6961 626c 655d 293a 2041 7267 756d  ariable]): Argum
-0001cdc0: 656e 7473 2074 6f20 7468 6520 6675 6e63  ents to the func
-0001cdd0: 7469 6f6e 2e0a 2020 2020 2020 2020 7472  tion..        tr
-0001cde0: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
-0001cdf0: 6365 206f 6620 7468 6520 6675 6e63 7469  ce of the functi
-0001ce00: 6f6e 2e0a 2020 2020 2020 2020 6b77 6172  on..        kwar
-0001ce10: 6773 2028 4469 6374 5b73 7472 2c20 5661  gs (Dict[str, Va
-0001ce20: 7269 6162 6c65 5d29 3a20 4b65 7977 6f72  riable]): Keywor
-0001ce30: 6420 6172 6775 6d65 6e74 7320 746f 2074  d arguments to t
-0001ce40: 6865 2066 756e 6374 696f 6e2e 0a0a 2020  he function...  
-0001ce50: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-0001ce60: 2020 2054 7570 6c65 5b41 6e79 2c20 4469     Tuple[Any, Di
-0001ce70: 6374 5b73 7472 2c20 416e 795d 5d3a 2054  ct[str, Any]]: T
-0001ce80: 7570 6c65 206f 6620 7468 6520 7072 696d  uple of the prim
-0001ce90: 616c 206f 7574 7075 7473 2061 6e64 2074  al outputs and t
-0001cea0: 6865 2065 6e76 6972 6f6e 6d65 6e74 2e0a  he environment..
-0001ceb0: 2020 2020 2222 220a 2020 2020 6172 6773      """.    args
-0001cec0: 2c20 6b77 6172 6773 203d 2074 7265 655f  , kwargs = tree_
-0001ced0: 6d61 7028 6c61 6d62 6461 2078 3a20 564a  map(lambda x: VJ
-0001cee0: 5044 7561 6c28 782c 2074 7570 6c65 2829  PDual(x, tuple()
-0001cef0: 292c 2028 6172 6773 2c20 6b77 6172 6773  ), (args, kwargs
-0001cf00: 2929 0a20 2020 2072 6573 756c 742c 2065  )).    result, e
-0001cf10: 6e76 203d 2065 7661 6c5f 7472 6163 6528  nv = eval_trace(
-0001cf20: 0a20 2020 2020 2020 2074 7261 6365 2c0a  .        trace,.
-0001cf30: 2020 2020 2020 2020 2a61 7267 732c 0a20          *args,. 
-0001cf40: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-0001cf50: 0a20 2020 2020 2020 2077 6974 685f 656e  .        with_en
-0001cf60: 763d 5472 7565 2c0a 2020 2020 2020 2020  v=True,.        
-0001cf70: 7379 6d62 6f6c 5f6d 6170 7065 723d 766a  symbol_mapper=vj
-0001cf80: 705f 7379 6d62 6f6c 5f6d 6170 7065 722c  p_symbol_mapper,
-0001cf90: 0a20 2020 2029 0a20 2020 2072 6573 756c  .    ).    resul
-0001cfa0: 7420 3d20 7472 6565 5f6d 6170 286c 616d  t = tree_map(lam
-0001cfb0: 6264 6120 783a 2078 2e70 7269 6d61 6c20  bda x: x.primal 
-0001cfc0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-0001cfd0: 2056 4a50 4475 616c 2920 656c 7365 2078   VJPDual) else x
-0001cfe0: 2c20 7265 7375 6c74 290a 2020 2020 7265  , result).    re
-0001cff0: 7475 726e 2072 6573 756c 742c 2065 6e76  turn result, env
-0001d000: 0a0a 0a23 2054 4f44 4f3a 2049 6e73 7465  ...# TODO: Inste
-0001d010: 6164 206f 6620 7573 696e 6720 7468 6520  ad of using the 
-0001d020: 656e 7669 726f 6e6d 656e 7420 6469 6374  environment dict
-0001d030: 696f 6e61 7279 2c20 7765 2063 6f75 6c64  ionary, we could
-0001d040: 2075 7365 2074 6865 2074 7261 6365 0a23   use the trace.#
-0001d050: 2073 796d 626f 6c73 206f 7264 6572 2028   symbols order (
-0001d060: 7468 6174 2073 686f 756c 6420 6265 2064  that should be d
-0001d070: 6574 6572 6d69 6e69 7374 6963 2920 746f  eterministic) to
-0001d080: 2072 6574 7269 6576 6520 7468 6520 7265   retrieve the re
-0001d090: 7369 6475 616c 7320 6e65 6564 6564 0a23  siduals needed.#
-0001d0a0: 2066 6f72 2074 6865 2062 6163 6b77 6172   for the backwar
-0001d0b0: 6420 7061 7373 2e0a 6465 6620 6261 636b  d pass..def back
-0001d0c0: 7761 7264 5f70 6173 7328 666f 7277 6172  ward_pass(forwar
-0001d0d0: 645f 656e 762c 2074 7261 6365 2c20 696e  d_env, trace, in
-0001d0e0: 6974 5f63 6f74 616e 6765 6e74 7329 3a0a  it_cotangents):.
-0001d0f0: 2020 2020 2222 2242 6163 6b77 6172 6420      """Backward 
-0001d100: 7061 7373 2066 6f72 2074 6865 2056 4a50  pass for the VJP
-0001d110: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
-0001d120: 2054 6865 2062 6163 6b77 6172 6420 7061   The backward pa
-0001d130: 7373 2069 7320 6120 7265 7665 7273 6520  ss is a reverse 
-0001d140: 6d6f 6465 2061 7574 6f6d 6174 6963 2064  mode automatic d
-0001d150: 6966 6665 7265 6e74 6961 7469 6f6e 2070  ifferentiation p
-0001d160: 6173 7320 7468 6174 0a20 2020 2063 6f6d  ass that.    com
-0001d170: 7075 7465 7320 7468 6520 7665 6374 6f72  putes the vector
-0001d180: 2d4a 6163 6f62 6961 6e20 7072 6f64 7563  -Jacobian produc
-0001d190: 7420 2856 4a50 2920 6f66 2074 6865 2066  t (VJP) of the f
-0001d1a0: 756e 6374 696f 6e2e 0a0a 2020 2020 4172  unction...    Ar
-0001d1b0: 6773 3a0a 2020 2020 2020 2020 666f 7277  gs:.        forw
-0001d1c0: 6172 645f 656e 7620 2844 6963 745b 7374  ard_env (Dict[st
-0001d1d0: 722c 2041 6e79 5d29 3a20 456e 7669 726f  r, Any]): Enviro
-0001d1e0: 6e6d 656e 7420 6f66 2074 6865 2066 6f72  nment of the for
-0001d1f0: 7761 7264 2070 6173 732e 0a20 2020 2020  ward pass..     
-0001d200: 2020 2074 7261 6365 2028 5472 6163 6529     trace (Trace)
-0001d210: 3a20 5472 6163 6520 6f66 2074 6865 2066  : Trace of the f
-0001d220: 756e 6374 696f 6e2e 0a20 2020 2020 2020  unction..       
-0001d230: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
-0001d240: 2028 5475 706c 655b 5661 7269 6162 6c65   (Tuple[Variable
-0001d250: 5d29 3a20 496e 6974 6961 6c20 636f 7461  ]): Initial cota
-0001d260: 6e67 656e 7473 2e0a 0a20 2020 2052 6574  ngents...    Ret
-0001d270: 7572 6e73 3a0a 2020 2020 2020 2020 5475  urns:.        Tu
-0001d280: 706c 655b 5072 6f78 792c 202e 2e2e 5d3a  ple[Proxy, ...]:
-0001d290: 2054 7570 6c65 206f 6620 7468 6520 7265   Tuple of the re
-0001d2a0: 7375 6c74 7320 6f66 2074 6865 2062 6163  sults of the bac
-0001d2b0: 6b77 6172 6420 7061 7373 2066 6f72 2065  kward pass for e
-0001d2c0: 6163 6820 696e 7075 742e 0a20 2020 2022  ach input..    "
-0001d2d0: 2222 0a20 2020 2065 6e76 203d 207b 7d0a  "".    env = {}.
-0001d2e0: 0a20 2020 2064 6566 2067 6574 5f67 7261  .    def get_gra
-0001d2f0: 6428 783a 2056 6172 6961 626c 6529 3a0a  d(x: Variable):.
-0001d300: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001d310: 7461 6e63 6528 782c 2056 6172 6961 626c  tance(x, Variabl
-0001d320: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001d330: 2320 5265 7475 726e 204e 6f6e 6520 6966  # Return None if
-0001d340: 2074 6865 2076 6172 6961 626c 6520 7761   the variable wa
-0001d350: 7320 6e6f 7420 7573 6564 2069 6e20 7468  s not used in th
-0001d360: 6520 636f 6d70 7574 6174 696f 6e20 616e  e computation an
-0001d370: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-0001d380: 6865 6e63 6520 6e6f 7420 696e 2074 6865  hence not in the
-0001d390: 2065 6e76 0a20 2020 2020 2020 2020 2020   env.           
-0001d3a0: 2072 6574 7572 6e20 656e 762e 6765 7428   return env.get(
-0001d3b0: 782e 6e61 6d65 2c20 4e6f 6e65 290a 2020  x.name, None).  
-0001d3c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001d3d0: 2020 2020 2020 2020 7265 7475 726e 2078          return x
-0001d3e0: 0a0a 2020 2020 6465 6620 7075 745f 6772  ..    def put_gr
-0001d3f0: 6164 2876 3a20 5661 7269 6162 6c65 2c20  ad(v: Variable, 
-0001d400: 7661 6c3a 2041 6e79 2920 2d3e 204e 6f6e  val: Any) -> Non
-0001d410: 653a 0a20 2020 2020 2020 2069 6620 6973  e:.        if is
-0001d420: 696e 7374 616e 6365 2876 2c20 5661 7269  instance(v, Vari
-0001d430: 6162 6c65 293a 0a20 2020 2020 2020 2020  able):.         
-0001d440: 2020 2069 6620 762e 6e61 6d65 2069 6e20     if v.name in 
-0001d450: 656e 763a 0a20 2020 2020 2020 2020 2020  env:.           
-0001d460: 2020 2020 2069 6620 7661 6c20 6973 204e       if val is N
-0001d470: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001d480: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0001d490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d4a0: 2320 4163 6375 6d75 6c61 7465 2063 6f74  # Accumulate cot
-0001d4b0: 616e 6765 6e74 730a 2020 2020 2020 2020  angents.        
-0001d4c0: 2020 2020 2020 2020 656e 765b 762e 6e61          env[v.na
-0001d4d0: 6d65 5d20 3d20 636c 616e 672e 6164 6428  me] = clang.add(
-0001d4e0: 656e 765b 762e 6e61 6d65 5d2c 2076 616c  env[v.name], val
-0001d4f0: 2920 6966 2065 6e76 5b76 2e6e 616d 655d  ) if env[v.name]
-0001d500: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
-0001d510: 6520 7661 6c0a 2020 2020 2020 2020 2020  e val.          
-0001d520: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0001d530: 2020 2020 2020 2020 2065 6e76 5b76 2e6e           env[v.n
-0001d540: 616d 655d 203d 2076 616c 0a20 2020 2020  ame] = val.     
-0001d550: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-0001d560: 6365 2876 2c20 5365 7175 656e 6365 2920  ce(v, Sequence) 
-0001d570: 616e 6420 616c 6c28 6973 696e 7374 616e  and all(isinstan
-0001d580: 6365 2878 2c20 696e 7429 2066 6f72 2078  ce(x, int) for x
-0001d590: 2069 6e20 7629 3a0a 2020 2020 2020 2020   in v):.        
-0001d5a0: 2020 2020 2320 544f 444f 3a20 7265 6d6f      # TODO: remo
-0001d5b0: 7665 2077 6865 6e20 7765 206d 6f76 6520  ve when we move 
-0001d5c0: 6469 6d73 2074 6f20 6b77 6172 6773 0a20  dims to kwargs. 
-0001d5d0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-0001d5e0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
-0001d5f0: 6e73 7461 6e63 6528 762c 2073 7472 293a  nstance(v, str):
-0001d600: 0a20 2020 2020 2020 2020 2020 2065 6e76  .            env
-0001d610: 5b76 5d20 3d20 7661 6c0a 2020 2020 2020  [v] = val.      
-0001d620: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
-0001d630: 6528 762c 2053 6571 7565 6e63 6529 2061  e(v, Sequence) a
-0001d640: 6e64 2076 616c 2069 7320 4e6f 6e65 3a0a  nd val is None:.
-0001d650: 2020 2020 2020 2020 2020 2020 2320 6272              # br
-0001d660: 6f61 6463 6173 7420 4e6f 6e65 2074 6f20  oadcast None to 
-0001d670: 7468 6520 7269 6768 7420 7368 6170 650a  the right shape.
-0001d680: 2020 2020 2020 2020 2020 2020 7361 6665              safe
-0001d690: 5f6d 6170 2870 7574 5f67 7261 642c 2076  _map(put_grad, v
-0001d6a0: 2c20 5b4e 6f6e 655d 202a 206c 656e 2876  , [None] * len(v
-0001d6b0: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-0001d6c0: 6973 696e 7374 616e 6365 2876 2c20 5365  isinstance(v, Se
-0001d6d0: 7175 656e 6365 2920 616e 6420 6973 696e  quence) and isin
-0001d6e0: 7374 616e 6365 2876 616c 2c20 5365 7175  stance(val, Sequ
-0001d6f0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0001d700: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
-0001d710: 2870 7574 5f67 7261 642c 2076 2c20 7661  (put_grad, v, va
-0001d720: 6c29 0a20 2020 2020 2020 2065 6c73 653a  l).        else:
-0001d730: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0001d740: 6b69 7020 7772 6974 696e 6720 746f 2063  kip writing to c
-0001d750: 6f6e 7374 616e 7473 0a20 2020 2020 2020  onstants.       
-0001d760: 2020 2020 2070 6173 730a 0a20 2020 2069       pass..    i
-0001d770: 6620 6973 696e 7374 616e 6365 2869 6e69  f isinstance(ini
-0001d780: 745f 636f 7461 6e67 656e 7473 2c20 5365  t_cotangents, Se
-0001d790: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
-0001d7a0: 696e 6974 5f63 6f74 616e 6765 6e74 7329  init_cotangents)
-0001d7b0: 203d 3d20 3120 616e 6420 6e6f 7420 6973   == 1 and not is
-0001d7c0: 696e 7374 616e 6365 2874 7261 6365 2e6f  instance(trace.o
-0001d7d0: 7574 7075 742c 2053 6571 7565 6e63 6529  utput, Sequence)
-0001d7e0: 3a0a 2020 2020 2020 2020 696e 6974 5f63  :.        init_c
-0001d7f0: 6f74 616e 6765 6e74 7320 3d20 696e 6974  otangents = init
-0001d800: 5f63 6f74 616e 6765 6e74 735b 305d 0a20  _cotangents[0]. 
-0001d810: 2020 2073 6166 655f 6d61 705f 666c 6174     safe_map_flat
-0001d820: 2870 7574 5f67 7261 642c 2074 7261 6365  (put_grad, trace
-0001d830: 2e6f 7574 7075 742c 2069 6e69 745f 636f  .output, init_co
-0001d840: 7461 6e67 656e 7473 290a 0a20 2020 2066  tangents)..    f
-0001d850: 6f72 2073 796d 626f 6c20 696e 2072 6576  or symbol in rev
-0001d860: 6572 7365 6428 6c69 7374 2869 7465 725f  ersed(list(iter_
-0001d870: 626f 756e 645f 7379 6d62 6f6c 7328 7472  bound_symbols(tr
-0001d880: 6163 652e 626f 756e 645f 7379 6d62 6f6c  ace.bound_symbol
-0001d890: 7329 2929 3a0a 2020 2020 2020 2020 7379  s))):.        sy
-0001d8a0: 6d62 6f6c 5f6f 7574 7075 7420 3d20 7365  mbol_output = se
-0001d8b0: 7175 656e 6369 6679 2873 796d 626f 6c2e  quencify(symbol.
-0001d8c0: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
-0001d8d0: 2063 6f74 616e 6765 6e74 7320 3d20 7472   cotangents = tr
-0001d8e0: 6565 5f6d 6170 2867 6574 5f67 7261 642c  ee_map(get_grad,
-0001d8f0: 2073 796d 626f 6c5f 6f75 7470 7574 290a   symbol_output).
-0001d900: 2020 2020 2020 2020 2320 4861 7669 6e67          # Having
-0001d910: 2061 2073 696e 676c 6520 636f 7461 6e67   a single cotang
-0001d920: 656e 7420 6973 2061 2063 6f6d 6d6f 6e20  ent is a common 
-0001d930: 6361 7365 2c20 736f 2077 6520 666c 6174  case, so we flat
-0001d940: 7465 6e20 6974 0a20 2020 2020 2020 2023  ten it.        #
-0001d950: 204f 7468 6572 7769 7365 2c20 7765 2077   Otherwise, we w
-0001d960: 696c 6c20 6e65 6564 2074 6f20 7265 7772  ill need to rewr
-0001d970: 6974 6520 7468 6520 7075 6c6c 6261 636b  ite the pullback
-0001d980: 2066 756e 6374 696f 6e73 0a20 2020 2020   functions.     
-0001d990: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
-0001d9a0: 7472 6565 5f66 6c61 7474 656e 2863 6f74  tree_flatten(cot
-0001d9b0: 616e 6765 6e74 7329 5b30 5d0a 2020 2020  angents)[0].    
-0001d9c0: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
-0001d9d0: 666f 7277 6172 645f 656e 765b 7379 6d62  forward_env[symb
-0001d9e0: 6f6c 5f6f 7574 7075 745b 305d 2e6e 616d  ol_output[0].nam
-0001d9f0: 655d 2e72 6573 6964 7561 6c73 0a20 2020  e].residuals.   
-0001da00: 2020 2020 2069 6620 6973 5f63 6f6e 7374       if is_const
-0001da10: 616e 745f 666f 725f 766a 7028 7379 6d62  ant_for_vjp(symb
-0001da20: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
-0001da30: 2023 2057 6520 6361 6e20 736b 6970 2074   # We can skip t
-0001da40: 6865 2070 756c 6c62 6163 6b20 6966 2061  he pullback if a
-0001da50: 6c6c 2074 6865 2061 7267 756d 656e 7473  ll the arguments
-0001da60: 2061 7265 2063 6f6e 7374 616e 740a 2020   are constant.  
-0001da70: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0001da80: 7565 0a0a 2020 2020 2020 2020 6966 2061  ue..        if a
-0001da90: 6c6c 2863 6f74 616e 6765 6e74 2069 7320  ll(cotangent is 
-0001daa0: 4e6f 6e65 2066 6f72 2063 6f74 616e 6765  None for cotange
-0001dab0: 6e74 2069 6e20 636f 7461 6e67 656e 7473  nt in cotangents
-0001dac0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0001dad0: 2057 6520 6361 6e20 736b 6970 2074 6865   We can skip the
-0001dae0: 2070 756c 6c62 6163 6b20 6966 2074 6865   pullback if the
-0001daf0: 2063 6f74 616e 6765 6e74 2069 7320 4e6f   cotangent is No
-0001db00: 6e65 0a20 2020 2020 2020 2020 2020 2073  ne.            s
-0001db10: 6166 655f 6d61 7028 7075 745f 6772 6164  afe_map(put_grad
-0001db20: 2c20 7379 6d62 6f6c 2e61 7267 732c 2028  , symbol.args, (
-0001db30: 4e6f 6e65 2c29 202a 206c 656e 2873 796d  None,) * len(sym
-0001db40: 626f 6c2e 6172 6773 2929 0a20 2020 2020  bol.args)).     
-0001db50: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001db60: 0a20 2020 2020 2020 2069 6620 7379 6d62  .        if symb
-0001db70: 6f6c 2e73 796d 2e69 6420 3d3d 2022 746f  ol.sym.id == "to
-0001db80: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-0001db90: 6c2e 6472 6f70 6f75 7422 2061 6e64 206e  l.dropout" and n
-0001dba0: 6f74 2073 796d 626f 6c2e 7375 6273 796d  ot symbol.subsym
-0001dbb0: 626f 6c73 3a0a 2020 2020 2020 2020 2020  bols:.          
-0001dbc0: 2020 2320 5765 2063 616e 2073 6b69 7020    # We can skip 
-0001dbd0: 7468 6520 7075 6c6c 6261 636b 2069 6620  the pullback if 
-0001dbe0: 7468 6520 6472 6f70 6f75 7420 7072 6f62  the dropout prob
-0001dbf0: 6162 696c 6974 7920 6973 2030 2e30 0a20  ability is 0.0. 
-0001dc00: 2020 2020 2020 2020 2020 2023 2041 7373             # Ass
-0001dc10: 756d 696e 6720 7468 6174 2074 6865 2064  uming that the d
-0001dc20: 726f 706f 7574 2073 796d 626f 6c20 6861  ropout symbol ha
-0001dc30: 7320 7468 6520 7361 6d65 206f 7574 7075  s the same outpu
-0001dc40: 7420 616e 6420 6172 6775 6d65 6e74 0a20  t and argument. 
-0001dc50: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001dc60: 7420 7379 6d62 6f6c 2e6f 7574 7075 742e  t symbol.output.
-0001dc70: 6e61 6d65 203d 3d20 7379 6d62 6f6c 2e61  name == symbol.a
-0001dc80: 7267 735b 305d 2e6e 616d 652c 2022 4472  rgs[0].name, "Dr
-0001dc90: 6f70 6f75 7420 7379 6d62 6f6c 2068 6173  opout symbol has
-0001dca0: 2061 2064 6966 6665 7265 6e74 206f 7574   a different out
-0001dcb0: 7075 7420 616e 6420 6172 6775 6d65 6e74  put and argument
-0001dcc0: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
-0001dcd0: 2073 796d 626f 6c2e 6172 6773 5b31 5d20   symbol.args[1] 
-0001dce0: 3d3d 2030 2e30 206f 7220 7379 6d62 6f6c  == 0.0 or symbol
-0001dcf0: 2e61 7267 735b 325d 2069 7320 4661 6c73  .args[2] is Fals
-0001dd00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001dd10: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0001dd20: 2020 2020 2062 6163 6b77 6172 6420 3d20       backward = 
-0001dd30: 6261 636b 7761 7264 5f69 6d70 6c73 2e67  backward_impls.g
-0001dd40: 6574 2873 796d 626f 6c2e 7379 6d2e 6964  et(symbol.sym.id
-0001dd50: 290a 2020 2020 2020 2020 6175 675f 666f  ).        aug_fo
-0001dd60: 7277 6172 6420 3d20 6175 676d 656e 7465  rward = augmente
-0001dd70: 645f 666f 7277 6172 645f 696d 706c 732e  d_forward_impls.
-0001dd80: 6765 7428 7379 6d62 6f6c 2e73 796d 2e69  get(symbol.sym.i
-0001dd90: 6429 0a0a 2020 2020 2020 2020 6966 205f  d)..        if _
-0001dda0: 6765 745f 6772 6164 666e 5f61 6e64 5f65  get_gradfn_and_e
-0001ddb0: 7865 6375 746f 7228 7379 6d62 6f6c 295b  xecutor(symbol)[
-0001ddc0: 305d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  0] is not None:.
-0001ddd0: 2020 2020 2020 2020 2020 2020 6175 675f              aug_
-0001dde0: 666f 7277 6172 642c 2062 6163 6b77 6172  forward, backwar
-0001ddf0: 6420 3d20 6d61 6b65 5f61 7567 5f66 6f72  d = make_aug_for
-0001de00: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
-0001de10: 6428 7379 6d62 6f6c 290a 0a20 2020 2020  d(symbol)..     
-0001de20: 2020 2069 6620 6261 636b 7761 7264 2069     if backward i
-0001de30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001de40: 2020 2020 6966 206c 656e 2873 796d 626f      if len(symbo
-0001de50: 6c2e 7375 6273 796d 626f 6c73 2920 3e20  l.subsymbols) > 
-0001de60: 3020 616e 6420 6e6f 7420 6973 696e 7374  0 and not isinst
-0001de70: 616e 6365 2873 796d 626f 6c2e 7379 6d2e  ance(symbol.sym.
-0001de80: 6964 2c20 7072 696d 732e 5072 696d 4944  id, prims.PrimID
-0001de90: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0001dea0: 2020 2020 2320 5765 2063 6f75 6c64 206e      # We could n
-0001deb0: 6f74 2066 696e 6420 6120 6261 636b 7761  ot find a backwa
-0001dec0: 7264 2066 6f72 2074 6869 7320 7379 6d62  rd for this symb
-0001ded0: 6f6c 2c20 736f 2077 6520 7472 7920 746f  ol, so we try to
-0001dee0: 2064 6563 6f6d 706f 7365 2069 740a 2020   decompose it.  
-0001def0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-0001df00: 636b 7761 7264 203d 2070 6172 7469 616c  ckward = partial
-0001df10: 2864 6563 6f6d 706f 7365 645f 666e 5f62  (decomposed_fn_b
-0001df20: 6163 6b77 6172 645f 7275 6c65 2c20 7379  ackward_rule, sy
-0001df30: 6d62 6f6c 2e73 796d 290a 2020 2020 2020  mbol.sym).      
-0001df40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001df50: 2020 2020 2020 2020 2020 2020 2320 5765              # We
-0001df60: 2063 6f75 6c64 206e 6f74 2066 696e 6420   could not find 
-0001df70: 6120 6261 636b 7761 7264 2066 6f72 2074  a backward for t
-0001df80: 6869 7320 7379 6d62 6f6c 2061 6e64 2077  his symbol and w
-0001df90: 6520 636f 756c 6420 6e6f 7420 6465 636f  e could not deco
-0001dfa0: 6d70 6f73 6520 6974 0a20 2020 2020 2020  mpose it.       
-0001dfb0: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
-0001dfc0: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
-0001dfd0: 6f72 2866 2242 6163 6b77 6172 6420 666f  or(f"Backward fo
-0001dfe0: 7220 7b73 796d 626f 6c2e 7379 6d2e 6964  r {symbol.sym.id
-0001dff0: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
-0001e000: 6e74 6564 2229 0a0a 2020 2020 2020 2020  nted")..        
-0001e010: 7265 7375 6c74 203d 2062 6163 6b77 6172  result = backwar
-0001e020: 6428 2a72 6573 6964 7561 6c73 2c20 2a63  d(*residuals, *c
-0001e030: 6f74 616e 6765 6e74 7329 0a20 2020 2020  otangents).     
-0001e040: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0001e050: 2872 6573 756c 742c 2064 6963 7429 3a0a  (result, dict):.
-0001e060: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-0001e070: 2074 6865 2062 6163 6b77 6172 6420 7265   the backward re
-0001e080: 7475 726e 7320 6120 6469 6374 2c20 7765  turns a dict, we
-0001e090: 2061 7373 756d 6520 7468 6174 2069 7420   assume that it 
-0001e0a0: 6973 2061 2064 6963 7420 6f66 0a20 2020  is a dict of.   
-0001e0b0: 2020 2020 2020 2020 2023 2066 6f72 7761           # forwa
-0001e0c0: 7264 2061 7267 756d 656e 7473 2074 6f20  rd arguments to 
-0001e0d0: 7468 6520 636f 7272 6573 706f 6e64 696e  the correspondin
-0001e0e0: 670a 2020 2020 2020 2020 2020 2020 2320  g.            # 
-0001e0f0: 6772 6164 6965 6e74 732f 636f 7461 6e67  gradients/cotang
-0001e100: 656e 7473 2f61 646a 6f69 6e74 732f 7365  ents/adjoints/se
-0001e110: 6e73 6974 6976 6974 6965 732e 0a20 2020  nsitivities..   
-0001e120: 2020 2020 2020 2020 2075 7365 645f 6e61           used_na
-0001e130: 6d65 7320 3d20 7365 7428 290a 2020 2020  mes = set().    
-0001e140: 2020 2020 2020 2020 666f 7220 692c 2028          for i, (
-0001e150: 6b2c 2076 2920 696e 2065 6e75 6d65 7261  k, v) in enumera
-0001e160: 7465 2869 6e73 7065 6374 2e73 6967 6e61  te(inspect.signa
-0001e170: 7475 7265 2861 7567 5f66 6f72 7761 7264  ture(aug_forward
-0001e180: 292e 7061 7261 6d65 7465 7273 2e69 7465  ).parameters.ite
-0001e190: 6d73 2829 293a 0a20 2020 2020 2020 2020  ms()):.         
-0001e1a0: 2020 2020 2020 2069 6620 762e 6b69 6e64         if v.kind
-0001e1b0: 2069 6e20 2869 6e73 7065 6374 2e50 6172   in (inspect.Par
-0001e1c0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
-0001e1d0: 4c5f 4f4e 4c59 2c20 696e 7370 6563 742e  L_ONLY, inspect.
-0001e1e0: 5061 7261 6d65 7465 722e 504f 5349 5449  Parameter.POSITI
-0001e1f0: 4f4e 414c 5f4f 525f 4b45 5957 4f52 4429  ONAL_OR_KEYWORD)
-0001e200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e210: 2020 2020 2020 7075 745f 6772 6164 2873        put_grad(s
-0001e220: 796d 626f 6c2e 6172 6773 5b69 5d2c 2072  ymbol.args[i], r
-0001e230: 6573 756c 742e 6765 7428 6b2c 204e 6f6e  esult.get(k, Non
-0001e240: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
-0001e250: 2020 2020 2020 2020 7573 6564 5f6e 616d          used_nam
-0001e260: 6573 2e61 6464 286b 290a 0a20 2020 2020  es.add(k)..     
-0001e270: 2020 2020 2020 2023 2046 6f72 2064 6576         # For dev
-0001e280: 656c 6f70 6572 2063 6f6e 7665 6e69 656e  eloper convenien
-0001e290: 6365 2c20 7765 2061 6c6c 6f77 2075 7369  ce, we allow usi
-0001e2a0: 6e67 2074 6865 206e 616d 6520 6672 6f6d  ng the name from
-0001e2b0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-0001e2c0: 2023 2066 6f72 7761 7264 206d 6574 6120   # forward meta 
-0001e2d0: 696e 2061 6464 6974 696f 6e20 746f 2074  in addition to t
-0001e2e0: 6865 206e 616d 6520 6672 6f6d 2074 6865  he name from the
-0001e2f0: 2061 7567 6d65 6e74 6564 2066 6f72 7761   augmented forwa
-0001e300: 7264 0a20 2020 2020 2020 2020 2020 2023  rd.            #
-0001e310: 2073 6967 6e61 7475 7265 2e0a 2020 2020   signature..    
-0001e320: 2020 2020 2020 2020 2320 4966 2062 6f74          # If bot
-0001e330: 6820 6e61 6d65 7320 6172 6520 7573 6564  h names are used
-0001e340: 2c20 7468 6520 6f6e 6520 6672 6f6d 2074  , the one from t
-0001e350: 6865 2066 6f72 7761 7264 206d 6574 6120  he forward meta 
-0001e360: 7461 6b65 730a 2020 2020 2020 2020 2020  takes.          
-0001e370: 2020 2320 7072 6563 6564 656e 6365 2e0a    # precedence..
-0001e380: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001e390: 692c 2028 6b2c 2076 2920 696e 2065 6e75  i, (k, v) in enu
-0001e3a0: 6d65 7261 7465 2869 6e73 7065 6374 2e73  merate(inspect.s
-0001e3b0: 6967 6e61 7475 7265 2873 796d 626f 6c2e  ignature(symbol.
-0001e3c0: 7379 6d2e 6d65 7461 292e 7061 7261 6d65  sym.meta).parame
-0001e3d0: 7465 7273 2e69 7465 6d73 2829 293a 0a20  ters.items()):. 
-0001e3e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001e3f0: 6620 762e 6b69 6e64 2069 6e20 2869 6e73  f v.kind in (ins
-0001e400: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
-0001e410: 4f53 4954 494f 4e41 4c5f 4f4e 4c59 2c20  OSITIONAL_ONLY, 
-0001e420: 696e 7370 6563 742e 5061 7261 6d65 7465  inspect.Paramete
-0001e430: 722e 504f 5349 5449 4f4e 414c 5f4f 525f  r.POSITIONAL_OR_
-0001e440: 4b45 5957 4f52 4429 3a0a 2020 2020 2020  KEYWORD):.      
-0001e450: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001e460: 206b 206e 6f74 2069 6e20 7573 6564 5f6e   k not in used_n
-0001e470: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
-0001e480: 2020 2020 2020 2020 2020 2020 2020 7075                pu
-0001e490: 745f 6772 6164 2873 796d 626f 6c2e 6172  t_grad(symbol.ar
-0001e4a0: 6773 5b69 5d2c 2072 6573 756c 742e 6765  gs[i], result.ge
-0001e4b0: 7428 6b2c 204e 6f6e 6529 290a 2020 2020  t(k, None)).    
-0001e4c0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0001e4d0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0001e4e0: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
-0001e4f0: 6c74 2c20 5365 7175 656e 6365 293a 0a20  lt, Sequence):. 
-0001e500: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-0001e510: 7420 3d20 2872 6573 756c 742c 290a 0a20  t = (result,).. 
-0001e520: 2020 2020 2020 2064 6566 2069 735f 6469         def is_di
-0001e530: 6666 6572 656e 7469 6162 6c65 2861 7267  fferentiable(arg
-0001e540: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-0001e550: 6174 6368 2061 7267 3a0a 2020 2020 2020  atch arg:.      
-0001e560: 2020 2020 2020 2020 2020 6361 7365 2054            case T
-0001e570: 656e 736f 7250 726f 7879 2829 3a0a 2020  ensorProxy():.  
-0001e580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e590: 2020 7265 7475 726e 2064 7479 7065 732e    return dtypes.
-0001e5a0: 6973 5f69 6e65 7861 6374 5f64 7479 7065  is_inexact_dtype
-0001e5b0: 2861 7267 2e64 7479 7065 290a 2020 2020  (arg.dtype).    
-0001e5c0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-0001e5d0: 2053 6571 7565 6e63 6528 293a 0a20 2020   Sequence():.   
-0001e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5f0: 2072 6574 7572 6e20 6172 6720 616e 6420   return arg and 
-0001e600: 616c 6c28 6973 696e 7374 616e 6365 2878  all(isinstance(x
-0001e610: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
-0001e620: 6e64 2064 7479 7065 732e 6973 5f69 6e65  nd dtypes.is_ine
-0001e630: 7861 6374 5f64 7479 7065 2878 2e64 7479  xact_dtype(x.dty
-0001e640: 7065 2920 666f 7220 7820 696e 2061 7267  pe) for x in arg
-0001e650: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e660: 2020 6361 7365 205f 3a0a 2020 2020 2020    case _:.      
-0001e670: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001e680: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-0001e690: 2020 2020 6966 206c 656e 2873 796d 626f      if len(symbo
-0001e6a0: 6c2e 6172 6773 2920 213d 2028 6f72 6967  l.args) != (orig
-0001e6b0: 5f72 6573 5f6c 656e 203a 3d20 6c65 6e28  _res_len := len(
-0001e6c0: 7265 7375 6c74 2929 3a0a 2020 2020 2020  result)):.      
-0001e6d0: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
-0001e6e0: 2020 2020 2020 2020 2020 2020 206f 7269               ori
-0001e6f0: 675f 7265 735f 6c65 6e20 3c3d 206c 656e  g_res_len <= len
-0001e700: 2873 796d 626f 6c2e 6172 6773 292c 0a20  (symbol.args),. 
-0001e710: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001e720: 616d 6264 613a 2066 2242 6163 6b77 6172  ambda: f"Backwar
-0001e730: 6420 666f 7220 7b73 796d 626f 6c2e 7379  d for {symbol.sy
-0001e740: 6d2e 6964 7d20 7265 7475 726e 6564 207b  m.id} returned {
-0001e750: 6f72 6967 5f72 6573 5f6c 656e 7d20 7661  orig_res_len} va
-0001e760: 6c75 6573 2c20 220a 2020 2020 2020 2020  lues, ".        
-0001e770: 2020 2020 2020 2020 2b20 6622 6275 7420          + f"but 
-0001e780: 6578 7065 6374 6564 2061 7420 6d6f 7374  expected at most
-0001e790: 207b 6c65 6e28 7379 6d62 6f6c 2e61 7267   {len(symbol.arg
-0001e7a0: 7329 7d22 2c0a 2020 2020 2020 2020 2020  s)}",.          
-0001e7b0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0001e7c0: 2320 4173 7375 6d69 6e67 2074 6861 7420  # Assuming that 
-0001e7d0: 7468 6520 6e6f 6e2d 6469 6666 6572 656e  the non-differen
-0001e7e0: 7469 6162 6c65 2061 7267 756d 656e 7473  tiable arguments
-0001e7f0: 2077 6572 6520 6472 6f70 7065 6420 6672   were dropped fr
-0001e800: 6f6d 0a20 2020 2020 2020 2020 2020 2023  om.            #
-0001e810: 2074 6865 2062 6163 6b77 6172 6420 6675   the backward fu
-0001e820: 6e63 7469 6f6e 2c20 7765 2061 7265 2067  nction, we are g
-0001e830: 6f69 6e67 2074 6f20 6170 7065 6e64 204e  oing to append N
-0001e840: 6f6e 6520 746f 2074 6865 2072 6573 756c  one to the resul
-0001e850: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0001e860: 746f 206d 6174 6368 2074 6865 206e 756d  to match the num
-0001e870: 6265 7220 6f66 2061 7267 756d 656e 7473  ber of arguments
-0001e880: 2e20 416c 7465 726e 6174 6976 656c 792c  . Alternatively,
-0001e890: 2077 6520 636f 756c 6420 6a75 7374 0a20   we could just. 
-0001e8a0: 2020 2020 2020 2020 2020 2023 2068 6176             # hav
-0001e8b0: 6520 6120 666f 722d 6c6f 6f70 2077 6974  e a for-loop wit
-0001e8c0: 6820 6120 636f 6e64 6974 696f 6e61 6c20  h a conditional 
-0001e8d0: 7768 656e 2077 7269 7469 6e67 2074 6f20  when writing to 
-0001e8e0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-0001e8f0: 2320 656e 7669 726f 6e6d 656e 742e 0a0a  # environment...
-0001e900: 2020 2020 2020 2020 2020 2020 6974 6572              iter
-0001e910: 5f72 6573 756c 7420 3d20 6974 6572 2872  _result = iter(r
-0001e920: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
-0001e930: 2020 206e 5f64 6966 6665 7265 6e74 6961     n_differentia
-0001e940: 626c 655f 6172 6773 203d 2073 756d 2862  ble_args = sum(b
-0001e950: 6f6f 6c28 6973 5f64 6966 6665 7265 6e74  ool(is_different
-0001e960: 6961 626c 6528 6172 6729 2920 666f 7220  iable(arg)) for 
-0001e970: 6172 6720 696e 2073 796d 626f 6c2e 6172  arg in symbol.ar
-0001e980: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-0001e990: 6368 6563 6b28 0a20 2020 2020 2020 2020  check(.         
-0001e9a0: 2020 2020 2020 206e 5f64 6966 6665 7265         n_differe
-0001e9b0: 6e74 6961 626c 655f 6172 6773 203c 3d20  ntiable_args <= 
-0001e9c0: 6f72 6967 5f72 6573 5f6c 656e 2c0a 2020  orig_res_len,.  
-0001e9d0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0001e9e0: 6d62 6461 3a20 6622 4261 636b 7761 7264  mbda: f"Backward
-0001e9f0: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
-0001ea00: 2e69 647d 2072 6574 7572 6e65 6420 7b6f  .id} returned {o
-0001ea10: 7269 675f 7265 735f 6c65 6e7d 2076 616c  rig_res_len} val
-0001ea20: 7565 2873 292c 2022 0a20 2020 2020 2020  ue(s), ".       
-0001ea30: 2020 2020 2020 2020 202b 2066 2262 7574           + f"but
-0001ea40: 2065 7870 6563 7465 6420 7b6e 5f64 6966   expected {n_dif
-0001ea50: 6665 7265 6e74 6961 626c 655f 6172 6773  ferentiable_args
-0001ea60: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-0001ea70: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-0001ea80: 6573 756c 7420 3d20 7475 706c 6528 6e65  esult = tuple(ne
-0001ea90: 7874 2869 7465 725f 7265 7375 6c74 2920  xt(iter_result) 
-0001eaa0: 6966 2069 735f 6469 6666 6572 656e 7469  if is_differenti
-0001eab0: 6162 6c65 2861 7267 2920 656c 7365 204e  able(arg) else N
-0001eac0: 6f6e 6520 666f 7220 6172 6720 696e 2073  one for arg in s
-0001ead0: 796d 626f 6c2e 6172 6773 290a 0a20 2020  ymbol.args)..   
-0001eae0: 2020 2020 2023 2053 6565 2022 4261 636b       # See "Back
-0001eaf0: 7761 7264 2069 6d70 6c20 666f 7220 6f70  ward impl for op
-0001eb00: 7320 6f66 2074 6865 2074 7970 6520 5365  s of the type Se
-0001eb10: 7175 656e 6365 5b54 656e 736f 7250 726f  quence[TensorPro
-0001eb20: 7879 5d2c 202e 2e2e 202d 3e20 2e2e 2e20  xy], ... -> ... 
-0001eb30: 7265 7375 6c74 7320 696e 204e 6f6e 6520  results in None 
-0001eb40: 6772 6164 732e 220a 2020 2020 2020 2020  grads.".        
-0001eb50: 2320 5468 6973 2069 7320 6120 7465 6d70  # This is a temp
-0001eb60: 6f72 6172 7920 776f 726b 6172 6f75 6e64  orary workaround
-0001eb70: 2e0a 2020 2020 2020 2020 6966 2073 796d  ..        if sym
-0001eb80: 626f 6c2e 7379 6d2e 6964 2069 6e20 2870  bol.sym.id in (p
-0001eb90: 7269 6d73 2e50 7269 6d49 4473 2e43 4154  rims.PrimIDs.CAT
-0001eba0: 2c20 2274 6f72 6368 2e63 6174 222c 2022  , "torch.cat", "
-0001ebb0: 746f 7263 682e 7374 6163 6b22 293a 0a20  torch.stack"):. 
-0001ebc0: 2020 2020 2020 2020 2020 2073 6166 655f             safe_
-0001ebd0: 6d61 705f 666c 6174 2870 7574 5f67 7261  map_flat(put_gra
-0001ebe0: 642c 2073 796d 626f 6c2e 6172 6773 2c20  d, symbol.args, 
-0001ebf0: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
-0001ec00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001ec10: 2020 7361 6665 5f6d 6170 2870 7574 5f67    safe_map(put_g
-0001ec20: 7261 642c 2073 796d 626f 6c2e 6172 6773  rad, symbol.args
-0001ec30: 2c20 7265 7375 6c74 290a 0a20 2020 2064  , result)..    d
-0001ec40: 6566 2067 6574 5f69 6e65 7861 6374 5f64  ef get_inexact_d
-0001ec50: 7479 7065 5f6f 725f 6e6f 6e65 2878 293a  type_or_none(x):
-0001ec60: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0001ec70: 7374 616e 6365 2878 2c20 2854 656e 736f  stance(x, (Tenso
-0001ec80: 7250 726f 7879 2c20 4675 7475 7265 5465  rProxy, FutureTe
-0001ec90: 6e73 6f72 5072 6f78 7929 2920 616e 6420  nsorProxy)) and 
-0001eca0: 6474 7970 6573 2e69 735f 696e 6578 6163  dtypes.is_inexac
-0001ecb0: 745f 6474 7970 6528 782e 6474 7970 6529  t_dtype(x.dtype)
-0001ecc0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001ecd0: 7475 726e 2078 0a20 2020 2020 2020 2065  turn x.        e
-0001ece0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001ecf0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-0001ed00: 2020 6761 7267 7320 3d20 7472 6565 5f6d    gargs = tree_m
-0001ed10: 6170 2867 6574 5f67 7261 642c 2074 7570  ap(get_grad, tup
-0001ed20: 6c65 2874 7261 6365 2e61 7267 7329 290a  le(trace.args)).
-0001ed30: 2020 2020 676b 7761 7267 7320 3d20 7472      gkwargs = tr
-0001ed40: 6565 5f6d 6170 2867 6574 5f67 7261 642c  ee_map(get_grad,
-0001ed50: 2074 7261 6365 2e6b 7761 7267 7329 0a20   trace.kwargs). 
-0001ed60: 2020 2067 6b77 6172 6773 203d 207b 6b3a     gkwargs = {k:
-0001ed70: 2076 2066 6f72 206b 2c20 7620 696e 2067   v for k, v in g
-0001ed80: 6b77 6172 6773 2e69 7465 6d73 2829 2069  kwargs.items() i
-0001ed90: 6620 7620 6973 206e 6f74 204e 6f6e 657d  f v is not None}
-0001eda0: 0a20 2020 2067 6172 6773 2c20 676b 7761  .    gargs, gkwa
-0001edb0: 7267 7320 3d20 7472 6565 5f6d 6170 2867  rgs = tree_map(g
-0001edc0: 6574 5f69 6e65 7861 6374 5f64 7479 7065  et_inexact_dtype
-0001edd0: 5f6f 725f 6e6f 6e65 2c20 2867 6172 6773  _or_none, (gargs
-0001ede0: 2c20 676b 7761 7267 7329 290a 2020 2020  , gkwargs)).    
-0001edf0: 7265 7475 726e 2067 6172 6773 202b 2028  return gargs + (
-0001ee00: 676b 7761 7267 732c 2920 6966 206c 656e  gkwargs,) if len
-0001ee10: 2867 6b77 6172 6773 2920 213d 2030 2065  (gkwargs) != 0 e
-0001ee20: 6c73 6520 6761 7267 730a 0a0a 6465 6620  lse gargs...def 
-0001ee30: 766a 705f 6361 6c6c 5f6d 6574 6166 756e  vjp_call_metafun
-0001ee40: 6328 6465 7461 6368 6564 3a20 626f 6f6c  c(detached: bool
-0001ee50: 2c20 7072 696d 616c 732c 2063 6f74 616e  , primals, cotan
-0001ee60: 6765 6e74 732c 2074 7261 6365 3a20 5472  gents, trace: Tr
-0001ee70: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
-0001ee80: 2020 2020 2320 4173 7375 6d69 6e67 2070      # Assuming p
-0001ee90: 7269 6d61 6c73 2069 7320 666c 6174 0a0a  rimals is flat..
-0001eea0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-0001eeb0: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
-0001eec0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-0001eed0: 2020 7072 696d 616c 7320 3d20 2870 7269    primals = (pri
-0001eee0: 6d61 6c73 2c29 0a0a 2020 2020 6374 7820  mals,)..    ctx 
-0001eef0: 3d20 6465 7461 6368 6564 5f74 7261 6365  = detached_trace
-0001ef00: 2829 2069 6620 6465 7461 6368 6564 2065  () if detached e
-0001ef10: 6c73 6520 6e75 6c6c 636f 6e74 6578 7428  lse nullcontext(
-0001ef20: 290a 2020 2020 7769 7468 2063 7478 3a0a  ).    with ctx:.
-0001ef30: 2020 2020 2020 2020 7265 7375 6c74 2c20          result, 
-0001ef40: 656e 7620 3d20 6175 676d 656e 7465 645f  env = augmented_
-0001ef50: 666f 7277 6172 645f 7061 7373 282a 7072  forward_pass(*pr
-0001ef60: 696d 616c 732c 2074 7261 6365 3d74 7261  imals, trace=tra
-0001ef70: 6365 2c20 2a2a 6b77 6172 6773 290a 2020  ce, **kwargs).  
-0001ef80: 2020 2020 2020 6368 6563 6b28 0a20 2020        check(.   
-0001ef90: 2020 2020 2020 2020 206c 656e 2872 6573           len(res
-0001efa0: 756c 7429 203d 3d20 6c65 6e28 636f 7461  ult) == len(cota
-0001efb0: 6e67 656e 7473 2920 6966 2069 7369 6e73  ngents) if isins
-0001efc0: 7461 6e63 6528 7265 7375 6c74 2c20 5365  tance(result, Se
-0001efd0: 7175 656e 6365 2920 656c 7365 2054 7275  quence) else Tru
-0001efe0: 652c 0a20 2020 2020 2020 2020 2020 206c  e,.            l
-0001eff0: 616d 6264 613a 2066 2245 7870 6563 7465  ambda: f"Expecte
-0001f000: 6420 636f 7461 6e67 656e 7473 2074 6f20  d cotangents to 
-0001f010: 6265 2061 2073 6571 7565 6e63 6520 6f66  be a sequence of
-0001f020: 206c 656e 6774 6820 7b6c 656e 2872 6573   length {len(res
-0001f030: 756c 7429 7d2c 2067 6f74 2061 2073 6571  ult)}, got a seq
-0001f040: 7565 6e63 6520 6f66 206c 656e 6774 6820  uence of length 
-0001f050: 7b6c 656e 2863 6f74 616e 6765 6e74 7329  {len(cotangents)
-0001f060: 7d22 2c0a 2020 2020 2020 2020 290a 2020  }",.        ).  
-0001f070: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-0001f080: 756c 742c 2062 6163 6b77 6172 645f 7061  ult, backward_pa
-0001f090: 7373 2865 6e76 2c20 7472 6163 652c 2063  ss(env, trace, c
-0001f0a0: 6f74 616e 6765 6e74 7329 0a0a 0a23 2054  otangents)...# T
-0001f0b0: 4f44 4f3a 2043 616e 2774 2075 7365 2061  ODO: Can't use a
-0001f0c0: 2053 796d 626f 6c20 6865 7265 2062 6563   Symbol here bec
-0001f0d0: 6175 7365 206d 6978 6564 2065 7865 6375  ause mixed execu
-0001f0e0: 746f 7220 7379 6273 796d 626f 6c73 2073  tor sybsymbols s
-0001f0f0: 6565 6d20 746f 2062 650a 2320 756e 7375  eem to be.# unsu
-0001f100: 7070 6f72 7465 642e 2053 6565 2069 7373  pported. See iss
-0001f110: 7565 2022 436f 756c 6420 6e6f 7420 6669  ue "Could not fi
-0001f120: 6e64 2061 6e20 6578 6563 7574 6f72 2066  nd an executor f
-0001f130: 6f72 2062 6f75 6e64 2073 796d 626f 6c20  or bound symbol 
-0001f140: 7768 656e 2069 7473 2073 7562 7379 6d62  when its subsymb
-0001f150: 6f6c 730a 2320 6172 6520 6e6f 7420 6675  ols.# are not fu
-0001f160: 6c6c 7920 7375 7070 6f72 7465 6420 6279  lly supported by
-0001f170: 2061 2073 696e 676c 6520 6578 6563 7574   a single execut
-0001f180: 6f72 220a 766a 705f 6361 6c6c 203d 2070  or".vjp_call = p
-0001f190: 6172 7469 616c 280a 2020 2020 766a 705f  artial(.    vjp_
-0001f1a0: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
-0001f1b0: 616c 7365 0a29 2020 2320 5379 6d62 6f6c  alse.)  # Symbol
-0001f1c0: 2869 643d 5472 616e 7366 6f72 6d73 2e56  (id=Transforms.V
-0001f1d0: 6a70 4f70 2c20 6e61 6d65 3d22 766a 705f  jpOp, name="vjp_
-0001f1e0: 6361 6c6c 222c 206d 6574 613d 7061 7274  call", meta=part
-0001f1f0: 6961 6c28 766a 705f 6361 6c6c 5f6d 6574  ial(vjp_call_met
-0001f200: 6166 756e 632c 2046 616c 7365 2929 0a0a  afunc, False))..
-0001f210: 0a64 6566 2076 6a70 2866 756e 6329 3a0a  .def vjp(func):.
-0001f220: 2020 2020 2222 2243 6f6d 7075 7465 7320      """Computes 
-0001f230: 7468 6520 564a 5020 6f66 2061 2066 756e  the VJP of a fun
-0001f240: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
-0001f250: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
-0001f260: 4361 6c6c 6162 6c65 293a 2046 756e 6374  Callable): Funct
-0001f270: 696f 6e20 746f 2062 6520 6469 6666 6572  ion to be differ
-0001f280: 656e 7469 6174 6564 2e0a 2020 2020 2222  entiated..    ""
-0001f290: 220a 0a20 2020 2064 6566 205f 766a 7028  "..    def _vjp(
-0001f2a0: 7072 696d 616c 732c 2063 6f74 616e 6765  primals, cotange
-0001f2b0: 6e74 732c 202a 2a6b 7761 7267 7329 3a0a  nts, **kwargs):.
-0001f2c0: 2020 2020 2020 2020 666c 6174 5f66 756e          flat_fun
-0001f2d0: 632c 2066 6c61 745f 6172 6773 2c20 7370  c, flat_args, sp
-0001f2e0: 6563 203d 2066 6c61 7474 656e 5f66 756e  ec = flatten_fun
-0001f2f0: 6328 6675 6e63 2c20 7072 696d 616c 732c  c(func, primals,
-0001f300: 206b 7761 7267 7329 0a20 2020 2020 2020   kwargs).       
-0001f310: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
-0001f320: 6374 5f74 7261 6365 2829 2866 6c61 745f  ct_trace()(flat_
-0001f330: 6675 6e63 2c20 2a66 6c61 745f 6172 6773  func, *flat_args
-0001f340: 290a 2020 2020 2020 2020 7265 7375 6c74  ).        result
-0001f350: 2c20 766a 705f 7265 7375 6c74 203d 2076  , vjp_result = v
-0001f360: 6a70 5f63 616c 6c28 666c 6174 5f61 7267  jp_call(flat_arg
-0001f370: 732c 2063 6f74 616e 6765 6e74 732c 2074  s, cotangents, t
-0001f380: 7261 6365 3d74 7261 6365 290a 2020 2020  race=trace).    
-0001f390: 2020 2020 6770 7269 6d61 6c73 2c20 676b      gprimals, gk
-0001f3a0: 7761 7267 7320 3d20 7472 6565 5f75 6e66  wargs = tree_unf
-0001f3b0: 6c61 7474 656e 2876 6a70 5f72 6573 756c  latten(vjp_resul
-0001f3c0: 742c 2073 7065 6329 0a20 2020 2020 2020  t, spec).       
-0001f3d0: 2067 7261 6473 203d 2067 7072 696d 616c   grads = gprimal
-0001f3e0: 7320 2b20 2867 6b77 6172 6773 2c29 2069  s + (gkwargs,) i
-0001f3f0: 6620 6c65 6e28 676b 7761 7267 7329 2021  f len(gkwargs) !
-0001f400: 3d20 3020 656c 7365 2067 7072 696d 616c  = 0 else gprimal
-0001f410: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
-0001f420: 2072 6573 756c 742c 2067 7261 6473 0a0a   result, grads..
-0001f430: 2020 2020 7265 7475 726e 205f 766a 700a      return _vjp.
-0001f440: 0a0a 6465 6620 7661 6c75 655f 616e 645f  ..def value_and_
-0001f450: 6772 6164 2866 756e 6329 3a0a 2020 2020  grad(func):.    
-0001f460: 2222 2243 6f6d 7075 7465 7320 7468 6520  """Computes the 
-0001f470: 7661 6c75 6520 616e 6420 6772 6164 6965  value and gradie
-0001f480: 6e74 206f 6620 6120 6675 6e63 7469 6f6e  nt of a function
-0001f490: 2e0a 0a20 2020 2054 6869 7320 6973 2061  ...    This is a
-0001f4a0: 2063 6f6e 7665 6e69 656e 6365 2066 756e   convenience fun
-0001f4b0: 6374 696f 6e20 7468 6174 2063 6f6d 6269  ction that combi
-0001f4c0: 6e65 7320 7468 6520 6675 6e63 7469 6f6e  nes the function
-0001f4d0: 616c 6974 7920 6f66 0a20 2020 2060 766a  ality of.    `vj
-0001f4e0: 705f 6361 6c6c 6020 7769 7468 2069 6d70  p_call` with imp
-0001f4f0: 6c69 6369 7420 696e 6974 6961 6c69 7a61  licit initializa
-0001f500: 7469 6f6e 206f 6620 7468 6520 636f 7461  tion of the cota
-0001f510: 6e67 656e 7420 746f 2031 2e0a 0a20 2020  ngent to 1...   
-0001f520: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
-0001f530: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
-0001f540: 4675 6e63 7469 6f6e 2074 6f20 6265 2064  Function to be d
-0001f550: 6966 6665 7265 6e74 6961 7465 642e 0a20  ifferentiated.. 
-0001f560: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-0001f570: 6f6e 6573 5f6c 696b 6528 7829 3a0a 2020  ones_like(x):.  
-0001f580: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001f590: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
-0001f5a0: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
-0001f5b0: 2072 6574 7572 6e20 6675 6c6c 5f6c 696b   return full_lik
-0001f5c0: 6528 782c 2066 696c 6c5f 7661 6c75 653d  e(x, fill_value=
-0001f5d0: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
-0001f5e0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-0001f5f0: 6d62 6572 5072 6f78 7929 3a0a 2020 2020  mberProxy):.    
-0001f600: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0001f610: 7970 6528 782e 7661 6c75 6529 2831 290a  ype(x.value)(1).
-0001f620: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001f630: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001f640: 204e 6f6e 650a 0a20 2020 2064 6566 205f   None..    def _
-0001f650: 7661 6c75 655f 616e 645f 6772 6164 282a  value_and_grad(*
-0001f660: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0001f670: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
-0001f680: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
-0001f690: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
-0001f6a0: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
-0001f6b0: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
-0001f6c0: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
-0001f6d0: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
-0001f6e0: 7472 6163 652e 6f75 7470 7574 290a 2020  trace.output).  
-0001f6f0: 2020 2020 2020 7265 7475 726e 2076 6a70        return vjp
-0001f700: 2866 756e 6329 2861 7267 732c 2063 6f74  (func)(args, cot
-0001f710: 616e 6765 6e74 732c 202a 2a6b 7761 7267  angents, **kwarg
-0001f720: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
-0001f730: 7661 6c75 655f 616e 645f 6772 6164 0a0a  value_and_grad..
-0001f740: 0a46 6f72 7761 7264 4261 636b 7761 7264  .ForwardBackward
-0001f750: 5472 6163 6573 203d 206e 616d 6564 7475  Traces = namedtu
-0001f760: 706c 6528 2246 6f72 7761 7264 4261 636b  ple("ForwardBack
-0001f770: 7761 7264 5472 6163 6573 222c 205b 2266  wardTraces", ["f
-0001f780: 6f72 7761 7264 5f74 7261 6365 222c 2022  orward_trace", "
-0001f790: 6261 636b 7761 7264 5f74 7261 6365 225d  backward_trace"]
-0001f7a0: 290a 0a0a 6465 6620 5f73 706c 6974 5f73  )...def _split_s
-0001f7b0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f7c0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
-0001f7d0: 6e64 5f6f 7468 6572 280a 2020 2020 7361  nd_other(.    sa
-0001f7e0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f7f0: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
-0001f800: 626c 655d 2c0a 2920 2d3e 2074 7570 6c65  ble],.) -> tuple
-0001f810: 5b53 6571 7565 6e63 655b 5661 7269 6162  [Sequence[Variab
-0001f820: 6c65 5d2c 2053 6571 7565 6e63 655b 5661  le], Sequence[Va
-0001f830: 7269 6162 6c65 5d5d 3a0a 2020 2020 2222  riable]]:.    ""
-0001f840: 2253 706c 6974 7320 7361 7665 645f 666f  "Splits saved_fo
-0001f850: 725f 6261 636b 7761 7264 2069 6e74 6f20  r_backward into 
-0001f860: 7465 6e73 6f72 7320 616e 6420 6f74 6865  tensors and othe
-0001f870: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
-0001f880: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
-0001f890: 6261 636b 7761 7264 2028 5365 7175 656e  backward (Sequen
-0001f8a0: 6365 5b56 6172 6961 626c 655d 293a 2053  ce[Variable]): S
-0001f8b0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f8c0: 6420 746f 2073 706c 6974 2e0a 0a20 2020  d to split...   
-0001f8d0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001f8e0: 2020 7475 706c 655b 5365 7175 656e 6365    tuple[Sequence
-0001f8f0: 5b56 6172 6961 626c 655d 2c20 5365 7175  [Variable], Sequ
-0001f900: 656e 6365 5b56 6172 6961 626c 655d 5d3a  ence[Variable]]:
-0001f910: 2054 7570 6c65 206f 6620 7465 6e73 6f72   Tuple of tensor
-0001f920: 7320 616e 6420 6f74 6865 722e 0a20 2020  s and other..   
-0001f930: 2022 2222 0a20 2020 2069 735f 7465 6e73   """.    is_tens
-0001f940: 6f72 203d 206c 616d 6264 6120 783a 2069  or = lambda x: i
-0001f950: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
-0001f960: 736f 7250 726f 7879 290a 2020 2020 6f74  sorProxy).    ot
-0001f970: 6865 722c 2074 656e 736f 7273 203d 2075  her, tensors = u
-0001f980: 7469 6c73 2e70 6172 7469 7469 6f6e 2869  tils.partition(i
-0001f990: 735f 7465 6e73 6f72 2c20 7361 7665 645f  s_tensor, saved_
-0001f9a0: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
-0001f9b0: 2020 7265 7475 726e 2074 7570 6c65 2874    return tuple(t
-0001f9c0: 656e 736f 7273 292c 2074 7570 6c65 286f  ensors), tuple(o
-0001f9d0: 7468 6572 290a 0a0a 6465 6620 5f75 7064  ther)...def _upd
-0001f9e0: 6174 655f 666f 7277 6172 645f 7769 7468  ate_forward_with
-0001f9f0: 5f6e 6577 5f73 6176 6564 5f66 6f72 5f62  _new_saved_for_b
-0001fa00: 6163 6b77 6172 6428 666f 7277 6172 645f  ackward(forward_
-0001fa10: 7472 6163 653a 2054 7261 6365 2c20 7361  trace: Trace, sa
-0001fa20: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001fa30: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
-0001fa40: 626c 655d 2920 2d3e 204e 6f6e 653a 0a20  ble]) -> None:. 
-0001fa50: 2020 2022 2222 5570 6461 7465 7320 7468     """Updates th
-0001fa60: 6520 666f 7277 6172 6420 7472 6163 6520  e forward trace 
-0001fa70: 7769 7468 206e 6577 2073 6176 6564 5f66  with new saved_f
-0001fa80: 6f72 5f62 6163 6b77 6172 642e 0a0a 2020  or_backward...  
-0001fa90: 2020 5468 6973 2069 7320 6e65 6365 7373    This is necess
-0001faa0: 6172 7920 6265 6361 7573 6520 7468 6520  ary because the 
-0001fab0: 7570 6461 7465 6420 7361 7665 645f 666f  updated saved_fo
-0001fac0: 725f 6261 636b 7761 7264 2069 7320 6e6f  r_backward is no
-0001fad0: 7420 6176 6169 6c61 626c 650a 2020 2020  t available.    
-0001fae0: 7768 656e 2074 6865 2066 6f72 7761 7264  when the forward
-0001faf0: 2061 6e64 2062 6163 6b77 6172 6420 7472   and backward tr
-0001fb00: 6163 6573 2061 7265 2063 6f6e 7374 7275  aces are constru
-0001fb10: 6374 6564 2e0a 0a20 2020 2041 7267 733a  cted...    Args:
-0001fb20: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
-0001fb30: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
-0001fb40: 466f 7277 6172 6420 7472 6163 6520 746f  Forward trace to
-0001fb50: 2075 7064 6174 652e 0a20 2020 2020 2020   update..       
-0001fb60: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001fb70: 6172 6420 2853 6571 7565 6e63 655b 5661  ard (Sequence[Va
-0001fb80: 7269 6162 6c65 5d29 3a20 5361 7665 645f  riable]): Saved_
-0001fb90: 666f 725f 6261 636b 7761 7264 2074 6f20  for_backward to 
-0001fba0: 7573 6520 746f 0a20 2020 2020 2020 2020  use to.         
-0001fbb0: 2020 2075 7064 6174 6520 7468 6520 666f     update the fo
-0001fbc0: 7277 6172 6420 7472 6163 652e 0a20 2020  rward trace..   
-0001fbd0: 2022 2222 0a20 2020 2073 6176 6564 5f66   """.    saved_f
-0001fbe0: 6f72 5f62 6163 6b77 6172 6420 3d20 7472  or_backward = tr
-0001fbf0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
-0001fc00: 2078 2e76 616c 7565 2069 6620 6973 696e   x.value if isin
-0001fc10: 7374 616e 6365 2878 2c20 4e75 6d62 6572  stance(x, Number
-0001fc20: 5072 6f78 7929 2065 6c73 6520 782c 2073  Proxy) else x, s
-0001fc30: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001fc40: 6429 0a20 2020 2073 6176 6564 5f74 656e  d).    saved_ten
-0001fc50: 736f 7273 2c20 7361 7665 645f 6f74 6865  sors, saved_othe
-0001fc60: 7220 3d20 5f73 706c 6974 5f73 6176 6564  r = _split_saved
-0001fc70: 5f66 6f72 5f62 6163 6b77 6172 645f 696e  _for_backward_in
-0001fc80: 746f 5f74 656e 736f 7273 5f61 6e64 5f6f  to_tensors_and_o
-0001fc90: 7468 6572 2873 6176 6564 5f66 6f72 5f62  ther(saved_for_b
-0001fca0: 6163 6b77 6172 6429 0a20 2020 2061 7373  ackward).    ass
-0001fcb0: 6572 7420 666f 7277 6172 645f 7472 6163  ert forward_trac
-0001fcc0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
-0001fcd0: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
-0001fce0: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
-0001fcf0: 524e 0a20 2020 206e 6577 5f72 6574 7572  RN.    new_retur
-0001fd00: 6e20 3d20 2866 6f72 7761 7264 5f74 7261  n = (forward_tra
-0001fd10: 6365 2e6f 7574 7075 745b 305d 2c20 2873  ce.output[0], (s
-0001fd20: 6176 6564 5f74 656e 736f 7273 2c20 7361  aved_tensors, sa
-0001fd30: 7665 645f 6f74 6865 7229 290a 2020 2020  ved_other)).    
-0001fd40: 666f 7277 6172 645f 7472 6163 652e 626f  forward_trace.bo
-0001fd50: 756e 645f 7379 6d62 6f6c 735b 2d31 5d20  und_symbols[-1] 
-0001fd60: 3d20 7265 706c 6163 6528 666f 7277 6172  = replace(forwar
-0001fd70: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
-0001fd80: 6d62 6f6c 735b 2d31 5d2c 2061 7267 733d  mbols[-1], args=
-0001fd90: 6e65 775f 7265 7475 726e 290a 0a0a 6465  new_return)...de
-0001fda0: 6620 5f75 7064 6174 655f 6261 636b 7761  f _update_backwa
-0001fdb0: 7264 5f77 6974 685f 6e65 775f 7361 7665  rd_with_new_save
-0001fdc0: 645f 666f 725f 6261 636b 7761 7264 2862  d_for_backward(b
-0001fdd0: 6163 6b77 6172 645f 7472 6163 653a 2054  ackward_trace: T
-0001fde0: 7261 6365 2c20 7361 7665 645f 666f 725f  race, saved_for_
-0001fdf0: 6261 636b 7761 7264 3a20 5365 7175 656e  backward: Sequen
-0001fe00: 6365 5b56 6172 6961 626c 655d 2920 2d3e  ce[Variable]) ->
-0001fe10: 204e 6f6e 653a 0a20 2020 2022 2222 5570   None:.    """Up
-0001fe20: 6461 7465 7320 7468 6520 6261 636b 7761  dates the backwa
-0001fe30: 7264 2074 7261 6365 2077 6974 6820 6e65  rd trace with ne
-0001fe40: 7720 7361 7665 645f 666f 725f 6261 636b  w saved_for_back
-0001fe50: 7761 7264 2e0a 0a20 2020 2054 6869 7320  ward...    This 
-0001fe60: 6973 206e 6563 6573 7361 7279 2062 6563  is necessary bec
-0001fe70: 6175 7365 2074 6865 2075 7064 6174 6564  ause the updated
-0001fe80: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001fe90: 6172 6420 6973 0a20 2020 206e 6f74 2061  ard is.    not a
-0001fea0: 7661 696c 6162 6c65 2077 6865 6e20 7468  vailable when th
-0001feb0: 6520 6261 636b 7761 7264 2074 7261 6365  e backward trace
-0001fec0: 2069 7320 636f 6e73 7472 7563 7465 642e   is constructed.
-0001fed0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001fee0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-0001fef0: 6365 2028 5472 6163 6529 3a20 4261 636b  ce (Trace): Back
-0001ff00: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
-0001ff10: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
-0001ff20: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001ff30: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
-0001ff40: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
-0001ff50: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
-0001ff60: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-0001ff70: 7570 6461 7465 2074 6865 2062 6163 6b77  update the backw
-0001ff80: 6172 6420 7472 6163 652e 0a20 2020 2022  ard trace..    "
-0001ff90: 2222 0a0a 2020 2020 6465 6620 756e 7061  ""..    def unpa
-0001ffa0: 636b 696e 675f 666e 2873 6176 6564 5f66  cking_fn(saved_f
-0001ffb0: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
-0001ffc0: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
-0001ffd0: 2020 7061 7373 0a0a 2020 2020 636f 7461    pass..    cota
-0001ffe0: 6e67 656e 7473 203d 2062 6163 6b77 6172  ngents = backwar
-0001fff0: 645f 7472 6163 652e 6172 6773 5b31 5d0a  d_trace.args[1].
-00020000: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
-00020010: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
-00020020: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
-00020030: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
-00020040: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
-00020050: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
-00020060: 7761 7264 290a 2020 2020 756e 7061 636b  ward).    unpack
-00020070: 696e 675f 7472 6163 6520 3d20 636f 6e73  ing_trace = cons
-00020080: 7472 7563 745f 7472 6163 6528 7265 6e61  truct_trace(rena
-00020090: 6d65 5f70 726f 7869 6573 3d46 616c 7365  me_proxies=False
-000200a0: 2c20 7573 655f 6463 653d 4661 6c73 6529  , use_dce=False)
-000200b0: 280a 2020 2020 2020 2020 756e 7061 636b  (.        unpack
-000200c0: 696e 675f 666e 2c20 2873 6176 6564 5f74  ing_fn, (saved_t
-000200d0: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
-000200e0: 6865 7229 2c20 636f 7461 6e67 656e 7473  her), cotangents
-000200f0: 0a20 2020 2029 0a20 2020 2061 7373 6572  .    ).    asser
-00020100: 7420 756e 7061 636b 696e 675f 7472 6163  t unpacking_trac
-00020110: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
-00020120: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
-00020130: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
-00020140: 524e 0a0a 2020 2020 6261 636b 7761 7264  RN..    backward
-00020150: 5f74 7261 6365 2e61 7267 7320 3d20 756e  _trace.args = un
-00020160: 7061 636b 696e 675f 7472 6163 652e 6172  packing_trace.ar
-00020170: 6773 0a20 2020 2062 6163 6b77 6172 645f  gs.    backward_
-00020180: 7472 6163 655f 6273 796d 735f 7769 7468  trace_bsyms_with
-00020190: 6f75 745f 756e 7061 636b 696e 6720 3d20  out_unpacking = 
-000201a0: 280a 2020 2020 2020 2020 6273 796d 0a20  (.        bsym. 
-000201b0: 2020 2020 2020 2066 6f72 2062 7379 6d20         for bsym 
-000201c0: 696e 2062 6163 6b77 6172 645f 7472 6163  in backward_trac
-000201d0: 652e 626f 756e 645f 7379 6d62 6f6c 730a  e.bound_symbols.
-000201e0: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
-000201f0: 7379 6d2e 6964 0a20 2020 2020 2020 206e  sym.id.        n
-00020200: 6f74 2069 6e20 280a 2020 2020 2020 2020  ot in (.        
-00020210: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00020220: 732e 554e 5041 434b 5f45 4d50 5459 5f44  s.UNPACK_EMPTY_D
-00020230: 4943 542c 0a20 2020 2020 2020 2020 2020  ICT,.           
-00020240: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
-00020250: 4e50 4143 4b5f 4b45 592c 0a20 2020 2020  NPACK_KEY,.     
-00020260: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
-00020270: 6d49 4473 2e55 4e50 4143 4b5f 5345 5155  mIDs.UNPACK_SEQU
-00020280: 454e 4345 2c0a 2020 2020 2020 2020 2020  ENCE,.          
-00020290: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-000202a0: 554e 5041 434b 5f54 5249 5649 414c 2c0a  UNPACK_TRIVIAL,.
-000202b0: 2020 2020 2020 2020 290a 2020 2020 290a          ).    ).
-000202c0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-000202d0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
-000202e0: 203d 206c 6973 7428 282a 756e 7061 636b   = list((*unpack
-000202f0: 696e 675f 7472 6163 652e 626f 756e 645f  ing_trace.bound_
-00020300: 7379 6d62 6f6c 735b 3a2d 315d 2c20 2a62  symbols[:-1], *b
-00020310: 6163 6b77 6172 645f 7472 6163 655f 6273  ackward_trace_bs
-00020320: 796d 735f 7769 7468 6f75 745f 756e 7061  yms_without_unpa
-00020330: 636b 696e 6729 290a 0a0a 2320 4e4f 5445  cking))...# NOTE
-00020340: 3a20 5265 7475 726e 696e 6720 6e61 6d65  : Returning name
-00020350: 6474 7570 6c65 7320 6672 6f6d 2063 6f6d  dtuples from com
-00020360: 7069 6c65 6420 6675 6e63 7469 6f6e 7320  piled functions 
-00020370: 646f 6573 6e27 7420 776f 726b 2e20 5365  doesn't work. Se
-00020380: 653a 0a23 2022 416c 6c6f 7720 7265 7475  e:.# "Allow retu
-00020390: 726e 696e 6720 6e61 6d65 6474 7570 6c65  rning namedtuple
-000203a0: 7320 6672 6f6d 2063 6f6d 7069 6c65 6420  s from compiled 
-000203b0: 6675 6e63 7469 6f6e 7322 0a23 204e 6f74  functions".# Not
-000203c0: 6520 5b47 7261 6420 666f 7277 6172 6420  e [Grad forward 
-000203d0: 6f75 7470 7574 2073 7065 635d 0a23 2049  output spec].# I
-000203e0: 6620 6974 2064 6964 2077 6f72 6b20 6974  f it did work it
-000203f0: 2077 6f75 6c64 2062 6520 6e69 6365 2074   would be nice t
-00020400: 6f20 7573 6520 7468 6973 206e 616d 6564  o use this named
-00020410: 7475 706c 650a 2320 696e 7374 6561 6420  tuple.# instead 
-00020420: 6f66 2074 6865 2070 6c61 696e 2074 7570  of the plain tup
-00020430: 6c65 206f 7220 6469 6374 2074 6861 7420  le or dict that 
-00020440: 7765 2772 6520 7573 696e 6720 6e6f 772e  we're using now.
-00020450: 0a54 6f72 6368 4175 746f 6772 6164 466f  .TorchAutogradFo
-00020460: 7277 6172 6444 6174 6120 3d20 6e61 6d65  rwardData = name
-00020470: 6474 7570 6c65 280a 2020 2020 2254 6f72  dtuple(.    "Tor
-00020480: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
-00020490: 6444 6174 6122 2c0a 2020 2020 5b22 6f75  dData",.    ["ou
-000204a0: 7470 7574 222c 2022 666c 6174 5f61 7267  tput", "flat_arg
-000204b0: 7322 2c20 2266 6c61 745f 6f75 7470 7574  s", "flat_output
-000204c0: 225d 2c0a 290a 0a0a 6465 6620 666f 7277  "],.)...def forw
-000204d0: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
-000204e0: 5f66 726f 6d5f 7472 6163 6528 7472 6163  _from_trace(trac
-000204f0: 653a 2054 7261 6365 2c20 746f 7263 685f  e: Trace, torch_
-00020500: 6175 746f 6772 6164 3d46 616c 7365 2920  autograd=False) 
-00020510: 2d3e 2046 6f72 7761 7264 4261 636b 7761  -> ForwardBackwa
-00020520: 7264 5472 6163 6573 3a0a 2020 2020 2222  rdTraces:.    ""
-00020530: 2247 656e 6572 6174 6573 2074 6865 2066  "Generates the f
-00020540: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
-00020550: 6172 6420 7061 7373 6573 2066 726f 6d20  ard passes from 
-00020560: 6120 7472 6163 652e 0a0a 2020 2020 5468  a trace...    Th
-00020570: 6973 2069 7320 6120 636f 6e76 656e 6965  is is a convenie
-00020580: 6e63 6520 6675 6e63 7469 6f6e 2074 6861  nce function tha
-00020590: 7420 636f 6d62 696e 6573 2074 6865 2066  t combines the f
-000205a0: 756e 6374 696f 6e61 6c69 7479 206f 660a  unctionality of.
-000205b0: 2020 2020 6061 7567 6d65 6e74 6564 5f66      `augmented_f
-000205c0: 6f72 7761 7264 5f70 6173 7360 2061 6e64  orward_pass` and
-000205d0: 2060 6261 636b 7761 7264 5f70 6173 7360   `backward_pass`
-000205e0: 2e20 5468 6520 6d61 696e 2064 6966 6665  . The main diffe
-000205f0: 7265 6e63 6520 6973 2074 6861 740a 2020  rence is that.  
-00020600: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
-00020610: 646f 6573 206e 6f74 2072 6571 7569 7265  does not require
-00020620: 2074 6865 2075 7365 7220 746f 2070 726f   the user to pro
-00020630: 7669 6465 206e 6577 2069 6e70 7574 7320  vide new inputs 
-00020640: 666f 7220 7468 650a 2020 2020 7472 6163  for the.    trac
-00020650: 6520 6576 616c 7561 7469 6f6e 2e20 496e  e evaluation. In
-00020660: 7374 6561 6420 6974 2075 7365 7320 7468  stead it uses th
-00020670: 6520 696e 7075 7473 2074 6861 7420 7765  e inputs that we
-00020680: 7265 2075 7365 6420 746f 2063 6f6e 7374  re used to const
-00020690: 7275 6374 0a20 2020 2074 6865 2074 7261  ruct.    the tra
-000206a0: 6365 2e0a 0a20 2020 2041 7267 733a 0a20  ce...    Args:. 
-000206b0: 2020 2020 2020 2074 7261 6365 2028 5472         trace (Tr
-000206c0: 6163 6529 3a20 5472 6163 6520 746f 2067  ace): Trace to g
-000206d0: 656e 6572 6174 6520 7468 6520 666f 7277  enerate the forw
-000206e0: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-000206f0: 2070 6173 7365 7320 6672 6f6d 2e0a 0a20   passes from... 
-00020700: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00020710: 2020 2020 466f 7277 6172 6442 6163 6b77      ForwardBackw
-00020720: 6172 6454 7261 6365 733a 2041 206e 616d  ardTraces: A nam
-00020730: 6564 2074 7570 6c65 2063 6f6e 7461 696e  ed tuple contain
-00020740: 696e 6720 7468 6520 666f 7277 6172 6420  ing the forward 
-00020750: 616e 6420 6261 636b 7761 7264 0a20 2020  and backward.   
-00020760: 2020 2020 2020 2020 2074 7261 6365 732e           traces.
-00020770: 0a0a 2020 2020 4578 616d 706c 653a 0a20  ..    Example:. 
-00020780: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
-00020790: 7420 746f 7263 680a 2020 2020 2020 2020  t torch.        
-000207a0: 3e3e 3e20 6672 6f6d 2074 6875 6e64 6572  >>> from thunder
-000207b0: 2069 6d70 6f72 7420 636f 6d70 696c 652c   import compile,
-000207c0: 206c 6173 745f 7472 6163 6573 0a20 2020   last_traces.   
-000207d0: 2020 2020 203e 3e3e 2066 726f 6d20 7468       >>> from th
-000207e0: 756e 6465 722e 636f 7265 2e74 7261 6e73  under.core.trans
-000207f0: 666f 726d 7320 696d 706f 7274 2066 6f72  forms import for
-00020800: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
-00020810: 645f 6672 6f6d 5f74 7261 6365 0a20 2020  d_from_trace.   
-00020820: 2020 2020 203e 3e3e 2064 6566 2066 2878       >>> def f(x
-00020830: 293a 0a20 2020 2020 2020 202e 2e2e 2020  ):.        ...  
-00020840: 2020 2072 6574 7572 6e20 746f 7263 682e     return torch.
-00020850: 7369 6e28 7829 0a20 2020 2020 2020 203e  sin(x).        >
-00020860: 3e3e 2078 203d 2074 6f72 6368 2e74 656e  >> x = torch.ten
-00020870: 736f 7228 332e 3029 0a20 2020 2020 2020  sor(3.0).       
-00020880: 203e 3e3e 2063 6620 3d20 636f 6d70 696c   >>> cf = compil
-00020890: 6528 6629 0a20 2020 2020 2020 203e 3e3e  e(f).        >>>
-000208a0: 206f 7574 203d 2063 6628 7829 0a20 2020   out = cf(x).   
-000208b0: 2020 2020 203e 3e3e 2074 7261 6365 203d       >>> trace =
-000208c0: 206c 6173 745f 7472 6163 6573 2863 6629   last_traces(cf)
-000208d0: 5b30 5d0a 2020 2020 2020 2020 3e3e 3e20  [0].        >>> 
-000208e0: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
-000208f0: 7761 7264 5f66 726f 6d5f 7472 6163 6528  ward_from_trace(
-00020900: 7472 6163 6529 0a20 2020 2020 2020 202e  trace).        .
-00020910: 2e2e 2046 6f72 7761 7264 4261 636b 7761  .. ForwardBackwa
-00020920: 7264 5472 6163 6573 280a 2020 2020 2020  rdTraces(.      
-00020930: 2020 2e2e 2e20 666f 7277 6172 645f 7472    ... forward_tr
-00020940: 6163 653d 2320 696d 706f 7274 2074 6875  ace=# import thu
-00020950: 6e64 6572 2061 7320 7468 756e 6465 720a  nder as thunder.
-00020960: 2020 2020 2020 2020 2e2e 2e20 2320 696d          ... # im
-00020970: 706f 7274 2074 6875 6e64 6572 2e63 6f72  port thunder.cor
-00020980: 652e 7072 696d 7320 6173 2070 7269 6d73  e.prims as prims
-00020990: 0a20 2020 2020 2020 202e 2e2e 2069 6d70  .        ... imp
-000209a0: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
-000209b0: 2020 2e2e 2e0a 2020 2020 2020 2020 2e2e    ....        ..
-000209c0: 2e20 4074 6f72 6368 2e6e 6f5f 6772 6164  . @torch.no_grad
-000209d0: 2829 0a20 2020 2020 2020 202e 2e2e 2064  ().        ... d
-000209e0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
-000209f0: 7761 7264 5f66 6e28 2a61 7267 7329 3a0a  ward_fn(*args):.
-00020a00: 2020 2020 2020 2020 2e2e 2e20 2020 2320          ...   # 
-00020a10: 6172 6773 3a20 2243 6f6c 6c65 6374 696f  args: "Collectio
-00020a20: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
-00020a30: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
-00020a40: 2020 2020 2020 2e2e 2e20 2020 7430 2c20        ...   t0, 
-00020a50: 5c0a 2020 2020 2020 2020 2e2e 2e20 2020  \.        ...   
-00020a60: 3d20 6172 6773 0a20 2020 2020 2020 202e  = args.        .
-00020a70: 2e2e 2020 2074 3120 3d20 7072 696d 732e  ..   t1 = prims.
-00020a80: 7369 6e28 7430 2920 2023 2074 313a 2022  sin(t0)  # t1: "
-00020a90: 6370 7520 6633 325b 5d22 0a20 2020 2020  cpu f32[]".     
-00020aa0: 2020 202e 2e2e 2020 2072 6574 7572 6e20     ...   return 
-00020ab0: 7431 2c20 2874 302c 292c 0a20 2020 2020  t1, (t0,),.     
-00020ac0: 2020 202e 2e2e 2062 6163 6b77 6172 645f     ... backward_
-00020ad0: 7472 6163 653d 2320 696d 706f 7274 2074  trace=# import t
-00020ae0: 6875 6e64 6572 2061 7320 7468 756e 6465  hunder as thunde
-00020af0: 720a 2020 2020 2020 2020 2e2e 2e20 2320  r.        ... # 
-00020b00: 696d 706f 7274 2074 6875 6e64 6572 2e63  import thunder.c
-00020b10: 6f72 652e 7072 696d 7320 6173 2070 7269  ore.prims as pri
-00020b20: 6d73 0a20 2020 2020 2020 202e 2e2e 2069  ms.        ... i
-00020b30: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
-00020b40: 2020 2020 2e2e 2e0a 2020 2020 2020 2020      ....        
-00020b50: 2e2e 2e20 4074 6f72 6368 2e6e 6f5f 6772  ... @torch.no_gr
-00020b60: 6164 2829 0a20 2020 2020 2020 202e 2e2e  ad().        ...
-00020b70: 2064 6566 2062 6163 6b77 6172 645f 666e   def backward_fn
-00020b80: 2873 6176 6564 5f66 6f72 5f62 6163 6b77  (saved_for_backw
-00020b90: 6172 642c 2063 6f74 616e 6765 6e74 7329  ard, cotangents)
-00020ba0: 3a0a 2020 2020 2020 2020 2e2e 2e20 2020  :.        ...   
-00020bb0: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
-00020bc0: 7761 7264 3a20 2243 6f6c 6c65 6374 696f  ward: "Collectio
-00020bd0: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
-00020be0: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
-00020bf0: 2020 2020 2020 2e2e 2e20 2020 2320 636f        ...   # co
-00020c00: 7461 6e67 656e 7473 3a20 2263 7075 2066  tangents: "cpu f
-00020c10: 3332 5b5d 2220 3d20 2063 6f74 616e 6765  32[]" =  cotange
-00020c20: 6e74 7320 2028 7472 6976 6961 6c20 756e  nts  (trivial un
-00020c30: 7061 636b 290a 2020 2020 2020 2020 2e2e  pack).        ..
-00020c40: 2e20 2020 7430 2c20 5c0a 2020 2020 2020  .   t0, \.      
-00020c50: 2020 2e2e 2e20 2020 3d20 7361 7665 645f    ...   = saved_
-00020c60: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
-00020c70: 2020 2020 202e 2e2e 2020 2074 3120 3d20       ...   t1 = 
-00020c80: 7072 696d 732e 636f 7328 7430 2920 2023  prims.cos(t0)  #
-00020c90: 2074 313a 2022 6370 7520 6633 325b 5d22   t1: "cpu f32[]"
-00020ca0: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
-00020cb0: 3220 3d20 7072 696d 732e 6d75 6c28 636f  2 = prims.mul(co
-00020cc0: 7461 6e67 656e 7473 2c20 7431 2920 2023  tangents, t1)  #
-00020cd0: 2074 323a 2022 6370 7520 6633 325b 5d22   t2: "cpu f32[]"
-00020ce0: 0a20 2020 2020 2020 202e 2e2e 2020 2072  .        ...   r
-00020cf0: 6574 7572 6e20 2874 322c 2929 0a20 2020  eturn (t2,)).   
-00020d00: 2022 2222 0a0a 2020 2020 6f75 7470 7574   """..    output
-00020d10: 5f73 7065 6320 3d20 4e6f 6e65 0a0a 2020  _spec = None..  
-00020d20: 2020 6465 6620 6175 676d 656e 7465 645f    def augmented_
-00020d30: 666f 7277 6172 645f 666e 282a 6172 6773  forward_fn(*args
-00020d40: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00020d50: 2020 2020 2072 6573 756c 742c 2065 6e76       result, env
-00020d60: 203d 2061 7567 6d65 6e74 6564 5f66 6f72   = augmented_for
-00020d70: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
-00020d80: 2074 7261 6365 3d74 7261 6365 2c20 2a2a   trace=trace, **
-00020d90: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-00020da0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00020db0: 7264 203d 2064 6563 6f6e 7374 7275 6374  rd = deconstruct
-00020dc0: 5f66 6f72 7761 7264 5f65 6e76 5f66 6f72  _forward_env_for
-00020dd0: 5f62 6163 6b77 6172 6428 7472 6163 652c  _backward(trace,
-00020de0: 2065 6e76 290a 2020 2020 2020 2020 6966   env).        if
-00020df0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
-00020e00: 0a20 2020 2020 2020 2020 2020 206e 6f6e  .            non
-00020e10: 6c6f 6361 6c20 6f75 7470 7574 5f73 7065  local output_spe
-00020e20: 630a 2020 2020 2020 2020 2020 2020 666c  c.            fl
-00020e30: 6174 5f61 7267 732c 205f 203d 2074 7265  at_args, _ = tre
-00020e40: 655f 666c 6174 7465 6e28 2861 7267 732c  e_flatten((args,
-00020e50: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
-00020e60: 2020 2020 2020 666c 6174 5f6f 7574 7075        flat_outpu
-00020e70: 742c 206f 7574 7075 745f 7370 6563 203d  t, output_spec =
-00020e80: 2074 7265 655f 666c 6174 7465 6e28 7265   tree_flatten(re
-00020e90: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
-00020ea0: 2020 666c 6174 5f6f 7574 7075 7420 3d20    flat_output = 
-00020eb0: 7475 706c 6528 666c 6174 5f6f 7574 7075  tuple(flat_outpu
-00020ec0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
-00020ed0: 2053 6565 204e 6f74 6520 5b47 7261 6420   See Note [Grad 
-00020ee0: 666f 7277 6172 6420 6f75 7470 7574 2073  forward output s
-00020ef0: 7065 635d 0a20 2020 2020 2020 2020 2020  pec].           
-00020f00: 2066 6f72 5f61 7574 6f67 7261 6420 3d20   for_autograd = 
-00020f10: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
-00020f20: 7761 7264 4461 7461 280a 2020 2020 2020  wardData(.      
-00020f30: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00020f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020f50: 2020 666c 6174 5f61 7267 732c 0a20 2020    flat_args,.   
-00020f60: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
-00020f70: 745f 6f75 7470 7574 2c0a 2020 2020 2020  t_output,.      
-00020f80: 2020 2020 2020 292e 5f61 7364 6963 7428        )._asdict(
-00020f90: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00020fa0: 7475 726e 2028 666f 725f 6175 746f 6772  turn (for_autogr
-00020fb0: 6164 2c20 7361 7665 645f 666f 725f 6261  ad, saved_for_ba
-00020fc0: 636b 7761 7264 290a 2020 2020 2020 2020  ckward).        
-00020fd0: 7265 7475 726e 2072 6573 756c 742c 2073  return result, s
-00020fe0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00020ff0: 640a 0a20 2020 2023 2043 6f70 7920 7468  d..    # Copy th
-00021000: 6520 7369 676e 6174 7572 6520 6f66 2074  e signature of t
-00021010: 6865 206f 7269 6769 6e61 6c20 6675 6e63  he original func
-00021020: 7469 6f6e 2073 6f20 7468 6174 2074 6865  tion so that the
-00021030: 2061 7267 756d 656e 7473 2061 7265 0a20   arguments are. 
-00021040: 2020 2023 206e 616d 6564 2063 6f72 7265     # named corre
-00021050: 6374 6c79 2069 6e20 7468 6520 6175 676d  ctly in the augm
-00021060: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
-00021070: 7373 2069 6e73 7465 6164 206f 6620 6265  ss instead of be
-00021080: 696e 6720 6e61 6d65 640a 2020 2020 2320  ing named.    # 
-00021090: 2261 7267 7322 2061 6e64 2022 6b77 6172  "args" and "kwar
-000210a0: 6773 222e 0a20 2020 2061 7567 6d65 6e74  gs"..    augment
-000210b0: 6564 5f66 6f72 7761 7264 5f66 6e2e 5f5f  ed_forward_fn.__
-000210c0: 7369 676e 6174 7572 655f 5f20 3d20 696e  signature__ = in
-000210d0: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
-000210e0: 7472 6163 652e 666e 206f 7220 7472 6163  trace.fn or trac
-000210f0: 652e 7079 7468 6f6e 5f63 616c 6c61 626c  e.python_callabl
-00021100: 6528 2929 0a0a 2020 2020 6465 6620 6f6e  e())..    def on
-00021110: 6573 5f6c 696b 6528 7829 3a0a 2020 2020  es_like(x):.    
-00021120: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00021130: 6528 782c 2054 656e 736f 7250 726f 7879  e(x, TensorProxy
-00021140: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00021150: 6574 7572 6e20 6675 6c6c 5f6c 696b 6528  eturn full_like(
-00021160: 782c 2066 696c 6c5f 7661 6c75 653d 3129  x, fill_value=1)
-00021170: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
-00021180: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
-00021190: 6572 5072 6f78 7929 3a0a 2020 2020 2020  erProxy):.      
-000211a0: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
-000211b0: 6528 782e 7661 6c75 6529 2831 290a 2020  e(x.value)(1).  
-000211c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000211d0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-000211e0: 6f6e 650a 0a20 2020 2066 6f72 7761 7264  one..    forward
-000211f0: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
-00021200: 6374 5f74 7261 6365 2829 2861 7567 6d65  ct_trace()(augme
-00021210: 6e74 6564 5f66 6f72 7761 7264 5f66 6e2c  nted_forward_fn,
-00021220: 202a 7472 6163 652e 6172 6773 2c20 2a2a   *trace.args, **
-00021230: 7472 6163 652e 6b77 6172 6773 290a 2020  trace.kwargs).  
-00021240: 2020 2320 5765 2073 6574 2066 6f72 7761    # We set forwa
-00021250: 7264 2074 7261 6365 2074 6f20 636f 6e73  rd trace to cons
-00021260: 7472 7563 7420 7072 6f78 6965 7320 6265  truct proxies be
-00021270: 6361 7573 6520 7765 206e 6565 6420 7468  cause we need th
-00021280: 6573 6520 7072 6f78 6965 7320 746f 0a20  ese proxies to. 
-00021290: 2020 2023 2068 6176 6520 6469 6666 6572     # have differ
-000212a0: 656e 7420 6e61 6d65 7320 7468 616e 2074  ent names than t
-000212b0: 6865 206f 6e65 7320 696e 2074 6865 2066  he ones in the f
-000212c0: 6f72 7761 7264 2074 7261 6365 2e0a 2020  orward trace..  
-000212d0: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
-000212e0: 7261 6365 6374 785f 746f 6b65 6e20 3d20  racectx_token = 
-000212f0: 7365 745f 7472 6163 6563 7478 2866 6f72  set_tracectx(for
-00021300: 7761 7264 5f74 7261 6365 290a 2020 2020  ward_trace).    
-00021310: 2020 2020 2320 5765 2064 6f6e 2774 2077      # We don't w
-00021320: 616e 7420 746f 2072 6563 6f72 6420 7468  ant to record th
-00021330: 6f73 6520 6f6e 6573 5f6c 696b 6520 6361  ose ones_like ca
-00021340: 6c6c 7320 696e 2074 6865 2066 6f72 7761  lls in the forwa
-00021350: 7264 2074 7261 6365 2e0a 2020 2020 2020  rd trace..      
-00021360: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
-00021370: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
-00021380: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
-00021390: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
-000213a0: 2020 2020 2020 2020 2320 4974 2773 2061          # It's a
-000213b0: 7373 756d 6564 2074 6861 7420 666f 7277  ssumed that forw
-000213c0: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
-000213d0: 5b30 5d20 6973 2061 2064 6963 7420 6672  [0] is a dict fr
-000213e0: 6f6d 2054 6f72 6368 4175 746f 6772 6164  om TorchAutograd
-000213f0: 466f 7277 6172 6444 6174 610a 2020 2020  ForwardData.    
-00021400: 2020 2020 2020 2020 2020 2020 666c 6174              flat
-00021410: 5f6f 7574 7075 7420 3d20 666f 7277 6172  _output = forwar
-00021420: 645f 7472 6163 652e 6f75 7470 7574 5b30  d_trace.output[0
-00021430: 5d5b 2266 6c61 745f 6f75 7470 7574 225d  ]["flat_output"]
-00021440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021450: 2063 6f74 616e 6765 6e74 7320 3d20 7574   cotangents = ut
-00021460: 696c 732e 7365 7175 656e 6369 6679 2874  ils.sequencify(t
-00021470: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
-00021480: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
-00021490: 666c 6174 5f6f 7574 7075 7429 290a 2020  flat_output)).  
-000214a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000214b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000214c0: 636f 7461 6e67 656e 7473 203d 2075 7469  cotangents = uti
-000214d0: 6c73 2e73 6571 7565 6e63 6966 7928 7472  ls.sequencify(tr
-000214e0: 6565 5f6d 6170 286c 616d 6264 6120 763a  ee_map(lambda v:
-000214f0: 206f 6e65 735f 6c69 6b65 2876 292c 2074   ones_like(v), t
-00021500: 7261 6365 2e6f 7574 7075 7429 290a 2020  race.output)).  
-00021510: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
-00021520: 2020 2072 6573 6574 5f74 7261 6365 6374     reset_tracect
-00021530: 7828 7472 6163 6563 7478 5f74 6f6b 656e  x(tracectx_token
-00021540: 290a 0a20 2020 2064 6566 2062 6163 6b77  )..    def backw
-00021550: 6172 645f 666e 2873 6176 6564 5f66 6f72  ard_fn(saved_for
-00021560: 5f62 6163 6b77 6172 642c 2063 6f74 616e  _backward, cotan
-00021570: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
-00021580: 656e 7620 3d20 7265 636f 6e73 7472 7563  env = reconstruc
-00021590: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
-000215a0: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
-000215b0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-000215c0: 7761 7264 290a 2020 2020 2020 2020 6966  ward).        if
-000215d0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
-000215e0: 0a20 2020 2020 2020 2020 2020 2063 6f74  .            cot
-000215f0: 616e 6765 6e74 7320 3d20 7472 6565 5f75  angents = tree_u
-00021600: 6e66 6c61 7474 656e 2863 6f74 616e 6765  nflatten(cotange
-00021610: 6e74 732c 206f 7574 7075 745f 7370 6563  nts, output_spec
-00021620: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
-00021630: 6261 636b 7761 7264 5f70 6173 7328 656e  backward_pass(en
-00021640: 762c 2074 7261 6365 2c20 636f 7461 6e67  v, trace, cotang
-00021650: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
-00021660: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
-00021670: 0a20 2020 2020 2020 2020 2020 2067 6b77  .            gkw
-00021680: 6172 6773 203d 206f 7574 5b2d 315d 2069  args = out[-1] i
-00021690: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
-000216a0: 5b2d 315d 2c20 6469 6374 2920 656c 7365  [-1], dict) else
-000216b0: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-000216c0: 6761 7267 7320 3d20 6f75 745b 3a2d 315d  gargs = out[:-1]
-000216d0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-000216e0: 7574 5b2d 315d 2c20 6469 6374 2920 656c  ut[-1], dict) el
-000216f0: 7365 206f 7574 0a20 2020 2020 2020 2020  se out.         
-00021700: 2020 2067 6b77 6172 6773 203d 207b 6b3a     gkwargs = {k:
-00021710: 2067 6b77 6172 6773 2e67 6574 286b 2c20   gkwargs.get(k, 
-00021720: 4e6f 6e65 2920 666f 7220 6b20 696e 2074  None) for k in t
-00021730: 7261 6365 2e6b 7761 7267 737d 0a20 2020  race.kwargs}.   
-00021740: 2020 2020 2020 2020 206f 7574 203d 2028           out = (
-00021750: 2a67 6172 6773 2c20 676b 7761 7267 7329  *gargs, gkwargs)
-00021760: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-00021770: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00021780: 6f75 7429 5b30 5d0a 2020 2020 2020 2020  out)[0].        
-00021790: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
-000217a0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-000217b0: 7264 203d 2066 6f72 7761 7264 5f74 7261  rd = forward_tra
-000217c0: 6365 2e6f 7574 7075 745b 315d 0a20 2020  ce.output[1].   
-000217d0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
-000217e0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-000217f0: 6528 7265 6e61 6d65 5f70 726f 7869 6573  e(rename_proxies
-00021800: 3d46 616c 7365 2928 6261 636b 7761 7264  =False)(backward
-00021810: 5f66 6e2c 2073 6176 6564 5f66 6f72 5f62  _fn, saved_for_b
-00021820: 6163 6b77 6172 642c 2063 6f74 616e 6765  ackward, cotange
-00021830: 6e74 7329 0a0a 2020 2020 2320 5765 2061  nts)..    # We a
-00021840: 7265 2064 6f6e 6520 7769 7468 2063 6f6e  re done with con
-00021850: 7374 7275 6374 696e 6720 7468 6520 666f  structing the fo
-00021860: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
-00021870: 7264 2070 6173 7365 7320 6174 2074 6869  rd passes at thi
-00021880: 730a 2020 2020 2320 7374 6167 652e 2054  s.    # stage. T
-00021890: 6865 2066 6f6c 6c6f 7769 6e67 2069 7320  he following is 
-000218a0: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
-000218b0: 6573 7361 7279 2c20 6275 7420 6974 2773  essary, but it's
-000218c0: 2067 6f6f 6420 746f 2066 696c 7465 720a   good to filter.
-000218d0: 2020 2020 2320 6f75 7420 7468 6520 756e      # out the un
-000218e0: 7573 6564 2065 6c65 6d65 6e74 7320 6f66  used elements of
-000218f0: 2074 6865 2073 6176 6564 5f66 6f72 5f62   the saved_for_b
-00021900: 6163 6b77 6172 6420 616e 6420 666c 6174  ackward and flat
-00021910: 7465 6e20 6974 2066 6f72 206d 6f72 650a  ten it for more.
-00021920: 2020 2020 2320 636f 6d70 6163 7420 6261      # compact ba
-00021930: 636b 7761 7264 2074 7261 6365 2e0a 0a20  ckward trace... 
-00021940: 2020 2023 204e 6f77 2077 6520 6361 6e20     # Now we can 
-00021950: 6465 7465 726d 696e 6520 6578 6163 746c  determine exactl
-00021960: 7920 7768 6174 2773 2075 7365 6420 696e  y what's used in
-00021970: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
-00021980: 7373 2066 726f 6d20 7468 650a 2020 2020  ss from the.    
-00021990: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
-000219a0: 7761 7264 2e20 5765 2063 616e 2066 6c61  ward. We can fla
-000219b0: 7474 656e 2061 6e64 2066 696c 7465 7220  tten and filter 
-000219c0: 7468 6520 7361 7665 645f 666f 725f 6261  the saved_for_ba
-000219d0: 636b 7761 7264 0a20 2020 2063 6f6e 7375  ckward.    consu
-000219e0: 6d65 7273 203d 2075 7469 6c73 2e63 6f6e  mers = utils.con
-000219f0: 7375 6d65 7273 2862 6163 6b77 6172 645f  sumers(backward_
-00021a00: 7472 6163 6529 0a0a 2020 2020 2320 466f  trace)..    # Fo
-00021a10: 7277 6172 6427 7320 616e 6420 6261 636b  rward's and back
-00021a20: 7761 7264 2773 2022 7361 7665 645f 666f  ward's "saved_fo
-00021a30: 725f 6261 636b 7761 7264 2220 6172 6520  r_backward" are 
-00021a40: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
-00021a50: 7468 6520 7361 6d65 0a20 2020 2023 2061  the same.    # a
-00021a60: 7320 7468 6520 7361 7665 645f 666f 725f  s the saved_for_
-00021a70: 6261 636b 7761 7264 2c20 6265 6361 7573  backward, becaus
-00021a80: 6520 736f 6d65 206f 7220 616c 6c20 656c  e some or all el
-00021a90: 656d 656e 7473 206f 6620 7468 650a 2020  ements of the.  
-00021aa0: 2020 2320 7361 7665 645f 666f 725f 6261    # saved_for_ba
-00021ab0: 636b 7761 7264 2072 6573 756c 7473 206d  ckward results m
-00021ac0: 6967 6874 2062 6520 7265 2d70 726f 7869  ight be re-proxi
-00021ad0: 6669 6564 2e0a 2020 2020 6277 5f66 6c61  fied..    bw_fla
-00021ae0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
-00021af0: 7761 7264 2c20 7370 6563 203d 2074 7265  ward, spec = tre
-00021b00: 655f 666c 6174 7465 6e28 6261 636b 7761  e_flatten(backwa
-00021b10: 7264 5f74 7261 6365 2e61 7267 735b 305d  rd_trace.args[0]
-00021b20: 290a 2020 2020 6677 5f66 6c61 745f 7361  ).    fw_flat_sa
-00021b30: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00021b40: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
-00021b50: 656e 2866 6f72 7761 7264 5f74 7261 6365  en(forward_trace
-00021b60: 2e6f 7574 7075 745b 315d 290a 2020 2020  .output[1]).    
-00021b70: 7573 6564 5f6d 6173 6b20 3d20 6c69 7374  used_mask = list
-00021b80: 286c 656e 2863 6f6e 7375 6d65 7273 2e67  (len(consumers.g
-00021b90: 6574 2878 2c20 2829 2929 203e 2030 2066  et(x, ())) > 0 f
-00021ba0: 6f72 2078 2069 6e20 6277 5f66 6c61 745f  or x in bw_flat_
-00021bb0: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00021bc0: 7264 290a 0a20 2020 2023 2044 6f6e 2774  rd)..    # Don't
-00021bd0: 2075 7365 2074 6865 2073 616d 6520 7661   use the same va
-00021be0: 7269 6162 6c65 2074 7769 6365 2069 6e20  riable twice in 
-00021bf0: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
-00021c00: 730a 2020 2020 7365 656e 203d 2073 6574  s.    seen = set
-00021c10: 2829 0a20 2020 2066 726f 6d20 7468 756e  ().    from thun
-00021c20: 6465 722e 636f 7265 2e70 726f 7869 6573  der.core.proxies
-00021c30: 2069 6d70 6f72 7420 5661 7269 6162 6c65   import Variable
-00021c40: 0a0a 2020 2020 666f 7220 692c 2078 2069  ..    for i, x i
-00021c50: 6e20 656e 756d 6572 6174 6528 6677 5f66  n enumerate(fw_f
-00021c60: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
-00021c70: 636b 7761 7264 293a 0a20 2020 2020 2020  ckward):.       
-00021c80: 2078 203d 2076 6172 6961 626c 6569 6679   x = variableify
-00021c90: 2878 290a 2020 2020 2020 2020 6966 206e  (x).        if n
-00021ca0: 6f74 2069 7369 6e73 7461 6e63 6528 782c  ot isinstance(x,
-00021cb0: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
-00021cc0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00021cd0: 0a20 2020 2020 2020 2069 6620 7820 696e  .        if x in
-00021ce0: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
-00021cf0: 2020 2075 7365 645f 6d61 736b 5b69 5d20     used_mask[i] 
-00021d00: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00021d10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00021d20: 2020 7365 656e 2e61 6464 2878 290a 0a20    seen.add(x).. 
-00021d30: 2020 206f 6e6c 795f 7573 6564 5f66 775f     only_used_fw_
-00021d40: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
-00021d50: 7264 203d 2074 7570 6c65 2863 6f6d 7072  rd = tuple(compr
-00021d60: 6573 7328 6677 5f66 6c61 745f 7361 7665  ess(fw_flat_save
-00021d70: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
-00021d80: 7573 6564 5f6d 6173 6b29 290a 2020 2020  used_mask)).    
-00021d90: 6f6e 6c79 5f75 7365 645f 6277 5f73 6176  only_used_bw_sav
-00021da0: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00021db0: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
-00021dc0: 2862 775f 666c 6174 5f73 6176 6564 5f66  (bw_flat_saved_f
-00021dd0: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
-00021de0: 645f 6d61 736b 2929 0a0a 2020 2020 2320  d_mask))..    # 
-00021df0: 5765 206e 6565 6420 746f 2075 7064 6174  We need to updat
-00021e00: 6520 7468 6520 7472 6163 6573 2077 6974  e the traces wit
-00021e10: 6820 7468 6520 6e65 7720 7361 7665 645f  h the new saved_
-00021e20: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
-00021e30: 205f 7570 6461 7465 5f66 6f72 7761 7264   _update_forward
-00021e40: 5f77 6974 685f 6e65 775f 7361 7665 645f  _with_new_saved_
-00021e50: 666f 725f 6261 636b 7761 7264 2866 6f72  for_backward(for
-00021e60: 7761 7264 5f74 7261 6365 2c20 6f6e 6c79  ward_trace, only
-00021e70: 5f75 7365 645f 6677 5f73 6176 6564 5f66  _used_fw_saved_f
-00021e80: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
-00021e90: 205f 7570 6461 7465 5f62 6163 6b77 6172   _update_backwar
-00021ea0: 645f 7769 7468 5f6e 6577 5f73 6176 6564  d_with_new_saved
-00021eb0: 5f66 6f72 5f62 6163 6b77 6172 6428 6261  _for_backward(ba
-00021ec0: 636b 7761 7264 5f74 7261 6365 2c20 6f6e  ckward_trace, on
-00021ed0: 6c79 5f75 7365 645f 6277 5f73 6176 6564  ly_used_bw_saved
-00021ee0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
-00021ef0: 2020 2066 6f72 7761 7264 5f74 7261 6365     forward_trace
-00021f00: 2e73 6574 5f70 726f 7665 6e61 6e63 6528  .set_provenance(
-00021f10: 5472 6163 6550 726f 7665 6e61 6e63 6528  TraceProvenance(
-00021f20: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
-00021f30: 7264 2070 6173 7322 2929 0a20 2020 2062  rd pass")).    b
-00021f40: 6163 6b77 6172 645f 7472 6163 652e 7365  ackward_trace.se
-00021f50: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
-00021f60: 6365 5072 6f76 656e 616e 6365 2822 4261  ceProvenance("Ba
-00021f70: 636b 7761 7264 2070 6173 7322 2929 0a20  ckward pass")). 
-00021f80: 2020 2072 6574 7572 6e20 466f 7277 6172     return Forwar
-00021f90: 6442 6163 6b77 6172 6454 7261 6365 7328  dBackwardTraces(
-00021fa0: 666f 7277 6172 645f 7472 6163 652c 2062  forward_trace, b
-00021fb0: 6163 6b77 6172 645f 7472 6163 6529 0a0a  ackward_trace)..
-00021fc0: 0a23 2064 6f20 7765 2068 6170 7065 6e20  .# do we happen 
-00021fd0: 746f 2077 616e 7420 746f 2072 6567 6973  to want to regis
-00021fe0: 7465 7220 606c 746f 7263 6860 206f 7073  ter `ltorch` ops
-00021ff0: 2073 7563 6820 6173 2060 6c74 6f72 6368   such as `ltorch
-00022000: 2e6c 6179 6572 5f6e 6f72 6d60 2061 7320  .layer_norm` as 
-00022010: 7765 6c6c 3f0a 6175 746f 6361 7374 5f69  well?.autocast_i
-00022020: 6d70 6c73 3a20 6469 6374 5b70 7269 6d73  mpls: dict[prims
-00022030: 2e50 7269 6d49 4473 2c20 4361 6c6c 6162  .PrimIDs, Callab
-00022040: 6c65 5d20 3d20 7b7d 0a0a 0a64 6566 2072  le] = {}...def r
-00022050: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
-00022060: 5f72 756c 6528 6f70 293a 0a20 2020 2064  _rule(op):.    d
-00022070: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
-00022080: 6329 3a0a 2020 2020 2020 2020 6175 746f  c):.        auto
-00022090: 6361 7374 5f69 6d70 6c73 5b6f 705d 203d  cast_impls[op] =
-000220a0: 2066 756e 630a 2020 2020 2020 2020 7265   func.        re
-000220b0: 7475 726e 2066 756e 630a 0a20 2020 2072  turn func..    r
-000220c0: 6574 7572 6e20 6465 636f 7261 746f 720a  eturn decorator.
-000220d0: 0a0a 6465 6620 6d61 7962 655f 646f 776e  ..def maybe_down
-000220e0: 6361 7374 5f74 6f28 6474 7970 652c 2061  cast_to(dtype, a
-000220f0: 7267 7329 3a0a 2020 2020 616c 6c6f 7765  rgs):.    allowe
-00022100: 645f 646f 776e 6361 7374 5f74 7970 6573  d_downcast_types
-00022110: 203d 2028 6474 7970 6573 2e66 6c6f 6174   = (dtypes.float
-00022120: 3136 2c20 6474 7970 6573 2e62 666c 6f61  16, dtypes.bfloa
-00022130: 7431 362c 2064 7479 7065 732e 666c 6f61  t16, dtypes.floa
-00022140: 7433 3229 0a0a 2020 2020 6465 6620 6d61  t32)..    def ma
-00022150: 705f 666e 2861 293a 0a20 2020 2020 2020  p_fn(a):.       
-00022160: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-00022170: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
-00022180: 6e64 2061 2e64 7479 7065 2069 6e20 616c  nd a.dtype in al
-00022190: 6c6f 7765 645f 646f 776e 6361 7374 5f74  lowed_downcast_t
-000221a0: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
-000221b0: 2020 7265 7475 726e 206d 6179 6265 5f63    return maybe_c
-000221c0: 6f6e 7665 7274 5f74 6f5f 6474 7970 6528  onvert_to_dtype(
-000221d0: 612c 2064 7479 7065 290a 2020 2020 2020  a, dtype).      
-000221e0: 2020 7265 7475 726e 2061 0a0a 2020 2020    return a..    
-000221f0: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
-00022200: 6d61 705f 666e 2c20 6172 6773 290a 0a0a  map_fn, args)...
-00022210: 4072 6567 6973 7465 725f 6175 746f 6361  @register_autoca
-00022220: 7374 5f72 756c 6528 2274 6f72 6368 2e6d  st_rule("torch.m
-00022230: 6174 6d75 6c22 290a 4072 6567 6973 7465  atmul").@registe
-00022240: 725f 6175 746f 6361 7374 5f72 756c 6528  r_autocast_rule(
-00022250: 7072 696d 732e 5072 696d 4944 732e 4d41  prims.PrimIDs.MA
-00022260: 544d 554c 290a 6465 6620 6175 746f 6361  TMUL).def autoca
-00022270: 7374 5f6d 6174 6d75 6c5f 7275 6c65 2861  st_matmul_rule(a
-00022280: 2c20 622c 2064 7479 7065 293a 0a20 2020  , b, dtype):.   
-00022290: 2022 2222 4175 746f 6361 7374 2072 756c   """Autocast rul
-000222a0: 6520 666f 7220 6d61 746d 756c 2222 220a  e for matmul""".
-000222b0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
-000222c0: 2e6d 6174 6d75 6c28 2a28 6d61 7962 655f  .matmul(*(maybe_
-000222d0: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
-000222e0: 652c 2028 612c 2062 2929 2929 0a0a 0a40  e, (a, b))))...@
-000222f0: 7265 6769 7374 6572 5f61 7574 6f63 6173  register_autocas
-00022300: 745f 7275 6c65 2822 746f 7263 682e 6e6e  t_rule("torch.nn
-00022310: 2e66 756e 6374 696f 6e61 6c2e 6c69 6e65  .functional.line
-00022320: 6172 2229 0a40 7265 6769 7374 6572 5f61  ar").@register_a
-00022330: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
-00022340: 6d73 2e50 7269 6d49 4473 2e4c 494e 4541  ms.PrimIDs.LINEA
-00022350: 5229 0a64 6566 2061 7574 6f63 6173 745f  R).def autocast_
-00022360: 6c69 6e65 6172 5f72 756c 6528 612c 2077  linear_rule(a, w
-00022370: 2c20 6269 6173 2c20 6474 7970 6529 3a0a  , bias, dtype):.
-00022380: 2020 2020 6966 2062 6961 7320 6973 204e      if bias is N
-00022390: 6f6e 653a 0a20 2020 2020 2020 2023 2044  one:.        # D
-000223a0: 6f6e 2774 2070 6173 7320 6062 6961 7360  on't pass `bias`
-000223b0: 2074 6f20 6d61 7962 655f 646f 776e 6361   to maybe_downca
-000223c0: 7374 5f74 6f2e 0a20 2020 2020 2020 2064  st_to..        d
-000223d0: 6f77 6e63 6173 745f 6172 6773 203d 206d  owncast_args = m
-000223e0: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
-000223f0: 2864 7479 7065 2c20 2861 2c20 7729 2920  (dtype, (a, w)) 
-00022400: 2b20 2862 6961 732c 290a 2020 2020 656c  + (bias,).    el
-00022410: 7365 3a0a 2020 2020 2020 2020 646f 776e  se:.        down
-00022420: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
-00022430: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
-00022440: 7970 652c 2028 612c 2077 2c20 6269 6173  ype, (a, w, bias
-00022450: 2929 0a0a 2020 2020 7265 7475 726e 2070  ))..    return p
-00022460: 7269 6d73 2e6c 696e 6561 7228 2a64 6f77  rims.linear(*dow
-00022470: 6e63 6173 745f 6172 6773 290a 0a0a 4072  ncast_args)...@r
-00022480: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
-00022490: 5f72 756c 6528 2274 6f72 6368 2e6e 6e2e  _rule("torch.nn.
-000224a0: 6675 6e63 7469 6f6e 616c 2e73 6361 6c65  functional.scale
-000224b0: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
-000224c0: 7465 6e74 696f 6e22 290a 6465 6620 6175  tention").def au
-000224d0: 746f 6361 7374 5f73 6361 6c65 645f 646f  tocast_scaled_do
-000224e0: 745f 7072 6f64 7563 745f 6174 7465 6e74  t_product_attent
-000224f0: 696f 6e28 0a20 2020 2071 7565 7279 2c0a  ion(.    query,.
-00022500: 2020 2020 6b65 792c 0a20 2020 2076 616c      key,.    val
-00022510: 7565 2c0a 2020 2020 6174 746e 5f6d 6173  ue,.    attn_mas
-00022520: 6b2c 0a20 2020 2064 726f 706f 7574 5f70  k,.    dropout_p
-00022530: 2c0a 2020 2020 6973 5f63 6175 7361 6c2c  ,.    is_causal,
-00022540: 0a20 2020 202a 2c0a 2020 2020 6474 7970  .    *,.    dtyp
-00022550: 652c 0a20 2020 2073 6361 6c65 2c0a 293a  e,.    scale,.):
-00022560: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00022570: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
-00022580: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
-00022590: 745f 6174 7465 6e74 696f 6e0a 0a20 2020  t_attention..   
-000225a0: 2071 2c20 6b2c 2076 203d 206d 6179 6265   q, k, v = maybe
-000225b0: 5f64 6f77 6e63 6173 745f 746f 2864 7479  _downcast_to(dty
-000225c0: 7065 2c20 2871 7565 7279 2c20 6b65 792c  pe, (query, key,
-000225d0: 2076 616c 7565 2929 0a20 2020 2072 6574   value)).    ret
-000225e0: 7572 6e20 7363 616c 6564 5f64 6f74 5f70  urn scaled_dot_p
-000225f0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
-00022600: 2871 2c20 6b2c 2076 2c20 6174 746e 5f6d  (q, k, v, attn_m
-00022610: 6173 6b2c 2064 726f 706f 7574 5f70 2c20  ask, dropout_p, 
-00022620: 6973 5f63 6175 7361 6c2c 2073 6361 6c65  is_causal, scale
-00022630: 3d73 6361 6c65 290a 0a0a 6465 6620 6175  =scale)...def au
-00022640: 746f 6361 7374 5f73 796d 626f 6c5f 6d61  tocast_symbol_ma
-00022650: 7070 6572 2862 6f75 6e64 5f73 796d 626f  pper(bound_symbo
-00022660: 6c3a 2042 6f75 6e64 5379 6d62 6f6c 496e  l: BoundSymbolIn
-00022670: 7465 7266 6163 652c 2064 7479 7065 3a20  terface, dtype: 
-00022680: 6474 7970 6573 2e64 7479 7065 293a 0a20  dtypes.dtype):. 
-00022690: 2020 2022 2222 5265 7475 726e 2074 6865     """Return the
-000226a0: 2063 616c 6c61 626c 6520 696d 706c 656d   callable implem
-000226b0: 656e 7469 6e67 2074 6865 2061 7574 6f63  enting the autoc
-000226c0: 6173 7420 7275 6c65 2066 6f72 2074 6865  ast rule for the
-000226d0: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
-000226e0: 6773 3a0a 2020 2020 2020 2020 626f 756e  gs:.        boun
-000226f0: 645f 7379 6d62 6f6c 3a20 4d61 7070 6564  d_symbol: Mapped
-00022700: 2074 6f20 6974 7320 6175 746f 6361 7374   to its autocast
-00022710: 2072 756c 652e 0a0a 2020 2020 5265 7475   rule...    Retu
-00022720: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
-00022730: 6c61 626c 653a 2054 6865 2063 616c 6c61  lable: The calla
-00022740: 626c 6520 696d 706c 656d 656e 7469 6e67  ble implementing
-00022750: 2074 6865 2061 7574 6f63 6173 7420 7275   the autocast ru
-00022760: 6c65 2066 6f72 2074 6865 2073 796d 626f  le for the symbo
-00022770: 6c2e 0a20 2020 2022 2222 0a20 2020 2061  l..    """.    a
-00022780: 7574 6f63 6173 745f 696d 706c 3a20 4361  utocast_impl: Ca
-00022790: 6c6c 6162 6c65 207c 204e 6f6e 6520 3d20  llable | None = 
-000227a0: 6175 746f 6361 7374 5f69 6d70 6c73 2e67  autocast_impls.g
-000227b0: 6574 2862 6f75 6e64 5f73 796d 626f 6c2e  et(bound_symbol.
-000227c0: 7379 6d2e 6964 290a 2020 2020 7265 7475  sym.id).    retu
-000227d0: 726e 2062 6f75 6e64 5f73 796d 626f 6c2e  rn bound_symbol.
-000227e0: 7379 6d20 6966 2061 7574 6f63 6173 745f  sym if autocast_
-000227f0: 696d 706c 2069 7320 4e6f 6e65 2065 6c73  impl is None els
-00022800: 6520 7061 7274 6961 6c28 6175 746f 6361  e partial(autoca
-00022810: 7374 5f69 6d70 6c2c 2064 7479 7065 3d64  st_impl, dtype=d
-00022820: 7479 7065 290a 0a0a 6465 6620 6175 746f  type)...def auto
-00022830: 6361 7374 2866 756e 633a 2043 616c 6c61  cast(func: Calla
-00022840: 626c 652c 2064 7479 7065 3a20 6474 7970  ble, dtype: dtyp
-00022850: 6573 2e64 7479 7065 293a 0a20 2020 2022  es.dtype):.    "
-00022860: 2222 5472 616e 7366 6f72 6d73 2061 2066  ""Transforms a f
-00022870: 756e 6374 696f 6e20 746f 2061 7574 6f63  unction to autoc
-00022880: 6173 7420 6365 7274 6169 6e20 6f70 6572  ast certain oper
-00022890: 6174 696f 6e73 2e0a 0a20 2020 2041 7267  ations...    Arg
-000228a0: 733a 0a20 2020 2020 2020 2066 756e 633a  s:.        func:
-000228b0: 2054 6865 2066 756e 6374 696f 6e20 746f   The function to
-000228c0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
-000228d0: 0a20 2020 2020 2020 2064 7479 7065 3a20  .        dtype: 
-000228e0: 5468 6520 6461 7461 2074 7970 6520 746f  The data type to
-000228f0: 2077 6869 6368 2061 7267 756d 656e 7473   which arguments
-00022900: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-00022910: 206f 7220 7375 6220 6675 6e63 7469 6f6e   or sub function
-00022920: 7320 636f 756c 6420 6765 7420 6361 7374  s could get cast
-00022930: 2069 660a 2020 2020 2020 2020 2020 2020   if.            
-00022940: 7468 6579 2061 7265 2060 6474 7970 6573  they are `dtypes
-00022950: 2e66 6c6f 6174 3332 602e 0a0a 2020 2020  .float32`...    
-00022960: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00022970: 2043 616c 6c61 626c 653a 2054 6865 2074   Callable: The t
-00022980: 7261 6e73 666f 726d 6564 2066 756e 6374  ransformed funct
-00022990: 696f 6e0a 2020 2020 2222 220a 0a20 2020  ion.    """..   
-000229a0: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-000229b0: 6365 2864 7479 7065 2c20 6474 7970 6573  ce(dtype, dtypes
-000229c0: 2e64 7479 7065 293a 0a20 2020 2020 2020  .dtype):.       
-000229d0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000229e0: 7228 6622 6064 7479 7065 6020 6973 2065  r(f"`dtype` is e
-000229f0: 7870 6563 7465 6420 746f 2062 6520 6074  xpected to be `t
-00022a00: 6875 6e64 6572 2e64 7479 7065 2e64 7479  hunder.dtype.dty
-00022a10: 7065 6020 6275 7420 7b74 7970 6528 6474  pe` but {type(dt
-00022a20: 7970 6529 7d22 290a 2020 2020 6966 2064  ype)}").    if d
-00022a30: 7479 7065 206e 6f74 2069 6e20 7b64 7479  type not in {dty
-00022a40: 7065 732e 666c 6f61 7431 362c 2064 7479  pes.float16, dty
-00022a50: 7065 732e 6266 6c6f 6174 3136 7d3a 0a20  pes.bfloat16}:. 
-00022a60: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00022a70: 7565 4572 726f 7228 6622 6064 7479 7065  ueError(f"`dtype
-00022a80: 6020 6973 2065 7870 6563 7465 6420 746f  ` is expected to
-00022a90: 2062 6520 6569 7468 6572 2060 7468 756e   be either `thun
-00022aa0: 6465 722e 666c 6f61 7431 3660 206f 7220  der.float16` or 
-00022ab0: 6074 6875 6e64 6572 2e62 666c 6f61 7431  `thunder.bfloat1
-00022ac0: 3660 2c20 6275 7420 7b64 7479 7065 7d22  6`, but {dtype}"
-00022ad0: 290a 0a20 2020 2040 7772 6170 7328 6675  )..    @wraps(fu
-00022ae0: 6e63 290a 2020 2020 6465 6620 7772 6170  nc).    def wrap
-00022af0: 7065 7228 2a61 7267 732c 202a 2a6b 7761  per(*args, **kwa
-00022b00: 7267 7329 3a0a 2020 2020 2020 2020 7472  rgs):.        tr
-00022b10: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-00022b20: 7472 6163 6528 2928 6675 6e63 2c20 2a61  trace()(func, *a
-00022b30: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
-00022b40: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
-00022b50: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
-00022b60: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
-00022b70: 2073 796d 626f 6c5f 6d61 7070 6572 3d70   symbol_mapper=p
-00022b80: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
-00022b90: 7379 6d62 6f6c 5f6d 6170 7065 722c 2064  symbol_mapper, d
-00022ba0: 7479 7065 3d64 7479 7065 2929 0a0a 2020  type=dtype))..  
-00022bb0: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
-00022bc0: 0a                                       .
+000089b0: 615f 6772 6164 203d 2067 7261 645f 6368  a_grad = grad_ch
+000089c0: 6f6f 7365 725f 6261 636b 7761 7264 2866  ooser_backward(f
+000089d0: 7764 2c20 612c 2061 2e73 6861 7065 2c20  wd, a, a.shape, 
+000089e0: 6469 6d73 2c20 6729 0a20 2020 2070 7574  dims, g).    put
+000089f0: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
+00008a00: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00008a10: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00008a20: 2870 6964 732e 414d 4158 2c20 5f61 6d61  (pids.AMAX, _ama
+00008a30: 785f 7072 696d 5f67 7261 6429 0a0a 0a64  x_prim_grad)...d
+00008a40: 6566 205f 7375 6d5f 7072 696d 5f67 7261  ef _sum_prim_gra
+00008a50: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
+00008a60: 2c20 2f2c 2064 696d 733a 2053 6571 7565  , /, dims: Seque
+00008a70: 6e63 655b 696e 745d 2920 2d3e 2054 656e  nce[int]) -> Ten
+00008a80: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+00008a90: 6420 3d20 7072 696d 732e 7375 6d28 612c  d = prims.sum(a,
+00008aa0: 2064 696d 7329 0a0a 2020 2020 6720 3d20   dims)..    g = 
+00008ab0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00008ac0: 2020 615f 6772 6164 203d 2072 6573 746f    a_grad = resto
+00008ad0: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
+00008ae0: 672c 2064 696d 732c 2061 2e73 6861 7065  g, dims, a.shape
+00008af0: 290a 2020 2020 7075 745f 6772 6164 2861  ).    put_grad(a
+00008b00: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
+00008b10: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00008b20: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
+00008b30: 554d 2c20 5f73 756d 5f70 7269 6d5f 6772  UM, _sum_prim_gr
+00008b40: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+00008b50: 6465 6620 5f74 6f70 6b5f 7072 696d 5f67  def _topk_prim_g
+00008b60: 7261 6428 0a20 2020 2061 3a20 5465 6e73  rad(.    a: Tens
+00008b70: 6f72 5072 6f78 792c 202f 2c20 6b3a 2069  orProxy, /, k: i
+00008b80: 6e74 2c20 6469 6d3a 204e 6f6e 6520 7c20  nt, dim: None | 
+00008b90: 696e 7420 3d20 4e6f 6e65 2c20 6c61 7267  int = None, larg
+00008ba0: 6573 743a 2062 6f6f 6c20 3d20 5472 7565  est: bool = True
+00008bb0: 2c20 736f 7274 6564 3a20 626f 6f6c 203d  , sorted: bool =
+00008bc0: 2054 7275 652c 202a 2c20 6f75 743d 4e6f   True, *, out=No
+00008bd0: 6e65 0a29 3a0a 2020 2020 6677 6420 3d20  ne.):.    fwd = 
+00008be0: 7072 696d 732e 746f 706b 2861 2c20 6b2c  prims.topk(a, k,
+00008bf0: 2064 696d 2c20 6c61 7267 6573 742c 2073   dim, largest, s
+00008c00: 6f72 7465 642c 206f 7574 3d6f 7574 290a  orted, out=out).
+00008c10: 2020 2020 7661 6c2c 2069 6478 203d 2066      val, idx = f
+00008c20: 7764 0a0a 2020 2020 7661 6c5f 6772 6164  wd..    val_grad
+00008c30: 203d 2067 6574 5f67 7261 6428 7661 6c29   = get_grad(val)
+00008c40: 0a0a 2020 2020 615f 6772 6164 203d 206c  ..    a_grad = l
+00008c50: 746f 7263 682e 7a65 726f 735f 6c69 6b65  torch.zeros_like
+00008c60: 2861 290a 2020 2020 2320 544f 444f 3a20  (a).    # TODO: 
+00008c70: 7265 706c 6163 6520 7769 7468 2073 6361  replace with sca
+00008c80: 7474 6572 206f 6e63 6520 7765 2068 6176  tter once we hav
+00008c90: 6520 6974 2e0a 2020 2020 2320 7363 6174  e it..    # scat
+00008ca0: 7465 725f 6164 6420 6973 2061 2070 7269  ter_add is a pri
+00008cb0: 6d20 616e 6420 6974 2072 656c 6965 7320  m and it relies 
+00008cc0: 6f6e 2061 746f 6d69 6320 6f70 732e 0a20  on atomic ops.. 
+00008cd0: 2020 2061 5f67 7261 6420 3d20 6c74 6f72     a_grad = ltor
+00008ce0: 6368 2e73 6361 7474 6572 5f61 6464 2861  ch.scatter_add(a
+00008cf0: 5f67 7261 642c 2064 696d 2c20 6964 782c  _grad, dim, idx,
+00008d00: 2076 616c 5f67 7261 6429 0a20 2020 2070   val_grad).    p
+00008d10: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+00008d20: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+00008d30: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+00008d40: 6164 2870 6964 732e 544f 504b 2c20 5f74  ad(pids.TOPK, _t
+00008d50: 6f70 6b5f 7072 696d 5f67 7261 6429 0a0a  opk_prim_grad)..
+00008d60: 0a23 2054 4f44 4f20 4669 7820 6469 7669  .# TODO Fix divi
+00008d70: 7369 6f6e 2062 7920 7a65 726f 2077 6865  sion by zero whe
+00008d80: 6e20 6e5f 656c 656d 5f72 6564 7563 6564  n n_elem_reduced
+00008d90: 203d 3d20 3020 6f72 2077 6865 6e20 6d65   == 0 or when me
+00008da0: 616e 2e6e 756d 656c 203d 3d20 300a 2320  an.numel == 0.# 
+00008db0: 2020 6279 2072 6574 7572 6e69 6e67 207a    by returning z
+00008dc0: 6572 6f73 5f6c 696b 6528 6129 206f 7220  eros_like(a) or 
+00008dd0: 7369 6d69 6c61 722e 0a23 2054 4f44 4f20  similar..# TODO 
+00008de0: 4669 7820 6772 6164 2077 6865 6e20 636f  Fix grad when co
+00008df0: 7272 6563 7469 6f6e 203e 206e 5f65 6c65  rrection > n_ele
+00008e00: 6d5f 7265 6475 6365 642e 0a40 746f 7263  m_reduced..@torc
+00008e10: 6863 7478 0a64 6566 205f 7661 725f 6d65  hctx.def _var_me
+00008e20: 616e 5f70 7269 6d5f 6772 6164 2861 3a20  an_prim_grad(a: 
+00008e30: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
+00008e40: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
+00008e50: 6e74 5d2c 202a 2c20 636f 7272 6563 7469  nt], *, correcti
+00008e60: 6f6e 3a20 4e75 6d62 6572 2920 2d3e 2054  on: Number) -> T
+00008e70: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00008e80: 762c 206d 203d 2070 7269 6d73 2e76 6172  v, m = prims.var
+00008e90: 5f6d 6561 6e28 612c 2064 696d 732c 2063  _mean(a, dims, c
+00008ea0: 6f72 7265 6374 696f 6e3d 636f 7272 6563  orrection=correc
+00008eb0: 7469 6f6e 290a 0a20 2020 2067 7620 3d20  tion)..    gv = 
+00008ec0: 6765 745f 6772 6164 2876 290a 2020 2020  get_grad(v).    
+00008ed0: 676d 203d 2067 6574 5f67 7261 6428 6d29  gm = get_grad(m)
+00008ee0: 0a0a 2020 2020 6e5f 656c 656d 5f72 6564  ..    n_elem_red
+00008ef0: 7563 6564 203d 2061 2e6e 756d 656c 2829  uced = a.numel()
+00008f00: 202f 2f20 6d2e 6e75 6d65 6c28 2920 6966   // m.numel() if
+00008f10: 2061 2e6e 756d 656c 2829 2021 3d20 3020   a.numel() != 0 
+00008f20: 656c 7365 2031 0a0a 2020 2020 2320 436f  else 1..    # Co
+00008f30: 6d70 7574 6573 206d 6561 6e20 6277 640a  mputes mean bwd.
+00008f40: 2020 2020 6d65 616e 5f73 6361 6c65 203d      mean_scale =
+00008f50: 2031 2e30 202f 206e 5f65 6c65 6d5f 7265   1.0 / n_elem_re
+00008f60: 6475 6365 640a 2020 2020 6d65 616e 5f67  duced.    mean_g
+00008f70: 7261 6420 3d20 6d65 616e 5f73 6361 6c65  rad = mean_scale
+00008f80: 202a 2072 6573 746f 7265 5f72 6564 7563   * restore_reduc
+00008f90: 6564 5f64 696d 7328 676d 2c20 6469 6d73  ed_dims(gm, dims
+00008fa0: 2c20 612e 7368 6170 6529 0a0a 2020 2020  , a.shape)..    
+00008fb0: 2320 436f 6d70 7574 6573 2076 6172 2062  # Computes var b
+00008fc0: 7764 0a20 2020 206e 6f72 6d61 6c69 7a61  wd.    normaliza
+00008fd0: 7469 6f6e 5f73 6361 6c61 7220 3d20 6e5f  tion_scalar = n_
+00008fe0: 656c 656d 5f72 6564 7563 6564 202d 2063  elem_reduced - c
+00008ff0: 6f72 7265 6374 696f 6e0a 2020 2020 7265  orrection.    re
+00009000: 7374 6f72 6564 5f67 7620 3d20 7265 7374  stored_gv = rest
+00009010: 6f72 655f 7265 6475 6365 645f 6469 6d73  ore_reduced_dims
+00009020: 2867 762c 2064 696d 732c 2061 2e73 6861  (gv, dims, a.sha
+00009030: 7065 290a 2020 2020 2320 496e 7365 7274  pe).    # Insert
+00009040: 696e 6720 6120 636f 6e76 6572 7369 6f6e  ing a conversion
+00009050: 2074 6f20 7468 6520 7361 6d65 2064 7479   to the same dty
+00009060: 7065 2074 6f20 6469 7361 626c 6520 6e76  pe to disable nv
+00009070: 4675 7365 7220 6578 6563 7574 6f72 7327  Fuser executors'
+00009080: 730a 2020 2020 2320 626f 6f6b 656e 6420  s.    # bookend 
+00009090: 6f70 7469 6d69 7a61 7469 6f6e 2028 6e76  optimization (nv
+000090a0: 5f65 6e61 626c 655f 626f 6f6b 656e 6429  _enable_bookend)
+000090b0: 2c20 7768 6963 6820 6361 6e20 6361 7573  , which can caus
+000090c0: 6520 7468 6520 6261 636b 7761 7264 0a20  e the backward. 
+000090d0: 2020 2023 2070 6173 7320 746f 2067 656e     # pass to gen
+000090e0: 6572 6174 6520 7477 6f20 6b65 726e 656c  erate two kernel
+000090f0: 730a 2020 2020 6d65 616e 5f6d 6474 7970  s.    mean_mdtyp
+00009100: 6520 3d20 7072 696d 732e 636f 6e76 6572  e = prims.conver
+00009110: 745f 656c 656d 656e 745f 7479 7065 286d  t_element_type(m
+00009120: 2c20 6d2e 6474 7970 6529 0a20 2020 2072  , m.dtype).    r
+00009130: 6573 746f 7265 645f 6d65 616e 203d 2072  estored_mean = r
+00009140: 6573 746f 7265 5f72 6564 7563 6564 5f64  estore_reduced_d
+00009150: 696d 7328 6d65 616e 5f6d 6474 7970 652c  ims(mean_mdtype,
+00009160: 2064 696d 732c 2061 2e73 6861 7065 290a   dims, a.shape).
+00009170: 2020 2020 7661 725f 6772 6164 203d 2028      var_grad = (
+00009180: 3220 2a20 7265 7374 6f72 6564 5f67 7620  2 * restored_gv 
+00009190: 2a20 2861 202d 2072 6573 746f 7265 645f  * (a - restored_
+000091a0: 6d65 616e 2929 202f 206e 6f72 6d61 6c69  mean)) / normali
+000091b0: 7a61 7469 6f6e 5f73 6361 6c61 720a 0a20  zation_scalar.. 
+000091c0: 2020 2070 7574 5f67 7261 6428 612c 206d     put_grad(a, m
+000091d0: 6561 6e5f 6772 6164 202b 2076 6172 5f67  ean_grad + var_g
+000091e0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+000091f0: 2076 2c20 6d0a 0a0a 7265 6769 7374 6572   v, m...register
+00009200: 5f67 7261 6428 7069 6473 2e56 4152 5f4d  _grad(pids.VAR_M
+00009210: 4541 4e2c 205f 7661 725f 6d65 616e 5f70  EAN, _var_mean_p
+00009220: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
+00009230: 4c69 6e65 6172 2061 6c67 6562 7261 206f  Linear algebra o
+00009240: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
+00009250: 4074 6f72 6368 6374 780a 6465 6620 5f6c  @torchctx.def _l
+00009260: 696e 6561 725f 7072 696d 5f67 7261 6428  inear_prim_grad(
+00009270: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+00009280: 773a 2054 656e 736f 7250 726f 7879 2c20  w: TensorProxy, 
+00009290: 6269 6173 3a20 4e6f 6e65 207c 2054 656e  bias: None | Ten
+000092a0: 736f 7250 726f 7879 2920 2d3e 2054 656e  sorProxy) -> Ten
+000092b0: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+000092c0: 6420 3d20 7072 696d 732e 6c69 6e65 6172  d = prims.linear
+000092d0: 2861 2c20 772c 2062 6961 7329 0a0a 2020  (a, w, bias)..  
+000092e0: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
+000092f0: 7764 290a 0a20 2020 2066 6972 7374 5f64  wd)..    first_d
+00009300: 696d 203d 202d 320a 2020 2020 6772 6164  im = -2.    grad
+00009310: 5f61 203d 206c 746f 7263 682e 6d61 746d  _a = ltorch.matm
+00009320: 756c 2867 2e72 6573 6861 7065 282d 312c  ul(g.reshape(-1,
+00009330: 2067 2e73 6861 7065 5b2d 315d 292c 2077   g.shape[-1]), w
+00009340: 292e 7265 7368 6170 6528 612e 7368 6170  ).reshape(a.shap
+00009350: 6529 0a0a 2020 2020 6772 6164 5f77 3a20  e)..    grad_w: 
+00009360: 5465 6e73 6f72 5072 6f78 790a 2020 2020  TensorProxy.    
+00009370: 6966 2061 2e6e 6469 6d20 3d3d 2031 3a0a  if a.ndim == 1:.
+00009380: 2020 2020 2020 2020 6772 6164 5f77 203d          grad_w =
+00009390: 206c 746f 7263 682e 6d61 746d 756c 2867   ltorch.matmul(g
+000093a0: 2e75 6e73 7175 6565 7a65 2866 6972 7374  .unsqueeze(first
+000093b0: 5f64 696d 292e 6d54 2c20 612e 756e 7371  _dim).mT, a.unsq
+000093c0: 7565 657a 6528 6669 7273 745f 6469 6d29  ueeze(first_dim)
+000093d0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+000093e0: 2020 2020 6772 6164 5f77 203d 206c 746f      grad_w = lto
+000093f0: 7263 682e 6d61 746d 756c 2867 2e72 6573  rch.matmul(g.res
+00009400: 6861 7065 282d 312c 2067 2e73 6861 7065  hape(-1, g.shape
+00009410: 5b2d 315d 292e 6d54 2c20 612e 7265 7368  [-1]).mT, a.resh
+00009420: 6170 6528 2d31 2c20 612e 7368 6170 655b  ape(-1, a.shape[
+00009430: 2d31 5d29 290a 0a20 2020 2070 7574 5f67  -1]))..    put_g
+00009440: 7261 6473 2828 612c 2077 292c 2028 6772  rads((a, w), (gr
+00009450: 6164 5f61 2c20 6772 6164 5f77 2929 0a0a  ad_a, grad_w))..
+00009460: 2020 2020 6966 2062 6961 7320 6973 206e      if bias is n
+00009470: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00009480: 2069 6620 672e 6e64 696d 203e 2031 3a0a   if g.ndim > 1:.
+00009490: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+000094a0: 5f62 6961 7320 3d20 6c74 6f72 6368 2e73  _bias = ltorch.s
+000094b0: 756d 2867 2c20 7475 706c 6528 7261 6e67  um(g, tuple(rang
+000094c0: 6528 672e 6e64 696d 202d 2031 2929 290a  e(g.ndim - 1))).
+000094d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000094e0: 2020 2020 2020 2020 2020 6772 6164 5f62            grad_b
+000094f0: 6961 7320 3d20 670a 2020 2020 2020 2020  ias = g.        
+00009500: 7075 745f 6772 6164 2862 6961 732c 2067  put_grad(bias, g
+00009510: 7261 645f 6269 6173 290a 0a20 2020 2072  rad_bias)..    r
+00009520: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00009530: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
+00009540: 494e 4541 522c 205f 6c69 6e65 6172 5f70  INEAR, _linear_p
+00009550: 7269 6d5f 6772 6164 290a 0a0a 2320 544f  rim_grad)...# TO
+00009560: 444f 2041 6464 2065 7870 6c69 6369 7420  DO Add explicit 
+00009570: 6c74 6f72 6368 2076 7320 636c 616e 6720  ltorch vs clang 
+00009580: 6d6f 6475 6c65 2074 6f20 7468 6520 7465  module to the te
+00009590: 6e73 6f72 206f 7065 7261 7469 6f6e 7320  nsor operations 
+000095a0: 6265 6c6f 770a 2320 544f 444f 2063 6f75  below.# TODO cou
+000095b0: 6c64 2077 6520 6765 7420 7269 6420 6f66  ld we get rid of
+000095c0: 2074 6865 2066 696e 616c 2073 7175 6565   the final squee
+000095d0: 7a65 7320 696e 2074 6865 2062 2e6e 6469  zes in the b.ndi
+000095e0: 6d20 3d3d 2031 2063 6173 6520 616e 6420  m == 1 case and 
+000095f0: 7468 6520 612e 6e64 696d 203d 3d20 3120  the a.ndim == 1 
+00009600: 6361 7365 3f0a 4074 6f72 6368 6374 780a  case?.@torchctx.
+00009610: 6465 6620 5f6d 6174 6d75 6c5f 7072 696d  def _matmul_prim
+00009620: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
+00009630: 726f 7879 2c20 623a 2054 656e 736f 7250  roxy, b: TensorP
+00009640: 726f 7879 2c20 2f29 202d 3e20 5465 6e73  roxy, /) -> Tens
+00009650: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00009660: 203d 2070 7269 6d73 2e6d 6174 6d75 6c28   = prims.matmul(
+00009670: 612c 2062 290a 2020 2020 6720 3d20 6765  a, b).    g = ge
+00009680: 745f 6772 6164 2866 7764 290a 0a20 2020  t_grad(fwd)..   
+00009690: 206c 6173 745f 6469 6d20 3d20 282d 312c   last_dim = (-1,
+000096a0: 290a 2020 2020 6669 7273 745f 6469 6d20  ).    first_dim 
+000096b0: 3d20 282d 322c 290a 2020 2020 6966 2061  = (-2,).    if a
+000096c0: 2e6e 6469 6d20 3d3d 2031 2061 6e64 2062  .ndim == 1 and b
+000096d0: 2e6e 6469 6d20 3d3d 2031 3a0a 2020 2020  .ndim == 1:.    
+000096e0: 2020 2020 7075 745f 6772 6164 7328 2861      put_grads((a
+000096f0: 2c20 6229 2c20 2867 202a 2062 2c20 6720  , b), (g * b, g 
+00009700: 2a20 6129 290a 2020 2020 656c 6966 2062  * a)).    elif b
+00009710: 2e6e 6469 6d20 3d3d 2031 3a0a 2020 2020  .ndim == 1:.    
+00009720: 2020 2020 6761 203d 2075 6e73 7175 6565      ga = unsquee
+00009730: 7a65 2867 2c20 6c61 7374 5f64 696d 2920  ze(g, last_dim) 
+00009740: 4020 756e 7371 7565 657a 6528 622c 206c  @ unsqueeze(b, l
+00009750: 6173 745f 6469 6d29 2e6d 540a 2020 2020  ast_dim).mT.    
+00009760: 2020 2020 6762 203d 2061 2e6d 5420 4020      gb = a.mT @ 
+00009770: 756e 7371 7565 657a 6528 672c 206c 6173  unsqueeze(g, las
+00009780: 745f 6469 6d29 0a20 2020 2020 2020 2069  t_dim).        i
+00009790: 6620 672e 6e64 696d 203e 2031 3a0a 2020  f g.ndim > 1:.  
+000097a0: 2020 2020 2020 2020 2020 6762 203d 2073            gb = s
+000097b0: 7175 6565 7a65 2867 622c 206c 6173 745f  queeze(gb, last_
+000097c0: 6469 6d29 0a20 2020 2020 2020 2020 2020  dim).           
+000097d0: 2067 6220 3d20 6c74 6f72 6368 2e73 756d   gb = ltorch.sum
+000097e0: 2867 622c 2074 7570 6c65 2872 616e 6765  (gb, tuple(range
+000097f0: 2867 622e 6e64 696d 202d 2031 2929 290a  (gb.ndim - 1))).
+00009800: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
+00009810: 7328 2861 2c20 6229 2c20 2867 612c 2067  s((a, b), (ga, g
+00009820: 622e 7371 7565 657a 6528 2929 290a 2020  b.squeeze())).  
+00009830: 2020 656c 6966 2061 2e6e 6469 6d20 3d3d    elif a.ndim ==
+00009840: 2031 3a0a 2020 2020 2020 2020 6761 203d   1:.        ga =
+00009850: 2075 6e73 7175 6565 7a65 2867 2c20 6669   unsqueeze(g, fi
+00009860: 7273 745f 6469 6d29 2040 2062 2e6d 540a  rst_dim) @ b.mT.
+00009870: 2020 2020 2020 2020 6966 2067 2e6e 6469          if g.ndi
+00009880: 6d20 3e20 313a 0a20 2020 2020 2020 2020  m > 1:.         
+00009890: 2020 2067 6120 3d20 6c74 6f72 6368 2e73     ga = ltorch.s
+000098a0: 756d 2867 612c 2074 7570 6c65 2872 616e  um(ga, tuple(ran
+000098b0: 6765 2867 612e 6e64 696d 202d 2031 2929  ge(ga.ndim - 1))
+000098c0: 290a 2020 2020 2020 2020 6762 203d 2075  ).        gb = u
+000098d0: 6e73 7175 6565 7a65 2861 2c20 6669 7273  nsqueeze(a, firs
+000098e0: 745f 6469 6d29 2e6d 5420 4020 756e 7371  t_dim).mT @ unsq
+000098f0: 7565 657a 6528 672c 2066 6972 7374 5f64  ueeze(g, first_d
+00009900: 696d 290a 2020 2020 2020 2020 7075 745f  im).        put_
+00009910: 6772 6164 7328 2861 2c20 6229 2c20 2867  grads((a, b), (g
+00009920: 612e 7371 7565 657a 6528 292c 2067 6229  a.squeeze(), gb)
+00009930: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00009940: 2020 2020 7075 745f 6772 6164 7328 2861      put_grads((a
+00009950: 2c20 6229 2c20 2867 2040 2062 2e6d 542c  , b), (g @ b.mT,
+00009960: 2061 2e6d 5420 4020 6729 290a 0a20 2020   a.mT @ g))..   
+00009970: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
+00009980: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00009990: 2e4d 4154 4d55 4c2c 205f 6d61 746d 756c  .MATMUL, _matmul
+000099a0: 5f70 7269 6d5f 6772 6164 290a 0a23 0a23  _prim_grad)..#.#
+000099b0: 204e 4e20 6f70 6572 6174 6f72 2067 7261   NN operator gra
+000099c0: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
+000099d0: 0a64 6566 205f 656d 6265 6464 696e 675f  .def _embedding_
+000099e0: 7072 696d 5f67 7261 6428 0a20 2020 2061  prim_grad(.    a
+000099f0: 3a20 5465 6e73 6f72 5072 6f78 792c 202f  : TensorProxy, /
+00009a00: 2c20 7765 6967 6874 2c20 2a2c 2070 6164  , weight, *, pad
+00009a10: 6469 6e67 5f69 6478 3d2d 312c 206d 6178  ding_idx=-1, max
+00009a20: 5f6e 6f72 6d3d 4e6f 6e65 2c20 6e6f 726d  _norm=None, norm
+00009a30: 5f74 7970 653d 322e 302c 2073 6361 6c65  _type=2.0, scale
+00009a40: 5f67 7261 645f 6279 5f66 7265 713d 4661  _grad_by_freq=Fa
+00009a50: 6c73 652c 2073 7061 7273 653d 4661 6c73  lse, sparse=Fals
+00009a60: 650a 2920 2d3e 2054 656e 736f 7250 726f  e.) -> TensorPro
+00009a70: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00009a80: 696d 732e 656d 6265 6464 696e 6728 0a20  ims.embedding(. 
+00009a90: 2020 2020 2020 2061 2c0a 2020 2020 2020         a,.      
+00009aa0: 2020 7765 6967 6874 2c0a 2020 2020 2020    weight,.      
+00009ab0: 2020 7061 6464 696e 675f 6964 783d 7061    padding_idx=pa
+00009ac0: 6464 696e 675f 6964 782c 0a20 2020 2020  dding_idx,.     
+00009ad0: 2020 206d 6178 5f6e 6f72 6d3d 6d61 785f     max_norm=max_
+00009ae0: 6e6f 726d 2c0a 2020 2020 2020 2020 6e6f  norm,.        no
+00009af0: 726d 5f74 7970 653d 6e6f 726d 5f74 7970  rm_type=norm_typ
+00009b00: 652c 0a20 2020 2020 2020 2073 6361 6c65  e,.        scale
+00009b10: 5f67 7261 645f 6279 5f66 7265 713d 7363  _grad_by_freq=sc
+00009b20: 616c 655f 6772 6164 5f62 795f 6672 6571  ale_grad_by_freq
+00009b30: 2c0a 2020 2020 2020 2020 7370 6172 7365  ,.        sparse
+00009b40: 3d73 7061 7273 652c 0a20 2020 2029 0a0a  =sparse,.    )..
+00009b50: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00009b60: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
+00009b70: 203d 2070 7269 6d73 2e65 6d62 6564 6469   = prims.embeddi
+00009b80: 6e67 5f62 6163 6b77 6172 6428 672c 2061  ng_backward(g, a
+00009b90: 2c20 7765 6967 6874 2e73 6861 7065 5b30  , weight.shape[0
+00009ba0: 5d2c 2070 6164 6469 6e67 5f69 6478 2c20  ], padding_idx, 
+00009bb0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+00009bc0: 6571 2c20 7370 6172 7365 290a 2020 2020  eq, sparse).    
+00009bd0: 7075 745f 6772 6164 2861 2c20 615f 6772  put_grad(a, a_gr
+00009be0: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
+00009bf0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00009c00: 7261 6428 7069 6473 2e45 4d42 4544 4449  rad(pids.EMBEDDI
+00009c10: 4e47 2c20 5f65 6d62 6564 6469 6e67 5f70  NG, _embedding_p
+00009c20: 7269 6d5f 6772 6164 290a 0a23 0a23 2050  rim_grad)..#.# P
+00009c30: 6861 6e74 6f6d 2067 7261 6420 7472 616e  hantom grad tran
+00009c40: 7366 6f72 6d20 6865 6c70 6572 730a 230a  sform helpers.#.
+00009c50: 0a0a 6465 6620 5f67 6574 5f67 7261 6466  ..def _get_gradf
+00009c60: 6e5f 616e 645f 6578 6563 7574 6f72 280a  n_and_executor(.
+00009c70: 2020 2020 6273 796d 3a20 426f 756e 6453      bsym: BoundS
+00009c80: 796d 626f 6c2c 202a 2c20 6578 6563 7574  ymbol, *, execut
+00009c90: 6f72 735f 6c69 7374 3a20 5365 7175 656e  ors_list: Sequen
+00009ca0: 6365 5b41 6e79 5d20 3d20 7475 706c 6528  ce[Any] = tuple(
+00009cb0: 290a 2920 2d3e 2074 7570 6c65 5b43 616c  ).) -> tuple[Cal
+00009cc0: 6c61 626c 6520 7c20 4e6f 6e65 2c20 4578  lable | None, Ex
+00009cd0: 6563 7574 6f72 207c 204e 6f6e 655d 3a0a  ecutor | None]:.
+00009ce0: 2020 2020 6364 203d 2067 6574 5f63 6f6d      cd = get_com
+00009cf0: 7069 6c65 5f64 6174 6128 290a 2020 2020  pile_data().    
+00009d00: 6578 6563 7574 6f72 735f 6c69 7374 203d  executors_list =
+00009d10: 2063 642e 6578 6563 7574 6f72 735f 6c69   cd.executors_li
+00009d20: 7374 2069 6620 6364 2069 7320 6e6f 7420  st if cd is not 
+00009d30: 4e6f 6e65 2065 6c73 6520 6578 6563 7574  None else execut
+00009d40: 6f72 735f 6c69 7374 0a20 2020 2023 2043  ors_list.    # C
+00009d50: 6865 636b 7320 6966 2074 6865 2065 7865  hecks if the exe
+00009d60: 6375 746f 7220 7768 6963 6820 6861 7320  cutor which has 
+00009d70: 7072 696f 7269 7479 2066 6f72 2074 6869  priority for thi
+00009d80: 7320 6f70 6572 6174 696f 6e20 6861 7320  s operation has 
+00009d90: 6120 7370 6563 6966 6963 2067 7261 6420  a specific grad 
+00009da0: 7472 616e 7366 6f72 6d20 666f 7220 6974  transform for it
+00009db0: 0a20 2020 2066 6f72 2065 7820 696e 2065  .    for ex in e
+00009dc0: 7865 6375 746f 7273 5f6c 6973 743a 0a20  xecutors_list:. 
+00009dd0: 2020 2020 2020 2069 6620 6578 2e63 616e         if ex.can
+00009de0: 5f65 7865 6375 7465 5f6f 725f 6675 7365  _execute_or_fuse
+00009df0: 2862 7379 6d29 3a0a 2020 2020 2020 2020  (bsym):.        
+00009e00: 2020 2020 6578 5f67 7261 645f 7472 616e      ex_grad_tran
+00009e10: 7366 6f72 6d3a 204e 6f6e 6520 7c20 4361  sform: None | Ca
+00009e20: 6c6c 6162 6c65 203d 2065 782e 6765 745f  llable = ex.get_
+00009e30: 6772 6164 5f74 7261 6e73 666f 726d 2862  grad_transform(b
+00009e40: 7379 6d2e 7379 6d29 0a20 2020 2020 2020  sym.sym).       
+00009e50: 2020 2020 2069 6620 6578 5f67 7261 645f       if ex_grad_
+00009e60: 7472 616e 7366 6f72 6d20 6973 206e 6f74  transform is not
+00009e70: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00009e80: 2020 2020 2020 2072 6574 7572 6e20 6578         return ex
+00009e90: 5f67 7261 645f 7472 616e 7366 6f72 6d2c  _grad_transform,
+00009ea0: 2065 780a 2020 2020 2020 2020 2020 2020   ex.            
+00009eb0: 6272 6561 6b0a 0a20 2020 2023 2049 6620  break..    # If 
+00009ec0: 7468 6520 6578 6563 7574 6f72 2064 6f65  the executor doe
+00009ed0: 736e 2774 2064 6566 696e 6520 6974 7320  sn't define its 
+00009ee0: 6f77 6e20 6772 6164 2074 7261 6e73 666f  own grad transfo
+00009ef0: 726d 2c20 7468 6973 206a 7573 7420 7265  rm, this just re
+00009f00: 7475 726e 7320 7468 6520 6465 6661 756c  turns the defaul
+00009f10: 7420 6772 6164 2074 7261 6e73 666f 726d  t grad transform
+00009f20: 2066 6f72 2074 6865 2062 7379 6d0a 2020   for the bsym.  
+00009f30: 2020 6772 6164 666e 203d 205f 6772 6164    gradfn = _grad
+00009f40: 5f66 6e5f 6d61 702e 6765 7428 6273 796d  _fn_map.get(bsym
+00009f50: 2e73 796d 2e69 642c 204e 6f6e 6529 0a20  .sym.id, None). 
+00009f60: 2020 2072 6574 7572 6e20 6772 6164 666e     return gradfn
+00009f70: 2c20 4e6f 6e65 0a0a 0a64 6566 2067 7261  , None...def gra
+00009f80: 6428 0a20 2020 2063 666e 2c0a 2920 2d3e  d(.    cfn,.) ->
+00009f90: 2043 616c 6c61 626c 653a 0a20 2020 2064   Callable:.    d
+00009fa0: 6566 2067 7261 6428 6675 6e63 293a 0a0a  ef grad(func):..
+00009fb0: 2020 2020 2020 2020 4077 7261 7073 2866          @wraps(f
+00009fc0: 756e 6329 0a20 2020 2020 2020 2064 6566  unc).        def
+00009fd0: 2067 7261 645f 6675 6e63 282a 6172 6773   grad_func(*args
+00009fe0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00009ff0: 2020 2020 2020 2020 205f 2c20 6772 6164           _, grad
+0000a000: 7320 3d20 7661 6c75 655f 616e 645f 6772  s = value_and_gr
+0000a010: 6164 2866 756e 6329 282a 6172 6773 2c20  ad(func)(*args, 
+0000a020: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+0000a030: 2020 2020 2020 6772 6164 7320 3d20 7472        grads = tr
+0000a040: 6565 5f66 6c61 7474 656e 2867 7261 6473  ee_flatten(grads
+0000a050: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+0000a060: 2067 7261 6473 203d 205b 6720 666f 7220   grads = [g for 
+0000a070: 6720 696e 2067 7261 6473 2069 6620 6720  g in grads if g 
+0000a080: 6973 206e 6f74 204e 6f6e 655d 0a20 2020  is not None].   
+0000a090: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000a0a0: 6772 6164 730a 0a20 2020 2020 2020 2072  grads..        r
+0000a0b0: 6574 7572 6e20 6772 6164 5f66 756e 630a  eturn grad_func.
+0000a0c0: 0a20 2020 2064 6566 205f 6772 6164 5f74  .    def _grad_t
+0000a0d0: 7261 6e73 666f 726d 2874 7263 3a20 5472  ransform(trc: Tr
+0000a0e0: 6163 652c 202a 2c20 6578 6563 7574 6f72  ace, *, executor
+0000a0f0: 735f 6c69 7374 3a20 5365 7175 656e 6365  s_list: Sequence
+0000a100: 5b41 6e79 5d29 202d 3e20 5472 6163 653a  [Any]) -> Trace:
+0000a110: 0a20 2020 2020 2020 2023 2055 7369 6e67  .        # Using
+0000a120: 2074 7263 2e70 7974 686f 6e5f 6361 6c6c   trc.python_call
+0000a130: 6162 6c65 2829 206d 616b 6573 2069 7420  able() makes it 
+0000a140: 696d 706f 7373 6962 6c65 2074 6f20 7265  impossible to re
+0000a150: 7472 6163 6520 7468 650a 2020 2020 2020  trace the.      
+0000a160: 2020 2320 6675 6e63 7469 6f6e 2062 6563    # function bec
+0000a170: 6175 7365 2074 6865 2070 7974 686f 6e5f  ause the python_
+0000a180: 6361 6c6c 6162 6c65 2075 7365 7320 7079  callable uses py
+0000a190: 7468 6f6e 5f63 7478 2077 6869 6368 2072  thon_ctx which r
+0000a1a0: 6570 6c61 6365 730a 2020 2020 2020 2020  eplaces.        
+0000a1b0: 2320 7379 6d62 6f6c 206f 6363 7572 7265  # symbol occurre
+0000a1c0: 6e63 6573 2077 6974 6820 6974 7320 7379  nces with its sy
+0000a1d0: 6d62 6f6c 2e5f 6361 6c6c 5f63 7478 2066  mbol._call_ctx f
+0000a1e0: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
+0000a1f0: 4077 7261 7073 2874 7263 2e70 7974 686f  @wraps(trc.pytho
+0000a200: 6e5f 6361 6c6c 6162 6c65 2829 290a 2020  n_callable()).  
+0000a210: 2020 2020 2020 6465 6620 7079 7468 6f6e        def python
+0000a220: 5f63 616c 6c61 626c 6528 2a61 7267 732c  _callable(*args,
+0000a230: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0000a240: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+0000a250: 7661 6c5f 7472 6163 6528 7472 632c 202a  val_trace(trc, *
+0000a260: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+0000a270: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000a280: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0000a290: 6365 2829 2867 7261 6428 7079 7468 6f6e  ce()(grad(python
+0000a2a0: 5f63 616c 6c61 626c 6529 2c20 2a74 7263  _callable), *trc
+0000a2b0: 2e61 7267 732c 202a 2a74 7263 2e6b 7761  .args, **trc.kwa
+0000a2c0: 7267 7329 0a20 2020 2020 2020 2072 6574  rgs).        ret
+0000a2d0: 7572 6e20 6772 6164 7472 630a 0a20 2020  urn gradtrc..   
+0000a2e0: 2063 666e 2e5f 7573 696e 675f 6772 6164   cfn._using_grad
+0000a2f0: 5f74 7261 6e73 666f 726d 203d 2054 7275  _transform = Tru
+0000a300: 650a 2020 2020 7265 7475 726e 2061 6464  e.    return add
+0000a310: 5f74 7261 6e73 666f 726d 2863 666e 2c20  _transform(cfn, 
+0000a320: 7472 616e 7366 6f72 6d3d 5f67 7261 645f  transform=_grad_
+0000a330: 7472 616e 7366 6f72 6d2c 2064 6973 6162  transform, disab
+0000a340: 6c65 5f74 6f72 6368 5f61 7574 6f67 7261  le_torch_autogra
+0000a350: 645f 7375 7070 6f72 743d 5472 7565 290a  d_support=True).
+0000a360: 0a0a 636c 6173 7320 5472 616e 7366 6f72  ..class Transfor
+0000a370: 6d73 2845 6e75 6d29 3a0a 2020 2020 4964  ms(Enum):.    Id
+0000a380: 656e 7469 7479 4f70 203d 2061 7574 6f28  entityOp = auto(
+0000a390: 290a 2020 2020 566d 6170 4f70 203d 2061  ).    VmapOp = a
+0000a3a0: 7574 6f28 290a 2020 2020 4a76 704f 7020  uto().    JvpOp 
+0000a3b0: 3d20 6175 746f 2829 0a20 2020 2056 6a70  = auto().    Vjp
+0000a3c0: 4f70 203d 2061 7574 6f28 290a 0a0a 406c  Op = auto()...@l
+0000a3d0: 7275 5f63 6163 6865 286d 6178 7369 7a65  ru_cache(maxsize
+0000a3e0: 3d4e 6f6e 6529 0a64 6566 2073 796d 626f  =None).def symbo
+0000a3f0: 6c5f 746f 5f65 7661 6c28 626f 756e 645f  l_to_eval(bound_
+0000a400: 7379 6d62 6f6c 293a 0a20 2020 2022 2222  symbol):.    """
+0000a410: 4d61 7020 6120 426f 756e 6453 796d 626f  Map a BoundSymbo
+0000a420: 6c20 746f 2061 2066 756e 6374 696f 6e20  l to a function 
+0000a430: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
+0000a440: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
+0000a450: 2020 2020 2020 626f 756e 645f 7379 6d62        bound_symb
+0000a460: 6f6c 3a20 426f 756e 6453 796d 626f 6c20  ol: BoundSymbol 
+0000a470: 746f 206d 6170 0a20 2020 2022 2222 0a20  to map.    """. 
+0000a480: 2020 2023 2053 796d 626f 6c20 6973 2063     # Symbol is c
+0000a490: 616c 6c61 626c 650a 2020 2020 7265 7475  allable.    retu
+0000a4a0: 726e 2062 6f75 6e64 5f73 796d 626f 6c2e  rn bound_symbol.
+0000a4b0: 7379 6d0a 0a0a 2320 544f 444f 3a20 4375  sym...# TODO: Cu
+0000a4c0: 7272 656e 746c 7920 7765 2075 7365 2074  rrently we use t
+0000a4d0: 7261 6365 2e61 7267 7320 616e 6420 7472  race.args and tr
+0000a4e0: 6163 652e 6b77 6172 6773 2074 6f20 6765  ace.kwargs to ge
+0000a4f0: 7420 7468 6520 6172 6775 6d65 6e74 730a  t the arguments.
+0000a500: 2320 4d61 7962 6520 7765 2073 686f 756c  # Maybe we shoul
+0000a510: 6420 7573 6520 7468 6573 6520 696e 7374  d use these inst
+0000a520: 6561 640a 7472 616e 7366 6f72 6d5f 736b  ead.transform_sk
+0000a530: 6970 5f6c 6973 7420 3d20 280a 2020 2020  ip_list = (.    
+0000a540: 7072 696d 732e 5072 696d 4944 732e 554e  prims.PrimIDs.UN
+0000a550: 5041 434b 5f45 4d50 5459 5f44 4943 542c  PACK_EMPTY_DICT,
+0000a560: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+0000a570: 4473 2e55 4e50 4143 4b5f 4b45 592c 0a20  Ds.UNPACK_KEY,. 
+0000a580: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+0000a590: 2e55 4e50 4143 4b5f 5345 5155 454e 4345  .UNPACK_SEQUENCE
+0000a5a0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+0000a5b0: 4944 732e 554e 5041 434b 5f54 5249 5649  IDs.UNPACK_TRIVI
+0000a5c0: 414c 2c0a 2020 2020 7072 696d 732e 5072  AL,.    prims.Pr
+0000a5d0: 696d 4944 732e 5245 5455 524e 2c0a 290a  imIDs.RETURN,.).
+0000a5e0: 0a0a 6465 6620 6576 616c 5f74 7261 6365  ..def eval_trace
+0000a5f0: 2874 7261 6365 2c20 2a61 7267 732c 2073  (trace, *args, s
+0000a600: 796d 626f 6c5f 6d61 7070 6572 3d73 796d  ymbol_mapper=sym
+0000a610: 626f 6c5f 746f 5f65 7661 6c2c 2077 6974  bol_to_eval, wit
+0000a620: 685f 656e 763d 4661 6c73 652c 202a 2a6b  h_env=False, **k
+0000a630: 7761 7267 7329 3a0a 2020 2020 2222 2245  wargs):.    """E
+0000a640: 7661 6c75 6174 6520 6120 7472 6163 652e  valuate a trace.
+0000a650: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0000a660: 2020 2020 7472 6163 653a 2074 7261 6365      trace: trace
+0000a670: 2074 6f20 6576 616c 7561 7465 0a20 2020   to evaluate.   
+0000a680: 2020 2020 202a 6172 6773 3a20 6172 6775       *args: argu
+0000a690: 6d65 6e74 7320 746f 2065 7661 6c75 6174  ments to evaluat
+0000a6a0: 6520 7468 6520 7472 6163 6520 7769 7468  e the trace with
+0000a6b0: 0a20 2020 2020 2020 2073 796d 626f 6c5f  .        symbol_
+0000a6c0: 6d61 7070 6572 3a20 6675 6e63 7469 6f6e  mapper: function
+0000a6d0: 2074 6861 7420 6d61 7073 2061 2073 796d   that maps a sym
+0000a6e0: 626f 6c20 746f 2061 2066 756e 6374 696f  bol to a functio
+0000a6f0: 6e20 7468 6174 2065 7661 6c75 6174 6573  n that evaluates
+0000a700: 2069 740a 2020 2020 2020 2020 2a2a 6b77   it.        **kw
+0000a710: 6172 6773 3a20 6b65 7977 6f72 6420 6172  args: keyword ar
+0000a720: 6775 6d65 6e74 7320 746f 2065 7661 6c75  guments to evalu
+0000a730: 6174 6520 7468 6520 7472 6163 6520 7769  ate the trace wi
+0000a740: 7468 0a0a 2020 2020 5265 7475 726e 733a  th..    Returns:
+0000a750: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+0000a760: 6f66 2065 7661 6c75 6174 696e 6720 7468  of evaluating th
+0000a770: 6520 7472 6163 650a 2020 2020 2222 220a  e trace.    """.
+0000a780: 2020 2020 656e 7620 3d20 7b7d 0a0a 2020      env = {}..  
+0000a790: 2020 6465 6620 7265 6164 2878 3a20 5661    def read(x: Va
+0000a7a0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
+0000a7b0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+0000a7c0: 2c20 5661 7269 6162 6c65 293a 0a20 2020  , Variable):.   
+0000a7d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000a7e0: 656e 765b 782e 6e61 6d65 5d0a 2020 2020  env[x.name].    
+0000a7f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000a800: 2020 2020 2020 7265 7475 726e 2078 0a0a        return x..
+0000a810: 2020 2020 6465 6620 7772 6974 6528 763a      def write(v:
+0000a820: 2056 6172 6961 626c 652c 2076 616c 3a20   Variable, val: 
+0000a830: 416e 792c 2061 6c6c 6f77 5f64 7570 6c69  Any, allow_dupli
+0000a840: 6361 7465 733d 4661 6c73 6529 202d 3e20  cates=False) -> 
+0000a850: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+0000a860: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+0000a870: 762c 2056 6172 6961 626c 6529 3a0a 2020  v, Variable):.  
+0000a880: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000a890: 0a20 2020 2020 2020 2023 2044 7570 6c69  .        # Dupli
+0000a8a0: 6361 7465 7320 6172 6520 616c 6c6f 7765  cates are allowe
+0000a8b0: 6420 616e 6420 6f76 6572 7772 6974 7465  d and overwritte
+0000a8c0: 6e0a 2020 2020 2020 2020 6966 2076 2e6e  n.        if v.n
+0000a8d0: 616d 6520 696e 2065 6e76 3a0a 2020 2020  ame in env:.    
+0000a8e0: 2020 2020 2020 2020 6966 2061 6c6c 6f77          if allow
+0000a8f0: 5f64 7570 6c69 6361 7465 733a 0a20 2020  _duplicates:.   
+0000a900: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0000a910: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
+0000a920: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000a930: 2866 2256 6172 6961 626c 6520 7b76 2e6e  (f"Variable {v.n
+0000a940: 616d 657d 2069 7320 6265 696e 6720 6f76  ame} is being ov
+0000a950: 6572 7772 6974 7465 6e20 7468 6973 2069  erwritten this i
+0000a960: 7320 6e6f 7420 616c 6c6f 7765 6422 290a  s not allowed").
+0000a970: 2020 2020 2020 2020 656e 765b 762e 6e61          env[v.na
+0000a980: 6d65 5d20 3d20 7661 6c0a 0a20 2020 2073  me] = val..    s
+0000a990: 6166 655f 6d61 705f 666c 6174 2877 7269  afe_map_flat(wri
+0000a9a0: 7465 2c20 6c69 7374 2874 7261 6365 2e61  te, list(trace.a
+0000a9b0: 7267 7329 2c20 6c69 7374 2861 7267 7329  rgs), list(args)
+0000a9c0: 290a 2020 2020 7361 6665 5f6d 6170 5f66  ).    safe_map_f
+0000a9d0: 6c61 7428 7772 6974 652c 206c 6973 7428  lat(write, list(
+0000a9e0: 7472 6163 652e 6b77 6172 6773 2e76 616c  trace.kwargs.val
+0000a9f0: 7565 7328 2929 2c20 6c69 7374 286b 7761  ues()), list(kwa
+0000aa00: 7267 732e 7661 6c75 6573 2829 2929 0a0a  rgs.values()))..
+0000aa10: 2020 2020 666f 7220 7379 6d62 6f6c 2069      for symbol i
+0000aa20: 6e20 7472 6163 652e 626f 756e 645f 7379  n trace.bound_sy
+0000aa30: 6d62 6f6c 733a 0a20 2020 2020 2020 2069  mbols:.        i
+0000aa40: 6620 7379 6d62 6f6c 2e73 796d 2e69 6420  f symbol.sym.id 
+0000aa50: 696e 2074 7261 6e73 666f 726d 5f73 6b69  in transform_ski
+0000aa60: 705f 6c69 7374 3a0a 2020 2020 2020 2020  p_list:.        
+0000aa70: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+0000aa80: 2020 2020 2061 7267 7320 3d20 7472 6565       args = tree
+0000aa90: 5f6d 6170 2872 6561 642c 2073 796d 626f  _map(read, symbo
+0000aaa0: 6c2e 6172 6773 290a 2020 2020 2020 2020  l.args).        
+0000aab0: 6b77 6172 6773 203d 2074 7265 655f 6d61  kwargs = tree_ma
+0000aac0: 7028 7265 6164 2c20 7379 6d62 6f6c 2e6b  p(read, symbol.k
+0000aad0: 7761 7267 7329 0a20 2020 2020 2020 2070  wargs).        p
+0000aae0: 7269 6d5f 6675 6e63 203d 2073 796d 626f  rim_func = symbo
+0000aaf0: 6c5f 6d61 7070 6572 2873 796d 626f 6c29  l_mapper(symbol)
+0000ab00: 0a20 2020 2020 2020 2069 6620 7072 696d  .        if prim
+0000ab10: 5f66 756e 6320 6973 204e 6f6e 653a 0a20  _func is None:. 
+0000ab20: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0000ab30: 6e75 650a 2020 2020 2020 2020 7265 7375  nue.        resu
+0000ab40: 6c74 203d 2070 7269 6d5f 6675 6e63 282a  lt = prim_func(*
+0000ab50: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+0000ab60: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
+0000ab70: 5f66 6c61 7428 7772 6974 652c 206c 6973  _flat(write, lis
+0000ab80: 7428 7365 7175 656e 6369 6679 2873 796d  t(sequencify(sym
+0000ab90: 626f 6c2e 6f75 7470 7574 2929 2c20 6c69  bol.output)), li
+0000aba0: 7374 2873 6571 7565 6e63 6966 7928 7265  st(sequencify(re
+0000abb0: 7375 6c74 2929 290a 0a20 2020 2069 6620  sult)))..    if 
+0000abc0: 7769 7468 5f65 6e76 3a0a 2020 2020 2020  with_env:.      
+0000abd0: 2020 7265 7475 726e 2074 7265 655f 6d61    return tree_ma
+0000abe0: 7028 7265 6164 2c20 7472 6163 652e 6f75  p(read, trace.ou
+0000abf0: 7470 7574 292c 2065 6e76 0a0a 2020 2020  tput), env..    
+0000ac00: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
+0000ac10: 7265 6164 2c20 7472 6163 652e 6f75 7470  read, trace.outp
+0000ac20: 7574 290a 0a0a 6465 6620 5f69 6465 6e74  ut)...def _ident
+0000ac30: 6974 795f 6361 6c6c 5f6d 6574 6166 756e  ity_call_metafun
+0000ac40: 6328 2a61 7267 732c 2074 7261 6365 3a20  c(*args, trace: 
+0000ac50: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
+0000ac60: 3a0a 2020 2020 7769 7468 2064 6574 6163  :.    with detac
+0000ac70: 6865 645f 7472 6163 6528 293a 0a20 2020  hed_trace():.   
+0000ac80: 2020 2020 2072 6574 7572 6e20 6576 616c       return eval
+0000ac90: 5f74 7261 6365 2874 7261 6365 2c20 2a61  _trace(trace, *a
+0000aca0: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
+0000acb0: 0a69 6465 6e74 6974 795f 6361 6c6c 203d  .identity_call =
+0000acc0: 2053 796d 626f 6c28 6964 3d54 7261 6e73   Symbol(id=Trans
+0000acd0: 666f 726d 732e 4964 656e 7469 7479 4f70  forms.IdentityOp
+0000ace0: 2c20 6e61 6d65 3d22 6964 656e 7469 7479  , name="identity
+0000acf0: 5f63 616c 6c22 2c20 6d65 7461 3d5f 6964  _call", meta=_id
+0000ad00: 656e 7469 7479 5f63 616c 6c5f 6d65 7461  entity_call_meta
+0000ad10: 6675 6e63 290a 0a0a 6465 6620 6964 656e  func)...def iden
+0000ad20: 7469 7479 2866 756e 6329 3a0a 2020 2020  tity(func):.    
+0000ad30: 2222 2249 6465 6e74 6974 7920 7472 616e  """Identity tran
+0000ad40: 7366 6f72 6d20 666f 7220 6120 5468 756e  sform for a Thun
+0000ad50: 6465 7220 6675 6e63 7469 6f6e 2e0a 0a20  der function... 
+0000ad60: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000ad70: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
+0000ad80: 3a20 4120 5468 756e 6465 7220 6675 6e63  : A Thunder func
+0000ad90: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
+0000ada0: 666f 726d 6564 2e0a 2020 2020 2222 220a  formed..    """.
+0000adb0: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
+0000adc0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000add0: 293a 0a20 2020 2020 2020 2074 7261 6365  ):.        trace
+0000ade0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0000adf0: 6365 2829 2866 756e 632c 202a 6172 6773  ce()(func, *args
+0000ae00: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0000ae10: 2020 2020 7265 7475 726e 2069 6465 6e74      return ident
+0000ae20: 6974 795f 6361 6c6c 282a 6172 6773 2c20  ity_call(*args, 
+0000ae30: 2a2a 6b77 6172 6773 2c20 7472 6163 653d  **kwargs, trace=
+0000ae40: 7472 6163 6529 0a0a 2020 2020 7265 7475  trace)..    retu
+0000ae50: 726e 2077 7261 7070 6572 0a0a 0a64 6566  rn wrapper...def
+0000ae60: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
+0000ae70: 7079 746f 7263 6828 2a61 7267 732c 2074  pytorch(*args, t
+0000ae80: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
+0000ae90: 7761 7267 7329 3a0a 2020 2020 696d 706f  wargs):.    impo
+0000aea0: 7274 2074 6f72 6368 0a0a 2020 2020 6465  rt torch..    de
+0000aeb0: 6620 7379 6d62 6f6c 5f6d 6170 7065 7228  f symbol_mapper(
+0000aec0: 6f70 293a 0a20 2020 2020 2020 2069 6620  op):.        if 
+0000aed0: 6f70 2e6f 7020 3d3d 2054 7261 6e73 666f  op.op == Transfo
+0000aee0: 726d 732e 4964 656e 7469 7479 4f70 3a0a  rms.IdentityOp:.
+0000aef0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000af00: 726e 205f 6964 656e 7469 7479 5f63 616c  rn _identity_cal
+0000af10: 6c5f 7079 746f 7263 680a 0a20 2020 2020  l_pytorch..     
+0000af20: 2020 2074 6f72 6368 5f6f 7020 3d20 6f70     torch_op = op
+0000af30: 735f 746f 5f74 6f72 6368 5f6f 7073 5f6d  s_to_torch_ops_m
+0000af40: 6170 5b6f 702e 6f70 5d0a 2020 2020 2020  ap[op.op].      
+0000af50: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000af60: 746f 7263 685f 6f70 2c20 7374 7229 3a0a  torch_op, str):.
+0000af70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000af80: 726e 2067 6574 6174 7472 2874 6f72 6368  rn getattr(torch
+0000af90: 2c20 746f 7263 685f 6f70 2e73 7472 6970  , torch_op.strip
+0000afa0: 2822 7079 746f 7263 682e 2229 290a 2020  ("pytorch.")).  
+0000afb0: 2020 2020 2020 7265 7475 726e 2074 6f72        return tor
+0000afc0: 6368 5f6f 700a 0a20 2020 2077 6974 6820  ch_op..    with 
+0000afd0: 6465 7461 6368 6564 5f74 7261 6365 2829  detached_trace()
+0000afe0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000aff0: 2065 7661 6c5f 7472 6163 6528 7472 6163   eval_trace(trac
+0000b000: 652c 202a 6172 6773 2c20 2a2a 6b77 6172  e, *args, **kwar
+0000b010: 6773 2c20 7379 6d62 6f6c 5f6d 6170 7065  gs, symbol_mappe
+0000b020: 723d 7379 6d62 6f6c 5f6d 6170 7065 7229  r=symbol_mapper)
+0000b030: 0a0a 0a23 2052 6567 6973 7465 7220 7468  ...# Register th
+0000b040: 6520 6964 656e 7469 7479 2063 616c 6c20  e identity call 
+0000b050: 666f 7220 5079 546f 7263 6820 6578 6563  for PyTorch exec
+0000b060: 7574 6f72 2e0a 2320 6f70 735f 746f 5f74  utor..# ops_to_t
+0000b070: 6f72 6368 5f6f 7073 5f6d 6170 5b54 7261  orch_ops_map[Tra
+0000b080: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
+0000b090: 4f70 5d20 3d20 5f69 6465 6e74 6974 795f  Op] = _identity_
+0000b0a0: 6361 6c6c 5f70 7974 6f72 6368 0a0a 0a23  call_pytorch...#
+0000b0b0: 2056 4d41 5020 7472 616e 7366 6f72 6d0a   VMAP transform.
+0000b0c0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  # -------------.
+0000b0d0: 0a0a 636c 6173 7320 4e6f 744d 6170 7065  ..class NotMappe
+0000b0e0: 643a 0a20 2020 2022 2222 5265 7072 6573  d:.    """Repres
+0000b0f0: 656e 7473 2061 206e 6f6e 2d62 6174 6368  ents a non-batch
+0000b100: 6564 2064 696d 656e 7369 6f6e 2e22 2222  ed dimension."""
+0000b110: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+0000b120: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+0000b130: 2020 7265 7475 726e 2022 6e6f 745f 6d61    return "not_ma
+0000b140: 7070 6564 220a 0a0a 4064 6174 6163 6c61  pped"...@datacla
+0000b150: 7373 2866 726f 7a65 6e3d 5472 7565 290a  ss(frozen=True).
+0000b160: 636c 6173 7320 4261 7463 6865 6456 616c  class BatchedVal
+0000b170: 7565 3a0a 2020 2020 2222 2242 6174 6368  ue:.    """Batch
+0000b180: 6564 2076 616c 7565 2066 6f72 2074 6865  ed value for the
+0000b190: 2076 6d61 7020 7472 616e 7366 6f72 6d2e   vmap transform.
+0000b1a0: 0a0a 2020 2020 4174 7472 6962 7574 6573  ..    Attributes
+0000b1b0: 3a0a 2020 2020 2020 2020 7661 6c75 653a  :.        value:
+0000b1c0: 2042 6174 6368 6564 2076 616c 7565 2e0a   Batched value..
+0000b1d0: 2020 2020 2020 2020 6261 7463 685f 6469          batch_di
+0000b1e0: 6d3a 2042 6174 6368 696e 6720 6469 6d65  m: Batching dime
+0000b1f0: 6e73 696f 6e20 6f72 206e 6f74 5f6d 6170  nsion or not_map
+0000b200: 7065 640a 2020 2020 2222 220a 0a20 2020  ped.    """..   
+0000b210: 2076 616c 7565 3a20 416e 790a 2020 2020   value: Any.    
+0000b220: 6261 7463 685f 6469 6d3a 2069 6e74 207c  batch_dim: int |
+0000b230: 204e 6f74 4d61 7070 6564 0a0a 2020 2020   NotMapped..    
+0000b240: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
+0000b250: 6629 3a0a 2020 2020 2020 2020 7969 656c  f):.        yiel
+0000b260: 6420 7365 6c66 2e76 616c 7565 0a20 2020  d self.value.   
+0000b270: 2020 2020 2079 6965 6c64 2073 656c 662e       yield self.
+0000b280: 6261 7463 685f 6469 6d0a 0a0a 6465 6620  batch_dim...def 
+0000b290: 7061 6972 5f74 6f5f 6261 7463 6865 645f  pair_to_batched_
+0000b2a0: 7661 6c75 6528 7061 6972 293a 0a20 2020  value(pair):.   
+0000b2b0: 2022 2222 436f 6e76 6572 7473 2061 2070   """Converts a p
+0000b2c0: 6169 7220 746f 2061 2042 6174 6368 6564  air to a Batched
+0000b2d0: 5661 6c75 652e 0a0a 2020 2020 4172 6773  Value...    Args
+0000b2e0: 3a0a 2020 2020 2020 2020 7061 6972 2028  :.        pair (
+0000b2f0: 5365 7175 656e 6365 293a 2050 6169 7220  Sequence): Pair 
+0000b300: 746f 2063 6f6e 7665 7274 2e0a 0a20 2020  to convert...   
+0000b310: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0000b320: 2020 4261 7463 6865 6456 616c 7565 3a20    BatchedValue: 
+0000b330: 4261 7463 6865 6456 616c 7565 2072 6570  BatchedValue rep
+0000b340: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
+0000b350: 6865 2070 6169 722e 0a20 2020 2022 2222  he pair..    """
+0000b360: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
+0000b370: 6365 2870 6169 722c 2042 6174 6368 6564  ce(pair, Batched
+0000b380: 5661 6c75 6529 3a0a 2020 2020 2020 2020  Value):.        
+0000b390: 7265 7475 726e 2070 6169 720a 2020 2020  return pair.    
+0000b3a0: 656c 7365 3a0a 2020 2020 2020 2020 6173  else:.        as
+0000b3b0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0000b3c0: 7061 6972 2c20 5365 7175 656e 6365 2920  pair, Sequence) 
+0000b3d0: 616e 6420 6c65 6e28 7061 6972 2920 3d3d  and len(pair) ==
+0000b3e0: 2032 0a20 2020 2020 2020 2072 6574 7572   2.        retur
+0000b3f0: 6e20 4261 7463 6865 6456 616c 7565 282a  n BatchedValue(*
+0000b400: 7061 6972 290a 0a0a 6465 6620 7665 6374  pair)...def vect
+0000b410: 6f72 697a 6564 5f62 6174 6368 6572 2870  orized_batcher(p
+0000b420: 7269 6d2c 2061 7869 735f 7369 7a65 2c20  rim, axis_size, 
+0000b430: 6261 7463 6865 645f 7661 6c75 6573 2c20  batched_values, 
+0000b440: 2a2a 6b77 6172 6773 293a 0a20 2020 2062  **kwargs):.    b
+0000b450: 6174 6368 5f64 696d 203d 2062 6174 6368  atch_dim = batch
+0000b460: 6564 5f76 616c 7565 735b 305d 2e62 6174  ed_values[0].bat
+0000b470: 6368 5f64 696d 0a20 2020 2061 7373 6572  ch_dim.    asser
+0000b480: 7420 616c 6c28 0a20 2020 2020 2020 2062  t all(.        b
+0000b490: 6174 6368 5f64 696d 203d 3d20 6276 2e62  atch_dim == bv.b
+0000b4a0: 6174 6368 5f64 696d 2066 6f72 2062 7620  atch_dim for bv 
+0000b4b0: 696e 2062 6174 6368 6564 5f76 616c 7565  in batched_value
+0000b4c0: 735b 313a 5d0a 2020 2020 292c 2066 2260  s[1:].    ), f"`
+0000b4d0: 7665 6374 6f72 697a 6564 5f62 6174 6368  vectorized_batch
+0000b4e0: 6572 6020 676f 7420 6469 6666 6572 656e  er` got differen
+0000b4f0: 7420 6261 7463 6865 6420 6469 6d65 6e73  t batched dimens
+0000b500: 696f 6e73 207b 5b62 762e 6261 7463 685f  ions {[bv.batch_
+0000b510: 6469 6d20 666f 7220 6276 2069 6e20 6261  dim for bv in ba
+0000b520: 7463 6865 645f 7661 6c75 6573 5d7d 220a  tched_values]}".
+0000b530: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+0000b540: 6564 5661 6c75 6528 7072 696d 282a 5b62  edValue(prim(*[b
+0000b550: 762e 7661 6c75 6520 666f 7220 6276 2069  v.value for bv i
+0000b560: 6e20 6261 7463 6865 645f 7661 6c75 6573  n batched_values
+0000b570: 5d2c 202a 2a6b 7761 7267 7329 2c20 6261  ], **kwargs), ba
+0000b580: 7463 685f 6469 6d29 0a0a 0a6e 6f74 5f6d  tch_dim)...not_m
+0000b590: 6170 7065 6420 3d20 4e6f 744d 6170 7065  apped = NotMappe
+0000b5a0: 6428 290a 0a0a 6465 6620 6d6f 7665 6469  d()...def movedi
+0000b5b0: 6d28 782c 2073 7263 3a20 696e 742c 2064  m(x, src: int, d
+0000b5c0: 7374 3a20 696e 7429 3a0a 2020 2020 7065  st: int):.    pe
+0000b5d0: 726d 203d 205b 6920 666f 7220 6920 696e  rm = [i for i in
+0000b5e0: 2072 616e 6765 2878 2e6e 6469 6d29 2069   range(x.ndim) i
+0000b5f0: 6620 6920 213d 2073 7263 5d0a 2020 2020  f i != src].    
+0000b600: 7065 726d 2e69 6e73 6572 7428 6473 742c  perm.insert(dst,
+0000b610: 2073 7263 290a 2020 2020 7265 7475 726e   src).    return
+0000b620: 2070 7269 6d73 2e74 7261 6e73 706f 7365   prims.transpose
+0000b630: 2878 2c20 7475 706c 6528 7065 726d 2929  (x, tuple(perm))
+0000b640: 0a0a 0a64 6566 206d 6f76 655f 6261 7463  ...def move_batc
+0000b650: 685f 6469 6d28 6178 6973 5f73 697a 652c  h_dim(axis_size,
+0000b660: 2073 7263 2c20 6473 742c 2078 293a 0a20   src, dst, x):. 
+0000b670: 2020 2069 6620 7372 6320 6973 206e 6f74     if src is not
+0000b680: 5f6d 6170 7065 643a 0a20 2020 2020 2020  _mapped:.       
+0000b690: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
+0000b6a0: 2c20 4e75 6d62 6572 293a 0a20 2020 2020  , Number):.     
+0000b6b0: 2020 2020 2020 2072 6574 7572 6e20 780a         return x.
+0000b6c0: 2020 2020 2020 2020 7461 7267 6574 5f73          target_s
+0000b6d0: 6861 7065 203d 206c 6973 7428 782e 7368  hape = list(x.sh
+0000b6e0: 6170 6529 0a20 2020 2020 2020 2074 6172  ape).        tar
+0000b6f0: 6765 745f 7368 6170 652e 696e 7365 7274  get_shape.insert
+0000b700: 2864 7374 2c20 6178 6973 5f73 697a 6529  (dst, axis_size)
+0000b710: 0a20 2020 2020 2020 2062 6361 7374 5f64  .        bcast_d
+0000b720: 696d 7320 3d20 6c69 7374 2872 616e 6765  ims = list(range
+0000b730: 286c 656e 2874 6172 6765 745f 7368 6170  (len(target_shap
+0000b740: 6529 2929 0a20 2020 2020 2020 2062 6361  e))).        bca
+0000b750: 7374 5f64 696d 732e 706f 7028 6473 7429  st_dims.pop(dst)
+0000b760: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000b770: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
+0000b780: 696e 5f64 696d 2878 2c20 7461 7267 6574  in_dim(x, target
+0000b790: 5f73 6861 7065 2c20 6263 6173 745f 6469  _shape, bcast_di
+0000b7a0: 6d73 290a 2020 2020 656c 6966 2073 7263  ms).    elif src
+0000b7b0: 203d 3d20 6473 743a 0a20 2020 2020 2020   == dst:.       
+0000b7c0: 2072 6574 7572 6e20 780a 2020 2020 656c   return x.    el
+0000b7d0: 7365 3a0a 2020 2020 2020 2020 7265 7475  se:.        retu
+0000b7e0: 726e 206d 6f76 6564 696d 2878 2c20 7372  rn movedim(x, sr
+0000b7f0: 632c 2064 7374 290a 0a0a 6465 6620 6269  c, dst)...def bi
+0000b800: 6e61 7279 5f6f 705f 6261 7463 6869 6e67  nary_op_batching
+0000b810: 5f72 756c 6528 6f70 3a20 7072 696d 732e  _rule(op: prims.
+0000b820: 5072 696d 4944 732c 2061 7869 735f 7369  PrimIDs, axis_si
+0000b830: 7a65 3a20 696e 742c 2076 616c 735f 696e  ze: int, vals_in
+0000b840: 3a20 4261 7463 6865 6456 616c 7565 293a  : BatchedValue):
+0000b850: 0a20 2020 2028 2878 2c20 785f 6264 696d  .    ((x, x_bdim
+0000b860: 292c 2028 792c 2079 5f62 6469 6d29 2920  ), (y, y_bdim)) 
+0000b870: 3d20 7661 6c73 5f69 6e0a 2020 2020 6966  = vals_in.    if
+0000b880: 2078 5f62 6469 6d20 213d 2079 5f62 6469   x_bdim != y_bdi
+0000b890: 6d3a 0a20 2020 2020 2020 2069 6620 785f  m:.        if x_
+0000b8a0: 6264 696d 2069 7320 6e6f 745f 6d61 7070  bdim is not_mapp
+0000b8b0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+0000b8c0: 7820 3d20 6d6f 7665 5f62 6174 6368 5f64  x = move_batch_d
+0000b8d0: 696d 2861 7869 735f 7369 7a65 2c20 785f  im(axis_size, x_
+0000b8e0: 6264 696d 2c20 795f 6264 696d 2c20 7829  bdim, y_bdim, x)
+0000b8f0: 0a20 2020 2020 2020 2020 2020 2078 5f62  .            x_b
+0000b900: 6469 6d20 3d20 795f 6264 696d 0a20 2020  dim = y_bdim.   
+0000b910: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000b920: 2020 2020 2020 2079 203d 206d 6f76 655f         y = move_
+0000b930: 6261 7463 685f 6469 6d28 6178 6973 5f73  batch_dim(axis_s
+0000b940: 697a 652c 2079 5f62 6469 6d2c 2078 5f62  ize, y_bdim, x_b
+0000b950: 6469 6d2c 2079 290a 2020 2020 7265 7475  dim, y).    retu
+0000b960: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+0000b970: 6f70 2878 2c20 7929 2c20 785f 6264 696d  op(x, y), x_bdim
+0000b980: 290a 0a0a 6465 6620 7369 6e5f 766d 6170  )...def sin_vmap
+0000b990: 2861 7869 735f 7369 7a65 3a20 696e 742c  (axis_size: int,
+0000b9a0: 2061 3a20 4261 7463 6865 6456 616c 7565   a: BatchedValue
+0000b9b0: 2920 2d3e 2042 6174 6368 6564 5661 6c75  ) -> BatchedValu
+0000b9c0: 653a 0a20 2020 2072 6574 7572 6e20 7665  e:.    return ve
+0000b9d0: 6374 6f72 697a 6564 5f62 6174 6368 6572  ctorized_batcher
+0000b9e0: 2870 7269 6d73 2e73 696e 2c20 6178 6973  (prims.sin, axis
+0000b9f0: 5f73 697a 652c 2028 612c 2929 0a0a 0a64  _size, (a,))...d
+0000ba00: 6566 2063 6f73 5f76 6d61 7028 6178 6973  ef cos_vmap(axis
+0000ba10: 5f73 697a 653a 2069 6e74 2c20 613a 2042  _size: int, a: B
+0000ba20: 6174 6368 6564 5661 6c75 6529 202d 3e20  atchedValue) -> 
+0000ba30: 4261 7463 6865 6456 616c 7565 3a0a 2020  BatchedValue:.  
+0000ba40: 2020 7265 7475 726e 2076 6563 746f 7269    return vectori
+0000ba50: 7a65 645f 6261 7463 6865 7228 7072 696d  zed_batcher(prim
+0000ba60: 732e 636f 732c 2061 7869 735f 7369 7a65  s.cos, axis_size
+0000ba70: 2c20 2861 2c29 290a 0a0a 6465 6620 6d75  , (a,))...def mu
+0000ba80: 6c5f 766d 6170 2861 7869 735f 7369 7a65  l_vmap(axis_size
+0000ba90: 3a20 696e 742c 2061 3a20 4261 7463 6865  : int, a: Batche
+0000baa0: 6456 616c 7565 2c20 623a 2042 6174 6368  dValue, b: Batch
+0000bab0: 6564 5661 6c75 6529 202d 3e20 4261 7463  edValue) -> Batc
+0000bac0: 6865 6456 616c 7565 3a0a 2020 2020 7265  hedValue:.    re
+0000bad0: 7475 726e 2062 696e 6172 795f 6f70 5f62  turn binary_op_b
+0000bae0: 6174 6368 696e 675f 7275 6c65 2870 7269  atching_rule(pri
+0000baf0: 6d73 2e6d 756c 2c20 6178 6973 5f73 697a  ms.mul, axis_siz
+0000bb00: 652c 2028 612c 2062 2929 0a0a 0a64 6566  e, (a, b))...def
+0000bb10: 2061 6464 5f76 6d61 7028 6178 6973 5f73   add_vmap(axis_s
+0000bb20: 697a 653a 2069 6e74 2c20 613a 2042 6174  ize: int, a: Bat
+0000bb30: 6368 6564 5661 6c75 652c 2062 3a20 4261  chedValue, b: Ba
+0000bb40: 7463 6865 6456 616c 7565 2920 2d3e 2042  tchedValue) -> B
+0000bb50: 6174 6368 6564 5661 6c75 653a 0a20 2020  atchedValue:.   
+0000bb60: 2072 6574 7572 6e20 6269 6e61 7279 5f6f   return binary_o
+0000bb70: 705f 6261 7463 6869 6e67 5f72 756c 6528  p_batching_rule(
+0000bb80: 7072 696d 732e 6164 642c 2061 7869 735f  prims.add, axis_
+0000bb90: 7369 7a65 2c20 2861 2c20 6229 290a 0a0a  size, (a, b))...
+0000bba0: 6465 6620 7375 6d5f 766d 6170 2861 7869  def sum_vmap(axi
+0000bbb0: 735f 7369 7a65 3a20 696e 742c 2061 3a20  s_size: int, a: 
+0000bbc0: 4261 7463 6865 6456 616c 7565 2c20 6469  BatchedValue, di
+0000bbd0: 6d73 3a20 5365 7175 656e 6365 5b69 6e74  ms: Sequence[int
+0000bbe0: 5d2c 202a 2a6b 7761 7267 7329 202d 3e20  ], **kwargs) -> 
+0000bbf0: 4261 7463 6865 6456 616c 7565 3a0a 2020  BatchedValue:.  
+0000bc00: 2020 6264 696d 203d 2061 2e62 6174 6368    bdim = a.batch
+0000bc10: 5f64 696d 0a20 2020 2023 2054 4f44 4f3a  _dim.    # TODO:
+0000bc20: 2072 656d 6f76 6520 7468 6973 2077 6865   remove this whe
+0000bc30: 6e20 6469 6d73 2062 6563 6f6d 6573 2061  n dims becomes a
+0000bc40: 206d 616e 6461 746f 7279 206b 7761 7267   mandatory kwarg
+0000bc50: 0a20 2020 2069 6620 6c65 6e28 6469 6d73  .    if len(dims
+0000bc60: 2920 3e20 303a 0a20 2020 2020 2020 2064  ) > 0:.        d
+0000bc70: 696d 732c 205f 203d 2073 6166 655f 7a69  ims, _ = safe_zi
+0000bc80: 7028 2a64 696d 7329 0a20 2020 2064 696d  p(*dims).    dim
+0000bc90: 735f 6265 666f 7265 203d 2074 7570 6c65  s_before = tuple
+0000bca0: 2865 6c20 666f 7220 656c 2069 6e20 6469  (el for el in di
+0000bcb0: 6d73 2069 6620 656c 203c 2062 6469 6d29  ms if el < bdim)
+0000bcc0: 0a20 2020 2064 696d 735f 6166 7465 7220  .    dims_after 
+0000bcd0: 3d20 7475 706c 6528 656c 202b 2031 2066  = tuple(el + 1 f
+0000bce0: 6f72 2065 6c20 696e 2064 696d 7320 6966  or el in dims if
+0000bcf0: 2065 6c20 3e3d 2062 6469 6d29 0a20 2020   el >= bdim).   
+0000bd00: 2062 6174 6368 6564 5f64 696d 7320 3d20   batched_dims = 
+0000bd10: 6469 6d73 5f62 6566 6f72 6520 2b20 6469  dims_before + di
+0000bd20: 6d73 5f61 6674 6572 0a20 2020 2072 6574  ms_after.    ret
+0000bd30: 7572 6e20 7665 6374 6f72 697a 6564 5f62  urn vectorized_b
+0000bd40: 6174 6368 6572 2870 7269 6d73 2e73 756d  atcher(prims.sum
+0000bd50: 2c20 6178 6973 5f73 697a 652c 2028 612c  , axis_size, (a,
+0000bd60: 292c 2064 696d 733d 6261 7463 6865 645f  ), dims=batched_
+0000bd70: 6469 6d73 2c20 2a2a 6b77 6172 6773 290a  dims, **kwargs).
+0000bd80: 0a0a 2320 544f 444f 3a20 506c 6561 7365  ..# TODO: Please
+0000bd90: 2074 6573 7420 7468 6973 2065 7874 656e   test this exten
+0000bda0: 7369 7665 6c79 0a64 6566 2062 726f 6164  sively.def broad
+0000bdb0: 6361 7374 5f69 6e5f 6469 6d5f 766d 6170  cast_in_dim_vmap
+0000bdc0: 280a 2020 2020 6178 6973 5f73 697a 653a  (.    axis_size:
+0000bdd0: 2069 6e74 2c20 613a 2042 6174 6368 6564   int, a: Batched
+0000bde0: 5661 6c75 652c 2073 6861 7065 3a20 5365  Value, shape: Se
+0000bdf0: 7175 656e 6365 5b42 6174 6368 6564 5661  quence[BatchedVa
+0000be00: 6c75 655d 2c20 6272 6f61 6463 6173 745f  lue], broadcast_
+0000be10: 6469 6d65 6e73 696f 6e73 3a20 5365 7175  dimensions: Sequ
+0000be20: 656e 6365 5b42 6174 6368 6564 5661 6c75  ence[BatchedValu
+0000be30: 655d 0a29 202d 3e20 4261 7463 6865 6456  e].) -> BatchedV
+0000be40: 616c 7565 3a0a 2020 2020 6264 696d 203d  alue:.    bdim =
+0000be50: 2061 2e62 6174 6368 5f64 696d 0a20 2020   a.batch_dim.   
+0000be60: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
+0000be70: 7468 6973 2077 6865 6e20 7368 6170 6520  this when shape 
+0000be80: 616e 6420 6272 6f61 6463 6173 745f 6469  and broadcast_di
+0000be90: 6d65 6e73 696f 6e73 2062 6563 6f6d 6520  mensions become 
+0000bea0: 6d61 6e64 6174 6f72 7920 6b77 6172 6773  mandatory kwargs
+0000beb0: 0a20 2020 2073 6861 7065 2c20 5f20 3d20  .    shape, _ = 
+0000bec0: 7361 6665 5f7a 6970 282a 7368 6170 6529  safe_zip(*shape)
+0000bed0: 0a20 2020 2069 6620 6c65 6e28 6272 6f61  .    if len(broa
+0000bee0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+0000bef0: 2920 3e20 303a 0a20 2020 2020 2020 2062  ) > 0:.        b
+0000bf00: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
+0000bf10: 6f6e 732c 205f 203d 2073 6166 655f 7a69  ons, _ = safe_zi
+0000bf20: 7028 2a62 726f 6164 6361 7374 5f64 696d  p(*broadcast_dim
+0000bf30: 656e 7369 6f6e 7329 0a20 2020 2069 6620  ensions).    if 
+0000bf40: 6264 696d 2069 7320 6e6f 745f 6d61 7070  bdim is not_mapp
+0000bf50: 6564 3a0a 2020 2020 2020 2020 7265 7475  ed:.        retu
+0000bf60: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
+0000bf70: 7072 696d 732e 6272 6f61 6463 6173 745f  prims.broadcast_
+0000bf80: 696e 5f64 696d 2861 2e76 616c 7565 2c20  in_dim(a.value, 
+0000bf90: 7368 6170 652c 2062 726f 6164 6361 7374  shape, broadcast
+0000bfa0: 5f64 696d 656e 7369 6f6e 7329 2c20 6264  _dimensions), bd
+0000bfb0: 696d 290a 2020 2020 656c 7365 3a0a 2020  im).    else:.  
+0000bfc0: 2020 2020 2020 6e65 775f 6264 696d 203d        new_bdim =
+0000bfd0: 2062 6469 6d20 2b20 7375 6d28 3120 666f   bdim + sum(1 fo
+0000bfe0: 7220 6469 6d20 696e 2062 726f 6164 6361  r dim in broadca
+0000bff0: 7374 5f64 696d 656e 7369 6f6e 7320 6966  st_dimensions if
+0000c000: 2064 696d 203c 2062 6469 6d29 0a20 2020   dim < bdim).   
+0000c010: 2020 2020 206e 6577 5f73 6861 7065 203d       new_shape =
+0000c020: 206c 6973 7428 7368 6170 6529 0a20 2020   list(shape).   
+0000c030: 2020 2020 206e 6577 5f73 6861 7065 2e69       new_shape.i
+0000c040: 6e73 6572 7428 6e65 775f 6264 696d 2c20  nsert(new_bdim, 
+0000c050: 6178 6973 5f73 697a 6529 0a20 2020 2020  axis_size).     
+0000c060: 2020 206e 6577 5f62 726f 6164 6361 7374     new_broadcast
+0000c070: 5f64 696d 656e 7369 6f6e 7320 3d20 2830  _dimensions = (0
+0000c080: 2c29 202b 2074 7570 6c65 2864 696d 202b  ,) + tuple(dim +
+0000c090: 2031 2069 6620 6469 6d20 3e3d 2062 6469   1 if dim >= bdi
+0000c0a0: 6d20 656c 7365 2064 696d 2066 6f72 2064  m else dim for d
+0000c0b0: 696d 2069 6e20 6272 6f61 6463 6173 745f  im in broadcast_
+0000c0c0: 6469 6d65 6e73 696f 6e73 290a 2020 2020  dimensions).    
+0000c0d0: 2020 2020 6966 2062 726f 6164 6361 7374      if broadcast
+0000c0e0: 5f64 696d 656e 7369 6f6e 7320 3d3d 2028  _dimensions == (
+0000c0f0: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
+0000c100: 6577 5f62 726f 6164 6361 7374 5f64 696d  ew_broadcast_dim
+0000c110: 656e 7369 6f6e 7320 3d20 2829 0a20 2020  ensions = ().   
+0000c120: 2020 2020 2072 6574 7572 6e20 4261 7463       return Batc
+0000c130: 6865 6456 616c 7565 2870 7269 6d73 2e62  hedValue(prims.b
+0000c140: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
+0000c150: 612e 7661 6c75 652c 206e 6577 5f73 6861  a.value, new_sha
+0000c160: 7065 2c20 6e65 775f 6272 6f61 6463 6173  pe, new_broadcas
+0000c170: 745f 6469 6d65 6e73 696f 6e73 292c 206e  t_dimensions), n
+0000c180: 6577 5f62 6469 6d29 0a0a 0a76 6d61 705f  ew_bdim)...vmap_
+0000c190: 696d 706c 733a 2064 6963 745b 7072 696d  impls: dict[prim
+0000c1a0: 732e 5379 6d62 6f6c 2c20 4361 6c6c 6162  s.Symbol, Callab
+0000c1b0: 6c65 5d20 3d20 6469 6374 2829 0a0a 0a64  le] = dict()...d
+0000c1c0: 6566 2075 6e77 7261 705f 6f6e 655f 6c65  ef unwrap_one_le
+0000c1d0: 7665 6c5f 6f66 5f73 7562 7379 6d62 6f6c  vel_of_subsymbol
+0000c1e0: 7328 7472 6163 6529 3a0a 2020 2020 6e65  s(trace):.    ne
+0000c1f0: 775f 7379 6d62 6f6c 735f 6974 6572 203d  w_symbols_iter =
+0000c200: 2028 0a20 2020 2020 2020 2062 6f75 6e64   (.        bound
+0000c210: 5f73 796d 626f 6c2e 7375 6273 796d 626f  _symbol.subsymbo
+0000c220: 6c73 2069 6620 6c65 6e28 626f 756e 645f  ls if len(bound_
+0000c230: 7379 6d62 6f6c 2e73 7562 7379 6d62 6f6c  symbol.subsymbol
+0000c240: 7329 203e 2030 2065 6c73 6520 5b62 6f75  s) > 0 else [bou
+0000c250: 6e64 5f73 796d 626f 6c5d 0a20 2020 2020  nd_symbol].     
+0000c260: 2020 2066 6f72 2062 6f75 6e64 5f73 796d     for bound_sym
+0000c270: 626f 6c20 696e 2074 7261 6365 2e62 6f75  bol in trace.bou
+0000c280: 6e64 5f73 796d 626f 6c73 0a20 2020 2029  nd_symbols.    )
+0000c290: 0a20 2020 206e 6577 5f73 796d 626f 6c73  .    new_symbols
+0000c2a0: 203d 206c 6973 7428 6368 6169 6e2e 6672   = list(chain.fr
+0000c2b0: 6f6d 5f69 7465 7261 626c 6528 6e65 775f  om_iterable(new_
+0000c2c0: 7379 6d62 6f6c 735f 6974 6572 2929 0a20  symbols_iter)). 
+0000c2d0: 2020 2074 7261 6365 2e62 6f75 6e64 5f73     trace.bound_s
+0000c2e0: 796d 626f 6c73 203d 206e 6577 5f73 796d  ymbols = new_sym
+0000c2f0: 626f 6c73 0a20 2020 2072 6574 7572 6e20  bols.    return 
+0000c300: 7472 6163 650a 0a0a 6465 6620 6465 636f  trace...def deco
+0000c310: 6d70 6f73 6564 5f66 6e5f 766d 6170 5f72  mposed_fn_vmap_r
+0000c320: 756c 6528 6178 6973 5f73 697a 652c 202a  ule(axis_size, *
+0000c330: 6172 6773 2c20 666e 2c20 2a2a 6b77 6172  args, fn, **kwar
+0000c340: 6773 293a 0a20 2020 2061 7267 732c 2069  gs):.    args, i
+0000c350: 6e5f 6469 6d73 203d 2075 6e7a 6970 3228  n_dims = unzip2(
+0000c360: 6172 6773 290a 2020 2020 756e 6261 7463  args).    unbatc
+0000c370: 6865 645f 6172 6773 203d 2074 7265 655f  hed_args = tree_
+0000c380: 6d61 7028 6c61 6d62 6461 2078 3a20 7265  map(lambda x: re
+0000c390: 6d6f 7665 5f62 6174 6368 5f64 696d 2878  move_batch_dim(x
+0000c3a0: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
+0000c3b0: 782c 2054 656e 736f 7250 726f 7879 2920  x, TensorProxy) 
+0000c3c0: 656c 7365 2078 2c20 6172 6773 290a 2020  else x, args).  
+0000c3d0: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
+0000c3e0: 7563 745f 7472 6163 6528 2928 666e 2c20  uct_trace()(fn, 
+0000c3f0: 2a75 6e62 6174 6368 6564 5f61 7267 732c  *unbatched_args,
+0000c400: 202a 2a6b 7761 7267 7329 0a20 2020 2074   **kwargs).    t
+0000c410: 7261 6365 203d 2075 6e77 7261 705f 6f6e  race = unwrap_on
+0000c420: 655f 6c65 7665 6c5f 6f66 5f73 7562 7379  e_level_of_subsy
+0000c430: 6d62 6f6c 7328 7472 6163 6529 0a20 2020  mbols(trace).   
+0000c440: 206f 7574 7320 3d20 5f76 6d61 705f 6361   outs = _vmap_ca
+0000c450: 6c6c 5f6d 6574 6166 756e 6328 4661 6c73  ll_metafunc(Fals
+0000c460: 652c 2061 7267 732c 2069 6e5f 6469 6d73  e, args, in_dims
+0000c470: 2c20 302c 2061 7869 735f 7369 7a65 2c20  , 0, axis_size, 
+0000c480: 6675 6e63 7469 6f6e 5f74 7261 6365 3d74  function_trace=t
+0000c490: 7261 6365 2c20 2a2a 6b77 6172 6773 290a  race, **kwargs).
+0000c4a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000c4b0: 6528 6f75 7473 2c20 5365 7175 656e 6365  e(outs, Sequence
+0000c4c0: 293a 0a20 2020 2020 2020 206f 7574 5f64  ):.        out_d
+0000c4d0: 696d 7320 3d20 2830 2c29 202a 206c 656e  ims = (0,) * len
+0000c4e0: 286f 7574 7329 0a20 2020 2020 2020 2072  (outs).        r
+0000c4f0: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
+0000c500: 6169 725f 746f 5f62 6174 6368 6564 5f76  air_to_batched_v
+0000c510: 616c 7565 2c20 7361 6665 5f7a 6970 286f  alue, safe_zip(o
+0000c520: 7574 732c 206f 7574 5f64 696d 7329 290a  uts, out_dims)).
+0000c530: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+0000c540: 6564 5661 6c75 6528 6f75 7473 2c20 3029  edValue(outs, 0)
+0000c550: 0a0a 0a76 6d61 705f 696d 706c 735b 7072  ...vmap_impls[pr
+0000c560: 696d 732e 5072 696d 4944 732e 5349 4e5d  ims.PrimIDs.SIN]
+0000c570: 203d 2073 696e 5f76 6d61 700a 766d 6170   = sin_vmap.vmap
+0000c580: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
+0000c590: 6d49 4473 2e43 4f53 5d20 3d20 636f 735f  mIDs.COS] = cos_
+0000c5a0: 766d 6170 0a76 6d61 705f 696d 706c 735b  vmap.vmap_impls[
+0000c5b0: 7072 696d 732e 5072 696d 4944 732e 4d55  prims.PrimIDs.MU
+0000c5c0: 4c5d 203d 206d 756c 5f76 6d61 700a 766d  L] = mul_vmap.vm
+0000c5d0: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
+0000c5e0: 7269 6d49 4473 2e41 4444 5d20 3d20 6164  rimIDs.ADD] = ad
+0000c5f0: 645f 766d 6170 0a76 6d61 705f 696d 706c  d_vmap.vmap_impl
+0000c600: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
+0000c610: 5355 4d5d 203d 2073 756d 5f76 6d61 700a  SUM] = sum_vmap.
+0000c620: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
+0000c630: 2e50 7269 6d49 4473 2e42 524f 4144 4341  .PrimIDs.BROADCA
+0000c640: 5354 5f49 4e5f 4449 4d5d 203d 2062 726f  ST_IN_DIM] = bro
+0000c650: 6164 6361 7374 5f69 6e5f 6469 6d5f 766d  adcast_in_dim_vm
+0000c660: 6170 0a0a 0a64 6566 2076 6d61 705f 7379  ap...def vmap_sy
+0000c670: 6d62 6f6c 5f6d 6170 7065 7228 7379 6d62  mbol_mapper(symb
+0000c680: 6f6c 3a20 7072 696d 732e 5379 6d62 6f6c  ol: prims.Symbol
+0000c690: 2c20 2a2c 2061 7869 735f 7369 7a65 3a20  , *, axis_size: 
+0000c6a0: 696e 7429 3a0a 2020 2020 2222 224d 6170  int):.    """Map
+0000c6b0: 7320 6120 7379 6d62 6f6c 2074 6f20 6120  s a symbol to a 
+0000c6c0: 766d 6170 2066 756e 6374 696f 6e20 7468  vmap function th
+0000c6d0: 6174 2065 7661 6c75 6174 6573 2069 742e  at evaluates it.
+0000c6e0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0000c6f0: 2020 2020 7379 6d62 6f6c 2028 7072 696d      symbol (prim
+0000c700: 732e 5379 6d62 6f6c 293a 2053 796d 626f  s.Symbol): Symbo
+0000c710: 6c20 746f 2065 7661 6c75 6174 652e 0a0a  l to evaluate...
+0000c720: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+0000c730: 2020 2020 4e6f 7449 6d70 6c65 6d65 6e74      NotImplement
+0000c740: 6564 4572 726f 723a 2049 6620 7468 6520  edError: If the 
+0000c750: 766d 6170 2066 6f72 2074 6865 2073 796d  vmap for the sym
+0000c760: 626f 6c20 6973 206e 6f74 2069 6d70 6c65  bol is not imple
+0000c770: 6d65 6e74 6564 2e0a 0a20 2020 2052 6574  mented...    Ret
+0000c780: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
+0000c790: 6c6c 6162 6c65 3a20 766d 6170 2066 756e  llable: vmap fun
+0000c7a0: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
+0000c7b0: 6174 6573 2074 6865 2073 796d 626f 6c2e  ates the symbol.
+0000c7c0: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+0000c7d0: 6620 7772 6170 5f61 7267 2878 293a 0a20  f wrap_arg(x):. 
+0000c7e0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000c7f0: 616e 6365 2878 2c20 4261 7463 6865 6456  ance(x, BatchedV
+0000c800: 616c 7565 293a 0a20 2020 2020 2020 2020  alue):.         
+0000c810: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
+0000c820: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0000c830: 6e63 6528 782c 2028 4e75 6d62 6572 2c20  nce(x, (Number, 
+0000c840: 4e75 6d62 6572 5072 6f78 7929 293a 0a20  NumberProxy)):. 
+0000c850: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000c860: 6e20 4261 7463 6865 6456 616c 7565 2878  n BatchedValue(x
+0000c870: 2c20 6e6f 745f 6d61 7070 6564 290a 2020  , not_mapped).  
+0000c880: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000c890: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0000c8a0: 6c75 6545 7272 6f72 2866 2276 6d61 7020  lueError(f"vmap 
+0000c8b0: 7772 6170 5f61 7267 2067 6f74 2061 6e20  wrap_arg got an 
+0000c8c0: 756e 7375 7070 6f72 7465 6420 7479 7065  unsupported type
+0000c8d0: 207b 7479 7065 2878 297d 2229 0a0a 2020   {type(x)}")..  
+0000c8e0: 2020 6966 2073 796d 626f 6c2e 6172 655f    if symbol.are_
+0000c8f0: 616c 6c5f 6172 6773 5f63 6f6e 7374 616e  all_args_constan
+0000c900: 743a 0a0a 2020 2020 2020 2020 6465 6620  t:..        def 
+0000c910: 5f76 6d61 705f 696d 706c 5f63 6f6e 7374  _vmap_impl_const
+0000c920: 2873 796d 626f 6c2c 202a 6172 6773 2c20  (symbol, *args, 
+0000c930: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+0000c940: 2020 2020 2020 206f 7574 203d 2073 796d         out = sym
+0000c950: 626f 6c5f 746f 5f65 7661 6c28 7379 6d62  bol_to_eval(symb
+0000c960: 6f6c 2928 2a61 7267 732c 202a 2a6b 7761  ol)(*args, **kwa
+0000c970: 7267 7329 0a0a 2020 2020 2020 2020 2020  rgs)..          
+0000c980: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000c990: 6f75 742c 2053 6571 7565 6e63 6529 3a0a  out, Sequence):.
+0000c9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9b0: 7265 7475 726e 2073 6166 655f 6d61 7028  return safe_map(
+0000c9c0: 7061 6972 5f74 6f5f 6261 7463 6865 645f  pair_to_batched_
+0000c9d0: 7661 6c75 652c 2073 6166 655f 7a69 7028  value, safe_zip(
+0000c9e0: 6172 6773 2c20 5b6e 6f74 5f6d 6170 7065  args, [not_mappe
+0000c9f0: 645d 202a 206c 656e 286f 7574 2929 290a  d] * len(out))).
+0000ca00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000ca10: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
+0000ca20: 286f 7574 2c20 6e6f 745f 6d61 7070 6564  (out, not_mapped
+0000ca30: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0000ca40: 6e20 7061 7274 6961 6c28 5f76 6d61 705f  n partial(_vmap_
+0000ca50: 696d 706c 5f63 6f6e 7374 2c20 7379 6d62  impl_const, symb
+0000ca60: 6f6c 290a 0a20 2020 2076 6d61 705f 696d  ol)..    vmap_im
+0000ca70: 706c 203d 2076 6d61 705f 696d 706c 732e  pl = vmap_impls.
+0000ca80: 6765 7428 7379 6d62 6f6c 2e73 796d 2e69  get(symbol.sym.i
+0000ca90: 6429 0a20 2020 2069 6620 766d 6170 5f69  d).    if vmap_i
+0000caa0: 6d70 6c20 6973 204e 6f6e 653a 0a20 2020  mpl is None:.   
+0000cab0: 2020 2020 2069 6620 6c65 6e28 7379 6d62       if len(symb
+0000cac0: 6f6c 2e73 7562 7379 6d62 6f6c 7329 203e  ol.subsymbols) >
+0000cad0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0000cae0: 766d 6170 5f69 6d70 6c20 3d20 7061 7274  vmap_impl = part
+0000caf0: 6961 6c28 6465 636f 6d70 6f73 6564 5f66  ial(decomposed_f
+0000cb00: 6e5f 766d 6170 5f72 756c 652c 2066 6e3d  n_vmap_rule, fn=
+0000cb10: 7379 6d62 6f6c 2e73 796d 290a 2020 2020  symbol.sym).    
+0000cb20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000cb30: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0000cb40: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0000cb50: 6622 766d 6170 2066 6f72 207b 7379 6d62  f"vmap for {symb
+0000cb60: 6f6c 2e73 796d 2e69 647d 2069 7320 6e6f  ol.sym.id} is no
+0000cb70: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
+0000cb80: 0a20 2020 2064 6566 205f 766d 6170 5f69  .    def _vmap_i
+0000cb90: 6d70 6c28 2a61 7267 732c 202a 2a6b 7761  mpl(*args, **kwa
+0000cba0: 7267 7329 3a0a 2020 2020 2020 2020 6172  rgs):.        ar
+0000cbb0: 6773 203d 2074 7265 655f 6d61 7028 7772  gs = tree_map(wr
+0000cbc0: 6170 5f61 7267 2c20 6172 6773 290a 2020  ap_arg, args).  
+0000cbd0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+0000cbe0: 2869 7369 6e73 7461 6e63 6528 6172 672c  (isinstance(arg,
+0000cbf0: 2042 6174 6368 6564 5661 6c75 6529 2066   BatchedValue) f
+0000cc00: 6f72 2061 7267 2069 6e20 7472 6565 5f66  or arg in tree_f
+0000cc10: 6c61 7474 656e 2861 7267 7329 5b30 5d29  latten(args)[0])
+0000cc20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000cc30: 766d 6170 5f69 6d70 6c28 6178 6973 5f73  vmap_impl(axis_s
+0000cc40: 697a 652c 202a 6172 6773 2c20 2a2a 6b77  ize, *args, **kw
+0000cc50: 6172 6773 290a 0a20 2020 2072 6574 7572  args)..    retur
+0000cc60: 6e20 5f76 6d61 705f 696d 706c 0a0a 0a64  n _vmap_impl...d
+0000cc70: 6566 2072 656d 6f76 655f 6261 7463 685f  ef remove_batch_
+0000cc80: 6469 6d28 7465 6e73 6f72 3a20 5465 6e73  dim(tensor: Tens
+0000cc90: 6f72 5072 6f78 792c 2062 6174 6368 5f64  orProxy, batch_d
+0000cca0: 696d 3a20 696e 7420 3d20 3029 202d 3e20  im: int = 0) -> 
+0000ccb0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+0000ccc0: 2022 2222 5265 6d6f 7665 7320 7468 6520   """Removes the 
+0000ccd0: 6261 7463 6820 6469 6d65 6e73 696f 6e20  batch dimension 
+0000cce0: 6672 6f6d 2061 2074 656e 736f 722e 0a0a  from a tensor...
+0000ccf0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0000cd00: 2020 7465 6e73 6f72 2028 5465 6e73 6f72    tensor (Tensor
+0000cd10: 5072 6f78 7929 3a20 5465 6e73 6f72 2074  Proxy): Tensor t
+0000cd20: 6f20 7265 6d6f 7665 2074 6865 2062 6174  o remove the bat
+0000cd30: 6368 2064 696d 656e 7369 6f6e 2066 726f  ch dimension fro
+0000cd40: 6d2e 0a0a 2020 2020 5265 7475 726e 733a  m...    Returns:
+0000cd50: 0a20 2020 2020 2020 2054 656e 736f 7250  .        TensorP
+0000cd60: 726f 7879 3a20 5465 6e73 6f72 2077 6974  roxy: Tensor wit
+0000cd70: 6820 7468 6520 6261 7463 6820 6469 6d65  h the batch dime
+0000cd80: 6e73 696f 6e20 7265 6d6f 7665 642e 0a20  nsion removed.. 
+0000cd90: 2020 2022 2222 0a20 2020 206e 6577 5f73     """.    new_s
+0000cda0: 6861 7065 203d 2074 656e 736f 722e 7368  hape = tensor.sh
+0000cdb0: 6170 655b 3a62 6174 6368 5f64 696d 5d20  ape[:batch_dim] 
+0000cdc0: 2b20 7465 6e73 6f72 2e73 6861 7065 5b62  + tensor.shape[b
+0000cdd0: 6174 6368 5f64 696d 202b 2031 203a 5d0a  atch_dim + 1 :].
+0000cde0: 2020 2020 7265 7475 726e 2054 656e 736f      return Tenso
+0000cdf0: 7250 726f 7879 286c 696b 653d 7465 6e73  rProxy(like=tens
+0000ce00: 6f72 2c20 7368 6170 653d 6e65 775f 7368  or, shape=new_sh
+0000ce10: 6170 6529 0a0a 0a23 2054 4f44 4f3a 2069  ape)...# TODO: i
+0000ce20: 6e20 4a41 5820 6172 6773 2c20 696e 5f64  n JAX args, in_d
+0000ce30: 696d 7320 6172 6520 666c 6174 7465 6e65  ims are flattene
+0000ce40: 6420 7468 6520 7361 6d65 2077 6179 0a23  d the same way.#
+0000ce50: 2054 4f44 4f3a 2069 6e20 4a41 5820 6f75   TODO: in JAX ou
+0000ce60: 745f 6469 6d73 2061 7265 2066 6c61 7474  t_dims are flatt
+0000ce70: 656e 6564 2061 7320 7765 6c6c 0a64 6566  ened as well.def
+0000ce80: 205f 766d 6170 5f63 616c 6c5f 6d65 7461   _vmap_call_meta
+0000ce90: 6675 6e63 2864 6574 6163 6865 643a 2062  func(detached: b
+0000cea0: 6f6f 6c2c 2061 7267 732c 2069 6e5f 6469  ool, args, in_di
+0000ceb0: 6d73 2c20 6f75 745f 6469 6d73 2c20 6178  ms, out_dims, ax
+0000cec0: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
+0000ced0: 6e5f 7472 6163 653a 2054 7261 6365 2c20  n_trace: Trace, 
+0000cee0: 2a2a 6b77 6172 6773 293a 0a20 2020 2022  **kwargs):.    "
+0000cef0: 2222 4d65 7461 6675 6e63 7469 6f6e 2066  ""Metafunction f
+0000cf00: 6f72 2076 6d61 7020 6361 6c6c 2e0a 0a20  or vmap call... 
+0000cf10: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000cf20: 2064 6574 6163 6865 6420 2862 6f6f 6c29   detached (bool)
+0000cf30: 3a20 5768 6574 6865 7220 746f 2064 6574  : Whether to det
+0000cf40: 6163 6820 7468 6520 7472 6163 652e 0a20  ach the trace.. 
+0000cf50: 2020 2020 2020 2061 7267 7320 2854 7570         args (Tup
+0000cf60: 6c65 5b50 726f 7879 5d29 3a20 4172 6775  le[Proxy]): Argu
+0000cf70: 6d65 6e74 7320 746f 2074 6865 2066 756e  ments to the fun
+0000cf80: 6374 696f 6e2e 0a20 2020 2020 2020 2069  ction..        i
+0000cf90: 6e5f 6469 6d73 2028 5475 706c 655b 696e  n_dims (Tuple[in
+0000cfa0: 745d 293a 2042 6174 6368 2064 696d 656e  t]): Batch dimen
+0000cfb0: 7369 6f6e 2066 6f72 2065 6163 6820 6172  sion for each ar
+0000cfc0: 6775 6d65 6e74 2e0a 2020 2020 2020 2020  gument..        
+0000cfd0: 6f75 745f 6469 6d73 2028 5475 706c 655b  out_dims (Tuple[
+0000cfe0: 696e 745d 293a 2042 6174 6368 2064 696d  int]): Batch dim
+0000cff0: 656e 7369 6f6e 2066 6f72 2072 6574 7572  ension for retur
+0000d000: 6e20 7661 6c75 6573 2e0a 2020 2020 2020  n values..      
+0000d010: 2020 6675 6e63 7469 6f6e 5f74 7261 6365    function_trace
+0000d020: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
+0000d030: 746f 2075 7365 2066 6f72 2074 6865 2066  to use for the f
+0000d040: 756e 6374 696f 6e2e 0a20 2020 2020 2020  unction..       
+0000d050: 206b 7761 7267 733a 204b 6579 776f 7264   kwargs: Keyword
+0000d060: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
+0000d070: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+0000d080: 2041 7373 6572 7469 6f6e 4572 726f 723a   AssertionError:
+0000d090: 2049 6620 7468 6520 766d 6170 2066 6f72   If the vmap for
+0000d0a0: 206b 6579 776f 7264 2061 7267 756d 656e   keyword argumen
+0000d0b0: 7473 2069 7320 6e6f 7420 696d 706c 656d  ts is not implem
+0000d0c0: 656e 7465 642e 0a0a 2020 2020 5265 7475  ented...    Retu
+0000d0d0: 726e 733a 0a20 2020 2020 2020 2052 6573  rns:.        Res
+0000d0e0: 756c 7420 6f66 2074 6865 2076 6d61 7020  ult of the vmap 
+0000d0f0: 7472 616e 7366 6f72 6d2e 0a20 2020 2022  transform..    "
+0000d100: 2222 0a20 2020 2063 6f6d 6d6f 6e5f 6465  "".    common_de
+0000d110: 7669 6365 203d 207b 782e 6465 7669 6365  vice = {x.device
+0000d120: 2066 6f72 2078 2069 6e20 6172 6773 2069   for x in args i
+0000d130: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+0000d140: 5465 6e73 6f72 5072 6f78 7929 7d0a 2020  TensorProxy)}.  
+0000d150: 2020 6173 7365 7274 206c 656e 2863 6f6d    assert len(com
+0000d160: 6d6f 6e5f 6465 7669 6365 2920 3c3d 2031  mon_device) <= 1
+0000d170: 2c20 2276 6d61 7020 666f 7220 6d75 6c74  , "vmap for mult
+0000d180: 6970 6c65 2064 6576 6963 6573 2069 7320  iple devices is 
+0000d190: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
+0000d1a0: 0a20 2020 2028 636f 6d6d 6f6e 5f64 6576  .    (common_dev
+0000d1b0: 6963 652c 2920 3d20 636f 6d6d 6f6e 5f64  ice,) = common_d
+0000d1c0: 6576 6963 6520 6966 206c 656e 2863 6f6d  evice if len(com
+0000d1d0: 6d6f 6e5f 6465 7669 6365 2920 3d3d 2031  mon_device) == 1
+0000d1e0: 2065 6c73 6520 2863 7075 2c29 0a0a 2020   else (cpu,)..  
+0000d1f0: 2020 6966 2061 7869 735f 7369 7a65 2069    if axis_size i
+0000d200: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000d210: 2861 7869 735f 7369 7a65 2c29 203d 207b  (axis_size,) = {
+0000d220: 782e 7368 6170 655b 6178 5d20 666f 7220  x.shape[ax] for 
+0000d230: 782c 2061 7820 696e 207a 6970 2861 7267  x, ax in zip(arg
+0000d240: 732c 2069 6e5f 6469 6d73 2920 6966 2061  s, in_dims) if a
+0000d250: 7820 6973 206e 6f74 206e 6f74 5f6d 6170  x is not not_map
+0000d260: 7065 647d 0a20 2020 2069 6e5f 6469 6d73  ped}.    in_dims
+0000d270: 203d 2069 6e5f 6469 6d73 2069 6620 6973   = in_dims if is
+0000d280: 696e 7374 616e 6365 2869 6e5f 6469 6d73  instance(in_dims
+0000d290: 2c20 5365 7175 656e 6365 2920 656c 7365  , Sequence) else
+0000d2a0: 2028 696e 5f64 696d 732c 290a 2020 2020   (in_dims,).    
+0000d2b0: 696e 5f64 696d 7320 3d20 7475 706c 6528  in_dims = tuple(
+0000d2c0: 6e6f 745f 6d61 7070 6564 2069 6620 6973  not_mapped if is
+0000d2d0: 696e 7374 616e 6365 2861 2c20 284e 756d  instance(a, (Num
+0000d2e0: 6265 722c 204e 756d 6265 7250 726f 7879  ber, NumberProxy
+0000d2f0: 2929 2065 6c73 6520 6420 666f 7220 612c  )) else d for a,
+0000d300: 2064 2069 6e20 7361 6665 5f7a 6970 2861   d in safe_zip(a
+0000d310: 7267 732c 2069 6e5f 6469 6d73 2929 0a20  rgs, in_dims)). 
+0000d320: 2020 206f 7574 5f64 696d 7320 3d20 6f75     out_dims = ou
+0000d330: 745f 6469 6d73 2069 6620 6973 696e 7374  t_dims if isinst
+0000d340: 616e 6365 286f 7574 5f64 696d 732c 2053  ance(out_dims, S
+0000d350: 6571 7565 6e63 6529 2065 6c73 6520 286f  equence) else (o
+0000d360: 7574 5f64 696d 732c 290a 0a20 2020 2063  ut_dims,)..    c
+0000d370: 7478 203d 2064 6574 6163 6865 645f 7472  tx = detached_tr
+0000d380: 6163 6528 2920 6966 2064 6574 6163 6865  ace() if detache
+0000d390: 6420 656c 7365 206e 756c 6c63 6f6e 7465  d else nullconte
+0000d3a0: 7874 2829 0a20 2020 2077 6974 6820 6374  xt().    with ct
+0000d3b0: 783a 0a20 2020 2020 2020 2023 2057 6520  x:.        # We 
+0000d3c0: 7072 6f70 6167 6174 6520 7468 6520 4261  propagate the Ba
+0000d3d0: 7463 6856 616c 7565 2074 6872 6f75 6768  tchValue through
+0000d3e0: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
+0000d3f0: 7468 656e 2075 6e77 7261 7020 6974 2061  then unwrap it a
+0000d400: 7420 7468 6520 656e 640a 2020 2020 2020  t the end.      
+0000d410: 2020 6261 7463 6865 645f 6172 6773 203d    batched_args =
+0000d420: 2073 6166 655f 6d61 7028 7061 6972 5f74   safe_map(pair_t
+0000d430: 6f5f 6261 7463 6865 645f 7661 6c75 652c  o_batched_value,
+0000d440: 2073 6166 655f 7a69 7028 6172 6773 2c20   safe_zip(args, 
+0000d450: 696e 5f64 696d 7329 290a 2020 2020 2020  in_dims)).      
+0000d460: 2020 7265 7375 6c74 203d 2065 7661 6c5f    result = eval_
+0000d470: 7472 6163 6528 0a20 2020 2020 2020 2020  trace(.         
+0000d480: 2020 2066 756e 6374 696f 6e5f 7472 6163     function_trac
+0000d490: 652c 202a 6261 7463 6865 645f 6172 6773  e, *batched_args
+0000d4a0: 2c20 7379 6d62 6f6c 5f6d 6170 7065 723d  , symbol_mapper=
+0000d4b0: 7061 7274 6961 6c28 766d 6170 5f73 796d  partial(vmap_sym
+0000d4c0: 626f 6c5f 6d61 7070 6572 2c20 6178 6973  bol_mapper, axis
+0000d4d0: 5f73 697a 653d 6178 6973 5f73 697a 6529  _size=axis_size)
+0000d4e0: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
+0000d4f0: 2020 2029 0a20 2020 2020 2020 2023 2055     ).        # U
+0000d500: 6e77 7261 7070 696e 6720 7468 6520 4261  nwrapping the Ba
+0000d510: 7463 6865 6456 616c 7565 2773 0a20 2020  tchedValue's.   
+0000d520: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000d530: 6365 2872 6573 756c 742c 2053 6571 7565  ce(result, Seque
+0000d540: 6e63 6529 3a0a 2020 2020 2020 2020 2020  nce):.          
+0000d550: 2020 666c 6174 5f72 6573 756c 742c 2073    flat_result, s
+0000d560: 7065 6320 3d20 7472 6565 5f66 6c61 7474  pec = tree_flatt
+0000d570: 656e 2872 6573 756c 7429 0a20 2020 2020  en(result).     
+0000d580: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
+0000d590: 6c28 6973 696e 7374 616e 6365 2878 2c20  l(isinstance(x, 
+0000d5a0: 4261 7463 6865 6456 616c 7565 2920 666f  BatchedValue) fo
+0000d5b0: 7220 7820 696e 2066 6c61 745f 7265 7375  r x in flat_resu
+0000d5c0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
+0000d5d0: 6f75 7473 2c20 6264 696d 7320 3d20 756e  outs, bdims = un
+0000d5e0: 7a69 7032 2866 6c61 745f 7265 7375 6c74  zip2(flat_result
+0000d5f0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0000d600: 544f 444f 3a20 6861 6e64 6c65 2074 6865  TODO: handle the
+0000d610: 2063 6173 6520 7768 6572 6520 6f75 745f   case where out_
+0000d620: 6469 6d73 2069 7320 6120 7369 6e67 6c65  dims is a single
+0000d630: 2076 616c 7565 2062 6574 7465 720a 2020   value better.  
+0000d640: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+0000d650: 286f 7574 5f64 696d 7329 203d 3d20 313a  (out_dims) == 1:
+0000d660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d670: 206f 7574 5f64 696d 7320 3d20 6f75 745f   out_dims = out_
+0000d680: 6469 6d73 202a 206c 656e 286f 7574 7329  dims * len(outs)
+0000d690: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000d6a0: 7320 3d20 7361 6665 5f6d 6170 2870 6172  s = safe_map(par
+0000d6b0: 7469 616c 286d 6f76 655f 6261 7463 685f  tial(move_batch_
+0000d6c0: 6469 6d2c 2061 7869 735f 7369 7a65 292c  dim, axis_size),
+0000d6d0: 2062 6469 6d73 2c20 6f75 745f 6469 6d73   bdims, out_dims
+0000d6e0: 2c20 6f75 7473 290a 2020 2020 2020 2020  , outs).        
+0000d6f0: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+0000d700: 756e 666c 6174 7465 6e28 6f75 7473 2c20  unflatten(outs, 
+0000d710: 7370 6563 290a 2020 2020 2020 2020 6966  spec).        if
+0000d720: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+0000d730: 6c74 2c20 284e 756d 6265 722c 204e 756d  lt, (Number, Num
+0000d740: 6265 7250 726f 7879 2929 2061 6e64 2061  berProxy)) and a
+0000d750: 7869 735f 7369 7a65 2069 7320 6e6f 7420  xis_size is not 
+0000d760: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000d770: 2020 2320 544f 444f 3a20 6665 7463 6820    # TODO: fetch 
+0000d780: 7468 6520 6465 6661 756c 7420 6465 7669  the default devi
+0000d790: 6365 2066 726f 6d20 7468 6520 636f 6e74  ce from the cont
+0000d7a0: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
+0000d7b0: 7265 7375 6c74 203d 2066 756c 6c28 7368  result = full(sh
+0000d7c0: 6170 653d 2829 2c20 6669 6c6c 5f76 616c  ape=(), fill_val
+0000d7d0: 7565 3d72 6573 756c 742c 2064 6576 6963  ue=result, devic
+0000d7e0: 653d 636f 6d6d 6f6e 5f64 6576 6963 6529  e=common_device)
+0000d7f0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0000d800: 756c 7420 3d20 4261 7463 6865 6456 616c  ult = BatchedVal
+0000d810: 7565 2872 6573 756c 742c 206e 6f74 5f6d  ue(result, not_m
+0000d820: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
+0000d830: 6c69 6620 280a 2020 2020 2020 2020 2020  lif (.          
+0000d840: 2020 6973 696e 7374 616e 6365 2872 6573    isinstance(res
+0000d850: 756c 742c 2042 6174 6368 6564 5661 6c75  ult, BatchedValu
+0000d860: 6529 0a20 2020 2020 2020 2020 2020 2061  e).            a
+0000d870: 6e64 2069 7369 6e73 7461 6e63 6528 7265  nd isinstance(re
+0000d880: 7375 6c74 2e76 616c 7565 2c20 284e 756d  sult.value, (Num
+0000d890: 6265 722c 204e 756d 6265 7250 726f 7879  ber, NumberProxy
+0000d8a0: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
+0000d8b0: 6e64 2061 7869 735f 7369 7a65 2069 7320  nd axis_size is 
+0000d8c0: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
+0000d8d0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0000d8e0: 7265 7375 6c74 203d 2042 6174 6368 6564  result = Batched
+0000d8f0: 5661 6c75 6528 6675 6c6c 2873 6861 7065  Value(full(shape
+0000d900: 3d28 292c 2066 696c 6c5f 7661 6c75 653d  =(), fill_value=
+0000d910: 7265 7375 6c74 2e76 616c 7565 2c20 6465  result.value, de
+0000d920: 7669 6365 3d63 6f6d 6d6f 6e5f 6465 7669  vice=common_devi
+0000d930: 6365 292c 2072 6573 756c 742e 6261 7463  ce), result.batc
+0000d940: 685f 6469 6d29 0a20 2020 2020 2020 2061  h_dim).        a
+0000d950: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000d960: 2872 6573 756c 742c 2042 6174 6368 6564  (result, Batched
+0000d970: 5661 6c75 6529 0a20 2020 2020 2020 206f  Value).        o
+0000d980: 7574 203d 206d 6f76 655f 6261 7463 685f  ut = move_batch_
+0000d990: 6469 6d28 6178 6973 5f73 697a 652c 2072  dim(axis_size, r
+0000d9a0: 6573 756c 742e 6261 7463 685f 6469 6d2c  esult.batch_dim,
+0000d9b0: 206f 7574 5f64 696d 735b 305d 2c20 7265   out_dims[0], re
+0000d9c0: 7375 6c74 2e76 616c 7565 290a 2020 2020  sult.value).    
+0000d9d0: 2020 2020 7265 7475 726e 206f 7574 0a0a      return out..
+0000d9e0: 0a76 6d61 705f 6361 6c6c 203d 2053 796d  .vmap_call = Sym
+0000d9f0: 626f 6c28 6964 3d54 7261 6e73 666f 726d  bol(id=Transform
+0000da00: 732e 566d 6170 4f70 2c20 6e61 6d65 3d22  s.VmapOp, name="
+0000da10: 766d 6170 5f63 616c 6c22 2c20 6d65 7461  vmap_call", meta
+0000da20: 3d70 6172 7469 616c 285f 766d 6170 5f63  =partial(_vmap_c
+0000da30: 616c 6c5f 6d65 7461 6675 6e63 2c20 4661  all_metafunc, Fa
+0000da40: 6c73 6529 290a 0a0a 2320 544f 444f 3a20  lse))...# TODO: 
+0000da50: 686f 7720 7368 6f75 6c64 2077 6520 6861  how should we ha
+0000da60: 6e64 6c65 206f 7574 5f64 696d 7320 6865  ndle out_dims he
+0000da70: 7265 3f0a 2320 616c 7468 6f75 6768 2068  re?.# although h
+0000da80: 6572 6520 7765 2061 7265 2063 616c 6c69  ere we are calli
+0000da90: 6e67 2076 6d61 7020 6f66 2069 6465 6e74  ng vmap of ident
+0000daa0: 6974 792c 2073 6f20 7765 2073 686f 756c  ity, so we shoul
+0000dab0: 6420 6b6e 6f77 2066 726f 6d20 7468 6520  d know from the 
+0000dac0: 6361 6c6c 2074 6f20 766d 6170 0a23 2054  call to vmap.# T
+0000dad0: 6869 7320 7368 6f75 6c64 2062 6520 6669  his should be fi
+0000dae0: 6e65 2e20 4966 2077 6520 6861 7665 2076  ne. If we have v
+0000daf0: 6d61 7028 6964 656e 7469 7479 2866 756e  map(identity(fun
+0000db00: 6329 2c20 6f75 745f 6469 6d73 3d4e 2920  c), out_dims=N) 
+0000db10: 7468 656e 2074 6869 7320 7275 6c65 2069  then this rule i
+0000db20: 7320 6669 7273 7420 7573 6564 0a23 2074  s first used.# t
+0000db30: 6f20 6765 7420 7468 6520 766d 6170 7065  o get the vmappe
+0000db40: 6420 7265 7375 6c74 206f 6620 6964 656e  d result of iden
+0000db50: 7469 7479 2866 756e 6329 2069 6e20 766d  tity(func) in vm
+0000db60: 6170 5f73 796d 626f 6c5f 6d61 7070 6572  ap_symbol_mapper
+0000db70: 2c20 616e 6420 6f75 745f 6469 6d73 2069  , and out_dims i
+0000db80: 7320 6861 6e64 6c65 640a 2320 6166 7465  s handled.# afte
+0000db90: 7220 7468 6174 2069 6e20 7468 6520 6f75  r that in the ou
+0000dba0: 7465 7220 5f76 6d61 705f 6361 6c6c 5f6d  ter _vmap_call_m
+0000dbb0: 6574 6166 756e 632e 0a64 6566 205f 6964  etafunc..def _id
+0000dbc0: 656e 7469 7479 5f63 616c 6c5f 766d 6170  entity_call_vmap
+0000dbd0: 2861 7869 735f 7369 7a65 2c20 2a62 6174  (axis_size, *bat
+0000dbe0: 6368 6564 5f61 7267 732c 2074 7261 6365  ched_args, trace
+0000dbf0: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+0000dc00: 7329 3a0a 2020 2020 6172 6773 2c20 696e  s):.    args, in
+0000dc10: 5f64 696d 7320 3d20 756e 7a69 7032 2862  _dims = unzip2(b
+0000dc20: 6174 6368 6564 5f61 7267 7329 0a20 2020  atched_args).   
+0000dc30: 206f 7574 5f64 696d 7320 3d20 3020 2023   out_dims = 0  #
+0000dc40: 2046 6978 6d65 0a20 2020 206f 7574 732c   Fixme.    outs,
+0000dc50: 206f 7574 5f64 696d 7320 3d20 5f76 6d61   out_dims = _vma
+0000dc60: 705f 6361 6c6c 5f6d 6574 6166 756e 6328  p_call_metafunc(
+0000dc70: 4661 6c73 652c 2061 7267 732c 2069 6e5f  False, args, in_
+0000dc80: 6469 6d73 2c20 6f75 745f 6469 6d73 2c20  dims, out_dims, 
+0000dc90: 6178 6973 5f73 697a 652c 2066 756e 6374  axis_size, funct
+0000dca0: 696f 6e5f 7472 6163 653d 7472 6163 652c  ion_trace=trace,
+0000dcb0: 202a 2a6b 7761 7267 7329 0a20 2020 2069   **kwargs).    i
+0000dcc0: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+0000dcd0: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+0000dce0: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
+0000dcf0: 655f 6d61 7028 7061 6972 5f74 6f5f 6261  e_map(pair_to_ba
+0000dd00: 7463 6865 645f 7661 6c75 652c 2073 6166  tched_value, saf
+0000dd10: 655f 7a69 7028 6f75 7473 2c20 6f75 745f  e_zip(outs, out_
+0000dd20: 6469 6d73 2929 0a20 2020 2072 6574 7572  dims)).    retur
+0000dd30: 6e20 4261 7463 6865 6456 616c 7565 286f  n BatchedValue(o
+0000dd40: 7574 732c 206f 7574 5f64 696d 7329 0a0a  uts, out_dims)..
+0000dd50: 0a76 6d61 705f 696d 706c 735b 5472 616e  .vmap_impls[Tran
+0000dd60: 7366 6f72 6d73 2e49 6465 6e74 6974 794f  sforms.IdentityO
+0000dd70: 705d 203d 205f 6964 656e 7469 7479 5f63  p] = _identity_c
+0000dd80: 616c 6c5f 766d 6170 0a0a 0a64 6566 205f  all_vmap...def _
+0000dd90: 6a76 705f 6361 6c6c 5f76 6d61 7028 6178  jvp_call_vmap(ax
+0000dda0: 6973 5f73 697a 652c 2062 6174 6368 6564  is_size, batched
+0000ddb0: 5f70 7269 6d61 6c73 2c20 6261 7463 6865  _primals, batche
+0000ddc0: 645f 7461 6e67 656e 7473 2c20 2a2c 2066  d_tangents, *, f
+0000ddd0: 756e 6374 696f 6e5f 7472 6163 653a 2054  unction_trace: T
+0000dde0: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
+0000ddf0: 0a20 2020 2070 7269 6d61 6c73 2c20 7072  .    primals, pr
+0000de00: 696d 616c 735f 6264 696d 7320 3d20 7361  imals_bdims = sa
+0000de10: 6665 5f7a 6970 282a 6261 7463 6865 645f  fe_zip(*batched_
+0000de20: 7072 696d 616c 7329 0a20 2020 2074 616e  primals).    tan
+0000de30: 6765 6e74 732c 2074 616e 6765 6e74 735f  gents, tangents_
+0000de40: 6264 696d 7320 3d20 7361 6665 5f7a 6970  bdims = safe_zip
+0000de50: 282a 6261 7463 6865 645f 7461 6e67 656e  (*batched_tangen
+0000de60: 7473 290a 2020 2020 6a76 705f 6675 6e63  ts).    jvp_func
+0000de70: 203d 2070 6172 7469 616c 285f 6a76 705f   = partial(_jvp_
+0000de80: 6361 6c6c 5f6d 6574 6166 756e 632c 2046  call_metafunc, F
+0000de90: 616c 7365 2c20 6675 6e63 7469 6f6e 5f74  alse, function_t
+0000dea0: 7261 6365 3d66 756e 6374 696f 6e5f 7472  race=function_tr
+0000deb0: 6163 6529 0a20 2020 2076 6d61 7070 6564  ace).    vmapped
+0000dec0: 5f6a 7670 5f66 756e 6320 3d20 766d 6170  _jvp_func = vmap
+0000ded0: 286a 7670 5f66 756e 632c 2069 6e5f 6469  (jvp_func, in_di
+0000dee0: 6d73 3d28 7072 696d 616c 735f 6264 696d  ms=(primals_bdim
+0000def0: 732c 2074 616e 6765 6e74 735f 6264 696d  s, tangents_bdim
+0000df00: 7329 2c20 6178 6973 5f73 697a 653d 6178  s), axis_size=ax
+0000df10: 6973 5f73 697a 6529 0a20 2020 2072 6573  is_size).    res
+0000df20: 756c 7420 3d20 766d 6170 7065 645f 6a76  ult = vmapped_jv
+0000df30: 705f 6675 6e63 2870 7269 6d61 6c73 2c20  p_func(primals, 
+0000df40: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
+0000df50: 6773 290a 2020 2020 7265 7475 726e 2074  gs).    return t
+0000df60: 7265 655f 6d61 7028 6c61 6d62 6461 2078  ree_map(lambda x
+0000df70: 3a20 4261 7463 6865 6456 616c 7565 2878  : BatchedValue(x
+0000df80: 2c20 3029 2c20 7265 7375 6c74 290a 0a0a  , 0), result)...
+0000df90: 766d 6170 5f69 6d70 6c73 5b54 7261 6e73  vmap_impls[Trans
+0000dfa0: 666f 726d 732e 4a76 704f 705d 203d 205f  forms.JvpOp] = _
+0000dfb0: 6a76 705f 6361 6c6c 5f76 6d61 700a 0a0a  jvp_call_vmap...
+0000dfc0: 6465 6620 766d 6170 2866 756e 632c 2069  def vmap(func, i
+0000dfd0: 6e5f 6469 6d73 3d30 2c20 6f75 745f 6469  n_dims=0, out_di
+0000dfe0: 6d73 3d30 2c20 6178 6973 5f73 697a 653d  ms=0, axis_size=
+0000dff0: 4e6f 6e65 293a 0a20 2020 2022 2222 5665  None):.    """Ve
+0000e000: 6374 6f72 697a 696e 6720 7472 616e 7366  ctorizing transf
+0000e010: 6f72 6d20 666f 7220 6120 5468 756e 6465  orm for a Thunde
+0000e020: 7220 6675 6e63 7469 6f6e 2e0a 0a20 2020  r function...   
+0000e030: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
+0000e040: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
+0000e050: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
+0000e060: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
+0000e070: 726d 6564 2e0a 0a20 2020 2052 6574 7572  rmed...    Retur
+0000e080: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+0000e090: 6162 6c65 3a20 4120 766d 6170 7065 6420  able: A vmapped 
+0000e0a0: 7665 7273 696f 6e20 6f66 2074 6865 2066  version of the f
+0000e0b0: 756e 6374 696f 6e2e 0a20 2020 2022 2222  unction..    """
+0000e0c0: 0a0a 2020 2020 2320 544f 444f 3a20 666c  ..    # TODO: fl
+0000e0d0: 6174 7465 6e0a 2020 2020 2320 496e 204a  atten.    # In J
+0000e0e0: 4158 2066 6c61 7474 656e 696e 6720 6f66  AX flattening of
+0000e0f0: 2069 6e5f 6469 6d73 2069 7320 7261 7468   in_dims is rath
+0000e100: 6572 2063 6f6d 706c 6963 6174 6564 2062  er complicated b
+0000e110: 6563 6175 7365 2069 7420 6361 6e20 6f70  ecause it can op
+0000e120: 7469 6f6e 616c 6c79 2062 650a 2020 2020  tionally be.    
+0000e130: 2320 7370 6563 6966 6965 6420 6173 2061  # specified as a
+0000e140: 20e2 809c 7072 6566 6978 e280 9d20 7079   ...prefix... py
+0000e150: 7472 6565 2c20 6d65 616e 696e 6720 7468  tree, meaning th
+0000e160: 6174 2061 2073 696e 676c 6520 6c65 6166  at a single leaf
+0000e170: 2076 616c 7565 2063 616e 2062 6520 6170   value can be ap
+0000e180: 706c 6965 640a 2020 2020 2320 746f 2061  plied.    # to a
+0000e190: 6e20 656e 7469 7265 2073 7562 2d70 7974  n entire sub-pyt
+0000e1a0: 7265 652e 0a0a 2020 2020 6465 6620 666c  ree...    def fl
+0000e1b0: 6174 7465 6e5f 6675 6e63 5f66 6f72 5f76  atten_func_for_v
+0000e1c0: 6d61 7028 6675 6e63 2c20 6172 6773 2c20  map(func, args, 
+0000e1d0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0000e1e0: 2066 6c61 745f 6172 6773 2c20 7370 6563   flat_args, spec
+0000e1f0: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+0000e200: 2861 7267 732c 206b 7761 7267 7329 290a  (args, kwargs)).
+0000e210: 0a20 2020 2020 2020 2064 6566 2066 6c61  .        def fla
+0000e220: 745f 6675 6e63 282a 666c 6174 5f61 7267  t_func(*flat_arg
+0000e230: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000e240: 666e 5f61 7267 732c 2066 6e5f 6b77 6172  fn_args, fn_kwar
+0000e250: 6773 203d 2074 7265 655f 756e 666c 6174  gs = tree_unflat
+0000e260: 7465 6e28 666c 6174 5f61 7267 732c 2073  ten(flat_args, s
+0000e270: 7065 6329 0a20 2020 2020 2020 2020 2020  pec).           
+0000e280: 2072 6574 7572 6e20 6675 6e63 282a 666e   return func(*fn
+0000e290: 5f61 7267 732c 202a 2a66 6e5f 6b77 6172  _args, **fn_kwar
+0000e2a0: 6773 290a 0a20 2020 2020 2020 2072 6574  gs)..        ret
+0000e2b0: 7572 6e20 666c 6174 5f66 756e 632c 2066  urn flat_func, f
+0000e2c0: 6c61 745f 6172 6773 2c20 7370 6563 0a0a  lat_args, spec..
+0000e2d0: 2020 2020 6465 6620 7772 6170 7065 7228      def wrapper(
+0000e2e0: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0000e2f0: 3a0a 2020 2020 2020 2020 6675 6e63 5f66  :.        func_f
+0000e300: 6c61 742c 2061 7267 735f 666c 6174 2c20  lat, args_flat, 
+0000e310: 6172 6773 5f73 7065 6320 3d20 666c 6174  args_spec = flat
+0000e320: 7465 6e5f 6675 6e63 5f66 6f72 5f76 6d61  ten_func_for_vma
+0000e330: 7028 6675 6e63 2c20 6172 6773 2c20 6b77  p(func, args, kw
+0000e340: 6172 6773 290a 2020 2020 2020 2020 6966  args).        if
+0000e350: 2069 7369 6e73 7461 6e63 6528 696e 5f64   isinstance(in_d
+0000e360: 696d 732c 2069 6e74 293a 0a20 2020 2020  ims, int):.     
+0000e370: 2020 2020 2020 2069 6e5f 6469 6d73 5f66         in_dims_f
+0000e380: 6c61 7420 3d20 2869 6e5f 6469 6d73 2c29  lat = (in_dims,)
+0000e390: 202a 206c 656e 2861 7267 735f 666c 6174   * len(args_flat
+0000e3a0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000e3b0: 2020 2020 2020 2020 2020 2020 696e 5f64              in_d
+0000e3c0: 696d 735f 666c 6174 2c20 696e 5f64 696d  ims_flat, in_dim
+0000e3d0: 735f 7370 6563 203d 2074 7265 655f 666c  s_spec = tree_fl
+0000e3e0: 6174 7465 6e28 696e 5f64 696d 7329 0a20  atten(in_dims). 
+0000e3f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000e400: 7420 6c65 6e28 696e 5f64 696d 735f 666c  t len(in_dims_fl
+0000e410: 6174 2920 3d3d 206c 656e 2861 7267 735f  at) == len(args_
+0000e420: 666c 6174 292c 2022 696e 5f64 696d 7320  flat), "in_dims 
+0000e430: 6d75 7374 2068 6176 6520 7468 6520 7361  must have the sa
+0000e440: 6d65 206c 656e 6774 6820 6173 2061 7267  me length as arg
+0000e450: 732c 206b 7761 7267 7322 0a20 2020 2020  s, kwargs".     
+0000e460: 2020 2075 6e62 6174 6368 6564 5f61 7267     unbatched_arg
+0000e470: 735f 666c 6174 203d 205b 7265 6d6f 7665  s_flat = [remove
+0000e480: 5f62 6174 6368 5f64 696d 2861 7267 2920  _batch_dim(arg) 
+0000e490: 6966 2069 7369 6e73 7461 6e63 6528 6172  if isinstance(ar
+0000e4a0: 672c 2054 656e 736f 7250 726f 7879 2920  g, TensorProxy) 
+0000e4b0: 656c 7365 2061 7267 2066 6f72 2061 7267  else arg for arg
+0000e4c0: 2069 6e20 6172 6773 5f66 6c61 745d 0a20   in args_flat]. 
+0000e4d0: 2020 2020 2020 2074 7261 6365 203d 2063         trace = c
+0000e4e0: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+0000e4f0: 2866 756e 635f 666c 6174 2c20 2a75 6e62  (func_flat, *unb
+0000e500: 6174 6368 6564 5f61 7267 735f 666c 6174  atched_args_flat
+0000e510: 290a 2020 2020 2020 2020 6f75 7473 203d  ).        outs =
+0000e520: 2076 6d61 705f 6361 6c6c 2861 7267 735f   vmap_call(args_
+0000e530: 666c 6174 2c20 696e 5f64 696d 735f 666c  flat, in_dims_fl
+0000e540: 6174 2c20 6f75 745f 6469 6d73 2c20 6178  at, out_dims, ax
+0000e550: 6973 5f73 697a 653d 6178 6973 5f73 697a  is_size=axis_siz
+0000e560: 652c 2066 756e 6374 696f 6e5f 7472 6163  e, function_trac
+0000e570: 653d 7472 6163 6529 0a20 2020 2020 2020  e=trace).       
+0000e580: 2072 6574 7572 6e20 6f75 7473 0a0a 2020   return outs..  
+0000e590: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
+0000e5a0: 0a0a 0a23 2054 4f44 4f20 5468 6973 2066  ...# TODO This f
+0000e5b0: 756e 6374 696f 6e20 636f 6d6d 656e 7465  unction commente
+0000e5c0: 6420 6f75 7420 6265 6361 7573 6520 6974  d out because it
+0000e5d0: 2063 616c 6c73 206d 616b 655f 7472 6163   calls make_trac
+0000e5e0: 6564 2c20 7768 6963 6820 646f 6573 206e  ed, which does n
+0000e5f0: 6f74 2065 7869 7374 0a23 2064 6566 2076  ot exist.# def v
+0000e600: 6d61 705f 6561 6765 7228 6675 6e63 2c20  map_eager(func, 
+0000e610: 6172 6773 2c20 696e 5f64 696d 733d 302c  args, in_dims=0,
+0000e620: 206f 7574 5f64 696d 733d 302c 2061 7869   out_dims=0, axi
+0000e630: 735f 7369 7a65 3d4e 6f6e 652c 2065 7865  s_size=None, exe
+0000e640: 6375 746f 723d 2274 6f72 6368 2229 3a0a  cutor="torch"):.
+0000e650: 2320 2020 2020 2222 2243 6f6d 7075 7465  #     """Compute
+0000e660: 7320 7468 6520 766d 6170 206f 6620 6120  s the vmap of a 
+0000e670: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
+0000e680: 2e0a 0a23 2020 2020 2041 7267 733a 0a23  ...#     Args:.#
+0000e690: 2020 2020 2020 2020 2066 756e 6320 2843           func (C
+0000e6a0: 616c 6c61 626c 6529 3a20 4120 5468 756e  allable): A Thun
+0000e6b0: 6465 7220 6675 6e63 7469 6f6e 2074 6f20  der function to 
+0000e6c0: 6265 2074 7261 6e73 666f 726d 6564 2e0a  be transformed..
+0000e6d0: 2320 2020 2020 2020 2020 6172 6773 2028  #         args (
+0000e6e0: 5f74 7970 655f 293a 2041 7267 7320 6f66  _type_): Args of
+0000e6f0: 2074 6865 2066 756e 6374 696f 6e2e 0a23   the function..#
+0000e700: 2020 2020 2020 2020 2065 7865 6375 746f           executo
+0000e710: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
+0000e720: 293a 2045 7865 6375 746f 7220 746f 2075  ): Executor to u
+0000e730: 7365 2e20 4465 6661 756c 7473 2074 6f20  se. Defaults to 
+0000e740: 2274 6f72 6368 222e 0a0a 2320 2020 2020  "torch"...#     
+0000e750: 5265 7475 726e 733a 0a23 2020 2020 2020  Returns:.#      
+0000e760: 2020 2054 6865 2072 6573 756c 7420 6f66     The result of
+0000e770: 2074 6865 2076 6d61 7070 6564 2066 756e   the vmapped fun
+0000e780: 6374 696f 6e2e 0a23 2020 2020 2022 2222  ction..#     """
+0000e790: 0a23 2020 2020 2023 2054 4f44 4f3a 2066  .#     # TODO: f
+0000e7a0: 6978 2074 6869 7320 2d20 6e6f 7420 616c  ix this - not al
+0000e7b0: 6c20 6172 6773 206d 6179 2062 6520 6261  l args may be ba
+0000e7c0: 7463 6865 640a 2320 2020 2020 2320 544f  tched.#     # TO
+0000e7d0: 444f 3a20 6865 7265 2077 6520 6173 7375  DO: here we assu
+0000e7e0: 6d65 2062 6174 6368 2061 7869 7320 6973  me batch axis is
+0000e7f0: 2030 0a23 2020 2020 2076 6d61 705f 7472   0.#     vmap_tr
+0000e800: 6163 6520 3d20 6d61 6b65 5f74 7261 6365  ace = make_trace
+0000e810: 280a 2320 2020 2020 2020 2020 766d 6170  (.#         vmap
+0000e820: 2866 756e 632c 2069 6e5f 6469 6d73 3d69  (func, in_dims=i
+0000e830: 6e5f 6469 6d73 2c20 6f75 745f 6469 6d73  n_dims, out_dims
+0000e840: 3d6f 7574 5f64 696d 732c 2061 7869 735f  =out_dims, axis_
+0000e850: 7369 7a65 3d61 7869 735f 7369 7a65 292c  size=axis_size),
+0000e860: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
+0000e870: 6f72 2c0a 2320 2020 2020 2020 2020 2a61  or,.#         *a
+0000e880: 7267 7329 0a23 2020 2020 2076 6d61 705f  rgs).#     vmap_
+0000e890: 7472 6163 6564 203d 206d 616b 655f 7472  traced = make_tr
+0000e8a0: 6163 6564 2870 6172 7469 616c 2865 7661  aced(partial(eva
+0000e8b0: 6c5f 7472 6163 652c 2076 6d61 705f 7472  l_trace, vmap_tr
+0000e8c0: 6163 6529 2c20 6578 6563 7574 6f72 3d65  ace), executor=e
+0000e8d0: 7865 6375 746f 7229 0a23 2020 2020 2072  xecutor).#     r
+0000e8e0: 6574 7572 6e20 766d 6170 5f74 7261 6365  eturn vmap_trace
+0000e8f0: 6428 2a61 7267 7329 0a0a 0a23 204a 5650  d(*args)...# JVP
+0000e900: 2074 7261 6e73 666f 726d 0a23 202d 2d2d   transform.# ---
+0000e910: 2d2d 2d2d 2d2d 2d2d 2d2d 0a0a 0a40 6461  ----------...@da
+0000e920: 7461 636c 6173 7328 6672 6f7a 656e 3d54  taclass(frozen=T
+0000e930: 7275 6529 0a63 6c61 7373 204a 5650 4475  rue).class JVPDu
+0000e940: 616c 3a0a 2020 2020 2222 2244 7561 6c20  al:.    """Dual 
+0000e950: 6e75 6d62 6572 2066 6f72 2074 6865 204a  number for the J
+0000e960: 5650 2074 7261 6e73 666f 726d 2e0a 0a20  VP transform... 
+0000e970: 2020 2041 7474 7269 6275 7465 733a 0a20     Attributes:. 
+0000e980: 2020 2020 2020 2070 7269 6d61 6c3a 2050         primal: P
+0000e990: 7269 6d61 6c20 7661 6c75 652e 0a20 2020  rimal value..   
+0000e9a0: 2020 2020 2074 616e 6765 6e74 3a20 5461       tangent: Ta
+0000e9b0: 6e67 656e 7420 7661 6c75 652e 0a20 2020  ngent value..   
+0000e9c0: 2022 2222 0a0a 2020 2020 7072 696d 616c   """..    primal
+0000e9d0: 3a20 416e 790a 2020 2020 7461 6e67 656e  : Any.    tangen
+0000e9e0: 743a 2041 6e79 0a0a 2020 2020 6465 6620  t: Any..    def 
+0000e9f0: 5f5f 6974 6572 5f5f 2873 656c 6629 3a0a  __iter__(self):.
+0000ea00: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+0000ea10: 6c66 2e70 7269 6d61 6c0a 2020 2020 2020  lf.primal.      
+0000ea20: 2020 7969 656c 6420 7365 6c66 2e74 616e    yield self.tan
+0000ea30: 6765 6e74 0a0a 0a64 6566 2070 6169 725f  gent...def pair_
+0000ea40: 746f 5f6a 7670 5f64 7561 6c28 7061 6972  to_jvp_dual(pair
+0000ea50: 293a 0a20 2020 2022 2222 436f 6e76 6572  ):.    """Conver
+0000ea60: 7473 2061 2070 6169 7220 746f 2061 204a  ts a pair to a J
+0000ea70: 5650 4475 616c 2e0a 0a20 2020 2041 7267  VPDual...    Arg
+0000ea80: 733a 0a20 2020 2020 2020 2070 6169 7220  s:.        pair 
+0000ea90: 2853 6571 7565 6e63 6529 3a20 5061 6972  (Sequence): Pair
+0000eaa0: 2074 6f20 636f 6e76 6572 742e 0a0a 2020   to convert...  
+0000eab0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0000eac0: 2020 204a 5650 4475 616c 3a20 4a56 5044     JVPDual: JVPD
+0000ead0: 7561 6c20 7265 7072 6573 656e 7461 7469  ual representati
+0000eae0: 6f6e 206f 6620 7468 6520 7061 6972 2e0a  on of the pair..
+0000eaf0: 2020 2020 2222 220a 2020 2020 6966 2069      """.    if i
+0000eb00: 7369 6e73 7461 6e63 6528 7061 6972 2c20  sinstance(pair, 
+0000eb10: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
+0000eb20: 2020 7265 7475 726e 2070 6169 720a 2020    return pair.  
+0000eb30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000eb40: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0000eb50: 6528 7061 6972 2c20 5365 7175 656e 6365  e(pair, Sequence
+0000eb60: 2920 616e 6420 6c65 6e28 7061 6972 2920  ) and len(pair) 
+0000eb70: 3d3d 2032 0a20 2020 2020 2020 2072 6574  == 2.        ret
+0000eb80: 7572 6e20 4a56 5044 7561 6c28 2a70 6169  urn JVPDual(*pai
+0000eb90: 7229 0a0a 0a64 6566 2073 696e 5f6a 7670  r)...def sin_jvp
+0000eba0: 2861 3a20 4a56 5044 7561 6c29 3a0a 2020  (a: JVPDual):.  
+0000ebb0: 2020 782c 2078 6420 3d20 610a 2020 2020    x, xd = a.    
+0000ebc0: 7265 7475 726e 204a 5650 4475 616c 2870  return JVPDual(p
+0000ebd0: 7269 6d73 2e73 696e 2878 292c 2070 7269  rims.sin(x), pri
+0000ebe0: 6d73 2e63 6f73 2878 2920 2a20 7864 290a  ms.cos(x) * xd).
+0000ebf0: 0a0a 6465 6620 6d75 6c5f 6a76 7028 613a  ..def mul_jvp(a:
+0000ec00: 204a 5650 4475 616c 2c20 623a 204a 5650   JVPDual, b: JVP
+0000ec10: 4475 616c 293a 0a20 2020 2078 2c20 7864  Dual):.    x, xd
+0000ec20: 203d 2061 0a20 2020 2079 2c20 7964 203d   = a.    y, yd =
+0000ec30: 2062 0a20 2020 2072 6574 7572 6e20 4a56   b.    return JV
+0000ec40: 5044 7561 6c28 7820 2a20 792c 2078 202a  PDual(x * y, x *
+0000ec50: 2079 6420 2b20 7920 2a20 7864 290a 0a0a   yd + y * xd)...
+0000ec60: 6465 6620 6164 645f 6a76 7028 613a 204a  def add_jvp(a: J
+0000ec70: 5650 4475 616c 2c20 623a 204a 5650 4475  VPDual, b: JVPDu
+0000ec80: 616c 293a 0a20 2020 2078 2c20 7864 203d  al):.    x, xd =
+0000ec90: 2061 0a20 2020 2079 2c20 7964 203d 2062   a.    y, yd = b
+0000eca0: 0a20 2020 2072 6574 7572 6e20 4a56 5044  .    return JVPD
+0000ecb0: 7561 6c28 7820 2b20 792c 2078 6420 2b20  ual(x + y, xd + 
+0000ecc0: 7964 290a 0a0a 6465 6620 6272 6f61 6463  yd)...def broadc
+0000ecd0: 6173 745f 696e 5f64 696d 5f6a 7670 2861  ast_in_dim_jvp(a
+0000ece0: 3a20 4a56 5044 7561 6c2c 2073 6861 7065  : JVPDual, shape
+0000ecf0: 3a20 7475 706c 655b 4a56 5044 7561 6c2c  : tuple[JVPDual,
+0000ed00: 202e 2e2e 5d2c 2062 726f 6164 6361 7374   ...], broadcast
+0000ed10: 5f64 696d 656e 7369 6f6e 733a 2074 7570  _dimensions: tup
+0000ed20: 6c65 5b4a 5650 4475 616c 2c20 2e2e 2e5d  le[JVPDual, ...]
+0000ed30: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
+0000ed40: 2020 782c 2078 6420 3d20 610a 2020 2020    x, xd = a.    
+0000ed50: 2320 544f 444f 3a20 7368 6170 6520 616e  # TODO: shape an
+0000ed60: 6420 6272 6f61 6463 6173 745f 6469 6d65  d broadcast_dime
+0000ed70: 6e73 696f 6e73 2073 686f 756c 6420 6265  nsions should be
+0000ed80: 2074 7570 6c65 7320 6f66 2069 6e74 730a   tuples of ints.
+0000ed90: 2020 2020 2320 6275 7420 666f 7220 6e6f      # but for no
+0000eda0: 7720 6974 2773 2061 2074 7570 6c65 206f  w it's a tuple o
+0000edb0: 6620 4a56 5044 7561 6c73 0a20 2020 2069  f JVPDuals.    i
+0000edc0: 6620 6c65 6e28 7368 6170 6529 203e 2030  f len(shape) > 0
+0000edd0: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
+0000ede0: 7368 6170 655b 305d 2c20 4a56 5044 7561  shape[0], JVPDua
+0000edf0: 6c29 3a0a 2020 2020 2020 2020 7368 6170  l):.        shap
+0000ee00: 652c 205f 203d 2073 6166 655f 7a69 7028  e, _ = safe_zip(
+0000ee10: 2a73 6861 7065 290a 2020 2020 6966 206c  *shape).    if l
+0000ee20: 656e 2862 726f 6164 6361 7374 5f64 696d  en(broadcast_dim
+0000ee30: 656e 7369 6f6e 7329 203e 2030 2061 6e64  ensions) > 0 and
+0000ee40: 2069 7369 6e73 7461 6e63 6528 6272 6f61   isinstance(broa
+0000ee50: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
+0000ee60: 5b30 5d2c 204a 5650 4475 616c 293a 0a20  [0], JVPDual):. 
+0000ee70: 2020 2020 2020 2062 726f 6164 6361 7374         broadcast
+0000ee80: 5f64 696d 656e 7369 6f6e 732c 205f 203d  _dimensions, _ =
+0000ee90: 2073 6166 655f 7a69 7028 2a62 726f 6164   safe_zip(*broad
+0000eea0: 6361 7374 5f64 696d 656e 7369 6f6e 7329  cast_dimensions)
+0000eeb0: 0a20 2020 2072 6574 7572 6e20 4a56 5044  .    return JVPD
+0000eec0: 7561 6c28 0a20 2020 2020 2020 2070 7269  ual(.        pri
+0000eed0: 6d73 2e62 726f 6164 6361 7374 5f69 6e5f  ms.broadcast_in_
+0000eee0: 6469 6d28 782c 2073 6861 7065 2c20 6272  dim(x, shape, br
+0000eef0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000ef00: 6e73 292c 2070 7269 6d73 2e62 726f 6164  ns), prims.broad
+0000ef10: 6361 7374 5f69 6e5f 6469 6d28 7864 2c20  cast_in_dim(xd, 
+0000ef20: 7368 6170 652c 2062 726f 6164 6361 7374  shape, broadcast
+0000ef30: 5f64 696d 656e 7369 6f6e 7329 0a20 2020  _dimensions).   
+0000ef40: 2029 0a0a 0a64 6566 2075 6e70 6163 6b5f   )...def unpack_
+0000ef50: 7365 7175 656e 6365 5f6a 7670 2873 6571  sequence_jvp(seq
+0000ef60: 7565 6e63 653a 204a 5650 4475 616c 2c20  uence: JVPDual, 
+0000ef70: 6c65 6e67 7468 3a20 4a56 5044 7561 6c29  length: JVPDual)
+0000ef80: 202d 3e20 4a56 5044 7561 6c3a 0a20 2020   -> JVPDual:.   
+0000ef90: 2078 203d 2074 7265 655f 6d61 7028 6c61   x = tree_map(la
+0000efa0: 6d62 6461 2078 3a20 782e 7072 696d 616c  mbda x: x.primal
+0000efb0: 2c20 7365 7175 656e 6365 290a 2020 2020  , sequence).    
+0000efc0: 7864 203d 2074 7265 655f 6d61 7028 6c61  xd = tree_map(la
+0000efd0: 6d62 6461 2078 3a20 782e 7461 6e67 656e  mbda x: x.tangen
+0000efe0: 742c 2073 6571 7565 6e63 6529 0a20 2020  t, sequence).   
+0000eff0: 206c 656e 6774 682c 205f 203d 206c 656e   length, _ = len
+0000f000: 6774 680a 2020 2020 7072 696d 616c 7320  gth.    primals 
+0000f010: 3d20 7072 696d 732e 756e 7061 636b 5f73  = prims.unpack_s
+0000f020: 6571 7565 6e63 6528 782c 206c 656e 6774  equence(x, lengt
+0000f030: 6829 0a20 2020 2074 616e 6765 6e74 7320  h).    tangents 
+0000f040: 3d20 7072 696d 732e 756e 7061 636b 5f73  = prims.unpack_s
+0000f050: 6571 7565 6e63 6528 7864 2c20 6c65 6e67  equence(xd, leng
+0000f060: 7468 290a 2020 2020 7265 7475 726e 2073  th).    return s
+0000f070: 6166 655f 6d61 7028 7061 6972 5f74 6f5f  afe_map(pair_to_
+0000f080: 6a76 705f 6475 616c 2c20 7361 6665 5f7a  jvp_dual, safe_z
+0000f090: 6970 2870 7269 6d61 6c73 2c20 7461 6e67  ip(primals, tang
+0000f0a0: 656e 7473 2929 0a0a 0a64 6566 2075 6e70  ents))...def unp
+0000f0b0: 6163 6b5f 7472 6976 6961 6c5f 6a76 7028  ack_trivial_jvp(
+0000f0c0: 783a 204a 5650 4475 616c 2920 2d3e 204a  x: JVPDual) -> J
+0000f0d0: 5650 4475 616c 3a0a 2020 2020 7265 7475  VPDual:.    retu
+0000f0e0: 726e 2078 0a0a 0a6a 7670 5f69 6d70 6c73  rn x...jvp_impls
+0000f0f0: 3a20 6469 6374 5b70 7269 6d73 2e53 796d  : dict[prims.Sym
+0000f100: 626f 6c2c 2043 616c 6c61 626c 655d 203d  bol, Callable] =
+0000f110: 2064 6963 7428 290a 0a6a 7670 5f69 6d70   dict()..jvp_imp
+0000f120: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
+0000f130: 2e53 494e 5d20 3d20 7369 6e5f 6a76 700a  .SIN] = sin_jvp.
+0000f140: 6a76 705f 696d 706c 735b 7072 696d 732e  jvp_impls[prims.
+0000f150: 5072 696d 4944 732e 4d55 4c5d 203d 206d  PrimIDs.MUL] = m
+0000f160: 756c 5f6a 7670 0a6a 7670 5f69 6d70 6c73  ul_jvp.jvp_impls
+0000f170: 5b70 7269 6d73 2e50 7269 6d49 4473 2e41  [prims.PrimIDs.A
+0000f180: 4444 5d20 3d20 6164 645f 6a76 700a 6a76  DD] = add_jvp.jv
+0000f190: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
+0000f1a0: 696d 4944 732e 4252 4f41 4443 4153 545f  imIDs.BROADCAST_
+0000f1b0: 494e 5f44 494d 5d20 3d20 6272 6f61 6463  IN_DIM] = broadc
+0000f1c0: 6173 745f 696e 5f64 696d 5f6a 7670 0a23  ast_in_dim_jvp.#
+0000f1d0: 206a 7670 5f69 6d70 6c73 5b70 7269 6d73   jvp_impls[prims
+0000f1e0: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
+0000f1f0: 5345 5155 454e 4345 5d20 3d20 756e 7061  SEQUENCE] = unpa
+0000f200: 636b 5f73 6571 7565 6e63 655f 6a76 700a  ck_sequence_jvp.
+0000f210: 2320 6a76 705f 696d 706c 735b 7072 696d  # jvp_impls[prim
+0000f220: 732e 5072 696d 4944 732e 554e 5041 434b  s.PrimIDs.UNPACK
+0000f230: 5f54 5249 5649 414c 5d20 3d20 756e 7061  _TRIVIAL] = unpa
+0000f240: 636b 5f74 7269 7669 616c 5f6a 7670 0a0a  ck_trivial_jvp..
+0000f250: 0a64 6566 206a 7670 5f73 796d 626f 6c5f  .def jvp_symbol_
+0000f260: 6d61 7070 6572 2873 796d 626f 6c3a 2070  mapper(symbol: p
+0000f270: 7269 6d73 2e53 796d 626f 6c29 3a0a 2020  rims.Symbol):.  
+0000f280: 2020 2222 224d 6170 7320 6120 7379 6d62    """Maps a symb
+0000f290: 6f6c 2074 6f20 6120 4a56 5020 6675 6e63  ol to a JVP func
+0000f2a0: 7469 6f6e 2074 6861 7420 6576 616c 7561  tion that evalua
+0000f2b0: 7465 7320 6974 2e0a 0a20 2020 2041 7267  tes it...    Arg
+0000f2c0: 733a 0a20 2020 2020 2020 2073 796d 626f  s:.        symbo
+0000f2d0: 6c20 2870 7269 6d73 2e53 796d 626f 6c29  l (prims.Symbol)
+0000f2e0: 3a20 5379 6d62 6f6c 2074 6f20 6576 616c  : Symbol to eval
+0000f2f0: 7561 7465 2e0a 0a20 2020 2052 6169 7365  uate...    Raise
+0000f300: 733a 0a20 2020 2020 2020 204e 6f74 496d  s:.        NotIm
+0000f310: 706c 656d 656e 7465 6445 7272 6f72 3a20  plementedError: 
+0000f320: 4966 2074 6865 204a 5650 2066 6f72 2074  If the JVP for t
+0000f330: 6865 2073 796d 626f 6c20 6973 206e 6f74  he symbol is not
+0000f340: 2069 6d70 6c65 6d65 6e74 6564 2e0a 0a20   implemented... 
+0000f350: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0000f360: 2020 2020 4361 6c6c 6162 6c65 3a20 4a56      Callable: JV
+0000f370: 5020 6675 6e63 7469 6f6e 2074 6861 7420  P function that 
+0000f380: 6576 616c 7561 7465 7320 7468 6520 7379  evaluates the sy
+0000f390: 6d62 6f6c 2e0a 2020 2020 2222 220a 0a20  mbol..    """.. 
+0000f3a0: 2020 2064 6566 2077 7261 705f 6172 6728     def wrap_arg(
+0000f3b0: 7829 3a0a 2020 2020 2020 2020 6966 2069  x):.        if i
+0000f3c0: 7369 6e73 7461 6e63 6528 782c 204a 5650  sinstance(x, JVP
+0000f3d0: 4475 616c 293a 0a20 2020 2020 2020 2020  Dual):.         
+0000f3e0: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
+0000f3f0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0000f400: 6e63 6528 782c 204e 756d 6265 7229 3a0a  nce(x, Number):.
+0000f410: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000f420: 726e 204a 5650 4475 616c 2878 2c20 7479  rn JVPDual(x, ty
+0000f430: 7065 2878 2928 3029 290a 2020 2020 2020  pe(x)(0)).      
+0000f440: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000f450: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0000f460: 7272 6f72 2866 224a 5650 2077 7261 705f  rror(f"JVP wrap_
+0000f470: 6172 6720 676f 7420 616e 2075 6e73 7570  arg got an unsup
+0000f480: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
+0000f490: 6528 7829 7d22 290a 0a20 2020 2023 2049  e(x)}")..    # I
+0000f4a0: 6620 7379 6d62 6f6c 2e61 7267 7320 646f  f symbol.args do
+0000f4b0: 6573 6e27 7420 6861 7665 2073 7562 636c  esn't have subcl
+0000f4c0: 6173 7365 7320 6f66 2056 6172 6961 626c  asses of Variabl
+0000f4d0: 652c 2074 6865 6e20 7765 206e 6565 6420  e, then we need 
+0000f4e0: 746f 2072 6574 7572 6e20 6120 7a65 726f  to return a zero
+0000f4f0: 2074 616e 6765 6e74 0a20 2020 2023 2054   tangent.    # T
+0000f500: 4f44 4f3a 2074 6865 7265 206d 6179 2062  ODO: there may b
+0000f510: 6520 6120 6265 7474 6572 2077 6179 2074  e a better way t
+0000f520: 6f20 6465 7465 6374 2063 6f6e 7374 616e  o detect constan
+0000f530: 7473 2069 6e20 7468 6520 7472 6163 650a  ts in the trace.
+0000f540: 2020 2020 6966 2073 796d 626f 6c2e 6172      if symbol.ar
+0000f550: 655f 616c 6c5f 6172 6773 5f63 6f6e 7374  e_all_args_const
+0000f560: 616e 743a 0a0a 2020 2020 2020 2020 6465  ant:..        de
+0000f570: 6620 7a65 726f 735f 6c69 6b65 2878 293a  f zeros_like(x):
+0000f580: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000f590: 6973 696e 7374 616e 6365 2878 2c20 5465  isinstance(x, Te
+0000f5a0: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
+0000f5b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000f5c0: 726e 2066 756c 6c5f 6c69 6b65 2878 2c20  rn full_like(x, 
+0000f5d0: 6669 6c6c 5f76 616c 7565 3d30 290a 2020  fill_value=0).  
+0000f5e0: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+0000f5f0: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
+0000f600: 6265 7250 726f 7879 293a 0a20 2020 2020  berProxy):.     
+0000f610: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f620: 6e20 7479 7065 2878 2e76 616c 7565 2928  n type(x.value)(
+0000f630: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
+0000f640: 6c69 6620 6973 696e 7374 616e 6365 2878  lif isinstance(x
+0000f650: 2c20 4e75 6d62 6572 293a 0a20 2020 2020  , Number):.     
+0000f660: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000f670: 6e20 7479 7065 2878 2928 3029 0a20 2020  n type(x)(0).   
+0000f680: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000f690: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000f6a0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000f6b0: 6622 7a65 726f 735f 6c69 6b65 2069 6e73  f"zeros_like ins
+0000f6c0: 6964 6520 4a56 5020 676f 7420 616e 2075  ide JVP got an u
+0000f6d0: 6e73 7570 706f 7274 6564 2074 7970 6520  nsupported type 
+0000f6e0: 7b74 7970 6528 7829 7d22 290a 0a20 2020  {type(x)}")..   
+0000f6f0: 2020 2020 2064 6566 206a 7670 5f69 6d70       def jvp_imp
+0000f700: 6c5f 636f 6e73 7428 7379 6d62 6f6c 2c20  l_const(symbol, 
+0000f710: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0000f720: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+0000f730: 696d 616c 7320 3d20 7379 6d62 6f6c 5f74  imals = symbol_t
+0000f740: 6f5f 6576 616c 2873 796d 626f 6c29 282a  o_eval(symbol)(*
+0000f750: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+0000f760: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000f770: 7369 6e73 7461 6e63 6528 7072 696d 616c  sinstance(primal
+0000f780: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+0000f790: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0000f7a0: 6e67 656e 7473 203d 2074 7570 6c65 287a  ngents = tuple(z
+0000f7b0: 6572 6f73 5f6c 696b 6528 7029 2066 6f72  eros_like(p) for
+0000f7c0: 2070 2069 6e20 7072 696d 616c 7329 0a20   p in primals). 
+0000f7d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000f7e0: 6574 7572 6e20 7361 6665 5f6d 6170 2870  eturn safe_map(p
+0000f7f0: 6169 725f 746f 5f6a 7670 5f64 7561 6c2c  air_to_jvp_dual,
+0000f800: 2073 6166 655f 7a69 7028 7072 696d 616c   safe_zip(primal
+0000f810: 732c 2074 616e 6765 6e74 7329 290a 2020  s, tangents)).  
+0000f820: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000f830: 204a 5650 4475 616c 2870 7269 6d61 6c73   JVPDual(primals
+0000f840: 2c20 7a65 726f 735f 6c69 6b65 2870 7269  , zeros_like(pri
+0000f850: 6d61 6c73 2929 0a0a 2020 2020 2020 2020  mals))..        
+0000f860: 7265 7475 726e 2070 6172 7469 616c 286a  return partial(j
+0000f870: 7670 5f69 6d70 6c5f 636f 6e73 742c 2073  vp_impl_const, s
+0000f880: 796d 626f 6c29 0a0a 2020 2020 2320 4e6f  ymbol)..    # No
+0000f890: 726d 616c 2063 6173 652c 2077 6520 6861  rmal case, we ha
+0000f8a0: 7665 2061 2070 726f 7879 2074 616e 6765  ve a proxy tange
+0000f8b0: 6e74 0a20 2020 206a 7670 5f69 6d70 6c20  nt.    jvp_impl 
+0000f8c0: 3d20 6a76 705f 696d 706c 732e 6765 7428  = jvp_impls.get(
+0000f8d0: 7379 6d62 6f6c 2e73 796d 2e69 6429 0a20  symbol.sym.id). 
+0000f8e0: 2020 2069 6620 6a76 705f 696d 706c 2069     if jvp_impl i
+0000f8f0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000f900: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
+0000f910: 6e74 6564 4572 726f 7228 6622 4a56 5020  ntedError(f"JVP 
+0000f920: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
+0000f930: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
+0000f940: 6d65 6e74 6564 2229 0a0a 2020 2020 6465  mented")..    de
+0000f950: 6620 5f6a 7670 5f69 6d70 6c28 2a61 7267  f _jvp_impl(*arg
+0000f960: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000f970: 2020 2020 2020 6172 6773 203d 2074 7265        args = tre
+0000f980: 655f 6d61 7028 7772 6170 5f61 7267 2c20  e_map(wrap_arg, 
+0000f990: 6172 6773 290a 2020 2020 2020 2020 2320  args).        # 
+0000f9a0: 4578 7065 6374 696e 6720 4a56 5044 7561  Expecting JVPDua
+0000f9b0: 6c73 2077 7261 7070 696e 6720 7061 6972  ls wrapping pair
+0000f9c0: 7320 6f66 2070 7269 6d61 6c73 2061 6e64  s of primals and
+0000f9d0: 2074 616e 6765 6e74 730a 2020 2020 2020   tangents.      
+0000f9e0: 2020 6173 7365 7274 2061 6c6c 2869 7369    assert all(isi
+0000f9f0: 6e73 7461 6e63 6528 6172 672c 204a 5650  nstance(arg, JVP
+0000fa00: 4475 616c 2920 666f 7220 6172 6720 696e  Dual) for arg in
+0000fa10: 2074 7265 655f 666c 6174 7465 6e28 6172   tree_flatten(ar
+0000fa20: 6773 295b 305d 290a 2020 2020 2020 2020  gs)[0]).        
+0000fa30: 7265 7475 726e 206a 7670 5f69 6d70 6c28  return jvp_impl(
+0000fa40: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0000fa50: 0a0a 2020 2020 7265 7475 726e 205f 6a76  ..    return _jv
+0000fa60: 705f 696d 706c 0a0a 0a64 6566 205f 6a76  p_impl...def _jv
+0000fa70: 705f 6361 6c6c 5f6d 6574 6166 756e 6328  p_call_metafunc(
+0000fa80: 6465 7461 6368 6564 3a20 626f 6f6c 2c20  detached: bool, 
+0000fa90: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+0000faa0: 732c 202a 2c20 6675 6e63 7469 6f6e 5f74  s, *, function_t
+0000fab0: 7261 6365 3a20 5472 6163 652c 202a 2a6b  race: Trace, **k
+0000fac0: 7761 7267 7329 3a0a 2020 2020 2222 224d  wargs):.    """M
+0000fad0: 6574 6166 756e 6374 696f 6e20 666f 7220  etafunction for 
+0000fae0: 7468 6520 4a56 5020 7472 616e 7366 6f72  the JVP transfor
+0000faf0: 6d2e 0a0a 2020 2020 4172 6773 3a0a 2020  m...    Args:.  
+0000fb00: 2020 2020 2020 6465 7461 6368 6564 2028        detached (
+0000fb10: 626f 6f6c 293a 2057 6865 7468 6572 2074  bool): Whether t
+0000fb20: 6f20 6465 7461 6368 2074 6865 2074 7261  o detach the tra
+0000fb30: 6365 2e0a 2020 2020 2020 2020 7072 696d  ce..        prim
+0000fb40: 616c 7320 2854 7570 6c65 5b50 726f 7879  als (Tuple[Proxy
+0000fb50: 5d29 3a20 5072 696d 616c 2076 616c 7565  ]): Primal value
+0000fb60: 732e 0a20 2020 2020 2020 2074 616e 6765  s..        tange
+0000fb70: 6e74 7320 2854 7570 6c65 5b50 726f 7879  nts (Tuple[Proxy
+0000fb80: 5d29 3a20 5461 6e67 656e 7420 7661 6c75  ]): Tangent valu
+0000fb90: 6573 2e0a 2020 2020 2020 2020 6675 6e63  es..        func
+0000fba0: 7469 6f6e 5f74 7261 6365 2028 5472 6163  tion_trace (Trac
+0000fbb0: 6529 3a20 5472 6163 6520 6f66 2074 6865  e): Trace of the
+0000fbc0: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
+0000fbd0: 7472 616e 7366 6f72 6d65 642e 0a20 2020  transformed..   
+0000fbe0: 2020 2020 206b 7761 7267 733a 204b 6579       kwargs: Key
+0000fbf0: 776f 7264 2061 7267 756d 656e 7473 2e0a  word arguments..
+0000fc00: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+0000fc10: 2020 2020 2041 7373 6572 7469 6f6e 4572       AssertionEr
+0000fc20: 726f 723a 2049 6620 7468 6520 4a56 5020  ror: If the JVP 
+0000fc30: 666f 7220 6b65 7977 6f72 6420 6172 6775  for keyword argu
+0000fc40: 6d65 6e74 7320 6973 206e 6f74 2069 6d70  ments is not imp
+0000fc50: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
+0000fc60: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000fc70: 5265 7375 6c74 206f 6620 7468 6520 4a56  Result of the JV
+0000fc80: 5020 7472 616e 7366 6f72 6d2e 0a20 2020  P transform..   
+0000fc90: 2022 2222 0a20 2020 2061 7373 6572 7420   """.    assert 
+0000fca0: 6c65 6e28 6b77 6172 6773 2920 3d3d 2030  len(kwargs) == 0
+0000fcb0: 2c20 224a 5650 2066 6f72 206b 7761 7267  , "JVP for kwarg
+0000fcc0: 7320 6973 206e 6f74 2069 6d70 6c65 6d65  s is not impleme
+0000fcd0: 6e74 6564 220a 0a20 2020 2063 7478 203d  nted"..    ctx =
+0000fce0: 2064 6574 6163 6865 645f 7472 6163 6528   detached_trace(
+0000fcf0: 2920 6966 2064 6574 6163 6865 6420 656c  ) if detached el
+0000fd00: 7365 206e 756c 6c63 6f6e 7465 7874 2829  se nullcontext()
+0000fd10: 0a20 2020 2077 6974 6820 6374 783a 0a20  .    with ctx:. 
+0000fd20: 2020 2020 2020 2023 2057 7261 7070 696e         # Wrappin
+0000fd30: 6720 7468 6520 7072 696d 616c 7320 616e  g the primals an
+0000fd40: 6420 7461 6e67 656e 7473 2069 6e20 4a56  d tangents in JV
+0000fd50: 5044 7561 6c73 2069 7320 6e6f 7420 7374  PDuals is not st
+0000fd60: 7269 6374 6c79 206e 6563 6573 7361 7279  rictly necessary
+0000fd70: 2c20 6275 7420 6974 206d 616b 6573 0a20  , but it makes. 
+0000fd80: 2020 2020 2020 2023 2074 6865 2063 6f64         # the cod
+0000fd90: 6520 6d6f 7265 2072 6561 6461 626c 650a  e more readable.
+0000fda0: 2020 2020 2020 2020 2320 5765 2070 726f          # We pro
+0000fdb0: 7061 6761 7465 2074 6865 204a 5650 4475  pagate the JVPDu
+0000fdc0: 616c 7320 7468 726f 7567 6820 7468 6520  als through the 
+0000fdd0: 7472 6163 652c 2061 6e64 2074 6865 6e20  trace, and then 
+0000fde0: 756e 7772 6170 2074 6865 6d20 6174 2074  unwrap them at t
+0000fdf0: 6865 2065 6e64 0a20 2020 2020 2020 2070  he end.        p
+0000fe00: 7269 6d61 6c73 5f74 616e 6765 6e74 735f  rimals_tangents_
+0000fe10: 6475 616c 7320 3d20 7361 6665 5f6d 6170  duals = safe_map
+0000fe20: 2870 6169 725f 746f 5f6a 7670 5f64 7561  (pair_to_jvp_dua
+0000fe30: 6c2c 2073 6166 655f 7a69 7028 7072 696d  l, safe_zip(prim
+0000fe40: 616c 732c 2074 616e 6765 6e74 7329 290a  als, tangents)).
+0000fe50: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0000fe60: 2065 7661 6c5f 7472 6163 6528 6675 6e63   eval_trace(func
+0000fe70: 7469 6f6e 5f74 7261 6365 2c20 2a70 7269  tion_trace, *pri
+0000fe80: 6d61 6c73 5f74 616e 6765 6e74 735f 6475  mals_tangents_du
+0000fe90: 616c 732c 2073 796d 626f 6c5f 6d61 7070  als, symbol_mapp
+0000fea0: 6572 3d6a 7670 5f73 796d 626f 6c5f 6d61  er=jvp_symbol_ma
+0000feb0: 7070 6572 290a 2020 2020 2020 2020 2320  pper).        # 
+0000fec0: 556e 7772 6170 7069 6e67 2074 6865 204a  Unwrapping the J
+0000fed0: 5650 4475 616c 730a 2020 2020 2020 2020  VPDuals.        
+0000fee0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
+0000fef0: 7375 6c74 2c20 5365 7175 656e 6365 293a  sult, Sequence):
+0000ff00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000ff10: 6572 7420 616c 6c28 6973 696e 7374 616e  ert all(isinstan
+0000ff20: 6365 2878 2c20 4a56 5044 7561 6c29 2066  ce(x, JVPDual) f
+0000ff30: 6f72 2078 2069 6e20 7265 7375 6c74 290a  or x in result).
+0000ff40: 2020 2020 2020 2020 2020 2020 7072 696d              prim
+0000ff50: 616c 732c 2074 616e 6765 6e74 7320 3d20  als, tangents = 
+0000ff60: 756e 7a69 7032 2872 6573 756c 7429 0a20  unzip2(result). 
+0000ff70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ff80: 6e20 7072 696d 616c 732c 2074 616e 6765  n primals, tange
+0000ff90: 6e74 730a 2020 2020 2020 2020 6173 7365  nts.        asse
+0000ffa0: 7274 2069 7369 6e73 7461 6e63 6528 7265  rt isinstance(re
+0000ffb0: 7375 6c74 2c20 4a56 5044 7561 6c29 0a20  sult, JVPDual). 
+0000ffc0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000ffd0: 7375 6c74 2e70 7269 6d61 6c2c 2072 6573  sult.primal, res
+0000ffe0: 756c 742e 7461 6e67 656e 740a 0a0a 6a76  ult.tangent...jv
+0000fff0: 705f 6361 6c6c 203d 2053 796d 626f 6c28  p_call = Symbol(
+00010000: 6964 3d54 7261 6e73 666f 726d 732e 4a76  id=Transforms.Jv
+00010010: 704f 702c 206e 616d 653d 226a 7670 5f63  pOp, name="jvp_c
+00010020: 616c 6c22 2c20 6d65 7461 3d70 6172 7469  all", meta=parti
+00010030: 616c 285f 6a76 705f 6361 6c6c 5f6d 6574  al(_jvp_call_met
+00010040: 6166 756e 632c 2046 616c 7365 2929 0a0a  afunc, False))..
+00010050: 0a64 6566 205f 6964 656e 7469 7479 5f63  .def _identity_c
+00010060: 616c 6c5f 6a76 7028 2a61 7267 733a 204a  all_jvp(*args: J
+00010070: 5650 4475 616c 2c20 7472 6163 653a 2054  VPDual, trace: T
+00010080: 7261 6365 2c20 2a2a 6b77 6172 6773 293a  race, **kwargs):
+00010090: 0a20 2020 2070 7269 6d61 6c73 2c20 7461  .    primals, ta
+000100a0: 6e67 656e 7473 203d 2075 6e7a 6970 3228  ngents = unzip2(
+000100b0: 6172 6773 290a 2020 2020 6f75 745f 7072  args).    out_pr
+000100c0: 696d 616c 732c 206f 7574 5f74 616e 6765  imals, out_tange
+000100d0: 6e74 7320 3d20 5f6a 7670 5f63 616c 6c5f  nts = _jvp_call_
+000100e0: 6d65 7461 6675 6e63 2846 616c 7365 2c20  metafunc(False, 
+000100f0: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+00010100: 732c 2074 7261 6365 2c20 2a2a 6b77 6172  s, trace, **kwar
+00010110: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
+00010120: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
+00010130: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+00010140: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
+00010150: 655f 6d61 7028 7061 6972 5f74 6f5f 6a76  e_map(pair_to_jv
+00010160: 705f 6475 616c 2c20 7361 6665 5f7a 6970  p_dual, safe_zip
+00010170: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
+00010180: 745f 7461 6e67 656e 7473 2929 0a20 2020  t_tangents)).   
+00010190: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
+000101a0: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
+000101b0: 5f74 616e 6765 6e74 7329 0a0a 0a6a 7670  _tangents)...jvp
+000101c0: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
+000101d0: 732e 4964 656e 7469 7479 4f70 5d20 3d20  s.IdentityOp] = 
+000101e0: 5f69 6465 6e74 6974 795f 6361 6c6c 5f6a  _identity_call_j
+000101f0: 7670 0a0a 0a64 6566 205f 766d 6170 5f63  vp...def _vmap_c
+00010200: 616c 6c5f 6a76 7028 6172 6773 3a20 4a56  all_jvp(args: JV
+00010210: 5044 7561 6c2c 2069 6e5f 6469 6d73 2c20  PDual, in_dims, 
+00010220: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
+00010230: 697a 652c 2074 7261 6365 3a20 5472 6163  ize, trace: Trac
+00010240: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
+00010250: 2020 7072 696d 616c 732c 2074 616e 6765    primals, tange
+00010260: 6e74 7320 3d20 7361 6665 5f7a 6970 282a  nts = safe_zip(*
+00010270: 6172 6773 290a 2020 2020 696e 5f64 696d  args).    in_dim
+00010280: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
+00010290: 2a69 6e5f 6469 6d73 290a 2020 2020 6f75  *in_dims).    ou
+000102a0: 745f 6469 6d73 2c20 5f20 3d20 7361 6665  t_dims, _ = safe
+000102b0: 5f7a 6970 282a 6f75 745f 6469 6d73 290a  _zip(*out_dims).
+000102c0: 2020 2020 766d 6170 7065 645f 7472 6163      vmapped_trac
+000102d0: 6520 3d20 636f 6e73 7472 7563 745f 7472  e = construct_tr
+000102e0: 6163 6528 2928 0a20 2020 2020 2020 2076  ace()(.        v
+000102f0: 6d61 7028 7061 7274 6961 6c28 6576 616c  map(partial(eval
+00010300: 5f74 7261 6365 2c20 7472 6163 6529 2c20  _trace, trace), 
+00010310: 696e 5f64 696d 733d 696e 5f64 696d 732c  in_dims=in_dims,
+00010320: 206f 7574 5f64 696d 733d 6f75 745f 6469   out_dims=out_di
+00010330: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
+00010340: 6973 5f73 697a 6529 2c20 2a70 7269 6d61  is_size), *prima
+00010350: 6c73 0a20 2020 2029 0a20 2020 2076 6d61  ls.    ).    vma
+00010360: 7070 6564 5f66 756e 6320 3d20 7061 7274  pped_func = part
+00010370: 6961 6c28 6576 616c 5f74 7261 6365 2c20  ial(eval_trace, 
+00010380: 766d 6170 7065 645f 7472 6163 6529 0a20  vmapped_trace). 
+00010390: 2020 206f 7574 5f70 7269 6d61 6c73 2c20     out_primals, 
+000103a0: 6f75 745f 7461 6e67 656e 7473 203d 206a  out_tangents = j
+000103b0: 7670 2876 6d61 7070 6564 5f66 756e 6329  vp(vmapped_func)
+000103c0: 2870 7269 6d61 6c73 2c20 7461 6e67 656e  (primals, tangen
+000103d0: 7473 2c20 2a2a 6b77 6172 6773 290a 2020  ts, **kwargs).  
+000103e0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000103f0: 6f75 745f 7072 696d 616c 732c 2053 6571  out_primals, Seq
+00010400: 7565 6e63 6529 3a0a 2020 2020 2020 2020  uence):.        
+00010410: 7265 7475 726e 2073 6166 655f 6d61 7028  return safe_map(
+00010420: 7061 6972 5f74 6f5f 6a76 705f 6475 616c  pair_to_jvp_dual
+00010430: 2c20 7361 6665 5f7a 6970 286f 7574 5f70  , safe_zip(out_p
+00010440: 7269 6d61 6c73 2c20 6f75 745f 7461 6e67  rimals, out_tang
+00010450: 656e 7473 2929 0a20 2020 2072 6574 7572  ents)).    retur
+00010460: 6e20 4a56 5044 7561 6c28 6f75 745f 7072  n JVPDual(out_pr
+00010470: 696d 616c 732c 206f 7574 5f74 616e 6765  imals, out_tange
+00010480: 6e74 7329 0a0a 0a6a 7670 5f69 6d70 6c73  nts)...jvp_impls
+00010490: 5b54 7261 6e73 666f 726d 732e 566d 6170  [Transforms.Vmap
+000104a0: 4f70 5d20 3d20 5f76 6d61 705f 6361 6c6c  Op] = _vmap_call
+000104b0: 5f6a 7670 0a0a 0a64 6566 206a 7670 2866  _jvp...def jvp(f
+000104c0: 756e 6329 3a0a 2020 2020 2222 224a 6163  unc):.    """Jac
+000104d0: 6f62 6961 6e2d 7665 6374 6f72 2070 726f  obian-vector pro
+000104e0: 6475 6374 2074 7261 6e73 666f 726d 2066  duct transform f
+000104f0: 6f72 2061 2054 6875 6e64 6572 2066 756e  or a Thunder fun
+00010500: 6374 696f 6e2e 0a0a 2020 2020 4172 6773  ction...    Args
+00010510: 3a0a 2020 2020 2020 2020 6675 6e63 2028  :.        func (
+00010520: 4361 6c6c 6162 6c65 293a 2041 2054 6875  Callable): A Thu
+00010530: 6e64 6572 2066 756e 6374 696f 6e20 746f  nder function to
+00010540: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+00010550: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
+00010560: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
+00010570: 2041 2066 756e 6374 696f 6e20 7468 6174   A function that
+00010580: 2063 6f6d 7075 7465 7320 7468 6520 4a61   computes the Ja
+00010590: 636f 6269 616e 2d76 6563 746f 7220 7072  cobian-vector pr
+000105a0: 6f64 7563 740a 2020 2020 2020 2020 2020  oduct.          
+000105b0: 2020 7461 6b69 6e67 2070 7269 6d61 6c73    taking primals
+000105c0: 2061 6e64 2074 616e 6765 6e74 7320 6173   and tangents as
+000105d0: 2061 7267 756d 656e 7473 2e0a 2020 2020   arguments..    
+000105e0: 2222 220a 0a20 2020 2064 6566 2077 7261  """..    def wra
+000105f0: 7070 6572 2870 7269 6d61 6c73 2c20 7461  pper(primals, ta
+00010600: 6e67 656e 7473 293a 0a20 2020 2020 2020  ngents):.       
+00010610: 2074 7261 6365 203d 2063 6f6e 7374 7275   trace = constru
+00010620: 6374 5f74 7261 6365 2829 2866 756e 632c  ct_trace()(func,
+00010630: 202a 7072 696d 616c 7329 0a20 2020 2020   *primals).     
+00010640: 2020 2072 6574 7572 6e20 6a76 705f 6361     return jvp_ca
+00010650: 6c6c 2870 7269 6d61 6c73 2c20 7461 6e67  ll(primals, tang
+00010660: 656e 7473 2c20 6675 6e63 7469 6f6e 5f74  ents, function_t
+00010670: 7261 6365 3d74 7261 6365 290a 0a20 2020  race=trace)..   
+00010680: 2072 6574 7572 6e20 7772 6170 7065 720a   return wrapper.
+00010690: 0a0a 2320 544f 444f 2054 6869 7320 6675  ..# TODO This fu
+000106a0: 6e63 7469 6f6e 2063 6f6d 6d65 6e74 6564  nction commented
+000106b0: 206f 7574 2062 6563 6175 7365 2069 7420   out because it 
+000106c0: 6361 6c6c 7320 6d61 6b65 5f74 7261 6365  calls make_trace
+000106d0: 642c 2077 6869 6368 2064 6f65 7320 6e6f  d, which does no
+000106e0: 7420 6578 6973 740a 2320 6465 6620 6a76  t exist.# def jv
+000106f0: 705f 6561 6765 7228 6675 6e63 2c20 7072  p_eager(func, pr
+00010700: 696d 616c 732c 2074 616e 6765 6e74 732c  imals, tangents,
+00010710: 2065 7865 6375 746f 723d 2274 6f72 6368   executor="torch
+00010720: 2229 3a0a 2320 2020 2020 2222 2243 6f6d  "):.#     """Com
+00010730: 7075 7465 7320 7468 6520 4a61 636f 6269  putes the Jacobi
+00010740: 616e 2d76 6563 746f 7220 7072 6f64 7563  an-vector produc
+00010750: 7420 6f66 2061 2054 6875 6e64 6572 2066  t of a Thunder f
+00010760: 756e 6374 696f 6e2e 0a0a 2320 2020 2020  unction...#     
+00010770: 4172 6773 3a0a 2320 2020 2020 2020 2020  Args:.#         
+00010780: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
+00010790: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
+000107a0: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
+000107b0: 6f72 6d65 642e 0a23 2020 2020 2020 2020  ormed..#        
+000107c0: 2070 7269 6d61 6c73 2028 5f74 7970 655f   primals (_type_
+000107d0: 293a 2050 7269 6d61 6c73 206f 6620 7468  ): Primals of th
+000107e0: 6520 6675 6e63 7469 6f6e 2e0a 2320 2020  e function..#   
+000107f0: 2020 2020 2020 7461 6e67 656e 7473 2028        tangents (
+00010800: 5f74 7970 655f 293a 2054 616e 6765 6e74  _type_): Tangent
+00010810: 7320 6f66 2074 6865 2066 756e 6374 696f  s of the functio
+00010820: 6e2e 0a23 2020 2020 2020 2020 2065 7865  n..#         exe
+00010830: 6375 746f 7220 2873 7472 2c20 6f70 7469  cutor (str, opti
+00010840: 6f6e 616c 293a 2045 7865 6375 746f 7220  onal): Executor 
+00010850: 746f 2075 7365 2e20 4465 6661 756c 7473  to use. Defaults
+00010860: 2074 6f20 2274 6f72 6368 222e 0a0a 2320   to "torch"...# 
+00010870: 2020 2020 5265 7475 726e 733a 0a23 2020      Returns:.#  
+00010880: 2020 2020 2020 2054 6865 2072 6573 756c         The resul
+00010890: 7420 6f66 2074 6865 204a 6163 6f62 6961  t of the Jacobia
+000108a0: 6e2d 7665 6374 6f72 2070 726f 6475 6374  n-vector product
+000108b0: 2e0a 2320 2020 2020 2222 220a 2320 2020  ..#     """.#   
+000108c0: 2020 7472 6163 6520 3d20 6d61 6b65 5f74    trace = make_t
+000108d0: 7261 6365 2866 756e 632c 2065 7865 6375  race(func, execu
+000108e0: 746f 723d 6578 6563 7574 6f72 2c20 2a70  tor=executor, *p
+000108f0: 7269 6d61 6c73 290a 0a23 2020 2020 2064  rimals)..#     d
+00010900: 6566 206a 7670 5f66 756e 6328 2a70 7269  ef jvp_func(*pri
+00010910: 6d61 6c73 5f61 6e64 5f74 616e 6765 6e74  mals_and_tangent
+00010920: 7329 3a0a 2320 2020 2020 2020 2020 5f70  s):.#         _p
+00010930: 7269 6d61 6c73 2c20 5f74 616e 6765 6e74  rimals, _tangent
+00010940: 7320 3d20 7072 696d 616c 735f 616e 645f  s = primals_and_
+00010950: 7461 6e67 656e 7473 5b3a 206c 656e 2870  tangents[: len(p
+00010960: 7269 6d61 6c73 295d 2c20 7072 696d 616c  rimals)], primal
+00010970: 735f 616e 645f 7461 6e67 656e 7473 5b6c  s_and_tangents[l
+00010980: 656e 2870 7269 6d61 6c73 2920 3a5d 0a23  en(primals) :].#
+00010990: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000109a0: 5f6a 7670 5f63 616c 6c5f 6d65 7461 6675  _jvp_call_metafu
+000109b0: 6e63 285f 7072 696d 616c 732c 205f 7461  nc(_primals, _ta
+000109c0: 6e67 656e 7473 2c20 7472 6163 652c 2064  ngents, trace, d
+000109d0: 6574 6163 6865 643d 4661 6c73 6529 0a0a  etached=False)..
+000109e0: 2320 2020 2020 6a76 705f 7472 6163 6520  #     jvp_trace 
+000109f0: 3d20 6d61 6b65 5f74 7261 6365 286a 7670  = make_trace(jvp
+00010a00: 5f66 756e 632c 2065 7865 6375 746f 723d  _func, executor=
+00010a10: 6578 6563 7574 6f72 2928 2a70 7269 6d61  executor)(*prima
+00010a20: 6c73 2c20 2a74 616e 6765 6e74 7329 0a23  ls, *tangents).#
+00010a30: 2020 2020 206a 7670 5f74 7261 6365 6420       jvp_traced 
+00010a40: 3d20 6d61 6b65 5f74 7261 6365 6428 7061  = make_traced(pa
+00010a50: 7274 6961 6c28 6576 616c 5f74 7261 6365  rtial(eval_trace
+00010a60: 2c20 6a76 705f 7472 6163 6529 2c20 6578  , jvp_trace), ex
+00010a70: 6563 7574 6f72 3d65 7865 6375 746f 7229  ecutor=executor)
+00010a80: 0a23 2020 2020 2072 6574 7572 6e20 6a76  .#     return jv
+00010a90: 705f 7472 6163 6564 282a 7072 696d 616c  p_traced(*primal
+00010aa0: 732c 202a 7461 6e67 656e 7473 290a 0a0a  s, *tangents)...
+00010ab0: 2320 564a 5020 7472 616e 7366 6f72 6d0a  # VJP transform.
+00010ac0: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  # =============.
+00010ad0: 4064 6174 6163 6c61 7373 2866 726f 7a65  @dataclass(froze
+00010ae0: 6e3d 5472 7565 290a 636c 6173 7320 564a  n=True).class VJ
+00010af0: 5044 7561 6c3a 0a20 2020 2022 2222 4120  PDual:.    """A 
+00010b00: 7061 6972 206f 6620 7072 696d 616c 2061  pair of primal a
+00010b10: 6e64 2073 6176 6564 2069 6e66 6f72 6d61  nd saved informa
+00010b20: 7469 6f6e 2066 6f72 2062 6163 6b77 6172  tion for backwar
+00010b30: 6420 2872 6573 6964 7561 6c73 292e 0a0a  d (residuals)...
+00010b40: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00010b50: 2020 7072 696d 616c 2028 556e 696f 6e5b    primal (Union[
+00010b60: 5072 6f78 792c 204e 756d 6265 725d 293a  Proxy, Number]):
+00010b70: 2050 7269 6d61 6c20 7661 6c75 652c 2069   Primal value, i
+00010b80: 2e65 2e2c 2074 6865 2076 616c 7565 2062  .e., the value b
+00010b90: 6569 6e67 2064 6966 6665 7265 6e74 6961  eing differentia
+00010ba0: 7465 642e 0a20 2020 2020 2020 2072 6573  ted..        res
+00010bb0: 6964 7561 6c73 2028 5475 706c 655b 5072  iduals (Tuple[Pr
+00010bc0: 6f78 792c 202e 2e2e 5d29 3a20 5265 7369  oxy, ...]): Resi
+00010bd0: 6475 616c 732c 2069 2e65 2e2c 2074 6865  duals, i.e., the
+00010be0: 2076 616c 7565 7320 7468 6174 2061 7265   values that are
+00010bf0: 0a20 2020 2020 2020 2020 2020 2073 6176  .            sav
+00010c00: 6564 2066 6f72 2074 6865 2062 6163 6b77  ed for the backw
+00010c10: 6172 642e 0a0a 2020 2020 5969 656c 6473  ard...    Yields
+00010c20: 3a0a 2020 2020 2020 2020 5475 706c 655b  :.        Tuple[
+00010c30: 5661 7269 6162 6c65 2c20 5475 706c 655b  Variable, Tuple[
+00010c40: 5661 7269 6162 6c65 2c20 2e2e 2e5d 2c20  Variable, ...], 
+00010c50: 4361 6c6c 6162 6c65 5d3a 2050 7269 6d61  Callable]: Prima
+00010c60: 6c20 616e 6420 7265 7369 6475 616c 730a  l and residuals.
+00010c70: 2020 2020 2222 220a 0a20 2020 2070 7269      """..    pri
+00010c80: 6d61 6c3a 2050 726f 7879 207c 204e 756d  mal: Proxy | Num
+00010c90: 6265 720a 2020 2020 7265 7369 6475 616c  ber.    residual
+00010ca0: 733a 2074 7570 6c65 5b50 726f 7879 2c20  s: tuple[Proxy, 
+00010cb0: 2e2e 2e5d 0a0a 2020 2020 6465 6620 5f5f  ...]..    def __
+00010cc0: 6974 6572 5f5f 2873 656c 6629 3a0a 2020  iter__(self):.  
+00010cd0: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
+00010ce0: 2e70 7269 6d61 6c0a 2020 2020 2020 2020  .primal.        
+00010cf0: 7969 656c 6420 7365 6c66 2e72 6573 6964  yield self.resid
+00010d00: 7561 6c73 0a0a 0a63 6c61 7373 204e 6f50  uals...class NoP
+00010d10: 756c 6c62 6163 6b3a 0a20 2020 2022 2222  ullback:.    """
+00010d20: 4120 6475 6d6d 7920 7075 6c6c 6261 636b  A dummy pullback
+00010d30: 2066 756e 6374 696f 6e20 7468 6174 2072   function that r
+00010d40: 6574 7572 6e73 204e 6f6e 6520 6f72 2072  eturns None or r
+00010d50: 6169 7365 7320 616e 2065 7272 6f72 2e22  aises an error."
+00010d60: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+00010d70: 6974 5f5f 2873 656c 662c 206e 756d 5f61  it__(self, num_a
+00010d80: 7267 733d 3029 3a0a 2020 2020 2020 2020  rgs=0):.        
+00010d90: 7365 6c66 2e6e 756d 5f61 7267 7320 3d20  self.num_args = 
+00010da0: 6e75 6d5f 6172 6773 0a0a 2020 2020 6465  num_args..    de
+00010db0: 6620 5f5f 6361 6c6c 5f5f 2873 656c 662c  f __call__(self,
+00010dc0: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00010dd0: 293a 0a20 2020 2020 2020 2069 6620 7365  ):.        if se
+00010de0: 6c66 2e6e 756d 5f61 7267 7320 3e20 303a  lf.num_args > 0:
+00010df0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00010e00: 7572 6e20 284e 6f6e 652c 2920 2a20 7365  urn (None,) * se
+00010e10: 6c66 2e6e 756d 5f61 7267 730a 2020 2020  lf.num_args.    
+00010e20: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00010e30: 6545 7272 6f72 2822 5075 6c6c 6261 636b  eError("Pullback
+00010e40: 2063 616c 6c65 6420 6f6e 2061 206e 6f6e   called on a non
+00010e50: 2d64 6966 6665 7265 6e74 6961 626c 6520  -differentiable 
+00010e60: 7379 6d62 6f6c 206f 7220 6120 636f 6e73  symbol or a cons
+00010e70: 7461 6e74 2e22 290a 0a0a 636c 6173 7320  tant.")...class 
+00010e80: 5a65 726f 4261 636b 7761 7264 3a0a 2020  ZeroBackward:.  
+00010e90: 2020 2222 2241 2068 656c 7065 7220 6261    """A helper ba
+00010ea0: 636b 7761 7264 2066 756e 6374 696f 6e20  ckward function 
+00010eb0: 7468 6174 2072 6574 7572 6e73 207a 6572  that returns zer
+00010ec0: 6f73 2e22 2222 0a0a 2020 2020 6465 6620  os."""..    def 
+00010ed0: 5f5f 696e 6974 5f5f 2873 656c 662c 206e  __init__(self, n
+00010ee0: 756d 5f61 7267 7329 3a0a 2020 2020 2020  um_args):.      
+00010ef0: 2020 7365 6c66 2e6e 756d 5f61 7267 7320    self.num_args 
+00010f00: 3d20 6e75 6d5f 6172 6773 0a0a 2020 2020  = num_args..    
+00010f10: 6465 6620 5f5f 6361 6c6c 5f5f 2873 656c  def __call__(sel
+00010f20: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
+00010f30: 6773 293a 0a20 2020 2020 2020 2023 2041  gs):.        # A
+00010f40: 7373 756d 696e 6720 7468 6174 2074 6865  ssuming that the
+00010f50: 2066 6972 7374 2061 7267 756d 656e 7473   first arguments
+00010f60: 2061 7265 2074 6865 2066 6f72 7761 7264   are the forward
+00010f70: 2061 7267 756d 656e 7473 0a20 2020 2020   arguments.     
+00010f80: 2020 2066 6f72 7761 7264 5f61 7267 7320     forward_args 
+00010f90: 3d20 6172 6773 5b3a 2073 656c 662e 6e75  = args[: self.nu
+00010fa0: 6d5f 6172 6773 5d0a 0a20 2020 2020 2020  m_args]..       
+00010fb0: 2064 6566 207a 6572 6f73 5f6c 696b 6528   def zeros_like(
+00010fc0: 7829 3a0a 2020 2020 2020 2020 2020 2020  x):.            
+00010fd0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+00010fe0: 2054 656e 736f 7250 726f 7879 293a 0a20   TensorProxy):. 
+00010ff0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011000: 6574 7572 6e20 6675 6c6c 5f6c 696b 6528  eturn full_like(
+00011010: 782c 2066 696c 6c5f 7661 6c75 653d 3029  x, fill_value=0)
+00011020: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00011030: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+00011040: 4e75 6d62 6572 5072 6f78 7929 3a0a 2020  NumberProxy):.  
+00011050: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00011060: 7475 726e 2074 7970 6528 782e 7661 6c75  turn type(x.valu
+00011070: 6529 2830 290a 2020 2020 2020 2020 2020  e)(0).          
+00011080: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00011090: 6528 782c 204e 756d 6265 7229 3a0a 2020  e(x, Number):.  
+000110a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000110b0: 7475 726e 2074 7970 6528 7829 2830 290a  turn type(x)(0).
+000110c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000110d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000110e0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000110f0: 6f72 2866 227a 6572 6f73 5f6c 696b 6520  or(f"zeros_like 
+00011100: 696e 7369 6465 205a 6572 6f42 6163 6b77  inside ZeroBackw
+00011110: 6172 6420 676f 7420 616e 2075 6e73 7570  ard got an unsup
+00011120: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
+00011130: 6528 7829 7d22 290a 0a20 2020 2020 2020  e(x)}")..       
+00011140: 2072 6574 7572 6e20 7475 706c 6528 7a65   return tuple(ze
+00011150: 726f 735f 6c69 6b65 2861 7267 2920 666f  ros_like(arg) fo
+00011160: 7220 6172 6720 696e 2066 6f72 7761 7264  r arg in forward
+00011170: 5f61 7267 7329 0a0a 0a23 204d 6170 7069  _args)...# Mappi
+00011180: 6e67 2066 726f 6d20 7379 6d62 6f6c 7320  ng from symbols 
+00011190: 746f 2061 7567 6d65 6e74 6564 2070 7269  to augmented pri
+000111a0: 6d61 6c20 2866 6f72 7761 7264 2920 6675  mal (forward) fu
+000111b0: 6e63 7469 6f6e 7320 7573 6564 2069 6e20  nctions used in 
+000111c0: 564a 500a 2320 5468 6520 6175 676d 656e  VJP.# The augmen
+000111d0: 7465 645f 7072 696d 616c 2066 756e 6374  ted_primal funct
+000111e0: 696f 6e20 7461 6b65 7320 7468 6520 7072  ion takes the pr
+000111f0: 696d 616c 2076 616c 7565 7320 616e 6420  imal values and 
+00011200: 7265 7475 726e 7320 7468 6520 7072 696d  returns the prim
+00011210: 616c 0a23 2072 6573 756c 7420 616e 6420  al.# result and 
+00011220: 7468 6520 7265 7369 6475 616c 7320 2873  the residuals (s
+00011230: 6176 6564 2076 616c 7565 7320 666f 7220  aved values for 
+00011240: 7468 6520 6261 636b 7761 7264 292e 0a61  the backward)..a
+00011250: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00011260: 5f69 6d70 6c73 203d 207b 0a20 2020 2070  _impls = {.    p
+00011270: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
+00011280: 533a 206c 616d 6264 6120 783a 2028 7072  S: lambda x: (pr
+00011290: 696d 732e 6163 6f73 2878 292c 2028 782c  ims.acos(x), (x,
+000112a0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000112b0: 696d 4944 732e 4143 4f53 483a 206c 616d  imIDs.ACOSH: lam
+000112c0: 6264 6120 783a 2028 7072 696d 732e 6163  bda x: (prims.ac
+000112d0: 6f73 6828 7829 2c20 2878 2c29 292c 0a20  osh(x), (x,)),. 
+000112e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000112f0: 2e41 5349 4e3a 206c 616d 6264 6120 783a  .ASIN: lambda x:
+00011300: 2028 7072 696d 732e 6173 696e 2878 292c   (prims.asin(x),
+00011310: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00011320: 732e 5072 696d 4944 732e 4153 494e 483a  s.PrimIDs.ASINH:
+00011330: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00011340: 732e 6173 696e 6828 7829 2c20 2878 2c29  s.asinh(x), (x,)
+00011350: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00011360: 6d49 4473 2e41 5441 4e3a 206c 616d 6264  mIDs.ATAN: lambd
+00011370: 6120 783a 2028 7072 696d 732e 6174 616e  a x: (prims.atan
+00011380: 2878 292c 2028 782c 2929 2c0a 2020 2020  (x), (x,)),.    
+00011390: 7072 696d 732e 5072 696d 4944 732e 4154  prims.PrimIDs.AT
+000113a0: 414e 483a 206c 616d 6264 6120 783a 2028  ANH: lambda x: (
+000113b0: 7072 696d 732e 6174 616e 6828 7829 2c20  prims.atanh(x), 
+000113c0: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
+000113d0: 2e50 7269 6d49 4473 2e41 5441 4e32 3a20  .PrimIDs.ATAN2: 
+000113e0: 6c61 6d62 6461 2078 2c20 793a 2028 7072  lambda x, y: (pr
+000113f0: 696d 732e 6174 616e 3228 782c 2079 292c  ims.atan2(x, y),
+00011400: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
+00011410: 696d 732e 5072 696d 4944 732e 434f 5348  ims.PrimIDs.COSH
+00011420: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00011430: 6d73 2e63 6f73 6828 7829 2c20 2878 2c29  ms.cosh(x), (x,)
+00011440: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00011450: 6d49 4473 2e44 4947 414d 4d41 3a20 6c61  mIDs.DIGAMMA: la
+00011460: 6d62 6461 2078 3a20 2870 7269 6d73 2e64  mbda x: (prims.d
+00011470: 6967 616d 6d61 2878 292c 2028 782c 2929  igamma(x), (x,))
+00011480: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00011490: 4944 732e 4552 4643 3a20 6c61 6d62 6461  IDs.ERFC: lambda
+000114a0: 2078 3a20 2870 7269 6d73 2e65 7266 6328   x: (prims.erfc(
+000114b0: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
+000114c0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+000114d0: 494e 563a 206c 616d 6264 6120 783a 2028  INV: lambda x: (
+000114e0: 7072 696d 732e 6572 6669 6e76 2878 292c  prims.erfinv(x),
+000114f0: 2028 7072 696d 732e 6572 6669 6e76 2878   (prims.erfinv(x
+00011500: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
+00011510: 5072 696d 4944 732e 4552 4643 494e 563a  PrimIDs.ERFCINV:
+00011520: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00011530: 732e 6572 6663 696e 7628 7829 2c20 2870  s.erfcinv(x), (p
+00011540: 7269 6d73 2e65 7266 6369 6e76 2878 292c  rims.erfcinv(x),
+00011550: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00011560: 696d 4944 732e 4558 5032 3a20 6c61 6d62  imIDs.EXP2: lamb
+00011570: 6461 2078 3a20 2870 7269 6d73 2e65 7870  da x: (prims.exp
+00011580: 3228 7829 2c20 2870 7269 6d73 2e65 7870  2(x), (prims.exp
+00011590: 3228 7829 2c29 292c 0a20 2020 2070 7269  2(x),)),.    pri
+000115a0: 6d73 2e50 7269 6d49 4473 2e45 5850 4d31  ms.PrimIDs.EXPM1
+000115b0: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+000115c0: 6d73 2e65 7870 6d31 2878 292c 2028 7072  ms.expm1(x), (pr
+000115d0: 696d 732e 6578 706d 3128 7829 2c29 292c  ims.expm1(x),)),
+000115e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000115f0: 4473 2e4c 4741 4d4d 413a 206c 616d 6264  Ds.LGAMMA: lambd
+00011600: 6120 783a 2028 7072 696d 732e 6c67 616d  a x: (prims.lgam
+00011610: 6d61 2878 292c 2028 782c 2929 2c0a 2020  ma(x), (x,)),.  
+00011620: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00011630: 4e44 5452 493a 206c 616d 6264 6120 783a  NDTRI: lambda x:
+00011640: 2028 7072 696d 732e 6e64 7472 6928 7829   (prims.ndtri(x)
+00011650: 2c20 2870 7269 6d73 2e6e 6474 7269 2878  , (prims.ndtri(x
+00011660: 292c 2929 2c0a 2020 2020 7072 696d 732e  ),)),.    prims.
+00011670: 5072 696d 4944 732e 5349 4e48 3a20 6c61  PrimIDs.SINH: la
+00011680: 6d62 6461 2078 3a20 2870 7269 6d73 2e73  mbda x: (prims.s
+00011690: 696e 6828 7829 2c20 2878 2c29 292c 0a20  inh(x), (x,)),. 
+000116a0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000116b0: 2e53 5152 543a 206c 616d 6264 6120 783a  .SQRT: lambda x:
+000116c0: 2028 7072 696d 732e 7371 7274 2878 292c   (prims.sqrt(x),
+000116d0: 2028 7072 696d 732e 7371 7274 2878 292c   (prims.sqrt(x),
+000116e0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000116f0: 696d 4944 732e 4c4f 4731 303a 206c 616d  imIDs.LOG10: lam
+00011700: 6264 6120 783a 2028 7072 696d 732e 6c6f  bda x: (prims.lo
+00011710: 6731 3028 7829 2c20 2878 2c29 292c 0a20  g10(x), (x,)),. 
+00011720: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00011730: 2e4c 4f47 3150 3a20 6c61 6d62 6461 2078  .LOG1P: lambda x
+00011740: 3a20 2870 7269 6d73 2e6c 6f67 3170 2878  : (prims.log1p(x
+00011750: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+00011760: 696d 732e 5072 696d 4944 732e 4c4f 4732  ims.PrimIDs.LOG2
+00011770: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00011780: 6d73 2e6c 6f67 3228 7829 2c20 2878 2c29  ms.log2(x), (x,)
+00011790: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+000117a0: 6d49 4473 2e5a 4554 413a 206c 616d 6264  mIDs.ZETA: lambd
+000117b0: 6120 782c 2079 3a20 2870 7269 6d73 2e7a  a x, y: (prims.z
+000117c0: 6574 6128 782c 2079 292c 2028 782c 2079  eta(x, y), (x, y
+000117d0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+000117e0: 696d 4944 732e 464d 4f44 3a20 6c61 6d62  imIDs.FMOD: lamb
+000117f0: 6461 2078 2c20 793a 2028 7072 696d 732e  da x, y: (prims.
+00011800: 666d 6f64 2878 2c20 7929 2c20 2878 2c20  fmod(x, y), (x, 
+00011810: 7929 292c 0a20 2020 2070 7269 6d73 2e50  y)),.    prims.P
+00011820: 7269 6d49 4473 2e43 4f50 595f 3a20 6c61  rimIDs.COPY_: la
+00011830: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
+00011840: 732e 636f 7079 5f28 782c 2079 292c 2074  s.copy_(x, y), t
+00011850: 7570 6c65 2829 292c 0a7d 0a0a 0a23 204d  uple()),.}...# M
+00011860: 6170 7069 6e67 2066 726f 6d20 7379 6d62  apping from symb
+00011870: 6f6c 7320 746f 2062 6163 6b77 6172 6420  ols to backward 
+00011880: 6675 6e63 7469 6f6e 7320 7573 6564 2069  functions used i
+00011890: 6e20 564a 500a 2320 5468 6520 6261 636b  n VJP.# The back
+000118a0: 7761 7264 2066 756e 6374 696f 6e20 7461  ward function ta
+000118b0: 6b65 7320 7468 6520 7265 7369 6475 616c  kes the residual
+000118c0: 7320 616e 6420 636f 7461 6e67 656e 7473  s and cotangents
+000118d0: 2061 6e64 2072 6574 7572 6e73 2074 6865   and returns the
+000118e0: 0a23 2076 6563 746f 722d 4a61 636f 6269  .# vector-Jacobi
+000118f0: 616e 2070 726f 6475 6374 7320 666f 7220  an products for 
+00011900: 6561 6368 2061 7267 756d 656e 742e 0a62  each argument..b
+00011910: 6163 6b77 6172 645f 696d 706c 7320 3d20  ackward_impls = 
+00011920: 7b0a 2020 2020 7072 696d 732e 5072 696d  {.    prims.Prim
+00011930: 4944 732e 4143 4f53 3a20 6c61 6d62 6461  IDs.ACOS: lambda
+00011940: 2078 2c20 673a 202d 6720 2f20 7072 696d   x, g: -g / prim
+00011950: 732e 7371 7274 2831 2e30 202d 2078 202a  s.sqrt(1.0 - x *
+00011960: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
+00011970: 7269 6d49 4473 2e41 434f 5348 3a20 6c61  rimIDs.ACOSH: la
+00011980: 6d62 6461 2078 2c20 673a 2067 202a 2070  mbda x, g: g * p
+00011990: 7269 6d73 2e72 7371 7274 2878 202a 2078  rims.rsqrt(x * x
+000119a0: 202d 2031 2e30 292c 0a20 2020 2070 7269   - 1.0),.    pri
+000119b0: 6d73 2e50 7269 6d49 4473 2e41 5349 4e3a  ms.PrimIDs.ASIN:
+000119c0: 206c 616d 6264 6120 782c 2067 3a20 6720   lambda x, g: g 
+000119d0: 2f20 7072 696d 732e 7371 7274 2831 2e30  / prims.sqrt(1.0
+000119e0: 202d 2078 202a 2078 292c 0a20 2020 2070   - x * x),.    p
+000119f0: 7269 6d73 2e50 7269 6d49 4473 2e41 5349  rims.PrimIDs.ASI
+00011a00: 4e48 3a20 6c61 6d62 6461 2078 2c20 673a  NH: lambda x, g:
+00011a10: 2067 202a 2070 7269 6d73 2e72 7371 7274   g * prims.rsqrt
+00011a20: 2831 2e30 202b 2078 202a 2078 292c 0a20  (1.0 + x * x),. 
+00011a30: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00011a40: 2e41 5441 4e3a 206c 616d 6264 6120 782c  .ATAN: lambda x,
+00011a50: 2067 3a20 6720 2f20 2831 2e30 202b 2078   g: g / (1.0 + x
+00011a60: 202a 2078 292c 0a20 2020 2070 7269 6d73   * x),.    prims
+00011a70: 2e50 7269 6d49 4473 2e41 5441 4e48 3a20  .PrimIDs.ATANH: 
+00011a80: 6c61 6d62 6461 2078 2c20 673a 2067 202f  lambda x, g: g /
+00011a90: 2028 312e 3020 2d20 7820 2a20 7829 2c0a   (1.0 - x * x),.
+00011aa0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00011ab0: 732e 434f 5348 3a20 6c61 6d62 6461 2078  s.COSH: lambda x
+00011ac0: 2c20 673a 2070 7269 6d73 2e6d 756c 2867  , g: prims.mul(g
+00011ad0: 2c20 7072 696d 732e 7369 6e68 2878 2929  , prims.sinh(x))
+00011ae0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00011af0: 4944 732e 4552 4643 3a20 6c61 6d62 6461  IDs.ERFC: lambda
+00011b00: 2078 2c20 673a 202d 6720 2a20 322e 3020   x, g: -g * 2.0 
+00011b10: 2f20 6d61 7468 2e73 7172 7428 6d61 7468  / math.sqrt(math
+00011b20: 2e70 6929 202a 2070 7269 6d73 2e65 7870  .pi) * prims.exp
+00011b30: 282d 7820 2a20 7829 2c0a 2020 2020 7072  (-x * x),.    pr
+00011b40: 696d 732e 5072 696d 4944 732e 4552 4649  ims.PrimIDs.ERFI
+00011b50: 4e56 3a20 6c61 6d62 6461 2072 6573 756c  NV: lambda resul
+00011b60: 742c 2067 3a20 6720 2a20 302e 3520 2a20  t, g: g * 0.5 * 
+00011b70: 6d61 7468 2e73 7172 7428 6d61 7468 2e70  math.sqrt(math.p
+00011b80: 6929 202a 2070 7269 6d73 2e65 7870 2872  i) * prims.exp(r
+00011b90: 6573 756c 742a 2a32 292c 0a20 2020 2070  esult**2),.    p
+00011ba0: 7269 6d73 2e50 7269 6d49 4473 2e45 5246  rims.PrimIDs.ERF
+00011bb0: 4349 4e56 3a20 6c61 6d62 6461 2072 6573  CINV: lambda res
+00011bc0: 756c 742c 2067 3a20 2d67 202a 2030 2e35  ult, g: -g * 0.5
+00011bd0: 202a 206d 6174 682e 7371 7274 286d 6174   * math.sqrt(mat
+00011be0: 682e 7069 2920 2a20 7072 696d 732e 6578  h.pi) * prims.ex
+00011bf0: 7028 7265 7375 6c74 2a2a 3229 2c0a 2020  p(result**2),.  
+00011c00: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00011c10: 4558 5032 3a20 6c61 6d62 6461 2072 6573  EXP2: lambda res
+00011c20: 756c 742c 2067 3a20 6720 2a20 7265 7375  ult, g: g * resu
+00011c30: 6c74 202a 206d 6174 682e 6c6f 6728 322e  lt * math.log(2.
+00011c40: 3029 2c0a 2020 2020 7072 696d 732e 5072  0),.    prims.Pr
+00011c50: 696d 4944 732e 4558 504d 313a 206c 616d  imIDs.EXPM1: lam
+00011c60: 6264 6120 7265 7375 6c74 2c20 673a 2067  bda result, g: g
+00011c70: 202a 2028 7265 7375 6c74 202b 2031 2e30   * (result + 1.0
+00011c80: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
+00011c90: 6d49 4473 2e4c 4741 4d4d 413a 206c 616d  mIDs.LGAMMA: lam
+00011ca0: 6264 6120 782c 2067 3a20 6720 2a20 7072  bda x, g: g * pr
+00011cb0: 696d 732e 6469 6761 6d6d 6128 7829 2c0a  ims.digamma(x),.
+00011cc0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00011cd0: 732e 4e44 5452 493a 206c 616d 6264 6120  s.NDTRI: lambda 
+00011ce0: 7265 7375 6c74 2c20 673a 2067 202a 2070  result, g: g * p
+00011cf0: 7269 6d73 2e65 7870 2830 2e35 202a 2072  rims.exp(0.5 * r
+00011d00: 6573 756c 742a 2a32 2920 2a20 6d61 7468  esult**2) * math
+00011d10: 2e73 7172 7428 322e 3020 2a20 6d61 7468  .sqrt(2.0 * math
+00011d20: 2e70 6929 2c0a 2020 2020 7072 696d 732e  .pi),.    prims.
+00011d30: 5072 696d 4944 732e 5349 4e48 3a20 6c61  PrimIDs.SINH: la
+00011d40: 6d62 6461 2078 2c20 673a 2070 7269 6d73  mbda x, g: prims
+00011d50: 2e6d 756c 2867 2c20 7072 696d 732e 636f  .mul(g, prims.co
+00011d60: 7368 2878 2929 2c0a 2020 2020 7072 696d  sh(x)),.    prim
+00011d70: 732e 5072 696d 4944 732e 5351 5254 3a20  s.PrimIDs.SQRT: 
+00011d80: 6c61 6d62 6461 2072 6573 756c 742c 2067  lambda result, g
+00011d90: 3a20 6720 2f20 2832 2e30 202a 2072 6573  : g / (2.0 * res
+00011da0: 756c 7429 2c0a 2020 2020 7072 696d 732e  ult),.    prims.
+00011db0: 5072 696d 4944 732e 4c4f 4731 303a 206c  PrimIDs.LOG10: l
+00011dc0: 616d 6264 6120 782c 2067 3a20 6720 2f20  ambda x, g: g / 
+00011dd0: 2878 202a 2032 2e33 3032 3538 3530 3932  (x * 2.302585092
+00011de0: 3939 3430 3436 292c 0a20 2020 2070 7269  994046),.    pri
+00011df0: 6d73 2e50 7269 6d49 4473 2e4c 4f47 3150  ms.PrimIDs.LOG1P
+00011e00: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
+00011e10: 202f 2028 7820 2b20 3129 2c0a 2020 2020   / (x + 1),.    
+00011e20: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
+00011e30: 4732 3a20 6c61 6d62 6461 2078 2c20 673a  G2: lambda x, g:
+00011e40: 2067 202f 2028 7820 2a20 302e 3639 3331   g / (x * 0.6931
+00011e50: 3437 3138 3035 3539 3934 3533 292c 0a20  471805599453),. 
+00011e60: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00011e70: 2e46 4d4f 443a 206c 616d 6264 6120 782c  .FMOD: lambda x,
+00011e80: 2079 2c20 673a 2028 672c 202d 6720 2a20   y, g: (g, -g * 
+00011e90: 7072 696d 732e 7472 756e 6328 7820 2f20  prims.trunc(x / 
+00011ea0: 7929 292c 0a20 2020 2023 2054 6865 2063  y)),.    # The c
+00011eb0: 6f70 7920 7368 6f75 6c64 206e 6f74 2062  opy should not b
+00011ec0: 6520 6469 6666 6572 656e 7469 6162 6c65  e differentiable
+00011ed0: 2e20 5765 2072 6574 7572 6e20 4e6f 6e65  . We return None
+00011ee0: 2074 6f20 656e 6162 6c65 2074 6865 2067   to enable the g
+00011ef0: 656e 6572 6174 696f 6e20 6f66 2074 6865  eneration of the
+00011f00: 2062 6163 6b77 6172 6420 6772 6170 6820   backward graph 
+00011f10: 7468 726f 7567 6820 7468 656d 2e0a 2020  through them..  
+00011f20: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00011f30: 434f 5059 5f3a 206c 616d 6264 6120 673a  COPY_: lambda g:
+00011f40: 2028 4e6f 6e65 2c20 4e6f 6e65 292c 0a7d   (None, None),.}
+00011f50: 0a0a 0a64 6566 2072 6567 6973 7465 725f  ...def register_
+00011f60: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00011f70: 6428 6f70 293a 0a20 2020 2022 2222 4465  d(op):.    """De
+00011f80: 636f 7261 746f 7220 746f 2072 6567 6973  corator to regis
+00011f90: 7465 7220 616e 2061 7567 6d65 6e74 6564  ter an augmented
+00011fa0: 2066 6f72 7761 7264 2069 6d70 6c65 6d65   forward impleme
+00011fb0: 6e74 6174 696f 6e20 666f 7220 6120 7379  ntation for a sy
+00011fc0: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
+00011fd0: 0a20 2020 2020 2020 206f 7020 284f 7073  .        op (Ops
+00011fe0: 293a 2053 796d 626f 6c20 666f 7220 7768  ): Symbol for wh
+00011ff0: 6963 6820 746f 2072 6567 6973 7465 7220  ich to register 
+00012000: 7468 6520 6175 676d 656e 7465 6420 666f  the augmented fo
+00012010: 7277 6172 6420 696d 706c 656d 656e 7461  rward implementa
+00012020: 7469 6f6e 2e0a 0a20 2020 2052 6574 7572  tion...    Retur
+00012030: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+00012040: 6162 6c65 3a20 4465 636f 7261 746f 7220  able: Decorator 
+00012050: 6675 6e63 7469 6f6e 2e0a 2020 2020 2222  function..    ""
+00012060: 220a 0a20 2020 2064 6566 2064 6563 6f72  "..    def decor
+00012070: 6174 6f72 2866 756e 6329 3a0a 2020 2020  ator(func):.    
+00012080: 2020 2020 6175 676d 656e 7465 645f 666f      augmented_fo
+00012090: 7277 6172 645f 696d 706c 735b 6f70 5d20  rward_impls[op] 
+000120a0: 3d20 6675 6e63 0a20 2020 2020 2020 2072  = func.        r
+000120b0: 6574 7572 6e20 6675 6e63 0a0a 2020 2020  eturn func..    
+000120c0: 7265 7475 726e 2064 6563 6f72 6174 6f72  return decorator
+000120d0: 0a0a 0a64 6566 2072 6567 6973 7465 725f  ...def register_
+000120e0: 6261 636b 7761 7264 286f 7029 3a0a 2020  backward(op):.  
+000120f0: 2020 2222 2244 6563 6f72 6174 6f72 2074    """Decorator t
+00012100: 6f20 7265 6769 7374 6572 2061 2062 6163  o register a bac
+00012110: 6b77 6172 6420 696d 706c 656d 656e 7461  kward implementa
+00012120: 7469 6f6e 2066 6f72 2061 2073 796d 626f  tion for a symbo
+00012130: 6c2e 0a0a 2020 2020 4172 6773 3a0a 2020  l...    Args:.  
+00012140: 2020 2020 2020 6f70 2028 4f70 7329 3a20        op (Ops): 
+00012150: 5379 6d62 6f6c 2066 6f72 2077 6869 6368  Symbol for which
+00012160: 2074 6f20 7265 6769 7374 6572 2074 6865   to register the
+00012170: 2062 6163 6b77 6172 6420 696d 706c 656d   backward implem
+00012180: 656e 7461 7469 6f6e 2e0a 0a20 2020 2052  entation...    R
+00012190: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000121a0: 4361 6c6c 6162 6c65 3a20 4465 636f 7261  Callable: Decora
+000121b0: 746f 7220 6675 6e63 7469 6f6e 2e0a 2020  tor function..  
+000121c0: 2020 2222 220a 0a20 2020 2064 6566 2064    """..    def d
+000121d0: 6563 6f72 6174 6f72 2866 756e 6329 3a0a  ecorator(func):.
+000121e0: 2020 2020 2020 2020 6261 636b 7761 7264          backward
+000121f0: 5f69 6d70 6c73 5b6f 705d 203d 2066 756e  _impls[op] = fun
+00012200: 630a 2020 2020 2020 2020 7265 7475 726e  c.        return
+00012210: 2066 756e 630a 0a20 2020 2072 6574 7572   func..    retur
+00012220: 6e20 6465 636f 7261 746f 720a 0a0a 6465  n decorator...de
+00012230: 6620 7265 7374 6f72 655f 7265 6475 6365  f restore_reduce
+00012240: 645f 6469 6d73 2878 2c20 7265 6475 6365  d_dims(x, reduce
+00012250: 645f 6469 6d73 2c20 6f72 6967 696e 616c  d_dims, original
+00012260: 5f73 6861 7065 293a 0a20 2020 2022 2222  _shape):.    """
+00012270: 5265 7374 6f72 6573 2074 6865 2072 6564  Restores the red
+00012280: 7563 6564 2064 696d 656e 7369 6f6e 7320  uced dimensions 
+00012290: 6f66 2061 2074 656e 736f 722e 0a0a 2020  of a tensor...  
+000122a0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000122b0: 7820 2856 6172 6961 626c 6529 3a20 5465  x (Variable): Te
+000122c0: 6e73 6f72 2074 6f20 6265 2072 6573 6861  nsor to be resha
+000122d0: 7065 642e 0a20 2020 2020 2020 2072 6564  ped..        red
+000122e0: 7563 6564 5f64 696d 7320 2854 7570 6c65  uced_dims (Tuple
+000122f0: 5b69 6e74 2c20 2e2e 2e5d 293a 2054 7570  [int, ...]): Tup
+00012300: 6c65 206f 6620 7265 6475 6365 6420 6469  le of reduced di
+00012310: 6d65 6e73 696f 6e73 2e0a 2020 2020 2020  mensions..      
+00012320: 2020 6f72 6967 696e 616c 5f73 6861 7065    original_shape
+00012330: 2028 5475 706c 655b 696e 742c 202e 2e2e   (Tuple[int, ...
+00012340: 5d29 3a20 4f72 6967 696e 616c 2073 6861  ]): Original sha
+00012350: 7065 206f 6620 7468 6520 7465 6e73 6f72  pe of the tensor
+00012360: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+00012370: 2020 2020 2020 2020 5661 7269 6162 6c65          Variable
+00012380: 3a20 5465 6e73 6f72 2077 6974 6820 7468  : Tensor with th
+00012390: 6520 7265 6475 6365 6420 6469 6d65 6e73  e reduced dimens
+000123a0: 696f 6e73 2072 6573 746f 7265 642e 0a20  ions restored.. 
+000123b0: 2020 2022 2222 0a20 2020 2069 6620 6f72     """.    if or
+000123c0: 6967 696e 616c 5f73 6861 7065 203d 3d20  iginal_shape == 
+000123d0: 2829 3a20 2023 2073 6361 6c61 720a 2020  ():  # scalar.  
+000123e0: 2020 2020 2020 7265 7475 726e 2078 0a0a        return x..
+000123f0: 2020 2020 756e 7371 7565 657a 6564 203d      unsqueezed =
+00012400: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
+00012410: 2878 2c20 7265 6475 6365 645f 6469 6d73  (x, reduced_dims
+00012420: 290a 2020 2020 7265 7475 726e 2063 6c61  ).    return cla
+00012430: 6e67 2e65 7870 616e 6428 756e 7371 7565  ng.expand(unsque
+00012440: 657a 6564 2c20 6f72 6967 696e 616c 5f73  ezed, original_s
+00012450: 6861 7065 290a 0a0a 4072 6567 6973 7465  hape)...@registe
+00012460: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00012470: 2e50 7269 6d49 4473 2e5a 4554 4129 0a64  .PrimIDs.ZETA).d
+00012480: 6566 207a 6574 615f 6261 636b 7761 7264  ef zeta_backward
+00012490: 2878 2c20 792c 2067 293a 0a20 2020 2023  (x, y, g):.    #
+000124a0: 2054 6865 2064 6572 6976 6174 6976 6520   The derivative 
+000124b0: 7772 7420 7468 6520 6669 7273 7420 6172  wrt the first ar
+000124c0: 6775 6d65 6e74 2069 7320 6e6f 7420 6578  gument is not ex
+000124d0: 7072 6573 7369 626c 6520 696e 2074 6572  pressible in ter
+000124e0: 6d73 206f 6620 7a65 7461 206f 720a 2020  ms of zeta or.  
+000124f0: 2020 2320 6f74 6865 7220 7370 6563 6961    # other specia
+00012500: 6c20 6675 6e63 7469 6f6e 730a 2020 2020  l functions.    
+00012510: 2320 5468 6572 6566 6f72 652c 2077 6520  # Therefore, we 
+00012520: 636f 6d70 7574 6520 6f6e 6c79 2074 6865  compute only the
+00012530: 2064 6572 6976 6174 6976 6520 7772 7420   derivative wrt 
+00012540: 7468 6520 7365 636f 6e64 2061 7267 756d  the second argum
+00012550: 656e 740a 2020 2020 6779 203d 2067 202a  ent.    gy = g *
+00012560: 202d 7820 2a20 7072 696d 732e 7a65 7461   -x * prims.zeta
+00012570: 2878 202b 2031 2e30 2c20 7929 0a0a 2020  (x + 1.0, y)..  
+00012580: 2020 2320 5265 7475 726e 2061 206d 6170    # Return a map
+00012590: 7070 696e 6720 6672 6f6d 2074 6865 2066  pping from the f
+000125a0: 6f72 7761 7264 2061 7267 756d 656e 7473  orward arguments
+000125b0: 2074 6f20 7468 6520 6772 6164 6965 6e74   to the gradient
+000125c0: 730a 2020 2020 7265 7475 726e 207b 2279  s.    return {"y
+000125d0: 223a 2067 797d 0a0a 0a40 7265 6769 7374  ": gy}...@regist
+000125e0: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+000125f0: 732e 5072 696d 4944 732e 4449 4741 4d4d  s.PrimIDs.DIGAMM
+00012600: 4129 0a64 6566 2064 6967 616d 6d61 5f62  A).def digamma_b
+00012610: 6163 6b77 6172 6428 613a 2050 726f 7879  ackward(a: Proxy
+00012620: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
+00012630: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+00012640: 6f72 7420 706f 6c79 6761 6d6d 610a 0a20  ort polygamma.. 
+00012650: 2020 2072 6574 7572 6e20 6720 2a20 706f     return g * po
+00012660: 6c79 6761 6d6d 6128 312c 2061 290a 0a0a  lygamma(1, a)...
+00012670: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+00012680: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
+00012690: 6368 2e70 6f6c 7967 616d 6d61 2229 0a64  ch.polygamma").d
+000126a0: 6566 2070 6f6c 7967 616d 6d61 5f61 7567  ef polygamma_aug
+000126b0: 5f66 7764 286e 3a20 696e 742c 2061 3a20  _fwd(n: int, a: 
+000126c0: 5072 6f78 7929 3a0a 2020 2020 6672 6f6d  Proxy):.    from
+000126d0: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+000126e0: 6d70 6f72 7420 706f 6c79 6761 6d6d 610a  mport polygamma.
+000126f0: 0a20 2020 2070 7269 6d61 6c20 3d20 706f  .    primal = po
+00012700: 6c79 6761 6d6d 6128 6e2c 2061 290a 2020  lygamma(n, a).  
+00012710: 2020 7265 7369 6475 616c 7320 3d20 286e    residuals = (n
+00012720: 2c20 6129 0a20 2020 2072 6574 7572 6e20  , a).    return 
+00012730: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+00012740: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+00012750: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00012760: 2274 6f72 6368 2e70 6f6c 7967 616d 6d61  "torch.polygamma
+00012770: 2229 0a64 6566 2070 6f6c 7967 616d 6d61  ").def polygamma
+00012780: 5f62 6163 6b77 6172 6428 6e3a 2069 6e74  _backward(n: int
+00012790: 2c20 613a 2050 726f 7879 2c20 6729 3a0a  , a: Proxy, g):.
+000127a0: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
+000127b0: 2e74 6f72 6368 2069 6d70 6f72 7420 706f  .torch import po
+000127c0: 6c79 6761 6d6d 610a 0a20 2020 2072 6574  lygamma..    ret
+000127d0: 7572 6e20 4e6f 6e65 2c20 6720 2a20 706f  urn None, g * po
+000127e0: 6c79 6761 6d6d 6128 6e20 2b20 312c 2061  lygamma(n + 1, a
+000127f0: 290a 0a0a 4072 6567 6973 7465 725f 6261  )...@register_ba
+00012800: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
+00012810: 6d49 4473 2e41 5441 4e32 290a 6465 6620  mIDs.ATAN2).def 
+00012820: 6174 616e 325f 6261 636b 7761 7264 2878  atan2_backward(x
+00012830: 2c20 792c 2067 293a 0a20 2020 2061 6c70  , y, g):.    alp
+00012840: 6861 203d 2031 2e30 202f 2028 7820 2a20  ha = 1.0 / (x * 
+00012850: 7820 2b20 7920 2a20 7929 0a20 2020 2067  x + y * y).    g
+00012860: 7261 645f 7820 3d20 6720 2a20 7920 2a20  rad_x = g * y * 
+00012870: 616c 7068 610a 2020 2020 6772 6164 5f79  alpha.    grad_y
+00012880: 203d 2067 202a 202d 7820 2a20 616c 7068   = g * -x * alph
+00012890: 610a 2020 2020 7265 7475 726e 2067 7261  a.    return gra
+000128a0: 645f 782c 2067 7261 645f 790a 0a0a 4072  d_x, grad_y...@r
+000128b0: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+000128c0: 645f 666f 7277 6172 6428 7072 696d 732e  d_forward(prims.
+000128d0: 5072 696d 4944 732e 5641 5229 0a64 6566  PrimIDs.VAR).def
+000128e0: 2076 6172 5f61 7567 5f66 7764 2861 2c20   var_aug_fwd(a, 
+000128f0: 6469 6d2c 202a 2c20 636f 7272 6563 7469  dim, *, correcti
+00012900: 6f6e 293a 0a20 2020 2076 203d 2070 7269  on):.    v = pri
+00012910: 6d73 2e76 6172 2861 2c20 6469 6d2c 2063  ms.var(a, dim, c
+00012920: 6f72 7265 6374 696f 6e3d 636f 7272 6563  orrection=correc
+00012930: 7469 6f6e 290a 2020 2020 7265 7475 726e  tion).    return
+00012940: 2056 4a50 4475 616c 2828 762c 292c 2028   VJPDual((v,), (
+00012950: 612c 2064 696d 2c20 636f 7272 6563 7469  a, dim, correcti
+00012960: 6f6e 2c20 7629 290a 0a0a 2320 544f 444f  on, v))...# TODO
+00012970: 3a20 6669 7820 6469 7669 7369 6f6e 2062  : fix division b
+00012980: 7920 7a65 726f 2077 6865 6e20 6e5f 656c  y zero when n_el
+00012990: 656d 5f72 6564 7563 6564 203d 3d20 3020  em_reduced == 0 
+000129a0: 6f72 2077 6865 6e20 762e 6e75 6d65 6c20  or when v.numel 
+000129b0: 3d3d 2030 0a23 2062 7920 7265 7475 726e  == 0.# by return
+000129c0: 696e 6720 7a65 726f 735f 6c69 6b65 2861  ing zeros_like(a
+000129d0: 2920 6f72 2073 696d 696c 6172 2e0a 2320  ) or similar..# 
+000129e0: 544f 444f 3a20 6669 7820 6772 6164 2077  TODO: fix grad w
+000129f0: 6865 6e20 636f 7272 6563 7469 6f6e 203e  hen correction >
+00012a00: 206e 5f65 6c65 6d5f 7265 6475 6365 642e   n_elem_reduced.
+00012a10: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+00012a20: 6172 6428 7072 696d 732e 5072 696d 4944  ard(prims.PrimID
+00012a30: 732e 5641 5229 0a64 6566 2076 6172 5f62  s.VAR).def var_b
+00012a40: 6163 6b77 6172 6428 612c 2064 696d 2c20  ackward(a, dim, 
+00012a50: 636f 7272 6563 7469 6f6e 2c20 762c 2067  correction, v, g
+00012a60: 293a 0a20 2020 206e 5f65 6c65 6d5f 7265  ):.    n_elem_re
+00012a70: 6475 6365 6420 3d20 612e 6e75 6d65 6c28  duced = a.numel(
+00012a80: 2920 2f2f 2076 2e6e 756d 656c 2829 2069  ) // v.numel() i
+00012a90: 6620 612e 6e75 6d65 6c28 2920 213d 2030  f a.numel() != 0
+00012aa0: 2065 6c73 6520 310a 2020 2020 6e6f 726d   else 1.    norm
+00012ab0: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
+00012ac0: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
+00012ad0: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
+00012ae0: 2020 2067 203d 2072 6573 746f 7265 5f72     g = restore_r
+00012af0: 6564 7563 6564 5f64 696d 7328 672c 2064  educed_dims(g, d
+00012b00: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
+00012b10: 2069 6620 612e 6474 7970 6520 213d 2076   if a.dtype != v
+00012b20: 2e64 7479 7065 3a0a 2020 2020 2020 2020  .dtype:.        
+00012b30: 6120 3d20 7072 696d 732e 636f 6e76 6572  a = prims.conver
+00012b40: 745f 656c 656d 656e 745f 7479 7065 2861  t_element_type(a
+00012b50: 2c20 762e 6474 7970 6529 0a20 2020 206d  , v.dtype).    m
+00012b60: 6561 6e20 3d20 7072 696d 732e 7375 6d28  ean = prims.sum(
+00012b70: 612c 2064 696d 2920 2f20 6e5f 656c 656d  a, dim) / n_elem
+00012b80: 5f72 6564 7563 6564 0a20 2020 206d 6561  _reduced.    mea
+00012b90: 6e20 3d20 7265 7374 6f72 655f 7265 6475  n = restore_redu
+00012ba0: 6365 645f 6469 6d73 286d 6561 6e2c 2064  ced_dims(mean, d
+00012bb0: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
+00012bc0: 2072 6574 7572 6e20 2832 202a 2067 202a   return (2 * g *
+00012bd0: 2028 6120 2d20 6d65 616e 2929 202f 206e   (a - mean)) / n
+00012be0: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
+00012bf0: 6c61 720a 0a0a 6465 6620 6e5f 656c 656d  lar...def n_elem
+00012c00: 5f72 6564 7563 6564 2861 5f6e 6469 6d2c  _reduced(a_ndim,
+00012c10: 2061 5f73 6861 7065 2c20 6469 6d73 293a   a_shape, dims):
+00012c20: 0a20 2020 2064 696d 7320 3d20 7574 696c  .    dims = util
+00012c30: 732e 6361 6e6f 6e69 6361 6c69 7a65 5f64  s.canonicalize_d
+00012c40: 696d 7328 615f 6e64 696d 2c20 6469 6d73  ims(a_ndim, dims
+00012c50: 290a 2020 2020 7265 6475 6374 696f 6e5f  ).    reduction_
+00012c60: 7369 7a65 203d 2031 0a20 2020 2066 6f72  size = 1.    for
+00012c70: 2069 6478 2c20 7369 7a65 2069 6e20 656e   idx, size in en
+00012c80: 756d 6572 6174 6528 615f 7368 6170 6529  umerate(a_shape)
+00012c90: 3a0a 2020 2020 2020 2020 6966 2069 6478  :.        if idx
+00012ca0: 2069 6e20 6469 6d73 3a0a 2020 2020 2020   in dims:.      
+00012cb0: 2020 2020 2020 7265 6475 6374 696f 6e5f        reduction_
+00012cc0: 7369 7a65 202a 3d20 7369 7a65 0a20 2020  size *= size.   
+00012cd0: 2072 6574 7572 6e20 7265 6475 6374 696f   return reductio
+00012ce0: 6e5f 7369 7a65 0a0a 0a64 6566 206d 6561  n_size...def mea
+00012cf0: 6e5f 6261 636b 7761 7264 2861 5f6e 6469  n_backward(a_ndi
+00012d00: 6d2c 2061 5f73 6861 7065 2c20 6469 6d73  m, a_shape, dims
+00012d10: 2c20 6772 6164 293a 0a20 2020 206d 6561  , grad):.    mea
+00012d20: 6e5f 6c6f 6361 6c5f 6772 6164 203d 2031  n_local_grad = 1
+00012d30: 2e30 202f 206e 5f65 6c65 6d5f 7265 6475  .0 / n_elem_redu
+00012d40: 6365 6428 615f 6e64 696d 2c20 615f 7368  ced(a_ndim, a_sh
+00012d50: 6170 652c 2064 696d 7329 0a20 2020 2072  ape, dims).    r
+00012d60: 6574 7572 6e20 7265 7374 6f72 655f 7265  eturn restore_re
+00012d70: 6475 6365 645f 6469 6d73 2867 7261 642c  duced_dims(grad,
+00012d80: 2064 696d 732c 2061 5f73 6861 7065 2920   dims, a_shape) 
+00012d90: 2a20 6d65 616e 5f6c 6f63 616c 5f67 7261  * mean_local_gra
+00012da0: 640a 0a0a 4072 6567 6973 7465 725f 6175  d...@register_au
+00012db0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+00012dc0: 7072 696d 732e 5072 696d 4944 732e 5041  prims.PrimIDs.PA
+00012dd0: 4429 0a64 6566 2070 6164 5f61 7567 5f66  D).def pad_aug_f
+00012de0: 7764 2861 2c20 7061 6464 696e 675f 7661  wd(a, padding_va
+00012df0: 6c75 652c 2070 6164 6469 6e67 5f63 6f6e  lue, padding_con
+00012e00: 6669 6729 3a0a 2020 2020 7265 7475 726e  fig):.    return
+00012e10: 2056 4a50 4475 616c 2828 7072 696d 732e   VJPDual((prims.
+00012e20: 7061 6428 612c 2070 6164 6469 6e67 5f76  pad(a, padding_v
+00012e30: 616c 7565 2c20 7061 6464 696e 675f 636f  alue, padding_co
+00012e40: 6e66 6967 292c 292c 2028 612c 2070 6164  nfig),), (a, pad
+00012e50: 6469 6e67 5f63 6f6e 6669 6729 290a 0a0a  ding_config))...
+00012e60: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+00012e70: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+00012e80: 2e50 4144 290a 6465 6620 7061 645f 6261  .PAD).def pad_ba
+00012e90: 636b 7761 7264 2861 2c20 7061 6464 696e  ckward(a, paddin
+00012ea0: 675f 636f 6e66 6967 2c20 6729 3a0a 2020  g_config, g):.  
+00012eb0: 2020 2320 5368 6f72 7420 6369 7263 7569    # Short circui
+00012ec0: 7420 6f6e 2065 6d70 7479 2069 6e70 7574  t on empty input
+00012ed0: 2e0a 2020 2020 6966 2061 6e79 2864 696d  ..    if any(dim
+00012ee0: 203d 3d20 3020 666f 7220 6469 6d20 696e   == 0 for dim in
+00012ef0: 2061 2e73 6861 7065 293a 0a20 2020 2020   a.shape):.     
+00012f00: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
+00012f10: 696b 6528 612c 2066 696c 6c5f 7661 6c75  ike(a, fill_valu
+00012f20: 653d 3029 0a0a 2020 2020 2320 556e 2d70  e=0)..    # Un-p
+00012f30: 6164 2062 7920 7061 6464 696e 6720 7769  ad by padding wi
+00012f40: 7468 207a 6572 6f20 7661 6c75 6573 0a20  th zero values. 
+00012f50: 2020 207a 6572 6f5f 7061 6464 696e 675f     zero_padding_
+00012f60: 636f 6e66 6967 203d 205b 282d 6c6f 2c20  config = [(-lo, 
+00012f70: 2d68 692c 2030 2920 666f 7220 6c6f 2c20  -hi, 0) for lo, 
+00012f80: 6869 2c20 5f20 696e 2070 6164 6469 6e67  hi, _ in padding
+00012f90: 5f63 6f6e 6669 675d 0a0a 2020 2020 6720  _config]..    g 
+00012fa0: 3d20 7072 696d 732e 7061 6428 672c 2030  = prims.pad(g, 0
+00012fb0: 2e30 2c20 7a65 726f 5f70 6164 6469 6e67  .0, zero_padding
+00012fc0: 5f63 6f6e 6669 6729 0a0a 2020 2020 2320  _config)..    # 
+00012fd0: 556e 2d73 6c69 6365 2062 7920 736c 6963  Un-slice by slic
+00012fe0: 696e 6720 7769 7468 2061 2073 7472 6964  ing with a strid
+00012ff0: 6520 6f66 2076 616c 7565 2028 6469 6c61  e of value (dila
+00013000: 7469 6f6e 202b 2031 290a 2020 2020 666f  tion + 1).    fo
+00013010: 7220 6469 6d2c 2028 5f2c 205f 2c20 6429  r dim, (_, _, d)
+00013020: 2069 6e20 656e 756d 6572 6174 6528 7061   in enumerate(pa
+00013030: 6464 696e 675f 636f 6e66 6967 293a 0a20  dding_config):. 
+00013040: 2020 2020 2020 2067 203d 2073 6c69 6365         g = slice
+00013050: 5f69 6e5f 6469 6d28 672c 2030 2c20 672e  _in_dim(g, 0, g.
+00013060: 7368 6170 655b 6469 6d5d 2c20 7374 7269  shape[dim], stri
+00013070: 6465 3d64 202b 2031 2c20 6469 6d3d 6469  de=d + 1, dim=di
+00013080: 6d29 0a0a 2020 2020 7265 7475 726e 2067  m)..    return g
+00013090: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+000130a0: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+000130b0: 7269 6d73 2e50 7269 6d49 4473 2e50 524f  rims.PrimIDs.PRO
+000130c0: 4429 0a64 6566 2070 726f 645f 6175 675f  D).def prod_aug_
+000130d0: 6677 6428 782c 2064 696d 7329 3a0a 2020  fwd(x, dims):.  
+000130e0: 2020 2222 2241 7567 6d65 6e74 6564 2070    """Augmented p
+000130f0: 726f 6420 6f70 6572 6174 696f 6e2e 0a0a  rod operation...
+00013100: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00013110: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
+00013120: 5465 6e73 6f72 2074 6f20 6265 206d 756c  Tensor to be mul
+00013130: 7469 706c 6965 642e 0a20 2020 2020 2020  tiplied..       
+00013140: 2064 696d 7320 2854 7570 6c65 5b69 6e74   dims (Tuple[int
+00013150: 2c20 2e2e 2e5d 293a 2044 696d 656e 7369  , ...]): Dimensi
+00013160: 6f6e 7320 746f 2062 6520 6d75 6c74 6970  ons to be multip
+00013170: 6c69 6564 2e0a 0a20 2020 2052 6574 7572  lied...    Retur
+00013180: 6e73 3a0a 2020 2020 2020 2020 564a 5044  ns:.        VJPD
+00013190: 7561 6c3a 2050 7269 6d61 6c20 616e 6420  ual: Primal and 
+000131a0: 7265 7369 6475 616c 732e 0a20 2020 2022  residuals..    "
+000131b0: 2222 0a20 2020 2070 7269 6d61 6c20 3d20  "".    primal = 
+000131c0: 7072 696d 732e 7072 6f64 2878 2c20 6469  prims.prod(x, di
+000131d0: 6d73 290a 0a20 2020 2072 6573 6964 7561  ms)..    residua
+000131e0: 6c73 203d 2028 0a20 2020 2020 2020 2070  ls = (.        p
+000131f0: 7269 6d61 6c2c 0a20 2020 2020 2020 2078  rimal,.        x
+00013200: 2c0a 2020 2020 2020 2020 782e 7368 6170  ,.        x.shap
+00013210: 652c 0a20 2020 2020 2020 2064 696d 732c  e,.        dims,
+00013220: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
+00013230: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+00013240: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
+00013250: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+00013260: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00013270: 5052 4f44 290a 6465 6620 7072 6f64 5f70  PROD).def prod_p
+00013280: 756c 6c62 6163 6b28 7072 696d 616c 2c20  ullback(primal, 
+00013290: 782c 2078 5f73 6861 7065 2c20 7265 6475  x, x_shape, redu
+000132a0: 6365 645f 6469 6d73 2c20 6729 3a0a 2020  ced_dims, g):.  
+000132b0: 2020 7265 7475 726e 2070 7269 6d73 2e64    return prims.d
+000132c0: 6976 2872 6573 746f 7265 5f72 6564 7563  iv(restore_reduc
+000132d0: 6564 5f64 696d 7328 7072 696d 616c 202a  ed_dims(primal *
+000132e0: 2067 2c20 7265 6475 6365 645f 6469 6d73   g, reduced_dims
+000132f0: 2c20 785f 7368 6170 6529 2c20 7829 0a0a  , x_shape), x)..
+00013300: 0a64 6566 206b 6565 7064 696d 5f72 6564  .def keepdim_red
+00013310: 7563 7469 6f6e 2872 6564 7563 7469 6f6e  uction(reduction
+00013320: 5f66 6e2c 2078 2c20 6469 6d73 293a 0a20  _fn, x, dims):. 
+00013330: 2020 2022 2222 4170 706c 6965 7320 7265     """Applies re
+00013340: 6475 6374 696f 6e20 616e 6420 6669 7865  duction and fixe
+00013350: 7320 6f75 7470 7574 2074 6f20 636f 6e66  s output to conf
+00013360: 6f72 6d20 746f 206b 6565 7064 696d 3d54  orm to keepdim=T
+00013370: 7275 6522 2222 0a20 2020 206f 7574 203d  rue""".    out =
+00013380: 2072 6564 7563 7469 6f6e 5f66 6e28 782c   reduction_fn(x,
+00013390: 2064 696d 7329 0a20 2020 2061 7267 6d61   dims).    argma
+000133a0: 785f 7375 6d5f 6f75 745f 7368 6170 6520  x_sum_out_shape 
+000133b0: 3d20 5b78 2e73 6861 7065 5b69 5d20 6966  = [x.shape[i] if
+000133c0: 2069 206e 6f74 2069 6e20 6469 6d73 2065   i not in dims e
+000133d0: 6c73 6520 3120 666f 7220 6920 696e 2072  lse 1 for i in r
+000133e0: 616e 6765 2878 2e6e 6469 6d29 5d0a 2020  ange(x.ndim)].  
+000133f0: 2020 6272 6f61 6463 6173 745f 6469 6d73    broadcast_dims
+00013400: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
+00013410: 616e 6765 2878 2e6e 6469 6d29 2069 6620  ange(x.ndim) if 
+00013420: 6920 6e6f 7420 696e 2064 696d 735d 0a20  i not in dims]. 
+00013430: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+00013440: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
+00013450: 286f 7574 2c20 6172 676d 6178 5f73 756d  (out, argmax_sum
+00013460: 5f6f 7574 5f73 6861 7065 2c20 6272 6f61  _out_shape, broa
+00013470: 6463 6173 745f 6469 6d73 290a 0a0a 2320  dcast_dims)...# 
+00013480: 496e 7370 6972 6564 2066 726f 6d20 6874  Inspired from ht
+00013490: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+000134a0: 2f48 4950 532f 6175 746f 6772 6164 2f62  /HIPS/autograd/b
+000134b0: 6c6f 622f 6d61 7374 6572 2f61 7574 6f67  lob/master/autog
+000134c0: 7261 642f 6e75 6d70 792f 6e75 6d70 795f  rad/numpy/numpy_
+000134d0: 766a 7073 2e70 7923 4c33 3533 0a64 6566  vjps.py#L353.def
+000134e0: 2067 7261 645f 6368 6f6f 7365 725f 6261   grad_chooser_ba
+000134f0: 636b 7761 7264 2870 7269 6d61 6c2c 2078  ckward(primal, x
+00013500: 2c20 785f 7368 6170 652c 2072 6564 7563  , x_shape, reduc
+00013510: 6564 5f64 696d 732c 2067 293a 0a20 2020  ed_dims, g):.   
+00013520: 2022 2222 4275 696c 6473 2067 7261 6469   """Builds gradi
+00013530: 656e 7420 6f66 2066 756e 6374 696f 6e73  ent of functions
+00013540: 2074 6861 7420 6368 6f6f 7365 2061 2073   that choose a s
+00013550: 696e 676c 6520 6974 656d 2c20 7375 6368  ingle item, such
+00013560: 2061 7320 6d69 6e20 6f72 206d 6178 2e22   as min or max."
+00013570: 2222 0a20 2020 2067 5f72 6570 6561 7465  "".    g_repeate
+00013580: 6420 3d20 7265 7374 6f72 655f 7265 6475  d = restore_redu
+00013590: 6365 645f 6469 6d73 2867 2c20 7265 6475  ced_dims(g, redu
+000135a0: 6365 645f 6469 6d73 2c20 785f 7368 6170  ced_dims, x_shap
+000135b0: 6529 0a20 2020 2070 7269 6d61 6c5f 7265  e).    primal_re
+000135c0: 7065 6174 6564 203d 2072 6573 746f 7265  peated = restore
+000135d0: 5f72 6564 7563 6564 5f64 696d 7328 7072  _reduced_dims(pr
+000135e0: 696d 616c 2c20 7265 6475 6365 645f 6469  imal, reduced_di
+000135f0: 6d73 2c20 785f 7368 6170 6529 0a20 2020  ms, x_shape).   
+00013600: 2061 7267 6d61 785f 6c6f 6361 7469 6f6e   argmax_location
+00013610: 7320 3d20 7820 3d3d 2070 7269 6d61 6c5f  s = x == primal_
+00013620: 7265 7065 6174 6564 0a20 2020 2061 7267  repeated.    arg
+00013630: 6d61 785f 7375 6d20 3d20 6b65 6570 6469  max_sum = keepdi
+00013640: 6d5f 7265 6475 6374 696f 6e28 7072 696d  m_reduction(prim
+00013650: 732e 7375 6d2c 2061 7267 6d61 785f 6c6f  s.sum, argmax_lo
+00013660: 6361 7469 6f6e 732c 2072 6564 7563 6564  cations, reduced
+00013670: 5f64 696d 7329 0a20 2020 206f 7574 203d  _dims).    out =
+00013680: 2067 5f72 6570 6561 7465 6420 2a20 6172   g_repeated * ar
+00013690: 676d 6178 5f6c 6f63 6174 696f 6e73 202f  gmax_locations /
+000136a0: 2061 7267 6d61 785f 7375 6d0a 2020 2020   argmax_sum.    
+000136b0: 7265 7475 726e 206f 7574 0a0a 0a72 6567  return out...reg
+000136c0: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+000136d0: 7269 6d73 2e50 7269 6d49 4473 2e41 4d49  rims.PrimIDs.AMI
+000136e0: 4e29 2867 7261 645f 6368 6f6f 7365 725f  N)(grad_chooser_
+000136f0: 6261 636b 7761 7264 290a 0a0a 4072 6567  backward)...@reg
+00013700: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00013710: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00013720: 696d 4944 732e 414d 494e 290a 6465 6620  imIDs.AMIN).def 
+00013730: 616d 696e 5f61 7567 5f66 7764 2878 2c20  amin_aug_fwd(x, 
+00013740: 6469 6d73 293a 0a20 2020 2022 2222 4175  dims):.    """Au
+00013750: 676d 656e 7465 6420 616d 696e 206f 7065  gmented amin ope
+00013760: 7261 7469 6f6e 2e0a 2020 2020 4172 6773  ration..    Args
+00013770: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+00013780: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
+00013790: 6f20 636f 6d70 7574 6520 616d 696e 206f  o compute amin o
+000137a0: 6e2e 0a20 2020 2020 2020 2064 696d 7320  n..        dims 
+000137b0: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
+000137c0: 293a 2044 696d 656e 7369 6f6e 7320 746f  ): Dimensions to
+000137d0: 2063 6f6d 7075 7465 2061 6d69 6e20 6f76   compute amin ov
+000137e0: 6572 2e0a 2020 2020 5265 7475 726e 733a  er..    Returns:
+000137f0: 0a20 2020 2020 2020 2056 4a50 4475 616c  .        VJPDual
+00013800: 3a20 5072 696d 616c 2061 6e64 2072 6573  : Primal and res
+00013810: 6964 7561 6c73 2e0a 2020 2020 2222 220a  iduals..    """.
+00013820: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
+00013830: 6d73 2e61 6d69 6e28 782c 2064 696d 7329  ms.amin(x, dims)
+00013840: 0a0a 2020 2020 7265 7369 6475 616c 7320  ..    residuals 
+00013850: 3d20 280a 2020 2020 2020 2020 7072 696d  = (.        prim
+00013860: 616c 2c0a 2020 2020 2020 2020 782c 0a20  al,.        x,. 
+00013870: 2020 2020 2020 2078 2e73 6861 7065 2c0a         x.shape,.
+00013880: 2020 2020 2020 2020 6469 6d73 2c0a 2020          dims,.  
+00013890: 2020 290a 0a20 2020 2072 6574 7572 6e20    )..    return 
+000138a0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+000138b0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+000138c0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+000138d0: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
+000138e0: 7269 6d49 4473 2e50 4f57 290a 6465 6620  rimIDs.POW).def 
+000138f0: 706f 775f 6175 675f 6665 6428 782c 2079  pow_aug_fed(x, y
+00013900: 293a 0a20 2020 2022 2222 4175 676d 656e  ):.    """Augmen
+00013910: 7465 6420 7468 6520 706f 7720 6f70 6572  ted the pow oper
+00013920: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
+00013930: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+00013940: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
+00013950: 6974 6820 7468 6520 6261 7365 2074 6f20  ith the base to 
+00013960: 6265 2065 7870 6f6e 656e 7469 6174 6564  be exponentiated
+00013970: 2e0a 2020 2020 2020 2020 7920 2856 6172  ..        y (Var
+00013980: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
+00013990: 6974 6820 706f 7765 7220 746f 2072 6169  ith power to rai
+000139a0: 7365 2074 6f2e 0a0a 2020 2020 5265 7475  se to...    Retu
+000139b0: 726e 733a 0a20 2020 2020 2020 2056 4a50  rns:.        VJP
+000139c0: 4475 616c 3a20 5072 696d 616c 2061 6e64  Dual: Primal and
+000139d0: 2072 6573 6964 7561 6c73 2e0a 2020 2020   residuals..    
+000139e0: 2222 220a 2020 2020 7072 696d 616c 203d  """.    primal =
+000139f0: 2070 7269 6d73 2e70 6f77 2878 2c20 7929   prims.pow(x, y)
+00013a00: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+00013a10: 2028 7072 696d 616c 2c20 782c 2079 290a   (primal, x, y).
+00013a20: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00013a30: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00013a40: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00013a50: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00013a60: 2e50 7269 6d49 4473 2e50 4f57 290a 6465  .PrimIDs.POW).de
+00013a70: 6620 706f 775f 6261 636b 7761 7264 2872  f pow_backward(r
+00013a80: 6573 756c 742c 2078 2c20 792c 2067 293a  esult, x, y, g):
+00013a90: 0a20 2020 2069 6d70 6f72 7420 7468 756e  .    import thun
+00013aa0: 6465 722e 636c 616e 6720 6173 2074 6c61  der.clang as tla
+00013ab0: 6e67 0a0a 2020 2020 6772 6573 756c 7420  ng..    gresult 
+00013ac0: 3d20 6720 2a20 7265 7375 6c74 2020 2320  = g * result  # 
+00013ad0: 7265 7573 6520 636f 6d6d 6f6e 2066 6163  reuse common fac
+00013ae0: 746f 720a 2020 2020 6478 203d 2067 202a  tor.    dx = g *
+00013af0: 2079 202a 2078 202a 2a20 2879 202d 2031   y * x ** (y - 1
+00013b00: 290a 2020 2020 6479 203d 2067 7265 7375  ).    dy = gresu
+00013b10: 6c74 202a 2074 6c61 6e67 2e6c 6f67 2878  lt * tlang.log(x
+00013b20: 290a 2020 2020 7265 7475 726e 2064 782c  ).    return dx,
+00013b30: 2064 790a 0a0a 4072 6567 6973 7465 725f   dy...@register_
+00013b40: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00013b50: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00013b60: 5441 4e29 0a64 6566 2074 616e 5f61 7567  TAN).def tan_aug
+00013b70: 5f66 7764 2878 293a 0a20 2020 2022 2222  _fwd(x):.    """
+00013b80: 4175 676d 656e 7465 6420 7461 6e20 6f70  Augmented tan op
+00013b90: 6572 6174 696f 6e2e 0a0a 2020 2020 4172  eration...    Ar
+00013ba0: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
+00013bb0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
+00013bc0: 2074 6f20 6265 2070 6173 7365 6420 746f   to be passed to
+00013bd0: 2074 616e 2e0a 2020 2020 2222 220a 0a20   tan..    """.. 
+00013be0: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
+00013bf0: 732e 7461 6e28 7829 0a20 2020 2072 6573  s.tan(x).    res
+00013c00: 6964 7561 6c73 203d 2028 7072 696d 616c  iduals = (primal
+00013c10: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
+00013c20: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00013c30: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00013c40: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00013c50: 696d 732e 5072 696d 4944 732e 5441 4e29  ims.PrimIDs.TAN)
+00013c60: 0a64 6566 2074 616e 5f62 6163 6b77 6172  .def tan_backwar
+00013c70: 6428 7265 7375 6c74 2c20 6729 3a0a 2020  d(result, g):.  
+00013c80: 2020 7265 7475 726e 2067 202a 2028 3120    return g * (1 
+00013c90: 2b20 7265 7375 6c74 202a 2072 6573 756c  + result * resul
+00013ca0: 7429 0a0a 0a23 204e 4f54 453a 204a 6178  t)...# NOTE: Jax
+00013cb0: 2075 7365 7320 6e70 2e61 7267 736f 7274   uses np.argsort
+00013cc0: 2069 6e20 6974 7320 7472 616e 7370 6f73   in its transpos
+00013cd0: 6520 766a 7020 636f 6d70 7574 6174 696f  e vjp computatio
+00013ce0: 6e0a 6465 6620 5f61 7267 736f 7274 2873  n.def _argsort(s
+00013cf0: 6571 293a 0a20 2020 2072 6574 7572 6e20  eq):.    return 
+00013d00: 736f 7274 6564 2872 616e 6765 286c 656e  sorted(range(len
+00013d10: 2873 6571 2929 2c20 6b65 793d 7365 712e  (seq)), key=seq.
+00013d20: 5f5f 6765 7469 7465 6d5f 5f29 0a0a 0a40  __getitem__)...@
+00013d30: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00013d40: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
+00013d50: 2e50 7269 6d49 4473 2e44 4556 4943 455f  .PrimIDs.DEVICE_
+00013d60: 5055 5429 0a64 6566 2064 6576 6963 655f  PUT).def device_
+00013d70: 7075 745f 6175 675f 6677 6428 613a 2054  put_aug_fwd(a: T
+00013d80: 656e 736f 7250 726f 7879 2c20 6465 7669  ensorProxy, devi
+00013d90: 6365 3a20 4465 7669 6365 2920 2d3e 2054  ce: Device) -> T
+00013da0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00013db0: 7072 696d 616c 203d 2070 7269 6d73 2e64  primal = prims.d
+00013dc0: 6576 6963 655f 7075 7428 612c 2064 6576  evice_put(a, dev
+00013dd0: 6963 6529 0a20 2020 2072 6573 6964 7561  ice).    residua
+00013de0: 6c73 203d 2028 612e 6465 7669 6365 2c29  ls = (a.device,)
+00013df0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+00013e00: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
+00013e10: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
+00013e20: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00013e30: 732e 5072 696d 4944 732e 4445 5649 4345  s.PrimIDs.DEVICE
+00013e40: 5f50 5554 290a 6465 6620 6465 7669 6365  _PUT).def device
+00013e50: 5f70 7574 5f62 6163 6b77 6172 6428 6f72  _put_backward(or
+00013e60: 6967 5f64 6576 6963 652c 2067 293a 0a20  ig_device, g):. 
+00013e70: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+00013e80: 6465 7669 6365 5f70 7574 2867 2c20 6f72  device_put(g, or
+00013e90: 6967 5f64 6576 6963 6529 2c20 4e6f 6e65  ig_device), None
+00013ea0: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+00013eb0: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+00013ec0: 7269 6d73 2e50 7269 6d49 4473 2e43 4f4e  rims.PrimIDs.CON
+00013ed0: 564f 4c55 5449 4f4e 290a 6465 6620 636f  VOLUTION).def co
+00013ee0: 6e76 6f6c 7574 696f 6e5f 6175 675f 6677  nvolution_aug_fw
+00013ef0: 6428 0a20 2020 2061 3a20 5072 6f78 792c  d(.    a: Proxy,
+00013f00: 0a20 2020 2077 6569 6768 742c 0a20 2020  .    weight,.   
+00013f10: 2062 6961 732c 0a20 2020 2073 7472 6964   bias,.    strid
+00013f20: 652c 0a20 2020 2070 6164 6469 6e67 2c0a  e,.    padding,.
+00013f30: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
+00013f40: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
+00013f50: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00013f60: 2c0a 2020 2020 6772 6f75 7073 2c0a 293a  ,.    groups,.):
+00013f70: 0a20 2020 2070 7269 6d61 6c20 3d20 636f  .    primal = co
+00013f80: 6e76 6f6c 7574 696f 6e28 612c 2077 6569  nvolution(a, wei
+00013f90: 6768 742c 2062 6961 732c 2073 7472 6964  ght, bias, strid
+00013fa0: 652c 2070 6164 6469 6e67 2c20 6469 6c61  e, padding, dila
+00013fb0: 7469 6f6e 2c20 7472 616e 7370 6f73 6564  tion, transposed
+00013fc0: 2c20 6f75 7470 7574 5f70 6164 6469 6e67  , output_padding
+00013fd0: 2c20 6772 6f75 7073 290a 2020 2020 7265  , groups).    re
+00013fe0: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
+00013ff0: 6c2c 2061 2c20 7765 6967 6874 2c20 6269  l, a, weight, bi
+00014000: 6173 2c20 7374 7269 6465 2c20 7061 6464  as, stride, padd
+00014010: 696e 672c 2064 696c 6174 696f 6e2c 2074  ing, dilation, t
+00014020: 7261 6e73 706f 7365 642c 206f 7574 7075  ransposed, outpu
+00014030: 745f 7061 6464 696e 672c 2067 726f 7570  t_padding, group
+00014040: 7329 0a20 2020 2072 6574 7572 6e20 564a  s).    return VJ
+00014050: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00014060: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00014070: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00014080: 696d 732e 5072 696d 4944 732e 434f 4e56  ims.PrimIDs.CONV
+00014090: 4f4c 5554 494f 4e29 0a64 6566 2063 6f6e  OLUTION).def con
+000140a0: 766f 6c75 7469 6f6e 5f62 6163 6b77 6172  volution_backwar
+000140b0: 6428 0a20 2020 206f 7574 7075 743a 2050  d(.    output: P
+000140c0: 726f 7879 2c0a 2020 2020 696e 7075 743a  roxy,.    input:
+000140d0: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
+000140e0: 6874 2c0a 2020 2020 6269 6173 2c0a 2020  ht,.    bias,.  
+000140f0: 2020 7374 7269 6465 2c0a 2020 2020 7061    stride,.    pa
+00014100: 6464 696e 672c 0a20 2020 2064 696c 6174  dding,.    dilat
+00014110: 696f 6e2c 0a20 2020 2074 7261 6e73 706f  ion,.    transpo
+00014120: 7365 642c 0a20 2020 206f 7574 7075 745f  sed,.    output_
+00014130: 7061 6464 696e 672c 0a20 2020 2067 726f  padding,.    gro
+00014140: 7570 732c 0a20 2020 2067 7261 642c 0a29  ups,.    grad,.)
+00014150: 3a0a 2020 2020 2320 5472 616e 7370 6f73  :.    # Transpos
+00014160: 6564 2063 6f6e 766f 6c75 7469 6f6e 2069  ed convolution i
+00014170: 7320 6e6f 7420 7375 7070 6f72 7465 6421  s not supported!
+00014180: 0a20 2020 2061 7373 6572 7420 7472 616e  .    assert tran
+00014190: 7370 6f73 6564 203d 3d20 300a 0a20 2020  sposed == 0..   
+000141a0: 2069 6e70 7574 5f67 7261 6420 3d20 4e6f   input_grad = No
+000141b0: 6e65 0a20 2020 2077 6569 6768 745f 6772  ne.    weight_gr
+000141c0: 6164 203d 204e 6f6e 650a 2020 2020 6269  ad = None.    bi
+000141d0: 6173 5f67 7261 6420 3d20 4e6f 6e65 0a0a  as_grad = None..
+000141e0: 2020 2020 2320 5368 6f72 7420 6369 7263      # Short circ
+000141f0: 7569 7420 6f6e 207a 6572 6f2d 6469 6d20  uit on zero-dim 
+00014200: 6772 6164 0a20 2020 2069 6620 616e 7928  grad.    if any(
+00014210: 7320 3d3d 2030 2066 6f72 2073 2069 6e20  s == 0 for s in 
+00014220: 6772 6164 2e73 6861 7065 293a 0a20 2020  grad.shape):.   
+00014230: 2020 2020 2069 6e70 7574 5f67 7261 6420       input_grad 
+00014240: 3d20 6675 6c6c 5f6c 696b 6528 696e 7075  = full_like(inpu
+00014250: 742c 2066 696c 6c5f 7661 6c75 653d 3029  t, fill_value=0)
+00014260: 0a20 2020 2020 2020 2077 6569 6768 745f  .        weight_
+00014270: 6772 6164 203d 2066 756c 6c5f 6c69 6b65  grad = full_like
+00014280: 2877 6569 6768 742c 2066 696c 6c5f 7661  (weight, fill_va
+00014290: 6c75 653d 3029 0a20 2020 2020 2020 2069  lue=0).        i
+000142a0: 6620 6269 6173 2069 7320 6e6f 7420 4e6f  f bias is not No
+000142b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000142c0: 6269 6173 5f67 7261 6420 3d20 6675 6c6c  bias_grad = full
+000142d0: 5f6c 696b 6528 6269 6173 2c20 6669 6c6c  _like(bias, fill
+000142e0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+000142f0: 2020 7265 7475 726e 2028 696e 7075 745f    return (input_
+00014300: 6772 6164 2c20 7765 6967 6874 5f67 7261  grad, weight_gra
+00014310: 642c 2062 6961 735f 6772 6164 2920 2b20  d, bias_grad) + 
+00014320: 2828 4e6f 6e65 2c29 202a 2036 290a 0a20  ((None,) * 6).. 
+00014330: 2020 2062 6174 6368 2c20 696e 5f63 6861     batch, in_cha
+00014340: 6e6e 656c 732c 202a 7370 6174 6961 6c5f  nnels, *spatial_
+00014350: 6469 6d73 203d 2069 6e70 7574 2e73 6861  dims = input.sha
+00014360: 7065 0a20 2020 206f 7574 5f63 6861 6e6e  pe.    out_chann
+00014370: 656c 732c 2067 696e 5f63 6861 6e6e 656c  els, gin_channel
+00014380: 732c 202a 6b65 726e 656c 5f64 696d 7320  s, *kernel_dims 
+00014390: 3d20 7765 6967 6874 2e73 6861 7065 0a20  = weight.shape. 
+000143a0: 2020 2064 696d 203d 206c 656e 2873 7061     dim = len(spa
+000143b0: 7469 616c 5f64 696d 7329 0a0a 2020 2020  tial_dims)..    
+000143c0: 6465 6620 6d61 7962 655f 6578 7061 6e64  def maybe_expand
+000143d0: 5f73 6571 2873 2c20 6469 6d29 3a0a 2020  _seq(s, dim):.  
+000143e0: 2020 2020 2020 6966 206c 656e 2873 2920        if len(s) 
+000143f0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00014400: 2020 7265 7475 726e 2028 735b 305d 2c29    return (s[0],)
+00014410: 202a 2064 696d 0a20 2020 2020 2020 2065   * dim.        e
+00014420: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00014430: 2072 6574 7572 6e20 730a 0a20 2020 2073   return s..    s
+00014440: 7472 6964 6520 3d20 6d61 7962 655f 6578  tride = maybe_ex
+00014450: 7061 6e64 5f73 6571 2873 7472 6964 652c  pand_seq(stride,
+00014460: 2064 696d 290a 2020 2020 7061 6464 696e   dim).    paddin
+00014470: 6720 3d20 6d61 7962 655f 6578 7061 6e64  g = maybe_expand
+00014480: 5f73 6571 2870 6164 6469 6e67 2c20 6469  _seq(padding, di
+00014490: 6d29 0a20 2020 2064 696c 6174 696f 6e20  m).    dilation 
+000144a0: 3d20 6d61 7962 655f 6578 7061 6e64 5f73  = maybe_expand_s
+000144b0: 6571 2864 696c 6174 696f 6e2c 2064 696d  eq(dilation, dim
+000144c0: 290a 0a20 2020 2064 6566 2063 6f6e 765f  )..    def conv_
+000144d0: 7472 616e 7370 6f73 6528 7429 3a0a 2020  transpose(t):.  
+000144e0: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
+000144f0: 6d73 2e74 7261 6e73 706f 7365 2874 2c20  ms.transpose(t, 
+00014500: 2831 2c20 3029 202b 2074 7570 6c65 2872  (1, 0) + tuple(r
+00014510: 616e 6765 2832 2c20 742e 6e64 696d 2929  ange(2, t.ndim))
+00014520: 290a 0a20 2020 2023 2069 6e70 7574 5f67  )..    # input_g
+00014530: 7261 6420 3d20 7b0a 2020 2020 6465 6620  rad = {.    def 
+00014540: 7472 616e 7370 6f73 655f 616e 645f 666c  transpose_and_fl
+00014550: 6970 5f77 6569 6768 7428 7765 6967 6874  ip_weight(weight
+00014560: 293a 0a20 2020 2020 2020 2023 2054 6865  ):.        # The
+00014570: 206c 696e 6573 2062 656c 6f77 2061 7265   lines below are
+00014580: 2074 7261 6e73 706f 7369 6e67 2074 6865   transposing the
+00014590: 2063 6861 6e6e 656c 7320 6469 6d73 2e0a   channels dims..
+000145a0: 2020 2020 2020 2020 2320 5765 2061 6c73          # We als
+000145b0: 6f20 6e65 6564 2074 6f20 6578 7472 6163  o need to extrac
+000145c0: 7420 7468 6520 6772 6f75 7020 696e 666f  t the group info
+000145d0: 726d 6174 696f 6e20 616e 6420 6d65 7267  rmation and merg
+000145e0: 6520 6974 0a20 2020 2020 2020 2023 2077  e it.        # w
+000145f0: 6974 6820 7468 6520 6469 6d65 6e73 696f  ith the dimensio
+00014600: 6e20 636f 7272 6573 706f 6e64 696e 6720  n corresponding 
+00014610: 746f 2074 6865 2022 6f75 745f 6368 616e  to the "out_chan
+00014620: 6e65 6c73 2220 6469 6d2e 0a20 2020 2020  nels" dim..     
+00014630: 2020 2023 2028 6f75 745f 6368 616e 6e65     # (out_channe
+00014640: 6c73 2c20 6769 6e5f 6368 616e 6e65 6c73  ls, gin_channels
+00014650: 2920 2d3e 2028 6769 6e5f 6368 616e 6e65  ) -> (gin_channe
+00014660: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
+00014670: 290a 2020 2020 2020 2020 7765 6967 6874  ).        weight
+00014680: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
+00014690: 6528 7765 6967 6874 290a 2020 2020 2020  e(weight).      
+000146a0: 2020 2320 5370 6c69 7420 286f 7574 5f63    # Split (out_c
+000146b0: 6861 6e6e 656c 732c 2920 2d3e 2028 6772  hannels,) -> (gr
+000146c0: 6f75 7073 2c20 6f75 745f 6368 616e 6e65  oups, out_channe
+000146d0: 6c73 202f 2f20 6772 6f75 7073 290a 2020  ls // groups).  
+000146e0: 2020 2020 2020 7765 6967 6874 203d 2077        weight = w
+000146f0: 6569 6768 742e 7265 7368 6170 6528 5b67  eight.reshape([g
+00014700: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
+00014710: 7570 732c 206f 7574 5f63 6861 6e6e 656c  ups, out_channel
+00014720: 7320 2f2f 2067 726f 7570 735d 202b 206b  s // groups] + k
+00014730: 6572 6e65 6c5f 6469 6d73 290a 2020 2020  ernel_dims).    
+00014740: 2020 2020 2320 4d6f 7669 6e67 2067 726f      # Moving gro
+00014750: 7570 7320 746f 2074 6865 206c 6566 742d  ups to the left-
+00014760: 6d6f 7374 2070 6f73 6974 696f 6e2e 0a20  most position.. 
+00014770: 2020 2020 2020 2023 2028 6769 6e5f 6368         # (gin_ch
+00014780: 616e 6e65 6c73 2c20 6772 6f75 7073 2c20  annels, groups, 
+00014790: 6f75 745f 6368 616e 6e65 6c73 202f 2f20  out_channels // 
+000147a0: 6772 6f75 7073 2920 2d3e 2028 6772 6f75  groups) -> (grou
+000147b0: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
+000147c0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
+000147d0: 2f20 6772 6f75 7073 290a 2020 2020 2020  / groups).      
+000147e0: 2020 7765 6967 6874 203d 2063 6f6e 765f    weight = conv_
+000147f0: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
+00014800: 290a 2020 2020 2020 2020 2320 5371 7561  ).        # Squa
+00014810: 7368 2028 6772 6f75 7073 2c20 6769 6e5f  sh (groups, gin_
+00014820: 6368 616e 6e65 6c73 2920 2d3e 2028 696e  channels) -> (in
+00014830: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
+00014840: 2020 2077 6569 6768 7420 3d20 7765 6967     weight = weig
+00014850: 6874 2e72 6573 6861 7065 285b 696e 5f63  ht.reshape([in_c
+00014860: 6861 6e6e 656c 732c 206f 7574 5f63 6861  hannels, out_cha
+00014870: 6e6e 656c 7320 2f2f 2067 726f 7570 735d  nnels // groups]
+00014880: 202b 206b 6572 6e65 6c5f 6469 6d73 290a   + kernel_dims).
+00014890: 0a20 2020 2020 2020 2023 2046 6c69 7020  .        # Flip 
+000148a0: 7370 6174 6961 6c20 6469 6d65 6e73 696f  spatial dimensio
+000148b0: 6e73 0a20 2020 2020 2020 2077 6569 6768  ns.        weigh
+000148c0: 7420 3d20 7072 696d 732e 666c 6970 2877  t = prims.flip(w
+000148d0: 6569 6768 742c 2074 7570 6c65 2872 616e  eight, tuple(ran
+000148e0: 6765 2832 2c20 7765 6967 6874 2e6e 6469  ge(2, weight.ndi
+000148f0: 6d29 2929 0a20 2020 2020 2020 2072 6574  m))).        ret
+00014900: 7572 6e20 7765 6967 6874 0a0a 2020 2020  urn weight..    
+00014910: 2320 5765 206e 6565 6420 746f 2070 6164  # We need to pad
+00014920: 2074 6865 2067 7261 6469 656e 7420 746f   the gradient to
+00014930: 2062 6520 6162 6c65 2074 6f20 6669 7420   be able to fit 
+00014940: 6b65 726e 656c 2077 696e 646f 7773 2e0a  kernel windows..
+00014950: 2020 2020 696e 6974 6961 6c5f 6772 6164      initial_grad
+00014960: 5f70 6164 6469 6e67 203d 205b 6420 2a20  _padding = [d * 
+00014970: 286b 202d 2031 2920 666f 7220 642c 206b  (k - 1) for d, k
+00014980: 2069 6e20 7a69 7028 6469 6c61 7469 6f6e   in zip(dilation
+00014990: 2c20 6b65 726e 656c 5f64 696d 7329 5d0a  , kernel_dims)].
+000149a0: 0a20 2020 2069 6e70 7574 5f67 7261 6420  .    input_grad 
+000149b0: 3d20 636f 6e76 6f6c 7574 696f 6e28 0a20  = convolution(. 
+000149c0: 2020 2020 2020 2070 7269 6d73 2e70 6164         prims.pad
+000149d0: 280a 2020 2020 2020 2020 2020 2020 6772  (.            gr
+000149e0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+000149f0: 302e 302c 0a20 2020 2020 2020 2020 2020  0.0,.           
+00014a00: 2023 2054 6865 2070 6978 6573 2061 7265   # The pixes are
+00014a10: 2073 7472 6964 6520 6177 6179 2066 726f   stride away fro
+00014a20: 6d20 6561 6368 206f 7468 6572 2069 6e20  m each other in 
+00014a30: 7468 6520 6f72 6967 696e 616c 2069 6e70  the original inp
+00014a40: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
+00014a50: 2320 4865 6e63 6520 7765 206e 6565 6420  # Hence we need 
+00014a60: 746f 2064 696c 6174 6520 7468 6520 6772  to dilate the gr
+00014a70: 6164 6965 6e74 2062 7920 6469 6c61 7469  adient by dilati
+00014a80: 6f6e 3d73 7472 6964 6520 2d20 310a 2020  on=stride - 1.  
+00014a90: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
+00014aa0: 6861 7420 7468 6572 6520 6172 6520 7374  hat there are st
+00014ab0: 7269 6465 202d 2031 207a 6572 6f73 2062  ride - 1 zeros b
+00014ac0: 6574 7765 656e 2074 6865 2070 6978 656c  etween the pixel
+00014ad0: 732e 0a20 2020 2020 2020 2020 2020 205b  s..            [
+00014ae0: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
+00014af0: 2c20 3029 5d20 2b20 5b28 302c 2030 2c20  , 0)] + [(0, 0, 
+00014b00: 7320 2d20 3129 2066 6f72 2073 2069 6e20  s - 1) for s in 
+00014b10: 7374 7269 6465 5d2c 0a20 2020 2020 2020  stride],.       
+00014b20: 2029 2c0a 2020 2020 2020 2020 7472 616e   ),.        tran
+00014b30: 7370 6f73 655f 616e 645f 666c 6970 5f77  spose_and_flip_w
+00014b40: 6569 6768 7428 7765 6967 6874 292c 0a20  eight(weight),. 
+00014b50: 2020 2020 2020 204e 6f6e 652c 0a20 2020         None,.   
+00014b60: 2020 2020 2023 2053 6574 7469 6e67 2073       # Setting s
+00014b70: 7472 6964 6520 746f 2031 2061 7320 7468  tride to 1 as th
+00014b80: 6520 6469 7374 616e 6365 2062 6574 7765  e distance betwe
+00014b90: 656e 2070 6978 656c 7320 6973 2074 616b  en pixels is tak
+00014ba0: 656e 0a20 2020 2020 2020 2023 2063 6172  en.        # car
+00014bb0: 6520 6279 2074 6865 2070 6164 2072 6967  e by the pad rig
+00014bc0: 6874 2061 626f 7665 2e0a 2020 2020 2020  ht above..      
+00014bd0: 2020 2831 2c29 2c0a 2020 2020 2020 2020    (1,),.        
+00014be0: 696e 6974 6961 6c5f 6772 6164 5f70 6164  initial_grad_pad
+00014bf0: 6469 6e67 2c0a 2020 2020 2020 2020 6469  ding,.        di
+00014c00: 6c61 7469 6f6e 2c0a 2020 2020 2020 2020  lation,.        
+00014c10: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
+00014c20: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
+00014c30: 6e67 2c0a 2020 2020 2020 2020 6772 6f75  ng,.        grou
+00014c40: 7073 2c0a 2020 2020 290a 0a20 2020 2064  ps,.    )..    d
+00014c50: 6566 2070 6164 5f74 6f5f 696e 7075 7428  ef pad_to_input(
+00014c60: 6772 6164 293a 0a20 2020 2020 2020 2023  grad):.        #
+00014c70: 2057 6520 6e65 6564 2074 6f20 756e 7061   We need to unpa
+00014c80: 6420 7468 6520 7061 6464 696e 6720 646f  d the padding do
+00014c90: 6e65 2074 6f20 7468 6520 696e 7075 7420  ne to the input 
+00014ca0: 7072 696f 7220 746f 2074 6865 2063 6f6e  prior to the con
+00014cb0: 766f 6c75 7469 6f6e 2e0a 2020 2020 2020  volution..      
+00014cc0: 2020 2320 4e6f 7465 2074 6861 7420 6c6f    # Note that lo
+00014cd0: 7720 616e 6420 6869 6768 2070 6164 6469  w and high paddi
+00014ce0: 6e67 2061 7265 206e 6f74 206e 6563 6573  ng are not neces
+00014cf0: 7361 7269 6c79 2065 7175 616c 2c20 736f  sarily equal, so
+00014d00: 2077 6520 6361 6e6e 6f74 0a20 2020 2020   we cannot.     
+00014d10: 2020 2023 2061 6273 6f72 6220 6974 2069     # absorb it i
+00014d20: 6e74 6f20 7468 6520 636f 6e76 6f6c 7574  nto the convolut
+00014d30: 696f 6e20 6a75 7374 2079 6574 2c20 756e  ion just yet, un
+00014d40: 6c65 7373 2074 6865 2041 5049 2069 7320  less the API is 
+00014d50: 6d6f 6469 6669 6564 2e0a 2020 2020 2020  modified..      
+00014d60: 2020 7061 645f 636f 6e66 6967 203d 205b    pad_config = [
+00014d70: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
+00014d80: 2c20 3029 5d0a 2020 2020 2020 2020 666f  , 0)].        fo
+00014d90: 7220 6f2c 2069 2c20 672c 2070 2069 6e20  r o, i, g, p in 
+00014da0: 7a69 7028 6772 6164 2e73 6861 7065 5b32  zip(grad.shape[2
+00014db0: 3a5d 2c20 7370 6174 6961 6c5f 6469 6d73  :], spatial_dims
+00014dc0: 2c20 696e 7075 745f 6772 6164 2e73 6861  , input_grad.sha
+00014dd0: 7065 5b32 3a5d 2c20 7061 6464 696e 6729  pe[2:], padding)
+00014de0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00014df0: 203d 202d 700a 2020 2020 2020 2020 2020   = -p.          
+00014e00: 2020 2320 4e6f 7465 2074 6861 7420 2869    # Note that (i
+00014e10: 202b 2032 202a 2070 2920 6973 2074 6865   + 2 * p) is the
+00014e20: 2073 697a 6520 6f66 2074 6865 2070 6164   size of the pad
+00014e30: 6465 6420 696e 7075 742c 0a20 2020 2020  ded input,.     
+00014e40: 2020 2020 2020 2023 2073 6f20 7468 6520         # so the 
+00014e50: 7175 616e 7469 7479 2028 6920 2b20 3220  quantity (i + 2 
+00014e60: 2a20 7029 202d 2067 2074 656c 6c73 2075  * p) - g tells u
+00014e70: 7320 6279 2068 6f77 206d 7563 680a 2020  s by how much.  
+00014e80: 2020 2020 2020 2020 2020 2320 7765 206e            # we n
+00014e90: 6565 6420 746f 2070 6164 2074 6865 2067  eed to pad the g
+00014ea0: 7261 6469 656e 7420 736f 2074 6861 7420  radient so that 
+00014eb0: 7468 6520 656c 656d 656e 7473 206f 7574  the elements out
+00014ec0: 7369 6465 0a20 2020 2020 2020 2020 2020  side.           
+00014ed0: 2023 206f 6620 7468 6520 636f 6e76 6f6c   # of the convol
+00014ee0: 7574 696f 6e20 7265 6365 6976 6520 7a65  ution receive ze
+00014ef0: 726f 2067 7261 6469 656e 742e 0a20 2020  ro gradient..   
+00014f00: 2020 2020 2020 2020 2023 2070 2069 7320           # p is 
+00014f10: 6164 6469 7469 6f6e 616c 6c79 2073 7562  additionally sub
+00014f20: 7472 6163 7465 6420 746f 206e 6567 6174  tracted to negat
+00014f30: 6520 7468 6520 696e 7075 7427 7320 7061  e the input's pa
+00014f40: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00014f50: 696e 2066 6f72 7761 7264 2e0a 2020 2020  in forward..    
+00014f60: 2020 2020 2020 2020 6869 203d 2028 6920          hi = (i 
+00014f70: 2b20 3220 2a20 7029 202d 2067 202d 2070  + 2 * p) - g - p
+00014f80: 0a20 2020 2020 2020 2020 2020 2070 6164  .            pad
+00014f90: 5f63 6f6e 6669 672e 6170 7065 6e64 2828  _config.append((
+00014fa0: 6c6f 2c20 6869 2c20 3029 290a 2020 2020  lo, hi, 0)).    
+00014fb0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+00014fc0: 2e70 6164 2867 7261 642c 2030 2e30 2c20  .pad(grad, 0.0, 
+00014fd0: 7061 645f 636f 6e66 6967 290a 0a20 2020  pad_config)..   
+00014fe0: 2069 6e70 7574 5f67 7261 6420 3d20 7061   input_grad = pa
+00014ff0: 645f 746f 5f69 6e70 7574 2869 6e70 7574  d_to_input(input
+00015000: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
+00015010: 2020 2020 2320 6269 6173 5f67 7261 6420      # bias_grad 
+00015020: 3d20 7b0a 2020 2020 6966 2062 6961 7320  = {.    if bias 
+00015030: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00015040: 2020 2020 2069 6d70 6f72 7420 7468 756e       import thun
+00015050: 6465 722e 746f 7263 6820 6173 206c 746f  der.torch as lto
+00015060: 7263 680a 0a20 2020 2020 2020 2062 6961  rch..        bia
+00015070: 735f 6772 6164 203d 206c 746f 7263 682e  s_grad = ltorch.
+00015080: 7375 6d28 6772 6164 2c20 5b64 2066 6f72  sum(grad, [d for
+00015090: 2064 2069 6e20 7261 6e67 6528 6772 6164   d in range(grad
+000150a0: 2e6e 6469 6d29 2069 6620 6420 213d 2031  .ndim) if d != 1
+000150b0: 5d29 0a20 2020 2023 207d 0a0a 2020 2020  ]).    # }..    
+000150c0: 2320 7765 6967 6874 2067 7261 6420 3d20  # weight grad = 
+000150d0: 7b0a 2020 2020 6465 6620 7061 645f 7472  {.    def pad_tr
+000150e0: 616e 7370 6f73 655f 616e 645f 7075 7368  anspose_and_push
+000150f0: 5f67 726f 7570 735f 696e 746f 5f62 6174  _groups_into_bat
+00015100: 6368 6573 2874 293a 0a20 2020 2020 2020  ches(t):.       
+00015110: 2023 2046 6972 7374 2070 6164 2c2e 2e2e   # First pad,...
+00015120: 0a20 2020 2020 2020 2023 2050 6164 2061  .        # Pad a
+00015130: 7320 6e65 6365 7373 6172 7920 736f 2074  s necessary so t
+00015140: 6861 7420 696e 2063 6f6e 766f 6c75 7469  hat in convoluti
+00015150: 6f6e 7320 7765 206e 6576 6572 2061 6476  ons we never adv
+00015160: 616e 6365 0a20 2020 2020 2020 2023 2070  ance.        # p
+00015170: 6173 7420 7265 6c65 7661 6e74 2069 6e70  ast relevant inp
+00015180: 7574 732e 0a20 2020 2020 2020 2070 6164  uts..        pad
+00015190: 5f63 6f6e 6669 6720 3d20 5b28 302c 2030  _config = [(0, 0
+000151a0: 2c20 3029 2c20 2830 2c20 302c 2030 295d  , 0), (0, 0, 0)]
+000151b0: 0a20 2020 2020 2020 2066 6f72 206f 2c20  .        for o, 
+000151c0: 692c 206b 2c20 702c 2073 2c20 6420 696e  i, k, p, s, d in
+000151d0: 207a 6970 2867 7261 642e 7368 6170 655b   zip(grad.shape[
+000151e0: 323a 5d2c 2073 7061 7469 616c 5f64 696d  2:], spatial_dim
+000151f0: 732c 206b 6572 6e65 6c5f 6469 6d73 2c20  s, kernel_dims, 
+00015200: 7061 6464 696e 672c 2073 7472 6964 652c  padding, stride,
+00015210: 2064 696c 6174 696f 6e29 3a0a 2020 2020   dilation):.    
+00015220: 2020 2020 2020 2020 2320 5061 6464 696e          # Paddin
+00015230: 6720 6672 6f6d 2062 656c 6f77 2069 7320  g from below is 
+00015240: 7468 6520 7361 6d65 2e0a 2020 2020 2020  the same..      
+00015250: 2020 2020 2020 6c6f 203d 2070 0a20 2020        lo = p.   
+00015260: 2020 2020 2020 2020 2023 2054 6865 7265           # There
+00015270: 2069 7320 616c 7761 7973 2074 6865 206d   is always the m
+00015280: 6178 2069 6e64 6578 2069 6478 2069 6e20  ax index idx in 
+00015290: 7468 6520 696e 7075 740a 2020 2020 2020  the input.      
+000152a0: 2020 2020 2020 2320 7468 6520 7661 6c75        # the valu
+000152b0: 6520 6f66 2077 6869 6368 2c20 696e 7075  e of which, inpu
+000152c0: 745b 6964 785d 2c20 7468 6520 6b65 726e  t[idx], the kern
+000152d0: 656c 2074 6f75 6368 6573 2e0a 2020 2020  el touches..    
+000152e0: 2020 2020 2020 2020 2320 5468 6520 6b65          # The ke
+000152f0: 726e 656c 2072 6561 6368 2c20 6f72 206b  rnel reach, or k
+00015300: 5f72 6561 6368 2c20 6973 2065 7861 6374  _reach, is exact
+00015310: 6c79 2069 6478 202b 2031 2e0a 2020 2020  ly idx + 1..    
+00015320: 2020 2020 2020 2020 2320 5765 2075 7365          # We use
+00015330: 2069 7420 746f 2064 6563 6964 6520 6279   it to decide by
+00015340: 2068 6f77 206d 7563 6820 7765 206e 6565   how much we nee
+00015350: 6420 746f 2070 6164 2066 726f 6d20 6162  d to pad from ab
+00015360: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
+00015370: 2320 6173 2074 6f20 6e6f 7420 6d6f 7665  # as to not move
+00015380: 2070 6173 7420 7265 6c65 7661 6e74 2076   past relevant v
+00015390: 616c 7565 732e 0a20 2020 2020 2020 2020  alues..         
+000153a0: 2020 206b 5f72 6561 6368 203d 2028 6f20     k_reach = (o 
+000153b0: 2d20 3129 202a 2073 202b 2064 202a 2028  - 1) * s + d * (
+000153c0: 6b20 2d20 3129 202b 2031 0a20 2020 2020  k - 1) + 1.     
+000153d0: 2020 2020 2020 2023 2054 6865 2070 6164         # The pad
+000153e0: 2066 726f 6d20 6162 6f76 6520 6571 7561   from above equa
+000153f0: 6c73 206b 5f72 6561 6368 206d 696e 7573  ls k_reach minus
+00015400: 2074 6865 206c 656e 6774 680a 2020 2020   the length.    
+00015410: 2020 2020 2020 2020 2320 6f66 2074 6865          # of the
+00015420: 2069 6e70 7574 2070 6164 6465 6420 6672   input padded fr
+00015430: 6f6d 2062 656c 6f77 2e0a 2020 2020 2020  om below..      
+00015440: 2020 2020 2020 6869 203d 206b 5f72 6561        hi = k_rea
+00015450: 6368 202d 2028 6920 2b20 7029 0a20 2020  ch - (i + p).   
+00015460: 2020 2020 2020 2020 2070 6164 5f63 6f6e           pad_con
+00015470: 6669 672e 6170 7065 6e64 2828 6c6f 2c20  fig.append((lo, 
+00015480: 6869 2c20 3029 290a 2020 2020 2020 2020  hi, 0)).        
+00015490: 7420 3d20 7072 696d 732e 7061 6428 742c  t = prims.pad(t,
+000154a0: 2030 2e30 2c20 7061 645f 636f 6e66 6967   0.0, pad_config
+000154b0: 290a 0a20 2020 2020 2020 205f 2c20 5f2c  )..        _, _,
+000154c0: 202a 745f 7370 6174 6961 6c5f 6469 6d73   *t_spatial_dims
+000154d0: 203d 2074 2e73 6861 7065 0a0a 2020 2020   = t.shape..    
+000154e0: 2020 2020 2320 2e2e 2e20 7468 656e 2064      # ... then d
+000154f0: 6f20 7468 6520 7265 7374 2e0a 2020 2020  o the rest..    
+00015500: 2020 2020 2320 742e 7368 6170 6520 3d3d      # t.shape ==
+00015510: 2028 6261 7463 682c 2069 6e5f 6368 616e   (batch, in_chan
+00015520: 6e65 6c73 2c20 2e2e 2e29 0a20 2020 2020  nels, ...).     
+00015530: 2020 2023 2054 6865 2072 6573 756c 7420     # The result 
+00015540: 6f66 2074 6869 7320 6675 6e63 7469 6f6e  of this function
+00015550: 2068 6173 2073 6861 7065 0a20 2020 2020   has shape.     
+00015560: 2020 2023 2028 696e 5f63 6861 6e6e 656c     # (in_channel
+00015570: 732c 2062 6174 6368 202a 2067 726f 7570  s, batch * group
+00015580: 7329 0a20 2020 2020 2020 2023 2028 6261  s).        # (ba
+00015590: 7463 682c 2069 6e5f 6368 616e 6e65 6c73  tch, in_channels
+000155a0: 2920 2d3e 2028 696e 5f63 6861 6e6e 656c  ) -> (in_channel
+000155b0: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
+000155c0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
+000155d0: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
+000155e0: 2320 5370 6c69 7420 2869 6e5f 6368 616e  # Split (in_chan
+000155f0: 6e65 6c73 2c29 202d 3e20 2867 726f 7570  nels,) -> (group
+00015600: 732c 2067 696e 5f63 6861 6e6e 656c 7329  s, gin_channels)
+00015610: 0a20 2020 2020 2020 2074 203d 2074 2e72  .        t = t.r
+00015620: 6573 6861 7065 285b 6772 6f75 7073 2c20  eshape([groups, 
+00015630: 6769 6e5f 6368 616e 6e65 6c73 2c20 6261  gin_channels, ba
+00015640: 7463 685d 202b 2074 5f73 7061 7469 616c  tch] + t_spatial
+00015650: 5f64 696d 7329 0a20 2020 2020 2020 2023  _dims).        #
+00015660: 2054 7261 6e73 706f 7365 2028 6772 6f75   Transpose (grou
+00015670: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
+00015680: 2c20 6261 7463 6829 202d 3e20 2867 696e  , batch) -> (gin
+00015690: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
+000156a0: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
+000156b0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
+000156c0: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
+000156d0: 2320 466c 6174 7465 6e20 2867 726f 7570  # Flatten (group
+000156e0: 732c 2062 6174 6368 2920 2d3e 2028 6772  s, batch) -> (gr
+000156f0: 6f75 7073 202a 2062 6174 6368 2c29 0a20  oups * batch,). 
+00015700: 2020 2020 2020 2074 203d 2074 2e72 6573         t = t.res
+00015710: 6861 7065 285b 6769 6e5f 6368 616e 6e65  hape([gin_channe
+00015720: 6c73 2c20 6772 6f75 7073 202a 2062 6174  ls, groups * bat
+00015730: 6368 5d20 2b20 745f 7370 6174 6961 6c5f  ch] + t_spatial_
+00015740: 6469 6d73 290a 2020 2020 2020 2020 7265  dims).        re
+00015750: 7475 726e 2074 0a0a 2020 2020 2320 696e  turn t..    # in
+00015760: 7075 7420 7769 6c6c 2068 6176 6520 7368  put will have sh
+00015770: 6170 6520 2867 696e 5f63 6861 6e6e 656c  ape (gin_channel
+00015780: 732c 2067 726f 7570 7320 2a20 6261 7463  s, groups * batc
+00015790: 6829 0a20 2020 2069 6e70 7574 203d 2070  h).    input = p
+000157a0: 6164 5f74 7261 6e73 706f 7365 5f61 6e64  ad_transpose_and
+000157b0: 5f70 7573 685f 6772 6f75 7073 5f69 6e74  _push_groups_int
+000157c0: 6f5f 6261 7463 6865 7328 696e 7075 7429  o_batches(input)
+000157d0: 0a20 2020 2023 2067 7261 6420 7769 6c6c  .    # grad will
+000157e0: 2068 6176 6520 7368 6170 6520 286f 7574   have shape (out
+000157f0: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
+00015800: 290a 2020 2020 2320 4e6f 7465 2074 6861  ).    # Note tha
+00015810: 7420 7468 6573 6520 7368 6170 6573 2061  t these shapes a
+00015820: 7265 2063 6f6d 7061 7469 626c 6520 666f  re compatible fo
+00015830: 7220 6120 6772 6f75 7020 636f 6e76 6f6c  r a group convol
+00015840: 7574 696f 6e2e 0a20 2020 2067 7261 6420  ution..    grad 
+00015850: 3d20 636f 6e76 5f74 7261 6e73 706f 7365  = conv_transpose
+00015860: 2867 7261 6429 0a0a 2020 2020 2320 5768  (grad)..    # Wh
+00015870: 7920 646f 2077 6520 666c 6970 2073 7472  y do we flip str
+00015880: 6964 6520 616e 6420 6469 6c61 7469 6f6e  ide and dilation
+00015890: 3f0a 2020 2020 2320 6b65 726e 656c 5b69  ?.    # kernel[i
+000158a0: 5d20 616e 6420 6b65 726e 656c 5b69 202b  ] and kernel[i +
+000158b0: 2031 5d20 6172 6520 6469 6c61 7469 6f6e   1] are dilation
+000158c0: 2061 7061 7274 2066 726f 6d20 6561 6368   apart from each
+000158d0: 206f 7468 6572 2c0a 2020 2020 2320 736f   other,.    # so
+000158e0: 2064 696c 6174 696f 6e20 6265 636f 6d65   dilation become
+000158f0: 7320 7468 6520 6e65 7720 7374 7269 6465  s the new stride
+00015900: 2e0a 2020 2020 2320 416c 6c20 7468 6520  ..    # All the 
+00015910: 656c 656d 656e 7473 2074 6861 7420 6b65  elements that ke
+00015920: 726e 656c 5b69 5d20 746f 7563 6865 7320  rnel[i] touches 
+00015930: 6172 6520 7374 7269 6465 2061 7761 7920  are stride away 
+00015940: 6672 6f6d 2065 6163 6820 6f74 6865 722c  from each other,
+00015950: 0a20 2020 2023 2068 656e 6365 2073 7472  .    # hence str
+00015960: 6964 6520 6265 636f 6d65 7320 7468 6520  ide becomes the 
+00015970: 6e65 7720 6469 6c61 7469 6f6e 2e0a 2020  new dilation..  
+00015980: 2020 7765 6967 6874 5f67 7261 6420 3d20    weight_grad = 
+00015990: 636f 6e76 6f6c 7574 696f 6e28 0a20 2020  convolution(.   
+000159a0: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+000159b0: 2020 2020 6772 6164 2c0a 2020 2020 2020      grad,.      
+000159c0: 2020 4e6f 6e65 2c0a 2020 2020 2020 2020    None,.        
+000159d0: 6469 6c61 7469 6f6e 2c20 2023 2073 6574  dilation,  # set
+000159e0: 2073 7472 6964 653d 6469 6c61 7469 6f6e   stride=dilation
+000159f0: 0a20 2020 2020 2020 2028 302c 292c 0a20  .        (0,),. 
+00015a00: 2020 2020 2020 2073 7472 6964 652c 2020         stride,  
+00015a10: 2320 7365 7420 6469 6c61 7469 6f6e 3d73  # set dilation=s
+00015a20: 7472 6964 650a 2020 2020 2020 2020 7472  tride.        tr
+00015a30: 616e 7370 6f73 6564 2c0a 2020 2020 2020  ansposed,.      
+00015a40: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00015a50: 2c0a 2020 2020 2020 2020 6772 6f75 7073  ,.        groups
+00015a60: 2c0a 2020 2020 290a 0a20 2020 2023 2054  ,.    )..    # T
+00015a70: 6865 2072 6573 756c 7420 6f66 2074 6865  he result of the
+00015a80: 2063 6f6e 766f 6c75 7469 6f6e 2068 6173   convolution has
+00015a90: 2073 6861 7065 2028 6769 6e5f 6368 616e   shape (gin_chan
+00015aa0: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
+00015ab0: 6c73 292c 0a20 2020 2023 2073 6f20 7472  ls),.    # so tr
+00015ac0: 616e 7370 6f73 6974 696f 6e20 6973 2072  ansposition is r
+00015ad0: 6571 7569 7265 642e 0a20 2020 2077 6569  equired..    wei
+00015ae0: 6768 745f 6772 6164 203d 2063 6f6e 765f  ght_grad = conv_
+00015af0: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
+00015b00: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
+00015b10: 2020 2020 7265 7475 726e 2028 696e 7075      return (inpu
+00015b20: 745f 6772 6164 2c20 7765 6967 6874 5f67  t_grad, weight_g
+00015b30: 7261 642c 2062 6961 735f 6772 6164 290a  rad, bias_grad).
+00015b40: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+00015b50: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+00015b60: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
+00015b70: 2229 0a64 6566 206c 6f67 5f73 6f66 746d  ").def log_softm
+00015b80: 6178 5f61 7567 5f66 7764 2869 6e70 7574  ax_aug_fwd(input
+00015b90: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
+00015ba0: 696d 3a20 696e 742c 202a 2c20 6474 7970  im: int, *, dtyp
+00015bb0: 653d 4e6f 6e65 2920 2d3e 2056 4a50 4475  e=None) -> VJPDu
+00015bc0: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
+00015bd0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+00015be0: 7420 6c6f 675f 736f 6674 6d61 780a 0a20  t log_softmax.. 
+00015bf0: 2020 2070 7269 6d61 6c20 3d20 6c6f 675f     primal = log_
+00015c00: 736f 6674 6d61 7828 696e 7075 742c 2064  softmax(input, d
+00015c10: 696d 3d64 696d 2c20 6474 7970 653d 6474  im=dim, dtype=dt
+00015c20: 7970 6529 0a20 2020 2072 6573 6964 7561  ype).    residua
+00015c30: 6c73 203d 2028 7072 696d 616c 2c20 6469  ls = (primal, di
+00015c40: 6d2c 2069 6e70 7574 2e64 7479 7065 290a  m, input.dtype).
+00015c50: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00015c60: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00015c70: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00015c80: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
+00015c90: 682e 6c6f 675f 736f 6674 6d61 7822 290a  h.log_softmax").
+00015ca0: 6465 6620 6c6f 675f 736f 6674 6d61 785f  def log_softmax_
+00015cb0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+00015cc0: 2064 696d 2c20 6474 7970 652c 2067 293a   dim, dtype, g):
+00015cd0: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00015ce0: 722e 746f 7263 6820 696d 706f 7274 206c  r.torch import l
+00015cf0: 6f67 5f73 6f66 746d 6178 5f62 6163 6b77  og_softmax_backw
+00015d00: 6172 640a 0a20 2020 2072 6574 7572 6e20  ard..    return 
+00015d10: 6c6f 675f 736f 6674 6d61 785f 6261 636b  log_softmax_back
+00015d20: 7761 7264 2867 2c20 7072 696d 616c 2c20  ward(g, primal, 
+00015d30: 6469 6d2c 2064 7479 7065 290a 0a0a 4072  dim, dtype)...@r
+00015d40: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+00015d50: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
+00015d60: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6e  .nn.functional.n
+00015d70: 6c6c 5f6c 6f73 7322 290a 6465 6620 6e6c  ll_loss").def nl
+00015d80: 6c5f 6c6f 7373 5f61 7567 5f66 7764 280a  l_loss_aug_fwd(.
+00015d90: 2020 2020 696e 7075 743a 2050 726f 7879      input: Proxy
+00015da0: 2c0a 2020 2020 7461 7267 6574 3a20 5072  ,.    target: Pr
+00015db0: 6f78 792c 0a20 2020 2077 6569 6768 743a  oxy,.    weight:
+00015dc0: 204e 6f6e 6520 7c20 5072 6f78 792c 0a20   None | Proxy,. 
+00015dd0: 2020 2069 676e 6f72 655f 696e 6465 783a     ignore_index:
+00015de0: 2069 6e74 2c0a 2020 2020 7265 6475 6374   int,.    reduct
+00015df0: 696f 6e3a 2073 7472 2c0a 2920 2d3e 2056  ion: str,.) -> V
+00015e00: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
+00015e10: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00015e20: 6d70 6f72 7420 5f6e 6c6c 5f6c 6f73 735f  mport _nll_loss_
+00015e30: 6865 6c70 6572 0a0a 2020 2020 7072 696d  helper..    prim
+00015e40: 616c 2c20 746f 7461 6c5f 7765 6967 6874  al, total_weight
+00015e50: 203d 205f 6e6c 6c5f 6c6f 7373 5f68 656c   = _nll_loss_hel
+00015e60: 7065 7228 0a20 2020 2020 2020 2069 6e70  per(.        inp
+00015e70: 7574 2c0a 2020 2020 2020 2020 7461 7267  ut,.        targ
+00015e80: 6574 2c0a 2020 2020 2020 2020 7765 6967  et,.        weig
+00015e90: 6874 2c0a 2020 2020 2020 2020 6967 6e6f  ht,.        igno
+00015ea0: 7265 5f69 6e64 6578 2c0a 2020 2020 2020  re_index,.      
+00015eb0: 2020 7265 6475 6374 696f 6e2c 0a20 2020    reduction,.   
+00015ec0: 2029 0a20 2020 2072 6573 6964 7561 6c73   ).    residuals
+00015ed0: 203d 2028 696e 7075 742c 2074 6172 6765   = (input, targe
+00015ee0: 742c 2077 6569 6768 742c 2072 6564 7563  t, weight, reduc
+00015ef0: 7469 6f6e 2c20 6967 6e6f 7265 5f69 6e64  tion, ignore_ind
+00015f00: 6578 2c20 746f 7461 6c5f 7765 6967 6874  ex, total_weight
+00015f10: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+00015f20: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+00015f30: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+00015f40: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
+00015f50: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+00015f60: 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64 6566  l.nll_loss").def
+00015f70: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
+00015f80: 7264 2869 6e70 7574 2c20 7461 7267 6574  rd(input, target
+00015f90: 2c20 7765 6967 6874 2c20 7265 6475 6374  , weight, reduct
+00015fa0: 696f 6e2c 2069 676e 6f72 655f 696e 6465  ion, ignore_inde
+00015fb0: 782c 2074 6f74 616c 5f77 6569 6768 742c  x, total_weight,
+00015fc0: 2067 293a 0a20 2020 2066 726f 6d20 7468   g):.    from th
+00015fd0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
+00015fe0: 7274 206e 6c6c 5f6c 6f73 735f 6261 636b  rt nll_loss_back
+00015ff0: 7761 7264 0a0a 2020 2020 6769 6e70 7574  ward..    ginput
+00016000: 203d 206e 6c6c 5f6c 6f73 735f 6261 636b   = nll_loss_back
+00016010: 7761 7264 2867 2c20 696e 7075 742c 2074  ward(g, input, t
+00016020: 6172 6765 742c 2077 6569 6768 742c 2072  arget, weight, r
+00016030: 6564 7563 7469 6f6e 2c20 6967 6e6f 7265  eduction, ignore
+00016040: 5f69 6e64 6578 2c20 746f 7461 6c5f 7765  _index, total_we
+00016050: 6967 6874 290a 2020 2020 7265 7475 726e  ight).    return
+00016060: 2067 696e 7075 742c 202a 2828 4e6f 6e65   ginput, *((None
+00016070: 2c29 202a 2034 290a 0a0a 4072 6567 6973  ,) * 4)...@regis
+00016080: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00016090: 7277 6172 6428 2274 6f72 6368 2e73 706c  rward("torch.spl
+000160a0: 6974 2229 0a64 6566 2073 706c 6974 5f61  it").def split_a
+000160b0: 7567 5f66 7764 2861 3a20 5465 6e73 6f72  ug_fwd(a: Tensor
+000160c0: 5072 6f78 792c 2073 706c 6974 5f73 697a  Proxy, split_siz
+000160d0: 655f 6f72 5f73 6563 7469 6f6e 733a 2069  e_or_sections: i
+000160e0: 6e74 207c 2053 6571 7565 6e63 655b 696e  nt | Sequence[in
+000160f0: 745d 2c20 6469 6d3a 2069 6e74 203d 2030  t], dim: int = 0
+00016100: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
+00016110: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00016120: 6f72 6368 2069 6d70 6f72 7420 7370 6c69  orch import spli
+00016130: 740a 0a20 2020 2070 7269 6d61 6c20 3d20  t..    primal = 
+00016140: 7370 6c69 7428 612c 2073 706c 6974 5f73  split(a, split_s
+00016150: 697a 655f 6f72 5f73 6563 7469 6f6e 732c  ize_or_sections,
+00016160: 2064 696d 290a 2020 2020 7265 7369 6475   dim).    residu
+00016170: 616c 7320 3d20 2864 696d 2c29 0a20 2020  als = (dim,).   
+00016180: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00016190: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+000161a0: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+000161b0: 6163 6b77 6172 6428 2274 6f72 6368 2e73  ackward("torch.s
+000161c0: 706c 6974 2229 0a64 6566 2073 706c 6974  plit").def split
+000161d0: 5f62 6163 6b77 6172 6428 6469 6d2c 202a  _backward(dim, *
+000161e0: 6772 6164 7329 3a0a 2020 2020 6672 6f6d  grads):.    from
+000161f0: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00016200: 6d70 6f72 7420 6361 740a 0a20 2020 2072  mport cat..    r
+00016210: 6574 7572 6e20 6361 7428 6772 6164 732c  eturn cat(grads,
+00016220: 2064 696d 290a 0a0a 4072 6567 6973 7465   dim)...@registe
+00016230: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+00016240: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
+00016250: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
+00016260: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
+00016270: 6e67 5f61 7567 5f66 7764 280a 2020 2020  ng_aug_fwd(.    
+00016280: 613a 2050 726f 7879 2c0a 2020 2020 7765  a: Proxy,.    we
+00016290: 6967 6874 3a20 5072 6f78 792c 0a20 2020  ight: Proxy,.   
+000162a0: 2070 6164 6469 6e67 5f69 6478 3a20 696e   padding_idx: in
+000162b0: 7420 7c20 4e6f 6e65 2c0a 2020 2020 6d61  t | None,.    ma
+000162c0: 785f 6e6f 726d 3a20 666c 6f61 7420 7c20  x_norm: float | 
+000162d0: 4e6f 6e65 2c0a 2020 2020 6e6f 726d 5f74  None,.    norm_t
+000162e0: 7970 653a 2066 6c6f 6174 2c0a 2020 2020  ype: float,.    
+000162f0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+00016300: 6571 3a20 626f 6f6c 2c0a 2020 2020 7370  eq: bool,.    sp
+00016310: 6172 7365 3a20 626f 6f6c 2c0a 2920 2d3e  arse: bool,.) ->
+00016320: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
+00016330: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00016340: 2069 6d70 6f72 7420 656d 6265 6464 696e   import embeddin
+00016350: 670a 0a20 2020 2070 7269 6d61 6c20 3d20  g..    primal = 
+00016360: 656d 6265 6464 696e 6728 0a20 2020 2020  embedding(.     
+00016370: 2020 2061 2c0a 2020 2020 2020 2020 7765     a,.        we
+00016380: 6967 6874 2c0a 2020 2020 2020 2020 7061  ight,.        pa
+00016390: 6464 696e 675f 6964 783d 7061 6464 696e  dding_idx=paddin
+000163a0: 675f 6964 782c 0a20 2020 2020 2020 206d  g_idx,.        m
+000163b0: 6178 5f6e 6f72 6d3d 6d61 785f 6e6f 726d  ax_norm=max_norm
+000163c0: 2c0a 2020 2020 2020 2020 6e6f 726d 5f74  ,.        norm_t
+000163d0: 7970 653d 6e6f 726d 5f74 7970 652c 0a20  ype=norm_type,. 
+000163e0: 2020 2020 2020 2073 6361 6c65 5f67 7261         scale_gra
+000163f0: 645f 6279 5f66 7265 713d 7363 616c 655f  d_by_freq=scale_
+00016400: 6772 6164 5f62 795f 6672 6571 2c0a 2020  grad_by_freq,.  
+00016410: 2020 2020 2020 7370 6172 7365 3d73 7061        sparse=spa
+00016420: 7273 652c 0a20 2020 2029 0a20 2020 2072  rse,.    ).    r
+00016430: 6573 6964 7561 6c73 203d 2028 612c 2077  esiduals = (a, w
+00016440: 6569 6768 742e 7368 6170 655b 305d 2c20  eight.shape[0], 
+00016450: 7061 6464 696e 675f 6964 782c 2073 6361  padding_idx, sca
+00016460: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
+00016470: 2073 7061 7273 6529 0a20 2020 2072 6574   sparse).    ret
+00016480: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+00016490: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+000164a0: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000164b0: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
+000164c0: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
+000164d0: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
+000164e0: 6e67 5f62 6163 6b77 6172 6428 612c 206e  ng_backward(a, n
+000164f0: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
+00016500: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
+00016510: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
+00016520: 7273 652c 2067 293a 0a20 2020 2066 726f  rse, g):.    fro
+00016530: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00016540: 696d 706f 7274 2065 6d62 6564 6469 6e67  import embedding
+00016550: 5f62 6163 6b77 6172 640a 0a20 2020 2070  _backward..    p
+00016560: 6164 6469 6e67 5f69 6478 203d 202d 3120  adding_idx = -1 
+00016570: 6966 2070 6164 6469 6e67 5f69 6478 2069  if padding_idx i
+00016580: 7320 4e6f 6e65 2065 6c73 6520 7061 6464  s None else padd
+00016590: 696e 675f 6964 780a 2020 2020 6777 6569  ing_idx.    gwei
+000165a0: 6768 7420 3d20 656d 6265 6464 696e 675f  ght = embedding_
+000165b0: 6261 636b 7761 7264 2867 2c20 612c 206e  backward(g, a, n
+000165c0: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
+000165d0: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
+000165e0: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
+000165f0: 7273 6529 0a20 2020 2072 6574 7572 6e20  rse).    return 
+00016600: 6777 6569 6768 740a 0a0a 4072 6567 6973  gweight...@regis
+00016610: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00016620: 7277 6172 6428 2274 6f72 6368 2e63 756d  rward("torch.cum
+00016630: 7375 6d22 290a 6465 6620 6375 6d73 756d  sum").def cumsum
+00016640: 5f61 7567 5f66 7764 2861 3a20 5072 6f78  _aug_fwd(a: Prox
+00016650: 792c 2064 696d 3a20 696e 742c 202a 2c20  y, dim: int, *, 
+00016660: 6474 7970 653a 204e 6f6e 6520 7c20 6474  dtype: None | dt
+00016670: 7970 6573 2e64 7479 7065 203d 204e 6f6e  ypes.dtype = Non
+00016680: 6529 202d 3e20 564a 5044 7561 6c3a 0a20  e) -> VJPDual:. 
+00016690: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+000166a0: 746f 7263 6820 696d 706f 7274 2063 756d  torch import cum
+000166b0: 7375 6d0a 0a20 2020 2070 7269 6d61 6c20  sum..    primal 
+000166c0: 3d20 6375 6d73 756d 2861 2c20 6469 6d2c  = cumsum(a, dim,
+000166d0: 2064 7479 7065 3d64 7479 7065 290a 2020   dtype=dtype).  
+000166e0: 2020 7265 7369 6475 616c 7320 3d20 280a    residuals = (.
+000166f0: 2020 2020 2020 2020 612e 6474 7970 652c          a.dtype,
+00016700: 0a20 2020 2020 2020 2064 696d 2c0a 2020  .        dim,.  
+00016710: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
+00016720: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00016730: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
+00016740: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
+00016750: 746f 7263 682e 6375 6d73 756d 2229 0a64  torch.cumsum").d
+00016760: 6566 2063 756d 7375 6d5f 6261 636b 7761  ef cumsum_backwa
+00016770: 7264 2861 5f64 7479 7065 2c20 6469 6d2c  rd(a_dtype, dim,
+00016780: 2067 293a 0a20 2020 2067 203d 2067 2e74   g):.    g = g.t
+00016790: 6f28 615f 6474 7970 6529 0a20 2020 2069  o(a_dtype).    i
+000167a0: 6620 672e 6e75 6d65 6c28 2920 3c3d 2031  f g.numel() <= 1
+000167b0: 206f 7220 672e 7368 6170 655b 6469 6d5d   or g.shape[dim]
+000167c0: 203d 3d20 313a 0a20 2020 2020 2020 2072   == 1:.        r
+000167d0: 6574 7572 6e20 670a 2020 2020 7265 7475  eturn g.    retu
+000167e0: 726e 2067 2e66 6c69 7028 6469 6d29 2e63  rn g.flip(dim).c
+000167f0: 756d 7375 6d28 6469 6d29 2e66 6c69 7028  umsum(dim).flip(
+00016800: 6469 6d29 0a0a 0a40 7265 6769 7374 6572  dim)...@register
+00016810: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
+00016820: 7264 2822 746f 7263 682e 736f 6674 6d61  rd("torch.softma
+00016830: 7822 290a 6465 6620 736f 6674 6d61 785f  x").def softmax_
+00016840: 6175 675f 6677 6428 613a 2050 726f 7879  aug_fwd(a: Proxy
+00016850: 2c20 6469 6d3a 2069 6e74 2c20 6474 7970  , dim: int, dtyp
+00016860: 653a 2064 7479 7065 732e 6474 7970 6520  e: dtypes.dtype 
+00016870: 7c20 4e6f 6e65 203d 204e 6f6e 6529 202d  | None = None) -
+00016880: 3e20 564a 5044 7561 6c3a 0a20 2020 2066  > VJPDual:.    f
+00016890: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
+000168a0: 6820 696d 706f 7274 2073 6f66 746d 6178  h import softmax
+000168b0: 0a0a 2020 2020 7072 696d 616c 203d 2073  ..    primal = s
+000168c0: 6f66 746d 6178 2861 2c20 6469 6d2c 2064  oftmax(a, dim, d
+000168d0: 7479 7065 3d64 7479 7065 290a 2020 2020  type=dtype).    
+000168e0: 7265 7369 6475 616c 7320 3d20 2870 7269  residuals = (pri
+000168f0: 6d61 6c2c 2064 696d 290a 2020 2020 7265  mal, dim).    re
+00016900: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
+00016910: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
+00016920: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
+00016930: 7761 7264 2822 746f 7263 682e 736f 6674  ward("torch.soft
+00016940: 6d61 7822 290a 6465 6620 736f 6674 6d61  max").def softma
+00016950: 785f 6261 636b 7761 7264 2870 7269 6d61  x_backward(prima
+00016960: 6c2c 2064 696d 2c20 6729 3a0a 2020 2020  l, dim, g):.    
+00016970: 7265 7475 726e 2070 7269 6d61 6c20 2a20  return primal * 
+00016980: 2867 202d 2028 7072 696d 616c 202a 2067  (g - (primal * g
+00016990: 292e 7375 6d28 6469 6d2c 206b 6565 7064  ).sum(dim, keepd
+000169a0: 696d 3d54 7275 6529 290a 0a0a 6465 6620  im=True))...def 
+000169b0: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
+000169c0: 6c73 2862 6f75 6e64 5f73 796d 626f 6c73  ls(bound_symbols
+000169d0: 293a 0a20 2020 2022 2222 4974 6572 6174  ):.    """Iterat
+000169e0: 6520 6f76 6572 2062 6f75 6e64 2073 796d  e over bound sym
+000169f0: 626f 6c73 2c20 736b 6970 7069 6e67 2073  bols, skipping s
+00016a00: 796d 626f 6c73 2074 6861 7420 6172 6520  ymbols that are 
+00016a10: 6e6f 7420 7375 7070 6f72 7465 6420 6279  not supported by
+00016a20: 0a20 2020 2074 6865 2074 7261 6e73 666f  .    the transfo
+00016a30: 726d 7320 696e 6672 6173 7472 7563 7475  rms infrastructu
+00016a40: 7265 2e0a 0a20 2020 2041 7267 733a 0a20  re...    Args:. 
+00016a50: 2020 2020 2020 2062 6f75 6e64 5f73 796d         bound_sym
+00016a60: 626f 6c73 2028 4c69 7374 5b42 6f75 6e64  bols (List[Bound
+00016a70: 5379 6d62 6f6c 5d29 3a20 4c69 7374 206f  Symbol]): List o
+00016a80: 6620 626f 756e 6420 7379 6d62 6f6c 730a  f bound symbols.
+00016a90: 0a20 2020 2059 6965 6c64 733a 0a20 2020  .    Yields:.   
+00016aa0: 2020 2020 2042 6f75 6e64 5379 6d62 6f6c       BoundSymbol
+00016ab0: 3a20 426f 756e 6420 7379 6d62 6f6c 7320  : Bound symbols 
+00016ac0: 7468 6174 2061 7265 2073 7570 706f 7274  that are support
+00016ad0: 6564 2062 7920 7468 6520 7472 616e 7366  ed by the transf
+00016ae0: 6f72 6d73 0a20 2020 2020 2020 2069 6e66  orms.        inf
+00016af0: 7261 7374 7275 6374 7572 650a 2020 2020  rastructure.    
+00016b00: 2222 220a 2020 2020 666f 7220 7379 6d62  """.    for symb
+00016b10: 6f6c 2069 6e20 626f 756e 645f 7379 6d62  ol in bound_symb
+00016b20: 6f6c 733a 0a20 2020 2020 2020 2069 6620  ols:.        if 
+00016b30: 7379 6d62 6f6c 2e73 796d 2e69 6420 696e  symbol.sym.id in
+00016b40: 2074 7261 6e73 666f 726d 5f73 6b69 705f   transform_skip_
+00016b50: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+00016b60: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00016b70: 2020 2065 6c69 6620 7379 6d62 6f6c 2e6f     elif symbol.o
+00016b80: 7574 7075 7420 6973 204e 6f6e 653a 0a20  utput is None:. 
+00016b90: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00016ba0: 6e75 650a 2020 2020 2020 2020 656c 7365  nue.        else
+00016bb0: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
+00016bc0: 656c 6420 7379 6d62 6f6c 0a0a 0a64 6566  eld symbol...def
+00016bd0: 2064 6563 6f6e 7374 7275 6374 5f66 6f72   deconstruct_for
+00016be0: 7761 7264 5f65 6e76 5f66 6f72 5f62 6163  ward_env_for_bac
+00016bf0: 6b77 6172 6428 7472 6163 652c 2065 6e76  kward(trace, env
+00016c00: 293a 0a20 2020 2023 204e 6f74 6520 5b53  ):.    # Note [S
+00016c10: 6176 696e 6720 7468 6520 666f 7277 6172  aving the forwar
+00016c20: 6420 656e 7669 726f 6e6d 656e 7420 696e  d environment in
+00016c30: 2074 6865 2062 6163 6b77 6172 6420 7275   the backward ru
+00016c40: 6c65 5d0a 2020 2020 2320 5765 2063 616e  le].    # We can
+00016c50: 6e6f 7420 7361 7665 2074 6865 2074 7261  not save the tra
+00016c60: 6365 206f 626a 6563 7420 696e 2074 6865  ce object in the
+00016c70: 2072 6573 6964 7561 6c73 2062 6563 6175   residuals becau
+00016c80: 7365 2065 7865 6375 746f 7273 206d 6179  se executors may
+00016c90: 206e 6f74 0a20 2020 2023 2062 6520 6162   not.    # be ab
+00016ca0: 6c65 2074 6f20 7265 7475 726e 2069 7420  le to return it 
+00016cb0: 666f 7220 7468 6520 7370 6c69 7474 6564  for the splitted
+00016cc0: 2066 6f72 7761 7264 2f62 6163 6b77 6172   forward/backwar
+00016cd0: 6420 7061 7373 6573 2e20 496e 7374 6561  d passes. Instea
+00016ce0: 642c 2077 650a 2020 2020 2320 7361 7665  d, we.    # save
+00016cf0: 2061 7267 7320 616e 6420 6b77 6172 6773   args and kwargs
+00016d00: 206f 6620 7468 6520 6f72 6967 696e 616c   of the original
+00016d10: 2066 756e 6374 696f 6e20 6361 6c6c 2061   function call a
+00016d20: 6e64 2072 6563 6f6e 7374 7275 6374 2074  nd reconstruct t
+00016d30: 6865 0a20 2020 2023 2074 7261 6365 206f  he.    # trace o
+00016d40: 626a 6563 7420 616e 6420 6974 7320 656e  bject and its en
+00016d50: 7669 726f 6e6d 656e 7420 6469 6374 2069  vironment dict i
+00016d60: 6e20 7468 6520 6261 636b 7761 7264 2072  n the backward r
+00016d70: 756c 652e 2048 6572 6520 7765 2072 656c  ule. Here we rel
+00016d80: 790a 2020 2020 2320 6f6e 2074 6865 2066  y.    # on the f
+00016d90: 6163 7420 7468 6174 2074 6865 206f 7264  act that the ord
+00016da0: 6572 206f 6620 7468 6520 7379 6d62 6f6c  er of the symbol
+00016db0: 7320 696e 2074 6865 2074 7261 6365 2069  s in the trace i
+00016dc0: 7320 6465 7465 726d 696e 6973 7469 630a  s deterministic.
+00016dd0: 2020 2020 2320 616e 6420 616c 7761 7973      # and always
+00016de0: 2074 6865 2073 616d 6520 666f 7220 7468   the same for th
+00016df0: 6520 7361 6d65 2066 756e 6374 696f 6e20  e same function 
+00016e00: 6361 6c6c 2061 6e64 2074 6865 2073 616d  call and the sam
+00016e10: 6520 7365 7420 6f66 0a20 2020 2023 2061  e set of.    # a
+00016e20: 7267 756d 656e 7473 2e20 5365 6520 7465  rguments. See te
+00016e30: 7374 5f67 7261 642e 7079 3a74 6573 745f  st_grad.py:test_
+00016e40: 746f 7263 685f 6175 746f 6772 6164 5f66  torch_autograd_f
+00016e50: 756e 6374 696f 6e20 666f 7220 616e 2065  unction for an e
+00016e60: 7861 6d70 6c65 0a20 2020 2023 2077 6865  xample.    # whe
+00016e70: 7265 2074 6869 7320 6973 2074 6573 7465  re this is teste
+00016e80: 642e 0a20 2020 2062 6f75 6e64 5f73 796d  d..    bound_sym
+00016e90: 626f 6c73 203d 2069 7465 725f 626f 756e  bols = iter_boun
+00016ea0: 645f 7379 6d62 6f6c 7328 7472 6163 652e  d_symbols(trace.
+00016eb0: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
+00016ec0: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
+00016ed0: 6b77 6172 6420 3d20 7475 706c 6528 656e  kward = tuple(en
+00016ee0: 765b 7365 7175 656e 6369 6679 2873 796d  v[sequencify(sym
+00016ef0: 626f 6c2e 6f75 7470 7574 295b 305d 2e6e  bol.output)[0].n
+00016f00: 616d 655d 2e72 6573 6964 7561 6c73 2066  ame].residuals f
+00016f10: 6f72 2073 796d 626f 6c20 696e 2062 6f75  or symbol in bou
+00016f20: 6e64 5f73 796d 626f 6c73 290a 2020 2020  nd_symbols).    
+00016f30: 7265 7475 726e 2073 6176 6564 5f66 6f72  return saved_for
+00016f40: 5f62 6163 6b77 6172 640a 0a0a 6465 6620  _backward...def 
+00016f50: 7265 636f 6e73 7472 7563 745f 666f 7277  reconstruct_forw
+00016f60: 6172 645f 656e 765f 666f 725f 6261 636b  ard_env_for_back
+00016f70: 7761 7264 2874 7261 6365 2c20 7361 7665  ward(trace, save
+00016f80: 645f 666f 725f 6261 636b 7761 7264 293a  d_for_backward):
+00016f90: 0a20 2020 2062 6f75 6e64 5f73 796d 626f  .    bound_symbo
+00016fa0: 6c73 203d 2069 7465 725f 626f 756e 645f  ls = iter_bound_
+00016fb0: 7379 6d62 6f6c 7328 7472 6163 652e 626f  symbols(trace.bo
+00016fc0: 756e 645f 7379 6d62 6f6c 7329 0a0a 2020  und_symbols)..  
+00016fd0: 2020 7265 636f 6e73 7472 7563 7465 645f    reconstructed_
+00016fe0: 656e 7620 3d20 7b7d 0a0a 2020 2020 666f  env = {}..    fo
+00016ff0: 7220 6964 782c 2073 796d 2069 6e20 656e  r idx, sym in en
+00017000: 756d 6572 6174 6528 626f 756e 645f 7379  umerate(bound_sy
+00017010: 6d62 6f6c 7329 3a0a 2020 2020 2020 2020  mbols):.        
+00017020: 6b20 3d20 7365 7175 656e 6369 6679 2873  k = sequencify(s
+00017030: 796d 2e6f 7574 7075 7429 5b30 5d2e 6e61  ym.output)[0].na
+00017040: 6d65 0a20 2020 2020 2020 2076 203d 2056  me.        v = V
+00017050: 4a50 4475 616c 284e 6f6e 652c 2073 6176  JPDual(None, sav
+00017060: 6564 5f66 6f72 5f62 6163 6b77 6172 645b  ed_for_backward[
+00017070: 6964 785d 290a 2020 2020 2020 2020 7265  idx]).        re
+00017080: 636f 6e73 7472 7563 7465 645f 656e 765b  constructed_env[
+00017090: 6b5d 203d 2076 0a0a 2020 2020 7265 7475  k] = v..    retu
+000170a0: 726e 2072 6563 6f6e 7374 7275 6374 6564  rn reconstructed
+000170b0: 5f65 6e76 0a0a 0a64 6566 2064 6563 6f6d  _env...def decom
+000170c0: 706f 7365 645f 666e 5f61 7567 5f66 7764  posed_fn_aug_fwd
+000170d0: 5f72 756c 6528 2a61 7267 732c 2064 6563  _rule(*args, dec
+000170e0: 6f6d 706f 7365 645f 666e 2c20 2a2a 6b77  omposed_fn, **kw
+000170f0: 6172 6773 293a 0a20 2020 2022 2222 4175  args):.    """Au
+00017100: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
+00017110: 7275 6c65 2066 6f72 2063 6f6d 706f 7369  rule for composi
+00017120: 7465 2066 756e 6374 696f 6e73 2069 6d70  te functions imp
+00017130: 6c65 6d65 6e74 6564 2069 6e20 7465 726d  lemented in term
+00017140: 7320 6f66 206f 7468 6572 2066 756e 6374  s of other funct
+00017150: 696f 6e73 2074 6861 7420 6172 650a 2020  ions that are.  
+00017160: 2020 7375 7070 6f73 6564 2074 6f20 6265    supposed to be
+00017170: 2073 7570 706f 7274 6564 2062 7920 7468   supported by th
+00017180: 6520 564a 5020 696e 6672 6173 7472 7563  e VJP infrastruc
+00017190: 7475 7265 2e0a 0a20 2020 2041 7267 733a  ture...    Args:
+000171a0: 0a20 2020 2020 2020 2064 6563 6f6d 706f  .        decompo
+000171b0: 7365 645f 666e 2028 4361 6c6c 6162 6c65  sed_fn (Callable
+000171c0: 293a 2064 6563 6f6d 706f 7365 6420 7665  ): decomposed ve
+000171d0: 7273 696f 6e20 6f66 2074 6865 2066 756e  rsion of the fun
+000171e0: 6374 696f 6e0a 0a20 2020 2052 6574 7572  ction..    Retur
+000171f0: 6e73 3a0a 2020 2020 2020 2020 4361 6c6c  ns:.        Call
+00017200: 6162 6c65 3a20 4175 676d 656e 7465 6420  able: Augmented 
+00017210: 666f 7277 6172 6420 7275 6c65 2066 6f72  forward rule for
+00017220: 2074 6865 2063 6f6d 706f 7369 7465 2066   the composite f
+00017230: 756e 6374 696f 6e0a 2020 2020 2222 220a  unction.    """.
+00017240: 2020 2020 7472 6163 6520 3d20 636f 6e73      trace = cons
+00017250: 7472 7563 745f 7472 6163 6528 2928 6465  truct_trace()(de
+00017260: 636f 6d70 6f73 6564 5f66 6e2c 202a 6172  composed_fn, *ar
+00017270: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
+00017280: 2020 7472 6163 6520 3d20 756e 7772 6170    trace = unwrap
+00017290: 5f6f 6e65 5f6c 6576 656c 5f6f 665f 7375  _one_level_of_su
+000172a0: 6273 796d 626f 6c73 2874 7261 6365 290a  bsymbols(trace).
+000172b0: 2020 2020 2320 5468 6572 6520 6d61 7920      # There may 
+000172c0: 6265 2061 2064 6561 6420 6e6f 6465 206c  be a dead node l
+000172d0: 696b 6520 225f 203d 2070 7269 6d73 2e63  ike "_ = prims.c
+000172e0: 6f6e 7665 7274 5f65 6c65 6d65 6e74 5f74  onvert_element_t
+000172f0: 7970 6528 302c 2066 6c6f 6174 2922 0a20  ype(0, float)". 
+00017300: 2020 2023 2069 6e20 7468 6520 7472 6163     # in the trac
+00017310: 652e 2057 6520 6e65 6564 2074 6f20 7265  e. We need to re
+00017320: 6d6f 7665 2069 7420 6265 666f 7265 2077  move it before w
+00017330: 6520 6361 6e20 7573 6520 7468 6520 7472  e can use the tr
+00017340: 6163 6520 666f 720a 2020 2020 2320 6175  ace for.    # au
+00017350: 676d 656e 7465 645f 666f 7277 6172 645f  gmented_forward_
+00017360: 7061 7373 2e0a 2020 2020 7472 6163 6520  pass..    trace 
+00017370: 3d20 6463 6528 7472 6163 6529 0a20 2020  = dce(trace).   
+00017380: 2072 6573 756c 742c 2065 6e76 203d 2061   result, env = a
+00017390: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+000173a0: 5f70 6173 7328 2a61 7267 732c 2074 7261  _pass(*args, tra
+000173b0: 6365 3d74 7261 6365 2c20 2a2a 6b77 6172  ce=trace, **kwar
+000173c0: 6773 290a 2020 2020 7361 7665 645f 666f  gs).    saved_fo
+000173d0: 725f 6261 636b 7761 7264 203d 2064 6563  r_backward = dec
+000173e0: 6f6e 7374 7275 6374 5f66 6f72 7761 7264  onstruct_forward
+000173f0: 5f65 6e76 5f66 6f72 5f62 6163 6b77 6172  _env_for_backwar
+00017400: 6428 7472 6163 652c 2065 6e76 290a 2020  d(trace, env).  
+00017410: 2020 2320 5374 6174 6963 2063 6163 6869    # Static cachi
+00017420: 6e67 2064 6f65 7320 6e6f 7420 7769 7468  ng does not with
+00017430: 2077 6974 6820 6b77 6172 6773 2064 6963   with kwargs dic
+00017440: 7473 2c20 736f 2077 6527 7265 2063 6f6e  ts, so we're con
+00017450: 7665 7274 696e 6720 7468 656d 0a20 2020  verting them.   
+00017460: 2023 2074 6f20 4e6f 6e65 2066 6f72 206e   # to None for n
+00017470: 6f77 2077 6865 6e20 706f 7373 6962 6c65  ow when possible
+00017480: 2e0a 2020 2020 6b77 6172 6773 203d 204e  ..    kwargs = N
+00017490: 6f6e 6520 6966 206e 6f74 206b 7761 7267  one if not kwarg
+000174a0: 7320 656c 7365 206b 7761 7267 730a 2020  s else kwargs.  
+000174b0: 2020 7265 7369 6475 616c 7320 3d20 2861    residuals = (a
+000174c0: 7267 732c 206b 7761 7267 732c 2073 6176  rgs, kwargs, sav
+000174d0: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
+000174e0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+000174f0: 7561 6c28 7265 7375 6c74 2c20 7265 7369  ual(result, resi
+00017500: 6475 616c 7329 0a0a 0a64 6566 2064 6563  duals)...def dec
+00017510: 6f6d 706f 7365 645f 666e 5f62 6163 6b77  omposed_fn_backw
+00017520: 6172 645f 7275 6c65 2864 6563 6f6d 706f  ard_rule(decompo
+00017530: 7365 645f 666e 2c20 6172 6773 2c20 6b77  sed_fn, args, kw
+00017540: 6172 6773 2c20 7361 7665 645f 666f 725f  args, saved_for_
+00017550: 6261 636b 7761 7264 2c20 2a67 7261 6473  backward, *grads
+00017560: 293a 0a20 2020 206b 7761 7267 7320 3d20  ):.    kwargs = 
+00017570: 7b7d 2069 6620 6b77 6172 6773 2069 7320  {} if kwargs is 
+00017580: 4e6f 6e65 2065 6c73 6520 6b77 6172 6773  None else kwargs
+00017590: 0a20 2020 2074 7261 6365 203d 2063 6f6e  .    trace = con
+000175a0: 7374 7275 6374 5f74 7261 6365 2829 2864  struct_trace()(d
+000175b0: 6563 6f6d 706f 7365 645f 666e 2c20 2a61  ecomposed_fn, *a
+000175c0: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+000175d0: 2020 2074 7261 6365 203d 2075 6e77 7261     trace = unwra
+000175e0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
+000175f0: 7562 7379 6d62 6f6c 7328 7472 6163 6529  ubsymbols(trace)
+00017600: 0a20 2020 2074 7261 6365 203d 2064 6365  .    trace = dce
+00017610: 2874 7261 6365 290a 2020 2020 2320 626f  (trace).    # bo
+00017620: 756e 645f 7379 6d62 6f6c 7320 3d20 6974  und_symbols = it
+00017630: 6572 5f62 6f75 6e64 5f73 796d 626f 6c73  er_bound_symbols
+00017640: 2874 7261 6365 2e62 6f75 6e64 5f73 796d  (trace.bound_sym
+00017650: 626f 6c73 290a 2020 2020 2320 7265 636f  bols).    # reco
+00017660: 6e73 7472 7563 7465 645f 656e 7620 3d20  nstructed_env = 
+00017670: 7b0a 2020 2020 2320 2020 2020 7365 7175  {.    #     sequ
+00017680: 656e 6369 6679 2873 796d 626f 6c2e 6f75  encify(symbol.ou
+00017690: 7470 7574 295b 305d 2e6e 616d 653a 2056  tput)[0].name: V
+000176a0: 4a50 4475 616c 284e 6f6e 652c 2073 6176  JPDual(None, sav
+000176b0: 6564 5f66 6f72 5f62 6163 6b77 6172 645b  ed_for_backward[
+000176c0: 695d 290a 2020 2020 2320 2020 2020 666f  i]).    #     fo
+000176d0: 7220 692c 2073 796d 626f 6c20 696e 2065  r i, symbol in e
+000176e0: 6e75 6d65 7261 7465 2862 6f75 6e64 5f73  numerate(bound_s
+000176f0: 796d 626f 6c73 290a 2020 2020 2320 7d0a  ymbols).    # }.
+00017700: 2020 2020 7265 636f 6e73 7472 7563 7465      reconstructe
+00017710: 645f 656e 7620 3d20 7265 636f 6e73 7472  d_env = reconstr
+00017720: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
+00017730: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
+00017740: 6365 2c20 7361 7665 645f 666f 725f 6261  ce, saved_for_ba
+00017750: 636b 7761 7264 290a 2020 2020 7265 7375  ckward).    resu
+00017760: 6c74 203d 2062 6163 6b77 6172 645f 7061  lt = backward_pa
+00017770: 7373 2872 6563 6f6e 7374 7275 6374 6564  ss(reconstructed
+00017780: 5f65 6e76 2c20 7472 6163 652c 2067 7261  _env, trace, gra
+00017790: 6473 290a 2020 2020 6966 206c 656e 2861  ds).    if len(a
+000177a0: 7267 7329 203d 3d20 313a 0a20 2020 2020  rgs) == 1:.     
+000177b0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+000177c0: 5b30 5d0a 2020 2020 2320 4261 636b 7761  [0].    # Backwa
+000177d0: 7264 2070 6173 7320 6d69 6768 7420 7265  rd pass might re
+000177e0: 7475 726e 2061 2064 6963 7420 7769 7468  turn a dict with
+000177f0: 2067 7261 6473 2062 7574 2063 7572 7265   grads but curre
+00017800: 6e74 2069 6e74 6572 6661 6365 206f 660a  nt interface of.
+00017810: 2020 2020 2320 6261 636b 7761 7264 2072      # backward r
+00017820: 756c 6520 646f 6573 206e 6f74 2073 7570  ule does not sup
+00017830: 706f 7274 2069 742e 2053 6f20 7765 206a  port it. So we j
+00017840: 7573 7420 6472 6f70 2069 7420 666f 7220  ust drop it for 
+00017850: 6e6f 772e 0a20 2020 2065 6c69 6620 6973  now..    elif is
+00017860: 696e 7374 616e 6365 2872 6573 756c 745b  instance(result[
+00017870: 2d31 5d2c 2064 6963 7429 3a0a 2020 2020  -1], dict):.    
+00017880: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00017890: 745b 3a2d 315d 0a20 2020 2072 6574 7572  t[:-1].    retur
+000178a0: 6e20 7265 7375 6c74 0a0a 0a40 7265 6769  n result...@regi
+000178b0: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
+000178c0: 6f72 7761 7264 2822 746f 7263 682e 5465  orward("torch.Te
+000178d0: 6e73 6f72 2e63 6f6e 7469 6775 6f75 7322  nsor.contiguous"
+000178e0: 290a 4072 6567 6973 7465 725f 6175 676d  ).@register_augm
+000178f0: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+00017900: 6f72 6368 2e63 6f6e 7469 6775 6f75 7322  orch.contiguous"
+00017910: 290a 6465 6620 636f 6e74 6967 756f 7573  ).def contiguous
+00017920: 5f61 7567 5f66 7764 2878 3a20 5465 6e73  _aug_fwd(x: Tens
+00017930: 6f72 5072 6f78 792c 202f 2c20 2a2c 206d  orProxy, /, *, m
+00017940: 656d 6f72 795f 666f 726d 6174 3a20 746f  emory_format: to
+00017950: 7263 682e 6d65 6d6f 7279 5f66 6f72 6d61  rch.memory_forma
+00017960: 7420 3d20 746f 7263 682e 636f 6e74 6967  t = torch.contig
+00017970: 756f 7573 5f66 6f72 6d61 7429 202d 3e20  uous_format) -> 
+00017980: 564a 5044 7561 6c3a 0a20 2020 2066 726f  VJPDual:.    fro
+00017990: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+000179a0: 696d 706f 7274 2063 6f6e 7469 6775 6f75  import contiguou
+000179b0: 730a 0a20 2020 2072 6574 7572 6e20 564a  s..    return VJ
+000179c0: 5044 7561 6c28 636f 6e74 6967 756f 7573  PDual(contiguous
+000179d0: 2878 2c20 6d65 6d6f 7279 5f66 6f72 6d61  (x, memory_forma
+000179e0: 743d 6d65 6d6f 7279 5f66 6f72 6d61 7429  t=memory_format)
+000179f0: 2c20 7475 706c 6528 2929 0a0a 0a40 7265  , tuple())...@re
+00017a00: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
+00017a10: 2274 6f72 6368 2e54 656e 736f 722e 636f  "torch.Tensor.co
+00017a20: 6e74 6967 756f 7573 2229 0a40 7265 6769  ntiguous").@regi
+00017a30: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
+00017a40: 6f72 6368 2e63 6f6e 7469 6775 6f75 7322  orch.contiguous"
+00017a50: 290a 6465 6620 636f 6e74 6967 756f 7573  ).def contiguous
+00017a60: 5f62 6163 6b77 6172 6428 2a72 6573 6964  _backward(*resid
+00017a70: 7561 6c73 5f61 6e64 5f67 7261 6429 202d  uals_and_grad) -
+00017a80: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00017a90: 2020 2023 2052 6573 6964 7561 6c73 2069     # Residuals i
+00017aa0: 7320 6e6f 7420 656d 7074 7920 6265 6361  s not empty beca
+00017ab0: 7573 6520 636f 6e74 6967 756f 7573 2073  use contiguous s
+00017ac0: 796d 626f 6c20 6861 7320 7468 6520 7361  ymbol has the sa
+00017ad0: 6d65 206f 7574 7075 7420 6173 2069 7473  me output as its
+00017ae0: 2069 6e70 7574 0a20 2020 2067 203d 2072   input.    g = r
+00017af0: 6573 6964 7561 6c73 5f61 6e64 5f67 7261  esiduals_and_gra
+00017b00: 645b 2d31 5d0a 2020 2020 7265 7475 726e  d[-1].    return
+00017b10: 2067 0a0a 0a64 6566 2072 6563 6970 726f   g...def recipro
+00017b20: 6361 6c5f 6175 675f 6677 6428 613a 2054  cal_aug_fwd(a: T
+00017b30: 656e 736f 7250 726f 7879 2920 2d3e 2056  ensorProxy) -> V
+00017b40: 4a50 4475 616c 3a0a 2020 2020 7072 696d  JPDual:.    prim
+00017b50: 616c 203d 2072 6563 6970 726f 6361 6c28  al = reciprocal(
+00017b60: 6129 0a20 2020 2072 6574 7572 6e20 564a  a).    return VJ
+00017b70: 5044 7561 6c28 7072 696d 616c 2c20 2870  PDual(primal, (p
+00017b80: 7269 6d61 6c2c 2929 0a0a 0a64 6566 2072  rimal,))...def r
+00017b90: 6563 6970 726f 6361 6c5f 6261 636b 7761  eciprocal_backwa
+00017ba0: 7264 2870 7269 6d61 6c2c 2067 293a 0a20  rd(primal, g):. 
+00017bb0: 2020 2072 6574 7572 6e20 2d67 202a 2070     return -g * p
+00017bc0: 7269 6d61 6c20 2a20 7072 696d 616c 0a0a  rimal * primal..
+00017bd0: 0a40 7061 7274 6961 6c28 7265 6769 7374  .@partial(regist
+00017be0: 6572 5f67 7261 642c 2070 7269 6d73 2e50  er_grad, prims.P
+00017bf0: 7269 6d49 4473 2e52 4543 4950 524f 4341  rimIDs.RECIPROCA
+00017c00: 4c29 0a64 6566 2072 6563 6970 726f 6361  L).def reciproca
+00017c10: 6c5f 6a6f 696e 745f 666f 7277 6172 645f  l_joint_forward_
+00017c20: 6261 636b 7761 7264 5f72 756c 6528 613a  backward_rule(a:
+00017c30: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
+00017c40: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00017c50: 2020 7265 7375 6c74 2c20 7361 7665 6420    result, saved 
+00017c60: 3d20 7265 6369 7072 6f63 616c 5f61 7567  = reciprocal_aug
+00017c70: 5f66 7764 2861 290a 2020 2020 6720 3d20  _fwd(a).    g = 
+00017c80: 6765 745f 6772 6164 2872 6573 756c 7429  get_grad(result)
+00017c90: 0a20 2020 2067 6120 3d20 7265 6369 7072  .    ga = recipr
+00017ca0: 6f63 616c 5f62 6163 6b77 6172 6428 2a73  ocal_backward(*s
+00017cb0: 6176 6564 2c20 6729 0a20 2020 2070 7574  aved, g).    put
+00017cc0: 5f67 7261 6428 612c 2067 6129 0a20 2020  _grad(a, ga).   
+00017cd0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00017ce0: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
+00017cf0: 6e74 6564 5f66 6f72 7761 7264 2822 746f  nted_forward("to
+00017d00: 7263 682e 696e 6465 785f 7075 7422 290a  rch.index_put").
+00017d10: 6465 6620 696e 6465 785f 7075 745f 6175  def index_put_au
+00017d20: 675f 6677 6428 0a20 2020 2061 3a20 5465  g_fwd(.    a: Te
+00017d30: 6e73 6f72 5072 6f78 792c 202f 2c20 696e  nsorProxy, /, in
+00017d40: 6469 6365 733a 2053 6571 7565 6e63 655b  dices: Sequence[
+00017d50: 5465 6e73 6f72 5072 6f78 795d 2c20 7661  TensorProxy], va
+00017d60: 6c75 6573 3a20 5465 6e73 6f72 5072 6f78  lues: TensorProx
+00017d70: 792c 2061 6363 756d 756c 6174 653a 2062  y, accumulate: b
+00017d80: 6f6f 6c20 3d20 4661 6c73 650a 2920 2d3e  ool = False.) ->
+00017d90: 2056 4a50 4475 616c 3a0a 2020 2020 7072   VJPDual:.    pr
+00017da0: 696d 616c 203d 2063 6c61 6e67 2e69 6e64  imal = clang.ind
+00017db0: 6578 5f70 7574 2861 2c20 696e 6469 6365  ex_put(a, indice
+00017dc0: 732c 2076 616c 7565 732c 2061 6363 756d  s, values, accum
+00017dd0: 756c 6174 6529 0a20 2020 2072 6573 6964  ulate).    resid
+00017de0: 7561 6c73 203d 2028 0a20 2020 2020 2020  uals = (.       
+00017df0: 2069 6e64 6963 6573 2c0a 2020 2020 2020   indices,.      
+00017e00: 2020 7661 6c75 6573 2c0a 2020 2020 2020    values,.      
+00017e10: 2020 6163 6375 6d75 6c61 7465 2c0a 2020    accumulate,.  
+00017e20: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
+00017e30: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00017e40: 6573 6964 7561 6c73 290a 0a0a 6465 6620  esiduals)...def 
+00017e50: 7375 6d5f 746f 2861 3a20 5465 6e73 6f72  sum_to(a: Tensor
+00017e60: 5072 6f78 792c 2073 6861 7065 3a20 5365  Proxy, shape: Se
+00017e70: 7175 656e 6365 5b69 6e74 5d29 202d 3e20  quence[int]) -> 
+00017e80: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00017e90: 2069 6620 6e6f 7420 7368 6170 653a 0a20   if not shape:. 
+00017ea0: 2020 2020 2020 2072 6574 7572 6e20 612e         return a.
+00017eb0: 7375 6d28 290a 2020 2020 6c65 6164 696e  sum().    leadin
+00017ec0: 675f 6469 6d73 203d 2061 2e6e 6469 6d20  g_dims = a.ndim 
+00017ed0: 2d20 6c65 6e28 7368 6170 6529 0a20 2020  - len(shape).   
+00017ee0: 2072 6564 7563 655f 6469 6d73 203d 2074   reduce_dims = t
+00017ef0: 7570 6c65 2872 616e 6765 286c 6561 6469  uple(range(leadi
+00017f00: 6e67 5f64 696d 7329 2920 2b20 7475 706c  ng_dims)) + tupl
+00017f10: 6528 0a20 2020 2020 2020 2069 2066 6f72  e(.        i for
+00017f20: 2069 2069 6e20 7261 6e67 6528 6c65 6164   i in range(lead
+00017f30: 696e 675f 6469 6d73 2c20 612e 6e64 696d  ing_dims, a.ndim
+00017f40: 2920 6966 2073 6861 7065 5b69 202d 206c  ) if shape[i - l
+00017f50: 6561 6469 6e67 5f64 696d 735d 203d 3d20  eading_dims] == 
+00017f60: 3120 616e 6420 612e 7368 6170 655b 695d  1 and a.shape[i]
+00017f70: 2021 3d20 310a 2020 2020 290a 2020 2020   != 1.    ).    
+00017f80: 6120 3d20 6c74 6f72 6368 2e73 756d 2861  a = ltorch.sum(a
+00017f90: 2c20 6469 6d3d 7265 6475 6365 5f64 696d  , dim=reduce_dim
+00017fa0: 732c 206b 6565 7064 696d 3d54 7275 6529  s, keepdim=True)
+00017fb0: 0a20 2020 2069 6620 6c65 6164 696e 675f  .    if leading_
+00017fc0: 6469 6d73 203e 2030 3a0a 2020 2020 2020  dims > 0:.      
+00017fd0: 2020 7265 7475 726e 206c 746f 7263 682e    return ltorch.
+00017fe0: 7669 6577 2861 2c20 7368 6170 6529 0a20  view(a, shape). 
+00017ff0: 2020 2072 6574 7572 6e20 610a 0a0a 4072     return a...@r
+00018000: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00018010: 2822 746f 7263 682e 696e 6465 785f 7075  ("torch.index_pu
+00018020: 7422 290a 6465 6620 696e 6465 785f 7075  t").def index_pu
+00018030: 745f 6261 636b 7761 7264 2869 6e64 6963  t_backward(indic
+00018040: 6573 3a20 5365 7175 656e 6365 5b54 656e  es: Sequence[Ten
+00018050: 736f 7250 726f 7879 5d2c 2076 616c 7565  sorProxy], value
+00018060: 733a 2054 656e 736f 7250 726f 7879 2c20  s: TensorProxy, 
+00018070: 6163 6375 6d75 6c61 7465 3a20 626f 6f6c  accumulate: bool
+00018080: 2c20 673a 2054 656e 736f 7250 726f 7879  , g: TensorProxy
+00018090: 293a 0a20 2020 2067 5f76 616c 7565 7320  ):.    g_values 
+000180a0: 3d20 675b 696e 6469 6365 735d 0a20 2020  = g[indices].   
+000180b0: 2023 2074 6f72 6368 2068 6173 2065 7874   # torch has ext
+000180c0: 7261 206c 6f67 6963 2074 6f20 6861 6e64  ra logic to hand
+000180d0: 6c65 2074 6865 2065 7870 616e 6465 6420  le the expanded 
+000180e0: 7661 6c75 6573 0a20 2020 2069 6620 6e6f  values.    if no
+000180f0: 7420 7574 696c 732e 7361 6d65 5f73 6861  t utils.same_sha
+00018100: 7065 2867 5f76 616c 7565 732e 7368 6170  pe(g_values.shap
+00018110: 652c 2076 616c 7565 732e 7368 6170 6529  e, values.shape)
+00018120: 3a0a 2020 2020 2020 2020 6966 2063 6c61  :.        if cla
+00018130: 6e67 2e63 6f6d 7075 7465 5f62 726f 6164  ng.compute_broad
+00018140: 6361 7374 5f73 6861 7065 2867 5f76 616c  cast_shape(g_val
+00018150: 7565 732e 7368 6170 652c 2076 616c 7565  ues.shape, value
+00018160: 732e 7368 6170 6529 3a0a 2020 2020 2020  s.shape):.      
+00018170: 2020 2020 2020 675f 7661 6c75 6573 203d        g_values =
+00018180: 2073 756d 5f74 6f28 675f 7661 6c75 6573   sum_to(g_values
+00018190: 2c20 7661 6c75 6573 2e73 6861 7065 290a  , values.shape).
+000181a0: 2020 2020 6966 2061 6363 756d 756c 6174      if accumulat
+000181b0: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+000181c0: 6e20 672c 2067 5f76 616c 7565 730a 2020  n g, g_values.  
+000181d0: 2020 7265 7475 726e 2063 6c61 6e67 2e69    return clang.i
+000181e0: 6e64 6578 5f70 7574 2867 2c20 696e 6469  ndex_put(g, indi
+000181f0: 6365 732c 206c 746f 7263 682e 7a65 726f  ces, ltorch.zero
+00018200: 735f 6c69 6b65 2876 616c 7565 7329 2c20  s_like(values), 
+00018210: 4661 6c73 6529 2c20 675f 7661 6c75 6573  False), g_values
+00018220: 0a0a 0a64 6566 2075 6e69 666f 726d 5f61  ...def uniform_a
+00018230: 7567 5f66 7764 2873 6861 7065 2c20 6d69  ug_fwd(shape, mi
+00018240: 6e76 616c 2c20 6d61 7876 616c 2c20 2a2c  nval, maxval, *,
+00018250: 2064 6576 6963 652c 2064 7479 7065 293a   device, dtype):
+00018260: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
+00018270: 696d 732e 756e 6966 6f72 6d28 7368 6170  ims.uniform(shap
+00018280: 652c 206d 696e 7661 6c2c 206d 6178 7661  e, minval, maxva
+00018290: 6c2c 2064 6576 6963 653d 6465 7669 6365  l, device=device
+000182a0: 2c20 6474 7970 653d 6474 7970 6529 0a20  , dtype=dtype). 
+000182b0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+000182c0: 6c28 7072 696d 616c 2c20 2870 7269 6d61  l(primal, (prima
+000182d0: 6c2c 206d 696e 7661 6c2c 206d 6178 7661  l, minval, maxva
+000182e0: 6c29 290a 0a0a 6465 6620 756e 6966 6f72  l))...def unifor
+000182f0: 6d5f 6261 636b 7761 7264 2870 7269 6d61  m_backward(prima
+00018300: 6c2c 206d 696e 7661 6c2c 206d 6178 7661  l, minval, maxva
+00018310: 6c2c 2067 293a 0a20 2020 2023 2075 6e69  l, g):.    # uni
+00018320: 666f 726d 2069 7320 696d 706c 656d 656e  form is implemen
+00018330: 7465 6420 6173 2028 6d61 7876 616c 202d  ted as (maxval -
+00018340: 206d 696e 7661 6c29 202a 2075 6e69 666f   minval) * unifo
+00018350: 726d 2873 6861 7065 2c20 302c 2031 2920  rm(shape, 0, 1) 
+00018360: 2b20 6d69 6e76 616c 0a20 2020 2075 6e73  + minval.    uns
+00018370: 6361 6c65 645f 7072 696d 616c 203d 2028  caled_primal = (
+00018380: 7072 696d 616c 202d 206d 696e 7661 6c29  primal - minval)
+00018390: 202f 2028 6d61 7876 616c 202d 206d 696e   / (maxval - min
+000183a0: 7661 6c29 0a20 2020 2072 6564 7563 655f  val).    reduce_
+000183b0: 616c 6c5f 6469 6d73 203d 2074 7570 6c65  all_dims = tuple
+000183c0: 2872 616e 6765 2867 2e6e 6469 6d29 290a  (range(g.ndim)).
+000183d0: 2020 2020 7375 6d20 3d20 7061 7274 6961      sum = partia
+000183e0: 6c28 7072 696d 732e 7375 6d2c 2064 696d  l(prims.sum, dim
+000183f0: 733d 7265 6475 6365 5f61 6c6c 5f64 696d  s=reduce_all_dim
+00018400: 7329 0a20 2020 2072 6574 7572 6e20 4e6f  s).    return No
+00018410: 6e65 2c20 7375 6d28 6720 2a20 2831 202d  ne, sum(g * (1 -
+00018420: 2075 6e73 6361 6c65 645f 7072 696d 616c   unscaled_primal
+00018430: 2929 2c20 7375 6d28 6720 2a20 756e 7363  )), sum(g * unsc
+00018440: 616c 6564 5f70 7269 6d61 6c29 0a0a 0a6e  aled_primal)...n
+00018450: 6f6e 6469 6666 6572 656e 7469 6162 6c65  ondifferentiable
+00018460: 5f76 6a70 5f73 796d 626f 6c73 203d 2028  _vjp_symbols = (
+00018470: 7072 696d 732e 5072 696d 4944 732e 4249  prims.PrimIDs.BI
+00018480: 5457 4953 455f 414e 442c 2070 7269 6d73  TWISE_AND, prims
+00018490: 2e50 7269 6d49 4473 2e53 4947 4e42 4954  .PrimIDs.SIGNBIT
+000184a0: 2c20 7072 696d 732e 5072 696d 4944 732e  , prims.PrimIDs.
+000184b0: 4655 4c4c 290a 0a0a 6465 6620 6973 5f63  FULL)...def is_c
+000184c0: 6f6e 7374 616e 745f 666f 725f 766a 7028  onstant_for_vjp(
+000184d0: 7379 6d62 6f6c 3a20 7072 696d 732e 5379  symbol: prims.Sy
+000184e0: 6d62 6f6c 2920 2d3e 2062 6f6f 6c3a 0a20  mbol) -> bool:. 
+000184f0: 2020 2022 2222 4368 6563 6b20 6966 2061     """Check if a
+00018500: 2073 796d 626f 6c20 6973 2063 6f6e 7374   symbol is const
+00018510: 616e 7420 666f 7220 7468 6520 564a 5020  ant for the VJP 
+00018520: 7472 616e 7366 6f72 6d2e 0a0a 2020 2020  transform...    
+00018530: 4172 6773 3a0a 2020 2020 2020 2020 7379  Args:.        sy
+00018540: 6d62 6f6c 2028 7072 696d 732e 5379 6d62  mbol (prims.Symb
+00018550: 6f6c 293a 2053 796d 626f 6c20 746f 2063  ol): Symbol to c
+00018560: 6865 636b 2e0a 0a20 2020 2052 6574 7572  heck...    Retur
+00018570: 6e73 3a0a 2020 2020 2020 2020 626f 6f6c  ns:.        bool
+00018580: 3a20 5472 7565 2069 6620 7468 6520 7379  : True if the sy
+00018590: 6d62 6f6c 2069 7320 636f 6e73 7461 6e74  mbol is constant
+000185a0: 2c20 4661 6c73 6520 6f74 6865 7277 6973  , False otherwis
+000185b0: 652e 0a20 2020 2022 2222 0a20 2020 2061  e..    """.    a
+000185c0: 7265 5f61 6c6c 5f61 7267 735f 6e6f 6e5f  re_all_args_non_
+000185d0: 6469 6666 6572 656e 7469 6162 6c65 203d  differentiable =
+000185e0: 206e 6f74 2061 6e79 2869 7369 6e73 7461   not any(isinsta
+000185f0: 6e63 6528 6172 672c 2028 466c 6f61 7450  nce(arg, (FloatP
+00018600: 726f 7879 2c20 5465 6e73 6f72 5072 6f78  roxy, TensorProx
+00018610: 7929 2920 666f 7220 6172 6720 696e 2073  y)) for arg in s
+00018620: 796d 626f 6c2e 666c 6174 5f61 7267 7329  ymbol.flat_args)
+00018630: 0a20 2020 2072 6574 7572 6e20 280a 2020  .    return (.  
+00018640: 2020 2020 2020 6172 655f 616c 6c5f 6172        are_all_ar
+00018650: 6773 5f6e 6f6e 5f64 6966 6665 7265 6e74  gs_non_different
+00018660: 6961 626c 650a 2020 2020 2020 2020 6f72  iable.        or
+00018670: 2073 796d 626f 6c2e 6172 655f 616c 6c5f   symbol.are_all_
+00018680: 6172 6773 5f63 6f6e 7374 616e 740a 2020  args_constant.  
+00018690: 2020 2020 2020 6f72 2073 796d 626f 6c2e        or symbol.
+000186a0: 7379 6d2e 6964 2069 6e20 6e6f 6e64 6966  sym.id in nondif
+000186b0: 6665 7265 6e74 6961 626c 655f 766a 705f  ferentiable_vjp_
+000186c0: 7379 6d62 6f6c 730a 2020 2020 290a 0a0a  symbols.    )...
+000186d0: 6465 6620 766a 705f 7379 6d62 6f6c 5f6d  def vjp_symbol_m
+000186e0: 6170 7065 7228 7379 6d62 6f6c 3a20 7072  apper(symbol: pr
+000186f0: 696d 732e 5379 6d62 6f6c 2c20 2a61 7267  ims.Symbol, *arg
+00018700: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+00018710: 2020 2222 2253 796d 626f 6c20 6d61 7070    """Symbol mapp
+00018720: 6572 2066 6f72 2074 6865 2056 4a50 2074  er for the VJP t
+00018730: 7261 6e73 666f 726d 2e0a 0a20 2020 2041  ransform...    A
+00018740: 7267 733a 0a20 2020 2020 2020 2073 796d  rgs:.        sym
+00018750: 626f 6c20 2870 7269 6d73 2e53 796d 626f  bol (prims.Symbo
+00018760: 6c29 3a20 5379 6d62 6f6c 2074 6f20 6265  l): Symbol to be
+00018770: 206d 6170 7065 642e 0a20 2020 2020 2020   mapped..       
+00018780: 2061 7267 7320 2854 7570 6c65 5b56 6172   args (Tuple[Var
+00018790: 6961 626c 655d 293a 2041 7267 756d 656e  iable]): Argumen
+000187a0: 7473 2074 6f20 7468 6520 7379 6d62 6f6c  ts to the symbol
+000187b0: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+000187c0: 2028 4469 6374 5b73 7472 2c20 5661 7269   (Dict[str, Vari
+000187d0: 6162 6c65 5d29 3a20 4b65 7977 6f72 6420  able]): Keyword 
+000187e0: 6172 6775 6d65 6e74 7320 746f 2074 6865  arguments to the
+000187f0: 2073 796d 626f 6c2e 0a0a 2020 2020 5265   symbol...    Re
+00018800: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
+00018810: 616c 6c61 626c 653a 2041 2066 756e 6374  allable: A funct
+00018820: 696f 6e20 7468 6174 2063 6f6d 7075 7465  ion that compute
+00018830: 7320 7468 6520 564a 5020 6f66 2074 6865  s the VJP of the
+00018840: 2073 796d 626f 6c2e 0a20 2020 2022 2222   symbol..    """
+00018850: 0a20 2020 2023 2043 6f6e 7374 616e 7420  .    # Constant 
+00018860: 6361 7365 0a20 2020 2069 6620 6973 5f63  case.    if is_c
+00018870: 6f6e 7374 616e 745f 666f 725f 766a 7028  onstant_for_vjp(
+00018880: 7379 6d62 6f6c 293a 0a0a 2020 2020 2020  symbol):..      
+00018890: 2020 6465 6620 766a 705f 696d 706c 5f63    def vjp_impl_c
+000188a0: 6f6e 7374 2873 796d 626f 6c2c 202a 6172  onst(symbol, *ar
+000188b0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+000188c0: 2020 2020 2020 2020 2020 2061 7267 732c             args,
+000188d0: 206b 7761 7267 7320 3d20 7472 6565 5f6d   kwargs = tree_m
+000188e0: 6170 286c 616d 6264 6120 783a 2078 2e70  ap(lambda x: x.p
+000188f0: 7269 6d61 6c20 6966 2069 7369 6e73 7461  rimal if isinsta
+00018900: 6e63 6528 782c 2056 4a50 4475 616c 2920  nce(x, VJPDual) 
+00018910: 656c 7365 2078 2c20 2861 7267 732c 206b  else x, (args, k
+00018920: 7761 7267 7329 290a 2020 2020 2020 2020  wargs)).        
+00018930: 2020 2020 7072 696d 616c 7320 3d20 7379      primals = sy
+00018940: 6d62 6f6c 5f74 6f5f 6576 616c 2873 796d  mbol_to_eval(sym
+00018950: 626f 6c29 282a 6172 6773 2c20 2a2a 6b77  bol)(*args, **kw
+00018960: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+00018970: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00018980: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
+00018990: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+000189a0: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+000189b0: 6d61 7028 6c61 6d62 6461 2078 3a20 564a  map(lambda x: VJ
+000189c0: 5044 7561 6c28 782c 2074 7570 6c65 2829  PDual(x, tuple()
+000189d0: 292c 2070 7269 6d61 6c73 290a 2020 2020  ), primals).    
+000189e0: 2020 2020 2020 2020 7265 7475 726e 2056          return V
+000189f0: 4a50 4475 616c 2870 7269 6d61 6c73 2c20  JPDual(primals, 
+00018a00: 7475 706c 6528 2929 0a0a 2020 2020 2020  tuple())..      
+00018a10: 2020 7265 7475 726e 2070 6172 7469 616c    return partial
+00018a20: 2876 6a70 5f69 6d70 6c5f 636f 6e73 742c  (vjp_impl_const,
+00018a30: 2073 796d 626f 6c29 0a0a 2020 2020 2320   symbol)..    # 
+00018a40: 4e6f 726d 616c 2063 6173 652c 2077 6520  Normal case, we 
+00018a50: 6861 7665 2061 2070 726f 7879 2074 616e  have a proxy tan
+00018a60: 6765 6e74 0a20 2020 2076 6a70 5f69 6d70  gent.    vjp_imp
+00018a70: 6c20 3d20 6175 676d 656e 7465 645f 666f  l = augmented_fo
+00018a80: 7277 6172 645f 696d 706c 732e 6765 7428  rward_impls.get(
+00018a90: 7379 6d62 6f6c 2e73 796d 2e69 6429 0a0a  symbol.sym.id)..
+00018aa0: 2020 2020 6966 205f 6765 745f 6772 6164      if _get_grad
+00018ab0: 666e 5f61 6e64 5f65 7865 6375 746f 7228  fn_and_executor(
+00018ac0: 7379 6d62 6f6c 295b 305d 2069 7320 6e6f  symbol)[0] is no
+00018ad0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00018ae0: 766a 705f 696d 706c 2c20 6261 636b 7761  vjp_impl, backwa
+00018af0: 7264 5f66 6e20 3d20 6d61 6b65 5f61 7567  rd_fn = make_aug
+00018b00: 5f66 6f72 7761 7264 5f61 6e64 5f62 6163  _forward_and_bac
+00018b10: 6b77 6172 6428 7379 6d62 6f6c 290a 0a20  kward(symbol).. 
+00018b20: 2020 2069 6620 766a 705f 696d 706c 2069     if vjp_impl i
+00018b30: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00018b40: 2320 5765 2063 6f75 6c64 206e 6f74 2066  # We could not f
+00018b50: 696e 6420 6120 564a 5020 666f 7220 7468  ind a VJP for th
+00018b60: 6973 2073 796d 626f 6c2c 2073 6f20 7765  is symbol, so we
+00018b70: 2074 7279 2074 6f20 6465 636f 6d70 6f73   try to decompos
+00018b80: 6520 6974 0a20 2020 2020 2020 2069 6620  e it.        if 
+00018b90: 6c65 6e28 7379 6d62 6f6c 2e73 7562 7379  len(symbol.subsy
+00018ba0: 6d62 6f6c 7329 203e 2030 2061 6e64 206e  mbols) > 0 and n
+00018bb0: 6f74 2069 7369 6e73 7461 6e63 6528 7379  ot isinstance(sy
+00018bc0: 6d62 6f6c 2e73 796d 2e69 642c 2070 7269  mbol.sym.id, pri
+00018bd0: 6d73 2e50 7269 6d49 4473 293a 0a20 2020  ms.PrimIDs):.   
+00018be0: 2020 2020 2020 2020 2076 6a70 5f69 6d70           vjp_imp
+00018bf0: 6c20 3d20 7061 7274 6961 6c28 6465 636f  l = partial(deco
+00018c00: 6d70 6f73 6564 5f66 6e5f 6175 675f 6677  mposed_fn_aug_fw
+00018c10: 645f 7275 6c65 2c20 6465 636f 6d70 6f73  d_rule, decompos
+00018c20: 6564 5f66 6e3d 7379 6d62 6f6c 2e73 796d  ed_fn=symbol.sym
+00018c30: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00018c40: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+00018c50: 2063 6f75 6c64 206e 6f74 2066 696e 6420   could not find 
+00018c60: 6120 564a 5020 666f 7220 7468 6973 2073  a VJP for this s
+00018c70: 796d 626f 6c20 616e 6420 7765 2063 6f75  ymbol and we cou
+00018c80: 6c64 206e 6f74 2064 6563 6f6d 706f 7365  ld not decompose
+00018c90: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+00018ca0: 2320 4974 2063 6f75 6c64 2062 6520 6120  # It could be a 
+00018cb0: 746f 7263 682e 6472 6f70 6f75 7420 7769  torch.dropout wi
+00018cc0: 7468 2030 2e30 2070 726f 6261 6269 6c69  th 0.0 probabili
+00018cd0: 7479 2c20 736f 2077 6520 736b 6970 2069  ty, so we skip i
+00018ce0: 740a 2020 2020 2020 2020 2020 2020 6966  t.            if
+00018cf0: 2073 796d 626f 6c2e 7379 6d2e 6964 203d   symbol.sym.id =
+00018d00: 3d20 2274 6f72 6368 2e6e 6e2e 6675 6e63  = "torch.nn.func
+00018d10: 7469 6f6e 616c 2e64 726f 706f 7574 223a  tional.dropout":
+00018d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018d30: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
+00018d40: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+00018d50: 2256 4a50 2066 6f72 207b 7379 6d62 6f6c  "VJP for {symbol
+00018d60: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
+00018d70: 6e74 6564 2229 0a20 2020 2020 2020 2020  nted").         
+00018d80: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+00018d90: 656d 656e 7465 6445 7272 6f72 2866 2256  ementedError(f"V
+00018da0: 4a50 2066 6f72 207b 7379 6d62 6f6c 2e73  JP for {symbol.s
+00018db0: 796d 2e69 647d 2069 7320 6e6f 7420 696d  ym.id} is not im
+00018dc0: 706c 656d 656e 7465 6422 290a 0a20 2020  plemented")..   
+00018dd0: 2064 6566 205f 766a 705f 696d 706c 282a   def _vjp_impl(*
+00018de0: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+00018df0: 0a20 2020 2020 2020 2070 7269 6d61 6c73  .        primals
+00018e00: 2c20 6b77 6172 6773 203d 2074 7265 655f  , kwargs = tree_
+00018e10: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+00018e20: 7072 696d 616c 2069 6620 6973 696e 7374  primal if isinst
+00018e30: 616e 6365 2878 2c20 564a 5044 7561 6c29  ance(x, VJPDual)
+00018e40: 2065 6c73 6520 782c 2028 6172 6773 2c20   else x, (args, 
+00018e50: 6b77 6172 6773 2929 0a20 2020 2020 2020  kwargs)).       
+00018e60: 206f 7574 5f70 7269 6d61 6c2c 206f 7574   out_primal, out
+00018e70: 5f72 6573 6964 7561 6c73 203d 2076 6a70  _residuals = vjp
+00018e80: 5f69 6d70 6c28 2a70 7269 6d61 6c73 2c20  _impl(*primals, 
+00018e90: 2a2a 6b77 6172 6773 290a 0a20 2020 2020  **kwargs)..     
+00018ea0: 2020 2023 2057 6520 6172 6520 7361 7669     # We are savi
+00018eb0: 6e67 2074 6865 2072 6573 6964 7561 6c73  ng the residuals
+00018ec0: 2061 6e64 2070 756c 6c62 6163 6b20 6f6e   and pullback on
+00018ed0: 6c79 2069 6e20 7468 6520 6669 7273 7420  ly in the first 
+00018ee0: 6f75 7470 7574 0a20 2020 2020 2020 2023  output.        #
+00018ef0: 2062 6163 6b77 6172 645f 7061 7373 2074   backward_pass t
+00018f00: 6865 6e20 7265 7472 6965 7665 7320 7468  hen retrieves th
+00018f10: 6520 7265 7369 6475 616c 7320 616e 6420  e residuals and 
+00018f20: 7075 6c6c 6261 636b 2066 726f 6d20 7468  pullback from th
+00018f30: 6520 6669 7273 7420 6f75 7470 7574 0a20  e first output. 
+00018f40: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00018f50: 616e 6365 286f 7574 5f70 7269 6d61 6c2c  ance(out_primal,
+00018f60: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+00018f70: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00018f80: 564a 5044 7561 6c28 6f75 745f 7072 696d  VJPDual(out_prim
+00018f90: 616c 5b30 5d2c 206f 7574 5f72 6573 6964  al[0], out_resid
+00018fa0: 7561 6c73 292c 202a 2856 4a50 4475 616c  uals), *(VJPDual
+00018fb0: 286f 2c20 7475 706c 6528 2929 2066 6f72  (o, tuple()) for
+00018fc0: 206f 2069 6e20 6f75 745f 7072 696d 616c   o in out_primal
+00018fd0: 5b31 3a5d 2929 0a0a 2020 2020 2020 2020  [1:]))..        
+00018fe0: 7265 7475 726e 2028 564a 5044 7561 6c28  return (VJPDual(
+00018ff0: 6f75 745f 7072 696d 616c 2c20 6f75 745f  out_primal, out_
+00019000: 7265 7369 6475 616c 7329 2c29 0a0a 2020  residuals),)..  
+00019010: 2020 7265 7475 726e 205f 766a 705f 696d    return _vjp_im
+00019020: 706c 0a0a 0a64 6566 2063 6865 636b 5f62  pl...def check_b
+00019030: 7379 6d5f 666f 725f 766a 7028 6273 796d  sym_for_vjp(bsym
+00019040: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+00019050: 6865 636b 2069 6620 6120 626f 756e 6420  heck if a bound 
+00019060: 7379 6d62 6f6c 2069 7320 7375 7070 6f72  symbol is suppor
+00019070: 7465 6420 6279 2076 6a70 2e0a 0a20 2020  ted by vjp...   
+00019080: 2041 7267 733a 0a20 2020 2020 2020 2062   Args:.        b
+00019090: 7379 6d20 2842 6f75 6e64 5379 6d62 6f6c  sym (BoundSymbol
+000190a0: 293a 2054 6865 2062 6f75 6e64 2073 796d  ): The bound sym
+000190b0: 626f 6c20 746f 2063 6865 636b 2e0a 0a20  bol to check... 
+000190c0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+000190d0: 2020 2020 626f 6f6c 3a20 5472 7565 2069      bool: True i
+000190e0: 6620 7468 6520 626f 756e 6420 7379 6d62  f the bound symb
+000190f0: 6f6c 2069 7320 7375 7070 6f72 7465 6420  ol is supported 
+00019100: 6279 2076 6a70 2c20 4661 6c73 6520 6f74  by vjp, False ot
+00019110: 6865 7277 6973 652e 0a20 2020 2022 2222  herwise..    """
+00019120: 0a0a 2020 2020 6966 2062 7379 6d2e 7379  ..    if bsym.sy
+00019130: 6d2e 6964 2069 6e20 7472 616e 7366 6f72  m.id in transfor
+00019140: 6d5f 736b 6970 5f6c 6973 743a 0a20 2020  m_skip_list:.   
+00019150: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+00019160: 0a0a 2020 2020 6966 2062 7379 6d2e 7379  ..    if bsym.sy
+00019170: 6d2e 6964 2069 6e20 6261 636b 7761 7264  m.id in backward
+00019180: 5f69 6d70 6c73 2061 6e64 2062 7379 6d2e  _impls and bsym.
+00019190: 7379 6d2e 6964 2069 6e20 6175 676d 656e  sym.id in augmen
+000191a0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
+000191b0: 733a 0a20 2020 2020 2020 2072 6574 7572  s:.        retur
+000191c0: 6e20 5472 7565 0a0a 2020 2020 6966 2062  n True..    if b
+000191d0: 7379 6d2e 7379 6d2e 6964 2069 6e20 5f67  sym.sym.id in _g
+000191e0: 7261 645f 666e 5f6d 6170 3a0a 2020 2020  rad_fn_map:.    
+000191f0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+00019200: 0a20 2020 2023 2057 6520 636f 756c 6420  .    # We could 
+00019210: 6e6f 7420 6669 6e64 2061 2056 4a50 2066  not find a VJP f
+00019220: 6f72 2074 6869 7320 7379 6d62 6f6c 2c20  or this symbol, 
+00019230: 736f 2077 6520 7472 7920 746f 2064 6563  so we try to dec
+00019240: 6f6d 706f 7365 2069 740a 2020 2020 2320  ompose it.    # 
+00019250: 696e 746f 2073 7562 2d73 796d 626f 6c73  into sub-symbols
+00019260: 2061 6e64 2063 6865 636b 2069 6620 7468   and check if th
+00019270: 6579 2061 7265 2073 7570 706f 7274 6564  ey are supported
+00019280: 0a20 2020 2069 6620 6c65 6e28 6273 796d  .    if len(bsym
+00019290: 2e73 7562 7379 6d62 6f6c 7329 203e 2030  .subsymbols) > 0
+000192a0: 2061 6e64 206e 6f74 2062 7379 6d2e 7379   and not bsym.sy
+000192b0: 6d2e 6973 5f70 7269 6d3a 0a20 2020 2020  m.is_prim:.     
+000192c0: 2020 2073 7562 7472 6163 6520 3d20 636f     subtrace = co
+000192d0: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+000192e0: 6273 796d 2e73 796d 2c20 2a62 7379 6d2e  bsym.sym, *bsym.
+000192f0: 6172 6773 2c20 2a2a 6273 796d 2e6b 7761  args, **bsym.kwa
+00019300: 7267 7329 0a20 2020 2020 2020 2073 7562  rgs).        sub
+00019310: 7472 6163 6520 3d20 756e 7772 6170 5f6f  trace = unwrap_o
+00019320: 6e65 5f6c 6576 656c 5f6f 665f 7375 6273  ne_level_of_subs
+00019330: 796d 626f 6c73 2873 7562 7472 6163 6529  ymbols(subtrace)
+00019340: 0a20 2020 2020 2020 2061 6c6c 5f73 7570  .        all_sup
+00019350: 706f 7274 6564 203d 2061 6c6c 2863 6865  ported = all(che
+00019360: 636b 5f62 7379 6d5f 666f 725f 766a 7028  ck_bsym_for_vjp(
+00019370: 7375 6262 7379 6d29 2066 6f72 2073 7562  subbsym) for sub
+00019380: 6273 796d 2069 6e20 7375 6274 7261 6365  bsym in subtrace
+00019390: 2e62 6f75 6e64 5f73 796d 626f 6c73 290a  .bound_symbols).
+000193a0: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+000193b0: 6c6c 5f73 7570 706f 7274 6564 0a0a 2020  ll_supported..  
+000193c0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+000193d0: 0a64 6566 2061 7567 6d65 6e74 6564 5f66  .def augmented_f
+000193e0: 6f72 7761 7264 5f70 6173 7328 2a61 7267  orward_pass(*arg
+000193f0: 732c 2074 7261 6365 3a20 5472 6163 652c  s, trace: Trace,
+00019400: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+00019410: 2222 2241 7567 6d65 6e74 6564 2066 6f72  """Augmented for
+00019420: 7761 7264 2070 6173 7320 666f 7220 7468  ward pass for th
+00019430: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
+00019440: 0a0a 2020 2020 5468 6520 6175 676d 656e  ..    The augmen
+00019450: 7465 6420 666f 7277 6172 6420 7061 7373  ted forward pass
+00019460: 2069 7320 6120 666f 7277 6172 6420 7061   is a forward pa
+00019470: 7373 2074 6861 7420 7265 7475 726e 7320  ss that returns 
+00019480: 7468 6520 7265 7369 6475 616c 730a 2020  the residuals.  
+00019490: 2020 6f66 2074 6865 2066 6f72 7761 7264    of the forward
+000194a0: 2070 6173 732e 0a20 2020 2054 6865 7365   pass..    These
+000194b0: 2072 6573 6964 7561 6c73 2061 7265 2075   residuals are u
+000194c0: 7365 6420 696e 2074 6865 2062 6163 6b77  sed in the backw
+000194d0: 6172 6420 7061 7373 2074 6f20 636f 6d70  ard pass to comp
+000194e0: 7574 6520 7468 6520 564a 5020 616e 6420  ute the VJP and 
+000194f0: 7468 6579 0a20 2020 2061 7265 2072 6563  they.    are rec
+00019500: 6f72 6465 6420 696e 2074 6865 2065 6e76  orded in the env
+00019510: 6972 6f6e 6d65 6e74 2064 6963 7469 6f6e  ironment diction
+00019520: 6172 7920 666f 7220 6561 6368 2076 6172  ary for each var
+00019530: 6961 626c 652e 0a0a 2020 2020 4172 6773  iable...    Args
+00019540: 3a0a 2020 2020 2020 2020 6172 6773 2028  :.        args (
+00019550: 5475 706c 655b 5661 7269 6162 6c65 5d29  Tuple[Variable])
+00019560: 3a20 4172 6775 6d65 6e74 7320 746f 2074  : Arguments to t
+00019570: 6865 2066 756e 6374 696f 6e2e 0a20 2020  he function..   
+00019580: 2020 2020 2074 7261 6365 2028 5472 6163       trace (Trac
+00019590: 6529 3a20 5472 6163 6520 6f66 2074 6865  e): Trace of the
+000195a0: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
+000195b0: 2020 206b 7761 7267 7320 2844 6963 745b     kwargs (Dict[
+000195c0: 7374 722c 2056 6172 6961 626c 655d 293a  str, Variable]):
+000195d0: 204b 6579 776f 7264 2061 7267 756d 656e   Keyword argumen
+000195e0: 7473 2074 6f20 7468 6520 6675 6e63 7469  ts to the functi
+000195f0: 6f6e 2e0a 0a20 2020 2052 6574 7572 6e73  on...    Returns
+00019600: 3a0a 2020 2020 2020 2020 5475 706c 655b  :.        Tuple[
+00019610: 416e 792c 2044 6963 745b 7374 722c 2041  Any, Dict[str, A
+00019620: 6e79 5d5d 3a20 5475 706c 6520 6f66 2074  ny]]: Tuple of t
+00019630: 6865 2070 7269 6d61 6c20 6f75 7470 7574  he primal output
+00019640: 7320 616e 6420 7468 6520 656e 7669 726f  s and the enviro
+00019650: 6e6d 656e 742e 0a20 2020 2022 2222 0a20  nment..    """. 
+00019660: 2020 2061 7267 732c 206b 7761 7267 7320     args, kwargs 
+00019670: 3d20 7472 6565 5f6d 6170 286c 616d 6264  = tree_map(lambd
+00019680: 6120 783a 2056 4a50 4475 616c 2878 2c20  a x: VJPDual(x, 
+00019690: 7475 706c 6528 2929 2c20 2861 7267 732c  tuple()), (args,
+000196a0: 206b 7761 7267 7329 290a 2020 2020 7265   kwargs)).    re
+000196b0: 7375 6c74 2c20 656e 7620 3d20 6576 616c  sult, env = eval
+000196c0: 5f74 7261 6365 280a 2020 2020 2020 2020  _trace(.        
+000196d0: 7472 6163 652c 0a20 2020 2020 2020 202a  trace,.        *
+000196e0: 6172 6773 2c0a 2020 2020 2020 2020 2a2a  args,.        **
+000196f0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00019700: 7769 7468 5f65 6e76 3d54 7275 652c 0a20  with_env=True,. 
+00019710: 2020 2020 2020 2073 796d 626f 6c5f 6d61         symbol_ma
+00019720: 7070 6572 3d76 6a70 5f73 796d 626f 6c5f  pper=vjp_symbol_
+00019730: 6d61 7070 6572 2c0a 2020 2020 290a 2020  mapper,.    ).  
+00019740: 2020 7265 7375 6c74 203d 2074 7265 655f    result = tree_
+00019750: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+00019760: 7072 696d 616c 2069 6620 6973 696e 7374  primal if isinst
+00019770: 616e 6365 2878 2c20 564a 5044 7561 6c29  ance(x, VJPDual)
+00019780: 2065 6c73 6520 782c 2072 6573 756c 7429   else x, result)
+00019790: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
+000197a0: 6c74 2c20 656e 760a 0a0a 2320 544f 444f  lt, env...# TODO
+000197b0: 3a20 496e 7374 6561 6420 6f66 2075 7369  : Instead of usi
+000197c0: 6e67 2074 6865 2065 6e76 6972 6f6e 6d65  ng the environme
+000197d0: 6e74 2064 6963 7469 6f6e 6172 792c 2077  nt dictionary, w
+000197e0: 6520 636f 756c 6420 7573 6520 7468 6520  e could use the 
+000197f0: 7472 6163 650a 2320 7379 6d62 6f6c 7320  trace.# symbols 
+00019800: 6f72 6465 7220 2874 6861 7420 7368 6f75  order (that shou
+00019810: 6c64 2062 6520 6465 7465 726d 696e 6973  ld be determinis
+00019820: 7469 6329 2074 6f20 7265 7472 6965 7665  tic) to retrieve
+00019830: 2074 6865 2072 6573 6964 7561 6c73 206e   the residuals n
+00019840: 6565 6465 640a 2320 666f 7220 7468 6520  eeded.# for the 
+00019850: 6261 636b 7761 7264 2070 6173 732e 0a64  backward pass..d
+00019860: 6566 2062 6163 6b77 6172 645f 7061 7373  ef backward_pass
+00019870: 2866 6f72 7761 7264 5f65 6e76 2c20 7472  (forward_env, tr
+00019880: 6163 652c 2069 6e69 745f 636f 7461 6e67  ace, init_cotang
+00019890: 656e 7473 293a 0a20 2020 2022 2222 4261  ents):.    """Ba
+000198a0: 636b 7761 7264 2070 6173 7320 666f 7220  ckward pass for 
+000198b0: 7468 6520 564a 5020 7472 616e 7366 6f72  the VJP transfor
+000198c0: 6d2e 0a0a 2020 2020 5468 6520 6261 636b  m...    The back
+000198d0: 7761 7264 2070 6173 7320 6973 2061 2072  ward pass is a r
+000198e0: 6576 6572 7365 206d 6f64 6520 6175 746f  everse mode auto
+000198f0: 6d61 7469 6320 6469 6666 6572 656e 7469  matic differenti
+00019900: 6174 696f 6e20 7061 7373 2074 6861 740a  ation pass that.
+00019910: 2020 2020 636f 6d70 7574 6573 2074 6865      computes the
+00019920: 2076 6563 746f 722d 4a61 636f 6269 616e   vector-Jacobian
+00019930: 2070 726f 6475 6374 2028 564a 5029 206f   product (VJP) o
+00019940: 6620 7468 6520 6675 6e63 7469 6f6e 2e0a  f the function..
+00019950: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00019960: 2020 2066 6f72 7761 7264 5f65 6e76 2028     forward_env (
+00019970: 4469 6374 5b73 7472 2c20 416e 795d 293a  Dict[str, Any]):
+00019980: 2045 6e76 6972 6f6e 6d65 6e74 206f 6620   Environment of 
+00019990: 7468 6520 666f 7277 6172 6420 7061 7373  the forward pass
+000199a0: 2e0a 2020 2020 2020 2020 7472 6163 6520  ..        trace 
+000199b0: 2854 7261 6365 293a 2054 7261 6365 206f  (Trace): Trace o
+000199c0: 6620 7468 6520 6675 6e63 7469 6f6e 2e0a  f the function..
+000199d0: 2020 2020 2020 2020 696e 6974 5f63 6f74          init_cot
+000199e0: 616e 6765 6e74 7320 2854 7570 6c65 5b56  angents (Tuple[V
+000199f0: 6172 6961 626c 655d 293a 2049 6e69 7469  ariable]): Initi
+00019a00: 616c 2063 6f74 616e 6765 6e74 732e 0a0a  al cotangents...
+00019a10: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00019a20: 2020 2020 2054 7570 6c65 5b50 726f 7879       Tuple[Proxy
+00019a30: 2c20 2e2e 2e5d 3a20 5475 706c 6520 6f66  , ...]: Tuple of
+00019a40: 2074 6865 2072 6573 756c 7473 206f 6620   the results of 
+00019a50: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
+00019a60: 7320 666f 7220 6561 6368 2069 6e70 7574  s for each input
+00019a70: 2e0a 2020 2020 2222 220a 2020 2020 656e  ..    """.    en
+00019a80: 7620 3d20 7b7d 0a0a 2020 2020 6465 6620  v = {}..    def 
+00019a90: 6765 745f 6772 6164 2878 3a20 5661 7269  get_grad(x: Vari
+00019aa0: 6162 6c65 293a 0a20 2020 2020 2020 2069  able):.        i
+00019ab0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
+00019ac0: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
+00019ad0: 2020 2020 2020 2023 2052 6574 7572 6e20         # Return 
+00019ae0: 4e6f 6e65 2069 6620 7468 6520 7661 7269  None if the vari
+00019af0: 6162 6c65 2077 6173 206e 6f74 2075 7365  able was not use
+00019b00: 6420 696e 2074 6865 2063 6f6d 7075 7461  d in the computa
+00019b10: 7469 6f6e 2061 6e64 0a20 2020 2020 2020  tion and.       
+00019b20: 2020 2020 2023 2068 656e 6365 206e 6f74       # hence not
+00019b30: 2069 6e20 7468 6520 656e 760a 2020 2020   in the env.    
+00019b40: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+00019b50: 6e76 2e67 6574 2878 2e6e 616d 652c 204e  nv.get(x.name, N
+00019b60: 6f6e 6529 0a20 2020 2020 2020 2065 6c73  one).        els
+00019b70: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00019b80: 6574 7572 6e20 780a 0a20 2020 2064 6566  eturn x..    def
+00019b90: 2070 7574 5f67 7261 6428 763a 2056 6172   put_grad(v: Var
+00019ba0: 6961 626c 652c 2076 616c 3a20 416e 7929  iable, val: Any)
+00019bb0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00019bc0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00019bd0: 762c 2056 6172 6961 626c 6529 3a0a 2020  v, Variable):.  
+00019be0: 2020 2020 2020 2020 2020 6966 2076 2e6e            if v.n
+00019bf0: 616d 6520 696e 2065 6e76 3a0a 2020 2020  ame in env:.    
+00019c00: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00019c10: 616c 2069 7320 4e6f 6e65 3a0a 2020 2020  al is None:.    
+00019c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c30: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+00019c40: 2020 2020 2020 2023 2041 6363 756d 756c         # Accumul
+00019c50: 6174 6520 636f 7461 6e67 656e 7473 0a20  ate cotangents. 
+00019c60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00019c70: 6e76 5b76 2e6e 616d 655d 203d 2063 6c61  nv[v.name] = cla
+00019c80: 6e67 2e61 6464 2865 6e76 5b76 2e6e 616d  ng.add(env[v.nam
+00019c90: 655d 2c20 7661 6c29 2069 6620 656e 765b  e], val) if env[
+00019ca0: 762e 6e61 6d65 5d20 6973 206e 6f74 204e  v.name] is not N
+00019cb0: 6f6e 6520 656c 7365 2076 616c 0a20 2020  one else val.   
+00019cc0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00019cd0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
+00019ce0: 656e 765b 762e 6e61 6d65 5d20 3d20 7661  env[v.name] = va
+00019cf0: 6c0a 2020 2020 2020 2020 656c 6966 2069  l.        elif i
+00019d00: 7369 6e73 7461 6e63 6528 762c 2053 6571  sinstance(v, Seq
+00019d10: 7565 6e63 6529 2061 6e64 2061 6c6c 2869  uence) and all(i
+00019d20: 7369 6e73 7461 6e63 6528 782c 2069 6e74  sinstance(x, int
+00019d30: 2920 666f 7220 7820 696e 2076 293a 0a20  ) for x in v):. 
+00019d40: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+00019d50: 4f3a 2072 656d 6f76 6520 7768 656e 2077  O: remove when w
+00019d60: 6520 6d6f 7665 2064 696d 7320 746f 206b  e move dims to k
+00019d70: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+00019d80: 2020 7061 7373 0a20 2020 2020 2020 2065    pass.        e
+00019d90: 6c69 6620 6973 696e 7374 616e 6365 2876  lif isinstance(v
+00019da0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+00019db0: 2020 2020 656e 765b 765d 203d 2076 616c      env[v] = val
+00019dc0: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00019dd0: 696e 7374 616e 6365 2876 2c20 5365 7175  instance(v, Sequ
+00019de0: 656e 6365 2920 616e 6420 7661 6c20 6973  ence) and val is
+00019df0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00019e00: 2020 2023 2062 726f 6164 6361 7374 204e     # broadcast N
+00019e10: 6f6e 6520 746f 2074 6865 2072 6967 6874  one to the right
+00019e20: 2073 6861 7065 0a20 2020 2020 2020 2020   shape.         
+00019e30: 2020 2073 6166 655f 6d61 7028 7075 745f     safe_map(put_
+00019e40: 6772 6164 2c20 762c 205b 4e6f 6e65 5d20  grad, v, [None] 
+00019e50: 2a20 6c65 6e28 7629 290a 2020 2020 2020  * len(v)).      
+00019e60: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00019e70: 6528 762c 2053 6571 7565 6e63 6529 2061  e(v, Sequence) a
+00019e80: 6e64 2069 7369 6e73 7461 6e63 6528 7661  nd isinstance(va
+00019e90: 6c2c 2053 6571 7565 6e63 6529 3a0a 2020  l, Sequence):.  
+00019ea0: 2020 2020 2020 2020 2020 7361 6665 5f6d            safe_m
+00019eb0: 6170 5f66 6c61 7428 7075 745f 6772 6164  ap_flat(put_grad
+00019ec0: 2c20 762c 2076 616c 290a 2020 2020 2020  , v, val).      
+00019ed0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00019ee0: 2020 2020 2320 536b 6970 2077 7269 7469      # Skip writi
+00019ef0: 6e67 2074 6f20 636f 6e73 7461 6e74 730a  ng to constants.
+00019f00: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00019f10: 0a0a 2020 2020 6966 2069 7369 6e73 7461  ..    if isinsta
+00019f20: 6e63 6528 696e 6974 5f63 6f74 616e 6765  nce(init_cotange
+00019f30: 6e74 732c 2053 6571 7565 6e63 6529 2061  nts, Sequence) a
+00019f40: 6e64 206c 656e 2869 6e69 745f 636f 7461  nd len(init_cota
+00019f50: 6e67 656e 7473 2920 3d3d 2031 2061 6e64  ngents) == 1 and
+00019f60: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00019f70: 7472 6163 652e 6f75 7470 7574 2c20 5365  trace.output, Se
+00019f80: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
+00019f90: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
+00019fa0: 203d 2069 6e69 745f 636f 7461 6e67 656e   = init_cotangen
+00019fb0: 7473 5b30 5d0a 2020 2020 7361 6665 5f6d  ts[0].    safe_m
+00019fc0: 6170 5f66 6c61 7428 7075 745f 6772 6164  ap_flat(put_grad
+00019fd0: 2c20 7472 6163 652e 6f75 7470 7574 2c20  , trace.output, 
+00019fe0: 696e 6974 5f63 6f74 616e 6765 6e74 7329  init_cotangents)
+00019ff0: 0a0a 2020 2020 666f 7220 7379 6d62 6f6c  ..    for symbol
+0001a000: 2069 6e20 7265 7665 7273 6564 286c 6973   in reversed(lis
+0001a010: 7428 6974 6572 5f62 6f75 6e64 5f73 796d  t(iter_bound_sym
+0001a020: 626f 6c73 2874 7261 6365 2e62 6f75 6e64  bols(trace.bound
+0001a030: 5f73 796d 626f 6c73 2929 293a 0a20 2020  _symbols))):.   
+0001a040: 2020 2020 2073 796d 626f 6c5f 6f75 7470       symbol_outp
+0001a050: 7574 203d 2073 6571 7565 6e63 6966 7928  ut = sequencify(
+0001a060: 7379 6d62 6f6c 2e6f 7574 7075 7429 0a0a  symbol.output)..
+0001a070: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
+0001a080: 7473 203d 2074 7265 655f 6d61 7028 6765  ts = tree_map(ge
+0001a090: 745f 6772 6164 2c20 7379 6d62 6f6c 5f6f  t_grad, symbol_o
+0001a0a0: 7574 7075 7429 0a20 2020 2020 2020 2023  utput).        #
+0001a0b0: 2048 6176 696e 6720 6120 7369 6e67 6c65   Having a single
+0001a0c0: 2063 6f74 616e 6765 6e74 2069 7320 6120   cotangent is a 
+0001a0d0: 636f 6d6d 6f6e 2063 6173 652c 2073 6f20  common case, so 
+0001a0e0: 7765 2066 6c61 7474 656e 2069 740a 2020  we flatten it.  
+0001a0f0: 2020 2020 2020 2320 4f74 6865 7277 6973        # Otherwis
+0001a100: 652c 2077 6520 7769 6c6c 206e 6565 6420  e, we will need 
+0001a110: 746f 2072 6577 7269 7465 2074 6865 2070  to rewrite the p
+0001a120: 756c 6c62 6163 6b20 6675 6e63 7469 6f6e  ullback function
+0001a130: 730a 2020 2020 2020 2020 636f 7461 6e67  s.        cotang
+0001a140: 656e 7473 203d 2074 7265 655f 666c 6174  ents = tree_flat
+0001a150: 7465 6e28 636f 7461 6e67 656e 7473 295b  ten(cotangents)[
+0001a160: 305d 0a20 2020 2020 2020 2072 6573 6964  0].        resid
+0001a170: 7561 6c73 203d 2066 6f72 7761 7264 5f65  uals = forward_e
+0001a180: 6e76 5b73 796d 626f 6c5f 6f75 7470 7574  nv[symbol_output
+0001a190: 5b30 5d2e 6e61 6d65 5d2e 7265 7369 6475  [0].name].residu
+0001a1a0: 616c 730a 2020 2020 2020 2020 6966 2069  als.        if i
+0001a1b0: 735f 636f 6e73 7461 6e74 5f66 6f72 5f76  s_constant_for_v
+0001a1c0: 6a70 2873 796d 626f 6c29 3a0a 2020 2020  jp(symbol):.    
+0001a1d0: 2020 2020 2020 2020 2320 5765 2063 616e          # We can
+0001a1e0: 2073 6b69 7020 7468 6520 7075 6c6c 6261   skip the pullba
+0001a1f0: 636b 2069 6620 616c 6c20 7468 6520 6172  ck if all the ar
+0001a200: 6775 6d65 6e74 7320 6172 6520 636f 6e73  guments are cons
+0001a210: 7461 6e74 0a20 2020 2020 2020 2020 2020  tant.           
+0001a220: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001a230: 2020 2069 6620 616c 6c28 636f 7461 6e67     if all(cotang
+0001a240: 656e 7420 6973 204e 6f6e 6520 666f 7220  ent is None for 
+0001a250: 636f 7461 6e67 656e 7420 696e 2063 6f74  cotangent in cot
+0001a260: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
+0001a270: 2020 2020 2020 2320 5765 2063 616e 2073        # We can s
+0001a280: 6b69 7020 7468 6520 7075 6c6c 6261 636b  kip the pullback
+0001a290: 2069 6620 7468 6520 636f 7461 6e67 656e   if the cotangen
+0001a2a0: 7420 6973 204e 6f6e 650a 2020 2020 2020  t is None.      
+0001a2b0: 2020 2020 2020 7361 6665 5f6d 6170 2870        safe_map(p
+0001a2c0: 7574 5f67 7261 642c 2073 796d 626f 6c2e  ut_grad, symbol.
+0001a2d0: 6172 6773 2c20 284e 6f6e 652c 2920 2a20  args, (None,) * 
+0001a2e0: 6c65 6e28 7379 6d62 6f6c 2e61 7267 7329  len(symbol.args)
+0001a2f0: 290a 2020 2020 2020 2020 2020 2020 636f  ).            co
+0001a300: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+0001a310: 6966 2073 796d 626f 6c2e 7379 6d2e 6964  if symbol.sym.id
+0001a320: 203d 3d20 2274 6f72 6368 2e6e 6e2e 6675   == "torch.nn.fu
+0001a330: 6e63 7469 6f6e 616c 2e64 726f 706f 7574  nctional.dropout
+0001a340: 2220 616e 6420 6e6f 7420 7379 6d62 6f6c  " and not symbol
+0001a350: 2e73 7562 7379 6d62 6f6c 733a 0a20 2020  .subsymbols:.   
+0001a360: 2020 2020 2020 2020 2023 2057 6520 6361           # We ca
+0001a370: 6e20 736b 6970 2074 6865 2070 756c 6c62  n skip the pullb
+0001a380: 6163 6b20 6966 2074 6865 2064 726f 706f  ack if the dropo
+0001a390: 7574 2070 726f 6261 6269 6c69 7479 2069  ut probability i
+0001a3a0: 7320 302e 300a 2020 2020 2020 2020 2020  s 0.0.          
+0001a3b0: 2020 2320 4173 7375 6d69 6e67 2074 6861    # Assuming tha
+0001a3c0: 7420 7468 6520 6472 6f70 6f75 7420 7379  t the dropout sy
+0001a3d0: 6d62 6f6c 2068 6173 2074 6865 2073 616d  mbol has the sam
+0001a3e0: 6520 6f75 7470 7574 2061 6e64 2061 7267  e output and arg
+0001a3f0: 756d 656e 740a 2020 2020 2020 2020 2020  ument.          
+0001a400: 2020 6173 7365 7274 2073 796d 626f 6c2e    assert symbol.
+0001a410: 6f75 7470 7574 2e6e 616d 6520 3d3d 2073  output.name == s
+0001a420: 796d 626f 6c2e 6172 6773 5b30 5d2e 6e61  ymbol.args[0].na
+0001a430: 6d65 2c20 2244 726f 706f 7574 2073 796d  me, "Dropout sym
+0001a440: 626f 6c20 6861 7320 6120 6469 6666 6572  bol has a differ
+0001a450: 656e 7420 6f75 7470 7574 2061 6e64 2061  ent output and a
+0001a460: 7267 756d 656e 7422 0a20 2020 2020 2020  rgument".       
+0001a470: 2020 2020 2069 6620 7379 6d62 6f6c 2e61       if symbol.a
+0001a480: 7267 735b 315d 203d 3d20 302e 3020 6f72  rgs[1] == 0.0 or
+0001a490: 2073 796d 626f 6c2e 6172 6773 5b32 5d20   symbol.args[2] 
+0001a4a0: 6973 2046 616c 7365 3a0a 2020 2020 2020  is False:.      
+0001a4b0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0001a4c0: 7565 0a0a 2020 2020 2020 2020 6261 636b  ue..        back
+0001a4d0: 7761 7264 203d 2062 6163 6b77 6172 645f  ward = backward_
+0001a4e0: 696d 706c 732e 6765 7428 7379 6d62 6f6c  impls.get(symbol
+0001a4f0: 2e73 796d 2e69 6429 0a20 2020 2020 2020  .sym.id).       
+0001a500: 2061 7567 5f66 6f72 7761 7264 203d 2061   aug_forward = a
+0001a510: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+0001a520: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
+0001a530: 6c2e 7379 6d2e 6964 290a 0a20 2020 2020  l.sym.id)..     
+0001a540: 2020 2069 6620 5f67 6574 5f67 7261 6466     if _get_gradf
+0001a550: 6e5f 616e 645f 6578 6563 7574 6f72 2873  n_and_executor(s
+0001a560: 796d 626f 6c29 5b30 5d20 6973 206e 6f74  ymbol)[0] is not
+0001a570: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001a580: 2020 2061 7567 5f66 6f72 7761 7264 2c20     aug_forward, 
+0001a590: 6261 636b 7761 7264 203d 206d 616b 655f  backward = make_
+0001a5a0: 6175 675f 666f 7277 6172 645f 616e 645f  aug_forward_and_
+0001a5b0: 6261 636b 7761 7264 2873 796d 626f 6c29  backward(symbol)
+0001a5c0: 0a0a 2020 2020 2020 2020 6966 2062 6163  ..        if bac
+0001a5d0: 6b77 6172 6420 6973 204e 6f6e 653a 0a20  kward is None:. 
+0001a5e0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+0001a5f0: 6e28 7379 6d62 6f6c 2e73 7562 7379 6d62  n(symbol.subsymb
+0001a600: 6f6c 7329 203e 2030 2061 6e64 206e 6f74  ols) > 0 and not
+0001a610: 2069 7369 6e73 7461 6e63 6528 7379 6d62   isinstance(symb
+0001a620: 6f6c 2e73 796d 2e69 642c 2070 7269 6d73  ol.sym.id, prims
+0001a630: 2e50 7269 6d49 4473 293a 0a20 2020 2020  .PrimIDs):.     
+0001a640: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
+0001a650: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
+0001a660: 2062 6163 6b77 6172 6420 666f 7220 7468   backward for th
+0001a670: 6973 2073 796d 626f 6c2c 2073 6f20 7765  is symbol, so we
+0001a680: 2074 7279 2074 6f20 6465 636f 6d70 6f73   try to decompos
+0001a690: 6520 6974 0a20 2020 2020 2020 2020 2020  e it.           
+0001a6a0: 2020 2020 2062 6163 6b77 6172 6420 3d20       backward = 
+0001a6b0: 7061 7274 6961 6c28 6465 636f 6d70 6f73  partial(decompos
+0001a6c0: 6564 5f66 6e5f 6261 636b 7761 7264 5f72  ed_fn_backward_r
+0001a6d0: 756c 652c 2073 796d 626f 6c2e 7379 6d29  ule, symbol.sym)
+0001a6e0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001a6f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001a700: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
+0001a710: 7420 6669 6e64 2061 2062 6163 6b77 6172  t find a backwar
+0001a720: 6420 666f 7220 7468 6973 2073 796d 626f  d for this symbo
+0001a730: 6c20 616e 6420 7765 2063 6f75 6c64 206e  l and we could n
+0001a740: 6f74 2064 6563 6f6d 706f 7365 2069 740a  ot decompose it.
+0001a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a760: 7261 6973 6520 4e6f 7449 6d70 6c65 6d65  raise NotImpleme
+0001a770: 6e74 6564 4572 726f 7228 6622 4261 636b  ntedError(f"Back
+0001a780: 7761 7264 2066 6f72 207b 7379 6d62 6f6c  ward for {symbol
+0001a790: 2e73 796d 2e69 647d 2069 7320 6e6f 7420  .sym.id} is not 
+0001a7a0: 696d 706c 656d 656e 7465 6422 290a 0a20  implemented").. 
+0001a7b0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0001a7c0: 6261 636b 7761 7264 282a 7265 7369 6475  backward(*residu
+0001a7d0: 616c 732c 202a 636f 7461 6e67 656e 7473  als, *cotangents
+0001a7e0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
+0001a7f0: 6e73 7461 6e63 6528 7265 7375 6c74 2c20  nstance(result, 
+0001a800: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+0001a810: 2020 2023 2049 6620 7468 6520 6261 636b     # If the back
+0001a820: 7761 7264 2072 6574 7572 6e73 2061 2064  ward returns a d
+0001a830: 6963 742c 2077 6520 6173 7375 6d65 2074  ict, we assume t
+0001a840: 6861 7420 6974 2069 7320 6120 6469 6374  hat it is a dict
+0001a850: 206f 660a 2020 2020 2020 2020 2020 2020   of.            
+0001a860: 2320 666f 7277 6172 6420 6172 6775 6d65  # forward argume
+0001a870: 6e74 7320 746f 2074 6865 2063 6f72 7265  nts to the corre
+0001a880: 7370 6f6e 6469 6e67 0a20 2020 2020 2020  sponding.       
+0001a890: 2020 2020 2023 2067 7261 6469 656e 7473       # gradients
+0001a8a0: 2f63 6f74 616e 6765 6e74 732f 6164 6a6f  /cotangents/adjo
+0001a8b0: 696e 7473 2f73 656e 7369 7469 7669 7469  ints/sensitiviti
+0001a8c0: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+0001a8d0: 7573 6564 5f6e 616d 6573 203d 2073 6574  used_names = set
+0001a8e0: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
+0001a8f0: 6f72 2069 2c20 286b 2c20 7629 2069 6e20  or i, (k, v) in 
+0001a900: 656e 756d 6572 6174 6528 696e 7370 6563  enumerate(inspec
+0001a910: 742e 7369 676e 6174 7572 6528 6175 675f  t.signature(aug_
+0001a920: 666f 7277 6172 6429 2e70 6172 616d 6574  forward).paramet
+0001a930: 6572 732e 6974 656d 7328 2929 3a0a 2020  ers.items()):.  
+0001a940: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001a950: 2076 2e6b 696e 6420 696e 2028 696e 7370   v.kind in (insp
+0001a960: 6563 742e 5061 7261 6d65 7465 722e 504f  ect.Parameter.PO
+0001a970: 5349 5449 4f4e 414c 5f4f 4e4c 592c 2069  SITIONAL_ONLY, i
+0001a980: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
+0001a990: 2e50 4f53 4954 494f 4e41 4c5f 4f52 5f4b  .POSITIONAL_OR_K
+0001a9a0: 4559 574f 5244 293a 0a20 2020 2020 2020  EYWORD):.       
+0001a9b0: 2020 2020 2020 2020 2020 2020 2070 7574               put
+0001a9c0: 5f67 7261 6428 7379 6d62 6f6c 2e61 7267  _grad(symbol.arg
+0001a9d0: 735b 695d 2c20 7265 7375 6c74 2e67 6574  s[i], result.get
+0001a9e0: 286b 2c20 4e6f 6e65 2929 0a20 2020 2020  (k, None)).     
+0001a9f0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0001aa00: 7365 645f 6e61 6d65 732e 6164 6428 6b29  sed_names.add(k)
+0001aa10: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0001aa20: 466f 7220 6465 7665 6c6f 7065 7220 636f  For developer co
+0001aa30: 6e76 656e 6965 6e63 652c 2077 6520 616c  nvenience, we al
+0001aa40: 6c6f 7720 7573 696e 6720 7468 6520 6e61  low using the na
+0001aa50: 6d65 2066 726f 6d20 7468 650a 2020 2020  me from the.    
+0001aa60: 2020 2020 2020 2020 2320 666f 7277 6172          # forwar
+0001aa70: 6420 6d65 7461 2069 6e20 6164 6469 7469  d meta in additi
+0001aa80: 6f6e 2074 6f20 7468 6520 6e61 6d65 2066  on to the name f
+0001aa90: 726f 6d20 7468 6520 6175 676d 656e 7465  rom the augmente
+0001aaa0: 6420 666f 7277 6172 640a 2020 2020 2020  d forward.      
+0001aab0: 2020 2020 2020 2320 7369 676e 6174 7572        # signatur
+0001aac0: 652e 0a20 2020 2020 2020 2020 2020 2023  e..            #
+0001aad0: 2049 6620 626f 7468 206e 616d 6573 2061   If both names a
+0001aae0: 7265 2075 7365 642c 2074 6865 206f 6e65  re used, the one
+0001aaf0: 2066 726f 6d20 7468 6520 666f 7277 6172   from the forwar
+0001ab00: 6420 6d65 7461 2074 616b 6573 0a20 2020  d meta takes.   
+0001ab10: 2020 2020 2020 2020 2023 2070 7265 6365           # prece
+0001ab20: 6465 6e63 652e 0a20 2020 2020 2020 2020  dence..         
+0001ab30: 2020 2066 6f72 2069 2c20 286b 2c20 7629     for i, (k, v)
+0001ab40: 2069 6e20 656e 756d 6572 6174 6528 696e   in enumerate(in
+0001ab50: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
+0001ab60: 7379 6d62 6f6c 2e73 796d 2e6d 6574 6129  symbol.sym.meta)
+0001ab70: 2e70 6172 616d 6574 6572 732e 6974 656d  .parameters.item
+0001ab80: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+0001ab90: 2020 2020 2020 6966 2076 2e6b 696e 6420        if v.kind 
+0001aba0: 696e 2028 696e 7370 6563 742e 5061 7261  in (inspect.Para
+0001abb0: 6d65 7465 722e 504f 5349 5449 4f4e 414c  meter.POSITIONAL
+0001abc0: 5f4f 4e4c 592c 2069 6e73 7065 6374 2e50  _ONLY, inspect.P
+0001abd0: 6172 616d 6574 6572 2e50 4f53 4954 494f  arameter.POSITIO
+0001abe0: 4e41 4c5f 4f52 5f4b 4559 574f 5244 293a  NAL_OR_KEYWORD):
+0001abf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ac00: 2020 2020 2069 6620 6b20 6e6f 7420 696e       if k not in
+0001ac10: 2075 7365 645f 6e61 6d65 733a 0a20 2020   used_names:.   
+0001ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac30: 2020 2020 2070 7574 5f67 7261 6428 7379       put_grad(sy
+0001ac40: 6d62 6f6c 2e61 7267 735b 695d 2c20 7265  mbol.args[i], re
+0001ac50: 7375 6c74 2e67 6574 286b 2c20 4e6f 6e65  sult.get(k, None
+0001ac60: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
+0001ac70: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0001ac80: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+0001ac90: 6365 2872 6573 756c 742c 2053 6571 7565  ce(result, Seque
+0001aca0: 6e63 6529 3a0a 2020 2020 2020 2020 2020  nce):.          
+0001acb0: 2020 7265 7375 6c74 203d 2028 7265 7375    result = (resu
+0001acc0: 6c74 2c29 0a0a 2020 2020 2020 2020 6465  lt,)..        de
+0001acd0: 6620 6973 5f64 6966 6665 7265 6e74 6961  f is_differentia
+0001ace0: 626c 6528 6172 6729 3a0a 2020 2020 2020  ble(arg):.      
+0001acf0: 2020 2020 2020 6d61 7463 6820 6172 673a        match arg:
+0001ad00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ad10: 2063 6173 6520 5465 6e73 6f72 5072 6f78   case TensorProx
+0001ad20: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+0001ad30: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001ad40: 6474 7970 6573 2e69 735f 696e 6578 6163  dtypes.is_inexac
+0001ad50: 745f 6474 7970 6528 6172 672e 6474 7970  t_dtype(arg.dtyp
+0001ad60: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001ad70: 2020 2063 6173 6520 5365 7175 656e 6365     case Sequence
+0001ad80: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001ad90: 2020 2020 2020 2020 7265 7475 726e 2061          return a
+0001ada0: 7267 2061 6e64 2061 6c6c 2869 7369 6e73  rg and all(isins
+0001adb0: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
+0001adc0: 726f 7879 2920 616e 6420 6474 7970 6573  roxy) and dtypes
+0001add0: 2e69 735f 696e 6578 6163 745f 6474 7970  .is_inexact_dtyp
+0001ade0: 6528 782e 6474 7970 6529 2066 6f72 2078  e(x.dtype) for x
+0001adf0: 2069 6e20 6172 6729 0a20 2020 2020 2020   in arg).       
+0001ae00: 2020 2020 2020 2020 2063 6173 6520 5f3a           case _:
+0001ae10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ae20: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0001ae30: 650a 0a20 2020 2020 2020 2069 6620 6c65  e..        if le
+0001ae40: 6e28 7379 6d62 6f6c 2e61 7267 7329 2021  n(symbol.args) !
+0001ae50: 3d20 286f 7269 675f 7265 735f 6c65 6e20  = (orig_res_len 
+0001ae60: 3a3d 206c 656e 2872 6573 756c 7429 293a  := len(result)):
+0001ae70: 0a20 2020 2020 2020 2020 2020 2063 6865  .            che
+0001ae80: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+0001ae90: 2020 2020 6f72 6967 5f72 6573 5f6c 656e      orig_res_len
+0001aea0: 203c 3d20 6c65 6e28 7379 6d62 6f6c 2e61   <= len(symbol.a
+0001aeb0: 7267 7329 2c0a 2020 2020 2020 2020 2020  rgs),.          
+0001aec0: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+0001aed0: 4261 636b 7761 7264 2066 6f72 207b 7379  Backward for {sy
+0001aee0: 6d62 6f6c 2e73 796d 2e69 647d 2072 6574  mbol.sym.id} ret
+0001aef0: 7572 6e65 6420 7b6f 7269 675f 7265 735f  urned {orig_res_
+0001af00: 6c65 6e7d 2076 616c 7565 732c 2022 0a20  len} values, ". 
+0001af10: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0001af20: 2066 2262 7574 2065 7870 6563 7465 6420   f"but expected 
+0001af30: 6174 206d 6f73 7420 7b6c 656e 2873 796d  at most {len(sym
+0001af40: 626f 6c2e 6172 6773 297d 222c 0a20 2020  bol.args)}",.   
+0001af50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001af60: 2020 2020 2020 2023 2041 7373 756d 696e         # Assumin
+0001af70: 6720 7468 6174 2074 6865 206e 6f6e 2d64  g that the non-d
+0001af80: 6966 6665 7265 6e74 6961 626c 6520 6172  ifferentiable ar
+0001af90: 6775 6d65 6e74 7320 7765 7265 2064 726f  guments were dro
+0001afa0: 7070 6564 2066 726f 6d0a 2020 2020 2020  pped from.      
+0001afb0: 2020 2020 2020 2320 7468 6520 6261 636b        # the back
+0001afc0: 7761 7264 2066 756e 6374 696f 6e2c 2077  ward function, w
+0001afd0: 6520 6172 6520 676f 696e 6720 746f 2061  e are going to a
+0001afe0: 7070 656e 6420 4e6f 6e65 2074 6f20 7468  ppend None to th
+0001aff0: 6520 7265 7375 6c74 0a20 2020 2020 2020  e result.       
+0001b000: 2020 2020 2023 2074 6f20 6d61 7463 6820       # to match 
+0001b010: 7468 6520 6e75 6d62 6572 206f 6620 6172  the number of ar
+0001b020: 6775 6d65 6e74 732e 2041 6c74 6572 6e61  guments. Alterna
+0001b030: 7469 7665 6c79 2c20 7765 2063 6f75 6c64  tively, we could
+0001b040: 206a 7573 740a 2020 2020 2020 2020 2020   just.          
+0001b050: 2020 2320 6861 7665 2061 2066 6f72 2d6c    # have a for-l
+0001b060: 6f6f 7020 7769 7468 2061 2063 6f6e 6469  oop with a condi
+0001b070: 7469 6f6e 616c 2077 6865 6e20 7772 6974  tional when writ
+0001b080: 696e 6720 746f 2074 6865 0a20 2020 2020  ing to the.     
+0001b090: 2020 2020 2020 2023 2065 6e76 6972 6f6e         # environ
+0001b0a0: 6d65 6e74 2e0a 0a20 2020 2020 2020 2020  ment...         
+0001b0b0: 2020 2069 7465 725f 7265 7375 6c74 203d     iter_result =
+0001b0c0: 2069 7465 7228 7265 7375 6c74 290a 2020   iter(result).  
+0001b0d0: 2020 2020 2020 2020 2020 6e5f 6469 6666            n_diff
+0001b0e0: 6572 656e 7469 6162 6c65 5f61 7267 7320  erentiable_args 
+0001b0f0: 3d20 7375 6d28 626f 6f6c 2869 735f 6469  = sum(bool(is_di
+0001b100: 6666 6572 656e 7469 6162 6c65 2861 7267  fferentiable(arg
+0001b110: 2929 2066 6f72 2061 7267 2069 6e20 7379  )) for arg in sy
+0001b120: 6d62 6f6c 2e61 7267 7329 0a20 2020 2020  mbol.args).     
+0001b130: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
+0001b140: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+0001b150: 6469 6666 6572 656e 7469 6162 6c65 5f61  differentiable_a
+0001b160: 7267 7320 3c3d 206f 7269 675f 7265 735f  rgs <= orig_res_
+0001b170: 6c65 6e2c 0a20 2020 2020 2020 2020 2020  len,.           
+0001b180: 2020 2020 206c 616d 6264 613a 2066 2242       lambda: f"B
+0001b190: 6163 6b77 6172 6420 666f 7220 7b73 796d  ackward for {sym
+0001b1a0: 626f 6c2e 7379 6d2e 6964 7d20 7265 7475  bol.sym.id} retu
+0001b1b0: 726e 6564 207b 6f72 6967 5f72 6573 5f6c  rned {orig_res_l
+0001b1c0: 656e 7d20 7661 6c75 6528 7329 2c20 220a  en} value(s), ".
+0001b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1e0: 2b20 6622 6275 7420 6578 7065 6374 6564  + f"but expected
+0001b1f0: 207b 6e5f 6469 6666 6572 656e 7469 6162   {n_differentiab
+0001b200: 6c65 5f61 7267 737d 222c 0a20 2020 2020  le_args}",.     
+0001b210: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0001b220: 2020 2020 2020 7265 7375 6c74 203d 2074        result = t
+0001b230: 7570 6c65 286e 6578 7428 6974 6572 5f72  uple(next(iter_r
+0001b240: 6573 756c 7429 2069 6620 6973 5f64 6966  esult) if is_dif
+0001b250: 6665 7265 6e74 6961 626c 6528 6172 6729  ferentiable(arg)
+0001b260: 2065 6c73 6520 4e6f 6e65 2066 6f72 2061   else None for a
+0001b270: 7267 2069 6e20 7379 6d62 6f6c 2e61 7267  rg in symbol.arg
+0001b280: 7329 0a0a 2020 2020 2020 2020 2320 5365  s)..        # Se
+0001b290: 6520 2242 6163 6b77 6172 6420 696d 706c  e "Backward impl
+0001b2a0: 2066 6f72 206f 7073 206f 6620 7468 6520   for ops of the 
+0001b2b0: 7479 7065 2053 6571 7565 6e63 655b 5465  type Sequence[Te
+0001b2c0: 6e73 6f72 5072 6f78 795d 2c20 2e2e 2e20  nsorProxy], ... 
+0001b2d0: 2d3e 202e 2e2e 2072 6573 756c 7473 2069  -> ... results i
+0001b2e0: 6e20 4e6f 6e65 2067 7261 6473 2e22 0a20  n None grads.". 
+0001b2f0: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
+0001b300: 2061 2074 656d 706f 7261 7279 2077 6f72   a temporary wor
+0001b310: 6b61 726f 756e 642e 0a20 2020 2020 2020  karound..       
+0001b320: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
+0001b330: 6420 696e 2028 7072 696d 732e 5072 696d  d in (prims.Prim
+0001b340: 4944 732e 4341 542c 2022 746f 7263 682e  IDs.CAT, "torch.
+0001b350: 6361 7422 2c20 2274 6f72 6368 2e73 7461  cat", "torch.sta
+0001b360: 636b 2229 3a0a 2020 2020 2020 2020 2020  ck"):.          
+0001b370: 2020 7361 6665 5f6d 6170 5f66 6c61 7428    safe_map_flat(
+0001b380: 7075 745f 6772 6164 2c20 7379 6d62 6f6c  put_grad, symbol
+0001b390: 2e61 7267 732c 2072 6573 756c 7429 0a20  .args, result). 
+0001b3a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001b3b0: 2020 2020 2020 2020 2073 6166 655f 6d61           safe_ma
+0001b3c0: 7028 7075 745f 6772 6164 2c20 7379 6d62  p(put_grad, symb
+0001b3d0: 6f6c 2e61 7267 732c 2072 6573 756c 7429  ol.args, result)
+0001b3e0: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
+0001b3f0: 6578 6163 745f 6474 7970 655f 6f72 5f6e  exact_dtype_or_n
+0001b400: 6f6e 6528 7829 3a0a 2020 2020 2020 2020  one(x):.        
+0001b410: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001b420: 2028 5465 6e73 6f72 5072 6f78 792c 2046   (TensorProxy, F
+0001b430: 7574 7572 6554 656e 736f 7250 726f 7879  utureTensorProxy
+0001b440: 2929 2061 6e64 2064 7479 7065 732e 6973  )) and dtypes.is
+0001b450: 5f69 6e65 7861 6374 5f64 7479 7065 2878  _inexact_dtype(x
+0001b460: 2e64 7479 7065 293a 0a20 2020 2020 2020  .dtype):.       
+0001b470: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
+0001b480: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001b490: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0001b4a0: 6f6e 650a 0a20 2020 2067 6172 6773 203d  one..    gargs =
+0001b4b0: 2074 7265 655f 6d61 7028 6765 745f 6772   tree_map(get_gr
+0001b4c0: 6164 2c20 7475 706c 6528 7472 6163 652e  ad, tuple(trace.
+0001b4d0: 6172 6773 2929 0a20 2020 2067 6b77 6172  args)).    gkwar
+0001b4e0: 6773 203d 2074 7265 655f 6d61 7028 6765  gs = tree_map(ge
+0001b4f0: 745f 6772 6164 2c20 7472 6163 652e 6b77  t_grad, trace.kw
+0001b500: 6172 6773 290a 2020 2020 676b 7761 7267  args).    gkwarg
+0001b510: 7320 3d20 7b6b 3a20 7620 666f 7220 6b2c  s = {k: v for k,
+0001b520: 2076 2069 6e20 676b 7761 7267 732e 6974   v in gkwargs.it
+0001b530: 656d 7328 2920 6966 2076 2069 7320 6e6f  ems() if v is no
+0001b540: 7420 4e6f 6e65 7d0a 2020 2020 6761 7267  t None}.    garg
+0001b550: 732c 2067 6b77 6172 6773 203d 2074 7265  s, gkwargs = tre
+0001b560: 655f 6d61 7028 6765 745f 696e 6578 6163  e_map(get_inexac
+0001b570: 745f 6474 7970 655f 6f72 5f6e 6f6e 652c  t_dtype_or_none,
+0001b580: 2028 6761 7267 732c 2067 6b77 6172 6773   (gargs, gkwargs
+0001b590: 2929 0a20 2020 2072 6574 7572 6e20 6761  )).    return ga
+0001b5a0: 7267 7320 2b20 2867 6b77 6172 6773 2c29  rgs + (gkwargs,)
+0001b5b0: 2069 6620 6c65 6e28 676b 7761 7267 7329   if len(gkwargs)
+0001b5c0: 2021 3d20 3020 656c 7365 2067 6172 6773   != 0 else gargs
+0001b5d0: 0a0a 0a64 6566 2076 6a70 5f63 616c 6c5f  ...def vjp_call_
+0001b5e0: 6d65 7461 6675 6e63 2864 6574 6163 6865  metafunc(detache
+0001b5f0: 643a 2062 6f6f 6c2c 2070 7269 6d61 6c73  d: bool, primals
+0001b600: 2c20 636f 7461 6e67 656e 7473 2c20 7472  , cotangents, tr
+0001b610: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+0001b620: 6172 6773 293a 0a20 2020 2023 2041 7373  args):.    # Ass
+0001b630: 756d 696e 6720 7072 696d 616c 7320 6973  uming primals is
+0001b640: 2066 6c61 740a 0a20 2020 2069 6620 6e6f   flat..    if no
+0001b650: 7420 6973 696e 7374 616e 6365 2870 7269  t isinstance(pri
+0001b660: 6d61 6c73 2c20 5365 7175 656e 6365 293a  mals, Sequence):
+0001b670: 0a20 2020 2020 2020 2070 7269 6d61 6c73  .        primals
+0001b680: 203d 2028 7072 696d 616c 732c 290a 0a20   = (primals,).. 
+0001b690: 2020 2063 7478 203d 2064 6574 6163 6865     ctx = detache
+0001b6a0: 645f 7472 6163 6528 2920 6966 2064 6574  d_trace() if det
+0001b6b0: 6163 6865 6420 656c 7365 206e 756c 6c63  ached else nullc
+0001b6c0: 6f6e 7465 7874 2829 0a20 2020 2077 6974  ontext().    wit
+0001b6d0: 6820 6374 783a 0a20 2020 2020 2020 2072  h ctx:.        r
+0001b6e0: 6573 756c 742c 2065 6e76 203d 2061 7567  esult, env = aug
+0001b6f0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f70  mented_forward_p
+0001b700: 6173 7328 2a70 7269 6d61 6c73 2c20 7472  ass(*primals, tr
+0001b710: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
+0001b720: 7267 7329 0a20 2020 2020 2020 2063 6865  rgs).        che
+0001b730: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+0001b740: 6c65 6e28 7265 7375 6c74 2920 3d3d 206c  len(result) == l
+0001b750: 656e 2863 6f74 616e 6765 6e74 7329 2069  en(cotangents) i
+0001b760: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
+0001b770: 756c 742c 2053 6571 7565 6e63 6529 2065  ult, Sequence) e
+0001b780: 6c73 6520 5472 7565 2c0a 2020 2020 2020  lse True,.      
+0001b790: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+0001b7a0: 4578 7065 6374 6564 2063 6f74 616e 6765  Expected cotange
+0001b7b0: 6e74 7320 746f 2062 6520 6120 7365 7175  nts to be a sequ
+0001b7c0: 656e 6365 206f 6620 6c65 6e67 7468 207b  ence of length {
+0001b7d0: 6c65 6e28 7265 7375 6c74 297d 2c20 676f  len(result)}, go
+0001b7e0: 7420 6120 7365 7175 656e 6365 206f 6620  t a sequence of 
+0001b7f0: 6c65 6e67 7468 207b 6c65 6e28 636f 7461  length {len(cota
+0001b800: 6e67 656e 7473 297d 222c 0a20 2020 2020  ngents)}",.     
+0001b810: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+0001b820: 7572 6e20 7265 7375 6c74 2c20 6261 636b  urn result, back
+0001b830: 7761 7264 5f70 6173 7328 656e 762c 2074  ward_pass(env, t
+0001b840: 7261 6365 2c20 636f 7461 6e67 656e 7473  race, cotangents
+0001b850: 290a 0a0a 2320 544f 444f 3a20 4361 6e27  )...# TODO: Can'
+0001b860: 7420 7573 6520 6120 5379 6d62 6f6c 2068  t use a Symbol h
+0001b870: 6572 6520 6265 6361 7573 6520 6d69 7865  ere because mixe
+0001b880: 6420 6578 6563 7574 6f72 2073 7962 7379  d executor sybsy
+0001b890: 6d62 6f6c 7320 7365 656d 2074 6f20 6265  mbols seem to be
+0001b8a0: 0a23 2075 6e73 7570 706f 7274 6564 2e20  .# unsupported. 
+0001b8b0: 5365 6520 6973 7375 6520 2243 6f75 6c64  See issue "Could
+0001b8c0: 206e 6f74 2066 696e 6420 616e 2065 7865   not find an exe
+0001b8d0: 6375 746f 7220 666f 7220 626f 756e 6420  cutor for bound 
+0001b8e0: 7379 6d62 6f6c 2077 6865 6e20 6974 7320  symbol when its 
+0001b8f0: 7375 6273 796d 626f 6c73 0a23 2061 7265  subsymbols.# are
+0001b900: 206e 6f74 2066 756c 6c79 2073 7570 706f   not fully suppo
+0001b910: 7274 6564 2062 7920 6120 7369 6e67 6c65  rted by a single
+0001b920: 2065 7865 6375 746f 7222 0a76 6a70 5f63   executor".vjp_c
+0001b930: 616c 6c20 3d20 7061 7274 6961 6c28 0a20  all = partial(. 
+0001b940: 2020 2076 6a70 5f63 616c 6c5f 6d65 7461     vjp_call_meta
+0001b950: 6675 6e63 2c20 4661 6c73 650a 2920 2023  func, False.)  #
+0001b960: 2053 796d 626f 6c28 6964 3d54 7261 6e73   Symbol(id=Trans
+0001b970: 666f 726d 732e 566a 704f 702c 206e 616d  forms.VjpOp, nam
+0001b980: 653d 2276 6a70 5f63 616c 6c22 2c20 6d65  e="vjp_call", me
+0001b990: 7461 3d70 6172 7469 616c 2876 6a70 5f63  ta=partial(vjp_c
+0001b9a0: 616c 6c5f 6d65 7461 6675 6e63 2c20 4661  all_metafunc, Fa
+0001b9b0: 6c73 6529 290a 0a0a 6465 6620 766a 7028  lse))...def vjp(
+0001b9c0: 6675 6e63 293a 0a20 2020 2022 2222 436f  func):.    """Co
+0001b9d0: 6d70 7574 6573 2074 6865 2056 4a50 206f  mputes the VJP o
+0001b9e0: 6620 6120 6675 6e63 7469 6f6e 2e0a 0a20  f a function... 
+0001b9f0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0001ba00: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
+0001ba10: 3a20 4675 6e63 7469 6f6e 2074 6f20 6265  : Function to be
+0001ba20: 2064 6966 6665 7265 6e74 6961 7465 642e   differentiated.
+0001ba30: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+0001ba40: 6620 5f76 6a70 2870 7269 6d61 6c73 2c20  f _vjp(primals, 
+0001ba50: 636f 7461 6e67 656e 7473 2c20 2a2a 6b77  cotangents, **kw
+0001ba60: 6172 6773 293a 0a20 2020 2020 2020 2066  args):.        f
+0001ba70: 6c61 745f 6675 6e63 2c20 666c 6174 5f61  lat_func, flat_a
+0001ba80: 7267 732c 2073 7065 6320 3d20 666c 6174  rgs, spec = flat
+0001ba90: 7465 6e5f 6675 6e63 2866 756e 632c 2070  ten_func(func, p
+0001baa0: 7269 6d61 6c73 2c20 6b77 6172 6773 290a  rimals, kwargs).
+0001bab0: 2020 2020 2020 2020 7472 6163 6520 3d20          trace = 
+0001bac0: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+0001bad0: 2928 666c 6174 5f66 756e 632c 202a 666c  )(flat_func, *fl
+0001bae0: 6174 5f61 7267 7329 0a20 2020 2020 2020  at_args).       
+0001baf0: 2072 6573 756c 742c 2076 6a70 5f72 6573   result, vjp_res
+0001bb00: 756c 7420 3d20 766a 705f 6361 6c6c 2866  ult = vjp_call(f
+0001bb10: 6c61 745f 6172 6773 2c20 636f 7461 6e67  lat_args, cotang
+0001bb20: 656e 7473 2c20 7472 6163 653d 7472 6163  ents, trace=trac
+0001bb30: 6529 0a20 2020 2020 2020 2067 7072 696d  e).        gprim
+0001bb40: 616c 732c 2067 6b77 6172 6773 203d 2074  als, gkwargs = t
+0001bb50: 7265 655f 756e 666c 6174 7465 6e28 766a  ree_unflatten(vj
+0001bb60: 705f 7265 7375 6c74 2c20 7370 6563 290a  p_result, spec).
+0001bb70: 2020 2020 2020 2020 6772 6164 7320 3d20          grads = 
+0001bb80: 6770 7269 6d61 6c73 202b 2028 676b 7761  gprimals + (gkwa
+0001bb90: 7267 732c 2920 6966 206c 656e 2867 6b77  rgs,) if len(gkw
+0001bba0: 6172 6773 2920 213d 2030 2065 6c73 6520  args) != 0 else 
+0001bbb0: 6770 7269 6d61 6c73 0a20 2020 2020 2020  gprimals.       
+0001bbc0: 2072 6574 7572 6e20 7265 7375 6c74 2c20   return result, 
+0001bbd0: 6772 6164 730a 0a20 2020 2072 6574 7572  grads..    retur
+0001bbe0: 6e20 5f76 6a70 0a0a 0a64 6566 2076 616c  n _vjp...def val
+0001bbf0: 7565 5f61 6e64 5f67 7261 6428 6675 6e63  ue_and_grad(func
+0001bc00: 293a 0a20 2020 2022 2222 436f 6d70 7574  ):.    """Comput
+0001bc10: 6573 2074 6865 2076 616c 7565 2061 6e64  es the value and
+0001bc20: 2067 7261 6469 656e 7420 6f66 2061 2066   gradient of a f
+0001bc30: 756e 6374 696f 6e2e 0a0a 2020 2020 5468  unction...    Th
+0001bc40: 6973 2069 7320 6120 636f 6e76 656e 6965  is is a convenie
+0001bc50: 6e63 6520 6675 6e63 7469 6f6e 2074 6861  nce function tha
+0001bc60: 7420 636f 6d62 696e 6573 2074 6865 2066  t combines the f
+0001bc70: 756e 6374 696f 6e61 6c69 7479 206f 660a  unctionality of.
+0001bc80: 2020 2020 6076 6a70 5f63 616c 6c60 2077      `vjp_call` w
+0001bc90: 6974 6820 696d 706c 6963 6974 2069 6e69  ith implicit ini
+0001bca0: 7469 616c 697a 6174 696f 6e20 6f66 2074  tialization of t
+0001bcb0: 6865 2063 6f74 616e 6765 6e74 2074 6f20  he cotangent to 
+0001bcc0: 312e 0a0a 2020 2020 4172 6773 3a0a 2020  1...    Args:.  
+0001bcd0: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
+0001bce0: 6162 6c65 293a 2046 756e 6374 696f 6e20  able): Function 
+0001bcf0: 746f 2062 6520 6469 6666 6572 656e 7469  to be differenti
+0001bd00: 6174 6564 2e0a 2020 2020 2222 220a 0a20  ated..    """.. 
+0001bd10: 2020 2064 6566 206f 6e65 735f 6c69 6b65     def ones_like
+0001bd20: 2878 293a 0a20 2020 2020 2020 2069 6620  (x):.        if 
+0001bd30: 6973 696e 7374 616e 6365 2878 2c20 5465  isinstance(x, Te
+0001bd40: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
+0001bd50: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001bd60: 756c 6c5f 6c69 6b65 2878 2c20 6669 6c6c  ull_like(x, fill
+0001bd70: 5f76 616c 7565 3d31 290a 2020 2020 2020  _value=1).      
+0001bd80: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+0001bd90: 6528 782c 204e 756d 6265 7250 726f 7879  e(x, NumberProxy
+0001bda0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0001bdb0: 6574 7572 6e20 7479 7065 2878 2e76 616c  eturn type(x.val
+0001bdc0: 7565 2928 3129 0a20 2020 2020 2020 2065  ue)(1).        e
+0001bdd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001bde0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+0001bdf0: 2020 6465 6620 5f76 616c 7565 5f61 6e64    def _value_and
+0001be00: 5f67 7261 6428 2a61 7267 732c 202a 2a6b  _grad(*args, **k
+0001be10: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+0001be20: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
+0001be30: 745f 7472 6163 6528 2928 6675 6e63 2c20  t_trace()(func, 
+0001be40: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0001be50: 0a20 2020 2020 2020 2063 6f74 616e 6765  .        cotange
+0001be60: 6e74 7320 3d20 7472 6565 5f6d 6170 286c  nts = tree_map(l
+0001be70: 616d 6264 6120 763a 206f 6e65 735f 6c69  ambda v: ones_li
+0001be80: 6b65 2876 292c 2074 7261 6365 2e6f 7574  ke(v), trace.out
+0001be90: 7075 7429 0a20 2020 2020 2020 2072 6574  put).        ret
+0001bea0: 7572 6e20 766a 7028 6675 6e63 2928 6172  urn vjp(func)(ar
+0001beb0: 6773 2c20 636f 7461 6e67 656e 7473 2c20  gs, cotangents, 
+0001bec0: 2a2a 6b77 6172 6773 290a 0a20 2020 2072  **kwargs)..    r
+0001bed0: 6574 7572 6e20 5f76 616c 7565 5f61 6e64  eturn _value_and
+0001bee0: 5f67 7261 640a 0a0a 466f 7277 6172 6442  _grad...ForwardB
+0001bef0: 6163 6b77 6172 6454 7261 6365 7320 3d20  ackwardTraces = 
+0001bf00: 6e61 6d65 6474 7570 6c65 2822 466f 7277  namedtuple("Forw
+0001bf10: 6172 6442 6163 6b77 6172 6454 7261 6365  ardBackwardTrace
+0001bf20: 7322 2c20 5b22 666f 7277 6172 645f 7472  s", ["forward_tr
+0001bf30: 6163 6522 2c20 2262 6163 6b77 6172 645f  ace", "backward_
+0001bf40: 7472 6163 6522 5d29 0a0a 0a64 6566 205f  trace"])...def _
+0001bf50: 7370 6c69 745f 7361 7665 645f 666f 725f  split_saved_for_
+0001bf60: 6261 636b 7761 7264 5f69 6e74 6f5f 7465  backward_into_te
+0001bf70: 6e73 6f72 735f 616e 645f 6f74 6865 7228  nsors_and_other(
+0001bf80: 0a20 2020 2073 6176 6564 5f66 6f72 5f62  .    saved_for_b
+0001bf90: 6163 6b77 6172 643a 2053 6571 7565 6e63  ackward: Sequenc
+0001bfa0: 655b 5661 7269 6162 6c65 5d2c 0a29 202d  e[Variable],.) -
+0001bfb0: 3e20 7475 706c 655b 5365 7175 656e 6365  > tuple[Sequence
+0001bfc0: 5b56 6172 6961 626c 655d 2c20 5365 7175  [Variable], Sequ
+0001bfd0: 656e 6365 5b56 6172 6961 626c 655d 5d3a  ence[Variable]]:
+0001bfe0: 0a20 2020 2022 2222 5370 6c69 7473 2073  .    """Splits s
+0001bff0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001c000: 6420 696e 746f 2074 656e 736f 7273 2061  d into tensors a
+0001c010: 6e64 206f 7468 6572 2e0a 0a20 2020 2041  nd other...    A
+0001c020: 7267 733a 0a20 2020 2020 2020 2073 6176  rgs:.        sav
+0001c030: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+0001c040: 2853 6571 7565 6e63 655b 5661 7269 6162  (Sequence[Variab
+0001c050: 6c65 5d29 3a20 5361 7665 645f 666f 725f  le]): Saved_for_
+0001c060: 6261 636b 7761 7264 2074 6f20 7370 6c69  backward to spli
+0001c070: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
+0001c080: 0a20 2020 2020 2020 2074 7570 6c65 5b53  .        tuple[S
+0001c090: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
+0001c0a0: 5d2c 2053 6571 7565 6e63 655b 5661 7269  ], Sequence[Vari
+0001c0b0: 6162 6c65 5d5d 3a20 5475 706c 6520 6f66  able]]: Tuple of
+0001c0c0: 2074 656e 736f 7273 2061 6e64 206f 7468   tensors and oth
+0001c0d0: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
+0001c0e0: 6973 5f74 656e 736f 7220 3d20 6c61 6d62  is_tensor = lamb
+0001c0f0: 6461 2078 3a20 6973 696e 7374 616e 6365  da x: isinstance
+0001c100: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
+0001c110: 0a20 2020 206f 7468 6572 2c20 7465 6e73  .    other, tens
+0001c120: 6f72 7320 3d20 7574 696c 732e 7061 7274  ors = utils.part
+0001c130: 6974 696f 6e28 6973 5f74 656e 736f 722c  ition(is_tensor,
+0001c140: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001c150: 6172 6429 0a20 2020 2072 6574 7572 6e20  ard).    return 
+0001c160: 7475 706c 6528 7465 6e73 6f72 7329 2c20  tuple(tensors), 
+0001c170: 7475 706c 6528 6f74 6865 7229 0a0a 0a64  tuple(other)...d
+0001c180: 6566 205f 7570 6461 7465 5f66 6f72 7761  ef _update_forwa
+0001c190: 7264 5f77 6974 685f 6e65 775f 7361 7665  rd_with_new_save
+0001c1a0: 645f 666f 725f 6261 636b 7761 7264 2866  d_for_backward(f
+0001c1b0: 6f72 7761 7264 5f74 7261 6365 3a20 5472  orward_trace: Tr
+0001c1c0: 6163 652c 2073 6176 6564 5f66 6f72 5f62  ace, saved_for_b
+0001c1d0: 6163 6b77 6172 643a 2053 6571 7565 6e63  ackward: Sequenc
+0001c1e0: 655b 5661 7269 6162 6c65 5d29 202d 3e20  e[Variable]) -> 
+0001c1f0: 4e6f 6e65 3a0a 2020 2020 2222 2255 7064  None:.    """Upd
+0001c200: 6174 6573 2074 6865 2066 6f72 7761 7264  ates the forward
+0001c210: 2074 7261 6365 2077 6974 6820 6e65 7720   trace with new 
+0001c220: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001c230: 7264 2e0a 0a20 2020 2054 6869 7320 6973  rd...    This is
+0001c240: 206e 6563 6573 7361 7279 2062 6563 6175   necessary becau
+0001c250: 7365 2074 6865 2075 7064 6174 6564 2073  se the updated s
+0001c260: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001c270: 6420 6973 206e 6f74 2061 7661 696c 6162  d is not availab
+0001c280: 6c65 0a20 2020 2077 6865 6e20 7468 6520  le.    when the 
+0001c290: 666f 7277 6172 6420 616e 6420 6261 636b  forward and back
+0001c2a0: 7761 7264 2074 7261 6365 7320 6172 6520  ward traces are 
+0001c2b0: 636f 6e73 7472 7563 7465 642e 0a0a 2020  constructed...  
+0001c2c0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0001c2d0: 666f 7277 6172 645f 7472 6163 6520 2854  forward_trace (T
+0001c2e0: 7261 6365 293a 2046 6f72 7761 7264 2074  race): Forward t
+0001c2f0: 7261 6365 2074 6f20 7570 6461 7465 2e0a  race to update..
+0001c300: 2020 2020 2020 2020 7361 7665 645f 666f          saved_fo
+0001c310: 725f 6261 636b 7761 7264 2028 5365 7175  r_backward (Sequ
+0001c320: 656e 6365 5b56 6172 6961 626c 655d 293a  ence[Variable]):
+0001c330: 2053 6176 6564 5f66 6f72 5f62 6163 6b77   Saved_for_backw
+0001c340: 6172 6420 746f 2075 7365 2074 6f0a 2020  ard to use to.  
+0001c350: 2020 2020 2020 2020 2020 7570 6461 7465            update
+0001c360: 2074 6865 2066 6f72 7761 7264 2074 7261   the forward tra
+0001c370: 6365 2e0a 2020 2020 2222 220a 2020 2020  ce..    """.    
+0001c380: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001c390: 7264 203d 2074 7265 655f 6d61 7028 6c61  rd = tree_map(la
+0001c3a0: 6d62 6461 2078 3a20 782e 7661 6c75 6520  mbda x: x.value 
+0001c3b0: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
+0001c3c0: 204e 756d 6265 7250 726f 7879 2920 656c   NumberProxy) el
+0001c3d0: 7365 2078 2c20 7361 7665 645f 666f 725f  se x, saved_for_
+0001c3e0: 6261 636b 7761 7264 290a 2020 2020 7361  backward).    sa
+0001c3f0: 7665 645f 7465 6e73 6f72 732c 2073 6176  ved_tensors, sav
+0001c400: 6564 5f6f 7468 6572 203d 205f 7370 6c69  ed_other = _spli
+0001c410: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
+0001c420: 7761 7264 5f69 6e74 6f5f 7465 6e73 6f72  ward_into_tensor
+0001c430: 735f 616e 645f 6f74 6865 7228 7361 7665  s_and_other(save
+0001c440: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
+0001c450: 2020 2020 6173 7365 7274 2066 6f72 7761      assert forwa
+0001c460: 7264 5f74 7261 6365 2e62 6f75 6e64 5f73  rd_trace.bound_s
+0001c470: 796d 626f 6c73 5b2d 315d 2e73 796d 2e69  ymbols[-1].sym.i
+0001c480: 6420 3d3d 2070 7269 6d73 2e50 7269 6d49  d == prims.PrimI
+0001c490: 4473 2e52 4554 5552 4e0a 2020 2020 6e65  Ds.RETURN.    ne
+0001c4a0: 775f 7265 7475 726e 203d 2028 666f 7277  w_return = (forw
+0001c4b0: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
+0001c4c0: 5b30 5d2c 2028 7361 7665 645f 7465 6e73  [0], (saved_tens
+0001c4d0: 6f72 732c 2073 6176 6564 5f6f 7468 6572  ors, saved_other
+0001c4e0: 2929 0a20 2020 2066 6f72 7761 7264 5f74  )).    forward_t
+0001c4f0: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001c500: 6c73 5b2d 315d 203d 2072 6570 6c61 6365  ls[-1] = replace
+0001c510: 2866 6f72 7761 7264 5f74 7261 6365 2e62  (forward_trace.b
+0001c520: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
+0001c530: 2c20 6172 6773 3d6e 6577 5f72 6574 7572  , args=new_retur
+0001c540: 6e29 0a0a 0a64 6566 205f 7570 6461 7465  n)...def _update
+0001c550: 5f62 6163 6b77 6172 645f 7769 7468 5f6e  _backward_with_n
+0001c560: 6577 5f73 6176 6564 5f66 6f72 5f62 6163  ew_saved_for_bac
+0001c570: 6b77 6172 6428 6261 636b 7761 7264 5f74  kward(backward_t
+0001c580: 7261 6365 3a20 5472 6163 652c 2073 6176  race: Trace, sav
+0001c590: 6564 5f66 6f72 5f62 6163 6b77 6172 643a  ed_for_backward:
+0001c5a0: 2053 6571 7565 6e63 655b 5661 7269 6162   Sequence[Variab
+0001c5b0: 6c65 5d29 202d 3e20 4e6f 6e65 3a0a 2020  le]) -> None:.  
+0001c5c0: 2020 2222 2255 7064 6174 6573 2074 6865    """Updates the
+0001c5d0: 2062 6163 6b77 6172 6420 7472 6163 6520   backward trace 
+0001c5e0: 7769 7468 206e 6577 2073 6176 6564 5f66  with new saved_f
+0001c5f0: 6f72 5f62 6163 6b77 6172 642e 0a0a 2020  or_backward...  
+0001c600: 2020 5468 6973 2069 7320 6e65 6365 7373    This is necess
+0001c610: 6172 7920 6265 6361 7573 6520 7468 6520  ary because the 
+0001c620: 7570 6461 7465 6420 7361 7665 645f 666f  updated saved_fo
+0001c630: 725f 6261 636b 7761 7264 2069 730a 2020  r_backward is.  
+0001c640: 2020 6e6f 7420 6176 6169 6c61 626c 6520    not available 
+0001c650: 7768 656e 2074 6865 2062 6163 6b77 6172  when the backwar
+0001c660: 6420 7472 6163 6520 6973 2063 6f6e 7374  d trace is const
+0001c670: 7275 6374 6564 2e0a 0a20 2020 2041 7267  ructed...    Arg
+0001c680: 733a 0a20 2020 2020 2020 2062 6163 6b77  s:.        backw
+0001c690: 6172 645f 7472 6163 6520 2854 7261 6365  ard_trace (Trace
+0001c6a0: 293a 2042 6163 6b77 6172 6420 7472 6163  ): Backward trac
+0001c6b0: 6520 746f 2075 7064 6174 652e 0a20 2020  e to update..   
+0001c6c0: 2020 2020 2073 6176 6564 5f66 6f72 5f62       saved_for_b
+0001c6d0: 6163 6b77 6172 6420 2853 6571 7565 6e63  ackward (Sequenc
+0001c6e0: 655b 5661 7269 6162 6c65 5d29 3a20 5361  e[Variable]): Sa
+0001c6f0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001c700: 2074 6f20 7573 6520 746f 0a20 2020 2020   to use to.     
+0001c710: 2020 2020 2020 2075 7064 6174 6520 7468         update th
+0001c720: 6520 6261 636b 7761 7264 2074 7261 6365  e backward trace
+0001c730: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+0001c740: 6566 2075 6e70 6163 6b69 6e67 5f66 6e28  ef unpacking_fn(
+0001c750: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001c760: 7264 2c20 636f 7461 6e67 656e 7473 293a  rd, cotangents):
+0001c770: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
+0001c780: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
+0001c790: 6261 636b 7761 7264 5f74 7261 6365 2e61  backward_trace.a
+0001c7a0: 7267 735b 315d 0a20 2020 2073 6176 6564  rgs[1].    saved
+0001c7b0: 5f74 656e 736f 7273 2c20 7361 7665 645f  _tensors, saved_
+0001c7c0: 6f74 6865 7220 3d20 5f73 706c 6974 5f73  other = _split_s
+0001c7d0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001c7e0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
+0001c7f0: 6e64 5f6f 7468 6572 2873 6176 6564 5f66  nd_other(saved_f
+0001c800: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
+0001c810: 2075 6e70 6163 6b69 6e67 5f74 7261 6365   unpacking_trace
+0001c820: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
+0001c830: 6365 2872 656e 616d 655f 7072 6f78 6965  ce(rename_proxie
+0001c840: 733d 4661 6c73 652c 2075 7365 5f64 6365  s=False, use_dce
+0001c850: 3d46 616c 7365 2928 0a20 2020 2020 2020  =False)(.       
+0001c860: 2075 6e70 6163 6b69 6e67 5f66 6e2c 2028   unpacking_fn, (
+0001c870: 7361 7665 645f 7465 6e73 6f72 732c 2073  saved_tensors, s
+0001c880: 6176 6564 5f6f 7468 6572 292c 2063 6f74  aved_other), cot
+0001c890: 616e 6765 6e74 730a 2020 2020 290a 2020  angents.    ).  
+0001c8a0: 2020 6173 7365 7274 2075 6e70 6163 6b69    assert unpacki
+0001c8b0: 6e67 5f74 7261 6365 2e62 6f75 6e64 5f73  ng_trace.bound_s
+0001c8c0: 796d 626f 6c73 5b2d 315d 2e73 796d 2e69  ymbols[-1].sym.i
+0001c8d0: 6420 3d3d 2070 7269 6d73 2e50 7269 6d49  d == prims.PrimI
+0001c8e0: 4473 2e52 4554 5552 4e0a 0a20 2020 2062  Ds.RETURN..    b
+0001c8f0: 6163 6b77 6172 645f 7472 6163 652e 6172  ackward_trace.ar
+0001c900: 6773 203d 2075 6e70 6163 6b69 6e67 5f74  gs = unpacking_t
+0001c910: 7261 6365 2e61 7267 730a 2020 2020 6261  race.args.    ba
+0001c920: 636b 7761 7264 5f74 7261 6365 5f62 7379  ckward_trace_bsy
+0001c930: 6d73 5f77 6974 686f 7574 5f75 6e70 6163  ms_without_unpac
+0001c940: 6b69 6e67 203d 2028 0a20 2020 2020 2020  king = (.       
+0001c950: 2062 7379 6d0a 2020 2020 2020 2020 666f   bsym.        fo
+0001c960: 7220 6273 796d 2069 6e20 6261 636b 7761  r bsym in backwa
+0001c970: 7264 5f74 7261 6365 2e62 6f75 6e64 5f73  rd_trace.bound_s
+0001c980: 796d 626f 6c73 0a20 2020 2020 2020 2069  ymbols.        i
+0001c990: 6620 6273 796d 2e73 796d 2e69 640a 2020  f bsym.sym.id.  
+0001c9a0: 2020 2020 2020 6e6f 7420 696e 2028 0a20        not in (. 
+0001c9b0: 2020 2020 2020 2020 2020 2070 7269 6d73             prims
+0001c9c0: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
+0001c9d0: 454d 5054 595f 4449 4354 2c0a 2020 2020  EMPTY_DICT,.    
+0001c9e0: 2020 2020 2020 2020 7072 696d 732e 5072          prims.Pr
+0001c9f0: 696d 4944 732e 554e 5041 434b 5f4b 4559  imIDs.UNPACK_KEY
+0001ca00: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
+0001ca10: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
+0001ca20: 434b 5f53 4551 5545 4e43 452c 0a20 2020  CK_SEQUENCE,.   
+0001ca30: 2020 2020 2020 2020 2070 7269 6d73 2e50           prims.P
+0001ca40: 7269 6d49 4473 2e55 4e50 4143 4b5f 5452  rimIDs.UNPACK_TR
+0001ca50: 4956 4941 4c2c 0a20 2020 2020 2020 2029  IVIAL,.        )
+0001ca60: 0a20 2020 2029 0a20 2020 2062 6163 6b77  .    ).    backw
+0001ca70: 6172 645f 7472 6163 652e 626f 756e 645f  ard_trace.bound_
+0001ca80: 7379 6d62 6f6c 7320 3d20 6c69 7374 2828  symbols = list((
+0001ca90: 2a75 6e70 6163 6b69 6e67 5f74 7261 6365  *unpacking_trace
+0001caa0: 2e62 6f75 6e64 5f73 796d 626f 6c73 5b3a  .bound_symbols[:
+0001cab0: 2d31 5d2c 202a 6261 636b 7761 7264 5f74  -1], *backward_t
+0001cac0: 7261 6365 5f62 7379 6d73 5f77 6974 686f  race_bsyms_witho
+0001cad0: 7574 5f75 6e70 6163 6b69 6e67 2929 0a0a  ut_unpacking))..
+0001cae0: 0a23 204e 4f54 453a 2052 6574 7572 6e69  .# NOTE: Returni
+0001caf0: 6e67 206e 616d 6564 7475 706c 6573 2066  ng namedtuples f
+0001cb00: 726f 6d20 636f 6d70 696c 6564 2066 756e  rom compiled fun
+0001cb10: 6374 696f 6e73 2064 6f65 736e 2774 2077  ctions doesn't w
+0001cb20: 6f72 6b2e 2053 6565 3a0a 2320 2241 6c6c  ork. See:.# "All
+0001cb30: 6f77 2072 6574 7572 6e69 6e67 206e 616d  ow returning nam
+0001cb40: 6564 7475 706c 6573 2066 726f 6d20 636f  edtuples from co
+0001cb50: 6d70 696c 6564 2066 756e 6374 696f 6e73  mpiled functions
+0001cb60: 220a 2320 4e6f 7465 205b 4772 6164 2066  ".# Note [Grad f
+0001cb70: 6f72 7761 7264 206f 7574 7075 7420 7370  orward output sp
+0001cb80: 6563 5d0a 2320 4966 2069 7420 6469 6420  ec].# If it did 
+0001cb90: 776f 726b 2069 7420 776f 756c 6420 6265  work it would be
+0001cba0: 206e 6963 6520 746f 2075 7365 2074 6869   nice to use thi
+0001cbb0: 7320 6e61 6d65 6474 7570 6c65 0a23 2069  s namedtuple.# i
+0001cbc0: 6e73 7465 6164 206f 6620 7468 6520 706c  nstead of the pl
+0001cbd0: 6169 6e20 7475 706c 6520 6f72 2064 6963  ain tuple or dic
+0001cbe0: 7420 7468 6174 2077 6527 7265 2075 7369  t that we're usi
+0001cbf0: 6e67 206e 6f77 2e0a 546f 7263 6841 7574  ng now..TorchAut
+0001cc00: 6f67 7261 6446 6f72 7761 7264 4461 7461  ogradForwardData
+0001cc10: 203d 206e 616d 6564 7475 706c 6528 0a20   = namedtuple(. 
+0001cc20: 2020 2022 546f 7263 6841 7574 6f67 7261     "TorchAutogra
+0001cc30: 6446 6f72 7761 7264 4461 7461 222c 0a20  dForwardData",. 
+0001cc40: 2020 205b 226f 7574 7075 7422 2c20 2266     ["output", "f
+0001cc50: 6c61 745f 6172 6773 222c 2022 666c 6174  lat_args", "flat
+0001cc60: 5f6f 7574 7075 7422 5d2c 0a29 0a0a 0a64  _output"],.)...d
+0001cc70: 6566 2066 6f72 7761 7264 5f61 6e64 5f62  ef forward_and_b
+0001cc80: 6163 6b77 6172 645f 6672 6f6d 5f74 7261  ackward_from_tra
+0001cc90: 6365 2874 7261 6365 3a20 5472 6163 652c  ce(trace: Trace,
+0001cca0: 2074 6f72 6368 5f61 7574 6f67 7261 643d   torch_autograd=
+0001ccb0: 4661 6c73 6529 202d 3e20 466f 7277 6172  False) -> Forwar
+0001ccc0: 6442 6163 6b77 6172 6454 7261 6365 733a  dBackwardTraces:
+0001ccd0: 0a20 2020 2022 2222 4765 6e65 7261 7465  .    """Generate
+0001cce0: 7320 7468 6520 666f 7277 6172 6420 616e  s the forward an
+0001ccf0: 6420 6261 636b 7761 7264 2070 6173 7365  d backward passe
+0001cd00: 7320 6672 6f6d 2061 2074 7261 6365 2e0a  s from a trace..
+0001cd10: 0a20 2020 2054 6869 7320 6973 2061 2063  .    This is a c
+0001cd20: 6f6e 7665 6e69 656e 6365 2066 756e 6374  onvenience funct
+0001cd30: 696f 6e20 7468 6174 2063 6f6d 6269 6e65  ion that combine
+0001cd40: 7320 7468 6520 6675 6e63 7469 6f6e 616c  s the functional
+0001cd50: 6974 7920 6f66 0a20 2020 2060 6175 676d  ity of.    `augm
+0001cd60: 656e 7465 645f 666f 7277 6172 645f 7061  ented_forward_pa
+0001cd70: 7373 6020 616e 6420 6062 6163 6b77 6172  ss` and `backwar
+0001cd80: 645f 7061 7373 602e 2054 6865 206d 6169  d_pass`. The mai
+0001cd90: 6e20 6469 6666 6572 656e 6365 2069 7320  n difference is 
+0001cda0: 7468 6174 0a20 2020 2074 6869 7320 6675  that.    this fu
+0001cdb0: 6e63 7469 6f6e 2064 6f65 7320 6e6f 7420  nction does not 
+0001cdc0: 7265 7175 6972 6520 7468 6520 7573 6572  require the user
+0001cdd0: 2074 6f20 7072 6f76 6964 6520 6e65 7720   to provide new 
+0001cde0: 696e 7075 7473 2066 6f72 2074 6865 0a20  inputs for the. 
+0001cdf0: 2020 2074 7261 6365 2065 7661 6c75 6174     trace evaluat
+0001ce00: 696f 6e2e 2049 6e73 7465 6164 2069 7420  ion. Instead it 
+0001ce10: 7573 6573 2074 6865 2069 6e70 7574 7320  uses the inputs 
+0001ce20: 7468 6174 2077 6572 6520 7573 6564 2074  that were used t
+0001ce30: 6f20 636f 6e73 7472 7563 740a 2020 2020  o construct.    
+0001ce40: 7468 6520 7472 6163 652e 0a0a 2020 2020  the trace...    
+0001ce50: 4172 6773 3a0a 2020 2020 2020 2020 7472  Args:.        tr
+0001ce60: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
+0001ce70: 6365 2074 6f20 6765 6e65 7261 7465 2074  ce to generate t
+0001ce80: 6865 2066 6f72 7761 7264 2061 6e64 2062  he forward and b
+0001ce90: 6163 6b77 6172 6420 7061 7373 6573 2066  ackward passes f
+0001cea0: 726f 6d2e 0a0a 2020 2020 5265 7475 726e  rom...    Return
+0001ceb0: 733a 0a20 2020 2020 2020 2046 6f72 7761  s:.        Forwa
+0001cec0: 7264 4261 636b 7761 7264 5472 6163 6573  rdBackwardTraces
+0001ced0: 3a20 4120 6e61 6d65 6420 7475 706c 6520  : A named tuple 
+0001cee0: 636f 6e74 6169 6e69 6e67 2074 6865 2066  containing the f
+0001cef0: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
+0001cf00: 6172 640a 2020 2020 2020 2020 2020 2020  ard.            
+0001cf10: 7472 6163 6573 2e0a 0a20 2020 2045 7861  traces...    Exa
+0001cf20: 6d70 6c65 3a0a 2020 2020 2020 2020 3e3e  mple:.        >>
+0001cf30: 3e20 696d 706f 7274 2074 6f72 6368 0a20  > import torch. 
+0001cf40: 2020 2020 2020 203e 3e3e 2066 726f 6d20         >>> from 
+0001cf50: 7468 756e 6465 7220 696d 706f 7274 2063  thunder import c
+0001cf60: 6f6d 7069 6c65 2c20 6c61 7374 5f74 7261  ompile, last_tra
+0001cf70: 6365 730a 2020 2020 2020 2020 3e3e 3e20  ces.        >>> 
+0001cf80: 6672 6f6d 2074 6875 6e64 6572 2e63 6f72  from thunder.cor
+0001cf90: 652e 7472 616e 7366 6f72 6d73 2069 6d70  e.transforms imp
+0001cfa0: 6f72 7420 666f 7277 6172 645f 616e 645f  ort forward_and_
+0001cfb0: 6261 636b 7761 7264 5f66 726f 6d5f 7472  backward_from_tr
+0001cfc0: 6163 650a 2020 2020 2020 2020 3e3e 3e20  ace.        >>> 
+0001cfd0: 6465 6620 6628 7829 3a0a 2020 2020 2020  def f(x):.      
+0001cfe0: 2020 2e2e 2e20 2020 2020 7265 7475 726e    ...     return
+0001cff0: 2074 6f72 6368 2e73 696e 2878 290a 2020   torch.sin(x).  
+0001d000: 2020 2020 2020 3e3e 3e20 7820 3d20 746f        >>> x = to
+0001d010: 7263 682e 7465 6e73 6f72 2833 2e30 290a  rch.tensor(3.0).
+0001d020: 2020 2020 2020 2020 3e3e 3e20 6366 203d          >>> cf =
+0001d030: 2063 6f6d 7069 6c65 2866 290a 2020 2020   compile(f).    
+0001d040: 2020 2020 3e3e 3e20 6f75 7420 3d20 6366      >>> out = cf
+0001d050: 2878 290a 2020 2020 2020 2020 3e3e 3e20  (x).        >>> 
+0001d060: 7472 6163 6520 3d20 6c61 7374 5f74 7261  trace = last_tra
+0001d070: 6365 7328 6366 295b 305d 0a20 2020 2020  ces(cf)[0].     
+0001d080: 2020 203e 3e3e 2066 6f72 7761 7264 5f61     >>> forward_a
+0001d090: 6e64 5f62 6163 6b77 6172 645f 6672 6f6d  nd_backward_from
+0001d0a0: 5f74 7261 6365 2874 7261 6365 290a 2020  _trace(trace).  
+0001d0b0: 2020 2020 2020 2e2e 2e20 466f 7277 6172        ... Forwar
+0001d0c0: 6442 6163 6b77 6172 6454 7261 6365 7328  dBackwardTraces(
+0001d0d0: 0a20 2020 2020 2020 202e 2e2e 2066 6f72  .        ... for
+0001d0e0: 7761 7264 5f74 7261 6365 3d23 2069 6d70  ward_trace=# imp
+0001d0f0: 6f72 7420 7468 756e 6465 7220 6173 2074  ort thunder as t
+0001d100: 6875 6e64 6572 0a20 2020 2020 2020 202e  hunder.        .
+0001d110: 2e2e 2023 2069 6d70 6f72 7420 7468 756e  .. # import thun
+0001d120: 6465 722e 636f 7265 2e70 7269 6d73 2061  der.core.prims a
+0001d130: 7320 7072 696d 730a 2020 2020 2020 2020  s prims.        
+0001d140: 2e2e 2e20 696d 706f 7274 2074 6f72 6368  ... import torch
+0001d150: 0a20 2020 2020 2020 202e 2e2e 0a20 2020  .        ....   
+0001d160: 2020 2020 202e 2e2e 2040 746f 7263 682e       ... @torch.
+0001d170: 6e6f 5f67 7261 6428 290a 2020 2020 2020  no_grad().      
+0001d180: 2020 2e2e 2e20 6465 6620 6175 676d 656e    ... def augmen
+0001d190: 7465 645f 666f 7277 6172 645f 666e 282a  ted_forward_fn(*
+0001d1a0: 6172 6773 293a 0a20 2020 2020 2020 202e  args):.        .
+0001d1b0: 2e2e 2020 2023 2061 7267 733a 2022 436f  ..   # args: "Co
+0001d1c0: 6c6c 6563 7469 6f6e 2220 3d20 2028 7430  llection" =  (t0
+0001d1d0: 2c29 2020 2874 7269 7669 616c 2075 6e70  ,)  (trivial unp
+0001d1e0: 6163 6b29 0a20 2020 2020 2020 202e 2e2e  ack).        ...
+0001d1f0: 2020 2074 302c 205c 0a20 2020 2020 2020     t0, \.       
+0001d200: 202e 2e2e 2020 203d 2061 7267 730a 2020   ...   = args.  
+0001d210: 2020 2020 2020 2e2e 2e20 2020 7431 203d        ...   t1 =
+0001d220: 2070 7269 6d73 2e73 696e 2874 3029 2020   prims.sin(t0)  
+0001d230: 2320 7431 3a20 2263 7075 2066 3332 5b5d  # t1: "cpu f32[]
+0001d240: 220a 2020 2020 2020 2020 2e2e 2e20 2020  ".        ...   
+0001d250: 7265 7475 726e 2074 312c 2028 7430 2c29  return t1, (t0,)
+0001d260: 2c0a 2020 2020 2020 2020 2e2e 2e20 6261  ,.        ... ba
+0001d270: 636b 7761 7264 5f74 7261 6365 3d23 2069  ckward_trace=# i
+0001d280: 6d70 6f72 7420 7468 756e 6465 7220 6173  mport thunder as
+0001d290: 2074 6875 6e64 6572 0a20 2020 2020 2020   thunder.       
+0001d2a0: 202e 2e2e 2023 2069 6d70 6f72 7420 7468   ... # import th
+0001d2b0: 756e 6465 722e 636f 7265 2e70 7269 6d73  under.core.prims
+0001d2c0: 2061 7320 7072 696d 730a 2020 2020 2020   as prims.      
+0001d2d0: 2020 2e2e 2e20 696d 706f 7274 2074 6f72    ... import tor
+0001d2e0: 6368 0a20 2020 2020 2020 202e 2e2e 0a20  ch.        .... 
+0001d2f0: 2020 2020 2020 202e 2e2e 2040 746f 7263         ... @torc
+0001d300: 682e 6e6f 5f67 7261 6428 290a 2020 2020  h.no_grad().    
+0001d310: 2020 2020 2e2e 2e20 6465 6620 6261 636b      ... def back
+0001d320: 7761 7264 5f66 6e28 7361 7665 645f 666f  ward_fn(saved_fo
+0001d330: 725f 6261 636b 7761 7264 2c20 636f 7461  r_backward, cota
+0001d340: 6e67 656e 7473 293a 0a20 2020 2020 2020  ngents):.       
+0001d350: 202e 2e2e 2020 2023 2073 6176 6564 5f66   ...   # saved_f
+0001d360: 6f72 5f62 6163 6b77 6172 643a 2022 436f  or_backward: "Co
+0001d370: 6c6c 6563 7469 6f6e 2220 3d20 2028 7430  llection" =  (t0
+0001d380: 2c29 2020 2874 7269 7669 616c 2075 6e70  ,)  (trivial unp
+0001d390: 6163 6b29 0a20 2020 2020 2020 202e 2e2e  ack).        ...
+0001d3a0: 2020 2023 2063 6f74 616e 6765 6e74 733a     # cotangents:
+0001d3b0: 2022 6370 7520 6633 325b 5d22 203d 2020   "cpu f32[]" =  
+0001d3c0: 636f 7461 6e67 656e 7473 2020 2874 7269  cotangents  (tri
+0001d3d0: 7669 616c 2075 6e70 6163 6b29 0a20 2020  vial unpack).   
+0001d3e0: 2020 2020 202e 2e2e 2020 2074 302c 205c       ...   t0, \
+0001d3f0: 0a20 2020 2020 2020 202e 2e2e 2020 203d  .        ...   =
+0001d400: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001d410: 6172 640a 2020 2020 2020 2020 2e2e 2e20  ard.        ... 
+0001d420: 2020 7431 203d 2070 7269 6d73 2e63 6f73    t1 = prims.cos
+0001d430: 2874 3029 2020 2320 7431 3a20 2263 7075  (t0)  # t1: "cpu
+0001d440: 2066 3332 5b5d 220a 2020 2020 2020 2020   f32[]".        
+0001d450: 2e2e 2e20 2020 7432 203d 2070 7269 6d73  ...   t2 = prims
+0001d460: 2e6d 756c 2863 6f74 616e 6765 6e74 732c  .mul(cotangents,
+0001d470: 2074 3129 2020 2320 7432 3a20 2263 7075   t1)  # t2: "cpu
+0001d480: 2066 3332 5b5d 220a 2020 2020 2020 2020   f32[]".        
+0001d490: 2e2e 2e20 2020 7265 7475 726e 2028 7432  ...   return (t2
+0001d4a0: 2c29 290a 2020 2020 2222 220a 0a20 2020  ,)).    """..   
+0001d4b0: 206f 7574 7075 745f 7370 6563 203d 204e   output_spec = N
+0001d4c0: 6f6e 650a 0a20 2020 2064 6566 2061 7567  one..    def aug
+0001d4d0: 6d65 6e74 6564 5f66 6f72 7761 7264 5f66  mented_forward_f
+0001d4e0: 6e28 2a61 7267 732c 202a 2a6b 7761 7267  n(*args, **kwarg
+0001d4f0: 7329 3a0a 2020 2020 2020 2020 7265 7375  s):.        resu
+0001d500: 6c74 2c20 656e 7620 3d20 6175 676d 656e  lt, env = augmen
+0001d510: 7465 645f 666f 7277 6172 645f 7061 7373  ted_forward_pass
+0001d520: 282a 6172 6773 2c20 7472 6163 653d 7472  (*args, trace=tr
+0001d530: 6163 652c 202a 2a6b 7761 7267 7329 0a20  ace, **kwargs). 
+0001d540: 2020 2020 2020 2073 6176 6564 5f66 6f72         saved_for
+0001d550: 5f62 6163 6b77 6172 6420 3d20 6465 636f  _backward = deco
+0001d560: 6e73 7472 7563 745f 666f 7277 6172 645f  nstruct_forward_
+0001d570: 656e 765f 666f 725f 6261 636b 7761 7264  env_for_backward
+0001d580: 2874 7261 6365 2c20 656e 7629 0a20 2020  (trace, env).   
+0001d590: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
+0001d5a0: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
+0001d5b0: 2020 2020 6e6f 6e6c 6f63 616c 206f 7574      nonlocal out
+0001d5c0: 7075 745f 7370 6563 0a20 2020 2020 2020  put_spec.       
+0001d5d0: 2020 2020 2066 6c61 745f 6172 6773 2c20       flat_args, 
+0001d5e0: 5f20 3d20 7472 6565 5f66 6c61 7474 656e  _ = tree_flatten
+0001d5f0: 2828 6172 6773 2c20 6b77 6172 6773 2929  ((args, kwargs))
+0001d600: 0a20 2020 2020 2020 2020 2020 2066 6c61  .            fla
+0001d610: 745f 6f75 7470 7574 2c20 6f75 7470 7574  t_output, output
+0001d620: 5f73 7065 6320 3d20 7472 6565 5f66 6c61  _spec = tree_fla
+0001d630: 7474 656e 2872 6573 756c 7429 0a20 2020  tten(result).   
+0001d640: 2020 2020 2020 2020 2066 6c61 745f 6f75           flat_ou
+0001d650: 7470 7574 203d 2074 7570 6c65 2866 6c61  tput = tuple(fla
+0001d660: 745f 6f75 7470 7574 290a 2020 2020 2020  t_output).      
+0001d670: 2020 2020 2020 2320 5365 6520 4e6f 7465        # See Note
+0001d680: 205b 4772 6164 2066 6f72 7761 7264 206f   [Grad forward o
+0001d690: 7574 7075 7420 7370 6563 5d0a 2020 2020  utput spec].    
+0001d6a0: 2020 2020 2020 2020 666f 725f 6175 746f          for_auto
+0001d6b0: 6772 6164 203d 2054 6f72 6368 4175 746f  grad = TorchAuto
+0001d6c0: 6772 6164 466f 7277 6172 6444 6174 6128  gradForwardData(
+0001d6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d6e0: 2072 6573 756c 742c 0a20 2020 2020 2020   result,.       
+0001d6f0: 2020 2020 2020 2020 2066 6c61 745f 6172           flat_ar
+0001d700: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+0001d710: 2020 2020 666c 6174 5f6f 7574 7075 742c      flat_output,
+0001d720: 0a20 2020 2020 2020 2020 2020 2029 2e5f  .            )._
+0001d730: 6173 6469 6374 2829 0a20 2020 2020 2020  asdict().       
+0001d740: 2020 2020 2072 6574 7572 6e20 2866 6f72       return (for
+0001d750: 5f61 7574 6f67 7261 642c 2073 6176 6564  _autograd, saved
+0001d760: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
+0001d770: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0001d780: 7375 6c74 2c20 7361 7665 645f 666f 725f  sult, saved_for_
+0001d790: 6261 636b 7761 7264 0a0a 2020 2020 2320  backward..    # 
+0001d7a0: 436f 7079 2074 6865 2073 6967 6e61 7475  Copy the signatu
+0001d7b0: 7265 206f 6620 7468 6520 6f72 6967 696e  re of the origin
+0001d7c0: 616c 2066 756e 6374 696f 6e20 736f 2074  al function so t
+0001d7d0: 6861 7420 7468 6520 6172 6775 6d65 6e74  hat the argument
+0001d7e0: 7320 6172 650a 2020 2020 2320 6e61 6d65  s are.    # name
+0001d7f0: 6420 636f 7272 6563 746c 7920 696e 2074  d correctly in t
+0001d800: 6865 2061 7567 6d65 6e74 6564 2066 6f72  he augmented for
+0001d810: 7761 7264 2070 6173 7320 696e 7374 6561  ward pass instea
+0001d820: 6420 6f66 2062 6569 6e67 206e 616d 6564  d of being named
+0001d830: 0a20 2020 2023 2022 6172 6773 2220 616e  .    # "args" an
+0001d840: 6420 226b 7761 7267 7322 2e0a 2020 2020  d "kwargs"..    
+0001d850: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+0001d860: 645f 666e 2e5f 5f73 6967 6e61 7475 7265  d_fn.__signature
+0001d870: 5f5f 203d 2069 6e73 7065 6374 2e73 6967  __ = inspect.sig
+0001d880: 6e61 7475 7265 2874 7261 6365 2e66 6e20  nature(trace.fn 
+0001d890: 6f72 2074 7261 6365 2e70 7974 686f 6e5f  or trace.python_
+0001d8a0: 6361 6c6c 6162 6c65 2829 290a 0a20 2020  callable())..   
+0001d8b0: 2064 6566 206f 6e65 735f 6c69 6b65 2878   def ones_like(x
+0001d8c0: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
+0001d8d0: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
+0001d8e0: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
+0001d8f0: 2020 2020 2020 7265 7475 726e 2066 756c        return ful
+0001d900: 6c5f 6c69 6b65 2878 2c20 6669 6c6c 5f76  l_like(x, fill_v
+0001d910: 616c 7565 3d31 290a 2020 2020 2020 2020  alue=1).        
+0001d920: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0001d930: 782c 204e 756d 6265 7250 726f 7879 293a  x, NumberProxy):
+0001d940: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001d950: 7572 6e20 7479 7065 2878 2e76 616c 7565  urn type(x.value
+0001d960: 2928 3129 0a20 2020 2020 2020 2065 6c73  )(1).        els
+0001d970: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001d980: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+0001d990: 666f 7277 6172 645f 7472 6163 6520 3d20  forward_trace = 
+0001d9a0: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
+0001d9b0: 2928 6175 676d 656e 7465 645f 666f 7277  )(augmented_forw
+0001d9c0: 6172 645f 666e 2c20 2a74 7261 6365 2e61  ard_fn, *trace.a
+0001d9d0: 7267 732c 202a 2a74 7261 6365 2e6b 7761  rgs, **trace.kwa
+0001d9e0: 7267 7329 0a20 2020 2023 2057 6520 7365  rgs).    # We se
+0001d9f0: 7420 666f 7277 6172 6420 7472 6163 6520  t forward trace 
+0001da00: 746f 2063 6f6e 7374 7275 6374 2070 726f  to construct pro
+0001da10: 7869 6573 2062 6563 6175 7365 2077 6520  xies because we 
+0001da20: 6e65 6564 2074 6865 7365 2070 726f 7869  need these proxi
+0001da30: 6573 2074 6f0a 2020 2020 2320 6861 7665  es to.    # have
+0001da40: 2064 6966 6665 7265 6e74 206e 616d 6573   different names
+0001da50: 2074 6861 6e20 7468 6520 6f6e 6573 2069   than the ones i
+0001da60: 6e20 7468 6520 666f 7277 6172 6420 7472  n the forward tr
+0001da70: 6163 652e 0a20 2020 2074 7279 3a0a 2020  ace..    try:.  
+0001da80: 2020 2020 2020 7472 6163 6563 7478 5f74        tracectx_t
+0001da90: 6f6b 656e 203d 2073 6574 5f74 7261 6365  oken = set_trace
+0001daa0: 6374 7828 666f 7277 6172 645f 7472 6163  ctx(forward_trac
+0001dab0: 6529 0a20 2020 2020 2020 2023 2057 6520  e).        # We 
+0001dac0: 646f 6e27 7420 7761 6e74 2074 6f20 7265  don't want to re
+0001dad0: 636f 7264 2074 686f 7365 206f 6e65 735f  cord those ones_
+0001dae0: 6c69 6b65 2063 616c 6c73 2069 6e20 7468  like calls in th
+0001daf0: 6520 666f 7277 6172 6420 7472 6163 652e  e forward trace.
+0001db00: 0a20 2020 2020 2020 2077 6974 6820 6465  .        with de
+0001db10: 7461 6368 6564 5f74 7261 6365 2829 3a0a  tached_trace():.
+0001db20: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0001db30: 6f72 6368 5f61 7574 6f67 7261 643a 0a20  orch_autograd:. 
+0001db40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001db50: 2049 7427 7320 6173 7375 6d65 6420 7468   It's assumed th
+0001db60: 6174 2066 6f72 7761 7264 5f74 7261 6365  at forward_trace
+0001db70: 2e6f 7574 7075 745b 305d 2069 7320 6120  .output[0] is a 
+0001db80: 6469 6374 2066 726f 6d20 546f 7263 6841  dict from TorchA
+0001db90: 7574 6f67 7261 6446 6f72 7761 7264 4461  utogradForwardDa
+0001dba0: 7461 0a20 2020 2020 2020 2020 2020 2020  ta.             
+0001dbb0: 2020 2066 6c61 745f 6f75 7470 7574 203d     flat_output =
+0001dbc0: 2066 6f72 7761 7264 5f74 7261 6365 2e6f   forward_trace.o
+0001dbd0: 7574 7075 745b 305d 5b22 666c 6174 5f6f  utput[0]["flat_o
+0001dbe0: 7574 7075 7422 5d0a 2020 2020 2020 2020  utput"].        
+0001dbf0: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
+0001dc00: 7473 203d 2075 7469 6c73 2e73 6571 7565  ts = utils.seque
+0001dc10: 6e63 6966 7928 7472 6565 5f6d 6170 286c  ncify(tree_map(l
+0001dc20: 616d 6264 6120 763a 206f 6e65 735f 6c69  ambda v: ones_li
+0001dc30: 6b65 2876 292c 2066 6c61 745f 6f75 7470  ke(v), flat_outp
+0001dc40: 7574 2929 0a20 2020 2020 2020 2020 2020  ut)).           
+0001dc50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001dc60: 2020 2020 2020 2063 6f74 616e 6765 6e74         cotangent
+0001dc70: 7320 3d20 7574 696c 732e 7365 7175 656e  s = utils.sequen
+0001dc80: 6369 6679 2874 7265 655f 6d61 7028 6c61  cify(tree_map(la
+0001dc90: 6d62 6461 2076 3a20 6f6e 6573 5f6c 696b  mbda v: ones_lik
+0001dca0: 6528 7629 2c20 7472 6163 652e 6f75 7470  e(v), trace.outp
+0001dcb0: 7574 2929 0a20 2020 2066 696e 616c 6c79  ut)).    finally
+0001dcc0: 3a0a 2020 2020 2020 2020 7265 7365 745f  :.        reset_
+0001dcd0: 7472 6163 6563 7478 2874 7261 6365 6374  tracectx(tracect
+0001dce0: 785f 746f 6b65 6e29 0a0a 2020 2020 6465  x_token)..    de
+0001dcf0: 6620 6261 636b 7761 7264 5f66 6e28 7361  f backward_fn(sa
+0001dd00: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001dd10: 2c20 636f 7461 6e67 656e 7473 293a 0a20  , cotangents):. 
+0001dd20: 2020 2020 2020 2065 6e76 203d 2072 6563         env = rec
+0001dd30: 6f6e 7374 7275 6374 5f66 6f72 7761 7264  onstruct_forward
+0001dd40: 5f65 6e76 5f66 6f72 5f62 6163 6b77 6172  _env_for_backwar
+0001dd50: 6428 7472 6163 652c 2073 6176 6564 5f66  d(trace, saved_f
+0001dd60: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
+0001dd70: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
+0001dd80: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
+0001dd90: 2020 2020 636f 7461 6e67 656e 7473 203d      cotangents =
+0001dda0: 2074 7265 655f 756e 666c 6174 7465 6e28   tree_unflatten(
+0001ddb0: 636f 7461 6e67 656e 7473 2c20 6f75 7470  cotangents, outp
+0001ddc0: 7574 5f73 7065 6329 0a20 2020 2020 2020  ut_spec).       
+0001ddd0: 206f 7574 203d 2062 6163 6b77 6172 645f   out = backward_
+0001dde0: 7061 7373 2865 6e76 2c20 7472 6163 652c  pass(env, trace,
+0001ddf0: 2063 6f74 616e 6765 6e74 7329 0a20 2020   cotangents).   
+0001de00: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
+0001de10: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
+0001de20: 2020 2020 676b 7761 7267 7320 3d20 6f75      gkwargs = ou
+0001de30: 745b 2d31 5d20 6966 2069 7369 6e73 7461  t[-1] if isinsta
+0001de40: 6e63 6528 6f75 745b 2d31 5d2c 2064 6963  nce(out[-1], dic
+0001de50: 7429 2065 6c73 6520 7b7d 0a20 2020 2020  t) else {}.     
+0001de60: 2020 2020 2020 2067 6172 6773 203d 206f         gargs = o
+0001de70: 7574 5b3a 2d31 5d20 6966 2069 7369 6e73  ut[:-1] if isins
+0001de80: 7461 6e63 6528 6f75 745b 2d31 5d2c 2064  tance(out[-1], d
+0001de90: 6963 7429 2065 6c73 6520 6f75 740a 2020  ict) else out.  
+0001dea0: 2020 2020 2020 2020 2020 676b 7761 7267            gkwarg
+0001deb0: 7320 3d20 7b6b 3a20 676b 7761 7267 732e  s = {k: gkwargs.
+0001dec0: 6765 7428 6b2c 204e 6f6e 6529 2066 6f72  get(k, None) for
+0001ded0: 206b 2069 6e20 7472 6163 652e 6b77 6172   k in trace.kwar
+0001dee0: 6773 7d0a 2020 2020 2020 2020 2020 2020  gs}.            
+0001def0: 6f75 7420 3d20 282a 6761 7267 732c 2067  out = (*gargs, g
+0001df00: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+0001df10: 2020 2020 6f75 7420 3d20 7472 6565 5f66      out = tree_f
+0001df20: 6c61 7474 656e 286f 7574 295b 305d 0a20  latten(out)[0]. 
+0001df30: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+0001df40: 740a 0a20 2020 2073 6176 6564 5f66 6f72  t..    saved_for
+0001df50: 5f62 6163 6b77 6172 6420 3d20 666f 7277  _backward = forw
+0001df60: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
+0001df70: 5b31 5d0a 2020 2020 6261 636b 7761 7264  [1].    backward
+0001df80: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
+0001df90: 6374 5f74 7261 6365 2872 656e 616d 655f  ct_trace(rename_
+0001dfa0: 7072 6f78 6965 733d 4661 6c73 6529 2862  proxies=False)(b
+0001dfb0: 6163 6b77 6172 645f 666e 2c20 7361 7665  ackward_fn, save
+0001dfc0: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+0001dfd0: 636f 7461 6e67 656e 7473 290a 0a20 2020  cotangents)..   
+0001dfe0: 2023 2057 6520 6172 6520 646f 6e65 2077   # We are done w
+0001dff0: 6974 6820 636f 6e73 7472 7563 7469 6e67  ith constructing
+0001e000: 2074 6865 2066 6f72 7761 7264 2061 6e64   the forward and
+0001e010: 2062 6163 6b77 6172 6420 7061 7373 6573   backward passes
+0001e020: 2061 7420 7468 6973 0a20 2020 2023 2073   at this.    # s
+0001e030: 7461 6765 2e20 5468 6520 666f 6c6c 6f77  tage. The follow
+0001e040: 696e 6720 6973 206e 6f74 2073 7472 6963  ing is not stric
+0001e050: 746c 7920 6e65 6365 7373 6172 792c 2062  tly necessary, b
+0001e060: 7574 2069 7427 7320 676f 6f64 2074 6f20  ut it's good to 
+0001e070: 6669 6c74 6572 0a20 2020 2023 206f 7574  filter.    # out
+0001e080: 2074 6865 2075 6e75 7365 6420 656c 656d   the unused elem
+0001e090: 656e 7473 206f 6620 7468 6520 7361 7665  ents of the save
+0001e0a0: 645f 666f 725f 6261 636b 7761 7264 2061  d_for_backward a
+0001e0b0: 6e64 2066 6c61 7474 656e 2069 7420 666f  nd flatten it fo
+0001e0c0: 7220 6d6f 7265 0a20 2020 2023 2063 6f6d  r more.    # com
+0001e0d0: 7061 6374 2062 6163 6b77 6172 6420 7472  pact backward tr
+0001e0e0: 6163 652e 0a0a 2020 2020 2320 4e6f 7720  ace...    # Now 
+0001e0f0: 7765 2063 616e 2064 6574 6572 6d69 6e65  we can determine
+0001e100: 2065 7861 6374 6c79 2077 6861 7427 7320   exactly what's 
+0001e110: 7573 6564 2069 6e20 7468 6520 6261 636b  used in the back
+0001e120: 7761 7264 2070 6173 7320 6672 6f6d 2074  ward pass from t
+0001e130: 6865 0a20 2020 2023 2073 6176 6564 5f66  he.    # saved_f
+0001e140: 6f72 5f62 6163 6b77 6172 642e 2057 6520  or_backward. We 
+0001e150: 6361 6e20 666c 6174 7465 6e20 616e 6420  can flatten and 
+0001e160: 6669 6c74 6572 2074 6865 2073 6176 6564  filter the saved
+0001e170: 5f66 6f72 5f62 6163 6b77 6172 640a 2020  _for_backward.  
+0001e180: 2020 636f 6e73 756d 6572 7320 3d20 7574    consumers = ut
+0001e190: 696c 732e 636f 6e73 756d 6572 7328 6261  ils.consumers(ba
+0001e1a0: 636b 7761 7264 5f74 7261 6365 290a 0a20  ckward_trace).. 
+0001e1b0: 2020 2023 2046 6f72 7761 7264 2773 2061     # Forward's a
+0001e1c0: 6e64 2062 6163 6b77 6172 6427 7320 2273  nd backward's "s
+0001e1d0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001e1e0: 6422 2061 7265 206e 6f74 206e 6563 6573  d" are not neces
+0001e1f0: 7361 7269 6c79 2074 6865 2073 616d 650a  sarily the same.
+0001e200: 2020 2020 2320 6173 2074 6865 2073 6176      # as the sav
+0001e210: 6564 5f66 6f72 5f62 6163 6b77 6172 642c  ed_for_backward,
+0001e220: 2062 6563 6175 7365 2073 6f6d 6520 6f72   because some or
+0001e230: 2061 6c6c 2065 6c65 6d65 6e74 7320 6f66   all elements of
+0001e240: 2074 6865 0a20 2020 2023 2073 6176 6564   the.    # saved
+0001e250: 5f66 6f72 5f62 6163 6b77 6172 6420 7265  _for_backward re
+0001e260: 7375 6c74 7320 6d69 6768 7420 6265 2072  sults might be r
+0001e270: 652d 7072 6f78 6966 6965 642e 0a20 2020  e-proxified..   
+0001e280: 2062 775f 666c 6174 5f73 6176 6564 5f66   bw_flat_saved_f
+0001e290: 6f72 5f62 6163 6b77 6172 642c 2073 7065  or_backward, spe
+0001e2a0: 6320 3d20 7472 6565 5f66 6c61 7474 656e  c = tree_flatten
+0001e2b0: 2862 6163 6b77 6172 645f 7472 6163 652e  (backward_trace.
+0001e2c0: 6172 6773 5b30 5d29 0a20 2020 2066 775f  args[0]).    fw_
+0001e2d0: 666c 6174 5f73 6176 6564 5f66 6f72 5f62  flat_saved_for_b
+0001e2e0: 6163 6b77 6172 642c 205f 203d 2074 7265  ackward, _ = tre
+0001e2f0: 655f 666c 6174 7465 6e28 666f 7277 6172  e_flatten(forwar
+0001e300: 645f 7472 6163 652e 6f75 7470 7574 5b31  d_trace.output[1
+0001e310: 5d29 0a20 2020 2075 7365 645f 6d61 736b  ]).    used_mask
+0001e320: 203d 206c 6973 7428 6c65 6e28 636f 6e73   = list(len(cons
+0001e330: 756d 6572 732e 6765 7428 782c 2028 2929  umers.get(x, ())
+0001e340: 2920 3e20 3020 666f 7220 7820 696e 2062  ) > 0 for x in b
+0001e350: 775f 666c 6174 5f73 6176 6564 5f66 6f72  w_flat_saved_for
+0001e360: 5f62 6163 6b77 6172 6429 0a0a 2020 2020  _backward)..    
+0001e370: 2320 446f 6e27 7420 7573 6520 7468 6520  # Don't use the 
+0001e380: 7361 6d65 2076 6172 6961 626c 6520 7477  same variable tw
+0001e390: 6963 6520 696e 2074 6865 2062 6163 6b77  ice in the backw
+0001e3a0: 6172 6420 7061 7373 0a20 2020 2073 6565  ard pass.    see
+0001e3b0: 6e20 3d20 7365 7428 290a 2020 2020 6672  n = set().    fr
+0001e3c0: 6f6d 2074 6875 6e64 6572 2e63 6f72 652e  om thunder.core.
+0001e3d0: 7072 6f78 6965 7320 696d 706f 7274 2056  proxies import V
+0001e3e0: 6172 6961 626c 650a 0a20 2020 2066 6f72  ariable..    for
+0001e3f0: 2069 2c20 7820 696e 2065 6e75 6d65 7261   i, x in enumera
+0001e400: 7465 2866 775f 666c 6174 5f73 6176 6564  te(fw_flat_saved
+0001e410: 5f66 6f72 5f62 6163 6b77 6172 6429 3a0a  _for_backward):.
+0001e420: 2020 2020 2020 2020 7820 3d20 7661 7269          x = vari
+0001e430: 6162 6c65 6966 7928 7829 0a20 2020 2020  ableify(x).     
+0001e440: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0001e450: 616e 6365 2878 2c20 5661 7269 6162 6c65  ance(x, Variable
+0001e460: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+0001e470: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+0001e480: 6966 2078 2069 6e20 7365 656e 3a0a 2020  if x in seen:.  
+0001e490: 2020 2020 2020 2020 2020 7573 6564 5f6d            used_m
+0001e4a0: 6173 6b5b 695d 203d 2046 616c 7365 0a20  ask[i] = False. 
+0001e4b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001e4c0: 2020 2020 2020 2020 2073 6565 6e2e 6164           seen.ad
+0001e4d0: 6428 7829 0a0a 2020 2020 6f6e 6c79 5f75  d(x)..    only_u
+0001e4e0: 7365 645f 6677 5f73 6176 6564 5f66 6f72  sed_fw_saved_for
+0001e4f0: 5f62 6163 6b77 6172 6420 3d20 7475 706c  _backward = tupl
+0001e500: 6528 636f 6d70 7265 7373 2866 775f 666c  e(compress(fw_fl
+0001e510: 6174 5f73 6176 6564 5f66 6f72 5f62 6163  at_saved_for_bac
+0001e520: 6b77 6172 642c 2075 7365 645f 6d61 736b  kward, used_mask
+0001e530: 2929 0a20 2020 206f 6e6c 795f 7573 6564  )).    only_used
+0001e540: 5f62 775f 7361 7665 645f 666f 725f 6261  _bw_saved_for_ba
+0001e550: 636b 7761 7264 203d 2074 7570 6c65 2863  ckward = tuple(c
+0001e560: 6f6d 7072 6573 7328 6277 5f66 6c61 745f  ompress(bw_flat_
+0001e570: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001e580: 7264 2c20 7573 6564 5f6d 6173 6b29 290a  rd, used_mask)).
+0001e590: 0a20 2020 2023 2057 6520 6e65 6564 2074  .    # We need t
+0001e5a0: 6f20 7570 6461 7465 2074 6865 2074 7261  o update the tra
+0001e5b0: 6365 7320 7769 7468 2074 6865 206e 6577  ces with the new
+0001e5c0: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001e5d0: 6172 640a 2020 2020 5f75 7064 6174 655f  ard.    _update_
+0001e5e0: 666f 7277 6172 645f 7769 7468 5f6e 6577  forward_with_new
+0001e5f0: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
+0001e600: 6172 6428 666f 7277 6172 645f 7472 6163  ard(forward_trac
+0001e610: 652c 206f 6e6c 795f 7573 6564 5f66 775f  e, only_used_fw_
+0001e620: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+0001e630: 7264 290a 2020 2020 5f75 7064 6174 655f  rd).    _update_
+0001e640: 6261 636b 7761 7264 5f77 6974 685f 6e65  backward_with_ne
+0001e650: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
+0001e660: 7761 7264 2862 6163 6b77 6172 645f 7472  ward(backward_tr
+0001e670: 6163 652c 206f 6e6c 795f 7573 6564 5f62  ace, only_used_b
+0001e680: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
+0001e690: 7761 7264 290a 2020 2020 666f 7277 6172  ward).    forwar
+0001e6a0: 645f 7472 6163 652e 7365 745f 7072 6f76  d_trace.set_prov
+0001e6b0: 656e 616e 6365 2854 7261 6365 5072 6f76  enance(TraceProv
+0001e6c0: 656e 616e 6365 2822 4175 676d 656e 7465  enance("Augmente
+0001e6d0: 6420 666f 7277 6172 6420 7061 7373 2229  d forward pass")
+0001e6e0: 290a 2020 2020 6261 636b 7761 7264 5f74  ).    backward_t
+0001e6f0: 7261 6365 2e73 6574 5f70 726f 7665 6e61  race.set_provena
+0001e700: 6e63 6528 5472 6163 6550 726f 7665 6e61  nce(TraceProvena
+0001e710: 6e63 6528 2242 6163 6b77 6172 6420 7061  nce("Backward pa
+0001e720: 7373 2229 290a 2020 2020 7265 7475 726e  ss")).    return
+0001e730: 2046 6f72 7761 7264 4261 636b 7761 7264   ForwardBackward
+0001e740: 5472 6163 6573 2866 6f72 7761 7264 5f74  Traces(forward_t
+0001e750: 7261 6365 2c20 6261 636b 7761 7264 5f74  race, backward_t
+0001e760: 7261 6365 290a 0a0a 2320 646f 2077 6520  race)...# do we 
+0001e770: 6861 7070 656e 2074 6f20 7761 6e74 2074  happen to want t
+0001e780: 6f20 7265 6769 7374 6572 2060 6c74 6f72  o register `ltor
+0001e790: 6368 6020 6f70 7320 7375 6368 2061 7320  ch` ops such as 
+0001e7a0: 606c 746f 7263 682e 6c61 7965 725f 6e6f  `ltorch.layer_no
+0001e7b0: 726d 6020 6173 2077 656c 6c3f 0a61 7574  rm` as well?.aut
+0001e7c0: 6f63 6173 745f 696d 706c 733a 2064 6963  ocast_impls: dic
+0001e7d0: 745b 7072 696d 732e 5072 696d 4944 732c  t[prims.PrimIDs,
+0001e7e0: 2043 616c 6c61 626c 655d 203d 207b 7d0a   Callable] = {}.
+0001e7f0: 0a0a 6465 6620 7265 6769 7374 6572 5f61  ..def register_a
+0001e800: 7574 6f63 6173 745f 7275 6c65 286f 7029  utocast_rule(op)
+0001e810: 3a0a 2020 2020 6465 6620 6465 636f 7261  :.    def decora
+0001e820: 746f 7228 6675 6e63 293a 0a20 2020 2020  tor(func):.     
+0001e830: 2020 2061 7574 6f63 6173 745f 696d 706c     autocast_impl
+0001e840: 735b 6f70 5d20 3d20 6675 6e63 0a20 2020  s[op] = func.   
+0001e850: 2020 2020 2072 6574 7572 6e20 6675 6e63       return func
+0001e860: 0a0a 2020 2020 7265 7475 726e 2064 6563  ..    return dec
+0001e870: 6f72 6174 6f72 0a0a 0a64 6566 206d 6179  orator...def may
+0001e880: 6265 5f64 6f77 6e63 6173 745f 746f 2864  be_downcast_to(d
+0001e890: 7479 7065 2c20 6172 6773 293a 0a20 2020  type, args):.   
+0001e8a0: 2061 6c6c 6f77 6564 5f64 6f77 6e63 6173   allowed_downcas
+0001e8b0: 745f 7479 7065 7320 3d20 2864 7479 7065  t_types = (dtype
+0001e8c0: 732e 666c 6f61 7431 362c 2064 7479 7065  s.float16, dtype
+0001e8d0: 732e 6266 6c6f 6174 3136 2c20 6474 7970  s.bfloat16, dtyp
+0001e8e0: 6573 2e66 6c6f 6174 3332 290a 0a20 2020  es.float32)..   
+0001e8f0: 2064 6566 206d 6170 5f66 6e28 6129 3a0a   def map_fn(a):.
+0001e900: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001e910: 7461 6e63 6528 612c 2054 656e 736f 7250  tance(a, TensorP
+0001e920: 726f 7879 2920 616e 6420 612e 6474 7970  roxy) and a.dtyp
+0001e930: 6520 696e 2061 6c6c 6f77 6564 5f64 6f77  e in allowed_dow
+0001e940: 6e63 6173 745f 7479 7065 733a 0a20 2020  ncast_types:.   
+0001e950: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001e960: 6d61 7962 655f 636f 6e76 6572 745f 746f  maybe_convert_to
+0001e970: 5f64 7479 7065 2861 2c20 6474 7970 6529  _dtype(a, dtype)
+0001e980: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001e990: 610a 0a20 2020 2072 6574 7572 6e20 7472  a..    return tr
+0001e9a0: 6565 5f6d 6170 286d 6170 5f66 6e2c 2061  ee_map(map_fn, a
+0001e9b0: 7267 7329 0a0a 0a40 7265 6769 7374 6572  rgs)...@register
+0001e9c0: 5f61 7574 6f63 6173 745f 7275 6c65 2822  _autocast_rule("
+0001e9d0: 746f 7263 682e 6d61 746d 756c 2229 0a40  torch.matmul").@
+0001e9e0: 7265 6769 7374 6572 5f61 7574 6f63 6173  register_autocas
+0001e9f0: 745f 7275 6c65 2870 7269 6d73 2e50 7269  t_rule(prims.Pri
+0001ea00: 6d49 4473 2e4d 4154 4d55 4c29 0a64 6566  mIDs.MATMUL).def
+0001ea10: 2061 7574 6f63 6173 745f 6d61 746d 756c   autocast_matmul
+0001ea20: 5f72 756c 6528 612c 2062 2c20 6474 7970  _rule(a, b, dtyp
+0001ea30: 6529 3a0a 2020 2020 2222 2241 7574 6f63  e):.    """Autoc
+0001ea40: 6173 7420 7275 6c65 2066 6f72 206d 6174  ast rule for mat
+0001ea50: 6d75 6c22 2222 0a20 2020 2072 6574 7572  mul""".    retur
+0001ea60: 6e20 7072 696d 732e 6d61 746d 756c 282a  n prims.matmul(*
+0001ea70: 286d 6179 6265 5f64 6f77 6e63 6173 745f  (maybe_downcast_
+0001ea80: 746f 2864 7479 7065 2c20 2861 2c20 6229  to(dtype, (a, b)
+0001ea90: 2929 290a 0a0a 4072 6567 6973 7465 725f  )))...@register_
+0001eaa0: 6175 746f 6361 7374 5f72 756c 6528 2274  autocast_rule("t
+0001eab0: 6f72 6368 2e6e 6e2e 6675 6e63 7469 6f6e  orch.nn.function
+0001eac0: 616c 2e6c 696e 6561 7222 290a 4072 6567  al.linear").@reg
+0001ead0: 6973 7465 725f 6175 746f 6361 7374 5f72  ister_autocast_r
+0001eae0: 756c 6528 7072 696d 732e 5072 696d 4944  ule(prims.PrimID
+0001eaf0: 732e 4c49 4e45 4152 290a 6465 6620 6175  s.LINEAR).def au
+0001eb00: 746f 6361 7374 5f6c 696e 6561 725f 7275  tocast_linear_ru
+0001eb10: 6c65 2861 2c20 772c 2062 6961 732c 2064  le(a, w, bias, d
+0001eb20: 7479 7065 293a 0a20 2020 2069 6620 6269  type):.    if bi
+0001eb30: 6173 2069 7320 4e6f 6e65 3a0a 2020 2020  as is None:.    
+0001eb40: 2020 2020 2320 446f 6e27 7420 7061 7373      # Don't pass
+0001eb50: 2060 6269 6173 6020 746f 206d 6179 6265   `bias` to maybe
+0001eb60: 5f64 6f77 6e63 6173 745f 746f 2e0a 2020  _downcast_to..  
+0001eb70: 2020 2020 2020 646f 776e 6361 7374 5f61        downcast_a
+0001eb80: 7267 7320 3d20 6d61 7962 655f 646f 776e  rgs = maybe_down
+0001eb90: 6361 7374 5f74 6f28 6474 7970 652c 2028  cast_to(dtype, (
+0001eba0: 612c 2077 2929 202b 2028 6269 6173 2c29  a, w)) + (bias,)
+0001ebb0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0001ebc0: 2020 2064 6f77 6e63 6173 745f 6172 6773     downcast_args
+0001ebd0: 203d 206d 6179 6265 5f64 6f77 6e63 6173   = maybe_downcas
+0001ebe0: 745f 746f 2864 7479 7065 2c20 2861 2c20  t_to(dtype, (a, 
+0001ebf0: 772c 2062 6961 7329 290a 0a20 2020 2072  w, bias))..    r
+0001ec00: 6574 7572 6e20 7072 696d 732e 6c69 6e65  eturn prims.line
+0001ec10: 6172 282a 646f 776e 6361 7374 5f61 7267  ar(*downcast_arg
+0001ec20: 7329 0a0a 0a40 7265 6769 7374 6572 5f61  s)...@register_a
+0001ec30: 7574 6f63 6173 745f 7275 6c65 2822 746f  utocast_rule("to
+0001ec40: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+0001ec50: 6c2e 7363 616c 6564 5f64 6f74 5f70 726f  l.scaled_dot_pro
+0001ec60: 6475 6374 5f61 7474 656e 7469 6f6e 2229  duct_attention")
+0001ec70: 0a64 6566 2061 7574 6f63 6173 745f 7363  .def autocast_sc
+0001ec80: 616c 6564 5f64 6f74 5f70 726f 6475 6374  aled_dot_product
+0001ec90: 5f61 7474 656e 7469 6f6e 280a 2020 2020  _attention(.    
+0001eca0: 7175 6572 792c 0a20 2020 206b 6579 2c0a  query,.    key,.
+0001ecb0: 2020 2020 7661 6c75 652c 0a20 2020 2061      value,.    a
+0001ecc0: 7474 6e5f 6d61 736b 2c0a 2020 2020 6472  ttn_mask,.    dr
+0001ecd0: 6f70 6f75 745f 702c 0a20 2020 2069 735f  opout_p,.    is_
+0001ece0: 6361 7573 616c 2c0a 2020 2020 2a2c 0a20  causal,.    *,. 
+0001ecf0: 2020 2064 7479 7065 2c0a 2020 2020 7363     dtype,.    sc
+0001ed00: 616c 652c 0a29 3a0a 2020 2020 6672 6f6d  ale,.):.    from
+0001ed10: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+0001ed20: 6d70 6f72 7420 7363 616c 6564 5f64 6f74  mport scaled_dot
+0001ed30: 5f70 726f 6475 6374 5f61 7474 656e 7469  _product_attenti
+0001ed40: 6f6e 0a0a 2020 2020 712c 206b 2c20 7620  on..    q, k, v 
+0001ed50: 3d20 6d61 7962 655f 646f 776e 6361 7374  = maybe_downcast
+0001ed60: 5f74 6f28 6474 7970 652c 2028 7175 6572  _to(dtype, (quer
+0001ed70: 792c 206b 6579 2c20 7661 6c75 6529 290a  y, key, value)).
+0001ed80: 2020 2020 7265 7475 726e 2073 6361 6c65      return scale
+0001ed90: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
+0001eda0: 7465 6e74 696f 6e28 712c 206b 2c20 762c  tention(q, k, v,
+0001edb0: 2061 7474 6e5f 6d61 736b 2c20 6472 6f70   attn_mask, drop
+0001edc0: 6f75 745f 702c 2069 735f 6361 7573 616c  out_p, is_causal
+0001edd0: 2c20 7363 616c 653d 7363 616c 6529 0a0a  , scale=scale)..
+0001ede0: 0a64 6566 2061 7574 6f63 6173 745f 7379  .def autocast_sy
+0001edf0: 6d62 6f6c 5f6d 6170 7065 7228 626f 756e  mbol_mapper(boun
+0001ee00: 645f 7379 6d62 6f6c 3a20 426f 756e 6453  d_symbol: BoundS
+0001ee10: 796d 626f 6c49 6e74 6572 6661 6365 2c20  ymbolInterface, 
+0001ee20: 6474 7970 653a 2064 7479 7065 732e 6474  dtype: dtypes.dt
+0001ee30: 7970 6529 3a0a 2020 2020 2222 2252 6574  ype):.    """Ret
+0001ee40: 7572 6e20 7468 6520 6361 6c6c 6162 6c65  urn the callable
+0001ee50: 2069 6d70 6c65 6d65 6e74 696e 6720 7468   implementing th
+0001ee60: 6520 6175 746f 6361 7374 2072 756c 6520  e autocast rule 
+0001ee70: 666f 7220 7468 6520 7379 6d62 6f6c 2e0a  for the symbol..
+0001ee80: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0001ee90: 2020 2062 6f75 6e64 5f73 796d 626f 6c3a     bound_symbol:
+0001eea0: 204d 6170 7065 6420 746f 2069 7473 2061   Mapped to its a
+0001eeb0: 7574 6f63 6173 7420 7275 6c65 2e0a 0a20  utocast rule... 
+0001eec0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0001eed0: 2020 2020 4361 6c6c 6162 6c65 3a20 5468      Callable: Th
+0001eee0: 6520 6361 6c6c 6162 6c65 2069 6d70 6c65  e callable imple
+0001eef0: 6d65 6e74 696e 6720 7468 6520 6175 746f  menting the auto
+0001ef00: 6361 7374 2072 756c 6520 666f 7220 7468  cast rule for th
+0001ef10: 6520 7379 6d62 6f6c 2e0a 2020 2020 2222  e symbol..    ""
+0001ef20: 220a 2020 2020 6175 746f 6361 7374 5f69  ".    autocast_i
+0001ef30: 6d70 6c3a 2043 616c 6c61 626c 6520 7c20  mpl: Callable | 
+0001ef40: 4e6f 6e65 203d 2061 7574 6f63 6173 745f  None = autocast_
+0001ef50: 696d 706c 732e 6765 7428 626f 756e 645f  impls.get(bound_
+0001ef60: 7379 6d62 6f6c 2e73 796d 2e69 6429 0a20  symbol.sym.id). 
+0001ef70: 2020 2072 6574 7572 6e20 626f 756e 645f     return bound_
+0001ef80: 7379 6d62 6f6c 2e73 796d 2069 6620 6175  symbol.sym if au
+0001ef90: 746f 6361 7374 5f69 6d70 6c20 6973 204e  tocast_impl is N
+0001efa0: 6f6e 6520 656c 7365 2070 6172 7469 616c  one else partial
+0001efb0: 2861 7574 6f63 6173 745f 696d 706c 2c20  (autocast_impl, 
+0001efc0: 6474 7970 653d 6474 7970 6529 0a0a 0a64  dtype=dtype)...d
+0001efd0: 6566 2061 7574 6f63 6173 7428 6675 6e63  ef autocast(func
+0001efe0: 3a20 4361 6c6c 6162 6c65 2c20 6474 7970  : Callable, dtyp
+0001eff0: 653a 2064 7479 7065 732e 6474 7970 6529  e: dtypes.dtype)
+0001f000: 3a0a 2020 2020 2222 2254 7261 6e73 666f  :.    """Transfo
+0001f010: 726d 7320 6120 6675 6e63 7469 6f6e 2074  rms a function t
+0001f020: 6f20 6175 746f 6361 7374 2063 6572 7461  o autocast certa
+0001f030: 696e 206f 7065 7261 7469 6f6e 732e 0a0a  in operations...
+0001f040: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0001f050: 2020 6675 6e63 3a20 5468 6520 6675 6e63    func: The func
+0001f060: 7469 6f6e 2074 6f20 6265 2074 7261 6e73  tion to be trans
+0001f070: 666f 726d 6564 2e0a 2020 2020 2020 2020  formed..        
+0001f080: 6474 7970 653a 2054 6865 2064 6174 6120  dtype: The data 
+0001f090: 7479 7065 2074 6f20 7768 6963 6820 6172  type to which ar
+0001f0a0: 6775 6d65 6e74 7320 6f66 2074 6865 2066  guments of the f
+0001f0b0: 756e 6374 696f 6e20 6f72 2073 7562 2066  unction or sub f
+0001f0c0: 756e 6374 696f 6e73 2063 6f75 6c64 2067  unctions could g
+0001f0d0: 6574 2063 6173 7420 6966 0a20 2020 2020  et cast if.     
+0001f0e0: 2020 2020 2020 2074 6865 7920 6172 6520         they are 
+0001f0f0: 6064 7479 7065 732e 666c 6f61 7433 3260  `dtypes.float32`
+0001f100: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001f110: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+0001f120: 3a20 5468 6520 7472 616e 7366 6f72 6d65  : The transforme
+0001f130: 6420 6675 6e63 7469 6f6e 0a20 2020 2022  d function.    "
+0001f140: 2222 0a0a 2020 2020 6966 206e 6f74 2069  ""..    if not i
+0001f150: 7369 6e73 7461 6e63 6528 6474 7970 652c  sinstance(dtype,
+0001f160: 2064 7479 7065 732e 6474 7970 6529 3a0a   dtypes.dtype):.
+0001f170: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+0001f180: 6c75 6545 7272 6f72 2866 2260 6474 7970  lueError(f"`dtyp
+0001f190: 6560 2069 7320 6578 7065 6374 6564 2074  e` is expected t
+0001f1a0: 6f20 6265 2060 7468 756e 6465 722e 6474  o be `thunder.dt
+0001f1b0: 7970 652e 6474 7970 6560 2062 7574 207b  ype.dtype` but {
+0001f1c0: 7479 7065 2864 7479 7065 297d 2229 0a20  type(dtype)}"). 
+0001f1d0: 2020 2069 6620 6474 7970 6520 6e6f 7420     if dtype not 
+0001f1e0: 696e 207b 6474 7970 6573 2e66 6c6f 6174  in {dtypes.float
+0001f1f0: 3136 2c20 6474 7970 6573 2e62 666c 6f61  16, dtypes.bfloa
+0001f200: 7431 367d 3a0a 2020 2020 2020 2020 7261  t16}:.        ra
+0001f210: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+0001f220: 2260 6474 7970 6560 2069 7320 6578 7065  "`dtype` is expe
+0001f230: 6374 6564 2074 6f20 6265 2065 6974 6865  cted to be eithe
+0001f240: 7220 6074 6875 6e64 6572 2e66 6c6f 6174  r `thunder.float
+0001f250: 3136 6020 6f72 2060 7468 756e 6465 722e  16` or `thunder.
+0001f260: 6266 6c6f 6174 3136 602c 2062 7574 207b  bfloat16`, but {
+0001f270: 6474 7970 657d 2229 0a0a 2020 2020 4077  dtype}")..    @w
+0001f280: 7261 7073 2866 756e 6329 0a20 2020 2064  raps(func).    d
+0001f290: 6566 2077 7261 7070 6572 282a 6172 6773  ef wrapper(*args
+0001f2a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0001f2b0: 2020 2020 2074 7261 6365 203d 2063 6f6e       trace = con
+0001f2c0: 7374 7275 6374 5f74 7261 6365 2829 2866  struct_trace()(f
+0001f2d0: 756e 632c 202a 6172 6773 2c20 2a2a 6b77  unc, *args, **kw
+0001f2e0: 6172 6773 290a 2020 2020 2020 2020 7265  args).        re
+0001f2f0: 7475 726e 2065 7661 6c5f 7472 6163 6528  turn eval_trace(
+0001f300: 7472 6163 652c 202a 6172 6773 2c20 2a2a  trace, *args, **
+0001f310: 6b77 6172 6773 2c20 7379 6d62 6f6c 5f6d  kwargs, symbol_m
+0001f320: 6170 7065 723d 7061 7274 6961 6c28 6175  apper=partial(au
+0001f330: 746f 6361 7374 5f73 796d 626f 6c5f 6d61  tocast_symbol_ma
+0001f340: 7070 6572 2c20 6474 7970 653d 6474 7970  pper, dtype=dtyp
+0001f350: 6529 290a 0a20 2020 2072 6574 7572 6e20  e))..    return 
+0001f360: 7772 6170 7065 720a                      wrapper.
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240602/thunder/core/vjp_utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/__init__.py`

 * *Files 5% similar despite different names*

```diff
@@ -9,28 +9,33 @@
 from typing import TYPE_CHECKING, Any
 from collections.abc import Generator
 from functools import partial
 
 
 import torch
 import torch.distributed as tdist
+from torch.utils.weak import WeakTensorKeyDictionary
 
 import thunder.core.utils as utils
-from thunder.core.proxies import DDPType
+from thunder.core.proxies import DistParallelType
+from thunder.distributed.tensor_parallel import column_parallel
+from thunder.distributed.tensor_parallel import row_parallel
 
 if TYPE_CHECKING:
     from torch.distributed import ProcessGroup
     from thunder.core.module import ThunderModule
 
 
 __all__ = [
     "ddp",
     "fsdp",
     "FSDPBucketingStrategy",
     "FSDPType",
+    "column_parallel",
+    "row_parallel",
 ]
 
 
 _skip_data_parallel_grad_sync = ContextVar("skip_data_parallel_grad_sync", default=False)
 
 
 def set_skip_data_parallel_grad_sync(value: bool) -> Token:
@@ -268,22 +273,22 @@
             lambda: (
                 "Trying to ddp a model with parameters on multiple devices, including devices "
                 f"{deviceindex} and {param.device.index} for {name!r}, but currently only models with all their "
                 "parameters on one device are supported"
             ),
         )
 
-    # Note [DistributedDataParallel and ddp_type]
+    # Note [DistributedDataParallel and distparallel_type]
     # If model was wrapped with thunder.distributed.ddp it would have a
     # .use_ddp attribute set to True and all parameters would be already
     # broadcasted to all other processes. So that our tracing is aware of
-    # this we need to mark the ddp_type of model's parameters as
-    # thunder.proxies.DDPType.REPLICATED
+    # this we need to mark the distparallel_type of model's parameters as
+    # thunder.proxies.DistParallelType.REPLICATED
     for p in model.parameters():
-        p.ddp_type = DDPType.REPLICATED
+        p.distparallel_type = DistParallelType.REPLICATED
 
     if broadcast_from is None:
         return model
 
     # Starts broadcasts
     # TODO Make these broadcast asyncs
     # TODO Perform up to two broadcasts at a time
@@ -399,14 +404,18 @@
     orig_module.process_group_for_ddp = process_group
     orig_module.bucketing_strategy = bucketing_strategy
     orig_module.sharding_strategy = sharding_strategy
 
     # modify module
     sharded_params = {}
     device_adjustments = {}
+    # We use `shared_params` dictionary to track the shared parameters.
+    # Key to this dictionary is the original parameter from the user's Module.
+    # Values are the copied and sharded parameter for the thunder module and meta-data related to sharding.
+    shared_params = WeakTensorKeyDictionary()
     for module_name, _ in thunder_model._model.named_modules():
         submodule = thunder_model.get_submodule(module_name)
 
         # we use a copy to let the user's module alone (TODO: does this fully work?)
         module_copy = copy.copy(submodule)
         # TODO: we should probably populate the module copy with parameters that consider overrides
 
@@ -414,49 +423,67 @@
         # This is done before sharding in case the materialization logic depends on the tensor shape.
         # The tradeoff is that all of a module's direct parameters need to fit in device.
         # Each module only initializes its own parameters and not those of its children (recurse=False)
         if any(t.is_meta for t in chain(module_copy.parameters(recurse=False), module_copy.buffers(recurse=False))):
             # TODO: we could also support calling a "param_init_fn" argument like PyTorch
             _materialize(module_copy, device)
             for n, p in module_copy.named_parameters(recurse=False, prefix=module_name):
-                thunder_model._overrides[n] = p
+                thunder_model._overrides_parameters[n] = p
                 device_adjustments[n] = device
             for n, b in module_copy.named_buffers(recurse=False, prefix=module_name):
-                thunder_model._overrides[n] = b
+                thunder_model._overrides_buffers[n] = b
                 device_adjustments[n] = device
         else:
             # Move leftover params and buffers to device. This is at least required to broadcast.
             # Cannot `submodule.to(device)` because we don't want it to recurse
             for n, p in module_copy.named_parameters(recurse=False, prefix=module_name):
                 if p.device != device:
-                    thunder_model._overrides[n] = torch.nn.Parameter(p.to(device=device), requires_grad=p.requires_grad)
+                    thunder_model._overrides_parameters[n] = torch.nn.Parameter(
+                        p.to(device=device), requires_grad=p.requires_grad
+                    )
                     device_adjustments[n] = device
             for n, b in module_copy.named_buffers(recurse=False, prefix=module_name):
                 if b.device != device:
-                    thunder_model._overrides[n] = b.to(device=device)
+                    thunder_model._overrides_buffers[n] = b.to(device=device)
                     device_adjustments[n] = device
 
         # Broadcast parameters if requested
         if broadcast_from is not None:
             for pn, _ in submodule.named_parameters(recurse=False, prefix=module_name):
                 tdist.broadcast(
                     thunder_model.get_parameter(pn), src=broadcast_from, group=process_group, async_op=False
                 )
             for pn, _ in submodule.named_buffers(recurse=False, prefix=module_name):
                 tdist.broadcast(thunder_model.get_buffer(pn), src=broadcast_from, group=process_group, async_op=False)
 
         for pn, p in submodule.named_parameters(recurse=False, prefix=module_name):
+            # If there are shared params in the original user Module, we reuse the sharded copy created from the original parameter below.
+            # This way we re-create parameter sharing in thunder's copy of the Module.
+            if p in shared_params:
+                # Re-use the previous copy of this parameter.
+                thunder_model._overrides_parameters[pn] = shared_params[p]["param_copy"]
+                sharded_params[pn] = shared_params[p]["param_shard_meta"]
+                continue
+
             # if we don't have an override or it is just the original, do create a copy
-            if thunder_model._overrides.get(pn, p) is p:
-                thunder_model._overrides[pn] = copy.copy(p)
+            if thunder_model._overrides_parameters.get(pn, p) is p:
+                thunder_model._overrides_parameters[pn] = copy.copy(p)
             # we collect shapes and devices because we do not know if other transforms also change it...
-            old_shape = thunder_model._overrides[pn].shape
-            _shard_param(thunder_model._overrides[pn], global_rank, world_size, pn, allow_padding_for_fsdp=True)
-            new_shape = thunder_model._overrides[pn].shape
-            sharded_params[pn] = (old_shape, new_shape, thunder_model._overrides[pn].device)
+            old_shape = thunder_model._overrides_parameters[pn].shape
+            _shard_param(
+                thunder_model._overrides_parameters[pn], global_rank, world_size, pn, allow_padding_for_fsdp=True
+            )
+            new_shape = thunder_model._overrides_parameters[pn].shape
+            sharded_params[pn] = (old_shape, new_shape, thunder_model._overrides_parameters[pn].device)
+
+            # Track the original param and it's corresponding copied shard and metadata.
+            shared_params[p] = {
+                "param_copy": thunder_model._overrides_parameters[pn],
+                "param_shard_meta": sharded_params[pn],
+            }
 
     early_transform_from_trace_to_fsdp_trace = FSDPTraceTransform(
         sharded_params=sharded_params,
         process_group=process_group,
     )
     # add prologue + compute transform
     thunder_model = add_transform(thunder_model, early_transform=early_transform_from_trace_to_fsdp_trace)
@@ -528,22 +555,22 @@
     model.process_group_for_ddp = process_group
     model.sharding_strategy = sharding_strategy
     model.bucketing_strategy = bucketing_strategy
 
     # Shard the parameters
     _shard_params(model, process_group, device, broadcast_from, allow_padding_for_fsdp=True)
 
-    # See Note [DistributedDataParallel and ddp_type]
+    # See Note [DistributedDataParallel and distparallel_type]
     # If model was wrapped with thunder.distributed.fsdp it would have a
     # .use_fsdp attribute set to True and all parameters would be already
     # sharded across all other processes. So that our tracing is aware of
-    # this we need to mark the ddp_type of model's parameters as
-    # thunder.proxies.DDPType.FULLY_SHARDED
+    # this we need to mark the distparallel_type of model's parameters as
+    # thunder.proxies.DistParallelType.FULLY_SHARDED
     for p in model.parameters():
-        p.ddp_type = DDPType.FULLY_SHARDED
+        p.distparallel_type = DistParallelType.FULLY_SHARDED
 
     return model
 
 
 @torch.no_grad()
 def _shard_params(
     module: torch.nn.Module,
@@ -555,14 +582,17 @@
     """Shards the parameters on the first dimension."""
     global_rank = tdist.get_rank(group=process_group)
     world_size = tdist.get_world_size(group=process_group)
     if device is None:
         local_rank = int(os.environ["LOCAL_RANK"])
         device = torch.device("cuda", local_rank)
 
+    # In case there is a weight sharing, we don't want to shard the same param
+    # multiple times. We use `sharded_params` to keep track of already sharded param.
+    sharded_params = WeakTensorKeyDictionary()
     # We will definitely change the sharding logic in the future
     for module_name, submodule in module.named_modules():
         # Materialize meta-parameters on-device if necessary.
         # This is done before sharding in case the materialization logic depends on the tensor shape.
         # The tradeoff is that all of a module's direct parameters need to fit in device.
         # Each module only initializes its own parameters and not those of its children (recurse=False)
         if any(t.is_meta for t in chain(submodule.parameters(recurse=False), submodule.buffers(recurse=False))):
@@ -577,49 +607,60 @@
         if broadcast_from is not None:
             for tensor in chain(submodule.parameters(recurse=False), submodule.buffers(recurse=False)):
                 tdist.broadcast(tensor, src=broadcast_from, group=process_group, async_op=False)
 
         # Note [FSDP Sharding]
         # All internal code will assume that the parameters are sharded on the first dimension
         for param_name, param in submodule.named_parameters(recurse=False, prefix=module_name):
+            if param in sharded_params:
+                continue
             _shard_param(param, global_rank, world_size, param_name, allow_padding_for_fsdp=allow_padding_for_fsdp)
+            # Mark the param as sharded so that we don't reshard it (in case model has shared parameters)
+            sharded_params[param] = True
 
 
 def _shard_param(
     param: torch.Tensor,
     rank: int,
     world_size: int,
     name: str,
+    *,
     allow_padding_for_fsdp: bool = False,
+    dim: int | None = None,
 ) -> None:
 
-    if not allow_padding_for_fsdp or (param.size(0) % world_size == 0):
-        if not allow_padding_for_fsdp:
-            utils.check(
-                param.shape[0] % world_size == 0,
-                lambda: (
-                    f"Current sharding requires the first dimension of the parameter {name!r} ({param.shape[0]})"
-                    f" to be divisible by the world size ({world_size})"
-                ),
-            )
-        chunk_size = param.shape[0] // world_size
-        # NOTE This could be a ShardTensor to indicate other parts of the code
-        # that it's sharded and should be treated differently
-        shard = param.data.narrow(0, chunk_size * rank, chunk_size).clone()
-        param.data = shard
-    else:
+    dim_to_shard = 0 if dim is None else dim
+    if allow_padding_for_fsdp:
+        utils.check(dim_to_shard == 0, lambda: f"Invalid {dim=} with {allow_padding_for_fsdp=}, Only 0 is supported")
         padded_param_shape = list(param.shape)
-        orig_0dim_size = param.size(0)
+        orig_0dim_size = param.size(dim_to_shard)
         chunk_size = (padded_param_shape[0] + world_size - 1) // world_size
         padded_param_shape[0] = chunk_size * world_size
         _thunder_fsdp_padding_size = padded_param_shape[0] - param.size(0)
-        padded_param = torch.empty(padded_param_shape, device=param.device, dtype=param.dtype)
-        padded_param[:orig_0dim_size].copy_(param)
-        param.data = padded_param.data.narrow(0, chunk_size * rank, chunk_size).clone()
-        param._thunder_fsdp_padding_size = _thunder_fsdp_padding_size
+        if _thunder_fsdp_padding_size > 0:
+            padded_param = torch.empty(padded_param_shape, device=param.device, dtype=param.dtype)
+            padded_param[:orig_0dim_size].copy_(param)
+            param.data = padded_param.data.narrow(0, chunk_size * rank, chunk_size).clone()
+            param._thunder_fsdp_padding_size = _thunder_fsdp_padding_size
+        else:
+            param.data = param.data.narrow(0, chunk_size * rank, chunk_size).clone()
+            param._thunder_fsdp_padding_size = None
+    else:
+        utils.check(
+            param.shape[dim_to_shard] % world_size == 0,
+            lambda: (
+                f"Current sharding requires the sharded dimension of the parameter {name!r} ({param.shape[dim_to_shard]})"
+                f" to be divisible by the world size ({world_size})"
+            ),
+        )
+        chunk_size = param.shape[dim_to_shard] // world_size
+        # NOTE This could be a ShardTensor to indicate other parts of the code
+        # that it's sharded and should be treated differently
+        shard = param.data.narrow(dim_to_shard, chunk_size * rank, chunk_size).clone()
+        param.data = shard
 
 
 @torch.no_grad()
 def _unshard_params(module: torch.nn.Module, process_group: ProcessGroup, cpu_offload: bool = False) -> None:
     """Unshard a module's parameters.
 
     This supports CPU offloading of parameters.
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/ddp.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 from collections import defaultdict
 from dataclasses import dataclass
 from typing import TYPE_CHECKING
 
+from thunder.common import CompileData
 from thunder.core import dtypes
 from thunder.core import devices
 from thunder.core import prims
 from thunder.core.prims import PrimIDs
 from thunder.core.proxies import FutureTensorProxy
 from thunder.core.proxies import TensorProxy
 from thunder.core.proxies import variableify
@@ -24,19 +25,18 @@
 if TYPE_CHECKING:
     from typing import Any
     from torch.distributed import ProcessGroup
     from thunder.core.symbol import Symbol
     from thunder.core.symbol import BoundSymbol
     from thunder.core.trace import TraceCtx
     from thunder.core.trace import VariableInterface
-    from thunder.common import CompileData
 
 
 __all__ = [
-    "optimize_allreduce_in_ddp_backward",
+    "apply_bucketing_to_grad_allreduce",
 ]
 
 
 def get_bsym_of_allreduce_of_grad(tensor: TensorProxy, producers: utils.ProxyDict) -> BoundSymbol:
     prod_bsym = producers[tensor]
     if prod_bsym.sym.id == dist_prims.PrimIDs.ALL_REDUCE:
         return prod_bsym
@@ -234,7 +234,73 @@
     updated_bwd_trace = visitor_transform(
         backward_trace,
         visit_callable,
         provenance="Batching all_reduce calls",
     )
     utils.check(visit_callable.has_replaced_return, lambda: "")
     return updated_bwd_trace
+
+
+def apply_bucketing_to_grad_allreduce(trace: TraceCtx) -> TraceCtx:
+    """Apply Bucketing to Gradient AllReduce.
+
+    This method takes a trace which could be one representing forward or backward of an
+    :class:`~torch.nn.Module` and also one representing a method, not a PyTorch Module.
+    Then this applies bucketing to the input when it is a trace defining a DDP backward computation
+    where :func:`~thunder.distributed.all_reduce` is applied to gradients.
+    Otherwise, this method returns the input trace as is.
+
+    Args:
+        trace: A :class:`thunder.core.trace.TraceCtx`.
+
+    Returns:
+        :class:`thunder.core.trace.TraceCtx`
+    """
+
+    from torch.distributed import ProcessGroup
+    from thunder.core.compile_data import get_compile_data
+
+    if get_skip_data_parallel_grad_sync():
+        return trace
+
+    compile_data = get_compile_data()
+    if compile_data is None:
+        import thunder
+
+        compile_data = thunder.compile_data(trace)
+    # There's no ways to move forward if `compile_data` is None, so early exit.
+    if compile_data is None:
+        return trace
+    utils.check_type(compile_data, CompileData)
+
+    if not compile_data.is_module:
+        return trace
+
+    # NOTE(crcrpar): Will need to allow `use_fsdp` once hybrid shard is implemented.
+    if getattr(compile_data.fn, "use_ddp", False):
+        utils.check_type(compile_data.process_group_for_ddp, ProcessGroup)
+    else:
+        return trace
+
+    producers = utils.producers(trace)
+    flat_trace_output, _ = tree_flatten(trace.output)
+    output_tensor_to_index_and_prod_bsym = utils.ProxyDict()  # dict[Proxy, tuple[int, BoundSymbol]]
+    for index, output in enumerate(flat_trace_output):
+        if isinstance(output, TensorProxy):
+            output_tensor_to_index_and_prod_bsym[output] = (index, producers[output])
+
+    grad_before_after_allreduce = utils.ProxyDict()
+    bsym: BoundSymbol
+    for key in output_tensor_to_index_and_prod_bsym._dict:
+        _, bsym = output_tensor_to_index_and_prod_bsym.get_by_name(key)
+        if bsym.sym.id == dist_prims.PrimIDs.WAIT:
+            bsym_of_allreduce: BoundSymbol = producers[bsym.flat_proxy_args[0]]
+            utils.check(
+                bsym_of_allreduce.sym.id,
+                dist_prims.PrimIDs.ALL_REDUCE,
+                lambda: f"{bsym.sym.id=}, {bsym_of_allreduce.sym.id=}",
+            )
+            grad_before_after_allreduce[bsym.flat_proxy_outs[0]] = bsym_of_allreduce.flat_proxy_args[0]
+    if len(grad_before_after_allreduce._dict) == 0:
+        return trace
+
+    return optimize_allreduce_in_ddp_backward(trace, compile_data=compile_data)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/fsdp.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/transforms/fsdp_v2.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/transforms/fsdp_v2.py`

 * *Files 6% similar despite different names*

```diff
@@ -3,15 +3,15 @@
 from __future__ import annotations
 from dataclasses import dataclass
 from typing import TYPE_CHECKING
 
 from thunder.core import devices
 from thunder.core import prims
 from thunder.core import utils
-from thunder.core.proxies import DDPType
+from thunder.core.proxies import DistParallelType
 from thunder.core.trace import from_trace
 from thunder.core.trace import tracectx
 from thunder.core.trace import TraceProvenance
 
 if TYPE_CHECKING:
     from typing import Any
     from torch.distributed import ProcessGroup
@@ -55,19 +55,19 @@
                 param_thunder_module, param_name = bsym.args
                 assert param_thunder_module is thunder_module_proxy
                 if param_name in self.sharded_params:
                     old_shape, new_shape, new_torch_device = self.sharded_params[param_name]
                     thunder_device = devices.to_device(new_torch_device)
                     thunder_device_str = str(thunder_device)
 
-                    pro_out_p._ddp_type = DDPType.FULLY_SHARDED
+                    pro_out_p._distparallel_type = DistParallelType.FULLY_SHARDED
                     pro_out_p._shape = tuple(new_shape)
                     pro_out_p._device = thunder_device
                     if comp_inp_p is not pro_out_p:
-                        comp_inp_p._ddp_type = DDPType.FULLY_SHARDED
+                        comp_inp_p._distparallel_type = DistParallelType.FULLY_SHARDED
                         comp_inp_p._shape = tuple(new_shape)
                         comp_inp_p._device = thunder_device
                     with tracectx(computation_trace):
                         synchronized_parameters.append(dist_prims.synchronize(comp_inp_p, self.process_group))
 
                     for c in prologue_consumers[pro_out_p]:
                         if c.sym is prims.check_tensor_shape_and_metadata:
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240602/thunder/distributed/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -47,18 +47,15 @@
             selector=prefer_everything_over_syncs,
         )
         return new_primal_trace
     else:
         return primal_trace
 
 
-# TODO: Currently prefer the most memory-efficient way for ZeRO3,
-# Need a strategy to balance the efficiency
-# and memory usage in the future
-def sort_waits_for_zero3(execution_trace):
+def sort_communication_ops(execution_trace):
     """
     Sorts the wait_prim_impl nodes in the execution trace to be as far from the
     communication ops as possible, except for the all_gather_prim_impl nodes, the all_gather_prim_impl nodes
     are sorted to be next to wait_prim_impl node to reduce the peak allocated memory
 
     Args:
         execution_trace (TraceCtx): The execution trace to sort.
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240602/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/cudnnex.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,24 +1,44 @@
 from typing import Any
 
 import torch
 import numpy as np
 import random
 
 from lightning_utilities.core.imports import package_available
+from looseversion import LooseVersion
 
 
-def cudnn_available() -> bool:
-    return package_available("cudnn")
+#
+# Functions for detecting cudnn and its version
+#
+def cudnn_version() -> LooseVersion | None:
+    try:
+        import cudnn
+
+        if hasattr(cudnn, "__version__"):
+            return LooseVersion(cudnn.__version__)
+
+        # NOTE: This import of cudnn may or may not have version info
+        return LooseVersion("0.0.0")
+    except ImportError:
+        pass
+
+    # NOTE This occurs when cudnn couldn't be imported
+    return None
 
 
-def cudnn_version() -> int:
-    if cudnn_available():
-        return cudnn.backend_version()
-    return 0
+def required_cudnn_version() -> LooseVersion:
+    # Using 1.3.0 majorly because it works better with other libraries (e.g. torch) that also build on top of cudnn backend
+    return LooseVersion("1.3.0")
+
+
+def cudnn_available() -> bool:
+    v = cudnn_version()
+    return v is not None and v >= required_cudnn_version()
 
 
 cudnn: None | Any = None
 cudnn_backend_version: None | Any = None
 if cudnn_available():
     import cudnn
 
@@ -350,27 +370,56 @@
     *,
     scale: float | None = None,
 ) -> bool:
     # TODO(#58): make the checker more conservative.
     if cudnn is None:
         return False
 
+    if query.device.type != "cuda" or key.device != query.device or value.device != query.device:
+        return False
+
     if len(query.size()) != 4:
         return False
     _, _, _, d_q = query.size()
 
     if len(value.size()) != 4:
         return False
     _, _, _, d_kv = value.size()
 
     # Bug in cudnn 8.9.5 and earlier where embedding dim support is missing
     for d in [d_q, d_kv]:
         if d % 8 != 0 or d > 128:
             return False
 
+    try:
+        # Build both forward and backward graphs
+        query_4d, key_4d, value_4d, attn_mask_4d = _transform_sdpa_inputs(query, key, value, attn_mask)
+        _make_cudnn_sdpa_forward_graph(query_4d, key_4d, value_4d, attn_mask_4d, dropout_p, is_causal)
+        _make_cudnn_sdpa_backward_graph(
+            query_4d,
+            key_4d,
+            value_4d,
+            attn_mask_4d,
+            dropout_p,
+            is_causal,
+            query_4d.stride,
+            key_4d.stride,
+            value_4d.stride,
+        )
+    # If cudnn can't support the graph, return false
+    # Please turn on cudnn API logging for helpful messages that mention why the graph is not supported.
+    # For cudnn backend logging, refer https://docs.nvidia.com/deeplearning/cudnn/latest/reference/troubleshooting.html
+    # For cudnn frontend logging, refer https://github.com/NVIDIA/cudnn-frontend?tab=readme-ov-file#debugging
+    except cudnn.cudnnGraphNotSupportedError as ex:
+        return False
+    # Otherwise just raise the error.
+    # These errors can be due to internal cudnn bugs, or user error.
+    except Exception as e:
+        raise
+
     return True
 
 
 cudnn_sdpa_fwd = cudnn_ex.register_operator(
     "cudnn_sdpa_fwd",
     meta=_cudnn_sdpa_forward_meta,
     fn=_cudnn_sdpa_fwd_impl,
@@ -379,17 +428,14 @@
 
 def _make_cudnn_sdpa_backward_graph(
     query, key, value, attn_mask, dropout_p, is_causal, grad_query_stride, grad_key_stride, grad_value_stride
 ):
     b, h, s_q, _ = query.size
     _, _, _, d_v = value.size
 
-    # cuDNN < 9.0.0 might produce nan gradients for sequence length < 64
-    assert s_q >= 64, "CUDNN SDPA requires sequence length to be at least 64 for backward pass"
-
     graph = cudnn.pygraph(
         io_data_type=torch_to_cudnn_dtype(query.dtype),
         intermediate_data_type=cudnn.data_type.FLOAT,
         compute_data_type=cudnn.data_type.FLOAT,
         handle=_get_cudnn_handle(query.device_index),
     )
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/nvfuserex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/nvfuserex_impl.py`

 * *Files 1% similar despite different names*

```diff
@@ -1024,19 +1024,22 @@
 def _uniform_philox_check(
     shape: Sequence[int],
     minval: float,
     maxval: float,
     *,
     device: Device,
     dtype: dtypes.dtype,
-    seed: int | TensorProxy,
-    offset: int | TensorProxy,
+    seed: int | NumberProxy | TensorProxy,
+    offset: int | NumberProxy | TensorProxy,
 ) -> bool:
     return (
-        is_supported_device(device) and is_supported_dtype(dtype) and isinstance(seed, int) and isinstance(offset, int)
+        is_supported_device(device)
+        and is_supported_dtype(dtype)
+        and is_supported_tensor_or_number(seed)
+        and is_supported_tensor_or_number(offset)
     )
 
 
 def uniform_philox(
     shape: Sequence[int],
     minval: float,
     maxval: float,
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/passes.py`

 * *Files 3% similar despite different names*

```diff
@@ -125,16 +125,24 @@
     extrace.set_provenance(
         TraceProvenance(f"Transform for operator executor execution (took {elapsed_time_millis} milliseconds)")
     )
     return extrace
 
 
 def transform_for_execution(trace: TraceCtx, executors_list: Sequence[Executor]) -> TraceCtx:
+    import torch
+
     start_time_ns = time.time_ns()
 
+    if torch.distributed.is_available():
+        # Apply AllReduce bucketing if possible & needed
+        from thunder.distributed.transforms.ddp import apply_bucketing_to_grad_allreduce
+
+        trace = apply_bucketing_to_grad_allreduce(trace)
+
     trace = dce(trace)
 
     #
     # Step 1 Performs execution transforms
     #
     extrace = _transform_for_operator_executor_execution(trace, executors_list)
     extrace = dce(extrace)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/pythonex.py`

 * *Files 2% similar despite different names*

```diff
@@ -10,15 +10,15 @@
 from types import ModuleType
 import platform
 
 import torch
 
 import thunder.core.prims as prims
 from thunder.core.prims import PrimIDs
-from thunder.core.proxies import NumberProxy, TensorProxy, CollectionProxy
+from thunder.core.proxies import NumberProxy, NumberLike, TensorProxy, CollectionProxy
 from thunder.core.symbol import Symbol, BoundSymbol
 from thunder.core import baseutils
 import thunder.core.dtypes as dtypes
 import thunder.core.devices as devices
 import thunder.core.utils as utils
 
 from thunder.extend import OperatorExecutor, register_executor, add_always_executor
@@ -170,16 +170,16 @@
 
 
 #
 # Data movement and transformation prims
 #
 
 
-def _convert_element_type_prim_checker(a: Number | TensorProxy, /, dtype: type | dtypes.dtype) -> bool:
-    return isinstance(a, Number) and dtype in (bool, int, float, complex)
+def _convert_element_type_prim_checker(a: NumberLike | TensorProxy, /, dtype: type | dtypes.dtype) -> bool:
+    return isinstance(a, (Number, NumberProxy)) and dtype in (bool, int, float, complex)
 
 
 def _convert_element_type_prim_impl(a: Number, dtype: type) -> Number:
     return dtype(a)
 
 
 convert_element_type = ex.register_operator(
@@ -194,16 +194,31 @@
 #
 # TODO Review math vs cmath and datatype support
 # TODO Use NumPy to fill-in operations
 # TODO Maybe exclusively use NumPy? Otherwise have to be more careful about cmath vs math and datatypes?
 # TODO Review differences in type promotion (for example round(2.3))
 
 
-def _elementwise_unary_checker(x: Number | TensorProxy) -> bool:
-    return isinstance(x, Number)
+def _elementwise_unary_checker(x: NumberLike | TensorProxy) -> bool:
+    return isinstance(x, (Number, NumberProxy))
+
+
+def _div_prim_impl(a: Number, b: Number) -> Number:
+    if dtypes.is_exact_dtype(type(a)) and dtypes.is_exact_dtype(type(b)):
+        if (a >= 0) != (b >= 0) and a % b:
+            # This implementation follows c-style integer division, which is
+            # truncation division. When the quotient is negative and not evenly
+            # divisible, special handling is necessary to round values to zero.
+            return a // b + 1
+        else:
+            # Python uses floor division for integers, which rounds values to
+            # negative infinity.
+            return a // b
+
+    return a / b
 
 
 # NOTE Tensor abs is distinct from Python's builtin abs because it preserves the dtype of booleans
 #   i.e. tensor_abs(True) -> True, while builtins.abs(True) -> 1
 def _tensor_abs_prim_impl(a: Number) -> Number:
     if type(a) is bool:
         return a
@@ -290,15 +305,15 @@
 # # trunc = _elementwise_unary_factory("trunc", math)
 
 #
 # Elementwise binary primitives
 #
 
 
-def _elementwise_binary_checker(a: Number | TensorProxy, b: Number | TensorProxy) -> bool:
+def _elementwise_binary_checker(a: NumberLike | TensorProxy, b: NumberLike | TensorProxy) -> bool:
     return isinstance(a, (Number, NumberProxy)) and isinstance(b, (Number, NumberProxy))
 
 
 add = ex.register_operator("add", like=prims.add, module=operator)
 atan2 = ex.register_operator("atan2", like=prims.atan2, module=operator)
 bitwise_and = ex.register_operator("bitwise_and", like=prims.bitwise_and, module=operator)
 bitwise_or = ex.register_operator("bitwise_or", like=prims.bitwise_or, module=operator)
@@ -311,14 +326,15 @@
 le = ex.register_operator("le", like=prims.le, module=operator)
 lt = ex.register_operator("lt", like=prims.lt, module=operator)
 mul = ex.register_operator("mul", like=prims.mul, module=operator)
 ne = ex.register_operator("ne", like=prims.ne, module=operator)
 # NOTE pythonex_pow to avoid a name conflict with the builtin pow
 pythonex_pow = ex.register_operator("pow", like=prims.pow, module=operator)
 sub = ex.register_operator("sub", like=prims.sub, module=operator)
+div = ex.register_operator("div", like=prims.div, fn=_div_prim_impl)
 
 # TODO: Restore truediv once we find it...
 # truediv = ex.register_operator("truediv", like=prims.truediv, module=operator)
 
 ex.register_implementation(prims.add, add, checker=_elementwise_binary_checker)
 ex.register_implementation(prims.atan2, atan2, checker=_elementwise_binary_checker)
 ex.register_implementation(prims.bitwise_and, bitwise_and, checker=_elementwise_binary_checker)
@@ -332,10 +348,11 @@
 ex.register_implementation(prims.le, le, checker=_elementwise_binary_checker)
 ex.register_implementation(prims.lt, lt, checker=_elementwise_binary_checker)
 ex.register_implementation(prims.mul, mul, checker=_elementwise_binary_checker)
 ex.register_implementation(prims.ne, ne, checker=_elementwise_binary_checker)
 # NOTE pythonex_pow to avoid a name conflict with the builtin pow
 ex.register_implementation(prims.pow, pythonex_pow, checker=_elementwise_binary_checker)
 ex.register_implementation(prims.sub, sub, checker=_elementwise_binary_checker)
+ex.register_implementation(prims.div, div, checker=_elementwise_binary_checker)
 
 # TODO: Restore truediv once we find it...
 # ex.register_implementation(prims.truediv, truediv, checker=_elementwise_binary_checker)
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/torch_autograd.py`

 * *Files 3% similar despite different names*

```diff
@@ -106,15 +106,15 @@
             return (None, None, None, None, None, *([None] * n_grads))
 
 
 def split_forward_backward(computation_trc: TraceCtx, compile_data, compile_stats, /, *flat_args):
     from thunder.core.rematerialization import rematerialize_all_gather, rematerialize_forward_and_backward
     from thunder.core.transforms import forward_and_backward_from_trace
     from thunder.distributed.transforms import FSDPCommBucketing
-    from thunder.distributed.utils import sort_data_parallel_syncs, sort_waits, sort_waits_for_zero3
+    from thunder.distributed.utils import sort_data_parallel_syncs, sort_waits, sort_communication_ops
     from thunder.executors.passes import del_last_used, transform_for_execution
 
     utils.check(compile_data is not None, lambda: "`compile_data` is required")
     # NOTE: This function is rather slow, so it's intended to be used
     # behind a cache.
     tensor_cls = (torch.Tensor, TensorProxy)
     requires_grad_mask = tuple(isinstance(arg, tensor_cls) and arg.requires_grad for arg in flat_args)
@@ -192,18 +192,15 @@
     new_bsyms[4] = new_bsyms[4].from_bsym_swap_proxies(
         swap_map,
         skip_inputs=False,
         skip_output=False,
         skip_subsymbols=False,
     )
     bw_trace.bound_symbols = new_bsyms
-    if getattr(compile_data.fn, "use_ddp", False):
-        from thunder.distributed.transforms import optimize_allreduce_in_ddp_backward
 
-        bw_trace = optimize_allreduce_in_ddp_backward(bw_trace, compile_data)
     if getattr(compile_data.fn, "use_fsdp", False):
         bw_trace = _fsdp_comm_bucketing.apply_bucketing_to_backward_trace(bw_trace)
 
     # Now we can run the optimization passes on the backward trace
     # TODO Restore request for no rematerialization
     bw_extrace = transform_for_execution(
         bw_trace,
@@ -222,28 +219,39 @@
     # backward trace and increases the peak allocated memory
     if getattr(compile_data.fn, "use_fsdp", False):
         assert hasattr(compile_data.fn, "sharding_strategy")
         if getattr(compile_data.fn, "sharding_strategy") == FSDPType.ZERO3:
             from thunder.distributed import FSDPBucketingStrategy
             from thunder.distributed.utils import limit_in_flight_allgathers
 
-            fw_extrace = sort_waits_for_zero3(fw_extrace)
+            fw_extrace = sort_communication_ops(fw_extrace)
             fw_extrace = limit_in_flight_allgathers(
                 fw_extrace,
                 3,
                 compile_data.fn.bucketing_strategy != FSDPBucketingStrategy.NONE,
             )
-            bw_extrace = sort_waits_for_zero3(bw_extrace)
+            bw_extrace = sort_communication_ops(bw_extrace)
             bw_extrace = limit_in_flight_allgathers(
                 bw_extrace,
                 3,
                 compile_data.fn.bucketing_strategy != FSDPBucketingStrategy.NONE,
             )
         if getattr(compile_data.fn, "sharding_strategy") == FSDPType.ZERO2:
-            fw_extrace = sort_waits(fw_extrace)
+            from thunder.distributed import FSDPBucketingStrategy
+            from thunder.distributed.utils import limit_in_flight_allgathers
+            from sys import maxsize as INT_MAX
+
+            # sort the allgather+wait as consumer order just before consumer
+            fw_extrace = sort_communication_ops(fw_extrace)
+            # unlimited number of allgathers, i.e. allgathers are listed at the beginning of the trace in consumer order and wait stays just before wait
+            fw_extrace = limit_in_flight_allgathers(
+                fw_extrace,
+                INT_MAX,
+                compile_data.fn.bucketing_strategy != FSDPBucketingStrategy.NONE,
+            )
             bw_extrace = sort_waits(bw_extrace)
     if getattr(compile_data.fn, "use_ddp", False):
         bw_extrace = sort_waits(bw_extrace)
 
     # Importing here to avoid cyclical dependencies in future.
     from thunder.executors.transformer_engineex import _transformer_engine_bwd_fp8_meta_sync, transformer_engine_ex
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/torch_compile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/torchex.py`

 * *Files 2% similar despite different names*

```diff
@@ -433,20 +433,45 @@
     seq_or_number, *, device: devices.Device, dtype: None | dtypes.dtype
 ) -> TensorLike:
     torch_device: torch.device = to_torch_device(device)
     torch_dtype: torch.dtype = to_torch_dtype(dtype)
     return tensor_from_sequence(seq_or_number, device=torch_device, dtype=torch_dtype)
 
 
+def _get_and_update_rng_state_impl(seed, offset, device):
+    state = torch.cuda.get_rng_state(device)
+    seed, offset = torch.chunk(state, 2)
+    # We follow the nvFuser way here. The offset used by nvfuser = pytorch_offset // 4
+    # See Note [Divide offset by 4] https://github.com/NVIDIA/Fuser/blob/729f36c/csrc/rng.cpp#L54
+    seed = seed.view(torch.int64).item()
+    offset = offset.view(torch.int64).item() // 4
+    # We follow the nvFuser way here. pytorch_new_offset = (nvfuser_offset + 1) * 4
+    # See Note [Divide offset by 4] https://github.com/NVIDIA/Fuser/blob/729f36c/csrc/rng.cpp#L54
+    new_offset = (offset + 1) * 4
+    seed_portion = torch.tensor([seed]).view(torch.uint8)
+    offset_portion = torch.tensor([new_offset]).view(torch.uint8)
+    new_state = torch.cat([seed_portion, offset_portion])
+    torch.cuda.set_rng_state(new_state, device)
+    return seed, offset
+
+
+get_and_update_rng_state_impl = ex.register_operator(
+    "get_and_update_rng_state_impl",
+    meta=prims.get_and_update_rng_state.meta,
+    fn=_get_and_update_rng_state_impl,
+)
+
+
 _register_implementation(prims.full, checker=_always_executable, execution_transform=_full_transform)
 _register_implementation(prims.iota, checker=_always_executable, execution_transform=_iota_transform)
 _register_implementation(prims.uniform, checker=_always_executable, execution_transform=_uniform_transform)
 _register_implementation(
     prims.uniform_philox, checker=_uniform_philox_prim_checker, execution_transform=_uniform_philox_prim_transform
 )
+_register_implementation(prims.get_and_update_rng_state, get_and_update_rng_state_impl, checker=_always_executable)
 _register_implementation(prims.randn, checker=_always_executable, execution_transform=_randn_prims_transform)
 _register_implementation(prims.empty, checker=_always_executable, execution_transform=_empty_prims_transform)
 _register_implementation(
     prims.tensor_from_sequence, checker=_always_executable, execution_transform=_tensor_from_sequence_prims_transform
 )
 
 _register_implementation(ltorch.arange, checker=_always_executable, execution_transform=_arange_transform)
@@ -839,21 +864,32 @@
 nextafter = _register_torch_operation("nextafter")
 polygamma = _register_torch_operation("polygamma", module=torch.special)
 pow = _register_torch_operation("pow")
 remainder = _register_torch_operation("remainder")
 sub = _register_torch_operation("sub")
 true_divide = _register_torch_operation("true_divide")
 zeta = _register_torch_operation("zeta", module=torch.special)
+div = _register_torch_operation("div")
 
 
 # NOTE PyTorch elementwise operations require at least one input to be a tensor
 def _elementwise_binary_checker(a: Number | TensorProxy, b: Number | TensorProxy) -> bool:
     return isinstance(a, TensorLike) or isinstance(b, TensorLike)
 
 
+def _div_checker(
+    a: Number | TensorProxy,
+    b: Number | TensorProxy,
+    *,
+    rounding_mode: None | str = None,
+    out: None | TensorProxy = None,
+) -> TensorProxy:
+    return _elementwise_binary_checker(a, b) and (rounding_mode is None or isinstance(rounding_mode, str))
+
+
 # NOTE add and sub have special check and factory functions to support alpha
 def _add_sub_checker(
     a: Number | TensorProxy, b: Number | TensorProxy, *, alpha: None | Number | TensorProxy = None
 ) -> bool:
     return _elementwise_binary_checker(a, b) and (alpha is None or isinstance(alpha, Number))
 
 
@@ -879,14 +915,28 @@
 def _sub_transform(a: Number | TensorProxy, b: Number | TensorProxy, *, alpha: None | Number = None) -> TensorProxy:
     if alpha is None:
         return sub(a, b)
 
     return sub(a, b, alpha=alpha)
 
 
+def _div_transform(
+    a: Number | TensorProxy,
+    b: Number | TensorProxy,
+    /,
+    *,
+    rounding_mode: None | str = None,
+    out: None | TensorProxy = None,
+) -> TensorProxy:
+    if rounding_mode is None:
+        return div(a, b)
+
+    return div(a, b, rounding_mode=rounding_mode)
+
+
 _register_elementwise_binary_implementation = partial(_register_implementation, checker=_elementwise_binary_checker)
 
 _register_elementwise_binary_implementation(prims.add, add)
 _register_elementwise_binary_implementation(prims.atan2, atan2)
 _register_elementwise_binary_implementation(prims.bitwise_and, bitwise_and)
 _register_elementwise_binary_implementation(prims.bitwise_or, bitwise_or)
 _register_elementwise_binary_implementation(prims.bitwise_xor, bitwise_xor)
@@ -929,14 +979,15 @@
 _register_elementwise_binary_implementation(ltorch.nextafter, nextafter)
 _register_elementwise_binary_implementation(ltorch.polygamma, polygamma)
 _register_elementwise_binary_implementation(ltorch.pow, pow)
 _register_elementwise_binary_implementation(ltorch.remainder, remainder)
 _register_elementwise_binary_implementation(ltorch.sub, checker=_add_sub_checker, execution_transform=_sub_transform)
 _register_elementwise_binary_implementation(ltorch.true_divide, true_divide)
 _register_elementwise_binary_implementation(ltorch.zeta, zeta)
+_register_elementwise_binary_implementation(ltorch.div, checker=_div_checker, execution_transform=_div_transform)
 
 #
 # Elementwise ternary operations
 #
 
 addcdiv = _register_torch_operation("addcdiv")
 addcmul = _register_torch_operation("addcmul")
@@ -1319,15 +1370,15 @@
         else:
             utils.check(
                 i < len(seq),
                 lambda: f"invalid pooling argument: {arg_name} needs to be None / a scalar / size-{ndim} Sequence, but received {seq}",
             )
             return seq[i]
 
-    out_sizes = []
+    out_sizes = list(a.shape[:-ndim])
     for i in range(ndim):
         in_ = a.shape[i - ndim]  # i - ndim is the i-th spatial dimension
         kernel_ = get_maybe_ith_entry("kernel_size", kernel_size, i)
         stride_ = get_maybe_ith_entry("stride", stride, i, kernel_)
         pad_ = get_maybe_ith_entry("padding", padding, i)
         dilation_ = get_maybe_ith_entry("dilation", dilation, i)
         utils.check(
@@ -1751,16 +1802,24 @@
 if torch.distributed.is_available():
 
     def _all_gather_prim_impl(
         a: torch.Tensor,
         /,
         group: torch.distributed.ProcessGroup,
         do_async: Number,
+        dim: int | None = None,
     ) -> torch.Tensor | tuple[torch.distributed.distributed_c10d.Work, torch.Tensor]:
-        out: torch.Tensor = torch.empty((group.size() * a.shape[0],) + a.shape[1:], dtype=a.dtype, device=a.device)
+        result_shape = list(a.shape)
+        if dim is not None:
+            utils.check_type(dim, int)
+            utils.check(dim >= 0 and dim < a.dim(), lambda: f"dim must satisfy 0 <= {dim=} < {a.dim()=}")
+            result_shape[dim] *= group.size()
+        else:
+            result_shape[0] *= group.size()
+        out: torch.Tensor = torch.empty(result_shape, dtype=a.dtype, device=a.device)
         do_async: bool = bool(do_async)
 
         handle: None | torch.distributed.distributed_c10d.Work = torch.distributed.all_gather_into_tensor(
             out, a, group, do_async
         )
 
         if do_async:
@@ -1805,16 +1864,24 @@
 
     def _reduce_scatter_prim_impl(
         a: torch.Tensor,
         /,
         op: DistributedReduceOps,
         group: torch.distributed.ProcessGroup,
         do_async: Number,
+        dim: int | None,
     ) -> torch.Tensor | tuple[torch.distributed.distributed_c10d.Work, torch.Tensor]:
-        out = torch.empty((a.shape[0] // group.size(),) + a.shape[1:], dtype=a.dtype, device=a.device)
+        result_shape = list(a.shape)
+        if dim is not None:
+            utils.check_type(dim, int)
+            utils.check(dim >= 0 and dim < a.dim(), lambda: f"dim must satisfry 0 <= {dim=} < {a.dim()=}")
+            result_shape[dim] //= group.size()
+        else:
+            result_shape[0] //= group.size()
+        out = torch.empty(result_shape, dtype=a.dtype, device=a.device)
         op: torch.distributed.ReduceOp = ltorch.to_torch_distributed_reduce_op(op)
         do_async: bool = bool(do_async)
 
         handle: None | torch.distributed.distributed_c10d.Work = torch.distributed.reduce_scatter_tensor(
             out, a, op, group, do_async
         )
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/transformer_engineex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240602/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/extend/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/extend/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240602/thunder/functional.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240602/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240602/thunder/torch/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -20,15 +20,23 @@
 from thunder.core.devices import to_device, device_from_string
 import thunder.core.dtypes as dtypes
 from thunder.core.dtypes import to_torch_dtype, to_dtype, _thunder_to_torch_dtype_map, _torch_to_thunder_dtype_map
 import thunder.core.prims as prims
 import thunder.core.utils as utils
 import thunder.distributed.prims as dist_prims
 from thunder.core.langctxs import langctx, Languages
-from thunder.core.proxies import FloatProxy, IntegerProxy, NumberProxy, TensorProxy, FutureTensorProxy, pyval
+from thunder.core.proxies import (
+    FloatProxy,
+    IntegerProxy,
+    NumberProxy,
+    NumberLike,
+    TensorProxy,
+    FutureTensorProxy,
+    pyval,
+)
 from thunder.core.pytree import tree_map
 from thunder.core.symbol import Symbol
 from thunder.core.transforms import register_grad, put_grads
 from thunder.core.prims import get_grad, put_grad
 from thunder.core.baseutils import run_once
 
 __all__ = [
@@ -38,15 +46,14 @@
 # NOTE torch is a requirement
 import torch
 import torch.distributed as tdist
 
 import warnings
 
 # Type annotation helpers
-NumberLike = Number | NumberProxy
 TensorLike = TensorProxy
 FutureTensorLike = FutureTensorProxy
 DeviceLike = str | devices.Device | torch.device
 dtypeLike = dtypes.dtype | torch.dtype
 
 
 # TODO RC1 Remove this map
@@ -901,16 +908,23 @@
         if dim >= len(pad):
             pad_config.append((0, 0, 0))
         else:
             pad_config.append((pad[dim - 1], pad[dim], 0))
 
     if value is None:
         value = 0
+    a_typ = to_dtype(a, true_dtype=True)
+    # Note that this can be unsafe. This can happen, for example, if `a` is an
+    # integer tensor and `value` is a float. It can also be more subtle, where
+    # `a` is a lower-precision float than `value`.
+    if a_typ is not to_dtype(value, true_dtype=True):
+        warnings.warn("`value` and Tensor input are of different types. This " "may create numeric issues.")
+    v2 = clang.maybe_convert_to_dtype(value, a_typ)
 
-    return clang.pad(a, value, pad_config)
+    return clang.pad(a, v2, pad_config)
 
 
 @torchsymbol(torch.permute, is_method=True)
 def permute(a: TensorLike, /, *dims: int) -> TensorLike:
     dims = utils.extract_shape_from_varargs(dims)
     return clang.transpose(a, dims)
 
@@ -1513,14 +1527,33 @@
 
 @torchsymbol(torch.copysign, is_method=True)
 def copysign(a, b, /):
     return clang.copysign(a, b)
 
 
 # TODO Implement div
+@torchsymbol(torch.div, is_method=True)
+def div(
+    a: Number | TensorLike,
+    b: Number | TensorLike,
+    /,
+    *,
+    rounding_mode: None | str = None,
+    out: None | TensorLike = None,
+) -> Number | TensorLike:
+    utils.check(out is None, lambda: "out is not None which is currently unsupported", NotImplementedError)
+
+    if rounding_mode is None:
+        return true_divide(a, b)
+    elif rounding_mode == "trunc":
+        return clang.trunc_divide(a, b)
+    elif rounding_mode == "floor":
+        return floor_divide(a, b)
+    else:
+        raise ValueError(f"div does not support the rounding_mode={rounding_mode} argument")
 
 
 @torchsymbol(torch.eq, is_method=True)
 def eq(a, b, /):
     return clang.eq(a, b)
 
 
@@ -4460,18 +4493,19 @@
         is_method=False,
         id="functional_all_gather",
     )
     def all_gather(
         a: TensorLike,
         group: torch.distributed.ProcessGroup | None = None,
         async_op: bool = False,
+        dim: int | None = None,
     ) -> TensorLike | FutureTensorLike:
         group = group if group is not None else torch.distributed.new_group()
 
-        return dist_prims.all_gather(a, group, async_op)
+        return dist_prims.all_gather(a, group, async_op, dim=dim)
 
     # NOTE torch.distributed.all_reduce is an inplace operation (although the underlying NCCL
     #   call does not need to be inplace). This, however, is modeled as an out-of-place functional
     #   operation, hence the id "functional_all_reduce", and why we do not translate PyTorch
     #   calls directly to this.
     # PyTorch uses torch.ops.c10d_functional.all_reduce as an ID for a similar operation.
     # This operation is based on torch.distributed.all_reduce, see:
@@ -4511,19 +4545,20 @@
         id="functional_reduce_scatter",
     )
     def reduce_scatter(
         a: TensorLike,
         op: DistributedReduceOpLike | None = None,
         group: torch.distributed.ProcessGroup | None = None,
         async_op: bool = False,
+        dim: int | None = None,
     ) -> TensorLike | FutureTensorLike:
         op = to_thunder_distributed_reduce_op(op)
         group = group if group is not None else torch.distributed.new_group()
 
-        return dist_prims.reduce_scatter(a, op, group, async_op)
+        return dist_prims.reduce_scatter(a, op, group, async_op, dim=dim)
 
 else:
 
     def all_gather(
         a: TensorLike,
         group: Any | None = None,
         async_op: bool = False,
```

### Comparing `lightning_thunder-0.2.0.dev20240526/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240602/thunder/torch/langctx.py`

 * *Files identical despite different names*

